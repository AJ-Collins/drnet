<style>
        :root { font-family: 'Plus Jakarta Sans', sans-serif; }
        
        body { background-color: #f8fafc; }

        .glass-panel { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px); 
            border: 1px solid #e2e8f0; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        table { border-collapse: separate; border-spacing: 0; width: 100%; }
        th { 
            background: #f8fafc; color: #64748b; font-size: 0.65rem; 
            font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; 
            padding: 1rem 1.5rem; text-align: left; border-bottom: 1px solid #e2e8f0;
        }
        td { 
            padding: 1rem 1.5rem; border-bottom: 1px solid #f1f5f9; 
            font-size: 0.85rem; vertical-align: middle;
        }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background-color: #f8fafc; }

        .badge { font-size: 0.65rem; font-weight: 800; padding: 0.35rem 0.75rem; border-radius: 9999px; text-transform: uppercase; letter-spacing: 0.05em; display: inline-flex; align-items: center; gap: 0.35rem; }
        .badge-active { background: #f0fdfa; color: #0d9488; border: 1px solid #ccfbf1; }
        .badge-overdue { background: #fff1f2; color: #be123c; border: 1px solid #ffe4e6; }
        .badge-inactive { background: #f8fafc; color: #64748b; border: 1px solid #e2e8f0; }
        .badge-expired { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }

        .drawer-overlay { background: rgba(15, 23, 42, 0.093); backdrop-filter: blur(0px); }
        .drawer-panel {
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: -10px 0 30px rgba(0,0,0,0.1);
        }
        .drawer-panel.open { transform: translateX(0); }

        .search-input { background: #f1f5f9; border: 1px solid transparent; transition: all 0.2s; }
        .search-input:focus { background: white; border-color: #0d9488; box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1); }
        .sms-editor {
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
            font-family: 'Courier New', monospace;
            line-height: 1.5;
        }

        .custom-checkbox {
            appearance: none; background-color: #fff; margin: 0;
            font: inherit; color: currentColor; width: 1.15em; height: 1.15em;
            border: 1px solid #cbd5e1; border-radius: 0.25em;
            display: grid; place-content: center; cursor: pointer;
        }
        .custom-checkbox::before {
            content: ""; width: 0.65em; height: 0.65em; transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em white;
            transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        .custom-checkbox:checked { background-color: #0d9488; border-color: #0d9488; }
        .custom-checkbox:checked::before { transform: scale(1); }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
<div class="max-w-full mx-auto flex flex-col min-h-screen">
    
    <div class="mb-8 flex flex-col md:flex-row md:items-end justify-between gap-4">
        <div>
            <h1 class="text-3xl font-black text-slate-900 tracking-tight">Client Comms</h1>
            <p class="text-slate-500 font-bold text-sm">SMS Dispatch Center</p>
        </div>
        
        <div id="balanceBadge" class="hidden bg-white px-4 py-2 rounded-xl border border-slate-200 shadow-sm flex items-center gap-3">
            <div class="w-8 h-8 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600">
                <i class="fas fa-coins"></i>
            </div>
            <div>
                <p class="text-[10px] font-black uppercase text-slate-400">SMS Balance</p>
                <p class="text-sm font-bold text-slate-900" id="smsBalanceVal">Loading...</p>
            </div>
        </div>
    </div>

    <div class="glass-panel p-2 rounded-xl flex flex-col md:flex-row gap-2 mb-6 sticky top-4 z-20">
        <div class="relative flex-grow">
            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
            <input type="text" id="searchInput" placeholder="Search clients..." 
                class="w-full pl-10 pr-4 py-3 rounded-xl search-input text-sm font-semibold outline-none text-slate-700 placeholder:text-slate-400">
        </div>
        
        <div class="flex gap-2">
            <select id="statusFilter" class="px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 text-xs font-bold uppercase text-slate-600 outline-none hover:bg-white cursor-pointer">
                <option value="">All Statuses</option>
                <option value="active">Active</option>
                <option value="overdue">Overdue (Warning)</option>
                <option value="expired">Expired (Disconnected)</option>
            </select>
            
            <button id="btnBulkAction" onclick="Actions.openBulkDrawer()" class="hidden px-6 py-3 rounded-xl bg-slate-900 text-white hover:bg-slate-800 transition-colors shadow-lg shadow-slate-900/20 font-bold text-xs flex items-center gap-2">
                <i class="fas fa-paper-plane"></i>
                <span id="bulkCount">0</span> SELECTED
            </button>

            <button onclick="initData()" class="px-4 py-3 rounded-xl bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 transition-colors">
                <i class="fas fa-sync-alt text-xs"></i>
            </button>
        </div>
    </div>

    <div id="loadingState" class="hidden py-20 text-center">
        <i class="fas fa-circle-notch fa-spin text-4xl text-teal-500 mb-4"></i>
        <p class="text-sm font-bold text-slate-400 uppercase tracking-widest">Syncing Data...</p>
    </div>

    <div id="tableContainer" class="glass-panel rounded-xl overflow-hidden mb-6 hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr>
                        <th class="w-10">
                            <input type="checkbox" id="selectAll" class="custom-checkbox" onchange="Actions.toggleSelectAll()">
                        </th>
                        <th>Client Identity</th>
                        <th>Package Plan</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Expiry Date</th>
                        <th>Sms</th>
                        <th>Counter</th>
                        <th class="text-right">Action</th>
                    </tr>
                </thead>
                <tbody id="clientsTableBody" class="bg-white"></tbody>
            </table>
        </div>
    </div>

    <div id="paginationContainer" class="mt-auto pt-6 flex justify-between items-center border-t border-slate-200 hidden">
        <span id="pageInfo" class="text-xs font-bold text-slate-400 uppercase">Showing 0-0 of 0</span>
        <div class="flex gap-2">
            <button id="btnPrev" class="px-4 py-2 rounded-lg border border-slate-200 text-xs font-bold text-slate-600 hover:bg-slate-50 disabled:opacity-50">Previous</button>
            <button id="btnNext" class="px-4 py-2 rounded-lg border border-slate-200 text-xs font-bold text-slate-600 hover:bg-slate-50 disabled:opacity-50">Next</button>
        </div>
    </div>

</div>

<div id="drawerOverlay" class="fixed inset-0 drawer-overlay hidden z-40 transition-opacity opacity-0" onclick="UI.closeAllDrawers()"></div>

<div id="smsDrawer" class="fixed top-0 right-0 h-full w-full max-w-[480px] bg-white z-50 drawer-panel flex flex-col border-l border-slate-200">
    <div class="p-6 border-b border-slate-100 flex justify-between items-start bg-slate-50">
        <div>
            <h2 id="dName" class="text-xl font-black text-slate-800 tracking-tight">Client Name</h2>
            <div class="flex items-center gap-2 mt-1">
                <span id="dPhone" class="text-xs font-bold text-slate-500 font-mono">07XX XXX XXX</span>
                <span id="dStatus" class="text-[9px] font-black uppercase px-2 py-0.5 rounded bg-slate-200 text-slate-600">Status</span>
            </div>
        </div>
        <button onclick="UI.closeAllDrawers()" class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-400 hover:text-rose-500 transition-colors"><i class="fas fa-times"></i></button>
    </div>

    <div class="flex-grow overflow-y-auto custom-scroll p-6 space-y-6">
        <div id="templateToggleContainer" class="flex p-1 bg-slate-100 rounded-lg">
            <button data-type="reminder" onclick="Actions.setTemplate('reminder', this)" class="flex-1 py-2 text-xs font-bold rounded-md bg-white shadow-sm text-slate-800 transition-all">Reminder</button>
            <button data-type="receipt" onclick="Actions.setTemplate('receipt', this)" class="flex-1 py-2 text-xs font-bold rounded-md text-slate-500 hover:text-slate-700 transition-all">Confirmation</button>
            <button data-type="custom" onclick="Actions.setTemplate('custom', this)" class="flex-1 py-2 text-xs font-bold rounded-md text-slate-500 hover:text-slate-700 transition-all">Custom</button>
        </div>

        <div class="relative group">
            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">Message Content</label>
            <textarea id="singleSmsBody" class="w-full h-48 sms-editor p-4 rounded-xl border border-slate-200 text-xs text-slate-700 outline-none focus:border-teal-400 focus:ring-4 focus:ring-teal-50 transition-all resize-none"></textarea>            
        </div>
    </div>

    <div class="p-6 bg-slate-50 border-t border-slate-100">
        <button id="btnSendSingle" onclick="API.sendSingleSMS()" class="w-full py-4 rounded-xl bg-teal-600 text-white font-bold text-sm hover:bg-teal-700 shadow-lg shadow-teal-600/20 flex items-center justify-center gap-2 transition-all">
            <i class="fas fa-paper-plane"></i> SEND SMS NOW
        </button>
    </div>
</div>

<div id="bulkDrawer" class="fixed top-0 right-0 h-full w-full max-w-[480px] bg-white z-50 drawer-panel flex flex-col border-l border-slate-200">
    <div class="p-6 border-b border-slate-100 bg-slate-900 text-white">
        <h2 class="text-xl font-black tracking-tight">Bulk Dispatch</h2>
        <p class="text-xs font-medium text-slate-400 mt-1">Sending to <span id="bulkTotalBadge" class="text-white font-bold">0</span> recipients</p>
    </div>

    <div class="flex-grow overflow-y-auto custom-scroll p-6 space-y-6">
        
        <div class="p-4 rounded-xl bg-slate-50 border border-slate-100">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Recipient Summary</p>
            <div class="flex flex-wrap gap-2" id="bulkRecipientList">
                </div>
            <p id="bulkHiddenCount" class="text-[10px] text-slate-400 font-bold mt-2 hidden">+ 12 others</p>
        </div>

        <div class="relative">
            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">Message to All</label>
            <textarea id="bulkSmsBody" class="w-full h-48 sms-editor p-4 rounded-xl border border-slate-200 text-xs text-slate-700 outline-none focus:border-slate-800 focus:ring-4 focus:ring-slate-100 transition-all resize-none" placeholder="Type your message here..."></textarea>
            <p class="text-[10px] text-slate-400 mt-2">
                <i class="fas fa-info-circle mr-1"></i> Same message will be sent to all selected clients.
            </p>
        </div>
    </div>

    <div class="p-6 bg-slate-50 border-t border-slate-100">
        <button id="btnSendBulk" onclick="API.sendBulkSMS()" class="w-full py-4 rounded-xl bg-slate-900 text-white font-bold text-sm hover:bg-slate-800 shadow-lg shadow-slate-900/20 flex items-center justify-center gap-2 transition-all">
            <i class="fas fa-mail-bulk"></i> SEND BULK BLAST
        </button>
    </div>
</div>

<div id="historyDrawer" class="fixed top-0 right-0 h-full w-full max-w-lg bg-white z-50 drawer-panel flex flex-col border-l border-slate-200 shadow-2xl">
    <div class="p-8 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
        <div>
            <h2 class="text-xl font-black text-slate-900 tracking-tight">Comms History</h2>
            <p id="hClientName" class="text-slate-500 text-[10px] font-bold uppercase tracking-widest mt-1">Loading profile...</p>
        </div>
        <button onclick="UI.closeAllDrawers()" class="w-10 h-10 rounded-xl hover:bg-rose-50 text-slate-400 hover:text-rose-600 transition-all flex items-center justify-center">
            <i class="fas fa-times text-lg"></i>
        </button>
    </div>

    <div id="historyList" class="flex-1 overflow-y-auto custom-scroll p-0 bg-white">
        </div>

    <div class="p-6 border-t border-slate-100 bg-white">
        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">End of History Log</span>
    </div>
</div>

<script>
    const API_BASE = "/api/hr/dispatch"; 
    const DATA_ENDPOINT = "/api/subscriptions/dashboard-data";
    
    const State = {
        allData: [],
        filteredData: [],
        selectedIds: new Set(),
        currentClient: null,
        isLoading: false,
        renderTimeout: null,
        displayedData: [],

        currentPage: 1,
        itemsPerPage: 50,
        totalPages: 1
    };

    function updatePagination() {
        State.totalPages = Math.ceil(State.filteredData.length / State.itemsPerPage);
        
        const startIdx = (State.currentPage - 1) * State.itemsPerPage;
        const endIdx = startIdx + State.itemsPerPage;
        
        State.displayedData = State.filteredData.slice(startIdx, endIdx);
        
        const pageInfo = document.getElementById('pageInfo');
        const btnPrev = document.getElementById('btnPrev');
        const btnNext = document.getElementById('btnNext');
        const paginationContainer = document.getElementById('paginationContainer');
        
        if (State.filteredData.length > State.itemsPerPage) {
            paginationContainer.classList.remove('hidden');
            pageInfo.textContent = `Showing ${startIdx + 1}-${Math.min(endIdx, State.filteredData.length)} of ${State.filteredData.length}`;
            
            btnPrev.disabled = State.currentPage === 1;
            btnNext.disabled = State.currentPage === State.totalPages;
        } else {
            paginationContainer.classList.add('hidden');
        }
    }

    function goToPage(page) {
        State.currentPage = Math.max(1, Math.min(page, State.totalPages));
        updatePagination();
        debouncedRender();
    }

    function debouncedRender() {
        if (State.renderTimeout) {
            clearTimeout(State.renderTimeout);
        }
        State.renderTimeout = setTimeout(() => {
            renderTable();
        }, 100);
    }

    const Els = {
        tableContainer: document.getElementById('tableContainer'),
        tbody: document.getElementById('clientsTableBody'),
        loader: document.getElementById('loadingState'),
        search: document.getElementById('searchInput'),
        filter: document.getElementById('statusFilter'),
        selectAll: document.getElementById('selectAll'),
        btnBulk: document.getElementById('btnBulkAction'),
        bulkCount: document.getElementById('bulkCount'),
        
        smsDrawer: document.getElementById('smsDrawer'),
        singleBody: document.getElementById('singleSmsBody'),
        
        bulkDrawer: document.getElementById('bulkDrawer'),
        bulkBody: document.getElementById('bulkSmsBody'),
        bulkRecipients: document.getElementById('bulkRecipientList'),
        
        overlay: document.getElementById('drawerOverlay')
    };

    async function initData() {
        if (State.isLoading) return;
        
        State.isLoading = true;
        UI.toggleLoading(true);
        
        try {
            // Only fetch subscription data first
            const res = await fetch(DATA_ENDPOINT);
            if(!res.ok) throw new Error("Failed to load data");
            const raw = await res.json();

            // Process subscriptions WITHOUT SMS counts initially
            State.allData = raw.subscriptions.map(sub => {
                const now = new Date();
                const expiryDate = new Date(sub.expiry_date.replace(' ', 'T'));
                
                const warningDate = new Date(expiryDate);
                warningDate.setDate(warningDate.getDate() - 5);
                
                let displayStatus = 'active';
                let isWarningPeriod = false;

                if (now > expiryDate) {
                    displayStatus = 'expired';
                } else if (now > warningDate) {
                    displayStatus = 'overdue'; 
                    isWarningPeriod = true;
                } else {
                    displayStatus = 'active';
                }

                return {
                    id: sub.id,
                    name: `${sub.first_name} ${sub.second_name}`,
                    phone: sub.phone,
                    pkgName: sub.package_name,
                    price: sub.price,
                    expiry: expiryDate,
                    warningDate: warningDate,
                    isWarningPeriod: isWarningPeriod,
                    displayStatus: displayStatus,
                    sms_24h_count: 0  // Default to 0, load later
                };
            }).sort((a,b) => a.name.localeCompare(b.name));
            
            API.checkBalance();            
            applyFilters();
            
            // Load SMS counts in background (non-blocking)
            loadSmsCountsAsync();
            
        } catch (error) {
            console.error("Init data error:", error);
            Swal.fire("Error", "Could not load data.", "error");
        } finally {
            State.isLoading = false;
            UI.toggleLoading(false);
        }
    }

    async function loadSmsCountsAsync() {
        try {
            const logRes = await fetch('/api/hr/sms/log');
            if(!logRes.ok) return;
            
            const logData = await logRes.json();
            
            // Update counts in existing data
            State.allData.forEach(client => {
                const logEntry = logData.subscriptions.find(l => l.id === client.id);
                if (logEntry) {
                    client.sms_24h_count = logEntry.sms_24h_count;
                }
            });
            
            // Re-render only if user is still on first page
            if (!State.isLoading) {
                debouncedRender();
            }
        } catch (e) {
            console.warn("SMS log fetch failed:", e);
        }
    }

    function getCountdown(graceExpiry) {
        const now = new Date();
        const diff = graceExpiry - now;

        if (diff <= 0) return "EXPIRED";

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

        return `${days}d ${hours}h ${mins}m left`;
    }

    function applyFilters() {
        const term = Els.search.value.toLowerCase().trim();
        const filter = Els.filter.value;

        State.filteredData = State.allData.filter(item => {
            const matchesSearch = item.name.toLowerCase().includes(term) || item.phone.includes(term);
            const matchesFilter = !filter || item.displayStatus === filter;
            return matchesSearch && matchesFilter;
        });

        // Reset to page 1 when filtering
        State.currentPage = 1;
        
        // Don't clear selections on filter - let user keep their selections
        // State.selectedIds.clear();  // REMOVED
        
        UI.updateBulkButton();
        updatePagination();
        debouncedRender();
    }

    function renderTable() {
        if (State.isLoading) return;
        
        Els.tbody.innerHTML = "";
        Els.tableContainer.classList.remove('hidden');

        // Only render displayedData (current page)
        State.displayedData.forEach(client => {
            const tr = document.createElement('tr');
            tr.dataset.clientId = client.id;
            
            const isSelected = State.selectedIds.has(client.id);
            const dateStr = client.expiry.toLocaleDateString('en-GB');
            let badgeClass = 'badge-active';
            let iconClass = 'fa-check-circle';

            if (client.displayStatus === 'expired') {
                badgeClass = 'badge-expired bg-rose-50 text-rose-700 border border-rose-100'; // Added inline styles for safety
                iconClass = 'fa-times-circle';
            } else if (client.displayStatus === 'overdue') {
                badgeClass = 'badge-overdue';
                iconClass = 'fa-exclamation-triangle';
            }

            const now = new Date();
            let countdownText = "";
            let countdownClass = "text-slate-500";
            let subLabel = "";

            if (now > client.expiry) {
                countdownText = "0 days left";
                countdownClass = "text-slate-400 font-medium";
                subLabel = "Service Disconnected";
            } else if (now > client.warningDate) {
                countdownText = getCountdown(client.expiry); 
                countdownClass = "text-rose-500 font-bold animate-pulse";
                subLabel = "CRITICAL: PAY SOON";
            } else {
                const diff = client.expiry - now;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                countdownText = `${days} days left`;
                countdownClass = "text-teal-600 font-bold";
                subLabel = "Active Period";
            }

            const count = client.sms_24h_count || 0;
            let countClass = count > 3 ? "text-rose-500 font-black animate-pulse" : (count > 0 ? "text-teal-600 font-bold" : "text-slate-400");

            tr.innerHTML = `
                <td>
                    <input type="checkbox" class="custom-checkbox row-checkbox" ${isSelected ? 'checked' : ''}>
                </td>
                <td>
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-700 font-bold text-xs overflow-hidden border border-slate-200">
                            ${client.image ? `<img src="${client.image}" class="w-full h-full object-cover" loading="lazy">` : client.name.charAt(0)}
                        </div>
                        <div>
                            <h2 class="font-bold text-slate-800 leading-tight">${client.name}</h2>
                            <p class="text-[10px] font-mono text-slate-400">${client.phone}</p>
                        </div>
                    </div>
                </td>
                <td class="font-medium text-slate-600 text-xs">${client.pkgName}</td>
                <td class="font-mono font-bold text-slate-700 text-xs">KES ${client.price}</td>
                <td>
                    <span class="badge ${badgeClass}">
                        <i class="fas ${iconClass}"></i> ${client.displayStatus}
                    </span>
                </td>
                <td class="text-xs font-medium text-slate-500 font-mono">${dateStr}</td>
                <td class="text-xs">
                    <div class="flex flex-col">
                        <span class="${countClass}">${count} sent <span class="text-[9px] opacity-60">/ 24h</span></span>
                        <button class="view-history text-[10px] text-indigo-500 font-bold hover:underline text-left uppercase mt-1">
                            History
                        </button>
                    </div>
                </td>
                <td class="text-xs">
                    <div class="font-mono ${countdownClass} flex items-center gap-1">
                        <i class="fas fa-clock opacity-70"></i> ${countdownText}
                    </div>
                    <div class="text-[10px] text-slate-400 mt-1 font-bold uppercase tracking-tighter">
                        ${subLabel}
                    </div>
                </td>
                <td class="text-right">
                    <button class="compose-btn text-[9px] font-black uppercase tracking-widest text-teal-600 bg-teal-50 hover:bg-teal-100 px-3 py-1.5 rounded-lg border border-teal-100 transition-colors">
                        Compose
                    </button>
                </td>
            `;
            Els.tbody.appendChild(tr);
        });
        
        const allCurrentPageSelected = State.displayedData.length > 0 && 
                                        State.displayedData.every(c => State.selectedIds.has(c.id));
        Els.selectAll.checked = allCurrentPageSelected;
    }

    Els.tbody.addEventListener('click', (e) => {
        const row = e.target.closest('tr');
        if (!row) return;
        
        const clientId = parseInt(row.dataset.clientId);
        
        if (e.target.classList.contains('row-checkbox')) {
            Actions.toggleSelect(clientId);
        } else if (e.target.classList.contains('compose-btn')) {
            Actions.openSingleDrawer(clientId);
        } else if (e.target.classList.contains('view-history')) {
            const client = State.allData.find(c => c.id === clientId);
            if (client) Actions.viewHistory(clientId, client.name);
        }
    });

    const API = {
        checkBalance: async () => {
            try {
                const res = await fetch(`${API_BASE}/sms/balance`);
                const json = await res.json();
                if(json.success) {
                    document.getElementById('smsBalanceVal').innerText = `KES ${json.data.balance}`;
                    document.getElementById('balanceBadge').classList.remove('hidden');
                }
            } catch(e) { console.warn("Balance check failed"); }
        },

        sendSingleSMS: async () => {
            const btn = document.getElementById('btnSendSingle');
            const originalText = btn.innerHTML;
            const message = Els.singleBody.value;

            if(!message) return Swal.fire("Empty Message", "Please write a message first.", "warning");

            try {
                btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Sending...`;
                btn.disabled = true;

                const res = await fetch(`${API_BASE}/sms`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: State.currentClient.phone,
                        message: message,
                        subscriptionId: State.currentClient.id,  // Add this
                        messageType: State.currentTemplateType || 'custom' 
                    })
                });
                
                const result = await res.json();
                if(res.status === 429) {
                    return Swal.fire({
                        title: "Rate Limit Exceeded",
                        html: `
                            <p>${result.error}</p>
                            <p class="text-sm text-gray-600 mt-2">This prevents multiple sms and ensures quality communication.</p>
                        `,
                        icon: "warning",
                        confirmButtonText: "Got it"
                    });
                }
                if(!res.ok) throw new Error(result.error || "Failed");

                Swal.fire({
                    title: "Sent!",
                    text: "SMS dispatched successfully.",
                    icon: "success",
                    timer: 2000,
                    showConfirmButton: false
                });
                UI.closeAllDrawers();
                initData();
                API.checkBalance(); 

            } catch (error) {
                Swal.fire("Failed", error.message, "error");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        },

        sendBulkSMS: async () => {
            const btn = document.getElementById('btnSendBulk');
            const originalText = btn.innerHTML;
            const message = Els.bulkBody.value;

            if(!message) return Swal.fire("Empty Message", "Please write a message.", "warning");

            const selectedClients = Array.from(State.selectedIds).map(id => 
                State.allData.find(c => c.id === id)
            ).filter(Boolean);

            const messages = selectedClients.map(client => ({
                phone: client.phone,
                message: message
            }));

            try {
                btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Dispatching ${messages.length} SMS...`;
                btn.disabled = true;

                const res = await fetch(`${API_BASE}/sms/bulk`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages })
                });

                const result = await res.json();
                if(!res.ok) throw new Error(result.error || "Failed");

                try {
                    await fetch('/api/hr/sms/log/bulk', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            logs: selectedClients.map(c => ({
                                subscriptionId: c.id,
                                phone: c.phone,
                                message: message,
                                type: 'reminder'
                            }))
                        })
                    });
                } catch (e) {
                    console.warn("SMS sent but logging failed", e);
                }

                Swal.fire("Batch Sent!", `Successfully queued ${messages.length} messages.`, "success");
                
                State.selectedIds.clear();
                UI.updateBulkButton();
                debouncedRender();
                UI.closeAllDrawers();
                initData();
                API.checkBalance();

            } catch (error) {
                Swal.fire("Bulk Failed", error.message, "error");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    };

    const Actions = {
        toggleSelect: (id) => {
            if(State.selectedIds.has(id)) State.selectedIds.delete(id);
            else State.selectedIds.add(id);
            UI.updateBulkButton();
            renderTable();
        },

        toggleSelectAll: () => {
            const allCurrentPageSelected = State.displayedData.every(c => State.selectedIds.has(c.id));
            
            State.displayedData.forEach(c => {
                if(allCurrentPageSelected) State.selectedIds.delete(c.id);
                else State.selectedIds.add(c.id);
            });
            
            UI.updateBulkButton();
            renderTable();
        },

        openSingleDrawer: (id) => {
            const client = State.allData.find(c => c.id === id);
            if(!client) return;
            State.currentClient = client;

            document.getElementById('dName').innerText = client.name;
            document.getElementById('dPhone').innerText = client.phone;
            document.getElementById('dStatus').innerText = client.displayStatus;

            const firstBtn = document.querySelector('#templateToggleContainer button');
            Actions.setTemplate('reminder', firstBtn);
            
            UI.openDrawer('smsDrawer');
        },

        openBulkDrawer: () => {
            if(State.selectedIds.size === 0) return;
            
            Els.bulkRecipients.innerHTML = "";
            let count = 0;
            State.selectedIds.forEach(id => {
                if(count >= 5) return;
                const c = State.allData.find(x => x.id === id);
                const div = document.createElement('div');
                div.className = "w-8 h-8 rounded-full bg-indigo-100 border border-white shadow-sm flex items-center justify-center text-[10px] font-bold text-indigo-700";
                div.innerText = c.name.charAt(0);
                Els.bulkRecipients.appendChild(div);
                count++;
            });

            const remaining = State.selectedIds.size - 5;
            const hiddenCountEl = document.getElementById('bulkHiddenCount');
            if(remaining > 0) {
                hiddenCountEl.innerText = `+ ${remaining} others`;
                hiddenCountEl.classList.remove('hidden');
            } else {
                hiddenCountEl.classList.add('hidden');
            }

            document.getElementById('bulkTotalBadge').innerText = State.selectedIds.size;
            UI.openDrawer('bulkDrawer');
        },

        setTemplate: (type, el) => {
            State.currentTemplateType = type;
            const c = State.currentClient;
            if(!c) return;

            if (el) {
                const buttons = el.parentElement.querySelectorAll('button');
                
                buttons.forEach(btn => {
                    btn.classList.remove('bg-white', 'shadow-sm', 'text-slate-800');
                    btn.classList.add('text-slate-500', 'hover:text-slate-700');
                });

                el.classList.add('bg-white', 'shadow-sm', 'text-slate-800');
                el.classList.remove('text-slate-500', 'hover:text-slate-700');
            }

            const now = new Date();
            
            const firstName = c.name.split(" ")[0];
            const diffTime = c.expiry - now;
            const daysLeft = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            const nextMonth = new Date(); 
            nextMonth.setDate(now.getDate() + 30);
            const dateStr = c.expiry.toLocaleDateString('en-GB');

            let text = "";
            if (type === 'reminder') {
                if (daysLeft <= 0) {
                    text = `Hello ${c.name.toUpperCase()},\nWe hope you’re doing well! Your DR.NET Internet subscription has expired, and the service is currently paused.\nAmount Due: KES ${parseFloat(c.price).toLocaleString('en-KE', {minimumFractionDigits: 2})}\n\nPay easily via M-PESA:\n• Buy Goods & Services\n• Till Number: 5626320\n\nOnce payment is received, your internet will be reconnected automatically — No Delays.\nThank you for choosing DR.NET. We truly appreciate your continued support!\n\nDR.NET Technology Labs`;
                } else {
                    text = `Reminder:\nWe hope you’re enjoying your internet service. Your ${c.pkgName} subscription will be due in ${daysLeft} days. To continue enjoying fast and uninterrupted connectivity, please pay KES ${parseFloat(c.price).toLocaleString('en-KE', {minimumFractionDigits: 2})} by ${dateStr}.\n\nMaking payment is easy via M-PESA:\n\nGo to Buy Goods & Services\n\nEnter Till Number: 5626320\n\nComplete the payment\n\nIf you have any questions or need assistance, our support team is always here to help. Thank you for choosing DR.NET Technology – we appreciate having you as our valued customer!`;
                }
            } else if (type === 'receipt') {
                text = `Confirmation:\nThank you, ${firstName.toUpperCase()}!\n\nWe’ve received your KES ${parseFloat(c.price).toLocaleString('en-KE', {minimumFractionDigits: 2})} payment for the ${c.pkgName}.Your DR.NET Internet Service is now active for the next 30 days, valid until ${nextMonth.toLocaleDateString('en-GB')}.\nWe’re happy to serve you! \n\nQuestions? Call 0701782354\nDR.NET Technology Labs`;
            } else {
                text = "";
            }
            
            Els.singleBody.value = text;
        },

        viewHistory: async (id, name) => {
            const list = document.getElementById('historyList');
            document.getElementById('hClientName').innerText = name;
            
            list.innerHTML = `
                <div class="flex flex-col items-center justify-center py-20">
                    <div class="relative">
                        <div class="w-10 h-10 border-4 border-teal-100 border-t-teal-500 rounded-full animate-spin"></div>
                    </div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] mt-4">Syncing Logs</p>
                </div>`;
            
            UI.openDrawer('historyDrawer');

            try {
                const res = await fetch(`/api/hr/sms/log/${id}`);
                const data = await res.json();
                
                if(!data.history || data.history.length === 0) {
                    list.innerHTML = `
                        <div class="py-20 text-center">
                            <div class="bg-slate-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-history text-slate-300 text-xl"></i>
                            </div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">No dispatch history recorded.</p>
                        </div>`;
                    return;
                }

                list.innerHTML = data.history.map(item => {
                    const typeColor = item.message_type === 'reminder' ? 'bg-amber-500' : 'bg-teal-500';
                    const iconColor = item.message_type === 'reminder' ? 'text-amber-500' : 'text-teal-500';
                    const badgeBg = item.message_type === 'reminder' ? 'bg-amber-100 text-amber-700' : 'bg-teal-100 text-teal-700';

                    return `
                    <div class="group relative bg-white border-b border-slate-50 hover:bg-slate-50/50 transition-all cursor-default">
                        <div class="absolute left-0 top-0 bottom-0 w-1 ${typeColor}"></div>

                        <div class="flex items-start gap-4 p-4 sm:px-8">
                            <div class="mt-1">
                                <i class="fas fa-check-circle ${iconColor} text-sm"></i>
                            </div>

                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-[9px] font-black uppercase tracking-tight ${badgeBg} px-2 py-0.5 rounded">
                                        ${item.message_type}
                                    </span>
                                    <span class="text-[9px] font-medium text-slate-400 uppercase tracking-tighter">
                                        ${item.formatted_date}
                                    </span>
                                </div>
                                
                                <p class="text-sm text-slate-700 font-medium leading-relaxed mb-1 font-mono">
                                    ${item.message_body}
                                </p>

                                <div class="flex items-center gap-2 mt-2">
                                    <span class="text-[9px] font-bold text-slate-400 uppercase">Status: Delivered</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');
            } catch (e) {
                list.innerHTML = `
                    <div class="p-8 text-center">
                        <i class="fas fa-exclamation-triangle text-rose-400 mb-2"></i>
                        <p class="text-xs font-bold text-rose-500 uppercase">Connection Error</p>
                    </div>`;
            }
        }
    };

    const UI = {
        toggleLoading: (show) => {
            Els.loader.classList.toggle('hidden', !show);
            Els.tableContainer.classList.toggle('hidden', show);
        },
        updateBulkButton: () => {
            const count = State.selectedIds.size;
            Els.bulkCount.innerText = count;
            Els.btnBulk.classList.toggle('hidden', count === 0);
        },
        openDrawer: (id) => {
            Els.overlay.classList.remove('hidden');
            setTimeout(() => {
                Els.overlay.classList.remove('opacity-0');
                document.getElementById(id).classList.add('open');
            }, 10);
        },
        closeAllDrawers: () => {
            Els.smsDrawer.classList.remove('open');
            Els.bulkDrawer.classList.remove('open');
            document.getElementById('historyDrawer').classList.remove('open');
            Els.overlay.classList.add('opacity-0');
            setTimeout(() => {
                Els.overlay.classList.add('hidden');
            }, 400);
        }
    };

    document.getElementById('btnPrev').addEventListener('click', () => {
        goToPage(State.currentPage - 1);
    });

    document.getElementById('btnNext').addEventListener('click', () => {
        goToPage(State.currentPage + 1);
    });

    let searchTimeout;
    Els.search.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            applyFilters();
        }, 300);
    });
    Els.filter.addEventListener('change', applyFilters);
    document.addEventListener('DOMContentLoaded', initData);

</script>