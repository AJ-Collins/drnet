<div class="flex items-center justify-between mb-8">
  <div>
    <h3 class="text-2xl font-bold text-teal-800">Team Communication</h3>
    <p class="text-teal-600 mt-1">
      Real-time Messaging, announcements, and team collaborations.
    </p>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Chat Panel -->
  <section
    class="lg:col-span-2 bg-white rounded-t-2xl border border-teal-100 shadow-md overflow-hidden flex flex-col min-h-[40vh] max-h-[80vh]"
  >
    <div
      class="p-4 bg-teal-100 border-b border-teal-300 flex items-center justify-between"
    >
      <div class="flex items-center gap-3">
        <i class="fas fa-comments text-teal-600 text-xl md:text-3xl"></i>
        <div>
          <h2 class="font-semibold text-gray-900">team-chat</h2>
          <div id="onlineCount" class="text-xs text-teal-700">
            0 members online
          </div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button
          onclick="clearChat()"
          class="p-2 rounded-lg text-gray-500 hover:text-red-600 hover:bg-red-50 transition"
        >
          <i class="fas fa-trash"></i>
        </button>
        <button
          onclick="refreshChat()"
          class="p-2 rounded-lg text-gray-500 hover:text-teal-600 hover:bg-teal-50 transition"
        >
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>
    </div>

    <!-- Messages (bubble style) -->
    <div
      id="chatMessages"
      class="p-5 overflow-y-auto flex flex-col gap-4 flex-1"
    >
      <!-- bubbles go here -->
    </div>

    <!-- Input -->
    <div class="p-4 border-t border-teal-100">
      <form
        id="slackMessageForm"
        class="flex items-end gap-3"
        onsubmit="sendMessage(event)"
      >
        <textarea
          id="messageInput"
          rows="1"
          class="flex-1 px-4 py-3 border border-teal-200 rounded-lg resize-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 overflow-hidden transition-all duration-100 min-h-[20px] max-h-[160px] text-base"
          placeholder="Message #team-chat"
        ></textarea>

        <button
          type="submit"
          class="bg-teal-600 hover:bg-teal-700 text-white p-3 rounded-lg shadow mb-1"
        >
          <i class="fas fa-paper-plane"></i>
        </button>
      </form>
    </div>
  </section>

  <!-- Right Pane -->
  <aside class="space-y-6">
    <div
      class="bg-white border border-teal-100 shadow-md p-4 max-h-[500px] overflow-y-auto"
    >
      <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
        <i class="fas fa-user-friends text-teal-600"></i> Team Members
      </h3>
      <div id="teamMembers" class="mt-4 space-y-3"></div>
    </div>

    <div
      class="bg-white border border-teal-100 shadow-md p-4 max-h-[500px] overflow-y-auto"
    >
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
          <i class="fas fa-bullhorn text-teal-600"></i> Announcements
        </h3>
        <button
          onclick="createAnnouncement()"
          class="text-teal-600 hover:text-teal-700"
        >
          <i class="fas fa-plus"></i>
        </button>
      </div>
      <div id="announcements" class="mt-4 space-y-3"></div>
    </div>
  </aside>
</div>

<!-- Edit / View Announcement Modal -->
<div id="announcementModal" class="fixed inset-0 z-50 hidden">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div
      class="fixed inset-0 bg-black/50"
      onclick="closeAnnouncementModal()"
    ></div>

    <div
      class="relative bg-white w-full max-w-2xl rounded-xl shadow-2xl border border-teal-100"
    >
      <!-- Header -->
      <div
        class="p-6 border-b border-teal-100 flex items-center justify-between"
      >
        <h3 id="modalHeader" class="text-xl font-bold text-teal-700">
          New Announcement
        </h3>
        <button
          onclick="closeAnnouncementModal()"
          class="text-teal-600 hover:text-teal-800"
        >
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <!-- Form -->
      <form
        id="announcementForm"
        onsubmit="saveAnnouncement(event)"
        class="p-6 space-y-5"
      >
        <input type="hidden" id="editId" value="" />

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Title</label
          >
          <input
            type="text"
            id="annTitle"
            required
            class="w-full px-4 py-2 border border-teal-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500"
            placeholder="e.g. Planned maintenance"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Message</label
          >
          <textarea
            id="annBody"
            rows="4"
            required
            class="w-full px-4 py-2 border border-teal-200 rounded-lg resize-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500"
            placeholder="Details of the announcement…"
          ></textarea>
        </div>

        <div class="flex justify-end gap-3">
          <button
            type="button"
            onclick="closeAnnouncementModal()"
            class="px-5 py-2 rounded-lg bg-gray-600 text-white hover:bg-gray-700"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="px-5 py-2 rounded-lg bg-teal-600 text-white hover:bg-teal-700"
          >
            <span id="submitBtnText">Publish</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Mock data for slack style
  const messages = [
    {
      id: "m1",
      from: "Alice Kim",
      avatarIcon: "fa-user",
      text: "Morning team! Router update deployed.",
      time: "09:05",
      me: false,
    },
    {
      id: "m2",
      from: "You",
      avatarIcon: "fa-user",
      text: "Thanks — I will verify logs.",
      time: "09:07",
      me: true,
    },
    {
      id: "m3",
      from: "John Doe",
      avatarIcon: "fa-user",
      text: "Ticket #T100 closed.",
      time: "09:10",
      me: false,
    },
  ];

  const members = [
    { id: 1, name: "Alice Kim", role: "Engineer", online: true },
    { id: 2, name: "John Doe", role: "Support", online: true },
    { id: 3, name: "Sarah Njeri", role: "QA", online: false },
  ];

  const announcements = [
    {
      id: "a1",
      title: "Planned maintenance",
      body: "Network maintenance on Friday 2AM-4AM.",
    },
  ];

  const $ = (id) => document.getElementById(id);
  const txt = document.getElementById("messageInput");
  let currentEditId = null;

  txt.addEventListener("input", () => {
    txt.style.height = "auto";
    txt.style.height = txt.scrollHeight + "px";
  });

  function renderMembers() {
    const el = $("teamMembers");
    el.innerHTML = "";
    members.forEach((m) => {
      const node = document.createElement("div");
      node.className = "flex items-center justify-between";
      node.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-teal-600 text-white flex items-center justify-center shadow">
              <i class="fas fa-user"></i>
            </div>
            <div>
              <div class="text-sm font-semibold text-gray-900">${m.name}</div>
              <div class="text-xs text-gray-500">${m.role}</div>
            </div>
          </div>
          <div class="text-xs ${
            m.online ? "text-teal-600" : "text-gray-400"
          }">${m.online ? "Online" : "Offline"}</div>`;
      el.appendChild(node);
    });
    $("onlineCount").textContent =
      members.filter((x) => x.online).length + " members online";
  }

  function renderAnnouncements() {
    const el = $("announcements");
    el.innerHTML = "";

    announcements.forEach((a) => {
      const card = document.createElement("div");
      card.className =
        "p-3 border rounded-lg bg-teal-50 border-teal-100 relative group cursor-pointer hover:shadow-md transition-shadow";

      card.onclick = (e) => {
        if (e.target.closest("button")) return;
        openEditAnnouncement(a.id);
      };

      card.innerHTML = `
      <div class="pr-8">
        <div class="text-sm font-semibold text-gray-800">${a.title}</div>
        <div class="text-sm text-gray-600 mt-1">${a.body}</div>
      </div>

      <!-- Delete button (stops click propagation) -->
      <button
        onclick="event.stopPropagation(); deleteAnnouncement('${a.id}')"
        class="absolute top-2 right-2 p-1 text-gray-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition">
        <i class="fas fa-times text-sm"></i>
      </button>
    `;

      el.appendChild(card);
    });
  }

  function renderMessages() {
    const wrap = document.getElementById("chatMessages");
    wrap.innerHTML = "";

    messages.forEach((m) => {
      const row = document.createElement("div");
      row.className = `flex w-full ${m.me ? "justify-end" : "justify-start"}`;

      const bubbleWrap = document.createElement("div");
      bubbleWrap.className = m.me
        ? "flex items-end gap-2 max-w-[70%]"
        : "flex items-start gap-2 max-w-[70%]";

      const avatar = document.createElement("div");
      avatar.className =
        "w-9 h-9 rounded-full bg-teal-600 text-white flex-shrink-0 flex items-center justify-center text-sm";
      avatar.innerHTML = `<i class="fas ${m.avatarIcon}"></i>`;

      const bubble = document.createElement("div");
      bubble.className = `bubble px-4 py-2 rounded-2xl text-sm break-words ${
        m.me
          ? "bg-teal-600 text-white rounded-br-none"
          : "bg-gray-100 text-gray-800 rounded-tl-none"
      }`;

      bubble.innerHTML = `
      <div class="font-semibold">${m.from}</div>
      <div class="mt-1">${m.text}</div>
      <div class="text-xs mt-1 opacity-70">${m.time}</div>
    `;

      if (m.me) {
        bubbleWrap.appendChild(bubble);
        bubbleWrap.appendChild(avatar);
      } else {
        bubbleWrap.appendChild(avatar);
        bubbleWrap.appendChild(bubble);
      }

      row.appendChild(bubbleWrap);
      wrap.appendChild(row);
    });

    // ---- auto-scroll to bottom ----
    wrap.scrollTop = wrap.scrollHeight;
  }

  function sendMessage(e) {
    if (e) e.preventDefault();
    const txt = $("messageInput").value.trim();
    if (!txt) return;
    const now = new Date();
    messages.push({
      id: "m" + Date.now(),
      from: "You",
      avatarIcon: "fa-user",
      text: txt,
      time: now.toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit",
      }),
      me: true,
    });
    $("messageInput").value = "";
    renderMessages();
  }

  function refreshChat() {
    renderMessages();
    renderMembers();
    renderAnnouncements();
  }

  function clearChat() {
    if (!confirm("Clear all messages?")) return;
    messages.length = 0;
    renderMessages();
  }

  function createAnnouncement() {
    currentEditId = null;
    document.getElementById("modalHeader").textContent = "New Announcement";
    document.getElementById("submitBtnText").textContent = "Publish";
    document.getElementById("editId").value = "";
    document.getElementById("annTitle").value = "";
    document.getElementById("annBody").value = "";
    document.getElementById("announcementModal").classList.remove("hidden");
  }

  function openEditAnnouncement(id) {
    const ann = announcements.find((a) => a.id === id);
    if (!ann) return;

    currentEditId = id;
    document.getElementById("modalHeader").textContent = "Edit Announcement";
    document.getElementById("submitBtnText").textContent = "Save Changes";
    document.getElementById("editId").value = id;
    document.getElementById("annTitle").value = ann.title;
    document.getElementById("annBody").value = ann.body;
    document.getElementById("announcementModal").classList.remove("hidden");
  }

  function closeAnnouncementModal() {
    document.getElementById("announcementModal").classList.add("hidden");
    currentEditId = null;
  }

  function saveAnnouncement(e) {
    e.preventDefault();

    const title = document.getElementById("annTitle").value.trim();
    const body = document.getElementById("annBody").value.trim();
    const editId = document.getElementById("editId").value;

    if (!title || !body) return;

    if (editId && currentEditId) {
      // === EDIT EXISTING ===
      const ann = announcements.find((a) => a.id === editId);
      if (ann) {
        ann.title = title;
        ann.body = body;
      }
    } else {
      // === CREATE NEW ===
      announcements.unshift({
        id: "a" + Date.now(),
        title,
        body,
      });
    }

    renderAnnouncements();
    closeAnnouncementModal();
  }

  function deleteAnnouncement(id) {
    if (!confirm("Delete this announcement?")) return;
    const index = announcements.findIndex((a) => a.id === id);
    if (index !== -1) announcements.splice(index, 1);
    renderAnnouncements();
  }

  // init
  window.addEventListener("load", () => {
    renderMessages();
    renderMembers();
    renderAnnouncements();
  });
</script>
