<style>
  .tab-button.active {
    background: linear-gradient(to right, #0d9488, #0f766e);
    color: white;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
      0 2px 4px -2px rgba(0, 0, 0, 0.1);
  }
  .tab-button:not(.active):hover {
    background-color: #f0fdfa;
    color: #0f766e;
  }
  .receipt-modal {
    transition: all 0.3s ease;
  }
  .modal-backdrop {
    background-color: rgba(0, 0, 0, 0.5);
  }
</style>

<div class="flex items-center justify-between mb-8">
  <div>
    <h3 class="text-2xl font-bold text-teal-800">Finance</h3>
    <p class="text-teal-600 mt-1">
      Manage invoices, receipts, payslips
    </p>
  </div>
</div>
<!-- Tab Navigation -->
<div class="w-full mt-6 mb-8">
  <div
    class="flex flex-wrap w-full gap-2 bg-white/60 backdrop-blur border border-gray-200 p-2 shadow-sm"
  >
    <button
      id="invoicesTab"
      class="tab-button grow px-6 py-3 font-semibold flex items-center justify-center gap-2 transition-all duration-200 bg-white text-gray-700 active"
      onclick="showTab('invoices')"
    >
      <i data-lucide="scroll-text" class="w-5 h-5"></i> Client Invoices
    </button>

    <button
      id="receiptsTab"
      class="tab-button grow px-6 py-3 font-semibold flex items-center justify-center gap-2 transition-all duration-200 hover:bg-gray-100"
      onclick="showTab('receipts')"
    >
      <i data-lucide="receipt" class="w-5 h-5"></i> Payment Receipts
    </button>

    <button
      id="payslipsTab"
      class="tab-button grow px-6 py-3 font-semibold flex items-center justify-center gap-2 transition-all duration-200 hover:bg-gray-100"
      onclick="showTab('payslips')"
    >
      <i data-lucide="wallet" class="w-5 h-5"></i> Staff Payslips
    </button>
  </div>

  <!-- Tab Content Sections -->
  <section id="reports-finance" class="space-y-8 pb-20">
    <!-- Invoices Section -->
    <div id="invoicesSection" class="tab-content space-y-8">
      <h3 class="text-2xl font-bold text-teal-600 mb-8">
        Client Invoices & Management
      </h3>

      <!-- Invoice Builder -->
      <div
        class="bg-white/90 backdrop-blur-sm p-8 border border-teal-100 rounded-2xl"
      >
        <h4 class="text-sm font-semibold text-gray-800 mb-6 border-b pb-2">
          Generate New Invoice
        </h4>

        <!-- Client Selection / Manual -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-search text-teal-600 mr-1"></i>Search & Select
              Client
            </label>
            <div class="relative">
              <input
                type="text"
                id="clientSearch"
                placeholder="Type name, phone, email..."
                class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100 transition-all"
              />
              <i
                class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
              ></i>
            </div>
            <select
              id="clientSelect"
              size="5"
              class="mt-2 w-full p-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100 bg-white"
              onchange="selectClient(this.value)"
            ></select>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-user-edit text-teal-600 mr-1"></i>Or Enter
              Manually
            </label>
            <div class="space-y-3">
              <input
                type="text"
                id="manualName"
                placeholder="Client Name"
                class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100"
              />
              <input
                type="text"
                id="manualPhone"
                placeholder="Phone"
                class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100"
              />
              <input
                type="email"
                id="manualEmail"
                placeholder="Email (optional)"
                class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100"
              />
              <input
                type="text"
                id="manualPeriod"
                placeholder="Billing Period (e.g. Nov 2025)"
                class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100"
              />
              <input
                type="date"
                id="manualDueDate"
                placeholder="Due Date"
                class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100"
              />
              <input
                type="text"
                id="manualLocation"
                placeholder="Location (e.g. Nairobi)"
                class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100"
              />
            </div>
          </div>
        </div>

        <!-- Add Item Button -->
        <div class="flex justify-between items-center mb-4">
          <h5 class="font-semibold text-gray-800">Invoice Items</h5>
          <button
            onclick="addInvoiceItem()"
            class="bg-teal-600 hover:bg-teal-700 text-white px-5 py-2 rounded-lg font-medium shadow-md flex items-center gap-2"
          >
            <i class="fas fa-plus"></i> Add Item
          </button>
        </div>

        <!-- Items Container -->
        <div id="invoiceItemsContainer" class="space-y-3 mb-6">
          <div
            class="p-4 bg-teal-50 border border-teal-200 text-sm text-teal-800 text-center"
          >
            No items added. Click "Add Item" to begin.
          </div>
        </div>

        <!-- Totals -->
        <div
          class="bg-gradient-to-r from-teal-50 to-teal-100 p-5 rounded-xl border border-teal-300"
        >
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-right">
            <div>
              <p class="text-sm text-gray-600">Subtotal</p>
              <p id="subtotal" class="text-xl font-bold text-gray-800">
                KES 0.00
              </p>
            </div>
            <div>
              <p class="text-sm text-gray-600">VAT (0%)</p>
              <p id="vat" class="text-xl font-bold text-gray-800">KES 0.00</p>
            </div>
            <div class="md:col-span-2">
              <p class="text-sm text-gray-600">Grand Total</p>
              <p id="grandTotal" class="text-2xl font-bold text-teal-700">
                KES 0.00
              </p>
            </div>
          </div>
        </div>

        <!-- Generate Button -->
        <div class="flex justify-end mt-6">
          <button
            onclick="generateAndSaveInvoice()"
            class="bg-gradient-to-r from-teal-600 to-teal-700 hover:from-teal-700 hover:to-teal-800 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all flex items-center gap-2"
          >
            <i class="fas fa-file-invoice"></i> Generate & Save Invoice
          </button>
        </div>
      </div>

      <!-- Generated Invoices Table -->
      <div
        class="bg-white/90 backdrop-blur-sm p-8 shadow-xl border border-teal-100"
      >
        <h4 class="text-xl font-semibold text-teal-800 mb-6 border-b pb-2">
          Generated Invoices
        </h4>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-teal-50">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider"
                >
                  Invoice #
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider"
                >
                  Client
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider"
                >
                  Period
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider"
                >
                  Amount
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider"
                >
                  Date
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider"
                >
                  Actions
                </th>
              </tr>
            </thead>
            <tbody
              id="invoicesTableBody"
              class="bg-white divide-y divide-gray-200"
            >
              <!-- Populated via JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Receipts Section -->
    <div id="receiptsSection" class="tab-content hidden space-y-8">
      <h3 class="text-2xl font-bold text-teal-600 mb-8">Payment Receipts</h3>

      <!-- Receipt Generation -->
      <div
        class="bg-white/90 backdrop-blur-sm p-8 border border-teal-100 rounded-2xl"
      >
        <h4 class="text-sm font-semibold text-gray-800 mb-6 border-b pb-2">
          Generate Payment Receipt
        </h4>

        <!-- Toggle Buttons -->
        <div class="flex gap-4 mb-6">
          <button
            id="selectClientBtn"
            onclick="toggleReceiptMode('select')"
            class="tab-button px-5 py-2 rounded-lg bg-teal-600 text-white font-medium active"
          >
            Select Client
          </button>
          <button
            id="manualEntryBtn"
            onclick="toggleReceiptMode('manual')"
            class="tab-button px-5 py-2 rounded-lg bg-gray-200 text-gray-700 font-medium hover:bg-gray-300"
          >
            Enter Manually
          </button>
        </div>

        <!-- ==== SELECT CLIENT MODE ==== -->
        <div id="selectClientMode">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <!-- Search & Select -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2"
                >Search & Select Client</label
              >
              <div class="relative">
                <input
                  type="text"
                  id="receiptClientSearch"
                  placeholder="Type name, phone, email..."
                  class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100 transition-all"
                />
                <i
                  class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
                ></i>
              </div>
              <select
                id="receiptClientSelect"
                size="5"
                class="mt-2 w-full p-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100 bg-white"
                onchange="selectReceiptClient(this.value)"
              ></select>
            </div>

            <!-- Selected Client Card -->
            <div
              id="selectedClientInfo"
              class="hidden p-4 bg-teal-50 border border-teal-200 rounded-xl"
            >
              <p class="text-sm font-medium text-teal-800">Selected Client:</p>
              <p id="selectedClientName" class="font-bold text-gray-800"></p>
              <p id="selectedClientPhone" class="text-sm text-gray-600"></p>
              <p
                id="selectedClientPackage"
                class="text-sm font-medium text-teal-700 mt-1"
              ></p>
            </div>

            <!-- Generate Button -->
            <div class="flex items-end">
              <button
                onclick="generateReceiptFromSelection()"
                class="bg-gradient-to-r from-teal-600 to-teal-700 hover:from-teal-700 hover:to-teal-800 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all flex items-center gap-2 w-full"
              >
                <i class="fas fa-file-invoice"></i> Generate Receipt
              </button>
            </div>
          </div>
        </div>

        <!-- ==== MANUAL / AUTO-FILLED FORM ==== -->
        <div
          id="receiptFormContainer"
          class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6"
        >
          <!-- Row 1 -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2"
              >Client Name *</label
            >
            <input
              type="text"
              id="receiptClientName"
              required
              class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100"
              placeholder="e.g. John Doe"
            />
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2"
              >Phone *</label
            >
            <input
              type="text"
              id="receiptClientPhone"
              required
              class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100"
              placeholder="e.g. 0712345678"
            />
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2"
              >Location (optional)</label
            >
            <input
              type="text"
              id="receiptClientLocation"
              class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100"
              placeholder="e.g. Nairobi"
            />
          </div>

          <!-- Row 2 -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2"
              >Billing Period (optional)</label
            >
            <input
              type="text"
              id="receiptBillingPeriod"
              class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100"
              placeholder="e.g. November 2025"
            />
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2"
              >Email (optional)</label
            >
            <input
              type="email"
              id="receiptClientEmail"
              class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100"
              placeholder="client@example.com"
            />
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2"
              >Amount Paid (KES) *</label
            >
            <input
              type="number"
              id="receiptAmount"
              required
              min="0"
              step="0.01"
              class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100"
              placeholder="5500"
            />
          </div>

          <!-- Row 3 -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2"
              >Payment Date *</label
            >
            <input
              type="date"
              id="receiptPaymentDate"
              required
              class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100"
            />
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2"
              >Transaction Ref (optional)</label
            >
            <input
              type="text"
              id="receiptTxRef"
              class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100"
              placeholder="e.g. MPESA123XYZ"
            />
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2"
              >Payment Method *</label
            >
            <select
              id="receiptPaymentMethod"
              required
              class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100 bg-white"
            >
              <option value="">Select...</option>
              <option value="mpesa">M-Pesa</option>
              <option value="bank">Bank Transfer</option>
              <option value="cash">Cash</option>
              <option value="cheque">Cheque</option>
              <option value="card">Card</option>
            </select>
          </div>

          <!-- Note -->
          <div class="md:col-span-3">
            <label class="block text-sm font-semibold text-gray-700 mb-2"
              >Note (optional)</label
            >
            <textarea
              id="receiptNote"
              rows="2"
              class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100"
              placeholder="Any additional info..."
            ></textarea>
          </div>

          <!-- Generate Button (Manual Mode) -->
          <div class="md:col-span-3 flex justify-end mt-4 gap-4">
            <button
              id="manualGenerateBtn"
              onclick="generateManualReceipt()"
              class="bg-gradient-to-r from-teal-600 to-teal-700 hover:from-teal-700 hover:to-teal-800 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all flex items-center gap-2"
            >
              <i class="fas fa-receipt"></i> Generate Receipt
            </button>
            <button
              onclick="resetReceiptForm()"
              class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-medium shadow-md transition-all hidden"
              id="cancelEditBtn"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>

      <!-- Recent Receipts (unchanged) -->
      <div
        class="bg-white/90 backdrop-blur-sm p-8 shadow-xl border border-teal-100 rounded-2xl"
      >
        <h4 class="text-xl font-semibold text-teal-800 mb-6 border-b pb-2">
          Recent Receipts
        </h4>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-teal-50">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider"
                >
                  Receipt #
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider"
                >
                  Client
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider"
                >
                  Amount
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider"
                >
                  Date
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider"
                >
                  Method
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider"
                >
                  Actions
                </th>
              </tr>
            </thead>
            <tbody
              id="receiptsTableBody"
              class="bg-white divide-y divide-gray-200"
            >
              <!-- Populated via JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Payslips Section -->
    <div id="payslipsSection" class="tab-content hidden space-y-8">
      <h3 class="text-2xl font-bold text-teal-600 mb-8">
        Staff Payslips Management
      </h3>

      <!-- Staff Selection & Preview -->
      <div
        class="bg-white/90 backdrop-blur-sm p-8 border border-teal-100 rounded-2xl shadow-xl"
      >
        <h4 class="text-sm font-semibold text-gray-800 mb-6 border-b pb-2">
          Select Staff to Generate Payslip
        </h4>

        <!-- Search & Multi-Select -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-search text-teal-600 mr-1"></i> Search & Select
              Staff
            </label>
            <div class="relative">
              <input
                type="text"
                id="payslipStaffSearch"
                placeholder="Search by name, phone, ID..."
                class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100 transition-all"
              />
              <i
                class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
              ></i>
            </div>
            <select
              id="payslipStaffSelect"
              multiple
              size="6"
              class="mt-2 w-full p-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100 bg-white text-sm"
            ></select>
            <p class="text-xs text-gray-500 mt-1">
              Hold Ctrl/Cmd to select multiple
            </p>
          </div>
        </div>

        <!-- Selected Staff Preview + Period Input -->
        <div id="selectedStaffPreview" class="hidden mt-6 space-y-4">
          <h5 class="font-semibold text-teal-800 flex items-center gap-2">
            <i class="fas fa-users"></i> Selected Staff Preview
          </h5>

          <!-- Staff Cards -->
          <div
            id="staffPreviewContainer"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
          ></div>

          <!-- Pay Period Input -->
          <div
            class="mt-6 p-4 bg-gradient-to-r from-teal-50 to-teal-100 border border-teal-300 rounded-xl"
          >
            <label class="block text-sm font-semibold text-teal-800 mb-2">
              <i class="fas fa-calendar-alt mr-1"></i> Pay Period (Required)
            </label>
            <input
              type="text"
              id="payslipPeriodInput"
              placeholder="e.g. November 2025"
              class="w-full md:w-64 p-3 border-2 border-teal-200 rounded-lg focus:border-teal-600 focus:ring-4 focus:ring-teal-100 transition-all font-medium"
              required
            />
            <p class="text-xs text-teal-700 mt-1">
              This will appear on all generated payslips
            </p>
          </div>

          <!-- Generate Button (Moved here) -->
          <div class="flex justify-end mt-4">
            <button
              onclick="generateSelectedPayslips()"
              id="generatePayslipsBtn"
              disabled
              class="bg-gradient-to-r from-teal-600 to-teal-700 hover:from-teal-700 hover:to-teal-800 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <i class="fas fa-file-invoice"></i> Generate Payslips
            </button>
          </div>
        </div>
      </div>

      <!-- Generated Payslips Table -->
      <div
        class="bg-white/90 backdrop-blur-sm p-8 shadow-xl border border-teal-100 rounded-2xl"
      >
        <h4 class="text-xl font-semibold text-teal-800 mb-6 border-b pb-2">
          Generated Payslips
        </h4>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-teal-50">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider"
                >
                  Payslip ID
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider"
                >
                  Staff
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider"
                >
                  Period
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider"
                >
                  Net Pay
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider"
                >
                  Status
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider"
                >
                  Actions
                </th>
              </tr>
            </thead>
            <tbody
              id="payslipsTableBody"
              class="bg-white divide-y divide-gray-200"
            >
              <!-- Populated via JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>
</div>


<script>
  const API_BASE = "/api"; 
  const formatKES = (n) =>
    `KES ${Number(n)
      .toFixed(2)
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;

  const api = async (path, opts = {}) => {
    const res = await fetch(`${API_BASE}${path}`, {
      headers: { "Content-Type": "application/json" },
      ...opts,
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  };

  // --------------------------------------------------------------
  //  TAB CONTROL
  // --------------------------------------------------------------
  let currentTab = "invoices";
  function showTab(id) {
    document
      .querySelectorAll(".tab-content")
      .forEach((s) => s.classList.add("hidden"));
    document
      .querySelectorAll(".tab-button")
      .forEach((b) => b.classList.remove("active"));
    document.getElementById(`${id}Section`)?.classList.remove("hidden");
    document.getElementById(`${id}Tab`)?.classList.add("active");
    currentTab = id;
    window[`setup${id.charAt(0).toUpperCase() + id.slice(1)}Tab`]?.();
  }

  // --------------------------------------------------------------
  //  COMMON POPULATE SELECTS
  // --------------------------------------------------------------
  async function populateSelect(url, selectId, textFn) {
    const data = await api(url);
    const sel = document.getElementById(selectId);
    sel.innerHTML = '<option value="">Choose...</option>';
    data.forEach((o) => {
      const opt = document.createElement("option");
      opt.value = o.id;
      opt.textContent = textFn(o);
      sel.appendChild(opt);
    });
  }

  // --------------------------------------------------------------
  //  INVOICES
  // --------------------------------------------------------------
  let invoiceItems = [];
  let clientsCache = [];
  let selectedClient = null;

  // Load clients on tab open
  async function setupInvoicesTab() {
    try {
      clientsCache = await api("/clients");
      populateClientSelect();
      loadGeneratedInvoices();
    } catch (e) {
      console.error(e);
    }
  }

  // Search & filter clients
  document.getElementById("clientSearch").addEventListener("input", (e) => {
    populateClientSelect(e.target.value);
  });

  function populateClientSelect(filter = "") {
    const select = document.getElementById("clientSelect");
    const filtered = clientsCache.filter((c) =>
      `${c.first_name} ${c.second_name} ${c.phone} ${c.email}`
        .toLowerCase()
        .includes(filter.toLowerCase())
    );
    select.innerHTML =
      filtered
        .map(
          (c) => `
      <option value="${c.id}">
        ${c.first_name} ${c.second_name} – ${c.phone} (${c.email})
      </option>
    `
        )
        .join("") || "<option disabled>No clients found</option>";
  }

  function selectClient(clientId) {
    if (!clientId) return;
    selectedClient = clientsCache.find((c) => c.id == clientId);
    if (selectedClient) {
      document.getElementById(
        "manualName"
      ).value = `${selectedClient.first_name} ${selectedClient.second_name}`;
      document.getElementById("manualPhone").value = selectedClient.phone;
      document.getElementById("manualEmail").value = selectedClient.email;
    }
  }

  // Add new item
  function addInvoiceItem() {
    invoiceItems.push({
      id: Date.now(),
      description: "",
      quantity: 1,
      amount: 0,
    });
    renderInvoiceItems();
  }

  // Remove item
  function removeInvoiceItem(id) {
    invoiceItems = invoiceItems.filter((i) => i.id !== id);
    renderInvoiceItems();
  }

  // Update item
  function updateInvoiceItem(id, field, value) {
    const item = invoiceItems.find((i) => i.id === id);
    if (!item) return;

    // Update model
    item[field] = field === "description" ? value : Number(value) || 0;

    // Update only the **total** for this row
    const row = document.querySelector(`[data-item-id="${id}"]`);
    if (row) {
      const qty = item.quantity;
      const amt = item.amount;
      const total = qty * amt;
      row.querySelector(
        ".item-total"
      ).textContent = `KES ${total.toLocaleString()}`;
    }

    // Update grand totals
    updateTotals();
  }

  // Render items + totals
  function renderInvoiceItems() {
    const container = document.getElementById("invoiceItemsContainer");
    if (!invoiceItems.length) {
      container.innerHTML = `
        <div class="p-4 bg-teal-50 border border-teal-200 text-sm text-teal-800 text-center rounded-lg">
          No items added. Click "Add Item" to begin.
        </div>`;
      updateTotals();
      return;
    }

    let subtotal = 0;
    container.innerHTML = invoiceItems
      .map((item) => {
        const total = item.quantity * item.amount;
        subtotal += total;

        // Unique IDs for label-for association
        const descId = `desc-${item.id}`;
        const qtyId = `qty-${item.id}`;
        const amountId = `amt-${item.id}`;

        return `
        <div class="grid grid-cols-1 md:grid-cols-6 gap-3 p-3 bg-gray-50 border rounded-lg items-center"
             data-item-id="${item.id}">

          <!-- ==== DESCRIPTION ==== -->
          <div class="col-span-2 flex flex-col">
            <label for="${descId}" class="text-xs font-medium text-gray-700 mb-1">
              Description
            </label>
            <input id="${descId}"
                   value="${item.description}"
                   onchange="updateInvoiceItem(${
                     item.id
                   }, 'description', this.value)"
                   class="p-2 border rounded text-sm"
                   placeholder="Item description" />
          </div>

          <!-- ==== QUANTITY ==== -->
          <div class="flex flex-col">
            <label for="${qtyId}" class="text-xs font-medium text-gray-700 mb-1">
              Qty
            </label>
            <input id="${qtyId}"
                   type="number"
                   value="${item.quantity}"
                   min="1"
                   onchange="updateInvoiceItem(${
                     item.id
                   }, 'quantity', this.value)"
                   class="p-2 border rounded text-sm w-20" />
          </div>

          <!-- ==== AMOUNT ==== -->
          <div class="flex flex-col">
            <label for="${amountId}" class="text-xs font-medium text-gray-700 mb-1">
              Amount (KES)
            </label>
            <input id="${amountId}"
                   type="number"
                   value="${item.amount}"
                   min="0"
                   step="0.01"
                   onchange="updateInvoiceItem(${
                     item.id
                   }, 'amount', this.value)"
                   class="p-2 border rounded text-sm w-28"
                   placeholder="0.00" />
          </div>

          <!-- ==== LINE TOTAL ==== -->
          <div class="text-right font-medium item-total">
            KES ${total.toLocaleString(undefined, { minimumFractionDigits: 2 })}
          </div>

          <!-- ==== REMOVE ==== -->
          <button onclick="removeInvoiceItem(${item.id})"
                  class="text-red-600 hover:text-red-800 transition"
                  title="Remove item">
            <i class="fas fa-trash"></i>
          </button>
        </div>`;
      })
      .join("");

    updateTotals();
  }

  function updateTotals() {
    const subtotal = invoiceItems.reduce(
      (sum, item) => sum + (item.quantity || 0) * (item.amount || 0),
      0
    );
    const vat = 0; // You said VAT is 0
    const grand = subtotal + vat;

    // Update Subtotal
    const subtotalEl = document.getElementById("subtotal");
    if (subtotalEl) {
      subtotalEl.textContent = formatKES(subtotal);
    }

    // Update VAT (make sure you have <span id="vatAmount">)
    const vatEl = document.getElementById("vatAmount");
    if (vatEl) {
      vatEl.textContent = formatKES(vat);
    }

    // Update Grand Total
    const grandTotalEl = document.getElementById("grandTotal");
    if (grandTotalEl) {
      grandTotalEl.textContent = formatKES(grand);
    }
  }

  // Generate & Save Invoice
  async function generateAndSaveInvoice() {
    if (!invoiceItems.length) return alert("Add at least one item");

    const clientData = {
      name: document.getElementById("manualName").value.trim(),
      phone: document.getElementById("manualPhone").value.trim(),
      email: document.getElementById("manualEmail").value.trim(),
      period: document.getElementById("manualPeriod").value.trim(),
      location: document.getElementById("manualLocation").value.trim(),
      dueDate: document.getElementById("manualDueDate").value.trim() || null,
      clientId: selectedClient?.id || null,
    };

    if (!clientData.name || !clientData.phone || !clientData.period) {
      return alert("Fill all fields");
    }

    const payload = {
      client: clientData,
      items: invoiceItems.map((i) => ({
        description: i.description,
        quantity: i.quantity,
        amount: i.amount,
      })),
    };

    try {
      const res = await api("/invoices/generate", {
        method: "POST",
        body: JSON.stringify(payload),
      });

      // Reset form
      invoiceItems = [];
      renderInvoiceItems();
      document.getElementById("manualName").value = "";
      document.getElementById("manualPhone").value = "";
      document.getElementById("manualEmail").value = "";
      document.getElementById("manualPeriod").value = "";
      document.getElementById("manualLocation").value = "";
      document.getElementById("manualDueDate").value = "";
      selectedClient = null;
      document.getElementById("clientSearch").value = "";

      Swal.fire(
        "Success!",
        `Invoice #${res.id} generated and saved.`,
        "success"
      );
      loadGeneratedInvoices();
      lucide.createIcons();
    } catch (e) {
      Swal.fire("Error", e.message, "error");
    }
  }

  // Load all generated invoices
  async function loadGeneratedInvoices() {
    try {
      const invoices = await api("/invoices");
      renderInvoicesTable(invoices);
    } catch (e) {
      console.error(e);
    }
  }

  function renderInvoicesTable(invoices) {
    const tbody = document.getElementById("invoicesTableBody");
    tbody.innerHTML =
      invoices
        .map(
          (inv) => `
      <tr class="hover:bg-gray-50 transition">
        <td class="px-6 py-4 text-sm font-medium">#${inv.invoice_number}</td>
        <td class="px-6 py-4 text-sm">${
          inv.client.name
        }<br><small class="text-gray-500">${inv.client.phone}</small></td>
        <td class="px-6 py-4 text-sm">${inv.client.period}</td>
        <td class="px-6 py-4 text-sm font-semibold">KES ${Number(
          inv.total
        ).toLocaleString()}</td>
        <td class="px-6 py-4 text-sm">${new Date(
          inv.created_at
        ).toLocaleDateString()}</td>
        <td class="px-6 py-4 text-sm space-x-2">
          <button onclick="downloadInvoice(${
            inv.id
          })" class="text-teal-600 hover:text-teal-800" title="Download PDF">
            <i class="fas fa-download"></i>
          </button>
          <button onclick="deleteInvoice(${
            inv.id
          })" class="text-red-600 hover:text-red-800" title="Delete">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      </tr>
    `
        )
        .join("") ||
      `<tr><td colspan="6" class="text-center py-8 text-gray-500">No invoices generated yet</td></tr>`;
      lucide.createIcons();
  }

  // Action placeholders (implement in backend)
  async function downloadInvoice(id) {
    try {
      const invoice = await api(`/invoices/${id}`);
      generateInvoicePDF(invoice);
    } catch (e) {
      Swal.fire("Error", e.message || "Could not load invoice", "error");
    }
  }
  async function editInvoice(id) {
    alert(`Edit invoice #${id}`);
  }
  async function deleteInvoice(id) {
    if (confirm("Delete invoice?")) {
      await api(`/invoices/${id}`, { method: "DELETE" });
      loadGeneratedInvoices();
    }
  }
  async function generateReceiptFromInvoice(id) {
    const inv = (await api("/invoices")).find((i) => i.id === id);
    if (inv) {
      // Switch to receipts tab and prefill
      showTab("receipts");
      document.getElementById("receiptClient").value =
        inv.client.clientId || "";
      document.getElementById("receiptAmount").value = inv.total;
    }
  }

  let receiptClientsCache = [];
  let selectedReceiptClient = null;
  let receiptMode = "select";

  async function setupReceiptsTab() {
    try {
      receiptClientsCache = await api("/clients");
      populateReceiptClientSelect();
      loadReceipts();
      toggleReceiptMode("select");
    } catch (e) {
      console.error(e);
    }
  }

  function toggleReceiptMode(mode) {
    receiptMode = mode;

    document.getElementById("selectClientBtn").className =
      mode === "select"
        ? "tab-button px-5 py-2 rounded-lg bg-teal-600 text-white font-medium active"
        : "tab-button px-5 py-2 rounded-lg bg-gray-200 text-gray-700 font-medium hover:bg-gray-300";
    document.getElementById("manualEntryBtn").className =
      mode === "manual"
        ? "tab-button px-5 py-2 rounded-lg bg-teal-600 text-white font-medium active"
        : "tab-button px-5 py-2 rounded-lg bg-gray-200 text-gray-700 font-medium hover:bg-gray-300";

    document
      .getElementById("selectClientMode")
      .classList.toggle("hidden", mode !== "select");
    document
      .getElementById("receiptFormContainer")
      .classList.toggle("hidden", false);

    if (mode === "manual") clearReceiptForm();

    document
      .getElementById("manualGenerateBtn")
      .classList.toggle("hidden", mode === "select");
  }

  document
    .getElementById("receiptClientSearch")
    .addEventListener("input", (e) =>
      populateReceiptClientSelect(e.target.value)
    );

  function populateReceiptClientSelect(filter = "") {
    const select = document.getElementById("receiptClientSelect");
    const filtered = receiptClientsCache.filter((c) =>
      `${c.first_name} ${c.second_name} ${c.phone} ${c.email} ${c.plan || ""}`
        .toLowerCase()
        .includes(filter.toLowerCase())
    );

    select.innerHTML =
      filtered
        .map(
          (c) => `
        <option value="${c.id}" data-plan="${c.plan || ""}">
          ${c.first_name} ${c.second_name} – ${c.phone} (${c.email || "—"}) [${
            c.plan || "No Plan"
          }]
        </option>`
        )
        .join("") || "<option disabled>No clients found</option>";
  }

  function selectReceiptClient(clientId) {
    if (!clientId) return;
    selectedReceiptClient = receiptClientsCache.find((c) => c.id == clientId);
    if (!selectedReceiptClient) return;

    document.getElementById(
      "receiptClientName"
    ).value = `${selectedReceiptClient.first_name} ${selectedReceiptClient.second_name}`;
    document.getElementById("receiptClientPhone").value =
      selectedReceiptClient.phone;
    document.getElementById("receiptClientEmail").value =
      selectedReceiptClient.email || "";
    document.getElementById("receiptClientLocation").value =
      selectedReceiptClient.address || "";
    document.getElementById(
      "selectedClientName"
    ).textContent = `${selectedReceiptClient.first_name} ${selectedReceiptClient.second_name}`;
    document.getElementById("selectedClientPhone").textContent =
      selectedReceiptClient.phone;
    document.getElementById("selectedClientPackage").textContent = `Package: ${
      selectedReceiptClient.plan || "None"
    }`;
    document.getElementById("selectedClientInfo").classList.remove("hidden");

    document.getElementById("manualGenerateBtn").classList.remove("hidden");
  }

  function clearReceiptForm() {
    const fields = [
      "receiptClientName",
      "receiptClientPhone",
      "receiptClientEmail",
      "receiptClientLocation",
      "receiptBillingPeriod",
      "receiptAmount",
      "receiptPaymentDate",
      "receiptTxRef",
      "receiptPaymentMethod",
      "receiptNote",
    ];
    fields.forEach((id) => (document.getElementById(id).value = ""));
    document.getElementById("selectedClientInfo").classList.add("hidden");
    selectedReceiptClient = null;
  }

  async function generateReceiptFromSelection() {
    if (!selectedReceiptClient) return alert("Select a client first");
    alert(
      "Client data pre-filled – now fill Amount, Date, Method and click Generate Receipt."
    );
  }

  async function generateManualReceipt() {
    const payload = {
      clientId: selectedReceiptClient ? selectedReceiptClient.id : null,
      client: {
        name: document.getElementById("receiptClientName").value.trim(),
        phone: document.getElementById("receiptClientPhone").value.trim(),
        location: document.getElementById("receiptClientLocation").value.trim(),
        period: document.getElementById("receiptBillingPeriod").value.trim(),
        email: document.getElementById("receiptClientEmail").value.trim(),
      },
      amount: Number(document.getElementById("receiptAmount").value),
      paymentDate: document.getElementById("receiptPaymentDate").value,
      transactionRef:
        document.getElementById("receiptTxRef").value.trim() || null,
      paymentMethod: document.getElementById("receiptPaymentMethod").value,
      note: document.getElementById("receiptNote").value.trim() || null,
    };

    if (
      !payload.client.name ||
      !payload.client.phone ||
      !payload.amount ||
      !payload.paymentDate ||
      !payload.paymentMethod
    ) {
      return Swal.fire(
        "Missing fields",
        "Please fill all required fields (*).",
        "warning"
      );
    }

    try {
      const res = await api(
        selectedReceiptClient ? "/receipts" : "/receipts/manual",
        { method: "POST", body: JSON.stringify(payload) }
      );
      loadReceipts();
      clearReceiptForm();
      toggleReceiptMode("select");
    } catch (e) {
      Swal.fire("Error", e.message, "error");
    }
  }

  function closeReceiptModal() {
    document.getElementById("receiptViewModal").classList.add("hidden");
  }

  function printReceiptFromModal() {
    window.print();
  }

  async function loadReceipts() {
    try {
      const data = await api("/receipts");
      renderReceiptsTable(data);
    } catch (e) {
      console.error(e);
    }
  }

  function renderReceiptsTable(list) {
    const tbody = document.getElementById("receiptsTableBody");
    tbody.innerHTML = "";
    if (!list.length) {
      tbody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-gray-500">No receipts generated yet</td></tr>`;
      return;
    }
    list.forEach((r) => {
      tbody.insertAdjacentHTML(
        "beforeend",
        `<tr class="hover:bg-gray-50 transition">
          <td class="px-6 py-4 text-sm font-medium">#${r.id}</td>
          <td class="px-6 py-4 text-sm">${
            r.clientName
          }<br><small class="text-gray-500">${r.clientPhone}</small></td>
          <td class="px-6 py-4 text-sm font-semibold">${formatKES(
            r.amount
          )}</td>
          <td class="px-6 py-4 text-sm">${new Date(
            r.paymentDate
          ).toLocaleDateString()}</td>
          <td class="px-6 py-4 text-sm">${r.paymentMethod}</td>
          <td class="px-6 py-4 text-sm space-x-2">
            <button onclick="editReceipt('${
              r.id
            }')" class="text-blue-600 hover:text-blue-800" title="Edit"><i class="fas fa-edit"></i></button>
            <button onclick="downloadReceipt('${
              r.id
            }')" class="text-green-600 hover:text-green-800" title="Download PDF"><i class="fas fa-download"></i></button>
            <button onclick="deleteReceipt('${
              r.id
            }')" class="text-red-600 hover:text-red-800" title="Delete"><i class="fas fa-trash"></i></button>
          </td>
        </tr>`
      );
    });
  }

  let editingReceiptId = null;

  async function editReceipt(id) {
    try {
      const receipt = await api(`/receipts/${id}`);

      editingReceiptId = id;

      toggleReceiptMode("manual");

      document.getElementById("receiptClientName").value = receipt.client.name;
      document.getElementById("receiptClientPhone").value =
        receipt.client.phone;
      document.getElementById("receiptClientEmail").value =
        receipt.client.email || "";
      document.getElementById("receiptClientLocation").value =
        receipt.client.location || "";
      document.getElementById("receiptBillingPeriod").value =
        receipt.client.period || "";
      document.getElementById("receiptAmount").value = receipt.amount;
      document.getElementById("receiptPaymentDate").value = receipt.paymentDate;
      document.getElementById("receiptTxRef").value =
        receipt.transactionRef || "";
      document.getElementById("receiptPaymentMethod").value =
        receipt.paymentMethod;
      document.getElementById("receiptNote").value = receipt.note || "";
      document.getElementById("cancelEditBtn").classList.remove("hidden");

      const btn = document.getElementById("manualGenerateBtn");
      btn.textContent = "Update Receipt";
      btn.onclick = updateReceipt;

      document
        .getElementById("receiptFormContainer")
        .scrollIntoView({ behavior: "smooth" });
    } catch (err) {
      Swal.fire("Error", "Could not load receipt for editing.", "error");
    }
  }

  async function updateReceipt() {
    const payload = {
      client: {
        name: document.getElementById("receiptClientName").value.trim(),
        phone: document.getElementById("receiptClientPhone").value.trim(),
        location: document.getElementById("receiptClientLocation").value.trim(),
        period: document.getElementById("receiptBillingPeriod").value.trim(),
        email: document.getElementById("receiptClientEmail").value.trim(),
      },
      amount: Number(document.getElementById("receiptAmount").value),
      paymentDate: document.getElementById("receiptPaymentDate").value,
      transactionRef:
        document.getElementById("receiptTxRef").value.trim() || null,
      paymentMethod: document.getElementById("receiptPaymentMethod").value,
      note: document.getElementById("receiptNote").value.trim() || null,
    };

    if (
      !payload.client.name ||
      !payload.client.phone ||
      !payload.amount ||
      !payload.paymentDate ||
      !payload.paymentMethod
    ) {
      return Swal.fire(
        "Missing fields",
        "Please fill all required fields.",
        "warning"
      );
    }

    try {
      await api(`/receipts/${editingReceiptId}`, {
        method: "PATCH",
        body: JSON.stringify(payload),
      });

      Swal.fire("Updated!", "Receipt updated successfully.", "success");
      loadReceipts();
      resetReceiptForm();
    } catch (e) {
      Swal.fire("Error", e.message, "error");
    }
  }

  function resetReceiptForm() {
    clearReceiptForm();
    toggleReceiptMode("select");
    const btn = document.getElementById("manualGenerateBtn");
    document.getElementById("cancelEditBtn").classList.add("hidden");
    btn.textContent = "Generate Receipt";
    btn.onclick = generateManualReceipt;
    editingReceiptId = null;
  }

  async function deleteReceipt(id) {
    if (
      !confirm(
        "Are you sure you want to delete this receipt? This cannot be undone."
      )
    )
      return;

    try {
      await api(`/receipts/${id}`, { method: "DELETE" });
      loadReceipts();
      Swal.fire("Deleted!", "Receipt has been removed.", "success");
    } catch (e) {
      Swal.fire("Error", e.message, "error");
    }
  }

  let staffCache = [];
  let salaryCache = {}; 
  let selectedStaffIds = [];
  let generatedPayslips = [];

  let staffTempData = {};

  async function setupPayslipsTab() {
    try {
      staffCache = await api("/staff");
      salaryCache = {};
      const salaries = await api("/staff/salaries");
      salaries.forEach((s) => (salaryCache[s.staff_id] = s));

      document
        .getElementById("payslipPeriodInput")
        ?.addEventListener("input", updateGenerateButton);

      populatePayslipStaffSelect();
      loadGeneratedPayslips();
    } catch (e) {
      console.error(e);
    }
  }

  document
    .getElementById("payslipStaffSearch")
    .addEventListener("input", (e) =>
      populatePayslipStaffSelect(e.target.value)
    );

  function populatePayslipStaffSelect(filter = "") {
    const select = document.getElementById("payslipStaffSelect");
    const filtered = staffCache.filter((s) =>
      `${s.first_name + " " + s.second_name} ${s.phone} ${s.employeeId} ${s.department}`
        .toLowerCase()
        .includes(filter.toLowerCase())
    );

    select.innerHTML =
      filtered
        .map(
          (s) => `
        <option value="${s.id}" data-dept="${s.department}" data-pos="${s.position}">
          ${s.first_name + " " + s.second_name} – (${s.phone}) [${s.department}]
        </option>
      `
        )
        .join("") || "<option disabled>No staff found</option>";

    Array.from(select.options).forEach(
      (o) => (o.selected = selectedStaffIds.includes(o.value))
    );
  }

  document
    .getElementById("payslipStaffSelect")
    .addEventListener("change", () => {
      selectedStaffIds = Array.from(
        document.getElementById("payslipStaffSelect").selectedOptions
      ).map((o) => o.value);
      updateGenerateButton();
      renderSelectedStaffPreview();
    });

  function updateGenerateButton() {
    const btn = document.getElementById("generatePayslipsBtn");
    const period = document.getElementById("payslipPeriodInput")?.value.trim();
    const enabled = selectedStaffIds.length && period;
    btn.disabled = !enabled;
    btn.classList.toggle("opacity-50", !enabled);
    btn.classList.toggle("cursor-not-allowed", !enabled);
  }

  function renderSelectedStaffPreview() {
    const container = document.getElementById("staffPreviewContainer");
    const preview = document.getElementById("selectedStaffPreview");

    if (!selectedStaffIds.length) {
      preview.classList.add("hidden");
      return;
    }

    const periodInput = document.getElementById("payslipPeriodInput");
    if (!periodInput.value) {
      const now = new Date();
      periodInput.value = `${now.toLocaleString("default", {
        month: "long",
      })} ${now.getFullYear()}`;
      updateGenerateButton();
    }

    preview.classList.remove("hidden");
    container.innerHTML = selectedStaffIds
      .map((id) => buildStaffCard(id))
      .join("");

    selectedStaffIds.forEach((id) => window.recalc(id));
  }

  function buildStaffCard(staffId) {
    const staff = staffCache.find((s) => String(s.id) === String(staffId));

    if (!staff) {
        return `<div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                  <p class="text-red-600">Staff data not found</p>
                </div>`;
    }

    const salary = salaryCache[staffId] || {
      basic_salary: 0,
      net_salary: 0,
      effective_from: "N/A",
    };
    const temp = staffTempData[staffId] || { allowances: [], deductions: [] };

    const recalc = () => {
      const basic = Number(salary.basic_salary) || 0;
      const alw = temp.allowances.reduce(
        (s, a) => s + Number(a.amount || 0),
        0
      );
      const ded = temp.deductions.reduce(
        (s, d) => s + Number(d.amount || 0),
        0
      );
      const net = basic + alw - ded;
      document.querySelector(`[data-staff="${staffId}"] .net-pay`).textContent =
        formatKES(net);
    };

    const lineHTML = (type, idx, item = { desc: "", amount: 0 }) => `
      <div class="flex gap-2 items-center mt-1">
        <input type="text" placeholder="Description"
              class="flex-1 p-1 text-xs border rounded"
              value="${item.desc}"
              onchange="updateTemp('${staffId}','${type}',${idx},'desc',this.value); window.recalc('${staffId}');">
        <input type="number" placeholder="0.00" min="0" step="0.01"
              class="w-20 p-1 text-xs border rounded text-right"
              value="${item.amount}"
              onchange="updateTemp('${staffId}','${type}',${idx},'amount',this.value); window.recalc('${staffId}');">
        <button type="button" class="text-red-600 hover:text-red-800 text-xs"
                onclick="removeTemp('${staffId}','${type}',${idx}); renderSelectedStaffPreview();">
          <i class="fas fa-trash"></i>
        </button>
      </div>`;

    const addBtn = (type) => `
      <button type="button"
              class="mt-2 text-xs text-teal-600 hover:text-teal-800"
              onclick="addTemp('${staffId}','${type}');renderSelectedStaffPreview();">
        <i class="fas fa-plus"></i> Add ${
          type === "allowances" ? "Allowance" : "Deduction"
        }
      </button>`;

    const fullName = `${staff.first_name || ''} ${staff.second_name || ''}`.trim();

    return `
      <div class="p-4 bg-teal-50 border border-teal-200 rounded-lg" data-staff="${staffId}">
        <p class="font-bold text-teal-800">${fullName}</p>
        <p class="text-sm text-gray-600">${staff.position} • ${
      staff.department
    }</p>

        <div class="mt-2 space-y-1 text-sm">
          <p><span class="font-medium">Basic:</span> ${formatKES(
            salary.basic_salary
          )}</p>

          <!-- ALLOWANCES -->
          <div class="mt-3">
            <p class="font-medium text-green-700">Allowances</p>
            ${temp.allowances
              .map((a, i) => lineHTML("allowances", i, a))
              .join("")}
            ${addBtn("allowances")}
          </div>

          <!-- DEDUCTIONS -->
          <div class="mt-3">
            <p class="font-medium text-red-700">Deductions</p>
            ${temp.deductions
              .map((d, i) => lineHTML("deductions", i, d))
              .join("")}
            ${addBtn("deductions")}
          </div>

          <p class="mt-2">
          <span class="font-medium">Net Pay:</span>
          <strong class="net-pay">${(() => {
            const basic = Number(salary.basic_salary) || 0;
            const alw = temp.allowances.reduce(
              (s, a) => s + Number(a.amount || 0),
              0
            );
            const ded = temp.deductions.reduce(
              (s, d) => s + Number(d.amount || 0),
              0
            );
            return formatKES(basic + alw - ded);
          })()}</strong>
        </p>
          <p class="text-xs text-gray-500">Effective: ${
            salary.effective_from
          }</p>
        </div>
      </div>`;
  }

  function addTemp(staffId, type) {
    if (!staffTempData[staffId])
      staffTempData[staffId] = { allowances: [], deductions: [] };
    staffTempData[staffId][type].push({ desc: "", amount: 0 });
  }
  function removeTemp(staffId, type, idx) {
    staffTempData[staffId][type].splice(idx, 1);
  }
  function updateTemp(staffId, type, idx, field, value) {
    const rec = staffTempData[staffId][type][idx];
    rec[field] = value;
  }

  async function generateSelectedPayslips() {
    if (!selectedStaffIds.length)
      return Swal.fire(
        "Warning",
        "Select at least one staff member.",
        "warning"
      );

    const period = document.getElementById("payslipPeriodInput").value.trim();
    if (!period)
      return Swal.fire("Warning", "Enter the pay period.", "warning");

    Swal.fire({
      title: "Generating…",
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading(),
    });

    try {
      const promises = selectedStaffIds.map(async (staffId) => {
        const salary = salaryCache[staffId] || { basic_salary: 0 };
        const temp = staffTempData[staffId] || {
          allowances: [],
          deductions: [],
        };

        const payload = {
          staffId: Number(staffId),
          period,
          basic_salary: Number(salary.basic_salary),
          allowances: temp.allowances.map((a) => ({
            description: a.desc,
            amount: Number(a.amount) || 0,
          })),
          deductions: temp.deductions.map((d) => ({
            description: d.desc,
            amount: Number(d.amount) || 0,
          })),
        };

        return api("/payslips", {
          method: "POST",
          body: JSON.stringify(payload),
        });
      });

      const responses = await Promise.all(promises);

      await loadGeneratedPayslips();

      Swal.fire({
        icon: "success",
        title: "Payslips Saved!",
        html: `<strong>${selectedStaffIds.length}</strong> payslip(s) created for <strong>${period}</strong>`,
        timer: 3500,
      });

      // Reset form
      selectedStaffIds = [];
      staffTempData = {}; 
      document.getElementById("payslipStaffSelect").selectedIndex = -1;
      document.getElementById("payslipPeriodInput").value = "";
      updateGenerateButton();
      renderSelectedStaffPreview();
    } catch (e) {
      console.error(e);
      Swal.fire("Error", e.message || "Failed to generate payslips.", "error");
    }
  }

  function renderPayslipsTable() {
    const tbody = document.getElementById("payslipsTableBody");
    if (!generatedPayslips.length) {
      tbody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-gray-500">No payslips generated yet</td></tr>`;
      return;
    }

    tbody.innerHTML = generatedPayslips
      .map((p) => {
        const staff = staffCache.find((s) => String(s.id) === String(p.staffId));
        const staffName = staff 
          ? `${staff.first_name} ${staff.second_name}`.trim() 
          : (p.staffName || p.staff_name || 'Unknown');
        
        const allowancesTotal = Array.isArray(p.allowances) 
          ? p.allowances.reduce((sum, amt) => sum + Number(amt || 0), 0)
          : 0;
        
        const deductionsTotal = Array.isArray(p.deductions)
          ? p.deductions.reduce((sum, amt) => sum + Number(amt || 0), 0)
          : 0;
        
        let summary = '';
        if (allowancesTotal > 0 || deductionsTotal > 0) {
          const parts = [];
          if (allowancesTotal > 0) {
            parts.push(`<span class="text-green-600">+${formatKES(allowancesTotal).replace('KES ', '')}</span>`);
          }
          if (deductionsTotal > 0) {
            parts.push(`<span class="text-red-600">-${formatKES(deductionsTotal).replace('KES ', '')}</span>`);
          }
          summary = `<div class="text-xs text-gray-500 mt-1">${parts.join(' | ')}</div>`;
        }
        
        return `
          <tr class="hover:bg-gray-50 transition">
            <td class="px-6 py-4 text-sm font-medium">#${p.id}</td>
            <td class="px-6 py-4 text-sm">${staffName}</td>
            <td class="px-6 py-4 text-sm">${p.period}</td>
            <td class="px-6 py-4 text-sm">
              <div class="font-semibold">${formatKES(p.netPay || p.net_salary)}</div>
              ${summary}
            </td>
            <td class="px-6 py-4 text-sm">
              <span class="px-2 py-1 text-xs rounded-full ${
                p.status === "Sent" || p.sent
                  ? "bg-green-100 text-green-800"
                  : "bg-yellow-100 text-yellow-800"
              }">
                ${p.status || (p.sent ? 'Sent' : 'Generated')}
              </span>
            </td>
            <td class="px-6 py-4 text-sm space-x-2">          
              <button onclick="deletePayslip(${
                p.id
              })" class="text-red-600 hover:text-red-800" title="Delete"><i class="fas fa-trash"></i></button>
            </td>
          </tr>`;
      })
      .join("");
  }

  function viewPayslip(id) {
    const p = generatedPayslips.find((x) => x.id === id);
    if (p?.preview) {
      Swal.fire({
        title: `Payslip #${id} – ${p.staffName}`,
        html: `<pre class="text-left text-xs overflow-auto max-h-96">${p.preview}</pre>`,
        width: 800,
      });
    }
  }
  async function editPayslip(id) {
    alert(`Edit payslip #${id}`);
  }
  async function sendPayslip(id) {
    if (confirm("Send payslip via email/SMS?")) {
      await api(`/payslips/send/${id}`, { method: "POST" });
      const p = generatedPayslips.find((x) => x.id === id);
      if (p) p.status = "Sent";
      renderPayslipsTable();
      Swal.fire("Sent!", "Payslip has been sent.", "success");
    }
  }
  async function deletePayslip(id) {
    if (confirm("Delete this payslip?")) {
      await api(`/payslips/${id}`, { method: "DELETE" });
      generatedPayslips = generatedPayslips.filter((p) => p.id !== id);
      renderPayslipsTable();
    }
  }

  async function loadGeneratedPayslips() {
    try {
      const data = await api("/payslips");
      generatedPayslips = data.map((p) => ({
        id: p.id,
        staffId: p.staff_id,
        staffName: p.staff_name || `${p.first_name} ${p.second_name}`.trim(),
        period: p.period,
        netPay: p.net_salary,
        allowances: p.allowances || [],
        deductions: p.deductions || [],
        status: p.sent ? "Sent" : "Generated",
        sent: p.sent
      }));
      renderPayslipsTable();
    } catch (e) {
      console.error(e);
    }
  }

  window.recalc = function (staffId) {
    const staff = staffCache.find((s) => s.id == staffId);
    const salary = salaryCache[staffId] || { basic_salary: 0 };
    const temp = staffTempData[staffId] || { allowances: [], deductions: [] };

    const basic = Number(salary.basic_salary) || 0;
    const alw = temp.allowances.reduce((s, a) => s + Number(a.amount || 0), 0);
    const ded = temp.deductions.reduce((s, d) => s + Number(d.amount || 0), 0);
    const net = basic + alw - ded;

    const netEl = document.querySelector(`[data-staff="${staffId}"] .net-pay`);
    if (netEl) {
      netEl.textContent = formatKES(net);
    }
  };

  // --------------------------------------------------------------
  //  INIT
  // --------------------------------------------------------------
  document.addEventListener("DOMContentLoaded", () => {
    lucide.createIcons();
    showTab("invoices");
    setupInvoicesTab();
    Promise.allSettled([
      setupReceiptsTab(),
      setupPayslipsTab(),
    ]).catch(() => {});
  });

  /**
   * Generate invoice PDF.
   * @param {Object} invoice
   */
  function generateInvoicePDF(invoice) {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();

    const client = invoice.client || {
      name: "Unknown Client",
      phone: "N/A",
      email: "",
      location: "",
      period: "",
    };

    pdf.setFontSize(24);
    pdf.setFont("helvetica", "bold");
    pdf.setTextColor(220, 38, 127);
    pdf.text("DR.NET Technology Labs ", 20, 25);

    pdf.setFontSize(10);
    pdf.setFont("helvetica", "normal");
    pdf.setTextColor(100, 100, 100);
    pdf.text("INNOVATIVE CONNECTIONS WITH DOCTORS PRECISION", 20, 33);
    pdf.text(
      "Email: dr.netinnovations@gmail.com | Website: https://drnet.co.ke/",
      20,
      40
    );
    pdf.text("P.O. Box 105876 - 00100 NAIROBI", 20, 47);
    pdf.text("Phone: +254111357066", 20, 54);

    pdf.setFontSize(20);
    pdf.setFont("helvetica", "bold");
    pdf.setTextColor(0, 0, 0);
    pdf.text("INVOICE", 150, 25);

    pdf.setDrawColor(220, 38, 127);
    pdf.setLineWidth(0.5);
    pdf.rect(120, 35, 70, 25);

    pdf.setFontSize(10);
    pdf.setFont("helvetica", "normal");
    pdf.text(`Invoice #: ${invoice.invoice_number || invoice.id}`, 125, 42);

    const issueDate = dayjs(invoice.created_at).add(1, "day");
    const dueDate = invoice.due_date
      ? dayjs(invoice.due_date)
      : issueDate.add(7, "day");
    pdf.text(`Issue Date: ${issueDate.format("MMM D, YYYY")}`, 125, 48);
    pdf.text(`Due Date: ${dueDate.format("MMM D, YYYY")}`, 125, 54);

    pdf.setFontSize(14);
    pdf.setFont("helvetica", "bold");
    pdf.text("BILL TO:", 20, 80);

    pdf.setFontSize(12);
    pdf.setFont("helvetica", "normal");
    pdf.text(client.name, 20, 90);
    pdf.text(`Phone: ${client.phone}`, 20, 98);
    pdf.text(`Location: ${client.location || "—"}`, 20, 106);
    if (client.email) pdf.text(`Email: ${client.email}`, 20, 114);
    if (client.period) pdf.text(`Period: ${client.period}`, 20, 122);

    const startY = 140;
    pdf.setFillColor(240, 240, 240);
    pdf.rect(20, startY, 170, 10, "F");

    pdf.setFontSize(10);
    pdf.setFont("helvetica", "bold");
    pdf.text("DESCRIPTION", 25, startY + 7);
    pdf.text("QTY", 100, startY + 7);
    pdf.text("UNIT PRICE", 125, startY + 7);
    pdf.text("TOTAL", 165, startY + 7);

    pdf.setFont("helvetica", "normal");
    let y = startY + 20;
    let subtotal = 0;

    const items = invoice.items || [];
    items.forEach((itm) => {
      const lineTotal =
        (itm.quantity || 1) * (itm.amount || itm.unit_price || 0);
      subtotal += lineTotal;

      pdf.text(itm.description || "Service/Item", 25, y);
      pdf.text(String(itm.quantity || 1), 102, y);
      pdf.text(
        Number(itm.amount || itm.unit_price || 0).toLocaleString(),
        130,
        y
      );
      pdf.text(lineTotal.toLocaleString(), 167, y);
      y += 8;
    });

    const vat = Number(invoice.vat || subtotal * 0.16);
    const grand = Number(invoice.grand_total || subtotal + vat);
    const totalY = y + 15;

    pdf.setDrawColor(0, 0, 0);
    pdf.line(120, totalY - 5, 190, totalY - 5);

    pdf.setFont("helvetica", "bold");
    pdf.text("SUBTOTAL:", 120, totalY);
    pdf.text(
      `KSH ${subtotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}`,
      160,
      totalY
    );

    pdf.text("VAT (0%):", 120, totalY + 8);
    pdf.text(
      `KSH ${vat.toLocaleString(undefined, { minimumFractionDigits: 2 })}`,
      160,
      totalY + 8
    );

    pdf.setFontSize(12);
    pdf.setTextColor(220, 38, 127);
    pdf.text("TOTAL DUE:", 120, totalY + 18);
    pdf.text(
      `KSH ${grand.toLocaleString(undefined, { minimumFractionDigits: 2 })}`,
      160,
      totalY + 18
    );

    const payY = totalY + 35;
    pdf.setFontSize(10);
    pdf.setFont("helvetica", "normal");
    pdf.setTextColor(0, 0, 0);
    pdf.text("PAYMENT INSTRUCTIONS:", 20, payY);
    pdf.text("• M-PESA: Lipa na M-Pesa Buy Goods", 20, payY + 8);
    pdf.text("• Till Number: 5626320", 20, payY + 16);
    pdf.text("• Name: DR.NET TECHNOLOGY LABS", 20, payY + 24);
    pdf.text(
      `• Reference: ${invoice.invoice_number || invoice.id}`,
      20,
      payY + 32
    );

    pdf.save(`DR-NET-Invoice-${invoice.invoice_number || invoice.id}.pdf`);

    Swal.fire({
      title: "Success",
      text: "Invoice PDF generated successfully!",
      icon: "success",
      timer: 2000,
      showConfirmButton: false,
    });
  }

function downloadReceipt(id) {
  let receipt = null;
  viewReceiptForDownload(id);
}

async function viewReceiptForDownload(id) {
  try {
    const receipt = await api(`/receipts/${id}`);
    generateReceiptPDF(receipt);
  } catch (e) {
    Swal.fire("Error", e.message || "Could not load receipt for download", "error");
  }
}

function generateReceiptPDF(receipt) {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  const clientName = receipt.clientName || receipt.client?.name || "Unknown Client";
  const clientPhone = receipt.clientPhone || receipt.client?.phone || "N/A";
  const clientEmail = receipt.clientEmail || receipt.client?.email || "";
  const clientLocation = receipt.clientLocation || receipt.client?.location || "";
  const billingPeriod = receipt.billingPeriod || receipt.client?.period || "";

  pdf.setFontSize(24);
  pdf.setFont("helvetica", "bold");
  pdf.setTextColor(220, 38, 127);
  pdf.text("DR.NET Technology Labs", 20, 25);

  pdf.setFontSize(10);
  pdf.setFont("helvetica", "normal");
  pdf.setTextColor(100, 100, 100);
  pdf.text("INNOVATIVE CONNECTIONS WITH DOCTORS PRECISION", 20, 33);
  pdf.text(
    "Email: dr.netinnovations@gmail.com | Website: https://drnet.co.ke/",
    20,
    40
  );
  pdf.text("P.O. Box 105876 - 00100 NAIROBI", 20, 47);
  pdf.text("Phone: +254111357066", 20, 54);

  pdf.setFontSize(20);
  pdf.setFont("helvetica", "bold");
  pdf.setTextColor(0, 0, 0);
  pdf.text("PAYMENT RECEIPT", 135, 25);

  pdf.setDrawColor(220, 38, 127);
  pdf.setLineWidth(0.5);
  pdf.rect(120, 35, 70, 25);

  pdf.setFontSize(10);
  pdf.setFont("helvetica", "normal");
  pdf.text(`Receipt #: ${receipt.id}`, 125, 42);

  const paymentDate = dayjs(receipt.paymentDate).format("MMM D, YYYY");
  pdf.text(`Payment Date: ${paymentDate}`, 125, 48);
  pdf.text(`Method: ${receipt.paymentMethod}`, 125, 54);

  pdf.setFontSize(14);
  pdf.setFont("helvetica", "bold");
  pdf.text("RECEIVED FROM:", 20, 80);

  pdf.setFontSize(12);
  pdf.setFont("helvetica", "normal");
  pdf.text(clientName, 20, 90);
  pdf.text(`Phone: ${clientPhone}`, 20, 98);
  if (clientLocation) pdf.text(`Location: ${clientLocation}`, 20, 106);
  if (clientEmail) pdf.text(`Email: ${clientEmail}`, 20, 114);
  if (billingPeriod) pdf.text(`Period: ${billingPeriod}`, 20, 122);

  const startY = 140;
  pdf.setFillColor(240, 240, 240);
  pdf.rect(20, startY, 170, 10, "F");

  pdf.setFontSize(10);
  pdf.setFont("helvetica", "bold");
  pdf.text("DESCRIPTION", 25, startY + 7);
  pdf.text("AMOUNT", 165, startY + 7);

  pdf.setFont("helvetica", "normal");
  let y = startY + 20;

  const description = `${billingPeriod || "Internet Service"}`;
  pdf.text(description, 25, y);
  pdf.text(Number(receipt.amount).toLocaleString(), 167, y);
  y += 10;

  if (receipt.transactionRef || receipt.txRef) {
    pdf.setFontSize(9);
    pdf.setTextColor(100, 100, 100);
    pdf.text(`Transaction Ref: ${receipt.transactionRef || receipt.txRef}`, 25, y);
    y += 8;
  }

  if (receipt.note) {
    pdf.text(`Note: ${receipt.note}`, 25, y);
    y += 8;
  }

  pdf.setTextColor(0, 0, 0);

  const totalY = y + 15;
  pdf.setDrawColor(0, 0, 0);
  pdf.line(120, totalY - 5, 190, totalY - 5);

  const subtotal = Number(receipt.amount);
  const vat = 0;

  pdf.setFontSize(10);
  pdf.setFont("helvetica", "bold");
  pdf.text("SUBTOTAL:", 120, totalY);
  pdf.text(
    `KSH ${subtotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}`,
    160,
    totalY
  );

  pdf.text("VAT (0%):", 120, totalY + 8);
  pdf.text(
    `KSH ${vat.toLocaleString(undefined, { minimumFractionDigits: 2 })}`,
    160,
    totalY + 8
  );

  pdf.setFontSize(12);
  pdf.setTextColor(220, 38, 127);
  pdf.text("TOTAL PAID:", 120, totalY + 18);
  pdf.text(
    `KSH ${subtotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}`,
    160,
    totalY + 18
  );

  const footerY = totalY + 35;
  pdf.setFontSize(10);
  pdf.setFont("helvetica", "italic");
  pdf.setTextColor(100, 100, 100);
  pdf.text("Thank you for your payment!", 20, footerY);

  pdf.save(`DR-NET-Receipt-${receipt.id}.pdf`);

  Swal.fire({
    title: "Success",
    text: "Receipt PDF downloaded successfully!",
    icon: "success",
    timer: 2000,
    showConfirmButton: false,
  });
}
</script>