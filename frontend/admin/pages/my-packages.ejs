<style>
    /* Skeleton Loading */
    @keyframes skeleton {
      0% { background-color: #f3f4f6; }
      100% { background-color: #e5e7eb; }
    }
    .skeleton {
      background: #e5e7eb;
      animation: skeleton 1.2s ease-in-out infinite;
      border-radius: 0.5rem;
    }
    .skeleton-text { height: 1rem; }
    .skeleton-title { height: 1.5rem; width: 60%; }
    .skeleton-circle { width: 2.5rem; height: 2.5rem; border-radius: 9999px; }
  </style>
  <div class="flex items-center justify-between mb-8">
    <div>
      <h3 class="text-2xl font-bold text-teal-800">Packages Management</h3>
      <p class="text-teal-600 mt-1">Full CTIO access Packages management</p>
    </div>
    <button
      onclick="openAddModal()"
      class="bg-teal-500 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center space-x-2 group"
    >
      <i class="fas fa-plus"></i>
      <span class="mr-2">Add Package</span>
    </button>
  </div>

  <!-- FILTERS -->
  <div class="bg-white/90 backdrop-blur-sm p-8 shadow-xl border border-teal-100 rounded-xl mb-6">
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 pb-4">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 pb-2 flex-1">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
          <input
            id="searchInput"
            type="text"
            onkeyup="applyFilters()"
            placeholder="Search packages..."
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Speed</label>
          <input
            id="speedFilter"
            type="text"
            onkeyup="applyFilters()"
            placeholder="e.g., 100 Mbps"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Validity</label>
          <select
            id="validityFilter"
            onchange="applyFilters()"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 bg-white"
          >
            <option value="">All Validity</option>
            <option value="7">7 Days</option>
            <option value="30">30 Days</option>
            <option value="90">90 Days</option>
            <option value="365">1 Year</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Price Range</label>
          <select
            id="priceFilter"
            onchange="applyFilters()"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 bg-white"
          >
            <option value="">All Prices</option>
            <option value="0-50">$0 - $50</option>
            <option value="50-100">$50 - $100</option>
            <option value="100-200">$100 - $200</option>
            <option value="200+">$200+</option>
          </select>
        </div>
      </div>
      <div class="flex-shrink-0 pb-4 flex items-center space-x-3">
        <button
          onclick="downloadReport()"
          class="bg-teal-500 hover:bg-teal-700 text-white px-2 py-2 rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center space-x-2 group"
        >
          <i class="fas fa-download"></i>
          <span class="mr-2">Report</span>
        </button>
      </div>
    </div>

    <div class="flex items-center justify-between border-b pb-4">
      <h3 class="text-lg font-bold text-teal-800">
        <i class="fas fa-box mr-2"></i>Packages
      </h3>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-teal-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Speed</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Validity</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody id="packagesTableBody" class="bg-white divide-y divide-gray-200">
          <!-- Skeleton Rows -->
          <tr><td colspan="7" class="p-4"><div class="skeleton skeleton-text w-full"></div></td></tr>
          <tr><td colspan="7" class="p-4"><div class="skeleton skeleton-text w-full"></div></td></tr>
          <tr><td colspan="7" class="p-4"><div class="skeleton skeleton-text w-full"></div></td></tr>
        </tbody>
      </table>
    </div>
  </div>
  <!-- ADD / EDIT MODAL -->
<div id="packageModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
  <div class="flex min-h-screen items-center justify-center p-4">
    <div class="fixed inset-0 bg-black bg-opacity-50" onclick="closeModal()"></div>
    <div class="relative bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6">
      <div class="flex items-center justify-between mb-6">
        <h3 id="modalTitle" class="text-lg font-semibold text-gray-900">Add New Package</h3>
        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <form id="packageForm" class="space-y-6">
        <input type="hidden" id="editId" />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Package Name</label>
            <input type="text" id="name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" placeholder="e.g., Home Lite"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Speed</label>
            <input type="text" id="speed" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" placeholder="e.g., 100 Mbps"/>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Classification</label>
            <select id="classification" required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 bg-white">
              <option value="">Select Classification</option>
              <option value="home">Home Package</option>
              <option value="business">Business Package</option>
              <option value="enterprise">Enterprise Package</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Price (Ksh)</label>
            <input type="number" id="price" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Validity (Days)</label>
            <input type="number" id="validity_days" min="1" value="30" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500"/>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
          <textarea id="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500"></textarea>
        </div>
        <div class="flex justify-end gap-3 pt-4 border-t">
          <button type="button" onclick="closeModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel</button>
          <button type="submit" class="px-6 py-2 bg-teal-600 hover:bg-teal-700 text-white rounded-lg font-medium">
            <span id="submitText">Add Package</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- DETAILS MODAL -->
<div id="detailsModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
  <div class="flex min-h-screen items-center justify-center p-4">
    <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeDetails()"></div>
    <div class="relative bg-white shadow-2xl rounded-2xl max-w-3xl w-full p-8 border border-teal-100">
      <div class="flex items-center justify-between mb-6 pb-3 border-b border-teal-200">
        <h3 class="text-2xl font-bold text-teal-700 flex items-center gap-2">
          <i class="fas fa-info-circle"></i> Package Details
        </h3>
        <button onclick="closeDetails()" class="text-teal-600 hover:text-teal-800 transition">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
      <div id="detailsContent" class="text-gray-700 space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>
    </div>
  </div>
</div>

<script>
  let packages = [];
  let editingId = null;

  // Fetch all packages
  async function fetchPackages() {
    showSkeleton();
    try {
      const res = await fetch('/api/packages');
      packages = await res.json();
      renderTable(packages);
    } catch (err) {
      alert('Failed to load packages');
      hideSkeleton();
    }
  }

  // Show Skeleton
  function showSkeleton() {
    const tbody = document.getElementById('packagesTableBody');
    tbody.innerHTML = Array(5).fill().map(() => `
      <tr>
        <td colspan="7" class="p-4">
          <div class="space-y-3">
            <div class="skeleton skeleton-title"></div>
            <div class="skeleton skeleton-text w-3/4"></div>
            <div class="skeleton skeleton-text w-1/2"></div>
          </div>
        </td>
      </tr>
    `).join('');
  }

  function hideSkeleton() {
    // Skeleton is replaced by renderTable
  }

  // Render table
  function renderTable(data) {
    const tbody = document.getElementById('packagesTableBody');
    if (data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" class="text-center py-8 text-gray-500">No packages found</td></tr>`;
      return;
    }

    tbody.innerHTML = data.map(pkg => `
      <tr class="hover:bg-teal-50 transition">
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${pkg.name || '-'}</td>
        <td class="px-6 py-4 text-sm text-gray-600 max-w-xs truncate">${pkg.description || '-'}</td>
        <td class="px-6 py-4 text-sm text-gray-900">Ksh ${parseFloat(pkg.price).toFixed(2)}</td>
        <td class="px-6 py-4 text-sm text-gray-900">${pkg.speed || '-'}</td>
        <td class="px-6 py-4 text-sm text-gray-900">${pkg.validity_days} days</td>
        <td class="px-6 py-4 text-sm text-gray-500">${new Date(pkg.created_at).toLocaleDateString()}</td>
        <td class="px-6 py-4 text-sm font-medium space-x-2">
          <button onclick="openDetails(${pkg.id})" class="text-teal-600 hover:text-teal-800"><i class="fas fa-eye"></i></button>
          <button onclick="openEditModal(${pkg.id})" class="text-blue-600 hover:text-blue-800"><i class="fas fa-edit"></i></button>
          <button onclick="deletePackage(${pkg.id})" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
        </td>
      </tr>
    `).join('');
  }

  // Apply filters
  function applyFilters() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const speed = document.getElementById('speedFilter').value.toLowerCase();
    const validity = document.getElementById('validityFilter').value;
    const priceRange = document.getElementById('priceFilter').value;

    let filtered = packages.filter(pkg => {
      const matchesSearch = pkg.name?.toLowerCase().includes(search) || pkg.description?.toLowerCase().includes(search);
      const matchesSpeed = !speed || pkg.speed?.toLowerCase().includes(speed);
      const matchesValidity = !validity || pkg.validity_days == validity;
      const price = parseFloat(pkg.price);
      let matchesPrice = true;
      if (priceRange === '0-50') matchesPrice = price <= 50;
      else if (priceRange === '50-100') matchesPrice = price > 50 && price <= 100;
      else if (priceRange === '100-200') matchesPrice = price > 100 && price <= 200;
      else if (priceRange === '200+') matchesPrice = price > 200;

      return matchesSearch && matchesSpeed && matchesValidity && matchesPrice;
    });

    renderTable(filtered);
  }

  // Open Add Modal
  function openAddModal() {
    editingId = null;
    document.getElementById('modalTitle').textContent = 'Add New Package';
    document.getElementById('submitText').textContent = 'Add Package';
    document.getElementById('packageForm').reset();
    document.getElementById('editId').value = '';
    document.getElementById('packageModal').classList.remove('hidden');
  }

  // Open Edit Modal
  function openEditModal(id) {
    const pkg = packages.find(p => p.id === id);
    if (!pkg) return;

    editingId = id;
    document.getElementById('modalTitle').textContent = 'Edit Package';
    document.getElementById('submitText').textContent = 'Update Package';
    document.getElementById('editId').value = id;
    document.getElementById('name').value = pkg.name;
    document.getElementById('speed').value = pkg.speed;
    document.getElementById('price').value = pkg.price;
    document.getElementById('validity_days').value = pkg.validity_days;
    document.getElementById('description').value = pkg.description || '';
    document.getElementById('classification').value = pkg.classification || '';
    document.getElementById('packageModal').classList.remove('hidden');
  }

  // Close Modal
  function closeModal() {
    document.getElementById('packageModal').classList.add('hidden');
  }

  // Submit Form
  document.getElementById('packageForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = {
      name: document.getElementById('name').value,
      description: document.getElementById('description').value,
      price: parseFloat(document.getElementById('price').value),
      speed: document.getElementById('speed').value,
      validity_days: parseInt(document.getElementById('validity_days').value),
      classification: document.getElementById('classification').value
    };

    try {
      let url = '/api/packages';
      let method = 'POST';
      if (editingId) {
        url += `/${editingId}`;
        method = 'PUT';
      }

      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });

      if (res.ok) {
        closeModal();
        fetchPackages();
      } else {
        const error = await res.text();
        alert('Operation failed: ' + error);
      }
    } catch (err) {
      alert('Error: ' + err.message);
    }
  });

  // Delete Package
  async function deletePackage(id) {
    if (!confirm('Are you sure you want to delete this package?')) return;
    try {
      const res = await fetch(`/api/packages/${id}`, { method: 'DELETE' });
      if (res.ok) {
        fetchPackages();
      } else {
        alert('Delete failed');
      }
    } catch (err) {
      alert('Error: ' + err.message);
    }
  }

  // Open Details Modal
  function openDetails(id) {
    const pkg = packages.find(p => p.id === id);
    if (!pkg) return;

    const details = `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div><strong>Name:</strong> <span class="ml-2">${pkg.name}</span></div>
        <div><strong>Classification:</strong> <span class="ml-2">${pkg.classification}</span></div>
        <div><strong>Speed:</strong> <span class="ml-2">${pkg.speed}</span></div>
        <div><strong>Price:</strong> <span class="ml-2 text-teal-600 font-bold">Ksh ${parseFloat(pkg.price).toFixed(2)}</span></div>
        <div><strong>Validity:</strong> <span class="ml-2">${pkg.validity_days} days</span></div>
        <div class="md:col-span-2"><strong>Description:</strong> <p class="mt-1 text-gray-600">${pkg.description || 'â€”'}</p></div>
        <div class="md:col-span-2"><strong>Created:</strong> <span class="ml-2">${new Date(pkg.created_at).toLocaleString()}</span></div>
      </div>
    `;
    document.getElementById('detailsContent').innerHTML = details;
    document.getElementById('detailsModal').classList.remove('hidden');
  }

  function closeDetails() {
    document.getElementById('detailsModal').classList.add('hidden');
  }

  // Download Report (Placeholder)
  function downloadReport() {
    alert('Report generation coming soon!');
  }

  // Load data on start
  window.onload = () => {
    fetchPackages();
  };
</script>
