<style>
  .pulse-ring { animation: pulse 2s infinite; }
  @keyframes pulse {
    0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
    70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
    100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
  }
  .user-row:hover { background: linear-gradient(to right, #fef2f2, #fee2e2); }
  .skeleton { background: #e5e7eb; animation: skeleton 1.2s ease-in-out infinite alternate; }
  @keyframes skeleton { to { background-color: #f3f4f6; } }
  .skeleton-text { height: 1rem; }
  .skeleton-title { height: 1.5rem; width: 60%; }
  .skeleton-circle { width: 2.5rem; height: 2.5rem; border-radius: 9999px; }
</style>

<!-- Header -->
<div class="bg-white shadow-sm border-b border-gray-200">
  <div class="px-6 py-6 flex items-center justify-between">
    <div>
      <h3 class="text-2xl font-bold text-red-700 flex items-center">
        Expired Subscriptions
      </h3>
      <p class="text-gray-600 mt-1">
        Clients with expired or no active subscription (<span id="expiredCount">0</span>)
      </p>
    </div>
    <button onclick="loadExpiredClients()" class="px-5 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium shadow-md hover:shadow-lg transition">
      <i class="fas fa-sync-alt mr-2"></i> Refresh
    </button>
  </div>
</div>

<div class="max-w-full mx-auto">
  <!-- Search & Filters -->
  <div class="bg-white shadow-md p-5 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="relative">
        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
        <input type="text" id="searchInput" placeholder="Search by name, email, phone..."
               class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition">
      </div>
      <select id="planFilter" class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 bg-white">
        <option value="">All Expired Plans</option>
        <option>Silver</option>
        <option>Gold</option>
        <option>Platinum</option>
        <option>Bronze</option>
      </select>
    </div>
  </div>

  <!-- Table -->
  <div class="bg-white shadow-md overflow-hidden">
    <div class="px-6 py-4 border-b border-red-200 bg-red-50">
      <h3 class="text-lg font-bold text-red-800">
        <i class="fas fa-exclamation-triangle mr-2"></i> Expired Clients List
      </h3>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full" id="expiredTable">
        <thead class="bg-gray-50 border-b border-gray-200">
          <tr>
            <th class="text-left p-4 font-semibold text-gray-700 text-sm uppercase tracking-wider">User</th>
            <th class="text-left p-4 font-semibold text-gray-700 text-sm uppercase tracking-wider">Contact</th>
            <th class="text-left p-4 font-semibold text-gray-700 text-sm uppercase tracking-wider">Last Plan</th>
            <th class="text-left p-4 font-semibold text-gray-700 text-sm uppercase tracking-wider">Expired On</th>
            <th class="text-left p-4 font-semibold text-gray-700 text-sm uppercase tracking-wider">Days Expired</th>
            <!-- <th class="text-right p-4 font-semibold text-gray-700 text-sm uppercase tracking-wider">Actions</th> -->
          </tr>
        </thead>
        <tbody id="expiredTableBody"></tbody>
      </table>
    </div>

    <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 text-sm text-gray-600">
      Showing <span id="range">0-0</span> of <span id="totalExpired">0</span> expired clients
    </div>
  </div>
</div>

<script>
  const API_BASE = "/api";
  let allClients = [];
  let expiredClients = [];

  const $ = (id) => document.getElementById(id);

  const formatDate = (d) => {
    if (!d) return "-";
    return new Date(d).toLocaleDateString("en-KE", { day: "numeric", month: "short", year: "numeric" });
  };

  const daysExpired = (date) => {
    if (!date) return "No subscriptions";
    const diff = (new Date().setHours(0,0,0,0) - new Date(date).setHours(0,0,0,0)) / 86400000;
    const days = Math.floor(diff);
    return days === 0 ? "Today" : `${days} day${days > 1 ? 's' : ''} ago`;
  };

  const showSkeleton = () => {
    $("expiredTableBody").innerHTML = Array(10).fill("").map(() => `
      <tr>
        <td class="p-4"><div class="flex items-center space-x-3">
          <div class="skeleton skeleton-circle"></div>
          <div><div class="skeleton skeleton-title mb-1"></div><div class="skeleton skeleton-text w-24"></div></div>
        </div></td>
        <td class="p-4"><div class="skeleton skeleton-text"></div><div class="skeleton skeleton-text w-32 mt-1"></div></td>
        <td class="p-4"><div class="skeleton skeleton-text w-40"></div></td>
        <td class="p-4"><div class="skeleton skeleton-text w-28"></div></td>
        <td class="p-4"><div class="skeleton skeleton-text w-20"></div></td>
      </tr>`).join("");
  };

  // MAIN FUNCTION: Get all clients + their current subscription status
  const loadExpiredClients = async () => {
    showSkeleton();
    $("expiredCount").textContent = "Loading...";

    try {
      // 1. Get all clients
      const clientsRes = await fetch(`${API_BASE}/clients`);
      if (!clientsRes.ok) throw new Error("Failed to load clients");
      const clients = await clientsRes.json();

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const expired = [];

      // 2. Check each client's current subscription
      for (const client of clients) {
        try {
          const subRes = await fetch(`${API_BASE}/subscribe/client/current?userId=${client.id}`);
          
          let isExpired = true;
          let lastPlan = "No subscriptions";
          let expiryDate = null;

          if (subRes.ok) {
            const subs = await subRes.json();
            const currentSub = Array.isArray(subs) ? subs[0] : subs;

            if (currentSub && currentSub.expires) {
              const expiry = new Date(currentSub.expires || currentSub.expiry_date);
              isExpired = expiry < today;
              if (!isExpired) continue; // Skip active users

              lastPlan = currentSub.package?.name || currentSub.package_name || "Unknown Plan";
              expiryDate = expiry;
            }
          }
          // If 404 or no valid expiry â†’ treat as expired

          expired.push({
            ...client,
            lastPlan,
            expiryDate,
            daysExpired: expiryDate ? daysExpired(expiryDate) : "-",
            expiryDisplay: expiryDate ? formatDate(expiryDate) : "-"
          });

        } catch (err) {
          console.warn(`Failed to check subscription for user ${client.id}`, err);
          // If API fails for one user, still count as expired
          expired.push({
            ...client,
            lastPlan: "Unknown",
            expiryDate: null,
            daysExpired: "Unknown",
            expiryDisplay: "Unknown"
          });
        }
      }

      expiredClients = expired.sort((a, b) => {
        if (!a.expiryDate) return 1;
        if (!b.expiryDate) return -1;
        return new Date(b.expiryDate) - new Date(a.expiryDate);
      });

      allClients = clients;
      renderTable();
      $("expiredCount").textContent = expiredClients.length;
      $("totalExpired").textContent = expiredClients.length;

    } catch (err) {
      console.error("Load failed:", err);
      $("expiredTableBody").innerHTML = `<tr><td colspan="6" class="p-8 text-center text-red-600">Failed to load expired clients: ${err.message}</td></tr>`;
    }
  };

  const renderTable = () => {
    const search = $("searchInput").value.toLowerCase().trim();
    const planFilter = $("planFilter").value.toLowerCase();

    let data = expiredClients.filter(c => {
      const name = `${c.first_name || ""} ${c.second_name || ""}`.toLowerCase();
      const matchesSearch = name.includes(search) ||
                          (c.email && c.email.toLowerCase().includes(search)) ||
                          (c.phone && c.phone.includes(search));
      const matchesPlan = !planFilter || (c.lastPlan || "").toLowerCase().includes(planFilter);
      return matchesSearch && matchesPlan;
    });

    $("totalExpired").textContent = data.length;
    $("range").textContent = data.length ? `1-${data.length}` : "0-0";

    if (data.length === 0) {
      $("expiredTableBody").innerHTML = `<tr><td colspan="6" class="p-8 text-center text-gray-500">
        ${expiredClients.length === 0 ? "No expired subscriptions found" : "No clients match your search"}
      </td></tr>`;
      return;
    }

    $("expiredTableBody").innerHTML = data.map(client => `
      <tr class="user-row border-b hover:bg-red-50 transition">
        <td class="p-4">
          <div class="flex items-center space-x-3">
            <div class="w-11 h-11 bg-gradient-to-br from-red-500 to-red-700 rounded-full flex items-center justify-center text-white font-bold shadow-md">
              ${(client.first_name?.[0] || "?")}${(client.second_name?.[0] || "?")}
            </div>
            <div>
              <p class="font-semibold text-gray-900">${client.first_name} ${client.second_name}</p>
              <p class="text-xs text-gray-500">ID: ${client.id}</p>
            </div>
          </div>
        </td>
        <td class="p-4">
          <p class="text-sm text-gray-700"><i class="fas fa-envelope mr-2 text-gray-400"></i>${client.email || "-"}</p>
          <p class="text-sm text-gray-600"><i class="fas fa-phone mr-2 text-gray-400"></i>${client.phone || "-"}</p>
        </td>
        <td class="p-4">
          <span class="px-3 py-1.5 rounded-lg text-sm font-semibold bg-red-100 text-red-800">
            ${client.lastPlan}
          </span>
        </td>
        <td class="p-4 text-gray-700 font-medium">${client.expiryDisplay}</td>
        <td class="p-4">
          <span class="text-red-700 font-bold">${client.daysExpired}</span>
        </td>
      </tr>`).join("");
  };

  // Actions
  window.openSubscription = (id) => window.location.href = `/admin/users?openSubscription=${id}`;
  window.viewClient = (id) => window.location.href = `/admin/users?view=${id}`;

  // Search & Filter
  $("searchInput").addEventListener("input", () => setTimeout(renderTable, 300));
  $("planFilter").addEventListener("change", renderTable);

  // Load on start
  window.addEventListener("DOMContentLoaded", loadExpiredClients);
</script>