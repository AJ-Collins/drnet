<style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        :root { font-family: 'Plus Jakarta Sans', sans-serif; }
        
        .glass-panel { background: white; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .input-field { background: #f8fafc; border: 1px solid #e2e8f0; transition: all 0.2s; }
        .input-field:focus-within { border-color: #0d9488; background: white; box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.05); }
        
        .btn-teal { background: #0d9488; color: white; transition: all 0.2s; }
        .btn-teal:hover { background: #0f766e; transform: translateY(-1px); }
        
        .status-badge { font-size: 10px; font-weight: 800; padding: 4px 8px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.05em; }
        .status-active { background: #f0fdfa; color: #0d9488; border: 1px solid #ccfbf1; }
        .status-overdue { background: #fff1f2; color: #e11d48; border: 1px solid #ffe4e6; }
        
        .custom-table th { font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; font-weight: 800; padding: 12px; background: #f8fafc; text-align: left; }
        .custom-table td { padding: 14px 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; color: #334155; font-weight: 600; vertical-align: middle; }
        .custom-table tr:last-child td { border-bottom: none; }
        .custom-table tr:hover td { background: #f8fafc; }
        
        /* Modal Overlay */
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-hidden { pointer-events: none; opacity: 0; }
        .modal-visible { pointer-events: auto; opacity: 1; }
        
        .stat-card {
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .slide-in {
            animation: slideIn 0.4s ease-out;
        }
        .user-row:hover {
            background: linear-gradient(to right, #f0fdfa, #ccfbf1);
        }
        
        .scale-95 {
            transform: scale(0.95);
        }
        .scale-100 {
            transform: scale(1);
        }
        .transition-all {
            transition: all 0.2s ease;
        }
        
        /* Toast Container */
        #toastContainer {
            position: fixed;
            top: 1.25rem;
            right: 1.25rem;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .toast {
            background: #0f172a;
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            min-width: 200px;
            animation: fadeUp 0.3s ease-out;
            border-left: 4px solid #0d9488;
        }
        
        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Toast Container -->
    <div id="toastContainer"></div>
    
    <!-- Main Container -->
    <div class="max-w-full mx-auto p-4">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8 px-2 pt-2">
            <div>
                <h1 class="text-3xl font-black text-slate-900 tracking-tight">User Management</h1>
                <p class="text-slate-500 font-medium">Manage clients and staff members efficiently.</p>
            </div>
            <div class="flex gap-4" id="statsRow">
                <!-- Stats will be populated here -->
            </div>
        </div>

        <!-- Tabs -->
        <div class="mb-6 slide-in px-2">
            <div class="bg-white rounded-xl shadow-md p-1 inline-flex border border-gray-200">
                <button id="clientsTab" class="tab-btn px-6 py-3 rounded-lg font-semibold transition-all duration-300 bg-gradient-to-r from-teal-600 to-teal-700 text-white shadow-md">
                    <i class="fas fa-users mr-2"></i>Clients (<span id="clientCount">0</span>)
                </button>
                <button id="staffTab" class="tab-btn px-6 py-3 rounded-lg font-semibold transition-all duration-300 text-gray-600 hover:bg-gray-50">
                    <i class="fas fa-user-tie mr-2"></i>Staff (<span id="staffCount">0</span>)
                </button>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="mb-6 px-2 flex gap-3">
            <button id="addClientBtn" class="btn-teal px-6 py-3 rounded-xl text-xs font-black uppercase tracking-widest shadow-lg shadow-teal-900/10 flex items-center gap-2">
                <i class="fas fa-user-plus"></i>
                <span>Add Client</span>
            </button>
            <button id="addStaffBtn" class="btn-teal px-6 py-3 rounded-xl text-xs font-black uppercase tracking-widest shadow-lg shadow-teal-900/10 flex items-center gap-2" style="display: none">
                <i class="fas fa-user-tie"></i>
                <span>Add Staff</span>
            </button>
        </div>

        <!-- Clients Section -->
        <div id="clientsSection" class="space-y-4">
            <div class="glass-panel rounded-xl">
                <div class="p-4 border-b border-slate-100 flex flex-wrap gap-4 items-center bg-white rounded-t-xl">
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                        <input type="text" id="clientsSearch" placeholder="Search name, email or phone..." 
                            class="pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-full text-xs font-bold text-slate-700 outline-none focus:border-teal-500 w-64 transition-all">
                    </div>
                    
                    <select id="clientSubFilter" class="text-xs font-bold text-slate-700 p-2.5 border border-slate-200 rounded-lg bg-white outline-none focus:border-teal-500">
                        <option value="">All Payments</option>
                        <option>Paid</option>
                        <option>Unpaid</option>
                    </select>
                    
                    <select id="clientPlanFilter" class="text-xs font-bold text-slate-700 p-2.5 border border-slate-200 rounded-lg bg-white outline-none focus:border-teal-500">
                        <option value="">All Plans</option>
                    </select>
                    
                    <button onclick="exportData('clients')" class="ml-auto text-xs font-bold text-teal-600 border border-teal-400 hover:bg-teal-50 rounded-lg px-3 py-2 transition-all">
                        <i class="fas fa-download mr-1"></i>Export
                    </button>
                </div>

                <div class="overflow-auto">
                    <table class="w-full custom-table">
                        <thead class="sticky top-0 z-10">
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAllClients" class="rounded border-slate-300 text-teal-600 focus:ring-teal-500 mr-2">
                                    User
                                </th>
                                <th>Contact Info</th>
                                <th>Current Plan</th>
                                <th>Subscription Amount</th>
                                <th class="text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody">
                            <!-- Clients will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="p-3 border-t border-slate-100 bg-slate-50 text-center text-[10px] font-bold text-slate-400 rounded-b-xl flex justify-between items-center">
                    <span id="clientsRange">Showing 0-0 of 0 clients</span>
                    <div class="flex items-center space-x-2" id="clientsPagination"></div>
                </div>
            </div>
        </div>

        <!-- Staff Section -->
        <div id="staffSection" class="hidden space-y-4">
            <div class="glass-panel rounded-xl">
                <div class="p-4 border-b border-slate-100 flex flex-wrap gap-4 items-center bg-white rounded-t-xl">
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                        <input type="text" id="staffSearch" placeholder="Search staff..." 
                            class="pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-full text-xs font-bold text-slate-700 outline-none focus:border-teal-500 w-64 transition-all">
                    </div>
                    
                    <select id="staffDeptFilter" class="text-xs font-bold text-slate-700 p-2.5 border border-slate-200 rounded-lg bg-white outline-none focus:border-teal-500">
                        <option value="">All Departments</option>
                        <option>Technical</option>
                        <option>Support</option>
                        <option>Sales</option>
                        <option>Management</option>
                    </select>
                    
                    <select id="staffStatusFilter" class="text-xs font-bold text-slate-700 p-2.5 border border-slate-200 rounded-lg bg-white outline-none focus:border-teal-500">
                        <option value="">All Status</option>
                        <option>Active</option>
                        <option>On Leave</option>
                        <option>Inactive</option>
                    </select>
                    
                    <button onclick="exportData('staff')" class="ml-auto text-xs font-bold text-teal-600 border border-teal-400 hover:bg-teal-50 rounded-lg px-3 py-2 transition-all">
                        <i class="fas fa-download mr-1"></i>Export
                    </button>
                </div>

                <div class="overflow-auto">
                    <table class="w-full custom-table">
                        <thead class="sticky top-0 z-10">
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAllStaff" class="rounded border-slate-300 text-teal-600 focus:ring-teal-500 mr-2">
                                    Staff Member
                                </th>
                                <th>Contact</th>
                                <th>Role & Department</th>
                                <th>Basic Salary</th>
                                <th class="text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="staffTableBody">
                            <!-- Staff will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="p-3 border-t border-slate-100 bg-slate-50 text-center text-[10px] font-bold text-slate-400 rounded-b-xl flex justify-between items-center">
                    <span id="staffRange">Showing 0-0 of 0 staff</span>
                    <div class="flex items-center space-x-2" id="staffPagination"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="addUserModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm modal-overlay modal-hidden">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full m-4 overflow-hidden">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <div>
                    <h3 class="text-xl font-black text-slate-900 flex items-center gap-2">
                        <i class="fas fa-user-plus text-teal-600"></i>
                        <span id="modalTitle">Add New User</span>
                    </h3>
                    <p class="text-slate-500 text-xs font-medium mt-1">Fill in the details to create a new account</p>
                </div>
                <button onclick="closeAddUserModal()" class="w-8 h-8 flex items-center justify-center rounded-full border border-slate-200 text-slate-500 hover:bg-slate-50 transition-all">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="addUserForm" class="p-6 space-y-5">
                <input type="hidden" id="editUserId" value="">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1 mb-1 block">First Name *</label>
                        <div class="input-field rounded-xl p-1">
                            <input type="text" id="first_name" required 
                                class="w-full bg-transparent border-none text-xs font-bold text-slate-700 p-2.5 outline-none">
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1 mb-1 block">Second Name *</label>
                        <div class="input-field rounded-xl p-1">
                            <input type="text" id="second_name" required 
                                class="w-full bg-transparent border-none text-xs font-bold text-slate-700 p-2.5 outline-none">
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1 mb-1 block">Email Address *</label>
                        <div class="input-field rounded-xl p-1">
                            <input type="email" id="email" required 
                                class="w-full bg-transparent border-none text-xs font-bold text-slate-700 p-2.5 outline-none">
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1 mb-1 block">Phone Number *</label>
                        <div class="input-field rounded-xl p-1">
                            <input type="tel" id="phone" required 
                                class="w-full bg-transparent border-none text-xs font-bold text-slate-700 p-2.5 outline-none">
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1 mb-1 block">ID Number</label>
                        <div class="input-field rounded-xl p-1">
                            <input type="text" id="idNumber" 
                                class="w-full bg-transparent border-none text-xs font-bold text-slate-700 p-2.5 outline-none">
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1 mb-1 block">Password *</label>
                        <div class="input-field rounded-xl p-1">
                            <input type="text" id="password" 
                                class="w-full bg-transparent border-none text-xs font-bold text-slate-700 p-2.5 outline-none">
                        </div>
                    </div>
                </div>
                
                <!-- Staff Specific Fields -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="staffFieldsContainer" style="display: none;">
                    <div id="roleContainer">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1 mb-1 block">Position *</label>
                        <div class="input-field rounded-xl p-1">
                            <select id="role" class="w-full bg-transparent border-none text-xs font-bold text-slate-700 p-2.5 outline-none cursor-pointer">
                                <option value="" disabled selected>Select position</option>
                                <option value="Network Engineer">Network Engineer</option>
                                <option value="Support Agent">Support Agent</option>
                                <option value="Sales Rep">Sales Rep</option>
                                <option value="Manager">Manager</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="assignedRoleContainer">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1 mb-1 block">Role (access) *</label>
                        <div class="input-field rounded-xl p-1">
                            <select id="assignedRole" class="w-full bg-transparent border-none text-xs font-bold text-slate-700 p-2.5 outline-none cursor-pointer">
                                <option value="" disabled selected>Loading roles...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="departmentContainer">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1 mb-1 block">Department *</label>
                        <div class="input-field rounded-xl p-1">
                            <select id="department" class="w-full bg-transparent border-none text-xs font-bold text-slate-700 p-2.5 outline-none cursor-pointer">
                                <option value="" disabled selected>Select department</option>
                                <option>Technical</option>
                                <option>Support</option>
                                <option>Sales</option>
                                <option>Management</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="salaryContainer">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1 mb-1 block">Basic Salary (KSh) *</label>
                        <div class="input-field rounded-xl p-1">
                            <input type="number" id="basic_salary" min="0" step="100" placeholder="e.g. 45000" 
                                class="w-full bg-transparent border-none text-xs font-bold text-slate-700 p-2.5 outline-none">
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeAddUserModal()" 
                        class="flex-1 py-3.5 rounded-xl border border-slate-200 text-slate-600 text-xs font-black uppercase tracking-widest hover:bg-slate-50 transition-all">
                        Cancel
                    </button>
                    <button type="submit" 
                        class="flex-1 btn-teal py-3.5 rounded-xl text-xs font-black uppercase tracking-widest shadow-lg shadow-teal-900/10">
                        <span id="submitBtnText">Create User</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- View User Modal -->
    <div id="viewUserModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm modal-overlay modal-hidden">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full m-4 overflow-hidden">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <div>
                    <h3 class="text-xl font-black text-slate-900 flex items-center gap-2">
                        <i class="fas fa-user-circle text-teal-600"></i>
                        <span id="viewModalTitle">User Details</span>
                    </h3>
                </div>
                <button onclick="closeViewUserModal()" class="w-8 h-8 flex items-center justify-center rounded-full border border-slate-200 text-slate-500 hover:bg-slate-50 transition-all">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="p-6 space-y-5">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">Full Name</p>
                        <p id="viewFullName" class="text-sm font-black text-slate-900">-</p>
                    </div>
                    
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">Email</p>
                        <p id="viewEmail" class="text-sm font-black text-slate-900">-</p>
                    </div>
                    
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">Phone</p>
                        <p id="viewPhone" class="text-sm font-black text-slate-900">-</p>
                    </div>
                    
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">ID Number</p>
                        <p id="viewIdNumber" class="text-sm font-black text-slate-900">-</p>
                    </div>
                </div>
                
                <!-- Client Fields -->
                <div id="clientFields" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-teal-50 p-4 rounded-xl border border-teal-100">
                            <p class="text-[10px] font-bold text-teal-600 uppercase tracking-widest mb-1">Service Plan</p>
                            <p id="viewPlan" class="text-sm font-black text-teal-900">-</p>
                        </div>
                        
                        <div class="bg-teal-50 p-4 rounded-xl border border-teal-100">
                            <p class="text-[10px] font-bold text-teal-600 uppercase tracking-widest mb-1">Status</p>
                            <p id="viewClientStatus" class="text-sm font-black text-teal-900">-</p>
                        </div>
                        
                        <div class="bg-teal-50 p-4 rounded-xl border border-teal-100">
                            <p class="text-[10px] font-bold text-teal-600 uppercase tracking-widest mb-1">Last Payment</p>
                            <p id="viewLastPayment" class="text-sm font-black text-teal-900">-</p>
                        </div>
                        
                        <div class="bg-teal-50 p-4 rounded-xl border border-teal-100">
                            <p class="text-[10px] font-bold text-teal-600 uppercase tracking-widest mb-1">Payment Status</p>
                            <p id="viewPaymentStatus" class="text-sm font-black text-teal-900">-</p>
                        </div>
                    </div>
                </div>
                
                <!-- Staff Fields -->
                <div id="staffFields" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
                            <p class="text-[10px] font-bold text-purple-600 uppercase tracking-widest mb-1">Role</p>
                            <p id="viewRole" class="text-sm font-black text-purple-900">-</p>
                        </div>
                        
                        <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
                            <p class="text-[10px] font-bold text-purple-600 uppercase tracking-widest mb-1">Department</p>
                            <p id="viewDepartment" class="text-sm font-black text-purple-900">-</p>
                        </div>
                        
                        <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
                            <p class="text-[10px] font-bold text-purple-600 uppercase tracking-widest mb-1">Basic Salary</p>
                            <p id="viewBasicSalary" class="text-sm font-black text-purple-900">-</p>
                        </div>
                        
                        <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
                            <p class="text-[10px] font-bold text-purple-600 uppercase tracking-widest mb-1">Status</p>
                            <p id="viewStaffStatus" class="text-sm font-black text-purple-900">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="pt-4 border-t border-slate-100">
                    <button onclick="closeViewUserModal()" 
                        class="w-full py-3.5 rounded-xl border border-slate-200 text-slate-600 text-xs font-black uppercase tracking-widest hover:bg-slate-50 transition-all">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURATION ==========
        const $ = id => document.getElementById(id);
        const API_BASE = '/api';
        let clientsCache = [];
        let staffCache = [];
        let rolesCache = [];
        let packagesCache = [];
        let currentUserType = 'clients';
        let currentPage = { clients: 1, staff: 1 };
        const itemsPerPage = 10;
        
        // ========== UTILITY FUNCTIONS ==========
        function showToast(title, message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            
            const borderColors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#0d9488'
            };
            
            toast.style.borderLeftColor = borderColors[type] || borderColors.info;
            
            toast.innerHTML = `
                <h5 class="text-[10px] font-black uppercase mb-1" style="color: ${borderColors[type] || borderColors.info}">${title}</h5>
                <p class="text-xs font-medium">${message}</p>
            `;
            
            $('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-KE', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }
        
        function getPlanColor(plan) {
            if (!plan || plan === 'No Plan') return 'from-gray-400 to-gray-600';
            if (plan.includes('Premium')) return 'from-teal-400 to-teal-600';
            if (plan.includes('Standard') || plan.includes('Gold')) return 'from-blue-400 to-blue-600';
            if (plan.includes('Basic') || plan.includes('Bronze')) return 'from-amber-400 to-amber-600';
            return 'from-indigo-400 to-indigo-600';
        }
        
        function getStatusBadge(plan) {
            if (!plan || plan === 'No Plan') return 'bg-gray-100 text-gray-600';
            if (plan.includes('Premium')) return 'bg-teal-100 text-teal-700';
            if (plan.includes('Standard') || plan.includes('Gold')) return 'bg-blue-100 text-blue-700';
            if (plan.includes('Basic') || plan.includes('Bronze')) return 'bg-amber-100 text-amber-700';
            return 'bg-indigo-100 text-indigo-700';
        }
        
        // ========== API FUNCTIONS ==========
        const api = {
            async get(type) {
                const res = await fetch(`${API_BASE}/${type}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return res.json();
            },
            
            async create(type, data) {
                const res = await fetch(`${API_BASE}/${type}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return res.json();
            },
            
            async update(type, id, data) {
                const res = await fetch(`${API_BASE}/${type}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return res.json();
            },
            
            async delete(type, id) {
                const res = await fetch(`${API_BASE}/${type}/${id}`, {
                    method: 'DELETE'
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return res.json();
            }
        };
        
        // ========== FILTER & PAGINATION ==========
        function applyFilters(type, data) {
            let filtered = [...data];
            const search = $(`${type}Search`)?.value.toLowerCase() || '';
            
            if (search) {
                filtered = filtered.filter(u => 
                    `${u.first_name} ${u.second_name}`.toLowerCase().includes(search) ||
                    u.email?.toLowerCase().includes(search) ||
                    u.phone?.includes(search)
                );
            }
            
            if (type === 'clients') {
                const sub = $('clientSubFilter')?.value;
                const planId = $('clientPlanFilter')?.value;
                
                if (sub) {
                    filtered = filtered.filter(c => {
                        if (!c.currentPlan || !c.currentPlan.payment) return sub === 'Unpaid';
                        const isPaid = c.currentPlan.payment.status === 'paid';
                        const status = isPaid ? 'Paid' : 'Unpaid';
                        return status === sub;
                    });
                }
                
                if (planId) {
                    filtered = filtered.filter(c => {
                        return c.currentPlan?.package_id == planId || c.currentPlan?.package?.id == planId;
                    });
                }
            }
            
            if (type === 'staff') {
                const dept = $('staffDeptFilter')?.value;
                const status = $('staffStatusFilter')?.value;
                if (dept) filtered = filtered.filter(s => s.department === dept);
                if (status) filtered = filtered.filter(s => s.status === status);
            }
            
            return filtered;
        }
        
        function paginate(arr, page, size) {
            return arr.slice((page - 1) * size, page * size);
        }
        
        function renderPagination(type, total) {
            const pages = Math.ceil(total / itemsPerPage);
            const container = $(`${type}Pagination`);
            if (!container || pages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            const btn = (txt, pageNum, disabled = false) => {
                const b = document.createElement('button');
                b.type = 'button';
                b.textContent = txt;
                b.disabled = disabled;
                b.className = `px-3 py-1.5 rounded text-[10px] font-bold border ${
                    disabled ? 'opacity-50 cursor-not-allowed bg-gray-100' : 'hover:bg-gray-100'
                } ${
                    pageNum === currentPage[type] ? 'bg-teal-600 text-white border-teal-600' : 'text-slate-600 border-slate-200'
                }`;
                if (!disabled) {
                    b.onclick = () => {
                        currentPage[type] = pageNum;
                        renderTable(type);
                    };
                }
                return b;
            };
            
            container.innerHTML = '';
            container.appendChild(btn('←', currentPage[type] - 1, currentPage[type] === 1));
            
            const start = Math.max(1, currentPage[type] - 2);
            const end = Math.min(pages, start + 4);
            
            for (let i = start; i <= end; i++) {
                container.appendChild(btn(i, i));
            }
            
            container.appendChild(btn('→', currentPage[type] + 1, currentPage[type] === pages));
        }
        
        function updateRange(type, total) {
            const start = (currentPage[type] - 1) * itemsPerPage + 1;
            const end = Math.min(currentPage[type] * itemsPerPage, total);
            $(`${type}Range`).textContent = total ? `Showing ${start}-${end} of ${total}` : 'Showing 0-0 of 0';
        }
        
        // ========== TABLE RENDERING ==========
        async function renderTable(type) {
            const tbody = $(`${type}TableBody`);
            if (!tbody) return;
            
            // Show loading state
            tbody.innerHTML = `
                <tr><td colspan="${type === 'clients' ? 5 : 5}" class="p-8 text-center text-slate-400 text-xs font-bold">
                    <i class="fas fa-circle-notch fa-spin mr-2"></i>Loading...
                </td></tr>
            `;
            
            try {
                const data = await api.get(type);
                
                if (type === 'clients') {
                    // Fetch current subscriptions for clients
                    const subs = await Promise.all(
                        data.map(async (client) => {
                            try {
                                const res = await fetch(`/api/subscribe/client/current?userId=${client.id}`, {
                                    headers: { 'X-Admin-Request': 'true' }
                                });
                                if (res.ok) {
                                    const subsArray = await res.json();
                                    const sub = Array.isArray(subsArray) && subsArray.length > 0 ? subsArray[0] : null;
                                    return { userId: client.id, plan: sub };
                                }
                                return { userId: client.id, plan: null };
                            } catch {
                                return { userId: client.id, plan: null };
                            }
                        })
                    );
                    
                    // Merge subscription into user
                    data.forEach(user => {
                        const sub = subs.find(s => s.userId === user.id);
                        user.currentPlan = sub?.plan || null;
                    });
                }
                
                // Cache data
                if (type === 'clients') clientsCache = data;
                else staffCache = data;
                
                const filtered = applyFilters(type, data);
                const paginated = paginate(filtered, currentPage[type], itemsPerPage);
                
                tbody.innerHTML = paginated.map(user => {
                    const isClient = type === 'clients';
                    
                    return `
                        <tr class="group transition-colors hover:bg-slate-50/50">
                            <td onclick="event.stopPropagation()">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" class="rounded border-slate-300 text-teal-600 focus:ring-teal-500" value="${user.id}">
                                    <div class="w-8 h-8 rounded-full bg-gradient-to-br ${getPlanColor(
                                        isClient ? (user.currentPlan?.package?.name || 'No Plan') : (user.role || 'Staff')
                                    )} flex items-center justify-center text-white text-xs font-black overflow-hidden border border-slate-200">
                                        ${user.first_name?.[0]?.toUpperCase() || 'U'}${user.second_name?.[0]?.toUpperCase() || ''}
                                    </div>
                                    <div>
                                        <div class="font-black text-slate-800 leading-tight text-sm">${user.first_name} ${user.second_name}</div>
                                        <div class="text-[10px] font-bold text-slate-400">ID: ${user.employeeId || user.id || '-'}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="space-y-1">
                                    <div class="text-xs font-bold text-slate-700 flex items-center gap-2">
                                        <i class="fas fa-envelope text-slate-400 text-[10px]"></i>
                                        <span class="truncate">${user.email || '-'}</span>
                                    </div>
                                    <div class="text-xs font-bold text-slate-600 flex items-center gap-2">
                                        <i class="fas fa-phone text-slate-400 text-[10px]"></i>
                                        <span>${user.phone || '-'}</span>
                                    </div>
                                </div>
                            </td>
                            ${isClient ? `
                                <td>
                                    <div class="flex flex-col">
                                        <span class="status-badge ${getStatusBadge(user.currentPlan?.package?.name || 'No Plan')}">
                                            ${user.currentPlan?.package?.name || 'No Plan'}
                                        </span>
                                        ${user.currentPlan?.expires || user.currentPlan?.expiry_date ? `
                                            <div class="text-[10px] font-bold text-slate-500 mt-1">
                                                ${formatDate(user.currentPlan.expires || user.currentPlan.expiry_date)}
                                            </div>
                                        ` : ''}
                                    </div>
                                </td>
                                <td>
                                    <div class="text-sm">
                                        <p class="font-black text-slate-800">
                                            ${user.currentPlan?.payment?.amount ? `KES ${Number(user.currentPlan.payment.amount).toLocaleString()}` : '-'}
                                        </p>
                                        ${user.currentPlan ? `
                                            <span class="status-badge ${user.currentPlan.payment?.status === 'paid' ? 'status-active' : 'status-overdue'}">
                                                ${user.currentPlan.payment?.status === 'paid' ? 'Paid' : 'Unpaid'}
                                            </span>
                                        ` : ''}
                                    </div>
                                </td>
                            ` : `
                                <td>
                                    <div class="font-black text-slate-800 text-sm">${user.role || '-'}</div>
                                    <div class="text-[10px] font-bold text-slate-500">${user.department || '-'}</div>
                                </td>
                                <td>
                                    <p class="font-black text-slate-800 text-sm">
                                        ${user.salary?.basic_salary ? `KES ${Number(user.salary.basic_salary).toLocaleString()}` : '-'}
                                    </p>
                                </td>
                            `}
                            <td class="text-right">
                                <div class="flex justify-end gap-1">
                                    <button onclick="viewUser('${user.id}', '${type}')" class="w-8 h-8 flex items-center justify-center rounded-lg border border-slate-200 text-slate-500 hover:bg-slate-50 hover:text-teal-600 transition-all" title="View">
                                        <i class="fas fa-eye text-xs"></i>
                                    </button>
                                    ${isClient ? `
                                        <button onclick="manageSubscription('${user.id}')" class="w-8 h-8 flex items-center justify-center rounded-lg border border-slate-200 text-slate-500 hover:bg-indigo-50 hover:text-indigo-600 transition-all" title="Manage Plan">
                                            <i class="fas fa-wifi text-xs"></i>
                                        </button>
                                    ` : ''}
                                    <button onclick="editUser('${user.id}', '${type}')" class="w-8 h-8 flex items-center justify-center rounded-lg border border-slate-200 text-slate-500 hover:bg-blue-50 hover:text-blue-600 transition-all" title="Edit">
                                        <i class="fas fa-edit text-xs"></i>
                                    </button>
                                    <button onclick="deleteUser('${user.id}', '${type}')" class="w-8 h-8 flex items-center justify-center rounded-lg border border-slate-200 text-slate-500 hover:bg-rose-50 hover:text-rose-600 transition-all" title="Delete">
                                        <i class="fas fa-trash-alt text-xs"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('') || `
                    <tr><td colspan="${isClient ? 5 : 5}" class="p-8 text-center text-slate-400 text-xs font-bold">
                        No ${type} found
                    </td></tr>
                `;
                
                renderPagination(type, filtered.length);
                updateRange(type, filtered.length);
                updateCounts();
            } catch (e) {
                tbody.innerHTML = `
                    <tr><td colspan="${type === 'clients' ? 5 : 5}" class="p-8 text-center text-rose-500 text-xs font-bold">
                        <i class="fas fa-exclamation-circle mr-2"></i>Error: ${e.message}
                    </td></tr>
                `;
            }
        }
        
        async function updateCounts() {
            try {
                const [clients, staff] = await Promise.all([
                    api.get('clients'),
                    api.get('staff')
                ]);
                
                $('clientCount').textContent = clients.length;
                $('staffCount').textContent = staff.length;
                
                // Update stats row
                const activeClients = clients.filter(c => c.currentPlan).length;
                const totalRevenue = clients.reduce((sum, c) => {
                    return sum + (c.currentPlan?.payment?.amount || 0);
                }, 0);
                
                $('statsRow').innerHTML = `
                    <div class="glass-panel rounded-xl p-4 flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-teal-50 text-teal-600 flex items-center justify-center">
                            <i class="fas fa-users text-sm"></i>
                        </div>
                        <div>
                            <p class="text-[10px] font-black text-slate-400 uppercase">Active Clients</p>
                            <p class="text-lg font-black text-slate-900">${activeClients}</p>
                        </div>
                    </div>
                    <div class="glass-panel rounded-xl p-4 flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center">
                            <i class="fas fa-wallet text-sm"></i>
                        </div>
                        <div>
                            <p class="text-[10px] font-black text-slate-400 uppercase">Revenue</p>
                            <p class="text-lg font-black text-slate-900">KES ${totalRevenue.toLocaleString()}</p>
                        </div>
                    </div>
                `;
            } catch (e) {
                console.error('Failed to update counts:', e);
            }
        }
        
        async function loadPackages() {
            try {
                const res = await fetch('/api/packages');
                if (!res.ok) throw new Error('Failed to load packages');
                packagesCache = await res.json();
                
                const select = $('clientPlanFilter');
                select.innerHTML = '<option value="">All Plans</option>';
                packagesCache.forEach(pkg => {
                    const opt = document.createElement('option');
                    opt.value = pkg.id;
                    opt.textContent = `${pkg.name} (${pkg.speed || '?'}Mbps)`;
                    select.appendChild(opt);
                });
            } catch (err) {
                $('clientPlanFilter').innerHTML = '<option value="">Error loading plans</option>';
            }
        }
        
        async function loadRoles() {
            try {
                const res = await fetch(`${API_BASE}/roles`);
                if (!res.ok) throw new Error('Failed to fetch roles');
                const allRoles = await res.json();
                
                // Filter out admin and client roles
                rolesCache = allRoles.filter(role => 
                    role.id !== 1 && role.id !== 4 && 
                    !['admin', 'client'].includes((role.name || '').toLowerCase().trim())
                );
                
                populateRoleDropdown();
            } catch (err) {
                console.error('Failed to load roles:', err);
            }
        }
        
        function populateRoleDropdown(selectedRoleId = null) {
            const select = $('assignedRole');
            if (!select) return;
            
            select.innerHTML = '<option value="" disabled selected>Select Role (access role)</option>';
            
            if (rolesCache.length === 0) {
                select.innerHTML += '<option value="" disabled>No roles available</option>';
                return;
            }
            
            rolesCache.forEach(role => {
                const opt = document.createElement('option');
                opt.value = role.id;
                opt.textContent = role.name;
                if (selectedRoleId != null && Number(selectedRoleId) === role.id) {
                    opt.selected = true;
                }
                select.appendChild(opt);
            });
        }
        
        // ========== TAB MANAGEMENT ==========
        function switchTab(tab) {
            currentUserType = tab;
            $('clientsSection').classList.toggle('hidden', tab !== 'clients');
            $('staffSection').classList.toggle('hidden', tab !== 'staff');
            
            // Update tab styles
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.className = 'tab-btn px-6 py-3 rounded-lg font-semibold transition-all duration-300 text-gray-600 hover:bg-gray-50';
            });
            
            $(`${tab}Tab`).className = 'tab-btn px-6 py-3 rounded-lg font-semibold transition-all duration-300 bg-gradient-to-r from-teal-600 to-teal-700 text-white shadow-md';
            
            // Update add buttons
            $('addClientBtn').style.display = tab === 'clients' ? 'flex' : 'none';
            $('addStaffBtn').style.display = tab === 'staff' ? 'flex' : 'none';
            
            // Reset pagination and render
            currentPage[tab] = 1;
            renderTable(tab);
        }
        
        // ========== MODAL FUNCTIONS ==========
        function openAddUserModal(type, id = null) {
            currentUserType = type;
            const modal = $('addUserModal');
            modal.classList.remove('modal-hidden');
            modal.classList.add('modal-visible');
            
            $('modalTitle').textContent = id ? `Edit ${type.slice(0, -1)}` : `Add New ${type.slice(0, -1)}`;
            $('submitBtnText').textContent = id ? 'Update' : 'Create';
            
            const isStaff = type === 'staff';
            const staffFields = $('staffFieldsContainer');
            staffFields.style.display = isStaff ? 'grid' : 'none';
            
            // Set required fields for staff
            if (isStaff) {
                ['role', 'assignedRole', 'department', 'basic_salary'].forEach(fieldId => {
                    const field = $(fieldId);
                    if (field) field.required = true;
                });
            }
            
            // Reset form
            $('addUserForm').reset();
            $('editUserId').value = '';
            
            if (isStaff) {
                $('role').value = '';
                $('assignedRole').innerHTML = '<option value="" disabled selected>Loading roles...</option>';
                $('department').value = '';
                $('basic_salary').value = '';
            }
            
            if (id) {
                const cache = type === 'clients' ? clientsCache : staffCache;
                const user = cache.find(u => u.id === parseInt(id));
                
                if (user) {
                    $('editUserId').value = user.id;
                    $('first_name').value = user.first_name || '';
                    $('second_name').value = user.second_name || '';
                    $('email').value = user.email || '';
                    $('phone').value = user.phone || '';
                    $('idNumber').value = user.idNumber || user.employeeId || '';
                    $('password').value = '';
                    
                    if (isStaff) {
                        $('role').value = user.role || '';
                        $('department').value = user.department || '';
                        $('basic_salary').value = user.basic_salary || user.salary?.basic_salary || '';
                        
                        // Load roles and select the current one
                        loadRoles().then(() => {
                            if (user.role_id) {
                                populateRoleDropdown(user.role_id);
                            }
                        });
                    }
                }
            } else if (isStaff) {
                loadRoles();
            }
        }
        
        function closeAddUserModal() {
            const modal = $('addUserModal');
            modal.classList.remove('modal-visible');
            modal.classList.add('modal-hidden');
        }
        
        function openViewUserModal(user, type) {
            const modal = $('viewUserModal');
            modal.classList.remove('modal-hidden');
            modal.classList.add('modal-visible');
            
            $('viewModalTitle').textContent = `${type === 'clients' ? 'Client' : 'Staff'} Details`;
            $('viewFullName').textContent = `${user.first_name} ${user.second_name}`;
            $('viewEmail').textContent = user.email || '-';
            $('viewPhone').textContent = user.phone || '-';
            $('viewIdNumber').textContent = user.idNumber || user.employeeId || '-';
            
            // Show/hide appropriate fields
            $('clientFields').classList.toggle('hidden', type !== 'clients');
            $('staffFields').classList.toggle('hidden', type !== 'staff');
            
            if (type === 'clients') {
                if (user.currentPlan) {
                    $('viewPlan').textContent = user.currentPlan.package?.name || 'Unknown Plan';
                    
                    const expiry = user.currentPlan.expires || user.currentPlan.expiry_date;
                    $('viewClientStatus').textContent = expiry ? `Expires ${formatDate(expiry)}` : 'Active';
                    
                    const amount = user.currentPlan.payment?.amount;
                    $('viewLastPayment').textContent = amount ? `KES ${Number(amount).toLocaleString()}` : '-';
                    
                    const paid = user.currentPlan.payment?.status === 'paid';
                    $('viewPaymentStatus').textContent = paid ? 'Paid' : 'Unpaid';
                    $('viewPaymentStatus').className = paid ? 'text-green-600 font-bold' : 'text-amber-600 font-bold';
                } else {
                    $('viewPlan').textContent = 'No Active Plan';
                    $('viewClientStatus').textContent = 'Not Subscribed';
                    $('viewLastPayment').textContent = '-';
                    $('viewPaymentStatus').textContent = 'No Plan';
                }
            } else {
                $('viewRole').textContent = user.role || '-';
                $('viewDepartment').textContent = user.department || '-';
                $('viewBasicSalary').textContent = user.salary?.basic_salary ? `KES ${Number(user.salary.basic_salary).toLocaleString()}` : '-';
                $('viewStaffStatus').textContent = user.status || '-';
            }
        }
        
        function closeViewUserModal() {
            const modal = $('viewUserModal');
            modal.classList.remove('modal-visible');
            modal.classList.add('modal-hidden');
        }
        
        // ========== USER ACTIONS ==========
        async function viewUser(id, type) {
            const cache = type === 'clients' ? clientsCache : staffCache;
            const user = cache.find(u => u.id === parseInt(id));
            
            if (!user) {
                showToast('ERROR', 'User not found', 'error');
                return;
            }
            
            // For clients, fetch subscription details
            if (type === 'clients') {
                try {
                    const res = await fetch(`/api/subscribe/client/current?userId=${id}`, {
                        headers: { 'X-Admin-Request': 'true' }
                    });
                    
                    if (res.ok) {
                        const subs = await res.json();
                        user.currentPlan = Array.isArray(subs) && subs.length > 0 ? subs[0] : null;
                    }
                } catch (e) {
                    console.error('Failed to fetch subscription:', e);
                }
            }
            
            openViewUserModal(user, type);
        }
        
        function editUser(id, type) {
            openAddUserModal(type, id);
        }
        
        async function deleteUser(id, type) {
            const result = await Swal.fire({
                title: 'Are you sure?',
                text: `This will permanently delete this ${type.slice(0, -1)}.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#0d9488',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            });
            
            if (!result.isConfirmed) return;
            
            try {
                await api.delete(type, id);
                showToast('SUCCESS', `${type.slice(0, -1)} deleted successfully`, 'success');
                renderTable(type);
                updateCounts();
            } catch (err) {
                showToast('ERROR', err.message || 'Failed to delete', 'error');
            }
        }
        
        function manageSubscription(clientId) {
            // This would open a subscription management modal
            showToast('INFO', 'Subscription management feature would open here', 'info');
            // In a real implementation, you would open a modal similar to the subscription modal from the inspiration
        }
        
        function exportData(type) {
            const data = type === 'clients' ? clientsCache : staffCache;
            if (!data.length) {
                showToast('WARNING', 'No data to export', 'warning');
                return;
            }
            
            const csv = [Object.keys(data[0]), ...data.map(Object.values)]
                .map(e => e.join(','))
                .join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${type}-${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('SUCCESS', `${type} exported successfully`, 'success');
        }
        
        // ========== FORM HANDLING ==========
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const isStaff = currentUserType === 'staff';
            const id = $('editUserId').value;
            
            // Validate staff fields
            if (isStaff) {
                const role = $('assignedRole')?.value;
                const department = $('department')?.value;
                const salary = $('basic_salary')?.value.trim();
                
                if (!role) {
                    showToast('WARNING', 'Please select a role', 'warning');
                    return;
                }
                
                if (!department) {
                    showToast('WARNING', 'Please select a department', 'warning');
                    return;
                }
                
                if (!salary || salary === '0') {
                    showToast('WARNING', 'Please enter a valid salary', 'warning');
                    return;
                }
            }
            
            const data = {
                first_name: $('first_name').value.trim(),
                second_name: $('second_name').value.trim(),
                email: $('email').value.trim(),
                phone: $('phone').value.trim(),
                idNumber: $('idNumber').value.trim(),
                password: $('password').value.trim() || undefined
            };
            
            // Add staff-specific fields
            if (isStaff) {
                data.role_legacy = $('role').value;
                data.role_id = $('assignedRole').value;
                data.department = $('department').value;
                data.basic_salary = $('basic_salary').value.trim();
            }
            
            try {
                if (id) {
                    await api.update(currentUserType, id, data);
                    showToast('SUCCESS', `${currentUserType.slice(0, -1)} updated successfully`, 'success');
                } else {
                    await api.create(currentUserType, data);
                    showToast('SUCCESS', `${currentUserTypes.slice(0, -1)} created successfully`, 'success');
                }
                
                closeAddUserModal();
                renderTable(currentUserType);
                updateCounts();
            } catch (err) {
                showToast('ERROR', err.message || 'Failed to save', 'error');
            }
        }
        
        // ========== INITIALIZATION ==========
        function init() {
            // Set up event listeners
            $('addClientBtn').onclick = () => openAddUserModal('clients');
            $('addStaffBtn').onclick = () => openAddUserModal('staff');
            
            $('clientsTab').onclick = () => switchTab('clients');
            $('staffTab').onclick = () => switchTab('staff');
            
            // Search and filter event listeners
            ['clientsSearch', 'staffSearch'].forEach(id => {
                $(id)?.addEventListener('input', () => {
                    currentPage[currentUserType] = 1;
                    renderTable(currentUserType);
                });
            });
            
            ['clientSubFilter', 'clientPlanFilter', 'staffDeptFilter', 'staffStatusFilter'].forEach(id => {
                $(id)?.addEventListener('change', () => {
                    currentPage[currentUserType] = 1;
                    renderTable(currentUserType);
                });
            });
            
            // Form submission
            $('addUserForm').addEventListener('submit', handleFormSubmit);
            
            // Initial load
            loadRoles();
            loadPackages();
            switchTab('clients');
            updateCounts();
        }
        
        // Start the application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>