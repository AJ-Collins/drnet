<style>
    :root { font-family: 'Plus Jakarta Sans', sans-serif; }
    body { background-color: #f8fafc; }
    .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid #e2e8f0; }
    .input-field { background: #f1f5f9; border: 1px solid #d5dce6; transition: all 0.2s; }
    .input-field:focus { background: white; border-color: #0d9488; box-shadow: 0 0 0 4px rgba(13, 148, 136, 0.1); }
    
    .serial-tag {
        display: inline-flex; align-items: center; background: #0f172a; color: white;
        padding: 4px 10px; border-radius: 8px; font-family: monospace; font-size: 11px; margin: 2px;
    }
    .serial-tag button { margin-left: 8px; color: #fca5a5; transition: 0.2s; }
    .serial-tag button:hover { color: #ef4444; }

    .group-header { background: #f1f5f9 !important; border-left: 4px solid #0d9488; }
    .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>

<div class="max-w-full mx-auto">
    <div id="toastContainer" class="fixed top-5 right-5 z-[100] space-y-3"></div>

    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-black text-slate-900 tracking-tight">Inventory Ledger</h1>
            <p class="text-slate-500 font-bold text-xs tracking-widest uppercase">Serialized Record Management</p>
        </div>
        <div class="flex gap-3 overflow-x-auto pb-2">
            <div class="glass-panel px-5 py-2.5 rounded-2xl flex items-center gap-3 min-w-[140px]">
                <div class="w-10 h-10 rounded-xl bg-slate-100 flex items-center justify-center text-slate-600"><i class="fas fa-boxes"></i></div>
                <div><div class="text-[10px] font-black uppercase text-slate-400">Total</div><div class="text-lg font-black text-slate-800" id="stat-total">0</div></div>
            </div>
            <div class="glass-panel px-5 py-2.5 rounded-2xl flex items-center gap-3 min-w-[140px] border-teal-200 bg-teal-50/30">
                <div class="w-10 h-10 rounded-xl bg-teal-100 flex items-center justify-center text-teal-600">
                    <i class="fas fa-warehouse"></i> 
                </div>
                <div>
                    <div class="text-[10px] font-black uppercase text-teal-600">In Stock</div>
                    <div class="text-lg font-black text-teal-700" id="stat-avail">0</div>
                </div>
            </div>

            <div class="glass-panel px-5 py-2.5 rounded-2xl flex items-center gap-3 min-w-[140px] border-indigo-200 bg-indigo-50/30">
                <div class="w-10 h-10 rounded-xl bg-red-100 flex items-center justify-center text-red-600">
                    <i class="fas fa-truck-loading"></i>
                </div>
                <div>
                    <div class="text-[10px] font-black uppercase text-red-600">Out of Stock</div>
                    <div class="text-lg font-black text-red-700" id="stat-deployed">0</div>
                </div>
            </div>
        </div>        
    </div>

    <div class="grid grid-cols-12 gap-4">
        <div id="listContainer" class="col-span-12 transition-all duration-500">
            <div class="glass-panel rounded-lg overflow-hidden shadow-xl bg-white min-h-[100vh]">
              <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white rounded-t-xl">
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                        <input type="text" id="searchInput" onkeyup="filterData(this.value)" placeholder="Search user, phone or package..." 
                            class="pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-full text-xs font-bold text-slate-700 outline-none focus:border-teal-500 w-72 transition-all">
                    </div>
                    <button onclick="showEditor('add')" class="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold text-xs uppercase flex items-center">
                        <i class="fas fa-plus mr-2"></i> New Assets
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-slate-50/50 border-b border-slate-100 text-[12px] uppercase font-black text-slate-400">
                                <th class="px-6 py-4">Item Identification</th>
                                <th class="px-6 py-4">Serial Number</th>
                                <th class="px-6 py-4">Status</th>
                                <th class="px-6 py-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTable" class="divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="editorPanel" class="col-span-12 lg:col-span-4 hidden animate-fade-in">
            <div class="glass-panel rounded-lg p-6 shadow-2xl bg-white sticky top-4">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="editorTitle" class="text-xl font-black text-slate-900">Add Units</h2>                    
                </div>

                <form id="inventoryForm" class="space-y-4">
                    <input type="hidden" id="edit-id">
                    
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-400 ml-1">Asset Name</label>
                        <input type="text" name="name" id="name" required class="w-full px-4 py-3 rounded-xl input-field text-sm font-bold">
                    </div>

                    <div id="bulk-input-area">
                        <label class="text-[10px] font-black uppercase text-slate-400 ml-1">Serial Numbers (Comma Separated)</label>
                        <div id="serial-container" class="flex flex-wrap items-center gap-1 p-2 min-h-[100px] rounded-xl input-field bg-slate-50">
                            <input type="text" id="serial_input" placeholder="Type SN..." class="flex-grow bg-transparent outline-none text-sm font-mono font-bold p-1">
                        </div>
                    </div>

                    <div id="single-serial-area" class="hidden">
                        <label class="text-[10px] font-black uppercase text-slate-400 ml-1">Serial Number</label>
                        <input type="text" name="serial_number" id="single_serial" class="w-full px-4 py-3 rounded-xl input-field text-sm font-mono font-bold">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 ml-1">Brand</label>
                            <input type="text" name="brand" id="brand" class="w-full px-4 py-3 rounded-xl input-field text-sm font-bold">
                        </div>
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 ml-1">Category</label>
                            <select name="category" id="category" class="w-full px-4 py-3 rounded-xl input-field text-sm font-bold">
                                <option value="Network">Network</option>
                                <option value="Tools">Tools</option>
                                <option value="Cables">Cables</option>
                                <option value="Hardware">Hardware</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-400 ml-1">Price (KES)</label>
                        <input type="number" name="unit_price" id="unit_price" class="w-full px-4 py-3 rounded-xl input-field text-sm font-bold">
                    </div>

                    <button type="submit" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black text-xs uppercase tracking-widest mt-4 shadow-lg hover:bg-teal-600 transition-all">
                        Save Record
                    </button>

                    <button type="button" onclick="hideEditor()" class="w-full flex items-center justify-center gap-2 text-slate-400 hover:text-rose-500 py-3 mt-2 transition-colors duration-200">
                        <i class="fas fa-trash-alt text-xs"></i>
                        <span class="text-[10px] font-black uppercase tracking-widest">Cancel & Clear</span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    let allData = [];
    let filteredData = [];
    let serialTags = [];

    const formatStatus = (s) => {
        const map = {
            'in-stock': 'In Stock',
            'out-stock': 'Out of Stock',
            'maintenance': 'Under Repair'
        };
        return map[s] || s.charAt(0).toUpperCase() + s.slice(1);
    };

    document.getElementById('serial_input').addEventListener('keyup', (e) => {
        if (e.key === ',' || e.key === 'Enter') {
            const val = e.target.value.replace(',', '').trim().toUpperCase();
            if (val && !serialTags.includes(val)) {
                serialTags.push(val);
                renderTags();
            }
            e.target.value = '';
        }
    });

    function renderTags() {
        const container = document.getElementById('serial-container');
        const input = document.getElementById('serial_input');
        container.querySelectorAll('.serial-tag').forEach(t => t.remove());
        serialTags.forEach((sn, i) => {
            const tag = document.createElement('div');
            tag.className = 'serial-tag';
            tag.innerHTML = `<span>${sn}</span><button type="button" onclick="removeTag(${i})"><i class="fas fa-times"></i></button>`;
            container.insertBefore(tag, input);
        });
    }

    function removeTag(i) { serialTags.splice(i, 1); renderTags(); }

    function renderTable() {
        const tbody = document.getElementById('inventoryTable');
        const grouped = filteredData.reduce((acc, item) => {
            if (!acc[item.name]) acc[item.name] = [];
            acc[item.name].push(item);
            return acc;
        }, {});

        let html = '';
        for (const [name, units] of Object.entries(grouped)) {
            html += `<tr class="group-header"><td colspan="4" class="px-6 py-2 text-[11px] font-black text-slate-600 uppercase tracking-wider">${name} (${units.length} Units)</td></tr>`;
            units.forEach(unit => {
                const sColor = unit.status === 'in-stock' ? 'bg-teal-100 text-teal-700' : 'bg-amber-100 text-amber-700';
                html += `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-6 py-4">
                        <div class="text-sm font-bold text-slate-800">${unit.name}</div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase">${unit.brand} â€¢ ${unit.category}</div>
                    </td>
                    <td class="px-6 py-4 font-mono text-sm font-black text-slate-600">${unit.serial_number}</td>
                    <td class="px-6 py-4">
                        <span class="px-2.5 py-1 rounded-lg text-[10px] font-black uppercase ${sColor}">
                            ${formatStatus(unit.status)}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex justify-end gap-2">
                            <button onclick="editItem(${unit.id})" class="w-8 h-8 rounded-lg bg-slate-100 text-slate-400 hover:bg-slate-900 hover:text-white transition-all flex items-center justify-center"><i class="fas fa-edit text-xs"></i></button>
                            <button onclick="deleteItem(${unit.id})" class="w-8 h-8 rounded-lg bg-slate-100 text-slate-300 hover:bg-rose-500 hover:text-white transition-all flex items-center justify-center"><i class="fas fa-trash text-xs"></i></button>
                        </div>
                    </td>
                </tr>`;
            });
        }
        tbody.innerHTML = html || '<tr><td colspan="4" class="p-20 text-center text-slate-400 font-bold italic">No records found.</td></tr>';
    }

    async function fetchData() {
      try {
          const res = await fetch('/api/inventory');
          allData = await res.json();
          filteredData = [...allData];
          updateStats();
          renderTable();
      } catch (err) {
        showToast("Failed to load inventory data");
      }
    }

    document.getElementById('inventoryForm').onsubmit = async (e) => {
      e.preventDefault();
      const id = document.getElementById('edit-id').value;
      const formData = Object.fromEntries(new FormData(e.target));
      
      const payload = id ? formData : { ...formData, serial_numbers: serialTags };

      if (!id && serialTags.length === 0) {
          return showToast("Please add at least one serial number");
      }

      try {
          const res = await fetch(id ? `/api/inventory/${id}` : '/api/inventory', {
              method: id ? 'PUT' : 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
          });

          const result = await res.json();

          if (res.ok) {
              showToast(id ? "Record updated successfully" : "Assets registered successfully", 'success');
              hideEditor();
              fetchData();
          } else {
              showToast(result.error || "An unexpected error occurred");
          }
      } catch (err) {
          showToast("Connection failed. Is the server running?");
      }
  };

    async function deleteItem(id) {
        if (confirm("Delete this physical record? This cannot be undone.")) {
            await fetch(`/api/inventory/${id}`, { method: 'DELETE' });
            fetchData();
        }
    }

    function editItem(id) {
        const item = allData.find(i => i.id === id);
        document.getElementById('edit-id').value = id;
        document.getElementById('name').value = item.name;
        document.getElementById('brand').value = item.brand;
        document.getElementById('category').value = item.category;
        document.getElementById('unit_price').value = item.unit_price;
        document.getElementById('single_serial').value = item.serial_number;

        document.getElementById('bulk-input-area').classList.add('hidden');
        document.getElementById('single-serial-area').classList.remove('hidden');
        document.getElementById('editorTitle').innerText = "Edit Record";
        showSidePanel();
    }

    function showEditor(mode) {
        document.getElementById('inventoryForm').reset();
        document.getElementById('edit-id').value = '';
        serialTags = [];
        renderTags();
        document.getElementById('bulk-input-area').classList.remove('hidden');
        document.getElementById('single-serial-area').classList.add('hidden');
        document.getElementById('editorTitle').innerText = "Register Assets";
        showSidePanel();
    }

    function showSidePanel() {
        document.getElementById('listContainer').classList.replace('col-span-12', 'lg:col-span-8');
        document.getElementById('editorPanel').classList.remove('hidden');
    }

    function hideEditor() {
        document.getElementById('editorPanel').classList.add('hidden');
        document.getElementById('listContainer').classList.replace('lg:col-span-8', 'col-span-12');
    }

    function showToast(msg, type = 'error') {
      const toastContainer = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      
      const bgColor = type === 'error' ? 'bg-rose-600' : 'bg-slate-900';
      const title = type === 'error' ? 'Error' : 'Success';
      
      toast.className = `${bgColor} text-white p-4 rounded-2xl shadow-2xl min-w-[280px] animate-fade-in flex flex-col`;
      toast.innerHTML = `
          <span class="text-[10px] font-black uppercase tracking-widest opacity-70">${title}</span>
          <span class="text-sm font-bold">${msg}</span>
      `;
      
      toastContainer.appendChild(toast);
      setTimeout(() => {
          toast.style.opacity = '0';
          setTimeout(() => toast.remove(), 500);
      }, 4000);
    }

    function filterData(query) {
        const term = query.toLowerCase().trim();
        
        if (!term) {
            filteredData = [...allData];
        } else {
            filteredData = allData.filter(item => 
                item.name.toLowerCase().includes(term) ||
                item.serial_number.toLowerCase().includes(term) ||
                item.brand.toLowerCase().includes(term) ||
                item.category.toLowerCase().includes(term)
            );
        }
        renderTable();
    }

    function updateStats() {
        const total = allData.length;
        const inStock = allData.filter(i => i.status === 'in-stock').length;
        const outStock = allData.filter(i => i.status === 'out-stock' || i.status === 'maintenance').length;

        document.getElementById('stat-total').innerText = total;
        document.getElementById('stat-avail').innerText = inStock;
        document.getElementById('stat-deployed').innerText = outStock;
    }

    fetchData();
</script>