<style>
  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }
  .animate-spin-slow {
    animation: spin 2s linear infinite;
  }
  .skeleton {
    background: #e5e7eb;
    animation: pulse 1.5s ease-in-out infinite;
  }
  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }
  .hidden {
    display: none !important;
  }

  #ticketsList .group:hover .border-gray-200 {
    border-color: #14b8a6 !important;
  }
  select:focus {
    outline: none !important;
    box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.2);
  }
</style>
<div id="skeleton" class="p-8 space-y-6">
  <div class="flex justify-between">
    <div class="h-8 w-64 bg-gray-300 rounded skeleton"></div>
    <div class="h-10 w-32 bg-gray-300 rounded-lg skeleton"></div>
  </div>
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <div class="h-24 bg-gray-300 rounded-xl skeleton"></div>
    <div class="h-24 bg-gray-300 rounded-xl skeleton"></div>
    <div class="h-24 bg-gray-300 rounded-xl skeleton"></div>
    <div class="h-24 bg-gray-300 rounded-xl skeleton"></div>
  </div>
  <div class="bg-white p-6 rounded-xl shadow">
    <div class="h-6 w-48 bg-gray-300 rounded skeleton mb-4"></div>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
      <div class="h-12 bg-gray-300 rounded-lg skeleton"></div>
      <div class="h-12 bg-gray-300 rounded-lg skeleton"></div>
      <div class="h-12 bg-gray-300 rounded-lg skeleton"></div>
      <div class="h-12 bg-gray-300 rounded-lg skeleton"></div>
    </div>
  </div>
</div>

<!-- Main Content -->
<div id="content" class="hidden p-8 space-y-6">
  <!-- Header -->
  <div class="flex justify-between items-center">
    <div>
      <h1 class="text-3xl font-bold text-teal-800">Support Tickets</h1>
      <p class="text-teal-600">Manage all customer support requests</p>
    </div>
    <button
      id="newTicketBtn"
      class="bg-teal-600 hover:bg-teal-700 text-white px-5 py-3 rounded-lg font-semibold flex items-center gap-2 shadow-lg"
    >
      <i class="fas fa-plus"></i> New Ticket
    </button>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <div class="bg-white p-5 rounded-xl shadow border border-teal-100">
      <div class="flex justify-between items-center">
        <div>
          <p class="text-teal-600 text-sm font-bold">Total</p>
          <p id="totalTickets" class="text-2xl font-bold text-gray-800">0</p>
        </div>
        <i class="fas fa-ticket-alt text-2xl text-teal-600"></i>
      </div>
    </div>
    <div class="bg-white p-5 rounded-xl shadow border border-teal-100">
      <div class="flex justify-between items-center">
        <div>
          <p class="text-yellow-600 text-sm font-bold">Open</p>
          <p id="openTickets" class="text-2xl font-bold text-gray-800">0</p>
        </div>
        <i class="fas fa-inbox text-2xl text-yellow-600"></i>
      </div>
    </div>
    <div class="bg-white p-5 rounded-xl shadow border border-teal-100">
      <div class="flex justify-between items-center">
        <div>
          <p class="text-blue-600 text-sm font-bold">In Progress</p>
          <p id="inProgressTickets" class="text-2xl font-bold text-gray-800">
            0
          </p>
        </div>
        <i class="fas fa-spinner text-2xl text-blue-600"></i>
      </div>
    </div>
    <div class="bg-white p-5 rounded-xl shadow border border-teal-100">
      <div class="flex justify-between items-center">
        <div>
          <p class="text-green-600 text-sm font-bold">Resolved</p>
          <p id="resolvedTickets" class="text-2xl font-bold text-gray-800">0</p>
        </div>
        <i class="fas fa-check-circle text-2xl text-green-600"></i>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="bg-white p-6 rounded-xl shadow border border-teal-100">
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Search</label
        >
        <input
          id="searchInput"
          type="text"
          placeholder="Name, ticket ID..."
          class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-teal-500"
        />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Priority</label
        >
        <select
          id="priorityFilter"
          class="w-full p-3 border rounded-lg bg-white focus:ring-2 focus:ring-teal-500"
        >
          <option value="">All</option>
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="high">High</option>
          <option value="critical">Critical</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Issue Type</label
        >
        <select
          id="issueTypeFilter"
          class="w-full p-3 border rounded-lg bg-white focus:ring-2 focus:ring-teal-500"
        >
          <option value="">All</option>
          <option value="Network Issue">Network Issue</option>
          <option value="Hardware Problem">Hardware Problem</option>
          <option value="Software Bug">Software Bug</option>
          <option value="Installation Request">Installation Request</option>
          <option value="Maintenance">Maintenance</option>
          <option value="Repair">Repair</option>
          <option value="Inspection">Inspection</option>
          <option value="Asset Recovery">Asset Recovery</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Status</label
        >
        <select
          id="statusFilter"
          class="w-full p-3 border rounded-lg bg-white focus:ring-2 focus:ring-teal-500"
        >
          <option value="">All</option>
          <option value="open">Open</option>
          <option value="in_progress">In Progress</option>
          <option value="resolved">Resolved</option>
          <option value="closed">Closed</option>
        </select>
      </div>
      <div>
        <button
          id="refreshBtn"
          class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-3 rounded-lg font-semibold flex items-center justify-center gap-2 w-full"
        >
          <i class="fas fa-sync"></i> Refresh
        </button>
      </div>
    </div>
  </div>

  <!-- Tickets List -->
  <div id="ticketsList" class="space-y-3">
    <p class="text-center text-gray-500 py-8">Loading tickets...</p>
  </div>
</div>

<!-- Create/Edit Modal -->
<div
  id="ticketModal"
  class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/50"
>
  <div
    class="bg-white w-full max-w-2xl rounded-xl shadow-2xl max-h-[90vh] overflow-y-auto"
  >
    <div
      class="bg-teal-600 text-white p-5 flex justify-between items-center rounded-t-xl"
    >
      <h3 id="modalTitle" class="text-xl font-bold">Create Ticket</h3>
      <button id="closeModalBtn" class="text-white hover:text-gray-200">
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>
    <form id="ticketForm" class="p-6 space-y-4">
      <input type="hidden" id="editId" />
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-semibold mb-1">Full Name *</label>
          <input
            required
            id="fullName"
            type="text"
            class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-teal-500"
          />
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Phone</label>
          <input
            id="phone"
            type="text"
            class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-teal-500"
          />
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Issue Type *</label>
          <select
            required
            id="issue_type"
            class="w-full p-3 border rounded-lg bg-white focus:ring-2 focus:ring-teal-500"
          >
            <option value="Network Issue">Network Issue</option>
            <option value="Hardware Problem">Hardware Problem</option>
            <option value="Software Bug">Software Bug</option>
            <option value="Installation Request">Installation Request</option>
            <option value="Maintenance">Maintenance</option>
            <option value="Repair">Repair</option>
            <option value="Inspection">Inspection</option>
            <option value="Asset Recovery">Asset Recovery</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Priority *</label>
          <select
            required
            id="priority"
            class="w-full p-3 border rounded-lg bg-white focus:ring-2 focus:ring-teal-500"
          >
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
            <option value="critical">Critical</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Status</label>
          <select
            id="status"
            class="w-full p-3 border rounded-lg bg-white focus:ring-2 focus:ring-teal-500"
          >
            <option value="open">Open</option>
            <option value="in_progress">In Progress</option>
            <option value="resolved">Resolved</option>
            <option value="closed">Closed</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Assign Staff</label>
          <select
            id="assigned_to"
            class="w-full p-3 border rounded-lg bg-white focus:ring-2 focus:ring-teal-500"
          >
            <option value="">Unassigned</option>
            <option value="1">John (Admin)</option>
            <option value="2">Sarah (Tech)</option>
            <option value="3">Mike (Support)</option>
          </select>
        </div>
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Initial Message</label>
        <textarea
          id="initialMessage"
          rows="3"
          class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-teal-500"
        ></textarea>
      </div>
      <div class="flex justify-end gap-3 pt-4 border-t">
        <button
          type="submit"
          class="bg-teal-600 hover:bg-teal-700 text-white px-5 py-2 rounded-lg font-semibold"
        >
          <i class="fas fa-save"></i> Save
        </button>
        <button
          type="button"
          id="cancelModalBtn"
          class="bg-gray-500 hover:bg-gray-600 text-white px-5 py-2 rounded-lg font-semibold"
        >
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Chat Modal -->
<div
  id="chatModal"
  class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/50"
>
  <div
    class="bg-white w-full max-w-4xl rounded-xl shadow-2xl max-h-[90vh] flex flex-col"
  >
    <div
      class="bg-teal-600 text-white p-5 flex justify-between items-center rounded-t-xl"
    >
      <h3 class="text-xl font-bold">
        Chat - <span id="chatTicketNumber"></span>
      </h3>
      <button id="closeChatBtn" class="text-white hover:text-gray-200">
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>
    <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-4"></div>
    <div class="p-4 border-t bg-gray-50">
      <div class="flex gap-2">
        <textarea
          id="adminMessage"
          rows="2"
          placeholder="Type your reply..."
          class="flex-1 p-3 border rounded-lg focus:ring-2 focus:ring-teal-500"
        ></textarea>
        <button
          id="sendMessageBtn"
          class="bg-teal-600 hover:bg-teal-700 text-white px-5 py-2 rounded-lg font-semibold"
        >
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  const API_BASE = "/api";

  // State
  let allTickets = [];
  let allMessages = [];
  let currentTicketId = null;
  let allStaff = [];

  // Utility: Get element safely
  function getEl(id) {
    const el = document.getElementById(id);
    return el;
  }

  // Utility: Escape HTML
  function escapeHtml(text) {
    if (!text) return "";
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }

  // Utility: Format status
  function formatStatus(s) {
    const map = {
      open: "Open",
      in_progress: "In Progress",
      resolved: "Resolved",
      closed: "Closed",
    };
    return map[s] || s;
  }

  // Initialize when DOM is ready
  document.addEventListener("DOMContentLoaded", () => {
    // Attach event listeners
    const form = getEl("ticketForm");
    if (form) form.addEventListener("submit", handleSaveTicket);

    const newTicketBtn = getEl("newTicketBtn");
    if (newTicketBtn) newTicketBtn.addEventListener("click", openCreateModal);

    const closeModalBtn = getEl("closeModalBtn");
    if (closeModalBtn) closeModalBtn.addEventListener("click", closeModal);

    const cancelModalBtn = getEl("cancelModalBtn");
    if (cancelModalBtn) cancelModalBtn.addEventListener("click", closeModal);

    const refreshBtn = getEl("refreshBtn");
    if (refreshBtn) refreshBtn.addEventListener("click", loadTickets);

    const closeChatBtn = getEl("closeChatBtn");
    if (closeChatBtn) closeChatBtn.addEventListener("click", closeChat);

    const sendMessageBtn = getEl("sendMessageBtn");
    if (sendMessageBtn) sendMessageBtn.addEventListener("click", sendMessage);

    // Attach filter listeners
    attachFilters();

    // Load initial data
    loadTickets();
  });

  // Attach filter event listeners
  function attachFilters() {
    const filterIds = [
      "searchInput",
      "priorityFilter",
      "issueTypeFilter",
      "statusFilter",
    ];
    filterIds.forEach((id) => {
      const el = getEl(id);
      if (el) {
        el.addEventListener("input", renderTickets);
      }
    });
  }

  // Load tickets and messages from API
  async function loadTickets() {
    const skeleton = getEl("skeleton");
    const content = getEl("content");

    if (skeleton) skeleton.classList.remove("hidden");
    if (content) content.classList.add("hidden");

    try {
      // 1. Load tickets
      const ticketsRes = await fetch(`${API_BASE}/tickets`);
      if (!ticketsRes.ok) throw new Error("Failed to fetch tickets");
      const ticketsData = await ticketsRes.json();

      // 2. Load messages
      const messagesRes = await fetch(`${API_BASE}/messages`);
      if (!messagesRes.ok) throw new Error("Failed to fetch messages");
      const messagesData = await messagesRes.json();

      // 3. LOAD STAFF FIRST â€” BEFORE RENDERING
      const staffRes = await fetch(`${API_BASE}/tickets/staff`);
      allStaff = staffRes.ok ? await staffRes.json() : [];

      // Now assign data
      allTickets = Array.isArray(ticketsData) ? ticketsData : [];
      allMessages = Array.isArray(messagesData?.messages)
        ? messagesData.messages
        : messagesData || [];

      // Update stats & render
      updateStats();
      renderTickets(); // Now allStaff is ready!

      // Also populate the modal dropdown
      loadStaffIntoDropdown();
    } catch (err) {
      const ticketsList = getEl("ticketsList");
      if (ticketsList) {
        ticketsList.innerHTML = `
          <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
            <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-3"></i>
            <p class="text-red-700 font-semibold text-lg">Error Loading Data</p>
            <p class="text-red-600 text-sm mt-2">${escapeHtml(err.message)}</p>
            <button onclick="loadTickets()" class="mt-4 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">
              Retry
            </button>
          </div>`;
      }
    } finally {
      if (skeleton) skeleton.classList.add("hidden");
      if (content) content.classList.remove("hidden");
    }
  }

  // Update statistics cards
  function updateStats() {
    const total = allTickets.length;
    const open = allTickets.filter((t) => t.status === "open").length;
    const inProgress = allTickets.filter(
      (t) => t.status === "in_progress"
    ).length;
    const resolved = allTickets.filter((t) => t.status === "resolved").length;

    const totalEl = getEl("totalTickets");
    const openEl = getEl("openTickets");
    const inProgressEl = getEl("inProgressTickets");
    const resolvedEl = getEl("resolvedTickets");

    if (totalEl) totalEl.textContent = total;
    if (openEl) openEl.textContent = open;
    if (inProgressEl) inProgressEl.textContent = inProgress;
    if (resolvedEl) resolvedEl.textContent = resolved;
  }

  // Render tickets list with filters
  function renderTickets() {
    const list = getEl("ticketsList");
    if (!list) return;

    const search = (getEl("searchInput")?.value || "").toLowerCase();
    const priority = getEl("priorityFilter")?.value || "";
    const issueType = getEl("issueTypeFilter")?.value || "";
    const status = getEl("statusFilter")?.value || "";

    let filtered = allTickets.filter((t) => {
      const matchesSearch =
        (t.fullName || "").toLowerCase().includes(search) ||
        (t.ticket_number || "").toLowerCase().includes(search) ||
        (t.subject || "").toLowerCase().includes(search) ||
        (t.description || "").toLowerCase().includes(search);
      const matchesPriority = !priority || t.priority === priority;
      const matchesIssue = !issueType || t.issue_type === issueType;
      const matchesStatus = !status || t.status === status;
      return matchesSearch && matchesPriority && matchesIssue && matchesStatus;
    });

    if (!filtered.length) {
      list.innerHTML = `
      <div class="text-center py-16">
        <i class="fas fa-inbox text-8xl text-gray-200 mb-6"></i>
        <p class="text-xl font-semibold text-gray-500">No tickets found</p>
        <p class="text-gray-400 mt-2">Try adjusting your filters</p>
      </div>`;
      return;
    }

    list.innerHTML = filtered
      .map((t) => {
        const ticketMessages = allMessages.filter((m) => m.ticket_id == t.id);
        const totalMessages = ticketMessages.length;
        const staffMessages = ticketMessages.filter(
          (m) => m.sender_staff_id != null
        );
        const hasStaffReplied = staffMessages.length > 0;
        const lastActivity =
          ticketMessages[ticketMessages.length - 1]?.created_at || t.created_at;

        const assignedStaff = allStaff.find((s) => s.id == t.assigned_to);
        const assignedName = assignedStaff
          ? escapeHtml(assignedStaff.name)
          : null;

        // Priority & Status Badges
        const priorityBadge =
          {
            critical: "bg-red-100 text-red-800 border-red-300",
            high: "bg-orange-100 text-orange-800 border-orange-300",
            medium: "bg-yellow-100 text-yellow-800 border-yellow-300",
            low: "bg-blue-100 text-blue-800 border-blue-300",
          }[t.priority] || "bg-gray-100 text-gray-800";

        const statusBadge =
          {
            open: "bg-yellow-100 text-yellow-800",
            in_progress: "bg-blue-100 text-blue-800",
            resolved: "bg-green-100 text-green-800",
            closed: "bg-gray-200 text-gray-700",
          }[t.status] || "bg-gray-100 text-gray-700";

        const staffActivity = t.assigned_to
          ? hasStaffReplied
            ? `<span class="text-green-600 font-bold text-xs"><i class="fas fa-check-circle"></i> Staff replied</span>`
            : `<span class="text-red-600 font-bold text-xs"><i class="fas fa-clock"></i> Awaiting reply</span>`
          : `<span class="text-gray-500 italic text-xs">Not assigned</span>`;

        // Truncate description for preview
        const shortDesc =
          t.description?.length > 120
            ? escapeHtml(t.description.slice(0, 120)) + "..."
            : escapeHtml(t.description || "No description provided");

        return `
        <div class="bg-white rounded-2xl shadow-lg border-2 border-gray-200 hover:border-teal-500 hover:shadow-2xl transition-all duration-300 group">
          <div class="p-6">

            <!-- Header -->
            <div class="flex justify-between items-start mb-5">
              <div>
                <h3 class="text-xl font-bold text-gray-900">${escapeHtml(
                  t.fullName
                )}</h3>
                <div class="flex items-center gap-3 mt-2">
                  <p class="text-teal-600 font-mono text-lg font-bold">#${escapeHtml(
                    t.ticket_number
                  )}</p>
                  <span class="px-4 py-1.5 rounded-full text-xs font-bold border ${priorityBadge}">
                    ${t.priority.toUpperCase()}
                  </span>
                  <span class="px-4 py-1.5 rounded-full text-xs font-bold ${statusBadge}">
                    ${formatStatus(t.status)}
                  </span>
                </div>
              </div>
            </div>

            <!-- Customer Description -->
            <div class="bg-gray-50 rounded-xl p-5 mb-6 border border-gray-200">
              <p class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                <i class="fas fa-quote-left text-teal-600"></i>
                Customer Message
              </p>
              <div class="text-gray-800 text-sm leading-relaxed">
                <span class="description-preview">${shortDesc}</span>
                ${
                  t.description?.length > 120
                    ? `
                  <button onclick="this.previousElementSibling.innerHTML = '${escapeHtml(
                    t.description
                  )}'; this.remove();" 
                    class="text-teal-600 hover:text-teal-700 font-medium text-xs ml-2">
                    Show more
                  </button>
                `
                    : ""
                }
              </div>
            </div>

            <!-- Staff Assignment -->
            <div class="bg-gradient-to-r from-teal-50 to-blue-50 rounded-xl p-5 mb-6 border border-teal-200">
              <div class="flex justify-between items-center mb-3">
                <p class="font-semibold text-gray-800">Assigned Staff</p>
                ${staffActivity}
              </div>
              
              <select onchange="assignTicket(${t.id}, this.value)"
                class="w-full px-5 py-3.5 border-2 rounded-xl text-base font-medium transition-all
                  ${
                    t.assigned_to
                      ? "border-teal-500 bg-white text-teal-900"
                      : "border-gray-300 bg-white text-gray-600"
                  }
                  focus:ring-4 focus:ring-teal-200 focus:border-teal-600">
                <option value="">Unassigned</option>
                ${allStaff
                  .map(
                    (s) => `
                  <option value="${s.id}" ${
                      t.assigned_to == s.id ? "selected" : ""
                    }>
                    ${escapeHtml(s.name)} (${s.role || "Staff"})
                  </option>
                `
                  )
                  .join("")}
              </select>

              ${
                t.assigned_to
                  ? `
                <p class="mt-3 text-sm">
                  <span class="font-medium text-gray-700">Currently assigned to:</span>
                  <span class="ml-2 font-bold text-teal-700">${assignedName}</span>
                </p>
              `
                  : ""
              }
            </div>

            <!-- Footer -->
            <div class="flex flex-wrap items-center justify-between gap-4 pt-5 border-t border-gray-200">
              <div class="flex items-center gap-6 text-sm text-gray-600">
                <span class="flex items-center gap-2">
                  <i class="fas fa-comments text-teal-600"></i>
                  <strong>${totalMessages}</strong> message${
          totalMessages !== 1 ? "s" : ""
        }
                  ${
                    staffMessages.length > 0
                      ? ` (${staffMessages.length} from staff)`
                      : ""
                  }
                </span>
                <span class="text-gray-500">
                  ${new Date(lastActivity).toLocaleDateString("en-GB", {
                    day: "numeric",
                    month: "short",
                    hour: "2-digit",
                    minute: "2-digit",
                  })}
                </span>
              </div>

              <div class="flex gap-3">
                <button onclick="openChat(${t.id})"
                  class="px-6 py-3 bg-teal-600 hover:bg-teal-700 text-white font-semibold rounded-xl shadow-md hover:shadow-lg transition-all transform hover:scale-105 flex items-center gap-2">
                  <i class="fas fa-comments"></i> Open Chat
                </button>
                <button onclick="deleteTicket(${t.id})"
                  class="p-3 text-red-600 hover:bg-red-50 rounded-xl transition-all"
                  title="Delete Ticket">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
            </div>
          </div>
        </div>`;
      })
      .join("");
  }

  async function assignTicket(ticketId, staffId) {
    if (staffId === "") staffId = null;

    try {
      const res = await fetch(`${API_BASE}/tickets/${ticketId}/assign`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ assigned_to: staffId }),
      });

      if (!res.ok) throw new Error("Failed to assign");

      const updatedTicket = await res.json();

      // Update local data
      const index = allTickets.findIndex((t) => t.id === updatedTicket.id);
      if (index !== -1) {
        allTickets[index] = updatedTicket;
      } else {
        allTickets.push(updatedTicket);
      }

      renderTickets();
      updateStats();
    } catch (err) {
      alert("Assign failed: " + err.message);
    }
  }

  // Load staff into assign dropdown
  async function loadStaffIntoDropdown() {
    const select = getEl("assigned_to");
    if (!select) return;

    try {
      const res = await fetch(`${API_BASE}/tickets/staff`);
      if (!res.ok) throw new Error("Failed to load staff");

      const staff = await res.json();

      select.innerHTML = '<option value="">Unassigned</option>';

      staff.forEach((s) => {
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = `${s.name} (${s.role || "Staff"})`;
        select.appendChild(opt);
      });
    } catch (err) {
      console.error("Failed to load staff:", err);
      select.innerHTML += '<option value="">Error loading staff</option>';
    }
  }

  // Open create modal
  function openCreateModal() {
    const modal = getEl("ticketModal");
    const modalTitle = getEl("modalTitle");
    const form = getEl("ticketForm");
    const editId = getEl("editId");

    if (modalTitle) modalTitle.textContent = "Create New Ticket";
    if (form) form.reset();
    if (editId) editId.value = "";
    if (modal) {
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    }
    loadStaffIntoDropdown();
  }

  // Handle save ticket (create or update)
  async function handleSaveTicket(e) {
    e.preventDefault();

    const editId = getEl("editId");
    const fullName = getEl("fullName");
    const phone = getEl("phone");
    const issueType = getEl("issue_type");
    const priority = getEl("priority");
    const status = getEl("status");
    const assignedTo = getEl("assigned_to");
    const initialMessage = getEl("initialMessage");

    const id = editId?.value;
    const payload = {
      fullName: fullName?.value.trim() || "",
      phone: phone?.value.trim() || "",
      issue_type: issueType?.value || "",
      priority: priority?.value || "",
      status: status?.value || "",
      assigned_to: assignedTo?.value || null,
    };

    if (!payload.fullName) {
      alert("Full Name is required");
      return;
    }

    try {
      if (id) {
        // Update existing ticket
        const response = await fetch(`${API_BASE}/tickets/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!response.ok) throw new Error("Failed to update ticket");
      } else {
        // Create new ticket
        const ticket_number = `TKT-${Date.now().toString().slice(-6)}`;
        const response = await fetch(`${API_BASE}/tickets`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ...payload, ticket_number }),
        });

        if (!response.ok) throw new Error("Failed to create ticket");

        const ticket = await response.json();
        const msg = initialMessage?.value.trim();

        // Add initial message if provided
        if (msg && ticket.id) {
          await fetch(`${API_BASE}/messages`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              ticket_id: ticket.id,
              sender_staff_id: 1,
              message: msg,
            }),
          });
        }
      }

      closeModal();
      await loadTickets();
    } catch (err) {
      alert("Save failed: " + err.message);
    }
  }

  // Delete ticket
  async function deleteTicket(id) {
    if (
      !confirm(
        "Are you sure you want to delete this ticket and all associated messages?"
      )
    ) {
      return;
    }

    try {
      // Delete messages first
      await fetch(`${API_BASE}/messages/ticket/${id}`, {
        method: "DELETE",
      });

      // Then delete the ticket
      const response = await fetch(`${API_BASE}/tickets/${id}`, {
        method: "DELETE",
      });

      if (!response.ok) throw new Error("Failed to delete ticket");

      await loadTickets();
    } catch (err) {
      alert("Delete failed: " + err.message);
    }
  }

  // Close modal
  function closeModal() {
    const modal = getEl("ticketModal");
    if (modal) {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    }
  }

  // Open chat modal
  async function openChat(id) {
    currentTicketId = id;
    const t = allTickets.find((x) => x.id === id);
    if (!t) return;

    const modal = getEl("chatModal");
    const ticketNumber = getEl("chatTicketNumber");

    if (ticketNumber) ticketNumber.textContent = `#${t.ticket_number}`;
    if (modal) {
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    }

    await loadMessages(id);
  }

  // Load messages for a ticket
  async function loadMessages(ticketId) {
    const container = getEl("chatMessages");
    if (!container) return;

    try {
      const response = await fetch(`${API_BASE}/messages/ticket/${ticketId}`);
      if (!response.ok) throw new Error("Failed to load messages");

      const data = await response.json();

      // Handle both array response and object with messages property
      const msgs = Array.isArray(data) ? data : data.messages || [];
      renderChat(msgs);
    } catch (err) {
      container.innerHTML = `
        <div class="text-center py-8">
          <i class="fas fa-exclamation-circle text-red-500 text-3xl mb-3"></i>
          <p class="text-red-500">Error loading messages</p>
          <p class="text-sm text-red-400">${escapeHtml(err.message)}</p>
        </div>`;
    }
  }

  // Render chat messages
  function renderChat(msgs) {
    const container = getEl("chatMessages");
    if (!container) return;

    if (!msgs || !msgs.length) {
      container.innerHTML = `
        <div class="text-center py-12">
          <i class="fas fa-comment-slash text-gray-300 text-4xl mb-3"></i>
          <p class="text-gray-500">No messages yet</p>
          <p class="text-sm text-gray-400">Start the conversation below</p>
        </div>`;
      return;
    }

    container.innerHTML = msgs
      .map((m) => {
        const isStaff = !!m.sender_staff_id;
        const bgColor = isStaff ? "bg-blue-50" : "bg-gray-50";
        const alignClass = isStaff ? "flex-row-reverse" : "";
        const avatarColor = isStaff
          ? "bg-blue-100 text-blue-700"
          : "bg-teal-100 text-teal-700";

        return `
          <div class="flex items-start gap-3 ${alignClass}">
            <div class="w-10 h-10 ${avatarColor} rounded-full flex items-center justify-center text-sm font-bold">
              ${isStaff ? "A" : "U"}
            </div>
            <div class="max-w-md">
              <div class="${bgColor} p-3 rounded-lg shadow-sm">
                <p class="text-xs font-semibold text-gray-600 mb-1">
                  ${isStaff ? "Admin" : "User"}
                </p>
                <p class="text-gray-900">${escapeHtml(m.message)}</p>
                <p class="text-xs text-gray-500 mt-2">
                  ${new Date(m.created_at).toLocaleString()}
                </p>
              </div>
            </div>
          </div>`;
      })
      .join("");

    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
  }

  // Send message
  async function sendMessage() {
    const input = getEl("adminMessage");
    if (!input) return;

    const msg = input.value.trim();
    if (!msg || !currentTicketId) return;

    try {
      const response = await fetch(`${API_BASE}/messages`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          ticket_id: currentTicketId,
          sender_staff_id: 1,
          message: msg,
        }),
      });

      if (!response.ok) throw new Error("Failed to send message");

      input.value = "";
      await loadMessages(currentTicketId);
      await loadTickets(); // Refresh to update message count
      renderTickets();
    } catch (err) {
      alert("Failed to send message: " + err.message);
    }
  }

  async function fetchMessages() {
    try {
      const res = await fetch(`${API_BASE}/messages`);
      if (!res.ok) throw new Error("Failed to fetch messages");
      const data = await res.json();
      allMessages = Array.isArray(data) ? data : data.messages || [];
    } catch (err) {
      console.error("Error fetching messages:", err);
    }
  }

  // Close chat modal
  function closeChat() {
    const modal = getEl("chatModal");
    if (modal) {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    }
    currentTicketId = null;
  }

  // Make functions globally available
  window.loadTickets = loadTickets;
  window.openCreateModal = openCreateModal;
  window.deleteTicket = deleteTicket;
  window.openChat = openChat;
  window.sendMessage = sendMessage;
  window.closeModal = closeModal;
  window.closeChat = closeChat;
</script>
