<style>
  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }
  .animate-spin-slow {
    animation: spin 2s linear infinite;
  }
  .skeleton {
    background: #e5e7eb;
    animation: pulse 1.5s ease-in-out infinite;
  }
  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }
  .hidden {
    display: none !important;
  }
</style>
<div id="skeleton" class="p-8 space-y-6">
  <div class="flex justify-between">
    <div class="h-8 w-64 bg-gray-300 rounded skeleton"></div>
    <div class="h-10 w-32 bg-gray-300 rounded-lg skeleton"></div>
  </div>
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <div class="h-24 bg-gray-300 rounded-xl skeleton"></div>
    <div class="h-24 bg-gray-300 rounded-xl skeleton"></div>
    <div class="h-24 bg-gray-300 rounded-xl skeleton"></div>
    <div class="h-24 bg-gray-300 rounded-xl skeleton"></div>
  </div>
  <div class="bg-white p-6 rounded-xl shadow">
    <div class="h-6 w-48 bg-gray-300 rounded skeleton mb-4"></div>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
      <div class="h-12 bg-gray-300 rounded-lg skeleton"></div>
      <div class="h-12 bg-gray-300 rounded-lg skeleton"></div>
      <div class="h-12 bg-gray-300 rounded-lg skeleton"></div>
      <div class="h-12 bg-gray-300 rounded-lg skeleton"></div>
    </div>
  </div>
</div>

<!-- Main Content -->
<div id="content" class="hidden p-8 space-y-6">
  <!-- Header -->
  <div class="flex justify-between items-center">
    <div>
      <h1 class="text-3xl font-bold text-teal-800">Support Tickets</h1>
      <p class="text-teal-600">Manage all customer support requests</p>
    </div>
    <button
      id="newTicketBtn"
      class="bg-teal-600 hover:bg-teal-700 text-white px-5 py-3 rounded-lg font-semibold flex items-center gap-2 shadow-lg"
    >
      <i class="fas fa-plus"></i> New Ticket
    </button>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <div class="bg-white p-5 rounded-xl shadow border border-teal-100">
      <div class="flex justify-between items-center">
        <div>
          <p class="text-teal-600 text-sm font-bold">Total</p>
          <p id="totalTickets" class="text-2xl font-bold text-gray-800">0</p>
        </div>
        <i class="fas fa-ticket-alt text-2xl text-teal-600"></i>
      </div>
    </div>
    <div class="bg-white p-5 rounded-xl shadow border border-teal-100">
      <div class="flex justify-between items-center">
        <div>
          <p class="text-yellow-600 text-sm font-bold">Open</p>
          <p id="openTickets" class="text-2xl font-bold text-gray-800">0</p>
        </div>
        <i class="fas fa-inbox text-2xl text-yellow-600"></i>
      </div>
    </div>
    <div class="bg-white p-5 rounded-xl shadow border border-teal-100">
      <div class="flex justify-between items-center">
        <div>
          <p class="text-blue-600 text-sm font-bold">In Progress</p>
          <p id="inProgressTickets" class="text-2xl font-bold text-gray-800">
            0
          </p>
        </div>
        <i class="fas fa-spinner text-2xl text-blue-600"></i>
      </div>
    </div>
    <div class="bg-white p-5 rounded-xl shadow border border-teal-100">
      <div class="flex justify-between items-center">
        <div>
          <p class="text-green-600 text-sm font-bold">Resolved</p>
          <p id="resolvedTickets" class="text-2xl font-bold text-gray-800">0</p>
        </div>
        <i class="fas fa-check-circle text-2xl text-green-600"></i>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="bg-white p-6 rounded-xl shadow border border-teal-100">
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Search</label
        >
        <input
          id="searchInput"
          type="text"
          placeholder="Name, ticket ID..."
          class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-teal-500"
        />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Priority</label
        >
        <select
          id="priorityFilter"
          class="w-full p-3 border rounded-lg bg-white focus:ring-2 focus:ring-teal-500"
        >
          <option value="">All</option>
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="high">High</option>
          <option value="critical">Critical</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Issue Type</label
        >
        <select
          id="issueTypeFilter"
          class="w-full p-3 border rounded-lg bg-white focus:ring-2 focus:ring-teal-500"
        >
          <option value="">All</option>
          <option value="Network Issue">Network Issue</option>
          <option value="Hardware Problem">Hardware Problem</option>
          <option value="Software Bug">Software Bug</option>
          <option value="Installation Request">Installation Request</option>
          <option value="Maintenance">Maintenance</option>
          <option value="Repair">Repair</option>
          <option value="Inspection">Inspection</option>
          <option value="Asset Recovery">Asset Recovery</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Status</label
        >
        <select
          id="statusFilter"
          class="w-full p-3 border rounded-lg bg-white focus:ring-2 focus:ring-teal-500"
        >
          <option value="">All</option>
          <option value="open">Open</option>
          <option value="in_progress">In Progress</option>
          <option value="resolved">Resolved</option>
          <option value="closed">Closed</option>
        </select>
      </div>
      <div>
        <button
          id="refreshBtn"
          class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-3 rounded-lg font-semibold flex items-center justify-center gap-2 w-full"
        >
          <i class="fas fa-sync"></i> Refresh
        </button>
      </div>
    </div>
  </div>

  <!-- Tickets List -->
  <div id="ticketsList" class="space-y-3">
    <p class="text-center text-gray-500 py-8">Loading tickets...</p>
  </div>
</div>

<!-- Create/Edit Modal -->
<div
  id="ticketModal"
  class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/50"
>
  <div
    class="bg-white w-full max-w-2xl rounded-xl shadow-2xl max-h-[90vh] overflow-y-auto"
  >
    <div
      class="bg-teal-600 text-white p-5 flex justify-between items-center rounded-t-xl"
    >
      <h3 id="modalTitle" class="text-xl font-bold">Create Ticket</h3>
      <button id="closeModalBtn" class="text-white hover:text-gray-200">
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>
    <form id="ticketForm" class="p-6 space-y-4">
      <input type="hidden" id="editId" />
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-semibold mb-1">Full Name *</label>
          <input
            required
            id="fullName"
            type="text"
            class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-teal-500"
          />
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Phone</label>
          <input
            id="phone"
            type="text"
            class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-teal-500"
          />
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Issue Type *</label>
          <select
            required
            id="issue_type"
            class="w-full p-3 border rounded-lg bg-white focus:ring-2 focus:ring-teal-500"
          >
            <option value="Network Issue">Network Issue</option>
            <option value="Hardware Problem">Hardware Problem</option>
            <option value="Software Bug">Software Bug</option>
            <option value="Installation Request">Installation Request</option>
            <option value="Maintenance">Maintenance</option>
            <option value="Repair">Repair</option>
            <option value="Inspection">Inspection</option>
            <option value="Asset Recovery">Asset Recovery</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Priority *</label>
          <select
            required
            id="priority"
            class="w-full p-3 border rounded-lg bg-white focus:ring-2 focus:ring-teal-500"
          >
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
            <option value="critical">Critical</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Status</label>
          <select
            id="status"
            class="w-full p-3 border rounded-lg bg-white focus:ring-2 focus:ring-teal-500"
          >
            <option value="open">Open</option>
            <option value="in_progress">In Progress</option>
            <option value="resolved">Resolved</option>
            <option value="closed">Closed</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Assign Staff</label>
          <select
            id="assigned_to"
            class="w-full p-3 border rounded-lg bg-white focus:ring-2 focus:ring-teal-500"
          >
            <option value="">Unassigned</option>
            <option value="1">John (Admin)</option>
            <option value="2">Sarah (Tech)</option>
            <option value="3">Mike (Support)</option>
          </select>
        </div>
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Initial Message</label>
        <textarea
          id="initialMessage"
          rows="3"
          class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-teal-500"
        ></textarea>
      </div>
      <div class="flex justify-end gap-3 pt-4 border-t">
        <button
          type="submit"
          class="bg-teal-600 hover:bg-teal-700 text-white px-5 py-2 rounded-lg font-semibold"
        >
          <i class="fas fa-save"></i> Save
        </button>
        <button
          type="button"
          id="cancelModalBtn"
          class="bg-gray-500 hover:bg-gray-600 text-white px-5 py-2 rounded-lg font-semibold"
        >
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Chat Modal -->
<div
  id="chatModal"
  class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/50"
>
  <div
    class="bg-white w-full max-w-4xl rounded-xl shadow-2xl max-h-[90vh] flex flex-col"
  >
    <div
      class="bg-teal-600 text-white p-5 flex justify-between items-center rounded-t-xl"
    >
      <h3 class="text-xl font-bold">
        Chat - <span id="chatTicketNumber"></span>
      </h3>
      <button id="closeChatBtn" class="text-white hover:text-gray-200">
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>
    <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-4"></div>
    <div class="p-4 border-t bg-gray-50">
      <div class="flex gap-2">
        <textarea
          id="adminMessage"
          rows="2"
          placeholder="Type your reply..."
          class="flex-1 p-3 border rounded-lg focus:ring-2 focus:ring-teal-500"
        ></textarea>
        <button
          id="sendMessageBtn"
          class="bg-teal-600 hover:bg-teal-700 text-white px-5 py-2 rounded-lg font-semibold"
        >
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  const API_BASE = "/api";

  // State
  let allTickets = [];
  let allMessages = [];
  let currentTicketId = null;

  // Utility: Get element safely
  function getEl(id) {
    const el = document.getElementById(id);
    return el;
  }

  // Utility: Escape HTML
  function escapeHtml(text) {
    if (!text) return "";
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }

  // Utility: Format status
  function formatStatus(s) {
    const map = {
      open: "Open",
      in_progress: "In Progress",
      resolved: "Resolved",
      closed: "Closed",
    };
    return map[s] || s;
  }

  // Initialize when DOM is ready
  document.addEventListener("DOMContentLoaded", () => {
    // Attach event listeners
    const form = getEl("ticketForm");
    if (form) form.addEventListener("submit", handleSaveTicket);

    const newTicketBtn = getEl("newTicketBtn");
    if (newTicketBtn) newTicketBtn.addEventListener("click", openCreateModal);

    const closeModalBtn = getEl("closeModalBtn");
    if (closeModalBtn) closeModalBtn.addEventListener("click", closeModal);

    const cancelModalBtn = getEl("cancelModalBtn");
    if (cancelModalBtn) cancelModalBtn.addEventListener("click", closeModal);

    const refreshBtn = getEl("refreshBtn");
    if (refreshBtn) refreshBtn.addEventListener("click", loadTickets);

    const closeChatBtn = getEl("closeChatBtn");
    if (closeChatBtn) closeChatBtn.addEventListener("click", closeChat);

    const sendMessageBtn = getEl("sendMessageBtn");
    if (sendMessageBtn) sendMessageBtn.addEventListener("click", sendMessage);

    // Attach filter listeners
    attachFilters();

    // Load initial data
    loadTickets();
  });

  // Attach filter event listeners
  function attachFilters() {
    const filterIds = [
      "searchInput",
      "priorityFilter",
      "issueTypeFilter",
      "statusFilter",
    ];
    filterIds.forEach((id) => {
      const el = getEl(id);
      if (el) {
        el.addEventListener("input", renderTickets);
      }
    });
  }

  // Load tickets and messages from API
  async function loadTickets() {
    const skeleton = getEl("skeleton");
    const content = getEl("content");

    if (skeleton) skeleton.classList.remove("hidden");
    if (content) content.classList.add("hidden");

    try {
      const ticketsRes = await fetch(`${API_BASE}/tickets`);

      if (!ticketsRes.ok) {
        throw new Error(
          `Failed to fetch tickets: ${ticketsRes.status} ${ticketsRes.statusText}`
        );
      }

      const ticketsData = await ticketsRes.json();

      const messagesRes = await fetch(`${API_BASE}/messages`);

      if (!messagesRes.ok) {
        throw new Error(
          `Failed to fetch messages: ${messagesRes.status} ${messagesRes.statusText}`
        );
      }

      const messagesData = await messagesRes.json();
      allTickets = Array.isArray(ticketsData) ? ticketsData : [];
      allMessages = Array.isArray(messagesData) ? messagesData : [];
      await fetchMessages();

      updateStats();
      renderTickets();
    } catch (err) {
      const ticketsList = getEl("ticketsList");
      if (ticketsList) {
        ticketsList.innerHTML = `
          <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
            <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-3"></i>
            <p class="text-red-700 font-semibold text-lg">Error Loading Tickets</p>
            <p class="text-red-600 text-sm mt-2">${escapeHtml(err.message)}</p>
            <button 
              onclick="loadTickets()" 
              class="mt-4 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg"
            >
              <i class="fas fa-sync"></i> Retry
            </button>
          </div>`;
      }
    } finally {
      if (skeleton) skeleton.classList.add("hidden");
      if (content) content.classList.remove("hidden");
    }
  }

  // Update statistics cards
  function updateStats() {
    const total = allTickets.length;
    const open = allTickets.filter((t) => t.status === "open").length;
    const inProgress = allTickets.filter(
      (t) => t.status === "in_progress"
    ).length;
    const resolved = allTickets.filter((t) => t.status === "resolved").length;

    const totalEl = getEl("totalTickets");
    const openEl = getEl("openTickets");
    const inProgressEl = getEl("inProgressTickets");
    const resolvedEl = getEl("resolvedTickets");

    if (totalEl) totalEl.textContent = total;
    if (openEl) openEl.textContent = open;
    if (inProgressEl) inProgressEl.textContent = inProgress;
    if (resolvedEl) resolvedEl.textContent = resolved;
  }

  // Render tickets list with filters
  function renderTickets() {
    const list = getEl("ticketsList");
    if (!list) return;

    const searchEl = getEl("searchInput");
    const priorityEl = getEl("priorityFilter");
    const issueTypeEl = getEl("issueTypeFilter");
    const statusEl = getEl("statusFilter");

    const search = (searchEl?.value || "").toLowerCase();
    const priority = priorityEl?.value || "";
    const issueType = issueTypeEl?.value || "";
    const status = statusEl?.value || "";

    let filtered = allTickets.filter((t) => {
      const matchesSearch =
        (t.fullName || "").toLowerCase().includes(search) ||
        (t.ticket_number || "").toLowerCase().includes(search) ||
        (t.subject || "").toLowerCase().includes(search);
      const matchesPriority = !priority || t.priority === priority;
      const matchesIssue = !issueType || t.issue_type === issueType;
      const matchesStatus = !status || t.status === status;
      return matchesSearch && matchesPriority && matchesIssue && matchesStatus;
    });

    if (!filtered.length) {
      list.innerHTML = `
        <div class="text-center py-12">
          <i class="fas fa-inbox text-gray-300 text-5xl mb-4"></i>
          <p class="text-gray-500 text-lg">No tickets found</p>
          <p class="text-gray-400 text-sm">Try adjusting your filters</p>
        </div>`;
      return;
    }

    list.innerHTML = filtered
      .map((t) => {
        const statusColors = {
          open: "bg-yellow-100 text-yellow-700",
          in_progress: "bg-blue-100 text-blue-700",
          resolved: "bg-green-100 text-green-700",
          closed: "bg-gray-200 text-gray-700",
        };
        const statusColor = statusColors[t.status] || "bg-gray-100";

        const msgCount = allMessages.filter((m) => m.ticket_id == t.id).length;
        const assigned = t.assigned_to
          ? `Staff #${t.assigned_to}`
          : "Unassigned";

        return `
          <div class="bg-white p-4 rounded-lg shadow border hover:border-teal-400 transition">
            <div class="grid grid-cols-1 md:grid-cols-8 gap-3 items-center text-sm">
              <div class="font-semibold text-gray-800 truncate">${escapeHtml(
                t.fullName
              )}</div>
              <div class="font-mono text-teal-700">#${escapeHtml(
                t.ticket_number
              )}</div>
              <div class="truncate">${escapeHtml(t.issue_type)}</div>
              <div class="truncate capitalize">${escapeHtml(t.priority)}</div>
              <div>
                <span class="px-2 py-1 rounded text-xs font-medium ${statusColor}">
                  ${formatStatus(t.status)}
                </span>
              </div>
              <div class="truncate text-xs text-gray-500">${escapeHtml(
                assigned
              )}</div>
              <div class="flex justify-end gap-1">
                <button 
                  onclick="openChat(${t.id})" 
                  class="p-2 text-teal-600 hover:bg-teal-50 rounded transition" 
                  title="Chat"
                >
                  <i class="fas fa-comments"></i> 
                  <span class="text-xs">${msgCount}</span>
                </button>
                <button 
                  onclick="editTicket(${t.id})" 
                  class="p-2 text-blue-600 hover:bg-blue-50 rounded transition" 
                  title="Edit"
                >
                  <i class="fas fa-edit"></i>
                </button>
                <button 
                  onclick="deleteTicket(${t.id})" 
                  class="p-2 text-red-600 hover:bg-red-50 rounded transition" 
                  title="Delete"
                >
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>`;
      })
      .join("");
  }

  // Open create modal
  function openCreateModal() {
    const modal = getEl("ticketModal");
    const modalTitle = getEl("modalTitle");
    const form = getEl("ticketForm");
    const editId = getEl("editId");

    if (modalTitle) modalTitle.textContent = "Create New Ticket";
    if (form) form.reset();
    if (editId) editId.value = "";
    if (modal) {
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    }
  }

  // Edit ticket
  function editTicket(id) {
    const t = allTickets.find((x) => x.id === id);
    if (!t) return;

    const modal = getEl("ticketModal");
    const modalTitle = getEl("modalTitle");
    const editId = getEl("editId");
    const fullName = getEl("fullName");
    const phone = getEl("phone");
    const issueType = getEl("issue_type");
    const priority = getEl("priority");
    const status = getEl("status");
    const assignedTo = getEl("assigned_to");
    const initialMessage = getEl("initialMessage");

    if (editId) editId.value = t.id;
    if (fullName) fullName.value = t.fullName || "";
    if (phone) phone.value = t.phone || "";
    if (issueType) issueType.value = t.issue_type || "";
    if (priority) priority.value = t.priority || "";
    if (status) status.value = t.status || "";
    if (assignedTo) assignedTo.value = t.assigned_to || "";
    if (initialMessage) initialMessage.value = "";
    if (modalTitle) modalTitle.textContent = "Edit Ticket";
    if (modal) {
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    }
  }

  // Handle save ticket (create or update)
  async function handleSaveTicket(e) {
    e.preventDefault();

    const editId = getEl("editId");
    const fullName = getEl("fullName");
    const phone = getEl("phone");
    const issueType = getEl("issue_type");
    const priority = getEl("priority");
    const status = getEl("status");
    const assignedTo = getEl("assigned_to");
    const initialMessage = getEl("initialMessage");

    const id = editId?.value;
    const payload = {
      fullName: fullName?.value.trim() || "",
      phone: phone?.value.trim() || "",
      issue_type: issueType?.value || "",
      priority: priority?.value || "",
      status: status?.value || "",
      assigned_to: assignedTo?.value || null,
    };

    if (!payload.fullName) {
      alert("Full Name is required");
      return;
    }

    try {
      if (id) {
        // Update existing ticket
        const response = await fetch(`${API_BASE}/tickets/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!response.ok) throw new Error("Failed to update ticket");
      } else {
        // Create new ticket
        const ticket_number = `TKT-${Date.now().toString().slice(-6)}`;
        const response = await fetch(`${API_BASE}/tickets`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ...payload, ticket_number }),
        });

        if (!response.ok) throw new Error("Failed to create ticket");

        const ticket = await response.json();
        const msg = initialMessage?.value.trim();

        // Add initial message if provided
        if (msg && ticket.id) {
          await fetch(`${API_BASE}/messages`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              ticket_id: ticket.id,
              sender_staff_id: 1,
              message: msg,
            }),
          });
        }
      }

      closeModal();
      await loadTickets();
    } catch (err) {
      alert("Save failed: " + err.message);
    }
  }

  // Delete ticket
  async function deleteTicket(id) {
    if (
      !confirm(
        "Are you sure you want to delete this ticket and all associated messages?"
      )
    ) {
      return;
    }

    try {
      // Delete messages first
      await fetch(`${API_BASE}/messages/ticket/${id}`, {
        method: "DELETE",
      });

      // Then delete the ticket
      const response = await fetch(`${API_BASE}/tickets/${id}`, {
        method: "DELETE",
      });

      if (!response.ok) throw new Error("Failed to delete ticket");

      await loadTickets();
    } catch (err) {
      alert("Delete failed: " + err.message);
    }
  }

  // Close modal
  function closeModal() {
    const modal = getEl("ticketModal");
    if (modal) {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    }
  }

  // Open chat modal
  async function openChat(id) {
    currentTicketId = id;
    const t = allTickets.find((x) => x.id === id);
    if (!t) return;

    const modal = getEl("chatModal");
    const ticketNumber = getEl("chatTicketNumber");

    if (ticketNumber) ticketNumber.textContent = `#${t.ticket_number}`;
    if (modal) {
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    }

    await loadMessages(id);
  }

  // Load messages for a ticket
  async function loadMessages(ticketId) {
    const container = getEl("chatMessages");
    if (!container) return;

    try {
      const response = await fetch(`${API_BASE}/messages/ticket/${ticketId}`);
      if (!response.ok) throw new Error("Failed to load messages");

      const data = await response.json();

      // Handle both array response and object with messages property
      const msgs = Array.isArray(data) ? data : data.messages || [];
      renderChat(msgs);
    } catch (err) {
      container.innerHTML = `
        <div class="text-center py-8">
          <i class="fas fa-exclamation-circle text-red-500 text-3xl mb-3"></i>
          <p class="text-red-500">Error loading messages</p>
          <p class="text-sm text-red-400">${escapeHtml(err.message)}</p>
        </div>`;
    }
  }

  // Render chat messages
  function renderChat(msgs) {
    const container = getEl("chatMessages");
    if (!container) return;

    if (!msgs || !msgs.length) {
      container.innerHTML = `
        <div class="text-center py-12">
          <i class="fas fa-comment-slash text-gray-300 text-4xl mb-3"></i>
          <p class="text-gray-500">No messages yet</p>
          <p class="text-sm text-gray-400">Start the conversation below</p>
        </div>`;
      return;
    }

    container.innerHTML = msgs
      .map((m) => {
        const isStaff = !!m.sender_staff_id;
        const bgColor = isStaff ? "bg-blue-50" : "bg-gray-50";
        const alignClass = isStaff ? "flex-row-reverse" : "";
        const avatarColor = isStaff
          ? "bg-blue-100 text-blue-700"
          : "bg-teal-100 text-teal-700";

        return `
          <div class="flex items-start gap-3 ${alignClass}">
            <div class="w-10 h-10 ${avatarColor} rounded-full flex items-center justify-center text-sm font-bold">
              ${isStaff ? "A" : "U"}
            </div>
            <div class="max-w-md">
              <div class="${bgColor} p-3 rounded-lg shadow-sm">
                <p class="text-xs font-semibold text-gray-600 mb-1">
                  ${isStaff ? "Admin" : "User"}
                </p>
                <p class="text-gray-900">${escapeHtml(m.message)}</p>
                <p class="text-xs text-gray-500 mt-2">
                  ${new Date(m.created_at).toLocaleString()}
                </p>
              </div>
            </div>
          </div>`;
      })
      .join("");

    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
  }

  // Send message
  async function sendMessage() {
    const input = getEl("adminMessage");
    if (!input) return;

    const msg = input.value.trim();
    if (!msg || !currentTicketId) return;

    try {
      const response = await fetch(`${API_BASE}/messages`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          ticket_id: currentTicketId,
          sender_staff_id: 1,
          message: msg,
        }),
      });

      if (!response.ok) throw new Error("Failed to send message");

      input.value = "";
      await loadMessages(currentTicketId);
      await loadTickets(); // Refresh to update message count
      renderTickets();
    } catch (err) {
      alert("Failed to send message: " + err.message);
    }
  }

  async function fetchMessages() {
    try {
      const res = await fetch(`${API_BASE}/messages`);
      if (!res.ok) throw new Error("Failed to fetch messages");
      const data = await res.json();
      allMessages = Array.isArray(data) ? data : data.messages || [];
    } catch (err) {
      console.error("Error fetching messages:", err);
    }
  }

  // Close chat modal
  function closeChat() {
    const modal = getEl("chatModal");
    if (modal) {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    }
    currentTicketId = null;
  }

  // Make functions globally available
  window.loadTickets = loadTickets;
  window.openCreateModal = openCreateModal;
  window.editTicket = editTicket;
  window.deleteTicket = deleteTicket;
  window.openChat = openChat;
  window.sendMessage = sendMessage;
  window.closeModal = closeModal;
  window.closeChat = closeChat;
</script>
