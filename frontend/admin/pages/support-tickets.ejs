<style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
    :root { font-family: 'Plus Jakarta Sans', sans-serif; }
    body { background-color: #f8fafc; color: #1e293b; overflow-x: hidden; }

    /* Layout Containers */
    .main-container { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    .side-panel { 
        position: fixed; top: 0; right: -100%; width: 100%; max-width: 500px; height: 100vh; 
        background: white; z-index: 50; box-shadow: -10px 0 30px rgba(0,0,0,0.1);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex; flex-direction: column;
    }
    .side-panel.active { right: 0; }
    .overlay { 
        position: fixed; inset: 0; background: rgba(15, 23, 42, 0.5); 
        backdrop-filter: blur(4px); z-index: 40; display: none; 
    }
    .overlay.active { display: block; }

    /* UI Components */
    .glass-panel { background: white; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
    .input-field { background: #f1f5f9; border: 1px solid #e2e8f0; transition: all 0.2s; }
    .input-field:focus { background: white; border-color: #0d9488; ring: 3px rgba(13, 148, 136, 0.1); }
    
    .ticket-card { border: 1px solid #e2e8f0; transition: all 0.3s; }
    .ticket-card:hover { border-color: #0d9488; transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }

    .badge { font-size: 10px; font-weight: 800; text-transform: uppercase; padding: 4px 10px; border-radius: 6px; }
    .badge-critical { background: #fef2f2; color: #b91c1c; }
    .badge-high { background: #fff7ed; color: #c2410c; }
    .badge-medium { background: #fefce8; color: #a16207; }
    .badge-low { background: #f0f9ff; color: #0369a1; }

    /* Chat Bubbles */
    .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 14px; }
    .chat-left { background: #f1f5f9; color: #1e293b; border-bottom-left-radius: 4px; }
    .chat-right { background: #0d9488; color: white; border-bottom-right-radius: 4px; }
    
    .label-caps { font-size: 10px; font-weight: 800; text-transform: uppercase; color: #64748b; letter-spacing: 0.05em; }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
</style>

<div class="overlay" id="uiOverlay" onclick="closeAllPanels()"></div>

<div class="main-container max-w-full mx-auto py-4">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
        <div>
            <h1 class="text-3xl font-black text-slate-900 tracking-tight">Help Desk</h1>
            <p class="text-slate-500 font-bold text-xs uppercase tracking-widest">Single-view Support Management</p>
        </div>
        <div class="flex gap-3">
            <button onclick="loadTickets()" class="p-3 bg-white border border-slate-200 rounded-2xl text-slate-600 hover:bg-slate-50 transition-all">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button onclick="openCreatePanel()" class="bg-slate-900 text-white px-6 py-3 rounded-2xl font-black text-xs uppercase tracking-widest hover:bg-teal-600 shadow-xl transition-all flex items-center gap-2">
                <i class="fas fa-plus"></i> Create Ticket
            </button>
        </div>
    </div>

    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="glass-panel p-5 rounded-[2rem] flex items-center gap-4 border-b-4 border-slate-200">
            <div class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center text-slate-500"><i class="fas fa-list"></i></div>
            <div><p class="label-caps">Total</p><h4 id="totalTickets" class="text-xl font-black">0</h4></div>
        </div>
        <div class="glass-panel p-5 rounded-[2rem] flex items-center gap-4 border-b-4 border-yellow-400">
            <div class="w-10 h-10 bg-yellow-50 rounded-xl flex items-center justify-center text-yellow-600"><i class="fas fa-door-open"></i></div>
            <div><p class="label-caps text-yellow-600">Open</p><h4 id="openTickets" class="text-xl font-black">0</h4></div>
        </div>
        <div class="glass-panel p-5 rounded-[2rem] flex items-center gap-4 border-b-4 border-blue-500">
            <div class="w-10 h-10 bg-blue-50 rounded-xl flex items-center justify-center text-blue-600"><i class="fas fa-spinner"></i></div>
            <div><p class="label-caps text-blue-600">Active</p><h4 id="inProgressTickets" class="text-xl font-black">0</h4></div>
        </div>
        <div class="glass-panel p-5 rounded-[2rem] flex items-center gap-4 border-b-4 border-teal-500">
            <div class="w-10 h-10 bg-teal-50 rounded-xl flex items-center justify-center text-teal-600"><i class="fas fa-check"></i></div>
            <div><p class="label-caps text-teal-600">Fixed</p><h4 id="resolvedTickets" class="text-xl font-black">0</h4></div>
        </div>
    </div>

    <div class="glass-panel rounded-3xl p-4 mb-8 grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="relative"><i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
            <input type="text" id="searchInput" oninput="renderTickets()" placeholder="Search..." class="w-full pl-11 pr-4 py-3 rounded-2xl input-field text-sm font-bold outline-none">
        </div>
        <select id="priorityFilter" onchange="renderTickets()" class="py-3 px-4 rounded-2xl input-field text-sm font-bold outline-none">
            <option value="">All Priorities</option><option value="critical">Critical</option><option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option>
        </select>
        <select id="issueTypeFilter" onchange="renderTickets()" class="py-3 px-4 rounded-2xl input-field text-sm font-bold outline-none">
            <option value="">All Issues</option><option value="Network Issue">Network Issue</option><option value="Hardware Problem">Hardware Problem</option>
        </select>
        <select id="statusFilter" onchange="renderTickets()" class="py-3 px-4 rounded-2xl input-field text-sm font-bold outline-none">
            <option value="">All Statuses</option><option value="open">Open</option><option value="in_progress">In Progress</option><option value="resolved">Resolved</option>
        </select>
    </div>

    <div id="ticketsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        </div>
</div>

<div id="formPanel" class="side-panel">
    <div class="p-8 border-b flex justify-between items-center bg-slate-50">
        <div>
            <h3 id="panelTitle" class="text-xl font-black text-slate-900">New Ticket</h3>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Details & Assignment</p>
        </div>
        <button onclick="closeAllPanels()" class="w-10 h-10 rounded-full hover:bg-rose-50 hover:text-rose-500 transition-all"><i class="fas fa-times"></i></button>
    </div>
    <form id="ticketForm" class="p-8 flex-1 overflow-y-auto space-y-6" onsubmit="handleSaveTicket(event)">
        <input type="hidden" id="editId">
        <div class="space-y-4">
            <div><label class="label-caps block mb-2">Customer Name</label>
                <input required id="fullName" type="text" class="w-full px-4 py-3 rounded-2xl input-field text-sm font-bold outline-none"></div>
            <div><label class="label-caps block mb-2">Contact Number</label>
                <input id="phone" type="text" class="w-full px-4 py-3 rounded-2xl input-field text-sm font-bold outline-none"></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="label-caps block mb-2">Type</label>
                    <select required id="issue_type" class="w-full px-4 py-3 rounded-xl input-field text-sm font-bold outline-none">
                        <option value="Network Issue">Network</option><option value="Hardware Problem">Hardware</option><option value="Maintenance">Maintenance</option>
                    </select></div>
                <div><label class="label-caps block mb-2">Priority</label>
                    <select required id="priority" class="w-full px-4 py-3 rounded-xl input-field text-sm font-bold outline-none">
                        <option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option><option value="critical">Critical</option>
                    </select></div>
            </div>
            <div><label class="label-caps block mb-2">Assign Agent</label>
                <select id="assigned_to" class="w-full px-4 py-3 rounded-2xl input-field text-sm font-bold outline-none"></select></div>
            <div><label class="label-caps block mb-2">Issue Description</label>
                <textarea id="initialMessage" rows="5" class="w-full px-4 py-3 rounded-2xl input-field text-sm font-bold outline-none"></textarea></div>
        </div>
        <div class="pt-6">
            <button type="submit" class="w-full bg-teal-600 text-white py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg shadow-teal-200 hover:bg-slate-900 transition-all">
                Save Ticket
            </button>
        </div>
    </form>
</div>

<div id="chatPanel" class="side-panel !max-w-[600px]">
    <div class="p-6 bg-slate-900 text-white flex justify-between items-center">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-2xl bg-teal-500 flex items-center justify-center text-white shadow-lg"><i class="fas fa-comments"></i></div>
            <div><h3 id="chatTicketNumber" class="text-lg font-black">#TKT-000</h3><p class="text-[9px] font-bold text-teal-400 uppercase tracking-widest">Real-time Support</p></div>
        </div>
        <button onclick="closeAllPanels()" class="w-10 h-10 rounded-full hover:bg-white/10 transition-all"><i class="fas fa-times"></i></button>
    </div>
    <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-4 bg-slate-50"></div>
    <div class="p-6 bg-white border-t">
        <div class="flex gap-2 bg-slate-100 p-2 rounded-2xl">
            <textarea id="adminMessage" rows="1" placeholder="Type a reply..." class="flex-1 bg-transparent border-none focus:ring-0 p-3 text-sm font-bold resize-none"></textarea>
            <button onclick="sendMessage()" class="w-12 h-12 bg-slate-900 text-white rounded-xl hover:bg-teal-600 transition-all"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<script>
    // --- State Management ---
    let allTickets = [];
    let allMessages = [];
    let allStaff = [];
    let currentTicketId = null;

    const API_BASE = "/api";
    const getEl = (id) => document.getElementById(id);
    const escapeHtml = (text) => text ? String(text).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : '';
    const formatStatus = (s) => s.replace('_', ' ').toUpperCase();

    // --- Core Functions ---
    async function loadTickets() {
        try {
            const [tRes, mRes, sRes] = await Promise.all([
                fetch(`${API_BASE}/tickets`), fetch(`${API_BASE}/messages`), fetch(`${API_BASE}/tickets/staff`)
            ]);
            allTickets = await tRes.json();
            const mData = await mRes.json();
            allMessages = mData.messages || mData;
            allStaff = await sRes.json();

            updateStats();
            renderTickets();
            populateStaffDropdowns();
        } catch (err) { console.error("Load failed", err); }
    }

    function updateStats() {
        getEl("totalTickets").textContent = allTickets.length;
        getEl("openTickets").textContent = allTickets.filter(t => t.status === 'open').length;
        getEl("inProgressTickets").textContent = allTickets.filter(t => t.status === 'in_progress').length;
        getEl("resolvedTickets").textContent = allTickets.filter(t => t.status === 'resolved').length;
    }

    function renderTickets() {
        const list = getEl("ticketsList");
        const q = getEl("searchInput").value.toLowerCase();
        const pFilter = getEl("priorityFilter").value;
        const sFilter = getEl("statusFilter").value;

        const filtered = allTickets.filter(t => 
            (t.fullName.toLowerCase().includes(q) || t.ticket_number.includes(q)) &&
            (!pFilter || t.priority === pFilter) &&
            (!sFilter || t.status === sFilter)
        );

        list.innerHTML = filtered.map(t => {
            const mCount = allMessages.filter(m => m.ticket_id == t.id).length;
            return `
            <div class="glass-panel rounded-[2rem] p-6 ticket-card flex flex-col">
                <div class="flex justify-between items-start mb-4">
                    <span class="badge badge-${t.priority}">${t.priority}</span>
                    <span class="text-[10px] font-black text-slate-400">#${t.ticket_number}</span>
                </div>
                <h4 class="text-lg font-black text-slate-900 mb-1">${escapeHtml(t.fullName)}</h4>
                <div class="flex items-center gap-2 mb-4 text-[10px] font-bold text-slate-500">
                    <span class="px-2 py-0.5 rounded bg-slate-100">${formatStatus(t.status)}</span>
                    <span>â€¢</span>
                    <span>${t.issue_type}</span>
                </div>
                <p class="text-sm text-slate-500 font-medium mb-6 line-clamp-2">${escapeHtml(t.description)}</p>
                
                <div class="mt-auto pt-4 border-t border-slate-100 flex items-center justify-between">
                    <button onclick="openChatPanel(${t.id})" class="text-xs font-black text-teal-600 hover:text-slate-900 transition-all flex items-center gap-2">
                        <i class="fas fa-comment-dots"></i> ${mCount} MESSAGES
                    </button>
                    <div class="flex gap-2">
                        <button onclick="openEditPanel(${t.id})" class="w-8 h-8 rounded-lg bg-slate-50 text-slate-400 hover:text-teal-600 transition-all"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteTicket(${t.id})" class="w-8 h-8 rounded-lg bg-slate-50 text-slate-400 hover:text-rose-500 transition-all"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
            </div>`;
        }).join("");
    }

    // --- Panel Controls ---
    function openCreatePanel() {
        getEl("panelTitle").textContent = "New Ticket";
        getEl("ticketForm").reset();
        getEl("editId").value = "";
        togglePanel("formPanel", true);
    }

    function openEditPanel(id) {
        const t = allTickets.find(x => x.id === id);
        if (!t) return;
        getEl("panelTitle").textContent = "Edit Ticket";
        getEl("editId").value = t.id;
        getEl("fullName").value = t.fullName;
        getEl("phone").value = t.phone || '';
        getEl("issue_type").value = t.issue_type;
        getEl("priority").value = t.priority;
        getEl("assigned_to").value = t.assigned_to || '';
        getEl("initialMessage").value = t.description;
        togglePanel("formPanel", true);
    }

    async function openChatPanel(id) {
        currentTicketId = id;
        const t = allTickets.find(x => x.id === id);
        getEl("chatTicketNumber").textContent = `#${t.ticket_number}`;
        togglePanel("chatPanel", true);
        await loadMessages(id);
    }

    function togglePanel(id, show) {
        getEl(id).classList.toggle("active", show);
        getEl("uiOverlay").classList.toggle("active", show);
    }

    function closeAllPanels() {
        document.querySelectorAll('.side-panel').forEach(p => p.classList.remove("active"));
        getEl("uiOverlay").classList.remove("active");
        currentTicketId = null;
    }

    // --- CRUD Actions ---
    async function handleSaveTicket(e) {
        e.preventDefault();
        const id = getEl("editId").value;
        const payload = {
            fullName: getEl("fullName").value,
            phone: getEl("phone").value,
            issue_type: getEl("issue_type").value,
            priority: getEl("priority").value,
            assigned_to: getEl("assigned_to").value || null,
            description: getEl("initialMessage").value,
            status: id ? undefined : 'open'
        };

        try {
            const url = id ? `${API_BASE}/tickets/${id}` : `${API_BASE}/tickets`;
            const method = id ? 'PUT' : 'POST';
            if (!id) payload.ticket_number = `TKT-${Date.now().toString().slice(-6)}`;

            const res = await fetch(url, {
                method, headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if (res.ok) { closeAllPanels(); loadTickets(); }
        } catch (err) { alert("Save failed"); }
    }

    async function sendMessage() {
        const msg = getEl("adminMessage").value.trim();
        if (!msg || !currentTicketId) return;

        try {
            await fetch(`${API_BASE}/messages`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ ticket_id: currentTicketId, sender_staff_id: 1, message: msg })
            });
            getEl("adminMessage").value = '';
            loadMessages(currentTicketId);
        } catch (err) { alert("Send failed"); }
    }

    async function loadMessages(tid) {
        const res = await fetch(`${API_BASE}/messages/ticket/${tid}`);
        const data = await res.json();
        const msgs = data.messages || data;
        const container = getEl("chatMessages");
        
        container.innerHTML = msgs.map(m => `
            <div class="flex ${m.sender_staff_id ? 'justify-end' : 'justify-start'}">
                <div class="chat-bubble ${m.sender_staff_id ? 'chat-right shadow-lg' : 'chat-left'}">
                    <p class="font-bold text-[9px] uppercase mb-1 opacity-70">${m.sender_staff_id ? 'Staff' : 'Customer'}</p>
                    <p class="font-medium">${escapeHtml(m.message)}</p>
                </div>
            </div>`).join("");
        container.scrollTop = container.scrollHeight;
    }

    function populateStaffDropdowns() {
        const html = '<option value="">Unassigned</option>' + allStaff.map(s => `<option value="${s.id}">${s.first_name} ${s.second_name}</option>`).join("");
        getEl("assigned_to").innerHTML = html;
    }

    async function deleteTicket(id) {
        if (!confirm("Delete this ticket?")) return;
        await fetch(`${API_BASE}/tickets/${id}`, { method: 'DELETE' });
        loadTickets();
    }

    // Init
    document.addEventListener("DOMContentLoaded", loadTickets);
</script>