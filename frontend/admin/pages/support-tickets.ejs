<style>
        .chat-scroll::-webkit-scrollbar { width: 5px; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .bubble-in { border-radius: 0 15px 15px 15px; background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .bubble-out { border-radius: 15px 0 15px 15px; background: #dcf8c6; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .chat-bg { background-color: #e5ddd5; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><text x="10" y="50" font-size="80" fill="%23999">ðŸ’¬</text></svg>'); }
        .line-clamp-1 {
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .animate-fade-in { 
            animation: fadeIn 0.3s ease-out forwards; 
        }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(5px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .spinner {
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 0.6s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
<div class="bg-gray-100 h-screen overflow-hidden flex flex-col">
    <div id="toastContainer" class="fixed top-5 right-5 z-[100] space-y-3"></div>
    <header class="bg-slate-800 text-white p-4 flex justify-between items-center shadow-md z-30">
        <h1 class="text-lg md:text-xl font-bold tracking-tight">SUPPORT MANAGEMENT</h1>
        <div class="flex gap-2">
            <button onclick="loadCreateForm()" class="bg-green-600 hover:bg-green-700 px-3 py-2 rounded text-xs md:text-sm font-semibold transition">
                + <span class="hidden md:inline">New Ticket</span>
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        <aside id="sidebar" class="w-full md:w-1/3 lg:w-1/4 border-r bg-white flex flex-col z-20 transition-all duration-300">
            <div class="p-4 border-b bg-gray-50">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-bold text-gray-500 uppercase">Tickets</span>
                    <button onclick="viewArchivedTickets()" class="text-[10px] font-bold text-blue-600 hover:underline">VIEW ARCHIVES</button>
                </div>
                <input type="text" id="ticketSearch" onkeyup="filterTickets()" placeholder="Search tickets..." class="w-full p-2 border rounded text-sm outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex-1 overflow-y-auto" id="ticketList"></div>
        </aside>

        <div id="mainDisplay" class="hidden md:flex flex-1 flex-col bg-white absolute inset-0 z-10 md:relative md:z-0">
            <div class="flex items-center justify-center h-full text-gray-400 flex-col p-6 text-center">
                <svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4v-3a2 2 0 00-2-2H5z"></path></svg>
                <p>Select a ticket to view conversation</p>
            </div>
        </div>
    </div>
</div>
    <script>
        async function requestNotificationPermission() {
            if (!("Notification" in window)) {
                console.log("This browser does not support desktop notification");
                return;
            }

            if (Notification.permission !== "granted" && Notification.permission !== "denied") {
                const permission = await Notification.requestPermission();
                if (permission === "granted") {
                    console.log("Notification permission granted.");
                }
            }
        }

        const socket = io(); 
        let activeTicketId = null;
        let allTickets = []; 
        let currentUserId = null;       

        // 1. INITIAL LOAD
        window.onload = () => {
            loadTickets();
            requestNotificationPermission();
            loadCurrentUserProfile();
        }

        async function loadCurrentUserProfile() {
            try {
                const res = await fetch('/api/profile');
                if (res.ok) {
                    const data = await res.json();
                    if (data.profile && data.profile.id) {
                        currentUserId = data.profile.id;
                    }
                }
            } catch (err) {
                console.error("Error loading user profile:", err);
            }
        }

        async function loadTickets() {
            try {
                const res = await fetch('/api/tickets');
                allTickets = await res.json();
                renderTicketList(allTickets);
            } catch (err) { console.error("Error loading tickets", err); }
        }

        function renderTicketList(tickets) {
            const list = document.getElementById('ticketList');
            list.innerHTML = tickets.map(t => {
                const maxLength = 50;
                const subjectTruncated = t.issue_subject.length > maxLength;
                const descTruncated = t.description && t.description.length > maxLength;
                
                return `
                    <div class="p-4 border-b hover:bg-blue-50 cursor-pointer transition border-l-4 ${activeTicketId == t.id ? 'border-l-blue-500 bg-blue-50' : 'border-l-transparent'}" onclick="viewTicket(${t.id})">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-bold text-slate-700 text-sm">#${t.ticket_number}</span>
                            <span class="text-[10px] ${t.status === 'open' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'} px-2 py-0.5 rounded-full font-bold uppercase">${t.status}</span>
                        </div>
                        
                        <div class="mb-2">
                            <h4 id="subject-${t.id}" class="text-sm font-medium text-gray-800 ${subjectTruncated ? 'line-clamp-1' : ''}">
                                ${t.issue_subject}
                            </h4>
                            ${subjectTruncated ? `
                                <button onclick="event.stopPropagation(); toggleText('subject-${t.id}', 'subject-btn-${t.id}')" 
                                    id="subject-btn-${t.id}"
                                    class="text-[10px] text-blue-600 hover:underline font-semibold mt-1">
                                    Show more
                                </button>
                            ` : ''}
                        </div>
                        
                        ${t.description ? `
                            <div class="mb-2">
                                <p id="desc-${t.id}" class="text-xs text-gray-500 ${descTruncated ? 'line-clamp-2' : ''}">
                                    ${t.description}
                                </p>
                                ${descTruncated ? `
                                    <button onclick="event.stopPropagation(); toggleText('desc-${t.id}', 'desc-btn-${t.id}')" 
                                        id="desc-btn-${t.id}"
                                        class="text-[10px] text-blue-600 hover:underline font-semibold mt-1">
                                        Show more
                                    </button>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <p class="text-xs text-gray-500 mt-1">Client: ${t.first_name} ${t.second_name}</p>
                    </div>
                `;
            }).join('');
        }

        function toggleText(elementId, buttonId) {
            const element = document.getElementById(elementId);
            const button = document.getElementById(buttonId);
            
            if (element.classList.contains('line-clamp-1') || element.classList.contains('line-clamp-2')) {
                element.classList.remove('line-clamp-1', 'line-clamp-2');
                button.textContent = 'Show less';
            } else {
                if (elementId.startsWith('subject-')) {
                    element.classList.add('line-clamp-1');
                } else {
                    element.classList.add('line-clamp-2');
                }
                button.textContent = 'Show more';
            }
        }

        // VIEW TICKET & LOAD CHAT
        async function viewTicket(id) {
            activeTicketId = id;
            socket.emit('joinTicket', id);
            
            // MOBILE TOGGLE: Show main, hide sidebar
            const main = document.getElementById('mainDisplay');
            const sidebar = document.getElementById('sidebar');
            main.classList.remove('hidden');
            main.classList.add('flex');
            sidebar.classList.add('hidden', 'md:flex'); 

            renderTicketList(allTickets);

            const [ticketRes, msgRes, staffRes, assignedRes] = await Promise.all([
                fetch(`/api/tickets/${id}`),
                fetch(`/api/tickets/${id}/messages`),
                fetch(`/api/staff`),
                fetch(`/api/tickets/${id}/assignments`)
            ]);

            const ticket = await ticketRes.json();
            const messages = await msgRes.json();
            const allStaff = await staffRes.json();
            const assignedStaff = await assignedRes.json();

            main.innerHTML = `
                <div class="p-3 md:p-4 border-b flex justify-between items-center bg-white shadow-sm z-10">
                    <div class="flex items-center gap-3">
                        <div>
                            <h2 class="text-sm md:text-lg font-bold text-slate-800 truncate max-w-[150px] md:max-w-none">#${ticket.ticket_number}</h2>
                            <p class="text-[10px] md:text-xs text-gray-500">${ticket.status.toUpperCase()}</p>
                        </div>
                    </div>
                    <div class="flex gap-1 md:gap-2">
                        <button onclick="updateTicketStatus(${id}, 'resolved')" class="text-[10px] bg-green-100 p-2 rounded font-bold text-green-700">Resolve</button>
                        <button onclick="archiveTicket(${id})" class="text-xs bg-amber-100 hover:bg-amber-200 p-2 rounded font-semibold text-amber-700">Archive</button>
                        <button onclick="deleteTicket(${id})" class="text-[10px] bg-red-100 p-2 rounded font-bold text-red-700">Delete</button>
                    </div>
                </div>

                <div class="flex flex-1 overflow-hidden flex-col lg:flex-row">
                    <div class="flex-1 flex flex-col border-r chat-bg order-1 lg:order-none">
                        <div id="chatContainer" class="flex-1 overflow-y-auto p-4 chat-scroll flex flex-col gap-3">
                            ${messages.map(m => renderMessage(m)).join('')}
                        </div>
                        <div class="p-3 bg-white border-t flex gap-2">
                            <input type="text" id="msgInput" onkeypress="if(event.key==='Enter') sendChatMessage()" placeholder="Type..." class="flex-1 p-2 bg-gray-100 border-none rounded-full px-4 text-sm outline-none">
                            <button onclick="sendChatMessage()" class="bg-green-500 text-white p-2 rounded-full">
                                <i class="fas fa-paper-plane text-lg"></i>
                            </button>
                        </div>
                    </div>

                    <div class="hidden lg:block w-80 bg-slate-50 border-l overflow-y-auto p-4 flex flex-col gap-6">
                        <div class="space-y-4 pb-2">
                            <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider">Assign Staff</h3>
                            <div class="space-y-2">
                                <select id="staffSelect" class="w-full p-2 text-sm border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">-- Select Staff --</option>
                                    ${allStaff.map(s => `<option value="${s.id}">${s.first_name} ${s.second_name}</option>`).join('')}
                                </select>
                                <textarea id="assignNote" 
                                    rows="3" 
                                    placeholder="Describe the task for this staff member..." 
                                    class="w-full p-2 text-sm border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-teal-500 resize-y min-h-[80px]"></textarea>                                
                                <div class="flex items-center gap-2 p-2 bg-blue-50 rounded-lg border border-blue-100">
                                    <input type="checkbox" id="sendStaffSmsCheckbox" class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500 cursor-pointer">
                                    <label for="sendStaffSmsCheckbox" class="text-xs text-slate-700 cursor-pointer select-none">Send SMS notification to assigned staff</label>
                                </div>
                                
                                <button onclick="handleAssignment(${id})" class="w-full bg-teal-400 text-white py-2 rounded-lg text-sm font-bold hover:bg-teal-700 transition">
                                    Assign
                                </button>
                            </div>
                        </div>
                        <hr class="border-slate-200 pb-1">

                        <div class="space-y-4">
                            <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider">Currently Assigned</h3>
                            <div id="assignedList" class="flex flex-col gap-2">
                                ${assignedStaff.length === 0 
                                    ? '<p class="text-xs text-gray-400 italic">No staff assigned yet.</p>' 
                                    : assignedStaff.map(s => `
                                    <div class="bg-white p-3 border border-slate-200 group">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <p class="text-sm font-bold text-slate-700">${s.first_name} ${s.second_name || ''}</p>
                                                <p class="text-[10px] text-gray-500">${s.position || 'Staff'}</p>
                                            </div>
                                            <button onclick="revokeAssignment(${id}, ${s.staff_id})" class="text-[14px] text-gray-400 hover:text-red-500 transition">
                                                revoke
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            scrollChat();
        }

        async function loadCreateForm() {
            activeTicketId = null;
            renderTicketList(allTickets); 

            const main = document.getElementById('mainDisplay');
            const sidebar = document.getElementById('sidebar');
            main.classList.remove('hidden');
            main.classList.add('flex');

            main.innerHTML = `<div class="flex-1 flex items-center justify-center text-gray-400 italic">Fetching client list...</div>`;

            try {
                const res = await fetch('/api/manage/clients');
                const clients = await res.json();

                main.innerHTML = `
                    <div class="flex-1 bg-white flex flex-col items-center p-6 md:p-12 overflow-y-auto">
                        <div class="w-full max-w-lg">
                            <div class="flex justify-between items-center border-b pb-4 mb-8">
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-900">New Ticket</h2>
                                    <p class="text-gray-500 text-sm">Assign a client and describe the issue.</p>
                                </div>
                                <button onclick="closeCreateForm()" class="text-gray-400 hover:text-gray-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                </button>
                            </div>

                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">Search & Select Client</label>
                                    <input type="text" id="clientSearchInput" onkeyup="filterClientDropdown()" placeholder="Type client name or ID..." 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-t-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                    
                                    <select id="newUserId" size="2" class="w-full px-2 py-1 border-x border-b border-gray-300 rounded-b-lg bg-white outline-none cursor-pointer overflow-y-auto">
                                        ${clients.map(c => `
                                            <option class="p-2 border-b border-gray-50 last:border-none hover:bg-blue-50" value="${c.id}">
                                                ${c.first_name} ${c.second_name} (${c.phone || c.email})
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">Subject</label>
                                    <input type="text" id="newSubject" placeholder="Summary of the issue" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                </div>

                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">Description</label>
                                    <textarea id="newDescription" rows="4" placeholder="Full details..." 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none resize-none"></textarea>
                                </div>

                                <div class="flex items-center gap-2 p-3 bg-green-50 rounded-lg border border-green-100">
                                    <input type="checkbox" id="sendClientSmsCheckbox" checked class="w-4 h-4 text-green-600 rounded focus:ring-2 focus:ring-green-500 cursor-pointer">
                                    <label for="sendClientSmsCheckbox" class="text-xs text-slate-700 cursor-pointer select-none">Send SMS notification to client about support ticket</label>
                                </div>

                                <div class="flex items-center gap-4 pt-2">
                                    <button onclick="saveNewTicket()" 
                                        class="flex-1 bg-slate-800 text-white py-2.5 rounded-lg font-bold hover:bg-slate-900 transition-colors">
                                        Create Ticket
                                    </button>
                                    <button onclick="closeCreateForm()" 
                                        class="px-6 py-2.5 text-gray-600 font-semibold hover:text-gray-900">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                console.error("Client fetch error:", err);
                main.innerHTML = `<div class="p-10 text-red-500 text-center">Failed to load clients. <br> <button onclick="loadCreateForm()" class="underline">Try Again</button></div>`;
            }
        }

        function renderMessage(m) {
            // Simple check: if sender_staff_id matches current user ID
            const isMe = m.sender_staff_id === currentUserId;
            const senderName = isMe ? 'You' : (m.staff_name || m.user_name || 'Unknown');
            
            return `
                <div class="${isMe ? 'self-end' : 'self-start'} max-w-[80%]">
                    <span class="text-[10px] text-gray-600 ${isMe ? 'mr-2 text-right block' : 'ml-2'}">
                        ${senderName}
                    </span>
                    <div class="${isMe ? 'bubble-out' : 'bubble-in'} p-3 text-sm text-gray-800">
                        ${m.message}
                        <span class="block text-[9px] ${isMe ? 'text-blue-200' : 'text-gray-400'} text-right mt-1">
                            ${new Date(m.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                        </span>
                    </div>
                </div>
            `;
        }

        async function sendChatMessage() {
            const input = document.getElementById('msgInput');
            if (!input.value.trim()) {
                showToast("Please enter a message", 'info');
                return;
            }

            const msgText = input.value;
            input.value = '';
            input.disabled = true;

            try {
                const res = await fetch('/api/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ticket_id: activeTicketId,
                        staff_id: currentUserId, // ADD THIS LINE
                        message: msgText
                    })
                });

                const data = await res.json();

                if (res.status === 401) {
                    showToast(data.message || "Unauthorized", 'error');
                    window.location.href = data.redirectUrl;
                    return;
                }

                if (!res.ok) {
                    showToast("Failed to send message", 'error');
                    input.value = msgText;
                }
            } catch (err) {
                console.error("Send message error:", err);
                showToast("Error sending message", 'error');
                input.value = msgText;
            } finally {
                input.disabled = false;
                input.focus();
            }
        }

        // Socket listener for new messages
        socket.on('newMessage', (msg) => {
            if (msg.ticket_id === activeTicketId) {
                const container = document.getElementById('chatContainer');
                const isMe = msg.sender_staff_id === currentUserId;
                const senderName = isMe ? 'You' : (msg.staff_name || msg.user_name || 'Unknown');
                
                const messageHtml = `
                    <div class="${isMe ? 'self-end' : 'self-start'} max-w-[80%] animate-fade-in">
                        <span class="text-[10px] text-gray-600 ${isMe ? 'mr-2 text-right block' : 'ml-2'}">
                            ${senderName}
                        </span>
                        <div class="${isMe ? 'bubble-out' : 'bubble-in'} p-3 text-sm text-gray-800">
                            ${msg.message}
                            <span class="block text-[9px] ${isMe ? 'text-blue-200' : 'text-gray-400'} text-right mt-1">
                                ${new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                            </span>
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', messageHtml);
                scrollChat();
                
                // Send notification if it's not from current user
                if (Notification.permission === "granted" && !isMe) {
                    if (document.hidden || msg.ticket_id != activeTicketId) {
                        const title = `New Message: Ticket #${msg.ticket_number || msg.ticket_id}`;
                        const options = {
                            body: `${senderName}: ${msg.message}`,
                            icon: '/static/images/logo_image.jpg', 
                            tag: `ticket-${msg.ticket_id}`,
                            renotify: true
                        };

                        const notification = new Notification(title, options);
                        notification.onclick = function() {
                            window.focus();
                            viewTicket(msg.ticket_id);
                            notification.close();
                        };
                    }
                }
            }
        });

        // 4. ASSIGNMENT & CRUD LOGIC
        async function handleAssignment(ticketId) {
            const staffId = document.getElementById('staffSelect').value;
            const note = document.getElementById('assignNote').value;
            const sendSms = document.getElementById('sendStaffSmsCheckbox').checked;
            const btn = event.target;

            if (!staffId) return alert("Please select a staff member first.");

            setButtonLoading(btn, true);

            try {
                const res = await fetch('/api/tickets/assign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        ticket_id: ticketId, 
                        staff_id: staffId, 
                        note: note,
                        send_sms: sendSms
                    })
                });

                const result = await res.json();
                if (result.success) {
                    showToast("Staff assigned successfully!", 'success');
                    viewTicket(ticketId);
                } else {
                    showToast(result.error || "Assignment failed", 'error');
                    alert("Assignment failed: " + (result.error || "Unknown error"));
                }
            } catch (err) {
                showToast("Failed to assign staff. Please try again.", 'error');
                console.error("Assignment error:", err);
            } finally {
                setButtonLoading(btn, false);
            }
        }

        async function saveNewTicket() {
            const subject = document.getElementById('newSubject').value;
            const userId = document.getElementById('newUserId').value;
            const description = document.getElementById('newDescription').value;
             const sendSms = document.getElementById('sendClientSmsCheckbox').checked;
             const btn = event.target;

            if (!subject || !userId) return alert("Please fill in Subject and User ID");

            setButtonLoading(btn, true);

            try {
                const response = await fetch('/api/tickets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        issue_subject: subject,
                        description: description,
                        send_sms: sendSms
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showToast("Ticket created successfully!", 'success');
                    await loadTickets(); // Reload sidebar
                    viewTicket(result.ticketId); // Open the new ticket
                } else {
                    showToast(result.error || "Failed to create ticket", 'error');
                }
            } catch (err) {
                console.error("Failed to save ticket:", err);
                showToast("Error creating ticket. Please try again.", 'error');
            } finally {
                setButtonLoading(btn, false);
            }
        }

        async function deleteTicket(id) {
            if (!confirm("Delete this ticket permanently?")) return;
            
            const btn = event.target;
            setButtonLoading(btn, true);

            try {
                const res = await fetch(`/api/tickets/${id}`, { method: 'DELETE' });
                const result = await res.json();
                
                if (result.success || res.ok) {
                    showToast("Ticket deleted successfully!", 'success');
                    await loadTickets();

                    const main = document.getElementById('mainDisplay');
                    main.innerHTML = `
                        <div class="flex items-center justify-center h-full text-gray-400 flex-col p-6 text-center">
                            <svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4v-3a2 2 0 00-2-2H5z"></path></svg>
                            <p>Ticket deleted successfully</p>
                            <p class="text-sm mt-2">Select another ticket to view</p>
                        </div>
                    `;
                    activeTicketId = null;
                    
                } else {
                    showToast("Failed to delete ticket", 'error');
                }
            } catch (err) {
                console.error("Delete error:", err);
                showToast("Error deleting ticket", 'error');
            } finally {
                setButtonLoading(btn, false);
            }
        }

        async function updateTicketStatus(id, newStatus) {
            const btn = event.target;
            setButtonLoading(btn, true);

            try {
                const response = await fetch(`/api/tickets/${id}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast(`Ticket marked as ${newStatus}!`, 'success');
                    await loadTickets(); 
                    viewTicket(id);
                } else {
                    showToast("Failed to update status", 'error');
                }
            } catch (err) {
                console.error("Failed to update status:", err);
                showToast("Error updating ticket status", 'error');
            } finally {
                 setButtonLoading(btn, false);
            }
        }

        async function archiveTicket(id) {
            if (!confirm("Are you sure you want to archive this ticket? It will be hidden from the main list.")) return;

            const btn = event.target;
            setButtonLoading(btn, true);
    
            try {
                const response = await fetch(`/api/tickets/${id}/archive`, {
                    method: 'PATCH'
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast("Ticket archived successfully!", 'success');
                    await loadTickets();
                    document.getElementById('mainDisplay').innerHTML = `
                        <div class="flex items-center justify-center h-full text-gray-400 flex-col">
                            <p>Ticket Archived Successfully</p>
                        </div>`;
                } else {
                    showToast("Failed to archive ticket", 'error');
                }
            } catch (err) {
                console.error("Archive failed:", err);
                showToast("Error archiving ticket", 'error');
            } finally {
                setButtonLoading(btn, false);
            }
        }

        async function revokeAssignment(ticketId, staffId) {
            if (!confirm("Are you sure you want to remove this staff member from this ticket?")) return;

            const btn = event.target;
            setButtonLoading(btn, true);


            try {
                const res = await fetch(`/api/tickets/${ticketId}/assign/${staffId}`, {
                    method: 'DELETE'
                });

                const result = await res.json();
                if (result.success) {
                    showToast("Staff assignment revoked!", 'success');
                    viewTicket(ticketId); // Refresh UI
                } else {
                    showToast("Failed to revoke assignment", 'error');
                }
            } catch (err) {
                console.error("Revoke failed:", err);
                showToast("Error revoking assignment", 'error');
            } finally {
                setButtonLoading(btn, false);
            }
        }

        // HELPERS
        function scrollChat() {
            const container = document.getElementById('chatContainer');
            if(container) container.scrollTop = container.scrollHeight;
        }

        function filterTickets() {
            const query = document.getElementById('ticketSearch').value.toLowerCase();
            const filtered = allTickets.filter(t => t.ticket_number.toLowerCase().includes(query) || t.issue_subject.toLowerCase().includes(query));
            renderTicketList(filtered);
        }

        async function viewArchivedTickets() {
            activeTicketId = null;
            const main = document.getElementById('mainDisplay');
            const sidebar = document.getElementById('sidebar');

            main.classList.remove('hidden');
            main.classList.add('flex');
            sidebar.classList.add('hidden', 'md:flex');

            main.innerHTML = `<div class="p-10 text-center text-gray-400 italic">Loading archives...</div>`;

            try {
                const res = await fetch('/api/tickets/archived');
                const data = await res.json();
                const archived = Array.isArray(data) ? data : [];

                if (!Array.isArray(data) && data.error) {
                    console.error("Server returned error:", data.error);
                }

                main.innerHTML = `
                    <div class="p-4 md:p-8 flex flex-col h-full bg-white overflow-hidden">
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex items-center gap-3">
                                <h2 class="text-2xl font-bold text-slate-800">Archive Vault</h2>
                            </div>
                            <button onclick="location.reload()" class="text-sm bg-slate-100 px-4 py-2 rounded-lg font-bold hover:bg-slate-200">Back to Active</button>
                        </div>

                        <div class="flex-1 overflow-y-auto border rounded-xl">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-slate-50 sticky top-0 border-b">
                                    <tr>
                                        <th class="p-4 text-xs font-bold text-gray-500 uppercase">Ticket</th>
                                        <th class="p-4 text-xs font-bold text-gray-500 uppercase">Client</th>
                                        <th class="p-4 text-xs font-bold text-gray-500 uppercase">Subject</th>
                                        <th class="p-4 text-xs font-bold text-gray-500 uppercase text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${archived.length === 0 
                                        ? '<tr><td colspan="4" class="p-10 text-center text-gray-400">No archived tickets found.</td></tr>' 
                                        : archived.map(t => `
                                            <tr class="border-b hover:bg-slate-50 transition">
                                                <td class="p-4 text-sm font-bold text-blue-600">#${t.ticket_number}</td>
                                                <td class="p-4 text-sm text-gray-600">${t.first_name} ${t.second_name}</td>
                                                <td class="p-4 text-sm text-gray-800 truncate max-w-[200px]">${t.issue_subject}</td>
                                                <td class="p-4 text-right">
                                                    <button onclick="restoreTicket(${t.id})" class="bg-green-100 text-green-700 px-3 py-1 rounded-md text-xs font-bold hover:bg-green-200 transition">
                                                        RESTORE
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } catch (err) {
                console.error("Archive fetch error:", err);
                main.innerHTML = `<div class="p-10 text-center text-red-500 font-bold">Failed to load archives. Check server console.</div>`;
            }
        }

        async function restoreTicket(id) {
            if (!confirm("Move this ticket back to the active list?")) return;

            const btn = event.target;
            setButtonLoading(btn, true);

            try {
                const response = await fetch(`/api/tickets/${id}/restore`, { method: 'PATCH' });
                const result = await response.json();
                if (result.success) {
                    showToast("Ticket restored successfully!", 'success');
                    viewArchivedTickets(); // Refresh archive list
                    loadTickets(); // Refresh the sidebar list
                } else {
                    showToast("Failed to restore ticket", 'error');
                }
            } catch (err) {
                console.error("Restore failed:", err);
                showToast("Error restoring ticket", 'error');
            } finally {
                setButtonLoading(btn, false);
            }
        }

        function filterClientDropdown() {
            const input = document.getElementById('clientSearchInput');
            const filter = input.value.toLowerCase();
            const select = document.getElementById('newUserId');
            const options = select.options;

            for (let i = 0; i < options.length; i++) {
                const text = options[i].text.toLowerCase();
                options[i].style.display = text.includes(filter) ? "" : "none";
            }
        }

        function closeCreateForm() {
            const main = document.getElementById('mainDisplay');
            main.innerHTML = `
                <div class="flex items-center justify-center h-full text-gray-400 flex-col p-6 text-center">
                    <svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4v-3a2 2 0 00-2-2H5z"></path></svg>
                    <p>Select a ticket to view conversation</p>
                </div>
            `;            
        }

        function showToast(msg, type = 'error') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-rose-600' : 'bg-emerald-600';
            const title = type === 'error' ? 'Error' : 'Success';
            toast.className = `${bgColor} text-white p-4 rounded-2xl shadow-2xl min-w-[280px] animate-fade-in flex flex-col`;
            toast.innerHTML = `
                <span class="text-[10px] font-black uppercase tracking-widest opacity-70">${title}</span>
                <span class="text-sm font-bold">${msg}</span>
            `;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 500);
            }, 4000);
        }

        function setButtonLoading(button, isLoading, originalText = '') {
            if (isLoading) {
                button.dataset.originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = `<span class="spinner"></span>`;
            } else {
                button.disabled = false;
                button.innerHTML = button.dataset.originalText || originalText;
            }
        }
    </script>