<!DOCTYPE html>
<html lang="en" class="bg-gray-100">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Dr.Net Admin Portal - Finance and Reports</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Simple and reliable jsPDF loading -->
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script>
      // Simple PDF creation function that doesn't rely on external library
      window.createReceiptPDF = function(receipt) {
        // Fallback to HTML-to-Canvas approach if jsPDF fails
        const receiptHTML = `
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <style>
              body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
              .header { background: #1e293b; color: white; padding: 20px; text-align: center; }
              .company-name { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
              .subtitle { font-size: 14px; }
              .receipt-title { font-size: 20px; font-weight: bold; margin: 20px 0; text-align: center; }
              .details-box { border: 1px solid #ccc; padding: 15px; margin: 20px 0; }
              .row { display: flex; margin-bottom: 8px; }
              .label { font-weight: bold; width: 150px; }
              .value { flex: 1; }
              .amount-section { background: #22c55e; color: white; padding: 20px; text-align: center; margin: 20px 0; }
              .amount-text { font-size: 16px; margin-bottom: 10px; }
              .amount-value { font-size: 24px; font-weight: bold; }
              .notes { background: #fef3c7; padding: 15px; margin: 20px 0; border-left: 4px solid #f59e0b; }
              .footer { border-top: 1px solid #ccc; padding-top: 15px; margin-top: 30px; font-size: 12px; color: #666; }
            </style>
          </head>
          <body>
            <div class="header">
              <div class="company-name">DR.NET SERVICES</div>
              <div class="subtitle">Internet Service Provider</div>
            </div>
            
            <div class="receipt-title">PAYMENT RECEIPT</div>
            
            <div class="details-box">
              <div class="row">
                <div class="label">Receipt Number:</div>
                <div class="value">${receipt.receiptNumber || receipt.id.substr(-4)}</div>
              </div>
              <div class="row">
                <div class="label">Date:</div>
                <div class="value">${new Date(receipt.date).toLocaleDateString()}</div>
              </div>
              <div class="row">
                <div class="label">Time:</div>
                <div class="value">${new Date(receipt.timestamp).toLocaleTimeString()}</div>
              </div>
            </div>
            
            <h3>CLIENT INFORMATION</h3>
            <div class="details-box">
              <div class="row">
                <div class="label">Client Name:</div>
                <div class="value">${receipt.client}</div>
              </div>
              <div class="row">
                <div class="label">Payment Method:</div>
                <div class="value">${receipt.paymentMethod}</div>
              </div>
              <div class="row">
                <div class="label">Transaction Ref:</div>
                <div class="value">${receipt.reference || 'N/A'}</div>
              </div>
              <div class="row">
                <div class="label">Service Period:</div>
                <div class="value">${receipt.servicePeriod || 'N/A'}</div>
              </div>
            </div>
            
            <div class="amount-section">
              <div class="amount-text">AMOUNT PAID</div>
              <div class="amount-value">KES ${receipt.amount.toFixed(2)}</div>
            </div>
            
            ${receipt.notes && receipt.notes.trim() ? `
              <div class="notes">
                <strong>Notes:</strong><br>
                ${receipt.notes}
              </div>
            ` : ''}
            
            <div class="footer">
              <div>Thank you for your payment!</div>
              <div>Dr.Net Services - Your Trusted Internet Provider</div>
              <div>Generated on: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}</div>
            </div>
          </body>
          </html>
        `;
        
        // Open in new window for printing
        const printWindow = window.open('', '_blank');
        printWindow.document.write(receiptHTML);
        printWindow.document.close();
        
        // Auto-print after content loads
        printWindow.onload = function() {
          printWindow.print();
          setTimeout(() => {
            printWindow.close();
          }, 1000);
        };
      };
      
      // Check jsPDF availability after page load
      window.addEventListener('load', function() {
        setTimeout(() => {
          if (typeof jsPDF !== 'undefined') {
            window.jsPDF = jsPDF;
            console.log('‚úÖ jsPDF loaded successfully');
          } else {
            console.log('‚ö†Ô∏è jsPDF not available, using HTML print fallback');
          }
        }, 1000);
      });
    </script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="css/ctio-gradients.css" />

    <style>
      /* Professional CTIO Design System */
      .ctio-professional {
        background: #1e293b;
      }

      /* Hide sections by default */
      .hidden {
        display: none !important;
      }
      
      /* Show sections when active */
      .section-visible {
        display: block !important;
      }
      
      /* Force section visibility */
      .section-active {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      
      /* Force section hiding */
      .section-hidden {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
      }
      
      /* Modal fixes */
      .modal-backdrop {
        z-index: 9998 !important;
        background-color: rgba(0, 0, 0, 0.5) !important;
      }
      
      .modal-content {
        z-index: 9999 !important;
        background-color: white !important;
        position: relative !important;
      }
      
      /* Ensure modals are above everything */
      [id$="Modal"] {
        z-index: 9999 !important;
      }
      
      [id$="Modal"] > div {
        z-index: 10000 !important;
        background-color: white !important;
      }

      /* Sidebar Styles */
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 280px;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        z-index: 60;
        backdrop-filter: blur(20px);
      }

      .sidebar.show {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
        transition: margin-left 0.3s ease-in-out;
      }
      
      /* Fix main layout and scrolling issues */
      main.flex-1 {
        min-height: 100vh;
        padding-bottom: 200px !important; /* Add bottom padding to prevent footer overlap */
        box-sizing: border-box;
      }
      
      /* Ensure sections have proper spacing */
      .space-y-8 > * + * {
        margin-top: 2rem !important;
      }
      
      /* Fix container heights */
      body {
        min-height: 100vh;
        overflow-x: hidden;
      }

      /* Desktop styles */
      @media (min-width: 1024px) {
        .sidebar {
          transform: translateX(0);
          position: fixed;
        }

        .main-content {
          margin-left: 280px;
        }

        .mobile-toggle {
          display: none !important;
        }
      }

      /* Mobile responsive */
      @media (max-width: 1023px) {
        .main-content {
          margin-left: 0 !important;
        }

        .sidebar {
          z-index: 60;
        }
      }

      /* Hover effects */
      .nav-item:hover {
        transform: translateX(8px);
        background: rgba(255, 255, 255, 0.15);
      }
      
      /* Additional scrolling and layout fixes */
      #reports-finance {
        position: relative;
        z-index: 1;
        margin-bottom: 100px !important;
      }
      
      /* Ensure sections are properly spaced and visible */
      .hidden.section-active,
      .section-visible {
        display: block !important;
        position: relative;
        z-index: 2;
      }
      
      /* Fix any potential overlay issues */
      .bg-white\/80 {
        position: relative;
        z-index: 3;
      }
      
      /* Smooth scrolling */
      html {
        scroll-behavior: smooth;
      }
      
      /* Prevent content from being hidden behind any fixed elements */
      .space-y-8 {
        padding-bottom: 50px;
      }
      
      /* Modal Animation */
      #receiptViewModal {
        backdrop-filter: blur(8px);
        animation: fadeIn 0.3s ease-out;
      }
      
      #receiptViewModal .bg-white {
        animation: slideUp 0.4s ease-out;
        transform: translateY(0);
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      @keyframes slideUp {
        from { 
          opacity: 0;
          transform: translateY(20px) scale(0.95);
        }
        to { 
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-slate-100 via-blue-50 to-indigo-100 min-h-screen"
  >
    <!-- Mobile backdrop -->
    <div
      id="sidebarBackdrop"
      class="fixed inset-0 bg-black bg-opacity-60 z-40 lg:hidden hidden transition-opacity duration-300"
    ></div>

    <!-- Modern Sidebar -->
    <aside
      id="sidebar"
      class="sidebar ctio-professional shadow-2xl flex flex-col text-white"
    >
      <!-- Sidebar Header -->
      <div class="p-6 border-b border-white/20">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div
              class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-lg"
            >
              <i class="fas fa-network-wired text-xl text-white"></i>
            </div>
            <div>
              <h2 class="text-xl font-bold">DR.NET CTIO</h2>
              <p class="text-white/80 text-sm">Julius Ojwang - CTO</p>
            </div>
          </div>
          <button
            id="closeSidebar"
            class="mobile-toggle text-white/80 hover:text-white p-2 rounded-lg hover:bg-white/10 transition-all duration-200"
          >
            <i class="fas fa-times text-lg"></i>
          </button>
        </div>
      </div>

      <!-- Navigation -->
      <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
        <a
          href="dashboard.html"
          class="nav-item group flex items-center px-4 py-3 rounded-xl transition-all duration-300 hover:bg-white/15 text-white/90 hover:text-white"
        >
          <div
            class="w-10 h-10 bg-white/10 rounded-lg flex items-center justify-center mr-4 group-hover:bg-white/20 transition-all duration-300"
          >
            <i class="fas fa-chart-pie text-lg"></i>
          </div>
          <span class="font-medium">Dashboard</span>
        </a>

        <a
          href="register-user.html"
          class="nav-item group flex items-center px-4 py-3 rounded-xl transition-all duration-300 hover:bg-white/15 text-white/90 hover:text-white"
        >
          <div
            class="w-10 h-10 bg-white/10 rounded-lg flex items-center justify-center mr-4 group-hover:bg-white/20 transition-all duration-300"
          >
            <i class="fas fa-user-plus text-lg"></i>
          </div>
          <span class="font-medium">Register User</span>
        </a>

        <a
          href="manage-users.html"
          class="nav-item group flex items-center px-4 py-3 rounded-xl transition-all duration-300 hover:bg-white/15 text-white/90 hover:text-white"
        >
          <div
            class="w-10 h-10 bg-white/10 rounded-lg flex items-center justify-center mr-4 group-hover:bg-white/20 transition-all duration-300"
          >
            <i class="fas fa-users text-lg"></i>
          </div>
          <span class="font-medium">Manage Users</span>
        </a>

        <a
          href="deleted-users.html"
          class="nav-item group flex items-center px-4 py-3 rounded-xl transition-all duration-300 hover:bg-white/15 text-white/90 hover:text-white"
        >
          <div
            class="w-10 h-10 bg-white/10 rounded-lg flex items-center justify-center mr-4 group-hover:bg-white/20 transition-all duration-300"
          >
            <i class="fas fa-trash text-lg"></i>
          </div>
          <span class="font-medium">Deleted Users</span>
        </a>

        <a
          href="service-assignments.html"
          class="nav-item group flex items-center px-4 py-3 rounded-xl transition-all duration-300 hover:bg-white/15 text-white/90 hover:text-white"
        >
          <div
            class="w-10 h-10 bg-white/10 rounded-lg flex items-center justify-center mr-4 group-hover:bg-white/20 transition-all duration-300"
          >
            <i class="fas fa-tools text-lg"></i>
          </div>
          <span class="font-medium">Service Assignments</span>
        </a>

        <a
          href="support-tickets.html"
          class="nav-item group flex items-center px-4 py-3 rounded-xl transition-all duration-300 hover:bg-white/15 text-white/90 hover:text-white"
        >
          <div
            class="w-10 h-10 bg-white/10 rounded-lg flex items-center justify-center mr-4 group-hover:bg-white/20 transition-all duration-300"
          >
            <i class="fas fa-ticket-alt text-lg"></i>
          </div>
          <span class="font-medium">Support Tickets</span>
        </a>

        <a
          href="renewals.html"
          class="nav-item group flex items-center px-4 py-3 rounded-xl transition-all duration-300 hover:bg-white/15 text-white/90 hover:text-white"
        >
          <div
            class="w-10 h-10 bg-white/10 rounded-lg flex items-center justify-center mr-4 group-hover:bg-white/20 transition-all duration-300"
          >
            <i class="fas fa-sync-alt text-lg"></i>
          </div>
          <span class="font-medium">Renewals</span>
        </a>

        <a
          href="invoice-generator.html"
          class="nav-item group flex items-center px-4 py-3 rounded-xl bg-white/20 text-white transition-all duration-300"
        >
          <div
            class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center mr-4 transition-all duration-300"
          >
            <i class="fas fa-file-invoice-dollar text-lg"></i>
          </div>
          <span class="font-medium">Finance and Reports</span>
        </a>

        <a
          href="website-bookings.html"
          class="nav-item group flex items-center px-4 py-3 rounded-xl transition-all duration-300 hover:bg-white/15 text-white/90 hover:text-white"
        >
          <div
            class="w-10 h-10 bg-white/10 rounded-lg flex items-center justify-center mr-4 group-hover:bg-white/20 transition-all duration-300"
          >
            <i class="fas fa-globe text-lg"></i>
          </div>
          <span class="font-medium">Website Bookings</span>
        </a>

        <a
          href="team-communication.html"
          class="nav-item group flex items-center px-4 py-3 rounded-xl transition-all duration-300 hover:bg-white/15 text-white/90 hover:text-white"
        >
          <div
            class="w-10 h-10 bg-white/10 rounded-lg flex items-center justify-center mr-4 group-hover:bg-white/20 transition-all duration-300"
          >
            <i class="fas fa-comments text-lg"></i>
          </div>
          <span class="font-medium">Team Communication</span>
        </a>

        <a
          href="settings.html"
          class="nav-item group flex items-center px-4 py-3 rounded-xl transition-all duration-300 hover:bg-white/15 text-white/90 hover:text-white"
        >
          <div
            class="w-10 h-10 bg-white/10 rounded-lg flex items-center justify-center mr-4 group-hover:bg-white/20 transition-all duration-300"
          >
            <i class="fas fa-cog text-lg"></i>
          </div>
          <span class="font-medium">Settings</span>
        </a>
      </nav>
    </aside>

    <!-- Mobile Menu Toggle Button -->
    <button
      id="toggleSidebar"
      class="lg:hidden fixed top-4 left-4 z-50 text-gray-800 bg-white p-2 rounded-full shadow-md"
    >
      <svg
        class="w-6 h-6"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M4 6h16M4 12h16M4 18h16"
        ></path>
      </svg>
    </button>

    <!-- Main Content -->
    <main class="flex-1 p-6 overflow-y-auto lg:ml-72 min-h-screen pb-32">
      <!-- Tab Navigation -->
      <div class="mt-6 mb-8">
        <div class="flex space-x-1 bg-gray-200 p-1 rounded-lg w-fit">
          <button
            id="invoicesTab"
            class="tab-button px-6 py-3 rounded-md font-medium transition-all duration-200 bg-gradient-to-r from-indigo-600 to-purple-600 text-white"
            onclick="showTab('invoices')"
          >
            üßæ Client Invoices
          </button>
          <button
            id="receiptsTab"
            class="tab-button px-6 py-3 rounded-md font-medium transition-all duration-200 bg-white/80 text-gray-700"
            onclick="showTab('receipts')"
          >
            üßæ Payment Receipts
          </button>
          <button
            id="payslipsTab"
            class="tab-button px-6 py-3 rounded-md font-medium transition-all duration-200 bg-white/80 text-gray-700"
            onclick="showTab('payslips')"
          >
            üí∞ Staff Payslips
          </button>
          <button
            id="expensesTab"
            class="tab-button px-6 py-3 rounded-md font-medium transition-all duration-200 bg-white/80 text-gray-700"
            onclick="showTab('expenses')"
          >
            üí∏ Expenses
          </button>
          <button
            id="salesTab"
            class="tab-button px-6 py-3 rounded-md font-medium transition-all duration-200 bg-white/80 text-gray-700"
            onclick="showTab('sales')"
          >
            üíµ Sales
          </button>
          <button
            id="equipmentTab"
            class="tab-button px-6 py-3 rounded-md font-medium transition-all duration-200 bg-white/80 text-gray-700"
            onclick="showTab('equipment')"
          >
            üß∞ Equipment & Tools
          </button>
          <button
            id="dailyReportsTab"
            class="tab-button px-6 py-3 rounded-md font-medium transition-all duration-200 bg-white/80 text-gray-700"
            onclick="showTab('dailyReports')"
          >
            üìã Reports
          </button>
          <button
            id="analyticsTab"
            class="tab-button px-6 py-3 rounded-md font-medium transition-all duration-200 bg-white/80 text-gray-700"
            onclick="showTab('analytics')"
          >
            üìä Analytics
          </button>
        </div>
      </div>

      <section id="reports-finance" class="space-y-8 pb-20">
        <h3
          class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent mb-8"
        >
          üí∞ Finance and Reports
        </h3>
        <!-- Client Invoices Section -->
        <div id="invoicesSection" class="hidden space-y-8">
          <!-- Invoice Generation -->
          <div class="bg-white/80 backdrop-blur-sm p-8 rounded-2xl shadow-lg">
            <h4 class="text-xl font-semibold text-gray-800 mb-6">
              Generate Client Invoice
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Select Client</label
                >
                <select
                  id="invoiceUser"
                  class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100"
                  onchange="loadClients()"
                >
                  <option value="">Choose a client...</option>
                </select>
              </div>
              <div class="flex items-end">
                <button
                  onclick="addInvoiceItem()"
                  class="w-full bg-gradient-to-r from-green-600 to-teal-600 text-white py-4 rounded-xl font-semibold hover:from-green-700 hover:to-teal-700 transition-all duration-300 transform hover:-translate-y-1"
                >
                  <span class="mr-2">‚ûï</span> Add Item
                </button>
              </div>
              <div class="flex items-end">
                <button
                  onclick="generateInvoice()"
                  class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-xl font-semibold hover:from-indigo-700 hover:to-purple-700 transition-all duration-300 transform hover:-translate-y-1"
                >
                  <span class="mr-2">üßæ</span> Generate Invoice PDF
                </button>
              </div>
            </div>
            <div
              id="invoicePreview"
              class="hidden mt-6 p-6 bg-gray-50 rounded-xl"
            ></div>
          </div>

          <!-- SMS Templates -->
          <div class="bg-white/80 backdrop-blur-sm p-8 rounded-2xl shadow-lg">
            <h4 class="text-xl font-semibold text-gray-800 mb-6">
              Client Communication Templates
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <button
                onclick="generateSMSTemplate('invoice')"
                class="p-6 bg-blue-50 rounded-xl border-2 border-blue-200 hover:border-blue-400 transition-all duration-200 transform hover:-translate-y-1"
              >
                <div class="text-3xl mb-2">üìß</div>
                <div class="font-semibold text-blue-800">Invoice SMS</div>
                <div class="text-sm text-blue-600">
                  Send invoice notification
                </div>
              </button>
              <button
                onclick="generateSMSTemplate('reminder')"
                class="p-6 bg-yellow-50 rounded-xl border-2 border-yellow-200 hover:border-yellow-400 transition-all duration-200 transform hover:-translate-y-1"
              >
                <div class="text-3xl mb-2">‚è∞</div>
                <div class="font-semibold text-yellow-800">Reminder SMS</div>
                <div class="text-sm text-yellow-600">Send payment reminder</div>
              </button>
              <button
                onclick="generateSMSTemplate('confirmation')"
                class="p-6 bg-green-50 rounded-xl border-2 border-green-200 hover:border-green-400 transition-all duration-200 transform hover:-translate-y-1"
              >
                <div class="text-3xl mb-2">‚úÖ</div>
                <div class="font-semibold text-green-800">
                  Payment Confirmation
                </div>
                <div class="text-sm text-green-600">
                  Confirm payment received
                </div>
              </button>
            </div>
            <div
              id="smsPreview"
              class="hidden mt-6 p-6 bg-gray-50 rounded-xl"
            ></div>
          </div>
        </div>

        <!-- Staff Payslips Section -->
        <div id="payslipsSection" class="hidden space-y-8">
          <!-- Payslip Generation -->
          <div class="bg-white/80 backdrop-blur-sm p-8 rounded-2xl shadow-lg">
            <h4 class="text-xl font-semibold text-gray-800 mb-6">
              Generate Staff Payslip
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Select Staff Member</label
                >
                <select
                  id="payslipStaff"
                  onchange="checkPayslipFormCompletion()"
                  class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-green-500 focus:ring-4 focus:ring-green-100"
                >
                  <option value="">Choose a staff member...</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Pay Period</label
                >
                <select
                  id="payPeriod"
                  onchange="checkPayslipFormCompletion()"
                  class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-green-500 focus:ring-4 focus:ring-green-100"
                >
                  <option value="">Select pay period...</option>
                  <!-- Options will be populated dynamically by JavaScript -->
                </select>
              </div>
              <div class="flex items-end gap-3">
                <button
                  onclick="generatePayslip()"
                  class="flex-1 bg-gradient-to-r from-green-600 to-blue-600 text-white py-4 rounded-xl font-semibold hover:from-green-700 hover:to-blue-700 transition-all duration-300 transform hover:-translate-y-1"
                >
                  <span class="mr-2">üí∞</span> Generate Payslip PDF
                </button>
                <button
                  id="payslipActionButton"
                  onclick="handlePayslipAction()"
                  class="flex-1 bg-gradient-to-r from-gray-400 to-gray-500 text-white py-4 rounded-xl font-semibold transition-all duration-300 transform hover:-translate-y-1 cursor-not-allowed"
                  disabled
                >
                  <span class="mr-2">‚úÖ</span> Activate Payslip
                </button>
              </div>
            </div>


            <div
              id="payslipPreview"
              class="hidden mt-6 p-6 bg-gray-50 rounded-xl"
            ></div>
            <div
              id="payslipSmsPreview"
              class="hidden mt-6 p-6 bg-blue-50 rounded-xl border-2 border-blue-200"
            >
              <div class="flex justify-between items-center mb-4">
                <h5 class="text-lg font-semibold text-blue-800">
                  üì± Payslip SMS Message
                </h5>
                <button
                  onclick="copyPayslipSMS()"
                  class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200 flex items-center gap-2"
                >
                  <span>üìã</span> Copy to Clipboard
                </button>
              </div>
              <div class="bg-white p-4 rounded-lg border border-blue-300">
                <div class="text-sm text-gray-600 mb-2">SMS Content:</div>
                <div
                  id="payslipSmsContent"
                  class="font-mono text-sm text-gray-800 whitespace-pre-wrap"
                ></div>
              </div>
              <div class="mt-4 text-sm text-blue-700">
                <p>
                  <strong>Recipient:</strong>
                  <span id="payslipSmsRecipient"></span>
                </p>
                <p>
                  <strong>Character Count:</strong>
                  <span id="payslipSmsCharCount">0</span> characters
                </p>
              </div>
            </div>
          </div>

          <!-- Bulk Payslip Generation -->
          <div class="bg-white/80 backdrop-blur-sm p-8 rounded-2xl shadow-lg">
            <h4 class="text-xl font-semibold text-gray-800 mb-6">
              Bulk Payslip Generation
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Department</label
                >
                <select
                  id="bulkDepartment"
                  class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-green-500 focus:ring-4 focus:ring-green-100"
                >
                  <option value="all">All Departments</option>
                  <option value="Technical">Technical</option>
                  <option value="Customer Service">Customer Service</option>
                  <option value="Sales">Sales</option>
                  <option value="Operations">Operations</option>
                  <option value="Administration">Administration</option>
                  <option value="Finance">Finance</option>
                  <option value="Marketing">Marketing</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Status</label
                >
                <select
                  id="bulkStatus"
                  class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-green-500 focus:ring-4 focus:ring-green-100"
                >
                  <option value="active">Active Only</option>
                  <option value="all">All Staff</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Month</label
                >
                <input
                  type="month"
                  id="bulkMonth"
                  class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-green-500 focus:ring-4 focus:ring-green-100"
                  value=""
                />
              </div>
              <div class="flex items-end gap-3">
                <button
                  onclick="generateBulkPayslips()"
                  class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-xl font-semibold hover:from-purple-700 hover:to-pink-700 transition-all duration-300 transform hover:-translate-y-1"
                >
                  <span class="mr-2">üì¶</span> Generate All PDFs
                </button>
                <button
                  onclick="generateBulkPayslipSMS()"
                  class="flex-1 bg-gradient-to-r from-orange-600 to-red-600 text-white py-4 rounded-xl font-semibold hover:from-orange-700 hover:to-red-700 transition-all duration-300 transform hover:-translate-y-1"
                >
                  <span class="mr-2">üì±</span> Generate All SMS
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Staff Attendance Section -->
        <div id="staffAttendanceSection" class="hidden space-y-8">
          <!-- Attendance Header -->
          <div class="bg-white/80 backdrop-blur-sm p-8 rounded-2xl shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
              <div>
                <h3 class="text-2xl font-bold bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent">
                  üë• Staff Attendance Records
                </h3>
                <p class="text-gray-600 mt-1">Real-time staff attendance tracking from all supervisors</p>
              </div>
              <div class="flex items-center space-x-4 mt-4 md:mt-0">
                <div class="text-center">
                  <div class="text-2xl font-bold text-green-600" id="totalStaffCount">8</div>
                  <div class="text-sm text-gray-500">Total Staff</div>
                </div>
                <div class="text-center">
                  <div class="text-2xl font-bold text-blue-600" id="attendanceRate">0%</div>
                  <div class="text-sm text-gray-500">Attendance Rate</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Attendance Statistics -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-xl text-white shadow-lg">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-green-100">Present Today</p>
                  <p class="text-3xl font-bold" id="totalPresent">0</p>
                </div>
                <div class="text-4xl opacity-80">
                  <i class="fas fa-user-check"></i>
                </div>
              </div>
            </div>

            <div class="bg-gradient-to-br from-red-500 to-red-600 p-6 rounded-xl text-white shadow-lg">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-red-100">Absent Today</p>
                  <p class="text-3xl font-bold" id="totalAbsent">0</p>
                </div>
                <div class="text-4xl opacity-80">
                  <i class="fas fa-user-times"></i>
                </div>
              </div>
            </div>

            <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 p-6 rounded-xl text-white shadow-lg">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-yellow-100">On Permission</p>
                  <p class="text-3xl font-bold" id="totalPermission">0</p>
                </div>
                <div class="text-4xl opacity-80">
                  <i class="fas fa-user-clock"></i>
                </div>
              </div>
            </div>

            <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-xl text-white shadow-lg">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-blue-100">On Off</p>
                  <p class="text-3xl font-bold" id="totalOff">0</p>
                </div>
                <div class="text-4xl opacity-80">
                  <i class="fas fa-calendar-times"></i>
                </div>
              </div>
            </div>
          </div>

          <!-- Attendance Filters and Actions -->
          <div class="bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-lg">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Search Staff</label>
                <input
                  type="text"
                  id="attendanceSearch"
                  placeholder="Search by name or ID..."
                  class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                  onkeyup="filterAttendance()"
                >
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status Filter</label>
                <select id="attendanceStatusFilter" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" onchange="filterAttendance()">
                  <option value="">All Status</option>
                  <option value="present">Present</option>
                  <option value="absent">Absent</option>
                  <option value="permission">On Permission</option>
                  <option value="off">On Off</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Date Filter</label>
                <input
                  type="date"
                  id="attendanceDateFilter"
                  class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                  onchange="filterAttendance()"
                >
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                <select id="attendanceDepartmentFilter" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" onchange="filterAttendance()">
                  <option value="">All Departments</option>
                  <option value="technical">Technical</option>
                  <option value="installation">Installation</option>
                  <option value="customer-service">Customer Service</option>
                  <option value="maintenance">Maintenance</option>
                </select>
              </div>
              <div class="flex items-end space-x-2">
                <button onclick="exportAttendance()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition duration-200 flex items-center justify-center text-sm">
                  <i class="fas fa-download mr-2"></i>
                  Export
                </button>
                <button onclick="refreshAttendance()" id="refreshAttendanceBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition duration-200 flex items-center justify-center text-sm">
                  <i class="fas fa-sync-alt mr-1"></i>
                </button>
              </div>
            </div>

            <!-- Attendance Table -->
            <div class="overflow-x-auto">
              <table class="w-full bg-white rounded-lg overflow-hidden shadow-sm">
                <thead class="bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Staff Details</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Arrival Time</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Recorded By</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                  </tr>
                </thead>
                <tbody id="attendanceTableBody" class="divide-y divide-gray-200">
                  <!-- Attendance records will be loaded here -->
                  <tr>
                    <td colspan="7" class="px-4 py-12 text-center text-gray-500">
                      <div class="flex flex-col items-center">
                        <i class="fas fa-users text-5xl text-gray-300 mb-4"></i>
                        <p class="text-xl font-medium text-gray-400">No attendance records</p>
                        <p class="text-sm text-gray-400">Attendance data will appear here when supervisors mark staff attendance</p>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Attendance Trends Chart -->
          <div class="bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-lg">
            <div class="flex items-center justify-between mb-6">
              <h4 class="text-lg font-semibold text-gray-900">üìà Attendance Trends (Last 7 Days)</h4>
              <div class="flex space-x-2">
                <button onclick="generateAttendanceReport()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium transition duration-200 text-sm">
                  <i class="fas fa-chart-line mr-2"></i>
                  Generate Report
                </button>
              </div>
            </div>
            
            <!-- Chart placeholder -->
            <div class="h-64 bg-gray-50 rounded-lg flex items-center justify-center border-2 border-dashed border-gray-300">
              <div class="text-center">
                <i class="fas fa-chart-bar text-4xl text-gray-400 mb-3"></i>
                <p class="text-gray-500">Attendance trend chart will display here</p>
                <p class="text-sm text-gray-400">Data visualization coming soon</p>
              </div>
            </div>
          </div>

          <!-- Department Breakdown -->
          <div class="bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-lg">
            <h4 class="text-lg font-semibold text-gray-900 mb-6">üè¢ Department Attendance Breakdown</h4>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-blue-900">Technical</p>
                    <p class="text-2xl font-bold text-blue-600" id="technicalAttendance">0/3</p>
                  </div>
                  <div class="text-blue-600">
                    <i class="fas fa-tools text-2xl"></i>
                  </div>
                </div>
              </div>

              <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-green-900">Installation</p>
                    <p class="text-2xl font-bold text-green-600" id="installationAttendance">0/1</p>
                  </div>
                  <div class="text-green-600">
                    <i class="fas fa-hammer text-2xl"></i>
                  </div>
                </div>
              </div>

              <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-purple-900">Customer Service</p>
                    <p class="text-2xl font-bold text-purple-600" id="customerServiceAttendance">0/3</p>
                  </div>
                  <div class="text-purple-600">
                    <i class="fas fa-headset text-2xl"></i>
                  </div>
                </div>
              </div>

              <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-orange-900">Maintenance</p>
                    <p class="text-2xl font-bold text-orange-600" id="maintenanceAttendance">0/1</p>
                  </div>
                  <div class="text-orange-600">
                    <i class="fas fa-wrench text-2xl"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Analytics Reports Section -->
        <div id="analyticsSection" class="hidden space-y-8">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Financial Reports -->
            <div class="bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-lg">
              <h5 class="text-lg font-semibold text-gray-800 mb-4">
                üíπ Financial Reports
              </h5>
              <div class="space-y-3">
                <button
                  onclick="generateReport('revenue')"
                  class="w-full p-3 bg-blue-50 rounded-lg border border-blue-200 hover:bg-blue-100 transition text-left"
                >
                  <div class="font-medium text-blue-800">Revenue Report</div>
                  <div class="text-sm text-blue-600">
                    Monthly/yearly revenue analysis
                  </div>
                </button>
                <button
                  onclick="generateReport('outstanding')"
                  class="w-full p-3 bg-red-50 rounded-lg border border-red-200 hover:bg-red-100 transition text-left"
                >
                  <div class="font-medium text-red-800">
                    Outstanding Payments
                  </div>
                  <div class="text-sm text-red-600">
                    Unpaid invoices and overdue
                  </div>
                </button>
                <button
                  onclick="generateReport('payroll')"
                  class="w-full p-3 bg-green-50 rounded-lg border border-green-200 hover:bg-green-100 transition text-left"
                >
                  <div class="font-medium text-green-800">Payroll Summary</div>
                  <div class="text-sm text-green-600">
                    Staff salary breakdown
                  </div>
                </button>
              </div>
            </div>

            <!-- Client Reports -->
            <div class="bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-lg">
              <h5 class="text-lg font-semibold text-gray-800 mb-4">
                üë• Client Reports
              </h5>
              <div class="space-y-3">
                <button
                  onclick="generateReport('clients')"
                  class="w-full p-3 bg-indigo-50 rounded-lg border border-indigo-200 hover:bg-indigo-100 transition text-left"
                >
                  <div class="font-medium text-indigo-800">Client Summary</div>
                  <div class="text-sm text-indigo-600">
                    Active/inactive client stats
                  </div>
                </button>
                <button
                  onclick="generateReport('packages')"
                  class="w-full p-3 bg-purple-50 rounded-lg border border-purple-200 hover:bg-purple-100 transition text-left"
                >
                  <div class="font-medium text-purple-800">
                    Package Analysis
                  </div>
                  <div class="text-sm text-purple-600">
                    Most popular packages
                  </div>
                </button>
                <button
                  onclick="generateReport('retention')"
                  class="w-full p-3 bg-pink-50 rounded-lg border border-pink-200 hover:bg-pink-100 transition text-left"
                >
                  <div class="font-medium text-pink-800">Client Retention</div>
                  <div class="text-sm text-pink-600">
                    Churn and retention rates
                  </div>
                </button>
              </div>
            </div>

            <!-- Staff Reports -->
            <div class="bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-lg">
              <h5 class="text-lg font-semibold text-gray-800 mb-4">
                üë®‚Äçüíº Staff Reports
              </h5>
              <div class="space-y-3">
                <button
                  onclick="generateReport('staffSummary')"
                  class="w-full p-3 bg-cyan-50 rounded-lg border border-cyan-200 hover:bg-cyan-100 transition text-left"
                >
                  <div class="font-medium text-cyan-800">Staff Summary</div>
                  <div class="text-sm text-cyan-600">
                    Headcount by department
                  </div>
                </button>
                <button
                  onclick="generateReport('performance')"
                  class="w-full p-3 bg-orange-50 rounded-lg border border-orange-200 hover:bg-orange-100 transition text-left"
                >
                  <div class="font-medium text-orange-800">
                    Performance Report
                  </div>
                  <div class="text-sm text-orange-600">
                    Staff productivity metrics
                  </div>
                </button>
                <button
                  onclick="generateReport('attendance')"
                  class="w-full p-3 bg-yellow-50 rounded-lg border border-yellow-200 hover:bg-yellow-100 transition text-left"
                >
                  <div class="font-medium text-yellow-800">
                    Attendance Report
                  </div>
                  <div class="text-sm text-yellow-600">
                    Staff attendance tracking
                  </div>
                </button>
              </div>
            </div>
          </div>

          <!-- Report Preview Area -->
          <div
            id="analyticsPreview"
            class="hidden bg-white/80 backdrop-blur-sm p-8 rounded-2xl shadow-lg"
          >
            <h4 class="text-xl font-semibold text-gray-800 mb-6">
              Report Preview
            </h4>
            <div id="reportContent"></div>
          </div>
        </div>

        <!-- Expenses Section -->
        <div id="expensesSection" class="hidden space-y-8">
          <!-- Add New Expense -->
          <div class="bg-white/80 backdrop-blur-sm p-8 rounded-2xl shadow-lg">
            <h4 class="text-xl font-semibold text-gray-800 mb-6">
              üí∏ Record New Expense
            </h4>
            <form id="expenseForm" onsubmit="recordExpense(event)" class="space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >Expense Category</label
                  >
                  <select
                    id="expenseCategory"
                    required
                    class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-red-500 focus:ring-4 focus:ring-red-100"
                  >
                    <option value="">Select category...</option>
                    <option value="bills">üìÑ Bills & Utilities</option>
                    <option value="salaries">üí∞ Staff Salaries</option>
                    <option value="petty_cash">üíµ Petty Cash</option>
                    <option value="equipment">üñ•Ô∏è Equipment & Hardware</option>
                    <option value="office_supplies">üìã Office Supplies</option>
                    <option value="maintenance">
                      üîß Maintenance & Repairs
                    </option>
                    <option value="transportation">üöó Transportation</option>
                    <option value="marketing">
                      üì¢ Marketing & Advertising
                    </option>
                    <option value="insurance">üõ°Ô∏è Insurance</option>
                    <option value="rent">üè¢ Rent & Property</option>
                    <option value="software">üíª Software & Licenses</option>
                    <option value="training">üéì Training & Development</option>
                    <option value="other">üè∑Ô∏è Other</option>
                  </select>
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >Amount (KES)</label
                  >
                  <input
                    type="number"
                    id="expenseAmount"
                    min="0"
                    step="0.01"
                    required
                    class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-red-500 focus:ring-4 focus:ring-red-100"
                    placeholder="0.00"
                  />
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >Date</label
                  >
                  <input
                    type="date"
                    id="expenseDate"
                    required
                    class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-red-500 focus:ring-4 focus:ring-red-100"
                  />
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >Vendor/Payee</label
                  >
                  <input
                    type="text"
                    id="expenseVendor"
                    required
                    class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-red-500 focus:ring-4 focus:ring-red-100"
                    placeholder="e.g., KPLC, John Doe, Safaricom"
                  />
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >Payment Method</label
                  >
                  <select
                    id="paymentMethod"
                    required
                    class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-red-500 focus:ring-4 focus:ring-red-100"
                  >
                    <option value="">Select method...</option>
                    <option value="cash">üíµ Cash</option>
                    <option value="bank_transfer">üè¶ Bank Transfer</option>
                    <option value="mpesa">üì± M-Pesa</option>
                    <option value="cheque">üìù Cheque</option>
                    <option value="card">üí≥ Debit/Credit Card</option>
                    <option value="other">üîÑ Other</option>
                  </select>
                </div>
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Description</label
                >
                <textarea
                  id="expenseDescription"
                  rows="3"
                  required
                  class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-red-500 focus:ring-4 focus:ring-red-100"
                  placeholder="Detailed description of the expense..."
                ></textarea>
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Receipt/Reference Number (Optional)</label
                >
                <input
                  type="text"
                  id="expenseReference"
                  class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-red-500 focus:ring-4 focus:ring-red-100"
                  placeholder="Receipt number, invoice number, etc."
                />
              </div>

              <div class="flex justify-end space-x-4">
                <button
                  type="button"
                  onclick="clearExpenseForm()"
                  class="px-6 py-3 bg-gray-200 text-gray-700 rounded-xl font-semibold hover:bg-gray-300 transition-all duration-200"
                >
                  Clear Form
                </button>
                <button
                  type="submit"
                  class="px-8 py-3 bg-gradient-to-r from-red-600 to-orange-600 text-white rounded-xl font-semibold hover:from-red-700 hover:to-orange-700 transition-all duration-300 transform hover:-translate-y-1"
                >
                  üí∏ Record Expense
                </button>
              </div>
            </form>
          </div>

          <!-- Expense Summary Cards -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div
              class="bg-gradient-to-r from-red-500 to-pink-500 p-6 rounded-2xl text-white"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-red-100 text-sm">This Month</p>
                  <p class="text-2xl font-bold" id="monthlyExpenses">KES 0</p>
                </div>
                <div class="text-3xl opacity-80">üìä</div>
              </div>
            </div>

            <div
              class="bg-gradient-to-r from-orange-500 to-yellow-500 p-6 rounded-2xl text-white"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-orange-100 text-sm">This Year</p>
                  <p class="text-2xl font-bold" id="yearlyExpenses">KES 0</p>
                </div>
                <div class="text-3xl opacity-80">üìà</div>
              </div>
            </div>

            <div
              class="bg-gradient-to-r from-purple-500 to-indigo-500 p-6 rounded-2xl text-white"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-purple-100 text-sm">Largest Expense</p>
                  <p class="text-2xl font-bold" id="largestExpense">KES 0</p>
                </div>
                <div class="text-3xl opacity-80">üí∞</div>
              </div>
            </div>

            <div
              class="bg-gradient-to-r from-green-500 to-teal-500 p-6 rounded-2xl text-white"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-green-100 text-sm">Total Expenses</p>
                  <p class="text-2xl font-bold" id="totalExpenses">KES 0</p>
                </div>
                <div class="text-3xl opacity-80">üí∏</div>
              </div>
            </div>
          </div>

          <!-- Expense Management -->
          <div class="bg-white/80 backdrop-blur-sm p-8 rounded-2xl shadow-lg">
            <div class="flex justify-between items-center mb-6">
              <h4 class="text-xl font-semibold text-gray-800">
                üíº Expense Records
              </h4>
              <div class="flex space-x-4">
                <select
                  id="expenseFilterCategory"
                  class="px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-500"
                >
                  <option value="all">All Categories</option>
                  <option value="bills">Bills & Utilities</option>
                  <option value="salaries">Staff Salaries</option>
                  <option value="petty_cash">Petty Cash</option>
                  <option value="equipment">Equipment</option>
                  <option value="office_supplies">Office Supplies</option>
                  <option value="maintenance">Maintenance</option>
                  <option value="other">Other</option>
                </select>
                <input
                  type="month"
                  id="expenseFilterMonth"
                  class="px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-500"
                />
                <button
                  onclick="filterExpenses()"
                  class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                >
                  üîç Filter
                </button>
                <button
                  onclick="exportExpenses()"
                  class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
                >
                  üìä Export
                </button>
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50 border-b">
                  <tr>
                    <th
                      class="px-4 py-3 text-left text-sm font-semibold text-gray-600"
                    >
                      Date
                    </th>
                    <th
                      class="px-4 py-3 text-left text-sm font-semibold text-gray-600"
                    >
                      Category
                    </th>
                    <th
                      class="px-4 py-3 text-left text-sm font-semibold text-gray-600"
                    >
                      Vendor/Payee
                    </th>
                    <th
                      class="px-4 py-3 text-left text-sm font-semibold text-gray-600"
                    >
                      Description
                    </th>
                    <th
                      class="px-4 py-3 text-right text-sm font-semibold text-gray-600"
                    >
                      Amount
                    </th>
                    <th
                      class="px-4 py-3 text-center text-sm font-semibold text-gray-600"
                    >
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody id="expenseTableBody" class="divide-y divide-gray-200">
                  <!-- Expense records will be populated here -->
                </tbody>
              </table>
            </div>

            <div id="noExpenses" class="hidden text-center py-8">
              <div class="text-gray-400 text-6xl mb-4">üí∏</div>
              <h3 class="text-lg font-semibold text-gray-600">
                No expenses recorded
              </h3>
              <p class="text-gray-500 mt-2">
                Start by recording your first expense above.
              </p>
            </div>
          </div>
        </div>

        <!-- Sales Section -->
        <div id="salesSection" class="hidden space-y-8">
          <!-- Record Sale -->
          <div class="bg-white/80 backdrop-blur-sm p-8 rounded-2xl shadow-lg">
            <h4 class="text-xl font-semibold text-gray-800 mb-6">
              üõí Record Accessories Sale
            </h4>
            <form id="saleForm" class="space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >Accessory Type *</label
                  >
                  <select
                    id="saleType"
                    class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-100"
                    required
                  >
                    <option value="">Select accessory type...</option>
                    <option value="router">Router</option>
                    <option value="cable">Cable</option>
                    <option value="adapter">Adapter</option>
                    <option value="switch">Switch</option>
                    <option value="modem">Modem</option>
                    <option value="antenna">Antenna</option>
                    <option value="connector">Connector</option>
                    <option value="splitter">Splitter</option>
                    <option value="extender">WiFi Extender</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >Item Description *</label
                  >
                  <input
                    type="text"
                    id="saleDescription"
                    class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-100"
                    placeholder="e.g., TP-Link Router AC1200"
                    required
                  />
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >Sale Amount (KES) *</label
                  >
                  <input
                    type="number"
                    id="saleAmount"
                    step="0.01"
                    min="0"
                    class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-100"
                    placeholder="e.g., 3500.00"
                    required
                  />
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >Sale Date *</label
                  >
                  <input
                    type="date"
                    id="saleDate"
                    class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-100"
                    required
                  />
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >Customer Name</label
                  >
                  <input
                    type="text"
                    id="saleCustomer"
                    class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-100"
                    placeholder="Customer name (optional)"
                  />
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >Quantity</label
                  >
                  <input
                    type="number"
                    id="saleQuantity"
                    min="1"
                    value="1"
                    class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-100"
                  />
                </div>
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Sale Notes</label
                >
                <textarea
                  id="saleNotes"
                  rows="3"
                  class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-100"
                  placeholder="Additional notes about the sale..."
                ></textarea>
              </div>

              <div class="flex flex-col sm:flex-row gap-4">
                <button
                  type="submit"
                  class="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4 px-6 rounded-xl font-semibold hover:from-blue-700 hover:to-purple-700 transition-all duration-300 transform hover:-translate-y-1"
                >
                  <span class="mr-2">üí∞</span> Record Sale
                </button>
                <button
                  type="button"
                  onclick="clearSaleForm()"
                  class="flex-1 sm:flex-none bg-gray-500 text-white py-4 px-6 rounded-xl font-semibold hover:bg-gray-600 transition-all duration-300"
                >
                  <span class="mr-2">üóëÔ∏è</span> Clear Form
                </button>
              </div>
            </form>
          </div>

          <!-- Sales Summary Cards -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-blue-50 border-2 border-blue-200 p-6 rounded-2xl">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-semibold text-blue-600">
                    Today's Sales
                  </p>
                  <p id="todaySales" class="text-2xl font-bold text-blue-800">
                    KES 0
                  </p>
                </div>
                <div class="text-3xl text-blue-500">üí∞</div>
              </div>
            </div>

            <div
              class="bg-purple-50 border-2 border-purple-200 p-6 rounded-2xl"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-semibold text-purple-600">
                    This Month
                  </p>
                  <p
                    id="monthlySales"
                    class="text-2xl font-bold text-purple-800"
                  >
                    KES 0
                  </p>
                </div>
                <div class="text-3xl text-purple-500">üìä</div>
              </div>
            </div>

            <div class="bg-green-50 border-2 border-green-200 p-6 rounded-2xl">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-semibold text-green-600">This Year</p>
                  <p id="yearlySales" class="text-2xl font-bold text-green-800">
                    KES 0
                  </p>
                </div>
                <div class="text-3xl text-green-500">üìà</div>
              </div>
            </div>

            <div
              class="bg-orange-50 border-2 border-orange-200 p-6 rounded-2xl"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-semibold text-orange-600">
                    Total Sales
                  </p>
                  <p
                    id="totalSalesCount"
                    class="text-2xl font-bold text-orange-800"
                  >
                    0
                  </p>
                </div>
                <div class="text-3xl text-orange-500">üõí</div>
              </div>
            </div>
          </div>

          <!-- Sales Management -->
          <div class="bg-white/80 backdrop-blur-sm p-8 rounded-2xl shadow-lg">
            <div
              class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4"
            >
              <h4 class="text-xl font-semibold text-gray-800">
                üìã Sales Management
              </h4>
              <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                <select
                  id="salesFilterType"
                  class="px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-blue-500 bg-white"
                >
                  <option value="all">All Types</option>
                  <option value="router">Router</option>
                  <option value="cable">Cable</option>
                  <option value="adapter">Adapter</option>
                  <option value="switch">Switch</option>
                  <option value="modem">Modem</option>
                  <option value="antenna">Antenna</option>
                  <option value="connector">Connector</option>
                  <option value="splitter">Splitter</option>
                  <option value="extender">WiFi Extender</option>
                  <option value="other">Other</option>
                </select>
                <select
                  id="salesFilterMonth"
                  class="px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-blue-500 bg-white"
                >
                  <option value="">All Months</option>
                </select>
                <button
                  onclick="exportSales()"
                  class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2"
                >
                  <span>üì•</span> Export CSV
                </button>
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="bg-gray-50 border-b border-gray-200">
                    <th
                      class="px-4 py-3 text-left text-sm font-semibold text-gray-600"
                    >
                      Date
                    </th>
                    <th
                      class="px-4 py-3 text-left text-sm font-semibold text-gray-600"
                    >
                      Type
                    </th>
                    <th
                      class="px-4 py-3 text-left text-sm font-semibold text-gray-600"
                    >
                      Description
                    </th>
                    <th
                      class="px-4 py-3 text-left text-sm font-semibold text-gray-600"
                    >
                      Customer
                    </th>
                    <th
                      class="px-4 py-3 text-left text-sm font-semibold text-gray-600"
                    >
                      Qty
                    </th>
                    <th
                      class="px-4 py-3 text-right text-sm font-semibold text-gray-600"
                    >
                      Amount
                    </th>
                    <th
                      class="px-4 py-3 text-center text-sm font-semibold text-gray-600"
                    >
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody id="salesTableBody" class="divide-y divide-gray-200">
                  <!-- Sales records will be populated here -->
                </tbody>
              </table>
            </div>

            <div id="noSales" class="hidden text-center py-8">
              <div class="text-gray-400 text-6xl mb-4">üõí</div>
              <h3 class="text-lg font-semibold text-gray-600">
                No sales recorded
              </h3>
              <p class="text-gray-500 mt-2">
                Start by recording your first sale above.
              </p>
            </div>
          </div>
        </div>

        <!-- Equipment & Tools Section -->
        <div id="equipmentSection" class="hidden space-y-8">
          <!-- Equipment Management Header -->
          <div class="bg-white/80 backdrop-blur-sm p-8 rounded-2xl shadow-lg">
            <h4 class="text-xl font-semibold text-gray-800 mb-6">
              üß∞ Equipment & Tools Inventory Management
            </h4>
            <p class="text-gray-600 mb-6">
              Manage equipment inventory, track quantities, and monitor equipment status across all service locations.
            </p>
            
            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-4 mb-8">
              <button
                onclick="openAddEquipmentModal()"
                class="px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg hover:from-green-700 hover:to-emerald-700 transition-all duration-200 flex items-center shadow-md"
              >
                <i class="fas fa-plus mr-2"></i>
                Add Equipment
              </button>
              <button
                onclick="downloadInventoryReport()"
                class="px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:from-blue-700 hover:to-indigo-700 transition-all duration-200 flex items-center shadow-md"
              >
                <i class="fas fa-download mr-2"></i>
                Export Report
              </button>
              <button
                onclick="refreshEquipmentData()"
                class="px-6 py-3 bg-gradient-to-r from-gray-600 to-gray-700 text-white rounded-lg hover:from-gray-700 hover:to-gray-800 transition-all duration-200 flex items-center shadow-md"
              >
                <i class="fas fa-sync-alt mr-2"></i>
                Refresh
              </button>
            </div>

            <!-- Equipment Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
              <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-xl text-white">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-blue-100 text-sm font-medium">Total Items</p>
                    <p class="text-2xl font-bold" id="totalItems">0</p>
                  </div>
                  <div class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-boxes text-lg"></i>
                  </div>
                </div>
              </div>
              <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-xl text-white">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-green-100 text-sm font-medium">In Stock</p>
                    <p class="text-2xl font-bold" id="inStock">0</p>
                  </div>
                  <div class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-check-circle text-lg"></i>
                  </div>
                </div>
              </div>
              <div class="bg-gradient-to-br from-yellow-500 to-orange-500 p-6 rounded-xl text-white">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-yellow-100 text-sm font-medium">Low Stock</p>
                    <p class="text-2xl font-bold" id="lowStock">0</p>
                  </div>
                  <div class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-exclamation-triangle text-lg"></i>
                  </div>
                </div>
              </div>
              <div class="bg-gradient-to-br from-red-500 to-red-600 p-6 rounded-xl text-white">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-red-100 text-sm font-medium">Out of Stock</p>
                    <p class="text-2xl font-bold" id="outOfStock">0</p>
                  </div>
                  <div class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-times-circle text-lg"></i>
                  </div>
                </div>
              </div>
            </div>

            <!-- Search and Filters -->
            <div class="bg-gray-50 p-6 rounded-xl mb-8">
              <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Search Equipment</label>
                  <div class="relative">
                    <input
                      type="text"
                      id="equipmentSearch"
                      placeholder="Search by name, serial number..."
                      class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      onkeyup="searchEquipment()"
                    />
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                  <select
                    id="categoryFilter"
                    onchange="filterEquipment()"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  >
                    <option value="">All Categories</option>
                    <option value="network">Network Equipment</option>
                    <option value="tools">Tools</option>
                    <option value="cables">Cables & Accessories</option>
                    <option value="hardware">Hardware</option>
                    <option value="safety">Safety Equipment</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                  <select
                    id="statusFilter"
                    onchange="filterEquipment()"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  >
                    <option value="">All Status</option>
                    <option value="in-stock">In Stock</option>
                    <option value="low-stock">Low Stock</option>
                    <option value="out-of-stock">Out of Stock</option>
                    <option value="maintenance">Maintenance</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                  <select
                    id="locationFilter"
                    onchange="filterEquipment()"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  >
                    <option value="">All Locations</option>
                    <option value="main-office">Main Office</option>
                    <option value="warehouse">Warehouse</option>
                    <option value="field-service">Field Service</option>
                    <option value="repair-center">Repair Center</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Equipment Table -->
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Equipment</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Serial Number</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Updated</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="equipmentTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Equipment items will be loaded here -->
                    <tr>
                      <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                        <div class="flex flex-col items-center">
                          <i class="fas fa-tools text-4xl text-gray-300 mb-3"></i>
                          <p class="text-lg font-medium">No equipment found</p>
                          <p class="text-sm">Click "Add Equipment" to start tracking your inventory</p>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Daily Reports Section -->
        <div id="dailyReportsSection" class="hidden space-y-8">
          <!-- Reports Header -->
          <div class="bg-white/80 backdrop-blur-sm p-8 rounded-2xl shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
              <div>
                <h3 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                  üìã Supervisor Daily Reports
                </h3>
                <p class="text-gray-600 mt-1">Reports submitted by supervisors and team leads</p>
              </div>
              <div class="flex items-center space-x-4 mt-4 md:mt-0">
                <div class="text-center">
                  <div class="text-2xl font-bold text-blue-600" id="totalReportsCount">0</div>
                  <div class="text-sm text-gray-500">Total Reports</div>
                </div>
                <div class="text-center">
                  <div class="text-2xl font-bold text-green-600" id="todayReportsCount">0</div>
                  <div class="text-sm text-gray-500">Today</div>
                </div>
              </div>
            </div>

            <!-- Filters and Search -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Search Reports</label>
                <input
                  type="text"
                  id="reportsSearch"
                  placeholder="Search by title or type..."
                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  onkeyup="filterReports()"
                >
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Report Type</label>
                <select id="reportsTypeFilter" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="filterReports()">
                  <option value="">All Types</option>
                  <option value="daily-operations">Daily Operations</option>
                  <option value="equipment-status">Equipment Status</option>
                  <option value="team-performance">Team Performance</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                <select id="reportsPriorityFilter" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="filterReports()">
                  <option value="">All Priorities</option>
                  <option value="normal">Normal</option>
                  <option value="high">High</option>
                  <option value="urgent">Urgent</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                <select id="reportsDateFilter" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="filterReports()">
                  <option value="">All Time</option>
                  <option value="today">Today</option>
                  <option value="yesterday">Yesterday</option>
                  <option value="week">This Week</option>
                  <option value="month">This Month</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Reports Statistics Cards -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="bg-gradient-to-r from-blue-500 to-indigo-600 p-6 rounded-2xl text-white">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-blue-100 text-sm">Today's Reports</p>
                  <p class="text-3xl font-bold" id="todayReportsCard">0</p>
                </div>
                <div class="text-4xl opacity-80">üìä</div>
              </div>
            </div>

            <div class="bg-gradient-to-r from-green-500 to-emerald-600 p-6 rounded-2xl text-white">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-green-100 text-sm">This Week</p>
                  <p class="text-3xl font-bold" id="weekReportsCard">0</p>
                </div>
                <div class="text-4xl opacity-80">üìà</div>
              </div>
            </div>

            <div class="bg-gradient-to-r from-purple-500 to-pink-600 p-6 rounded-2xl text-white">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-purple-100 text-sm">High Priority</p>
                  <p class="text-3xl font-bold" id="highPriorityReportsCard">0</p>
                </div>
                <div class="text-4xl opacity-80">‚ö°</div>
              </div>
            </div>

            <div class="bg-gradient-to-r from-orange-500 to-red-600 p-6 rounded-2xl text-white">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-orange-100 text-sm">Urgent Issues</p>
                  <p class="text-3xl font-bold" id="urgentReportsCard">0</p>
                </div>
                <div class="text-4xl opacity-80">üö®</div>
              </div>
            </div>
          </div>

          <!-- Reports List -->
          <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg overflow-hidden">
            <div class="p-6 border-b border-gray-200">
              <h4 class="text-xl font-semibold text-gray-800">Recent Reports</h4>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Report Details</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type & Priority</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Shift</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CTIO Actions</th>
                  </tr>
                </thead>
                <tbody id="reportsTableBody" class="bg-white divide-y divide-gray-200">
                  <!-- Reports will be loaded here -->
                  <tr>
                    <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                      <div class="flex flex-col items-center">
                        <i class="fas fa-clipboard-list text-4xl text-gray-300 mb-3"></i>
                        <p class="text-lg font-medium">No reports available</p>
                        <p class="text-sm">Reports from supervisors will appear here once submitted</p>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Report Detail Modal (hidden by default) -->
          <div id="reportDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-[9999] hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
              <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                  <h3 class="text-xl font-semibold text-gray-900">Report Details</h3>
                  <button onclick="closeReportModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                  </button>
                </div>
              </div>
              <div id="reportDetailContent" class="p-6">
                <!-- Report details will be loaded here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Receipts Section -->
        <div id="receiptsSection" class="hidden space-y-8">
          <!-- Record Payment Receipt -->
          <div class="bg-white/80 backdrop-blur-sm p-8 rounded-2xl shadow-lg">
            <h4 class="text-xl font-semibold text-gray-800 mb-6">
              üßæ Record Payment Receipt
            </h4>
            <form id="receiptForm" onsubmit="recordReceipt(event)" class="space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >Client Name *</label
                  >
                  <input
                    type="text"
                    id="receiptClient"
                    class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-green-500 focus:ring-4 focus:ring-green-100"
                    placeholder="Enter client name..."
                    required
                  />
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >Amount Paid (KES) *</label
                  >
                  <input
                    type="number"
                    id="receiptAmount"
                    step="0.01"
                    min="0"
                    class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-green-500 focus:ring-4 focus:ring-green-100"
                    placeholder="e.g., 2500.00"
                    required
                  />
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >Payment Date *</label
                  >
                  <input
                    type="date"
                    id="receiptDate"
                    class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-green-500 focus:ring-4 focus:ring-green-100"
                    required
                  />
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >Payment Method *</label
                  >
                  <select
                    id="receiptPaymentMethod"
                    class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-green-500 focus:ring-4 focus:ring-green-100"
                    required
                  >
                    <option value="">Select payment method...</option>
                    <option value="M-PESA">M-PESA</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                    <option value="Cash">Cash</option>
                    <option value="Cheque">Cheque</option>
                    <option value="Airtel Money">Airtel Money</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >Transaction Reference</label
                  >
                  <input
                    type="text"
                    id="receiptReference"
                    class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-green-500 focus:ring-4 focus:ring-green-100"
                    placeholder="e.g., QHW7G8K2MP"
                  />
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >Service Period</label
                  >
                  <select
                    id="receiptServicePeriod"
                    class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-green-500 focus:ring-4 focus:ring-green-100"
                  >
                    <option value="">Select period...</option>
                    <option value="Current Month">Current Month</option>
                    <option value="Next Month">Next Month</option>
                    <option value="Quarterly">Quarterly</option>
                    <option value="Annual">Annual</option>
                    <option value="Setup Fee">Setup Fee</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Payment Notes</label
                >
                <textarea
                  id="receiptNotes"
                  rows="3"
                  class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-green-500 focus:ring-4 focus:ring-green-100"
                  placeholder="Additional notes about the payment..."
                ></textarea>
              </div>

              <div class="flex flex-col sm:flex-row gap-4">
                <button
                  type="submit"
                  class="flex-1 bg-gradient-to-r from-green-600 to-blue-600 text-white py-4 px-6 rounded-xl font-semibold hover:from-green-700 hover:to-blue-700 transition-all duration-300 transform hover:-translate-y-1"
                >
                  <span class="mr-2">üíæ</span> Record Payment
                </button>
                <button
                  type="button"
                  onclick="clearReceiptForm()"
                  class="flex-1 sm:flex-none bg-gray-500 text-white py-4 px-6 rounded-xl font-semibold hover:bg-gray-600 transition-all duration-300"
                >
                  <span class="mr-2">üóëÔ∏è</span> Clear Form
                </button>
              </div>
            </form>
          </div>

          <!-- Payment Summary Cards -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-green-50 border-2 border-green-200 p-6 rounded-2xl">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-semibold text-green-600">
                    Today's Payments
                  </p>
                  <p
                    id="todayPayments"
                    class="text-2xl font-bold text-green-800"
                  >
                    KES 0
                  </p>
                </div>
                <div class="text-3xl text-green-500">üí∞</div>
              </div>
            </div>

            <div class="bg-blue-50 border-2 border-blue-200 p-6 rounded-2xl">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-semibold text-blue-600">This Month</p>
                  <p
                    id="monthlyPayments"
                    class="text-2xl font-bold text-blue-800"
                  >
                    KES 0
                  </p>
                </div>
                <div class="text-3xl text-blue-500">üìä</div>
              </div>
            </div>

            <div
              class="bg-purple-50 border-2 border-purple-200 p-6 rounded-2xl"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-semibold text-purple-600">This Year</p>
                  <p
                    id="yearlyPayments"
                    class="text-2xl font-bold text-purple-800"
                  >
                    KES 0
                  </p>
                </div>
                <div class="text-3xl text-purple-500">üìà</div>
              </div>
            </div>

            <div
              class="bg-orange-50 border-2 border-orange-200 p-6 rounded-2xl"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-semibold text-orange-600">
                    Total Receipts
                  </p>
                  <p
                    id="totalReceipts"
                    class="text-2xl font-bold text-orange-800"
                  >
                    0
                  </p>
                </div>
                <div class="text-3xl text-orange-500">üßæ</div>
              </div>
            </div>
          </div>

          <!-- Receipt Management -->
          <div class="bg-white/80 backdrop-blur-sm p-8 rounded-2xl shadow-lg">
            <div
              class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4"
            >
              <h4 class="text-xl font-semibold text-gray-800">
                üìã Payment Receipts Management
              </h4>
              <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                <select
                  id="receiptFilterClient"
                  class="px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-green-500 bg-white"
                >
                  <option value="all">All Clients</option>
                </select>
                <select
                  id="receiptFilterMonth"
                  class="px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-green-500 bg-white"
                >
                  <option value="">All Months</option>
                </select>
                <button
                  onclick="exportReceipts()"
                  class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center gap-2"
                >
                  <span>üì•</span> Export CSV
                </button>
                <button
                  onclick="testPDFFunction()"
                  class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2"
                  title="Test receipt generation (PDF or Print)"
                >
                  <span>üß™</span> Test Receipt
                </button>
                <button
                  onclick="checkPDFStatus()"
                  class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition flex items-center gap-2"
                  title="Check PDF library status"
                >
                  <span>üîç</span> Check Status
                </button>

              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="bg-gray-50 border-b border-gray-200">
                    <th
                      class="px-4 py-3 text-left text-sm font-semibold text-gray-600"
                    >
                      Date
                    </th>
                    <th
                      class="px-4 py-3 text-left text-sm font-semibold text-gray-600"
                    >
                      Receipt #
                    </th>
                    <th
                      class="px-4 py-3 text-left text-sm font-semibold text-gray-600"
                    >
                      Client
                    </th>
                    <th
                      class="px-4 py-3 text-left text-sm font-semibold text-gray-600"
                    >
                      Payment Method
                    </th>
                    <th
                      class="px-4 py-3 text-left text-sm font-semibold text-gray-600"
                    >
                      Service Period
                    </th>
                    <th
                      class="px-4 py-3 text-right text-sm font-semibold text-gray-600"
                    >
                      Amount
                    </th>
                    <th
                      class="px-4 py-3 text-center text-sm font-semibold text-gray-600"
                    >
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody id="receiptTableBody" class="divide-y divide-gray-200">
                  <!-- Receipt records will be populated here -->
                </tbody>
              </table>
            </div>

            <div id="noReceipts" class="hidden text-center py-8">
              <div class="text-gray-400 text-6xl mb-4">üßæ</div>
              <h3 class="text-lg font-semibold text-gray-600">
                No payment receipts recorded
              </h3>
              <p class="text-gray-500 mt-2">
                Start by recording your first payment receipt above.
              </p>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Receipt View Modal -->
    <div id="receiptViewModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[9999] flex items-center justify-center p-4">
      <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto transform transition-all">
        <!-- Modal Header -->
        <div class="bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-700 text-white p-8 rounded-t-3xl relative overflow-hidden">
          <div class="absolute inset-0 bg-gradient-to-r from-blue-500/20 via-purple-500/20 to-indigo-500/20"></div>
          <div class="relative z-10">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h3 class="text-2xl font-bold flex items-center">
                  <i class="fas fa-receipt mr-3 text-3xl"></i>
                  Payment Receipt
                </h3>
                <p class="text-blue-100 mt-2">Dr.Net Services - Internet Service Provider</p>
              </div>
              <button onclick="closeReceiptModal()" class="text-white hover:text-red-200 transition-colors p-2 hover:bg-white/10 rounded-full">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>
            
            <!-- Receipt Number Badge -->
            <div class="inline-block bg-white/20 backdrop-blur-sm px-4 py-2 rounded-full">
              <span class="font-semibold">Receipt #</span>
              <span id="modalReceiptNumber" class="font-bold ml-2">---</span>
            </div>
          </div>
          
          <!-- Decorative elements -->
          <div class="absolute -top-10 -right-10 w-32 h-32 bg-white/10 rounded-full"></div>
          <div class="absolute -bottom-6 -left-6 w-20 h-20 bg-white/5 rounded-full"></div>
        </div>

        <!-- Modal Content -->
        <div class="p-8">
          <!-- Receipt Details Grid -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Date & Time -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-2xl border border-blue-100">
              <h4 class="font-semibold text-blue-800 mb-3 flex items-center">
                <i class="fas fa-calendar-alt mr-2"></i> Date & Time
              </h4>
              <p class="text-gray-700 mb-1"><span class="font-medium">Date:</span> <span id="modalReceiptDate">---</span></p>
              <p class="text-gray-700"><span class="font-medium">Time:</span> <span id="modalReceiptTime">---</span></p>
            </div>

            <!-- Client Info -->
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-2xl border border-green-100">
              <h4 class="font-semibold text-green-800 mb-3 flex items-center">
                <i class="fas fa-user mr-2"></i> Client Information
              </h4>
              <p class="text-gray-700 font-semibold text-lg" id="modalClientName">---</p>
            </div>
          </div>

          <!-- Payment Details -->
          <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-2xl border border-purple-100 mb-6">
            <h4 class="font-semibold text-purple-800 mb-4 flex items-center text-lg">
              <i class="fas fa-credit-card mr-2"></i> Payment Details
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <p class="text-sm font-medium text-gray-600">Payment Method</p>
                <p class="text-lg font-semibold text-gray-800" id="modalPaymentMethod">---</p>
              </div>
              <div>
                <p class="text-sm font-medium text-gray-600">Transaction Reference</p>
                <p class="text-lg font-semibold text-gray-800" id="modalReference">---</p>
              </div>
              <div>
                <p class="text-sm font-medium text-gray-600">Service Period</p>
                <p class="text-lg font-semibold text-gray-800" id="modalServicePeriod">---</p>
              </div>
            </div>
          </div>

          <!-- Amount Section -->
          <div class="bg-gradient-to-r from-green-600 to-emerald-600 text-white p-6 rounded-2xl mb-6 relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-r from-green-500/30 to-emerald-500/30"></div>
            <div class="relative z-10">
              <h4 class="text-lg font-semibold mb-2 flex items-center">
                <i class="fas fa-money-bill-wave mr-2"></i> Amount Paid
              </h4>
              <p class="text-4xl font-bold" id="modalAmount">KES 0.00</p>
            </div>
            <div class="absolute -top-4 -right-4 w-24 h-24 bg-white/10 rounded-full"></div>
          </div>

          <!-- Notes Section -->
          <div id="modalNotesSection" class="bg-gradient-to-r from-yellow-50 to-orange-50 p-4 rounded-2xl border border-yellow-100 mb-6 hidden">
            <h4 class="font-semibold text-orange-800 mb-3 flex items-center">
              <i class="fas fa-sticky-note mr-2"></i> Payment Notes
            </h4>
            <p class="text-gray-700" id="modalNotes">---</p>
          </div>

          <!-- Action Buttons -->
          <div class="flex flex-col sm:flex-row gap-3 pt-4 border-t border-gray-200">
            <button onclick="printReceiptFromModal()" class="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 px-6 rounded-xl font-semibold hover:from-purple-700 hover:to-indigo-700 transition-all duration-300 transform hover:scale-105 flex items-center justify-center">
              <i class="fas fa-file-pdf mr-2"></i> Generate PDF
            </button>
            <button onclick="closeReceiptModal()" class="flex-1 sm:flex-none bg-gradient-to-r from-gray-500 to-gray-600 text-white py-3 px-6 rounded-xl font-semibold hover:from-gray-600 hover:to-gray-700 transition-all duration-300 flex items-center justify-center">
              <i class="fas fa-times mr-2"></i> Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Equipment Modal -->
    <div id="addEquipmentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform transition-all">
        <div class="bg-gradient-to-r from-green-600 to-emerald-600 text-white p-6 rounded-t-2xl">
          <h3 class="text-xl font-semibold flex items-center">
            <i class="fas fa-plus-circle mr-3"></i>
            Add New Equipment
          </h3>
        </div>
        <form id="addEquipmentForm" class="p-6 space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Equipment Name *</label>
            <input
              type="text"
              id="equipmentName"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
              placeholder="Enter equipment name"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Serial Number</label>
            <input
              type="text"
              id="equipmentSerial"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
              placeholder="Enter serial number"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Category *</label>
            <select
              id="equipmentCategory"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
            >
              <option value="">Select Category</option>
              <option value="network">Network Equipment</option>
              <option value="tools">Tools</option>
              <option value="cables">Cables & Accessories</option>
              <option value="hardware">Hardware</option>
              <option value="safety">Safety Equipment</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Quantity *</label>
            <input
              type="number"
              id="equipmentQuantity"
              required
              min="0"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
              placeholder="Enter quantity"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Stock Level</label>
            <input
              type="number"
              id="equipmentMinStock"
              min="0"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
              placeholder="Enter minimum stock level"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Location *</label>
            <select
              id="equipmentLocation"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
            >
              <option value="">Select Location</option>
              <option value="main-office">Main Office</option>
              <option value="warehouse">Warehouse</option>
              <option value="field-service">Field Service</option>
              <option value="repair-center">Repair Center</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
            <textarea
              id="equipmentDescription"
              rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
              placeholder="Enter equipment description"
            ></textarea>
          </div>
          <div class="flex justify-end space-x-3 pt-4">
            <button
              type="button"
              onclick="closeAddEquipmentModal()"
              class="px-6 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-6 py-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg hover:from-green-700 hover:to-emerald-700 transition-all"
            >
              Add Equipment
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit Equipment Modal -->
    <div id="editEquipmentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform transition-all">
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 rounded-t-2xl">
          <h3 class="text-xl font-semibold flex items-center">
            <i class="fas fa-edit mr-3"></i>
            Edit Equipment
          </h3>
        </div>
        <form id="editEquipmentForm" class="p-6 space-y-4">
          <input type="hidden" id="editEquipmentId" />
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Equipment Name *</label>
            <input
              type="text"
              id="editEquipmentName"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              placeholder="Enter equipment name"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Serial Number</label>
            <input
              type="text"
              id="editEquipmentSerial"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              placeholder="Enter serial number"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Category *</label>
            <select
              id="editEquipmentCategory"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="">Select Category</option>
              <option value="network">Network Equipment</option>
              <option value="tools">Tools</option>
              <option value="cables">Cables & Accessories</option>
              <option value="hardware">Hardware</option>
              <option value="safety">Safety Equipment</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Quantity *</label>
            <input
              type="number"
              id="editEquipmentQuantity"
              required
              min="0"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              placeholder="Enter quantity"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Stock Level</label>
            <input
              type="number"
              id="editEquipmentMinStock"
              min="0"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              placeholder="Enter minimum stock level"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Location *</label>
            <select
              id="editEquipmentLocation"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="">Select Location</option>
              <option value="main-office">Main Office</option>
              <option value="warehouse">Warehouse</option>
              <option value="field-service">Field Service</option>
              <option value="repair-center">Repair Center</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
            <textarea
              id="editEquipmentDescription"
              rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              placeholder="Enter equipment description"
            ></textarea>
          </div>
          <div class="flex justify-end space-x-3 pt-4">
            <button
              type="button"
              onclick="closeEditEquipmentModal()"
              class="px-6 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-6 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:from-blue-700 hover:to-indigo-700 transition-all"
            >
              Update Equipment
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Equipment Management Functions
      let equipmentData = JSON.parse(localStorage.getItem('equipmentData')) || [];

      // Initialize equipment data on page load
      document.addEventListener('DOMContentLoaded', function() {
        loadEquipmentData();
        updateEquipmentStats();
      });

      function openAddEquipmentModal() {
        document.getElementById('addEquipmentModal').classList.remove('hidden');
        document.getElementById('addEquipmentForm').reset();
      }

      function closeAddEquipmentModal() {
        document.getElementById('addEquipmentModal').classList.add('hidden');
      }

      function openEditEquipmentModal(id) {
        const equipment = equipmentData.find(item => item.id === id);
        if (equipment) {
          document.getElementById('editEquipmentId').value = equipment.id;
          document.getElementById('editEquipmentName').value = equipment.name;
          document.getElementById('editEquipmentSerial').value = equipment.serialNumber || '';
          document.getElementById('editEquipmentCategory').value = equipment.category;
          document.getElementById('editEquipmentQuantity').value = equipment.quantity;
          document.getElementById('editEquipmentMinStock').value = equipment.minStock || '';
          document.getElementById('editEquipmentLocation').value = equipment.location;
          document.getElementById('editEquipmentDescription').value = equipment.description || '';
          document.getElementById('editEquipmentModal').classList.remove('hidden');
        }
      }

      function closeEditEquipmentModal() {
        document.getElementById('editEquipmentModal').classList.add('hidden');
      }

      // Add equipment form submission
      document.getElementById('addEquipmentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const newEquipment = {
          id: Date.now().toString(),
          name: document.getElementById('equipmentName').value,
          serialNumber: document.getElementById('equipmentSerial').value,
          category: document.getElementById('equipmentCategory').value,
          quantity: parseInt(document.getElementById('equipmentQuantity').value),
          minStock: parseInt(document.getElementById('equipmentMinStock').value) || 0,
          location: document.getElementById('equipmentLocation').value,
          description: document.getElementById('equipmentDescription').value,
          dateAdded: new Date().toISOString().split('T')[0],
          lastUpdated: new Date().toISOString().split('T')[0]
        };

        equipmentData.push(newEquipment);
        localStorage.setItem('equipmentData', JSON.stringify(equipmentData));
        
        loadEquipmentData();
        updateEquipmentStats();
        closeAddEquipmentModal();
        
        // Show success message
        showNotification('Equipment added successfully!', 'success');
      });

      // Edit equipment form submission
      document.getElementById('editEquipmentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const id = document.getElementById('editEquipmentId').value;
        const equipmentIndex = equipmentData.findIndex(item => item.id === id);
        
        if (equipmentIndex !== -1) {
          equipmentData[equipmentIndex] = {
            ...equipmentData[equipmentIndex],
            name: document.getElementById('editEquipmentName').value,
            serialNumber: document.getElementById('editEquipmentSerial').value,
            category: document.getElementById('editEquipmentCategory').value,
            quantity: parseInt(document.getElementById('editEquipmentQuantity').value),
            minStock: parseInt(document.getElementById('editEquipmentMinStock').value) || 0,
            location: document.getElementById('editEquipmentLocation').value,
            description: document.getElementById('editEquipmentDescription').value,
            lastUpdated: new Date().toISOString().split('T')[0]
          };

          localStorage.setItem('equipmentData', JSON.stringify(equipmentData));
          
          loadEquipmentData();
          updateEquipmentStats();
          closeEditEquipmentModal();
          
          // Show success message
          showNotification('Equipment updated successfully!', 'success');
        }
      });

      // Receipt form submission
      document.getElementById('receiptForm').addEventListener('submit', function(e) {
        e.preventDefault();
        recordReceipt();
      });

      function deleteEquipment(id) {
        if (confirm('Are you sure you want to delete this equipment item?')) {
          equipmentData = equipmentData.filter(item => item.id !== id);
          localStorage.setItem('equipmentData', JSON.stringify(equipmentData));
          
          loadEquipmentData();
          updateEquipmentStats();
          
          // Show success message
          showNotification('Equipment deleted successfully!', 'success');
        }
      }

      function loadEquipmentData() {
        const tbody = document.getElementById('equipmentTableBody');
        
        if (equipmentData.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                <div class="flex flex-col items-center">
                  <i class="fas fa-tools text-4xl text-gray-300 mb-3"></i>
                  <p class="text-lg font-medium">No equipment found</p>
                  <p class="text-sm">Click "Add Equipment" to start tracking your inventory</p>
                </div>
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = equipmentData.map(equipment => {
          const status = getEquipmentStatus(equipment);
          const statusColor = getStatusColor(status);
          
          return `
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap">
                <div>
                  <div class="text-sm font-medium text-gray-900">${equipment.name}</div>
                  <div class="text-sm text-gray-500">${equipment.description || 'No description'}</div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                ${equipment.serialNumber || 'N/A'}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                  ${getCategoryLabel(equipment.category)}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                ${equipment.quantity}
                ${equipment.minStock ? `/ ${equipment.minStock} min` : ''}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                  ${status}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                ${getLocationLabel(equipment.location)}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${equipment.lastUpdated}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <div class="flex space-x-2">
                  <button
                    onclick="openEditEquipmentModal('${equipment.id}')"
                    class="text-indigo-600 hover:text-indigo-900 transition-colors"
                    title="Edit"
                  >
                    <i class="fas fa-edit"></i>
                  </button>
                  <button
                    onclick="deleteEquipment('${equipment.id}')"
                    class="text-red-600 hover:text-red-900 transition-colors"
                    title="Delete"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      }

      function updateEquipmentStats() {
        const totalItems = equipmentData.length;
        const inStock = equipmentData.filter(item => item.quantity > (item.minStock || 0)).length;
        const lowStock = equipmentData.filter(item => item.quantity > 0 && item.quantity <= (item.minStock || 0) && item.minStock > 0).length;
        const outOfStock = equipmentData.filter(item => item.quantity === 0).length;

        document.getElementById('totalItems').textContent = totalItems;
        document.getElementById('inStock').textContent = inStock;
        document.getElementById('lowStock').textContent = lowStock;
        document.getElementById('outOfStock').textContent = outOfStock;
      }

      function getEquipmentStatus(equipment) {
        if (equipment.quantity === 0) return 'Out of Stock';
        if (equipment.minStock && equipment.quantity <= equipment.minStock) return 'Low Stock';
        return 'In Stock';
      }

      function getStatusColor(status) {
        switch (status) {
          case 'In Stock': return 'bg-green-100 text-green-800';
          case 'Low Stock': return 'bg-yellow-100 text-yellow-800';
          case 'Out of Stock': return 'bg-red-100 text-red-800';
          default: return 'bg-gray-100 text-gray-800';
        }
      }

      function getCategoryLabel(category) {
        const labels = {
          'network': 'Network Equipment',
          'tools': 'Tools',
          'cables': 'Cables & Accessories',
          'hardware': 'Hardware',
          'safety': 'Safety Equipment'
        };
        return labels[category] || category;
      }

      function getLocationLabel(location) {
        const labels = {
          'main-office': 'Main Office',
          'warehouse': 'Warehouse',
          'field-service': 'Field Service',
          'repair-center': 'Repair Center'
        };
        return labels[location] || location;
      }

      function searchEquipment() {
        const searchTerm = document.getElementById('equipmentSearch').value.toLowerCase();
        const categoryFilter = document.getElementById('categoryFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        const locationFilter = document.getElementById('locationFilter').value;

        let filteredData = equipmentData.filter(equipment => {
          const matchesSearch = equipment.name.toLowerCase().includes(searchTerm) ||
                               (equipment.serialNumber && equipment.serialNumber.toLowerCase().includes(searchTerm)) ||
                               (equipment.description && equipment.description.toLowerCase().includes(searchTerm));
          
          const matchesCategory = !categoryFilter || equipment.category === categoryFilter;
          const matchesLocation = !locationFilter || equipment.location === locationFilter;
          
          let matchesStatus = true;
          if (statusFilter) {
            const status = getEquipmentStatus(equipment);
            matchesStatus = status.toLowerCase().replace(' ', '-') === statusFilter;
          }

          return matchesSearch && matchesCategory && matchesStatus && matchesLocation;
        });

        displayFilteredEquipment(filteredData);
      }

      function filterEquipment() {
        searchEquipment(); // Reuse the search function for filtering
      }

      function displayFilteredEquipment(filteredData) {
        const tbody = document.getElementById('equipmentTableBody');
        
        if (filteredData.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                <div class="flex flex-col items-center">
                  <i class="fas fa-search text-4xl text-gray-300 mb-3"></i>
                  <p class="text-lg font-medium">No equipment found</p>
                  <p class="text-sm">Try adjusting your search or filter criteria</p>
                </div>
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = filteredData.map(equipment => {
          const status = getEquipmentStatus(equipment);
          const statusColor = getStatusColor(status);
          
          return `
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap">
                <div>
                  <div class="text-sm font-medium text-gray-900">${equipment.name}</div>
                  <div class="text-sm text-gray-500">${equipment.description || 'No description'}</div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                ${equipment.serialNumber || 'N/A'}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                  ${getCategoryLabel(equipment.category)}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                ${equipment.quantity}
                ${equipment.minStock ? `/ ${equipment.minStock} min` : ''}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                  ${status}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                ${getLocationLabel(equipment.location)}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${equipment.lastUpdated}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <div class="flex space-x-2">
                  <button
                    onclick="openEditEquipmentModal('${equipment.id}')"
                    class="text-indigo-600 hover:text-indigo-900 transition-colors"
                    title="Edit"
                  >
                    <i class="fas fa-edit"></i>
                  </button>
                  <button
                    onclick="deleteEquipment('${equipment.id}')"
                    class="text-red-600 hover:text-red-900 transition-colors"
                    title="Delete"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      }

      function refreshEquipmentData() {
        loadEquipmentData();
        updateEquipmentStats();
        
        // Reset filters
        document.getElementById('equipmentSearch').value = '';
        document.getElementById('categoryFilter').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('locationFilter').value = '';
        
        showNotification('Equipment data refreshed!', 'info');
      }

      function downloadInventoryReport() {
        if (equipmentData.length === 0) {
          showNotification('No equipment data to export!', 'warning');
          return;
        }

        // Prepare CSV content
        const headers = ['Equipment Name', 'Serial Number', 'Category', 'Quantity', 'Min Stock', 'Status', 'Location', 'Description', 'Date Added', 'Last Updated'];
        const csvContent = [
          headers.join(','),
          ...equipmentData.map(equipment => [
            `"${equipment.name}"`,
            `"${equipment.serialNumber || ''}"`,
            `"${getCategoryLabel(equipment.category)}"`,
            equipment.quantity,
            equipment.minStock || 0,
            `"${getEquipmentStatus(equipment)}"`,
            `"${getLocationLabel(equipment.location)}"`,
            `"${equipment.description || ''}"`,
            `"${equipment.dateAdded}"`,
            `"${equipment.lastUpdated}"`
          ].join(','))
        ].join('\n');

        // Create and download file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `equipment_inventory_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('Inventory report downloaded successfully!', 'success');
      }

      function showNotification(message, type = 'info') {
        // Simple notification function (you can enhance this)
        const colors = {
          success: 'bg-green-500',
          error: 'bg-red-500',
          warning: 'bg-yellow-500',
          info: 'bg-blue-500'
        };

        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-[10000] transform transition-all duration-300`;
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.style.transform = 'translateX(400px)';
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        }, 3000);
      }

      // Daily Reports Functions
      
      // Helper function to get approval status badge
      function getApprovalStatusBadge(status) {
        const statusConfig = {
          'pending': { class: 'bg-yellow-100 text-yellow-800', text: 'Pending', icon: '‚è≥' },
          'approved': { class: 'bg-green-100 text-green-800', text: 'Approved', icon: '‚úÖ' },
          'rejected': { class: 'bg-red-100 text-red-800', text: 'Rejected', icon: '‚ùå' }
        };
        
        const config = statusConfig[status] || statusConfig['pending'];
        return `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${config.class}">
          <span class="mr-1">${config.icon}</span>
          ${config.text}
        </span>`;
      }
      
      // Helper function to get approval buttons
      function getApprovalButtons(status, reportId) {
        if (status === 'pending') {
          return `
            <button
              onclick="approveReport('${reportId}')"
              class="text-green-600 hover:text-green-800 transition-colors"
              title="Approve Report"
            >
              <i class="fas fa-check"></i>
            </button>
            <button
              onclick="rejectReport('${reportId}')"
              class="text-red-600 hover:text-red-800 transition-colors"
              title="Reject Report"
            >
              <i class="fas fa-times"></i>
            </button>
          `;
        } else if (status === 'approved') {
          return `
            <button
              onclick="rejectReport('${reportId}')"
              class="text-red-600 hover:text-red-800 transition-colors"
              title="Reject Report"
            >
              <i class="fas fa-times"></i>
            </button>
          `;
        } else if (status === 'rejected') {
          return `
            <button
              onclick="approveReport('${reportId}')"
              class="text-green-600 hover:text-green-800 transition-colors"
              title="Approve Report"
            >
              <i class="fas fa-check"></i>
            </button>
          `;
        }
        return '';
      }
      
      // Approval functions
      function approveReport(reportId) {
        Swal.fire({
          title: 'Approve Report?',
          text: 'This report will be marked as approved and the supervisor will be notified.',
          icon: 'question',
          showCancelButton: true,
          confirmButtonColor: '#10B981',
          cancelButtonColor: '#6B7280',
          confirmButtonText: 'Yes, Approve',
          cancelButtonText: 'Cancel'
        }).then((result) => {
          if (result.isConfirmed) {
            updateReportApprovalStatus(reportId, 'approved');
            Swal.fire({
              title: 'Report Approved!',
              text: 'The report has been approved and the supervisor has been notified.',
              icon: 'success',
              confirmButtonColor: '#10B981'
            });
          }
        });
      }
      
      function rejectReport(reportId) {
        Swal.fire({
          title: 'Reject Report?',
          text: 'This report will be marked as rejected and the supervisor will be notified.',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#EF4444',
          cancelButtonColor: '#6B7280',
          confirmButtonText: 'Yes, Reject',
          cancelButtonText: 'Cancel'
        }).then((result) => {
          if (result.isConfirmed) {
            updateReportApprovalStatus(reportId, 'rejected');
            Swal.fire({
              title: 'Report Rejected!',
              text: 'The report has been rejected and the supervisor has been notified.',
              icon: 'info',
              confirmButtonColor: '#EF4444'
            });
          }
        });
      }
      
      function updateReportApprovalStatus(reportId, status) {
        // Update CTIO reports
        const ctioReports = JSON.parse(localStorage.getItem('ctioReports') || '[]');
        const reportIndex = ctioReports.findIndex(r => r.id === reportId);
        
        if (reportIndex !== -1) {
          ctioReports[reportIndex].approvalStatus = status;
          ctioReports[reportIndex].approvalDate = new Date().toISOString().split('T')[0];
          ctioReports[reportIndex].approvedBy = 'CTIO Admin';
          localStorage.setItem('ctioReports', JSON.stringify(ctioReports));
        }
        
        // Update supervisor reports
        const supervisorReports = JSON.parse(localStorage.getItem('supervisorReports') || '[]');
        const supervisorReportIndex = supervisorReports.findIndex(r => r.id === reportId);
        
        if (supervisorReportIndex !== -1) {
          supervisorReports[supervisorReportIndex].approvalStatus = status;
          supervisorReports[supervisorReportIndex].approvalDate = new Date().toISOString().split('T')[0];
          supervisorReports[supervisorReportIndex].approvedBy = 'CTIO Admin';
          localStorage.setItem('supervisorReports', JSON.stringify(supervisorReports));
        }
        
        // Reload the reports display
        loadCtioReports();
      }
      
      function loadCtioReports() {
        const reports = JSON.parse(localStorage.getItem('ctioReports') || '[]');
        const tbody = document.getElementById('reportsTableBody');
        
        if (!tbody) return;

        if (reports.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                <div class="flex flex-col items-center">
                  <i class="fas fa-clipboard-list text-4xl text-gray-300 mb-3"></i>
                  <p class="text-lg font-medium">No reports available</p>
                  <p class="text-sm">Reports from supervisors will appear here once submitted</p>
                </div>
              </td>
            </tr>
          `;
          updateReportsStatistics();
          return;
        }

        tbody.innerHTML = reports.map(report => {
          const priorityColors = {
            'normal': 'bg-gray-100 text-gray-800',
            'high': 'bg-yellow-100 text-yellow-800',
            'urgent': 'bg-red-100 text-red-800'
          };

          const typeLabels = {
            'daily-operations': 'Daily Operations',
            'equipment-status': 'Equipment Status',
            'team-performance': 'Team Performance',
            'service-summary': 'Service Summary',
            'incident-report': 'Incident Report',
            'maintenance-log': 'Maintenance Log'
          };

          return `
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4">
                <div>
                  <div class="text-sm font-medium text-gray-900">${report.title}</div>
                  <div class="text-sm text-gray-500">ID: ${report.id}</div>
                  <div class="text-xs text-gray-400">By: ${report.submittedBy || 'Supervisor'}</div>
                </div>
              </td>
              <td class="px-6 py-4">
                <div class="flex flex-col space-y-1">
                  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                    ${typeLabels[report.type] || report.type}
                  </span>
                  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${priorityColors[report.priority]}">
                    ${report.priority.toUpperCase()}
                  </span>
                </div>
              </td>
              <td class="px-6 py-4 text-sm text-gray-900">
                <div>${report.date}</div>
                <div class="text-xs text-gray-500">${report.shift ? report.shift.replace('-', ' ').toUpperCase() : 'N/A'}</div>
              </td>
              <td class="px-6 py-4 text-sm text-gray-900">
                <div class="flex items-center space-x-2">
                  ${getApprovalStatusBadge(report.approvalStatus || 'pending')}
                  <div class="text-xs text-gray-500">
                    ${report.approvalDate ? `Approved: ${report.approvalDate}` : 'Pending Review'}
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 text-sm font-medium">
                <div class="flex space-x-2">
                  <button
                    onclick="viewCtioReport('${report.id}')"
                    class="text-blue-600 hover:text-blue-800 transition-colors"
                    title="View Details"
                  >
                    <i class="fas fa-eye"></i>
                  </button>
                  ${getApprovalButtons(report.approvalStatus || 'pending', report.id)}
                  <button
                    onclick="downloadReport('${report.id}')"
                    class="text-green-600 hover:text-green-800 transition-colors"
                    title="Download"
                  >
                    <i class="fas fa-download"></i>
                  </button>
                  <button
                    onclick="deleteReport('${report.id}')"
                    class="text-red-600 hover:text-red-800 transition-colors"
                    title="Delete"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');

        updateReportsStatistics();
      }

      function updateReportsStatistics() {
        const reports = JSON.parse(localStorage.getItem('ctioReports') || '[]');
        
        // Update count displays
        const totalReports = reports.length;
        document.getElementById('totalReportsCount').textContent = totalReports;
        document.getElementById('todayReportsCount').textContent = getTodayReportsCount(reports);
        document.getElementById('todayReportsCard').textContent = getTodayReportsCount(reports);
        document.getElementById('weekReportsCard').textContent = getWeekReportsCount(reports);
        document.getElementById('highPriorityReportsCard').textContent = getHighPriorityReportsCount(reports);
        document.getElementById('urgentReportsCard').textContent = getUrgentReportsCount(reports);
      }

      function getTodayReportsCount(reports) {
        const today = new Date().toISOString().split('T')[0];
        return reports.filter(report => report.date === today).length;
      }

      function getWeekReportsCount(reports) {
        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
        return reports.filter(report => new Date(report.date) >= oneWeekAgo).length;
      }

      function getHighPriorityReportsCount(reports) {
        return reports.filter(report => report.priority === 'high').length;
      }

      function getUrgentReportsCount(reports) {
        return reports.filter(report => report.priority === 'urgent').length;
      }

      function viewCtioReport(reportId) {
        const reports = JSON.parse(localStorage.getItem('ctioReports') || '[]');
        const report = reports.find(r => r.id === reportId);
        
        if (!report) return;

        const detailsHtml = `
          <div class="space-y-6">
            <div class="border-b border-gray-200 pb-4">
              <h3 class="text-xl font-semibold text-gray-900">${report.title}</h3>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-3 text-sm">
                <div>
                  <span class="font-medium text-gray-500">Report ID:</span>
                  <div class="text-gray-900">${report.id}</div>
                </div>
                <div>
                  <span class="font-medium text-gray-500">Date:</span>
                  <div class="text-gray-900">${report.date}</div>
                </div>
                <div>
                  <span class="font-medium text-gray-500">Type:</span>
                  <div class="text-gray-900">${report.type.replace('-', ' ').toUpperCase()}</div>
                </div>
                <div>
                  <span class="font-medium text-gray-500">Priority:</span>
                  <div class="text-gray-900">${report.priority.toUpperCase()}</div>
                </div>
                <div>
                  <span class="font-medium text-gray-500">Shift:</span>
                  <div class="text-gray-900">${report.shift.replace('-', ' ').toUpperCase()}</div>
                </div>
                <div>
                  <span class="font-medium text-gray-500">Submitted By:</span>
                  <div class="text-gray-900">${report.submittedBy}</div>
                </div>
                <div>
                  <span class="font-medium text-gray-500">Submitted:</span>
                  <div class="text-gray-900">${new Date(report.submittedAt).toLocaleString()}</div>
                </div>
              </div>
            </div>

            <div>
              <h4 class="text-lg font-medium text-gray-900 mb-3">Summary</h4>
              <div class="bg-gray-50 rounded-lg p-4">
                <p class="text-gray-700 whitespace-pre-wrap">${report.summary}</p>
              </div>
            </div>

            ${report.issues ? `
            <div>
              <h4 class="text-lg font-medium text-gray-900 mb-3">Issues Reported</h4>
              <div class="bg-red-50 rounded-lg p-4 border border-red-200">
                <p class="text-gray-700 whitespace-pre-wrap">${report.issues}</p>
              </div>
            </div>
            ` : ''}

            ${report.recommendations ? `
            <div>
              <h4 class="text-lg font-medium text-gray-900 mb-3">Recommendations</h4>
              <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                <p class="text-gray-700 whitespace-pre-wrap">${report.recommendations}</p>
              </div>
            </div>
            ` : ''}

            <div>
              <h4 class="text-lg font-medium text-gray-900 mb-3">Metrics</h4>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                  <div class="text-2xl font-bold text-green-700">${report.servicesCompleted || 'N/A'}</div>
                  <div class="text-sm text-green-600">Services Completed</div>
                </div>
                <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                  <div class="text-2xl font-bold text-blue-700">${report.ticketsResolved || 'N/A'}</div>
                  <div class="text-sm text-blue-600">Tickets Resolved</div>
                </div>
                <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
                  <div class="text-2xl font-bold text-purple-700">${report.teamMembersPresent || 'N/A'}</div>
                  <div class="text-sm text-purple-600">Team Members Present</div>
                </div>
              </div>
            </div>
          </div>
        `;

        document.getElementById('reportDetailContent').innerHTML = detailsHtml;
        document.getElementById('reportDetailModal').classList.remove('hidden');
      }

      function closeReportModal() {
        document.getElementById('reportDetailModal').classList.add('hidden');
      }

      function downloadReport(reportId) {
        const reports = JSON.parse(localStorage.getItem('ctioReports') || '[]');
        const report = reports.find(r => r.id === reportId);
        
        if (!report) return;

        const reportContent = `
DR.NET CTIO - Supervisor Report
===============================

Report ID: ${report.id}
Title: ${report.title}
Date: ${report.date}
Type: ${report.type.replace('-', ' ').toUpperCase()}
Shift: ${report.shift.replace('-', ' ').toUpperCase()}
Priority: ${report.priority.toUpperCase()}
Submitted By: ${report.submittedBy}
Submitted At: ${new Date(report.submittedAt).toLocaleString()}

SUMMARY
-------
${report.summary}

${report.issues ? `ISSUES REPORTED
---------------
${report.issues}

` : ''}${report.recommendations ? `RECOMMENDATIONS
---------------
${report.recommendations}

` : ''}METRICS
-------
Services Completed: ${report.servicesCompleted || 'N/A'}
Tickets Resolved: ${report.ticketsResolved || 'N/A'}
Team Members Present: ${report.teamMembersPresent || 'N/A'}

---
Report generated by DR.NET CTIO System
        `;

        const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `report_${report.id}_${report.date}.txt`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('Report downloaded successfully!', 'success');
      }

      function deleteReport(reportId) {
        if (confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
          let reports = JSON.parse(localStorage.getItem('ctioReports') || '[]');
          reports = reports.filter(r => r.id !== reportId);
          localStorage.setItem('ctioReports', JSON.stringify(reports));
          
          loadCtioReports();
          showNotification('Report deleted successfully!', 'success');
        }
      }

      function filterReports() {
        const searchTerm = document.getElementById('reportsSearch').value.toLowerCase();
        const typeFilter = document.getElementById('reportsTypeFilter').value;
        const priorityFilter = document.getElementById('reportsPriorityFilter').value;
        const dateFilter = document.getElementById('reportsDateFilter').value;
        
        const reports = JSON.parse(localStorage.getItem('ctioReports') || '[]');
        
        let filteredReports = reports.filter(report => {
          const matchesSearch = report.title.toLowerCase().includes(searchTerm) ||
                               report.type.toLowerCase().includes(searchTerm) ||
                               report.summary.toLowerCase().includes(searchTerm);
          
          const matchesType = !typeFilter || report.type === typeFilter;
          const matchesPriority = !priorityFilter || report.priority === priorityFilter;
          
          let matchesDate = true;
          if (dateFilter) {
            const reportDate = new Date(report.date);
            const today = new Date();
            
            switch (dateFilter) {
              case 'today':
                matchesDate = report.date === today.toISOString().split('T')[0];
                break;
              case 'yesterday':
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                matchesDate = report.date === yesterday.toISOString().split('T')[0];
                break;
              case 'week':
                const oneWeekAgo = new Date(today);
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                matchesDate = reportDate >= oneWeekAgo;
                break;
              case 'month':
                const oneMonthAgo = new Date(today);
                oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
                matchesDate = reportDate >= oneMonthAgo;
                break;
            }
          }

          return matchesSearch && matchesType && matchesPriority && matchesDate;
        });

        displayFilteredReports(filteredReports);
      }

      function displayFilteredReports(filteredReports) {
        const tbody = document.getElementById('reportsTableBody');
        
        if (filteredReports.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                <div class="flex flex-col items-center">
                  <i class="fas fa-search text-4xl text-gray-300 mb-3"></i>
                  <p class="text-lg font-medium">No reports found</p>
                  <p class="text-sm">Try adjusting your search criteria</p>
                </div>
              </td>
            </tr>
          `;
          return;
        }

        // Reuse the same rendering logic as loadCtioReports
        const priorityColors = {
          'normal': 'bg-gray-100 text-gray-800',
          'high': 'bg-yellow-100 text-yellow-800',
          'urgent': 'bg-red-100 text-red-800'
        };

        const typeLabels = {
          'daily-operations': 'Daily Operations',
          'equipment-status': 'Equipment Status',
          'team-performance': 'Team Performance'
        };

        tbody.innerHTML = filteredReports.map(report => {
          return `
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4">
                <div>
                  <div class="text-sm font-medium text-gray-900">${report.title}</div>
                  <div class="text-sm text-gray-500">ID: ${report.id}</div>
                </div>
              </td>
              <td class="px-6 py-4">
                <div class="flex flex-col space-y-1">
                  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                    ${typeLabels[report.type] || report.type}
                  </span>
                  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${priorityColors[report.priority]}">
                    ${report.priority.toUpperCase()}
                  </span>
                </div>
              </td>
              <td class="px-6 py-4 text-sm text-gray-900">
                <div>${report.date}</div>
                <div class="text-xs text-gray-500">${report.shift.replace('-', ' ').toUpperCase()}</div>
              </td>
              <td class="px-6 py-4 text-sm text-gray-900">
                <div class="space-y-1">
                  ${report.servicesCompleted ? `<div>Services: ${report.servicesCompleted}</div>` : ''}
                  ${report.ticketsResolved ? `<div>Tickets: ${report.ticketsResolved}</div>` : ''}
                  ${report.teamMembersPresent ? `<div>Team: ${report.teamMembersPresent}</div>` : ''}
                </div>
              </td>
              <td class="px-6 py-4 text-sm font-medium">
                <div class="flex space-x-2">
                  <button
                    onclick="viewCtioReport('${report.id}')"
                    class="text-blue-600 hover:text-blue-800 transition-colors"
                    title="View Details"
                  >
                    <i class="fas fa-eye"></i>
                  </button>
                  <button
                    onclick="downloadReport('${report.id}')"
                    class="text-green-600 hover:text-green-800 transition-colors"
                    title="Download"
                  >
                    <i class="fas fa-download"></i>
                  </button>
                  <button
                    onclick="deleteReport('${report.id}')"
                    class="text-red-600 hover:text-red-800 transition-colors"
                    title="Delete"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      }
      // Tab Management - Enhanced with better visibility control
      function showTab(tabName) {
        try {
          console.log('üîÑ Switching to tab:', tabName);
          
          // Hide all sections FORCEFULLY with multiple methods
          const sections = [
            'invoicesSection', 'receiptsSection', 'payslipsSection', 
            'expensesSection', 'salesSection', 'equipmentSection', 
            'dailyReportsSection', 'staffAttendanceSection', 'analyticsSection'
          ];
          
          sections.forEach(sectionId => {
            const section = document.getElementById(sectionId);
            if (section) {
              // Multiple hiding methods to ensure it works
              section.classList.add('hidden', 'section-hidden');
              section.classList.remove('section-visible', 'section-active');
              section.style.display = 'none';
              section.style.visibility = 'hidden';
              section.style.opacity = '0';
              console.log('üëÅÔ∏è Hiding section:', sectionId);
            } else {
              console.warn('‚ö†Ô∏è Section not found:', sectionId);
            }
          });

          // Remove active class from all tabs
          const tabs = document.querySelectorAll('.tab-button');
          tabs.forEach(tab => {
            tab.classList.remove('bg-gradient-to-r', 'from-blue-600', 'to-purple-600', 'text-white', 'shadow-lg', 'from-indigo-600');
            tab.classList.add('bg-white/80', 'text-gray-700');
          });

          // Show selected section with multiple methods
          const targetSection = document.getElementById(tabName + 'Section');
          if (targetSection) {
            // Multiple showing methods to ensure it works
            targetSection.classList.remove('hidden', 'section-hidden');
            targetSection.classList.add('section-visible', 'section-active');
            targetSection.style.display = 'block';
            targetSection.style.visibility = 'visible';
            targetSection.style.opacity = '1';
            
            // Force a reflow to ensure the change takes effect
            targetSection.offsetHeight;
            
            console.log('‚úÖ Showing section:', tabName + 'Section');
            console.log('Section classes:', targetSection.className);
            console.log('Section style.display:', targetSection.style.display);
          } else {
            console.error('‚ùå Target section not found:', tabName + 'Section');
          }

          // Activate selected tab
          const activeTab = document.getElementById(tabName + 'Tab');
          if (activeTab) {
            activeTab.classList.remove('bg-white/80', 'text-gray-700');
            activeTab.classList.add('bg-gradient-to-r', 'from-indigo-600', 'to-purple-600', 'text-white', 'shadow-lg');
            console.log('Activated tab:', tabName + 'Tab');
          } else {
            console.error('Active tab not found:', tabName + 'Tab');
          }

          // Scroll to the top of the section to ensure visibility
          setTimeout(() => {
            if (targetSection) {
              targetSection.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start',
                inline: 'nearest'
              });
            }
            // Also scroll the main content to top
            const mainContent = document.querySelector('main');
            if (mainContent) {
              mainContent.scrollTop = 0;
            }
          }, 100);

          // Load specific data for each tab
          switch (tabName) {
            case 'invoices':
              loadClients();
              console.log('Loading invoices section');
              break;
            case 'receipts':
              loadReceiptData();
              updateReceiptSummary();
              clearReceiptForm();
              break;
            case 'payslips':
              loadStaffForPayslips();
              populatePayPeriodDropdown();
              clearPayslipForm();
              console.log('Loading payslips section');
              break;
            case 'expenses':
              loadExpenseData();
              updateExpenseSummary();
              clearExpenseForm();
              console.log('Loading expenses section');
              break;
            case 'sales':
              // Load sales data if needed
              console.log('Loading sales section');
              break;
            case 'equipment':
              loadEquipmentData();
              updateEquipmentStats();
              break;
            case 'dailyReports':
              loadCtioReports();
              break;

            case 'staffAttendance':
              loadAttendanceData();
              updateAttendanceStats();
              break;
            case 'analytics':
              // Load analytics data if needed
              console.log('Loading analytics section');
              break;
            default:
              console.log('Unknown tab:', tabName);
          }
        } catch (error) {
          console.error('Error in showTab function:', error);
          alert('An error occurred while switching tabs. Please check the console for details.');
        }
      }

      // Debug function to test all sections
      function debugAllSections() {
        const sections = [
          'invoicesSection', 'receiptsSection', 'payslipsSection', 
          'expensesSection', 'salesSection', 'equipmentSection', 
          'dailyReportsSection', 'staffAttendanceSection', 'analyticsSection'
        ];
        
        console.log('=== DEBUGGING ALL SECTIONS ===');
        sections.forEach(sectionId => {
          const section = document.getElementById(sectionId);
          if (section) {
            console.log(`‚úÖ Section ${sectionId}:`, {
              exists: true,
              classes: section.className,
              display: section.style.display,
              visibility: section.style.visibility,
              opacity: section.style.opacity,
              offsetHeight: section.offsetHeight,
              hasContent: section.innerHTML.length > 100
            });
          } else {
            console.log(`‚ùå Section ${sectionId}: NOT FOUND`);
          }
        });
        console.log('=== END DEBUGGING ===');
      }

      // Test function to cycle through tabs
      function testAllTabs() {
        const tabs = ['invoices', 'receipts', 'payslips', 'expenses', 'sales', 'equipment', 'dailyReports', 'analytics'];
        let index = 0;
        
        const cycle = () => {
          if (index < tabs.length) {
            console.log(`Testing tab: ${tabs[index]}`);
            showTab(tabs[index]);
            index++;
            setTimeout(cycle, 2000);
          } else {
            console.log('Finished testing all tabs');
          }
        };
        
        cycle();
      }

       // Comprehensive diagnostic function
       function runFullDiagnostic() {
         console.log('üîç RUNNING FULL DIAGNOSTIC...');
         
         // Check if DOM is ready
         console.log('üìã DOM Ready State:', document.readyState);
         
         // Check if all required elements exist
         const requiredElements = [
           'invoicesTab', 'receiptsTab', 'payslipsTab', 'expensesTab', 
           'salesTab', 'equipmentTab', 'dailyReportsTab', 'analyticsTab',
           'invoicesSection', 'receiptsSection', 'payslipsSection', 
           'expensesSection', 'salesSection', 'equipmentSection', 
           'dailyReportsSection', 'analyticsSection'
         ];
         
         console.log('üîç Checking required elements...');
         requiredElements.forEach(id => {
           const element = document.getElementById(id);
           console.log(`${element ? '‚úÖ' : '‚ùå'} ${id}:`, element ? 'Found' : 'NOT FOUND');
         });
         
         // Check CSS classes
         console.log('üé® Checking CSS classes...');
         const testSection = document.getElementById('invoicesSection');
         if (testSection) {
           console.log('invoicesSection classes:', testSection.className);
           console.log('invoicesSection computed style:', window.getComputedStyle(testSection).display);
         }
         
         // Test tab click manually
         console.log('üñ±Ô∏è Testing manual tab click...');
         const invoicesTab = document.getElementById('invoicesTab');
         if (invoicesTab) {
           console.log('invoicesTab found, testing click...');
           invoicesTab.click();
         }
         
         // Check for JavaScript errors
         console.log('‚ö†Ô∏è Checking for JavaScript errors...');
         window.addEventListener('error', function(e) {
           console.error('JavaScript Error:', e.error);
         });
         
         console.log('‚úÖ DIAGNOSTIC COMPLETE');
       }
       
       // Test modal visibility
       function testModalVisibility() {
         console.log('üß™ Testing modal visibility...');
         
         // Test report detail modal
         const reportModal = document.getElementById('reportDetailModal');
         if (reportModal) {
           console.log('Report Modal found, testing visibility...');
           reportModal.classList.remove('hidden');
           setTimeout(() => {
             reportModal.classList.add('hidden');
             console.log('Report Modal test completed');
           }, 3000);
         }
         
         // Test equipment modal
         const equipmentModal = document.getElementById('addEquipmentModal');
         if (equipmentModal) {
           console.log('Equipment Modal found, testing visibility...');
           equipmentModal.classList.remove('hidden');
           setTimeout(() => {
             equipmentModal.classList.add('hidden');
             console.log('Equipment Modal test completed');
           }, 3000);
         }
       }
       
       // Debug function to check for layout issues
       function debugLayoutIssues() {
         console.log('=== LAYOUT DEBUGGING ===');
         
         const main = document.querySelector('main');
         const reportsSection = document.getElementById('reports-finance');
         const body = document.body;
         
         console.log('Main element:', {
           height: main?.offsetHeight,
           scrollHeight: main?.scrollHeight,
           scrollTop: main?.scrollTop,
           classes: main?.className
         });
         
         console.log('Reports section:', {
           height: reportsSection?.offsetHeight,
           scrollHeight: reportsSection?.scrollHeight,
           classes: reportsSection?.className
         });
         
         console.log('Body:', {
           height: body.offsetHeight,
           scrollHeight: body.scrollHeight,
           scrollTop: body.scrollTop
         });
         
         console.log('Window:', {
           innerHeight: window.innerHeight,
           scrollY: window.scrollY
         });
         
         // Check for any fixed/sticky elements that might be overlapping
         const fixedElements = Array.from(document.querySelectorAll('*')).filter(el => {
           const style = window.getComputedStyle(el);
           return style.position === 'fixed' || style.position === 'sticky';
         });
         
         console.log('Fixed/Sticky elements:', fixedElements.map(el => ({
           tag: el.tagName,
           id: el.id,
           classes: el.className,
           zIndex: window.getComputedStyle(el).zIndex
         })));
         
         console.log('=== END LAYOUT DEBUGGING ===');
       }

       // Make debug functions globally available
       window.debugAllSections = debugAllSections;
       window.testAllTabs = testAllTabs;
       window.showTab = showTab;
       window.runFullDiagnostic = runFullDiagnostic;
       window.testModalVisibility = testModalVisibility;
       window.debugLayoutIssues = debugLayoutIssues;



      // Staff Attendance Functions for CTIO Dashboard
      function loadAttendanceData() {
        try {
          const attendanceData = JSON.parse(localStorage.getItem('attendanceData') || '[]');
          const tableBody = document.getElementById('attendanceTableBody');
          
          if (!tableBody) return;
          
          if (attendanceData.length === 0) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="7" class="px-4 py-12 text-center text-gray-500">
                  <div class="flex flex-col items-center">
                    <i class="fas fa-users text-5xl text-gray-300 mb-4"></i>
                    <p class="text-xl font-medium text-gray-400">No attendance records</p>
                    <p class="text-sm text-gray-400">Attendance data will appear here when supervisors mark staff attendance</p>
                  </div>
                </td>
              </tr>
            `;
            return;
          }

          // Sort by date and time (newest first)
          attendanceData.sort((a, b) => {
            const dateCompare = new Date(b.date) - new Date(a.date);
            if (dateCompare !== 0) return dateCompare;
            return (b.arrivalTime || '').localeCompare(a.arrivalTime || '');
          });

          tableBody.innerHTML = attendanceData.map(record => {
            const statusBadge = getStatusBadge(record.status);
            const formattedDate = new Date(record.date).toLocaleDateString();
            const formattedTime = formatTime(record.arrivalTime);
            
            return `
              <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-4 py-3">
                  <div>
                    <div class="font-medium text-gray-900">${record.staffName || 'N/A'}</div>
                    <div class="text-sm text-gray-500">${record.staffId || 'N/A'}</div>
                  </div>
                </td>
                <td class="px-4 py-3">
                  <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-indigo-100 text-indigo-800">
                    ${(record.department || '').replace('-', ' ').toUpperCase()}
                  </span>
                </td>
                <td class="px-4 py-3 text-sm text-gray-900">${formattedDate}</td>
                <td class="px-4 py-3 text-sm text-gray-900">${formattedTime}</td>
                <td class="px-4 py-3">${statusBadge}</td>
                <td class="px-4 py-3 text-sm text-gray-600">${record.recordedBy || 'System'}</td>
                <td class="px-4 py-3 text-sm text-gray-500">${record.notes || '-'}</td>
              </tr>
            `;
          }).join('');
          
          // Update department breakdown
          updateDepartmentBreakdown(attendanceData);
        } catch (error) {
          console.error('Error loading attendance data:', error);
        }
      }

      function getStatusBadge(status) {
        const badges = {
          'present': '<span class="inline-flex px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800"><i class="fas fa-check-circle mr-1"></i>Present</span>',
          'absent': '<span class="inline-flex px-3 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800"><i class="fas fa-times-circle mr-1"></i>Absent</span>',
          'permission': '<span class="inline-flex px-3 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800"><i class="fas fa-clock mr-1"></i>On Permission</span>',
          'off': '<span class="inline-flex px-3 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800"><i class="fas fa-calendar-alt mr-1"></i>On Off</span>'
        };
        return badges[status] || badges['absent'];
      }

      function formatTime(timeString) {
        if (!timeString) return 'N/A';
        try {
          const [hours, minutes] = timeString.split(':');
          const hour12 = hours % 12 || 12;
          const ampm = hours >= 12 ? 'PM' : 'AM';
          return `${hour12}:${minutes} ${ampm}`;
        } catch (error) {
          return timeString;
        }
      }

      function updateAttendanceStats() {
        try {
          const attendanceData = JSON.parse(localStorage.getItem('attendanceData') || '[]');
          const today = new Date().toISOString().split('T')[0];
          
          // Filter today's records
          const todayRecords = attendanceData.filter(record => record.date === today);
          
          // Count by status
          const stats = {
            present: todayRecords.filter(r => r.status === 'present').length,
            absent: todayRecords.filter(r => r.status === 'absent').length,
            permission: todayRecords.filter(r => r.status === 'permission').length,
            off: todayRecords.filter(r => r.status === 'off').length
          };
          
          // Calculate attendance rate
          const totalStaff = 8; // Adjust based on actual staff count
          const attendanceRate = totalStaff > 0 ? Math.round((stats.present / totalStaff) * 100) : 0;
          
          // Update UI elements safely
          const updateElement = (id, value) => {
            const element = document.getElementById(id);
            if (element) element.textContent = value;
          };
          
          updateElement('totalPresent', stats.present);
          updateElement('totalAbsent', stats.absent);
          updateElement('totalPermission', stats.permission);
          updateElement('totalOff', stats.off);
          updateElement('attendanceRate', attendanceRate + '%');
          updateElement('totalStaffCount', totalStaff);
          
        } catch (error) {
          console.error('Error updating attendance stats:', error);
        }
      }

      function updateDepartmentBreakdown(attendanceData) {
        try {
          const today = new Date().toISOString().split('T')[0];
          const todayRecords = attendanceData.filter(record => record.date === today);
          
          // Department staff counts (adjust as needed)
          const departmentTotals = {
            technical: 3,
            installation: 1,
            'customer-service': 3,
            maintenance: 1
          };
          
          // Count present staff by department
          const departmentPresent = {};
          Object.keys(departmentTotals).forEach(dept => {
            departmentPresent[dept] = todayRecords.filter(r => 
              r.department === dept && r.status === 'present'
            ).length;
          });
          
          // Update UI elements safely
          const updateElement = (id, value) => {
            const element = document.getElementById(id);
            if (element) element.textContent = value;
          };
          
          updateElement('technicalAttendance', `${departmentPresent.technical}/${departmentTotals.technical}`);
          updateElement('installationAttendance', `${departmentPresent.installation}/${departmentTotals.installation}`);
          updateElement('customerServiceAttendance', `${departmentPresent['customer-service']}/${departmentTotals['customer-service']}`);
          updateElement('maintenanceAttendance', `${departmentPresent.maintenance}/${departmentTotals.maintenance}`);
          
        } catch (error) {
          console.error('Error updating department breakdown:', error);
        }
      }

      function filterAttendance() {
        try {
          const searchTerm = (document.getElementById('attendanceSearch')?.value || '').toLowerCase();
          const statusFilter = document.getElementById('attendanceStatusFilter')?.value || '';
          const dateFilter = document.getElementById('attendanceDateFilter')?.value || '';
          const departmentFilter = document.getElementById('attendanceDepartmentFilter')?.value || '';
          
          const attendanceData = JSON.parse(localStorage.getItem('attendanceData') || '[]');
          
          let filteredData = attendanceData.filter(record => {
            const matchesSearch = (record.staffName || '').toLowerCase().includes(searchTerm) || 
                                 (record.staffId || '').toLowerCase().includes(searchTerm);
            const matchesStatus = !statusFilter || record.status === statusFilter;
            const matchesDate = !dateFilter || record.date === dateFilter;
            const matchesDepartment = !departmentFilter || record.department === departmentFilter;
            
            return matchesSearch && matchesStatus && matchesDate && matchesDepartment;
          });
          
          // Update table with filtered data
          const tableBody = document.getElementById('attendanceTableBody');
          if (!tableBody) return;
          
          if (filteredData.length === 0) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="7" class="px-4 py-12 text-center text-gray-500">
                  <div class="flex flex-col items-center">
                    <i class="fas fa-search text-4xl text-gray-300 mb-3"></i>
                    <p class="text-lg font-medium">No matching records</p>
                    <p class="text-sm">Try adjusting your filters</p>
                  </div>
                </td>
              </tr>
            `;
            return;
          }

          // Sort filtered data
          filteredData.sort((a, b) => {
            const dateCompare = new Date(b.date) - new Date(a.date);
            if (dateCompare !== 0) return dateCompare;
            return (b.arrivalTime || '').localeCompare(a.arrivalTime || '');
          });

          tableBody.innerHTML = filteredData.map(record => {
            const statusBadge = getStatusBadge(record.status);
            const formattedDate = new Date(record.date).toLocaleDateString();
            const formattedTime = formatTime(record.arrivalTime);
            
            return `
              <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-4 py-3">
                  <div>
                    <div class="font-medium text-gray-900">${record.staffName || 'N/A'}</div>
                    <div class="text-sm text-gray-500">${record.staffId || 'N/A'}</div>
                  </div>
                </td>
                <td class="px-4 py-3">
                  <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-indigo-100 text-indigo-800">
                    ${(record.department || '').replace('-', ' ').toUpperCase()}
                  </span>
                </td>
                <td class="px-4 py-3 text-sm text-gray-900">${formattedDate}</td>
                <td class="px-4 py-3 text-sm text-gray-900">${formattedTime}</td>
                <td class="px-4 py-3">${statusBadge}</td>
                <td class="px-4 py-3 text-sm text-gray-600">${record.recordedBy || 'System'}</td>
                <td class="px-4 py-3 text-sm text-gray-500">${record.notes || '-'}</td>
              </tr>
            `;
          }).join('');
        } catch (error) {
          console.error('Error filtering attendance:', error);
        }
      }

      function exportAttendance() {
        try {
          const attendanceData = JSON.parse(localStorage.getItem('attendanceData') || '[]');
          
          if (attendanceData.length === 0) {
            alert('No attendance data to export');
            return;
          }

          // Create CSV content
          const headers = ['Staff ID', 'Staff Name', 'Department', 'Date', 'Arrival Time', 'Status', 'Recorded By', 'Notes', 'Recorded At'];
          const csvContent = [
            headers.join(','),
            ...attendanceData.map(record => [
              record.staffId || '',
              `"${record.staffName || ''}"`,
              record.department || '',
              record.date || '',
              record.arrivalTime || '',
              record.status || '',
              record.recordedBy || 'System',
              `"${record.notes || ''}"`,
              record.recordedAt ? new Date(record.recordedAt).toLocaleString() : ''
            ].join(','))
          ].join('\n');

          // Download file
          const blob = new Blob([csvContent], { type: 'text/csv' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.setAttribute('hidden', '');
          a.setAttribute('href', url);
          a.setAttribute('download', `staff-attendance-${new Date().toISOString().split('T')[0]}.csv`);
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          
          // Show success notification
          setTimeout(() => {
            alert('Attendance data exported successfully!');
          }, 100);
        } catch (error) {
          console.error('Error exporting attendance:', error);
          alert('Error exporting attendance data');
        }
      }

      function refreshAttendance() {
        try {
          loadAttendanceData();
          updateAttendanceStats();

          // Show refresh animation
          const button = document.getElementById('refreshAttendanceBtn');
          if (button) {
            const originalContent = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check mr-1"></i>';
            button.classList.add('bg-green-600');

            setTimeout(() => {
              button.innerHTML = originalContent;
              button.classList.remove('bg-green-600');
            }, 1000);
          }
        } catch (error) {
          console.error('Error refreshing attendance:', error);
        }
      }

      function generateAttendanceReport() {
        alert('Generating comprehensive attendance report... This feature will provide detailed analytics and trends.');
      }

      // Invoice and SMS Template Functions (placeholders for missing onclick handlers)
      // Client Invoice Functions
      let invoiceItems = [];
      let invoiceNumber = 1;

      function loadClients() {
        try {
          const clients = JSON.parse(localStorage.getItem('clientsData') || '[]');
          const selectElement = document.getElementById('invoiceUser');
          
          if (selectElement) {
            selectElement.innerHTML = '<option value="">Choose a client...</option>';
            clients.forEach(client => {
              const option = document.createElement('option');
              option.value = JSON.stringify(client);
              option.textContent = `${client.fullName} - ${client.phoneNumber}`;
              selectElement.appendChild(option);
            });
          }
        } catch (error) {
          console.error('Error loading clients:', error);
        }
      }

      function addInvoiceItem() {
        const description = prompt('Enter service description:');
        const amount = parseFloat(prompt('Enter amount:'));
        
        if (description && !isNaN(amount) && amount > 0) {
          invoiceItems.push({
            id: Date.now(),
            description,
            amount,
            date: new Date().toISOString().split('T')[0]
          });
          updateInvoicePreview();
        }
      }

      function removeInvoiceItem(itemId) {
        invoiceItems = invoiceItems.filter(item => item.id !== itemId);
        updateInvoicePreview();
      }

      function updateInvoicePreview() {
        const previewDiv = document.getElementById('invoicePreview');
        if (!previewDiv) return;
        
        if (invoiceItems.length === 0) {
          previewDiv.classList.add('hidden');
          return;
        }

        const total = invoiceItems.reduce((sum, item) => sum + item.amount, 0);
        
        previewDiv.innerHTML = `
          <h5 class="font-semibold text-gray-800 mb-4">Invoice Preview</h5>
          <div class="space-y-2 mb-4">
            ${invoiceItems.map(item => `
              <div class="flex justify-between items-center p-3 bg-white rounded-lg">
                <div>
                  <span class="font-medium">${item.description}</span>
                  <span class="text-sm text-gray-500 ml-2">(${item.date})</span>
                </div>
                <div class="flex items-center space-x-3">
                  <span class="font-semibold">K${item.amount.toFixed(2)}</span>
                  <button onclick="removeInvoiceItem(${item.id})" class="text-red-500 hover:text-red-700">
                    <i class="fas fa-trash text-sm"></i>
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
          <div class="border-t pt-4">
            <div class="flex justify-between items-center font-semibold text-lg">
              <span>Total Amount:</span>
              <span class="text-green-600">K${total.toFixed(2)}</span>
            </div>
          </div>
          <div class="mt-4 flex space-x-3">
            <button onclick="addInvoiceItem()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
              <i class="fas fa-plus mr-2"></i>Add Item
            </button>
            <button onclick="clearInvoice()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
              <i class="fas fa-trash mr-2"></i>Clear All
            </button>
          </div>
        `;
        previewDiv.classList.remove('hidden');
      }

      function clearInvoice() {
        invoiceItems = [];
        updateInvoicePreview();
      }

      function generateInvoice() {
        try {
          const clientData = document.getElementById('invoiceUser')?.value;
          
          if (!clientData) {
            alert('Please select a client');
            return;
          }
          
          if (invoiceItems.length === 0) {
            alert('Please add at least one item to the invoice');
            return;
          }

          const client = JSON.parse(clientData);
          const total = invoiceItems.reduce((sum, item) => sum + item.amount, 0);
          const currentDate = new Date().toLocaleDateString();
          
          // Generate invoice data
          const invoiceData = {
            invoiceNumber: `INV-${String(invoiceNumber).padStart(4, '0')}`,
            date: currentDate,
            client,
            items: invoiceItems,
            total,
            generatedAt: new Date().toISOString()
          };
          
          // Save invoice to localStorage
          const invoices = JSON.parse(localStorage.getItem('invoicesData') || '[]');
          invoices.push(invoiceData);
          localStorage.setItem('invoicesData', JSON.stringify(invoices));
          
          // Generate PDF (simplified - you can integrate jsPDF here)
          const invoiceText = `
INVOICE ${invoiceData.invoiceNumber}
Date: ${currentDate}

Bill To:
${client.fullName}
${client.phoneNumber}
${client.address || ''}

Items:
${invoiceItems.map(item => `${item.description}: K${item.amount.toFixed(2)}`).join('\n')}

TOTAL: K${total.toFixed(2)}
          `;
          
          // Create downloadable text file (you can replace this with proper PDF generation)
          const blob = new Blob([invoiceText], { type: 'text/plain' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.setAttribute('hidden', '');
          a.setAttribute('href', url);
          a.setAttribute('download', `invoice-${invoiceData.invoiceNumber}.txt`);
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          
          invoiceNumber++;
          alert(`Invoice ${invoiceData.invoiceNumber} generated successfully!`);
          
          // Clear form
          clearInvoice();
          document.getElementById('invoiceUser').selectedIndex = 0;
          
        } catch (error) {
          console.error('Error generating invoice:', error);
          alert('Error generating invoice. Please try again.');
        }
      }

      function generateSMSTemplate(type) {
        const clientData = document.getElementById('invoiceUser')?.value;
        
        if (!clientData) {
          alert('Please select a client first');
          return;
        }
        
        const client = JSON.parse(clientData);
        const templates = {
          'invoice': `Dear ${client.fullName}, your invoice is ready for payment. Amount: K${invoiceItems.reduce((sum, item) => sum + item.amount, 0).toFixed(2)}. Please contact us for payment details. - Dr.Net Services`,
          'reminder': `Hi ${client.fullName}, this is a friendly reminder that your payment is due. Please settle your account to continue enjoying our services. - Dr.Net Services`,
          'confirmation': `Thank you ${client.fullName}! Your payment has been received and confirmed. Receipt will be sent shortly. - Dr.Net Services`
        };
        
        const smsText = templates[type] || 'Template not found';
        
        // Show SMS preview
        const previewDiv = document.getElementById('smsPreview');
        if (previewDiv) {
          previewDiv.innerHTML = `
            <h5 class="font-semibold text-gray-800 mb-3">${type.charAt(0).toUpperCase() + type.slice(1)} SMS Preview</h5>
            <div class="p-4 bg-white rounded-lg border-2 border-gray-200">
              <p class="text-gray-800">${smsText}</p>
            </div>
            <div class="mt-4 flex space-x-3">
              <button onclick="copySMSTemplate('${smsText}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                <i class="fas fa-copy mr-2"></i>Copy SMS
              </button>
              <button onclick="sendSMS('${client.phoneNumber}', '${smsText}')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                <i class="fas fa-paper-plane mr-2"></i>Send SMS
              </button>
            </div>
          `;
          previewDiv.classList.remove('hidden');
        }
      }

      function copySMSTemplate(text) {
        navigator.clipboard.writeText(text).then(() => {
          alert('SMS text copied to clipboard!');
        }).catch(err => {
          console.error('Error copying to clipboard:', err);
          alert('Error copying to clipboard');
        });
      }

      function sendSMS(phoneNumber, message) {
        alert(`SMS would be sent to ${phoneNumber}:\n\n${message}\n\n(SMS integration not configured)`);
      }

      function generatePayslipSMS() {
        alert('Payslip SMS notification will be implemented here');
      }

      // New function to handle payslip action button
      function handlePayslipAction() {
        const staffData = document.getElementById('payslipStaff')?.value;
        const payPeriod = document.getElementById('payPeriod')?.value;
        
        if (!staffData || !payPeriod) {
          alert('Please select both staff member and pay period');
          return;
        }

        // Activate payslip for the selected staff member
        activatePayslipForStaff(staffData, payPeriod);
      }

      // Function to activate payslip for staff member
      function activatePayslipForStaff(staffId, payPeriod) {
        try {
          // Get staff data
          const staff = JSON.parse(staffId);
          const period = getPayPeriodText(payPeriod);
          
          // Store activated payslip in localStorage for the staff member
          const payslipData = {
            staffId: staff.id,
            staffName: staff.fullName,
            staffRole: staff.role,
            payPeriod: period,
            basicSalary: staff.basicSalary || 45000, // Use staff's actual salary
            netSalary: staff.basicSalary || 45000, // Same as basic salary (no deductions)
            activatedBy: 'CTIO',
            activatedDate: new Date().toISOString(),
            status: 'active',
            // Link directly to the selected staff member
            staffUserId: staff.id, // Staff member's user ID
            staffUserName: staff.fullName, // Staff member's name
            staffUserRole: staff.role // Staff member's role
          };

          // Store in localStorage with staff-specific key
          const payslipKey = `payslip_${staff.id}_${period.replace(/\s+/g, '_').toLowerCase()}`;
          localStorage.setItem(payslipKey, JSON.stringify(payslipData));

          // Store in staff-specific payslips list
          let staffPayslips = JSON.parse(localStorage.getItem('staffPayslips') || '[]');
          staffPayslips.push(payslipData);
          localStorage.setItem('staffPayslips', JSON.stringify(staffPayslips));

          // Also add to general payslips list for backup
          let activatedPayslips = JSON.parse(localStorage.getItem('activatedPayslips') || '[]');
          activatedPayslips.push(payslipData);
          localStorage.setItem('activatedPayslips', JSON.stringify(activatedPayslips));

          // Show success message
          Swal.fire({
            title: 'Payslip Activated!',
            text: `Payslip for ${staff.fullName} (${period}) has been activated and linked to their dashboard. They can now view and download it from their staff portal.`,
            icon: 'success',
            confirmButtonText: 'OK'
          });

          // Reset button state
          resetPayslipActionButton();

        } catch (error) {
          console.error('Error activating payslip:', error);
          alert('Error activating payslip. Please try again.');
        }
      }

      // Function to get pay period text
      function getPayPeriodText(period) {
        // Handle new month format (YYYY-MM, e.g., 2024-01, 2024-12, etc.)
        if (period && period.match(/^\d{4}-\d{2}$/)) {
          const [year, month] = period.split('-');
          const monthNames = [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
          ];
          const monthIndex = parseInt(month) - 1;
          return `${monthNames[monthIndex]} ${year}`;
        }
        
        // Legacy format handling (for backward compatibility)
        const currentDate = new Date();
        const currentMonth = currentDate.toLocaleString('default', { month: 'long' });
        const currentYear = currentDate.getFullYear();
        
        switch(period) {
          case 'current':
            return `${currentMonth} ${currentYear}`;
          case 'previous':
            const prevDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1);
            const prevMonth = prevDate.toLocaleString('default', { month: 'long' });
            return `${prevMonth} ${prevDate.getFullYear()}`;
          case 'custom':
            const fromDate = document.getElementById('payslipFromDate')?.value;
            const toDate = document.getElementById('payslipToDate')?.value;
            if (fromDate && toDate) {
              return `${fromDate} to ${toDate}`;
            }
            return 'Custom Period';
          default:
            return period;
        }
      }

      // Function to reset payslip action button
      function resetPayslipActionButton() {
        const button = document.getElementById('payslipActionButton');
        button.disabled = true;
        button.className = 'flex-1 bg-gradient-to-r from-gray-400 to-gray-500 text-white py-4 rounded-xl font-semibold transition-all duration-300 transform hover:-translate-y-1 cursor-not-allowed';
        button.innerHTML = '<span class="mr-2">‚úÖ</span> Activate Payslip';
      }

      // Function to check if payslip form is completed and update button
      function checkPayslipFormCompletion() {
        const staffData = document.getElementById('payslipStaff')?.value;
        const payPeriod = document.getElementById('payPeriod')?.value;
        const button = document.getElementById('payslipActionButton');
        
        if (staffData && payPeriod) {
          // Both fields are selected, enable the button and change to "Activate"
          button.disabled = false;
          button.className = 'flex-1 bg-gradient-to-r from-green-600 to-blue-600 text-white py-4 rounded-xl font-semibold hover:from-green-700 hover:to-blue-700 transition-all duration-300 transform hover:-translate-y-1';
          button.innerHTML = '<span class="mr-2">‚úÖ</span> Activate Payslip';
        } else {
          // One or both fields are missing, disable the button
          button.disabled = true;
          button.className = 'flex-1 bg-gradient-to-r from-gray-400 to-gray-500 text-white py-4 rounded-xl font-semibold transition-all duration-300 transform hover:-translate-y-1 cursor-not-allowed';
          button.innerHTML = '<span class="mr-2">‚úÖ</span> Activate Payslip';
        }
      }

      function copyPayslipSMS() {
        alert('Copy payslip SMS to clipboard functionality will be implemented here');
      }

      function generateBulkPayslips() {
        alert('Bulk payslip generation functionality will be implemented here');
      }

      function generateBulkPayslipSMS() {
        alert('Bulk payslip SMS functionality will be implemented here');
      }

      // Receipt Management Functions
      // Payment Receipt Functions
      let receiptNumber = 1;

      function clearReceiptForm() {
        const form = document.getElementById('receiptForm');
        if (form) {
          form.reset();
          // Set today's date as default
          const today = new Date().toISOString().split('T')[0];
          const dateField = document.getElementById('receiptDate');
          if (dateField) dateField.value = today;
        }
      }

      function recordReceipt(event) {
        event.preventDefault();
        
        const form = document.getElementById('receiptForm');
        if (!form || !form.checkValidity()) {
          if (form) form.reportValidity();
          return;
        }

        try {
          const receiptData = {
            id: Date.now().toString(),
            receiptNumber: `REC-${String(receiptNumber).padStart(4, '0')}`,
            client: document.getElementById('receiptClient').value,
            amount: parseFloat(document.getElementById('receiptAmount').value),
            date: document.getElementById('receiptDate').value,
            paymentMethod: document.getElementById('receiptPaymentMethod').value,
            reference: document.getElementById('receiptReference').value || 'N/A',
            servicePeriod: document.getElementById('receiptServicePeriod').value || 'N/A',
            notes: document.getElementById('receiptNotes').value || '',
            timestamp: new Date().toISOString()
          };

          // Save to localStorage
          let receipts = JSON.parse(localStorage.getItem('paymentReceipts') || '[]');
          receipts.push(receiptData);
          localStorage.setItem('paymentReceipts', JSON.stringify(receipts));

          receiptNumber++;

          // Clear form and show success message
          clearReceiptForm();
          alert(`Payment receipt ${receiptData.receiptNumber} recorded successfully!`);
          
          // Refresh display
          loadReceiptData();
          updateReceiptSummary();
        } catch (error) {
          console.error('Error recording receipt:', error);
          alert('Error recording receipt. Please try again.');
        }
      }

      function loadReceiptData() {
        try {
          const receipts = JSON.parse(localStorage.getItem('paymentReceipts') || '[]');
          const tableBody = document.getElementById('receiptTableBody');
          const noReceipts = document.getElementById('noReceipts');
          
          if (!tableBody) return;
          
          if (receipts.length === 0) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                  <div class="flex flex-col items-center">
                    <i class="fas fa-receipt text-4xl text-gray-300 mb-3"></i>
                    <p class="text-lg font-medium">No payment receipts recorded</p>
                    <p class="text-sm">Start by recording your first payment receipt</p>
                  </div>
                </td>
              </tr>
            `;
            if (noReceipts) noReceipts.classList.remove('hidden');
            return;
          }

          if (noReceipts) noReceipts.classList.add('hidden');

          // Sort receipts by date (newest first)
          receipts.sort((a, b) => new Date(b.date) - new Date(a.date));

          tableBody.innerHTML = receipts.map(receipt => `
            <tr class="hover:bg-gray-50 transition-colors">
              <td class="px-4 py-3 text-sm text-gray-900">${new Date(receipt.date).toLocaleDateString()}</td>
              <td class="px-4 py-3 text-sm font-medium text-gray-900">${receipt.receiptNumber || receipt.id.substr(-4)}</td>
              <td class="px-4 py-3 text-sm text-gray-900">${receipt.client}</td>
              <td class="px-4 py-3 text-sm text-gray-600">${receipt.paymentMethod}</td>
              <td class="px-4 py-3 text-sm text-gray-600">${receipt.servicePeriod}</td>
              <td class="px-4 py-3 text-sm font-semibold text-right text-green-600">KES ${receipt.amount.toFixed(2)}</td>
              <td class="px-4 py-3 text-center">
                <div class="flex justify-center space-x-2">
                  <button onclick="viewReceiptModal('${receipt.id}')" class="text-blue-600 hover:text-blue-800 transition-colors p-2 rounded-lg hover:bg-blue-50" title="View Receipt">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button onclick="generateReceiptPDF('${receipt.id}')" class="text-purple-600 hover:text-purple-800 transition-colors p-2 rounded-lg hover:bg-purple-50" title="Generate PDF">
                    <i class="fas fa-file-pdf"></i>
                  </button>
                  <button onclick="deleteReceipt('${receipt.id}')" class="text-red-600 hover:text-red-800 transition-colors p-2 rounded-lg hover:bg-red-50" title="Delete Receipt">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          `).join('');
          
          // Update filter dropdown
          updateReceiptFilters(receipts);
        } catch (error) {
          console.error('Error loading receipt data:', error);
        }
      }

      function updateReceiptSummary() {
        try {
          const receipts = JSON.parse(localStorage.getItem('paymentReceipts') || '[]');
          const today = new Date().toISOString().split('T')[0];
          const thisMonth = new Date().toISOString().substr(0, 7); // YYYY-MM
          const thisYear = new Date().getFullYear().toString();

          // Calculate totals
          const todayTotal = receipts
            .filter(r => r.date === today)
            .reduce((sum, r) => sum + r.amount, 0);

          const monthlyTotal = receipts
            .filter(r => r.date.startsWith(thisMonth))
            .reduce((sum, r) => sum + r.amount, 0);

          const yearlyTotal = receipts
            .filter(r => r.date.startsWith(thisYear))
            .reduce((sum, r) => sum + r.amount, 0);

          // Update UI
          const updateElement = (id, value) => {
            const element = document.getElementById(id);
            if (element) element.textContent = value;
          };

          updateElement('todayPayments', `KES ${todayTotal.toFixed(2)}`);
          updateElement('monthlyPayments', `KES ${monthlyTotal.toFixed(2)}`);
          updateElement('yearlyPayments', `KES ${yearlyTotal.toFixed(2)}`);
          updateElement('totalReceipts', receipts.length.toString());
        } catch (error) {
          console.error('Error updating receipt summary:', error);
        }
      }

      function updateReceiptFilters(receipts) {
        try {
          const clientFilter = document.getElementById('receiptFilterClient');
          const monthFilter = document.getElementById('receiptFilterMonth');

          if (clientFilter) {
            const clients = [...new Set(receipts.map(r => r.client))].sort();
            clientFilter.innerHTML = '<option value="all">All Clients</option>' +
              clients.map(client => `<option value="${client}">${client}</option>`).join('');
          }

          if (monthFilter) {
            const months = [...new Set(receipts.map(r => r.date.substr(0, 7)))].sort().reverse();
            monthFilter.innerHTML = '<option value="">All Months</option>' +
              months.map(month => `<option value="${month}">${new Date(month + '-01').toLocaleDateString('en-US', {year: 'numeric', month: 'long'})}</option>`).join('');
          }
        } catch (error) {
          console.error('Error updating filters:', error);
        }
      }

      // Modal Management Functions
      function viewReceiptModal(receiptId) {
        try {
          const receipts = JSON.parse(localStorage.getItem('paymentReceipts') || '[]');
          const receipt = receipts.find(r => r.id === receiptId);
          
          if (!receipt) {
            alert('Receipt not found');
            return;
          }

          // Populate modal with receipt data
          document.getElementById('modalReceiptNumber').textContent = receipt.receiptNumber || receipt.id.substr(-4);
          document.getElementById('modalReceiptDate').textContent = new Date(receipt.date).toLocaleDateString();
          document.getElementById('modalReceiptTime').textContent = new Date(receipt.timestamp).toLocaleTimeString();
          document.getElementById('modalClientName').textContent = receipt.client;
          document.getElementById('modalPaymentMethod').textContent = receipt.paymentMethod;
          document.getElementById('modalReference').textContent = receipt.reference || 'N/A';
          document.getElementById('modalServicePeriod').textContent = receipt.servicePeriod || 'N/A';
          document.getElementById('modalAmount').textContent = `KES ${receipt.amount.toFixed(2)}`;

          // Handle notes section
          const notesSection = document.getElementById('modalNotesSection');
          const notesText = document.getElementById('modalNotes');
          if (receipt.notes && receipt.notes.trim()) {
            notesText.textContent = receipt.notes;
            notesSection.classList.remove('hidden');
          } else {
            notesSection.classList.add('hidden');
          }

          // Store current receipt ID for modal actions
          window.currentModalReceiptId = receiptId;

          // Show modal with animation
          const modal = document.getElementById('receiptViewModal');
          modal.classList.remove('hidden');
          setTimeout(() => {
            modal.querySelector('.bg-white').classList.add('scale-100');
          }, 10);

        } catch (error) {
          console.error('Error viewing receipt:', error);
          alert('Error viewing receipt');
        }
      }

      function closeReceiptModal() {
        const modal = document.getElementById('receiptViewModal');
        modal.classList.add('hidden');
        window.currentModalReceiptId = null;
      }

      // Close modal with Escape key
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
          const modal = document.getElementById('receiptViewModal');
          if (modal && !modal.classList.contains('hidden')) {
            closeReceiptModal();
          }
        }
      });

      function printReceiptFromModal() {
        console.log('üñ®Ô∏è Print from modal triggered');
        if (window.currentModalReceiptId) {
          console.log('üìÑ Modal receipt ID:', window.currentModalReceiptId);
          generateReceiptPDF(window.currentModalReceiptId);
        } else {
          console.error('‚ùå No receipt ID available from modal');
          alert('Error: No receipt selected. Please close and reopen the receipt.');
        }
      }

      // ‚úÖ Comprehensive Receipt Generation System with Multiple Fallbacks
      function generateReceiptPDF(receiptId) {
        console.log('üöÄ Starting comprehensive receipt generation for ID:', receiptId);
        
        try {
          const receipts = JSON.parse(localStorage.getItem('paymentReceipts') || '[]');
          const receipt = receipts.find(r => r.id === receiptId);
          
          if (!receipt) {
            alert('‚ùå Receipt not found');
            return;
          }

          // Show loading indicator
          const currentButton = event?.target || document.querySelector(`button[onclick*="generateReceiptPDF(${receiptId})"]`);
          const originalText = currentButton?.innerHTML || '';
          if (currentButton) {
            currentButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            currentButton.disabled = true;
          }

          console.log('üìã Receipt found:', receipt.client, 'Amount:', receipt.amount);

          // üîß METHOD 1: Primary jsPDF (window.jsPDF)
          if (typeof window.jsPDF !== 'undefined') {
            console.log('‚úÖ Method 1: Using window.jsPDF');
            return generatePDFMethod1(receipt, currentButton, originalText);
          }
          
          // üîß METHOD 2: Global jsPDF
          if (typeof jsPDF !== 'undefined') {
            console.log('‚úÖ Method 2: Using global jsPDF');
            return generatePDFMethod2(receipt, currentButton, originalText);
          }
          
          // üîß METHOD 3: HTML Print Fallback
          console.log('‚ö†Ô∏è PDF libraries unavailable, using Method 3: HTML Print Fallback');
          return generateHTMLPrintFallback(receipt, currentButton, originalText);

        } catch (error) {
          console.error('‚ùå Receipt Generation Error:', error);
          
          // üîß METHOD 4: Text Download (Last Resort)
          console.log('üÜò All methods failed, using Method 4: Text Download');
          generateTextDownloadFallback(receipt);
          
          // Reset button
          if (currentButton) {
            setTimeout(() => {
              currentButton.innerHTML = originalText || '<i class="fas fa-file-pdf"></i> Generate PDF';
              currentButton.disabled = false;
            }, 1000);
          }
        }
      }

      // üîß METHOD 1: Primary jsPDF with window.jsPDF
      function generatePDFMethod1(receipt, button, originalText) {
        try {
          const { jsPDF } = window.jsPDF;
          const doc = new jsPDF();
          
          createProfessionalPDF(doc, receipt);
          
          const fileName = generateFileName(receipt);
          doc.save(fileName);
          
          showSuccessMessage(receipt, fileName, 'Method 1: window.jsPDF');
          resetButton(button, originalText);
          
        } catch (error) {
          console.error('‚ùå Method 1 failed:', error);
          // Fall back to Method 2
          if (typeof jsPDF !== 'undefined') {
            generatePDFMethod2(receipt, button, originalText);
          } else {
            generateHTMLPrintFallback(receipt, button, originalText);
          }
        }
      }

      // üîß METHOD 2: Global jsPDF
      function generatePDFMethod2(receipt, button, originalText) {
        try {
          const doc = new jsPDF();
          
          createProfessionalPDF(doc, receipt);
          
          const fileName = generateFileName(receipt);
          doc.save(fileName);
          
          showSuccessMessage(receipt, fileName, 'Method 2: Global jsPDF');
          resetButton(button, originalText);
          
        } catch (error) {
          console.error('‚ùå Method 2 failed:', error);
          generateHTMLPrintFallback(receipt, button, originalText);
        }
      }

      // üîß METHOD 3: Beautiful HTML Print Fallback
      function generateHTMLPrintFallback(receipt, button, originalText) {
        console.log('üìÑ Generating HTML receipt for printing...');
        
        const htmlContent = `
          <!DOCTYPE html>
          <html>
          <head>
            <title>DR.NET Receipt - ${receipt.client}</title>
            <style>
              @media print {
                body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
                .no-print { display: none !important; }
                .receipt-container { padding: 20px; max-width: 800px; margin: 0 auto; }
              }
              body { margin: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8fafc; }
              .receipt-container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto; }
              .header { background: linear-gradient(135deg, #1e293b, #334155); color: white; padding: 30px; border-radius: 8px; text-align: center; margin-bottom: 30px; }
              .header h1 { margin: 0; font-size: 32px; font-weight: bold; }
              .header p { margin: 5px 0 0 0; font-size: 16px; opacity: 0.9; }
              .receipt-title { text-align: center; font-size: 28px; font-weight: bold; color: #1e293b; margin: 30px 0; }
              .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 30px 0; }
              .info-section { background: #f8fafc; padding: 20px; border-radius: 8px; border-left: 4px solid #3b82f6; }
              .info-section h3 { margin: 0 0 15px 0; color: #1e293b; font-size: 18px; }
              .info-row { display: flex; justify-content: space-between; margin: 8px 0; padding: 5px 0; border-bottom: 1px solid #e2e8f0; }
              .info-label { font-weight: 600; color: #64748b; }
              .info-value { font-weight: bold; color: #1e293b; }
              .amount-highlight { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; padding: 25px; border-radius: 12px; text-align: center; margin: 30px 0; }
              .amount-highlight h2 { margin: 0 0 10px 0; font-size: 20px; }
              .amount-highlight .amount { font-size: 36px; font-weight: bold; margin: 0; }
              .notes-section { background: #fef3c7; padding: 20px; border-radius: 8px; border-left: 4px solid #f59e0b; margin: 20px 0; }
              .notes-section h4 { margin: 0 0 10px 0; color: #92400e; }
              .footer { text-align: center; margin-top: 40px; padding: 20px; border-top: 2px solid #e2e8f0; color: #64748b; }
              .print-button { background: #3b82f6; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin: 20px; }
              .print-button:hover { background: #2563eb; }
            </style>
          </head>
          <body>
            <div class="receipt-container">
              <div class="header">
                <h1>DR.NET TECHNOLOGY LABS</h1>
                <p>Innovative Connections with Doctors Precision</p>
              </div>
              
              <div class="receipt-title">PAYMENT RECEIPT</div>
              
              <div class="info-grid">
                <div class="info-section">
                  <h3>Receipt Information</h3>
                  <div class="info-row">
                    <span class="info-label">Receipt Number:</span>
                    <span class="info-value">${receipt.receiptNumber || receipt.id.toString().substr(-4)}</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">Date:</span>
                    <span class="info-value">${new Date(receipt.date || Date.now()).toLocaleDateString()}</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">Time:</span>
                    <span class="info-value">${new Date(receipt.timestamp || Date.now()).toLocaleTimeString()}</span>
                  </div>
                </div>
                
                <div class="info-section">
                  <h3>Client Information</h3>
                  <div class="info-row">
                    <span class="info-label">Client Name:</span>
                    <span class="info-value">${receipt.client || 'N/A'}</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">Payment Method:</span>
                    <span class="info-value">${receipt.paymentMethod || 'N/A'}</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">Reference:</span>
                    <span class="info-value">${receipt.reference || 'N/A'}</span>
                  </div>
                </div>
              </div>
              
              <div class="amount-highlight">
                <h2>AMOUNT PAID</h2>
                <p class="amount">KES ${parseFloat(receipt.amount || 0).toFixed(2)}</p>
              </div>
              
              ${receipt.notes ? `
                <div class="notes-section">
                  <h4>Notes:</h4>
                  <p>${receipt.notes}</p>
                </div>
              ` : ''}
              
              <div class="footer">
                <p><strong>Thank you for your payment!</strong></p>
                <p>Dr.Net Technology Labs - Innovative Connections with Doctors Precision</p>
                <p>Generated: ${new Date().toLocaleString()}</p>
              </div>
              
              <div class="no-print" style="text-align: center; margin: 20px 0;">
                <button class="print-button" onclick="window.print()">üñ®Ô∏è Print Receipt (Save as PDF)</button>
                <button class="print-button" onclick="window.close()" style="background: #6b7280;">‚ùå Close</button>
              </div>
            </div>
          </body>
          </html>
        `;
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(htmlContent);
        printWindow.document.close();
        
        // Auto-trigger print dialog after a short delay
        setTimeout(() => {
          printWindow.print();
        }, 500);
        
        alert('üìÑ HTML Receipt Generated!\n\n‚úÖ A new window opened with your receipt\nüñ®Ô∏è Use Ctrl+P or the Print button to save as PDF\nüí° Choose "Save as PDF" in the print dialog');
        
        resetButton(button, originalText);
      }

      // üîß METHOD 4: Text Download Fallback
      function generateTextDownloadFallback(receipt) {
        const textContent = `
DR.NET TECHNOLOGY LABS - PAYMENT RECEIPT
Innovative Connections with Doctors Precision
=====================================

Receipt Number: ${receipt.receiptNumber || receipt.id.toString().substr(-4)}
Date: ${new Date(receipt.date || Date.now()).toLocaleDateString()}
Time: ${new Date(receipt.timestamp || Date.now()).toLocaleTimeString()}

CLIENT INFORMATION
------------------
Client Name: ${receipt.client || 'N/A'}
Payment Method: ${receipt.paymentMethod || 'N/A'}
Transaction Reference: ${receipt.reference || 'N/A'}
Service Period: ${receipt.servicePeriod || 'N/A'}

PAYMENT DETAILS
--------------
AMOUNT PAID: KES ${parseFloat(receipt.amount || 0).toFixed(2)}

${receipt.notes ? `NOTES:\n${receipt.notes}\n` : ''}

=====================================
Thank you for your payment!
Dr.Net Technology Labs - Innovative Connections with Doctors Precision
Generated: ${new Date().toLocaleString()}
        `;
        
        const blob = new Blob([textContent], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `DR.NET_Receipt_${receipt.receiptNumber || receipt.id.toString().substr(-4)}_${(receipt.client || 'Unknown').replace(/[^a-zA-Z0-9]/g, '_')}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        alert('üìÑ Text Receipt Downloaded!\n\n‚úÖ Receipt saved as text file\nüí° All PDF methods failed, but your receipt is safe!');
      }

      // Helper Functions
      function createProfessionalPDF(doc, receipt) {
        // Minimal Header - Single line
        doc.setFillColor(30, 41, 59);
        doc.rect(0, 0, 210, 20, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('DR.NET TECHNOLOGY LABS - PAYMENT RECEIPT', 20, 13);

        // Consolidated Information Block - Everything in one table
        doc.setTextColor(0, 0, 0);
        doc.setDrawColor(200, 200, 200);
        doc.setLineWidth(0.3);
        
        // Main info box - all data in grid format
        doc.rect(20, 25, 170, 35);
        
        // Grid layout - 3 columns x 3 rows
        doc.setFontSize(7);
        doc.setFont('helvetica', 'normal');
        
        // Row 1
        doc.text('Receipt #:', 22, 32);
        doc.setFont('helvetica', 'bold');
        doc.text(receipt.receiptNumber || receipt.id.toString().substr(-4), 22, 37);
        
        doc.setFont('helvetica', 'normal');
        doc.text('Client Name:', 75, 32);
        doc.setFont('helvetica', 'bold');
        const clientName = (receipt.client || 'N/A').length > 25 ? 
                          (receipt.client || 'N/A').substring(0, 25) + '...' : 
                          (receipt.client || 'N/A');
        doc.text(clientName, 75, 37);
        
        doc.setFont('helvetica', 'normal');
        doc.text('Amount:', 140, 32);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(8);
        doc.text(`KES ${parseFloat(receipt.amount || 0).toFixed(2)}`, 140, 37);
        
        // Row 2
        doc.setFontSize(7);
        doc.setFont('helvetica', 'normal');
        doc.text('Date:', 22, 45);
        doc.setFont('helvetica', 'bold');
        doc.text(new Date(receipt.date || Date.now()).toLocaleDateString(), 22, 50);
        
        doc.setFont('helvetica', 'normal');
        doc.text('Payment Method:', 75, 45);
        doc.setFont('helvetica', 'bold');
        doc.text((receipt.paymentMethod || 'N/A').substring(0, 20), 75, 50);
        
        doc.setFont('helvetica', 'normal');
        doc.text('Reference:', 140, 45);
        doc.setFont('helvetica', 'bold');
        doc.text((receipt.reference || 'N/A').substring(0, 15), 140, 50);
        
        // Row 3 - Time and Service Period (if available)
        doc.setFont('helvetica', 'normal');
        doc.text('Time:', 22, 55);
        doc.setFont('helvetica', 'bold');
        doc.text(new Date(receipt.timestamp || Date.now()).toLocaleTimeString(), 22, 58);
        
        if (receipt.servicePeriod) {
          doc.setFont('helvetica', 'normal');
          doc.text('Service Period:', 75, 55);
          doc.setFont('helvetica', 'bold');
          doc.text((receipt.servicePeriod).substring(0, 20), 75, 58);
        }

        // Highlighted Amount Section
        doc.setFillColor(34, 197, 94);
        doc.rect(20, 65, 170, 15, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        doc.text('TOTAL AMOUNT PAID:', 25, 75);
        doc.setFontSize(13);
        doc.text(`KES ${parseFloat(receipt.amount || 0).toFixed(2)}`, 130, 75);

        // Compact Notes Section (if any)
        let currentY = 85;
        if (receipt.notes && receipt.notes.trim()) {
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(7);
          doc.text('NOTES: ', 20, currentY);
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(6);
          // Single line notes only
          const singleLineNote = receipt.notes.substring(0, 120) + (receipt.notes.length > 120 ? '...' : '');
          doc.text(singleLineNote, 35, currentY);
          currentY += 8;
        }

        // Company tagline and thank you (inline)
        currentY += 5;
        doc.setTextColor(100, 100, 100);
        doc.setFontSize(6);
        doc.setFont('helvetica', 'normal');
        doc.text('Thank you for your payment! | Dr.Net Technology Labs - Innovative Connections with Doctors Precision', 20, currentY);
        
        // Generation info (minimal)
        doc.setFontSize(5);
        doc.text(`Generated: ${new Date().toLocaleString()}`, 20, currentY + 6);
        
        // Force everything to stay within bounds
        const finalY = currentY + 6;
        console.log(`üìÑ PDF Layout Complete - Final Y: ${finalY}mm (A4 limit: 297mm)`);
        
        // Add border for professional look
        doc.setDrawColor(150, 150, 150);
        doc.setLineWidth(0.5);
        doc.rect(15, 20, 180, finalY - 15);
      }

      function generateFileName(receipt) {
        const clientName = (receipt.client || 'Unknown').replace(/[^a-zA-Z0-9]/g, '_');
        const receiptNum = receipt.receiptNumber || receipt.id.toString().substr(-4);
        return `DR.NET_Receipt_${receiptNum}_${clientName}.pdf`;
      }

      function showSuccessMessage(receipt, fileName, method) {
        setTimeout(() => {
          alert(`‚úÖ PDF Generated Successfully!\n\nMethod: ${method}\nFile: ${fileName}\n\nReceipt for: ${receipt.client}\nAmount: KES ${parseFloat(receipt.amount || 0).toFixed(2)}\n\nThe PDF has been downloaded to your Downloads folder.`);
        }, 300);
      }

      function resetButton(button, originalText) {
        if (button) {
          setTimeout(() => {
            button.innerHTML = originalText || '<i class="fas fa-file-pdf"></i> Generate PDF';
            button.disabled = false;
          }, 1000);
        }
      }

      // Enhanced test function
      function testPDFFunction() {
        console.log('üß™ Testing receipt generation functionality...');
        
        // Check if there are any receipts
        let receipts = JSON.parse(localStorage.getItem('paymentReceipts') || '[]');
        console.log('üìã Available receipts:', receipts.length);
        
        if (receipts.length === 0) {
          console.log('‚ö†Ô∏è No receipts available, creating test receipt...');
          
          // Create a test receipt for Sena Level 4 Hospital
          const testReceipt = {
            id: 'SENA_' + Date.now(),
            receiptNumber: 'RCP' + String(Date.now()).substr(-4),
            client: 'Sena Level 4 Hospital',
            amount: 2500.00,
            date: new Date().toISOString().split('T')[0],
            timestamp: new Date().toISOString(),
            paymentMethod: 'M-PESA',
            reference: 'QHW7G8K2MP',
            servicePeriod: 'Monthly Internet Service',
            notes: 'Payment for internet connectivity services. Test receipt created for PDF functionality.'
          };
          
          receipts.push(testReceipt);
          localStorage.setItem('paymentReceipts', JSON.stringify(receipts));
          
          console.log('‚úÖ Test receipt created:', testReceipt);
          
          // Refresh the display
          loadReceiptData();
          updateReceiptSummary();
        }
        
        // Test with first receipt (which should be Sena Level 4 Hospital)
        const testReceipt = receipts[0];
        console.log('üß™ Testing receipt generation for:', testReceipt.client);
        
        // Show available methods
        console.log('üîç Checking available PDF methods...');
        console.log('- window.jsPDF available:', typeof window.jsPDF !== 'undefined');
        console.log('- global jsPDF available:', typeof jsPDF !== 'undefined');
        console.log('- HTML print fallback available:', typeof window.createReceiptPDF !== 'undefined');
        
        // Start the generation process
        printReceiptPDF(testReceipt.id);
        
        return true;
      }

      // Status check function
      function checkPDFStatus() {
        console.log('üîç Checking PDF/Print status...');
        
        let status = 'üìä Receipt Generation Status:\n\n';
        
        // Check jsPDF availability
        if (typeof window.jsPDF !== 'undefined') {
          status += '‚úÖ Method 1: window.jsPDF - Available\n';
        } else {
          status += '‚ùå Method 1: window.jsPDF - Not Available\n';
        }
        
        if (typeof jsPDF !== 'undefined') {
          status += '‚úÖ Method 2: global jsPDF - Available\n';
        } else {
          status += '‚ùå Method 2: global jsPDF - Not Available\n';
        }
        
        if (typeof window.createReceiptPDF !== 'undefined') {
          status += '‚úÖ Method 3: HTML Print Fallback - Available\n';
        } else {
          status += '‚ùå Method 3: HTML Print Fallback - Not Available\n';
        }
        
        // Check receipts
        const receipts = JSON.parse(localStorage.getItem('paymentReceipts') || '[]');
        status += `\nüìã Available Receipts: ${receipts.length}\n`;
        
        if (receipts.length > 0) {
          status += `\nüìÑ Sample Receipt: "${receipts[0].client}"\n`;
          status += `üí∞ Amount: KES ${receipts[0].amount.toFixed(2)}\n`;
        }
        
        status += '\nüí° Click "Test Receipt" to try generation!';
        
        alert(status);
      }

      // Make functions globally available
      window.testPDFFunction = testPDFFunction;
      window.checkPDFStatus = checkPDFStatus;

      function printReceiptPDF(receiptId) {
        try {
          console.log('üñ®Ô∏è Starting receipt generation for:', receiptId);
          
          const receipts = JSON.parse(localStorage.getItem('paymentReceipts') || '[]');
          const receipt = receipts.find(r => r.id === receiptId);
          
          if (!receipt) {
            alert('‚ùå Receipt not found');
            return;
          }

          console.log('üìÑ Receipt data found:', receipt);

          // Try multiple approaches for PDF generation
          let pdfGenerated = false;

          // Method 1: Try jsPDF from window.jsPDF
          if (typeof window.jsPDF !== 'undefined' && !pdfGenerated) {
            try {
              console.log('üîÑ Trying Method 1: window.jsPDF');
              const { jsPDF } = window.jsPDF;
              generatePDFWithJsPDF(new jsPDF(), receipt);
              pdfGenerated = true;
            } catch (e) {
              console.log('‚ùå Method 1 failed:', e.message);
            }
          }

          // Method 2: Try global jsPDF
          if (typeof jsPDF !== 'undefined' && !pdfGenerated) {
            try {
              console.log('üîÑ Trying Method 2: global jsPDF');
              generatePDFWithJsPDF(new jsPDF(), receipt);
              pdfGenerated = true;
            } catch (e) {
              console.log('‚ùå Method 2 failed:', e.message);
            }
          }

          // Method 3: Fallback to HTML print
          if (!pdfGenerated) {
            console.log('üîÑ Using fallback: HTML print method');
            if (window.createReceiptPDF) {
              window.createReceiptPDF(receipt);
              alert('‚úÖ Receipt opened in print dialog!\n\nUse your browser\'s "Save as PDF" option to save as PDF file.');
            } else {
              // Ultimate fallback - simple text download
              downloadReceiptAsText(receipt);
            }
          }

        } catch (error) {
          console.error('‚ùå Error generating receipt:', error);
          
          // Try HTML fallback as last resort
          try {
            const receipts = JSON.parse(localStorage.getItem('paymentReceipts') || '[]');
            const receipt = receipts.find(r => r.id === receiptId);
            if (receipt && window.createReceiptPDF) {
              window.createReceiptPDF(receipt);
              alert('‚ö†Ô∏è PDF generation failed, opened print version instead.\n\nUse "Save as PDF" in the print dialog.');
            }
          } catch (fallbackError) {
            alert('‚ùå Unable to generate receipt. Please refresh the page and try again.');
          }
        }
      }

      // Separate function for jsPDF generation
      function generatePDFWithJsPDF(doc, receipt) {
        // Company Header
        doc.setFillColor(30, 41, 59);
        doc.rect(0, 0, 210, 40, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(24);
        doc.setFont('helvetica', 'bold');
        doc.text('DR.NET SERVICES', 20, 25);
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.text('Internet Service Provider', 20, 35);

        // Receipt Title
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(20);
        doc.setFont('helvetica', 'bold');
        doc.text('PAYMENT RECEIPT', 20, 60);

        // Receipt Details
        doc.setDrawColor(200, 200, 200);
        doc.setLineWidth(0.5);
        doc.rect(20, 70, 170, 30);
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text('Receipt Number:', 25, 80);
        doc.text('Date:', 25, 87);
        doc.text('Time:', 25, 94);
        
        doc.setFont('helvetica', 'bold');
        doc.text(receipt.receiptNumber || receipt.id.substr(-4), 70, 80);
        doc.text(new Date(receipt.date).toLocaleDateString(), 70, 87);
        doc.text(new Date(receipt.timestamp).toLocaleTimeString(), 70, 94);

        // Client Information
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.text('CLIENT INFORMATION', 20, 120);
        
        doc.line(20, 125, 190, 125);
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text('Client Name:', 25, 135);
        doc.text('Payment Method:', 25, 142);
        doc.text('Transaction Reference:', 25, 149);
        doc.text('Service Period:', 25, 156);
        
        doc.setFont('helvetica', 'bold');
        doc.text(receipt.client, 80, 135);
        doc.text(receipt.paymentMethod, 80, 142);
        doc.text(receipt.reference || 'N/A', 80, 149);
        doc.text(receipt.servicePeriod || 'N/A', 80, 156);

        // Amount
        doc.setFillColor(34, 197, 94);
        doc.rect(20, 170, 170, 25, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text('AMOUNT PAID', 25, 185);
        doc.setFontSize(20);
        doc.text(`KES ${receipt.amount.toFixed(2)}`, 120, 185);

        // Notes
        if (receipt.notes && receipt.notes.trim()) {
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(12);
          doc.text('NOTES', 20, 210);
          
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(10);
          const splitNotes = doc.splitTextToSize(receipt.notes, 170);
          doc.text(splitNotes, 20, 220);
        }

        // Footer
        const footerY = receipt.notes ? 250 : 220;
        doc.setDrawColor(200, 200, 200);
        doc.line(20, footerY, 190, footerY);
        
        doc.setTextColor(100, 100, 100);
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.text('Thank you for your payment!', 20, footerY + 10);
        doc.text('Dr.Net Services - Your Trusted Internet Provider', 20, footerY + 17);
        doc.text(`Generated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, 20, footerY + 24);

        // Save
        const fileName = `DR.NET_Receipt_${receipt.receiptNumber || receipt.id.substr(-4)}_${receipt.client.replace(/\s+/g, '_')}.pdf`;
        doc.save(fileName);
        
        console.log('‚úÖ PDF generated successfully:', fileName);
        setTimeout(() => {
          alert(`‚úÖ PDF Receipt Generated!\n\nFile: ${fileName}\n\nSaved to your Downloads folder.`);
        }, 300);
      }

      // Text fallback function
      function downloadReceiptAsText(receipt) {
        const receiptText = `
DR.NET SERVICES - PAYMENT RECEIPT
================================

Receipt #: ${receipt.receiptNumber || receipt.id.substr(-4)}
Date: ${new Date(receipt.date).toLocaleDateString()}
Time: ${new Date(receipt.timestamp).toLocaleTimeString()}

CLIENT INFORMATION
------------------
Name: ${receipt.client}
Payment Method: ${receipt.paymentMethod}
Transaction Ref: ${receipt.reference || 'N/A'}
Service Period: ${receipt.servicePeriod || 'N/A'}

AMOUNT PAID: KES ${receipt.amount.toFixed(2)}

${receipt.notes ? 'Notes: ' + receipt.notes + '\n' : ''}
Thank you for your payment!
Dr.Net Services - Internet Service Provider
Generated: ${new Date().toLocaleString()}
        `;

        const blob = new Blob([receiptText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `DR.NET_Receipt_${receipt.receiptNumber || receipt.id.substr(-4)}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert('‚ö†Ô∏è PDF not available, downloaded as text file instead.\n\nYou can copy the content to create a PDF manually.');
      }

      function deleteReceipt(receiptId) {
        if (!confirm('Are you sure you want to delete this receipt? This action cannot be undone.')) {
          return;
        }

        try {
          let receipts = JSON.parse(localStorage.getItem('paymentReceipts') || '[]');
          receipts = receipts.filter(r => r.id !== receiptId);
          localStorage.setItem('paymentReceipts', JSON.stringify(receipts));
          
          alert('Receipt deleted successfully');
          loadReceiptData();
          updateReceiptSummary();
        } catch (error) {
          console.error('Error deleting receipt:', error);
          alert('Error deleting receipt');
        }
      }



      function exportAllReceiptsPDF() {
        try {
          const receipts = JSON.parse(localStorage.getItem('paymentReceipts') || '[]');
          
          if (receipts.length === 0) {
            alert('No receipts to export');
            return;
          }

          if (typeof window.jsPDF === 'undefined') {
            alert('PDF library not loaded. Please refresh the page and try again.');
            return;
          }

          const { jsPDF } = window.jsPDF;
          const doc = new jsPDF();

          // Sort receipts by date (newest first)
          receipts.sort((a, b) => new Date(b.date) - new Date(a.date));

          receipts.forEach((receipt, index) => {
            if (index > 0) {
              doc.addPage(); // Add new page for each receipt (except first)
            }

            // Company Header
            doc.setFillColor(30, 41, 59);
            doc.rect(0, 0, 210, 40, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text('DR.NET SERVICES', 20, 25);
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('Internet Service Provider', 20, 35);

            // Receipt Title
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text('PAYMENT RECEIPT', 20, 60);

            // Receipt Details Box
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.5);
            doc.rect(20, 70, 170, 30);
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('Receipt Number:', 25, 80);
            doc.text('Date:', 25, 87);
            doc.text('Time:', 25, 94);
            
            doc.setFont('helvetica', 'bold');
            doc.text(receipt.receiptNumber || receipt.id.substr(-4), 70, 80);
            doc.text(new Date(receipt.date).toLocaleDateString(), 70, 87);
            doc.text(new Date(receipt.timestamp).toLocaleTimeString(), 70, 94);

            // Client Information
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.text('CLIENT INFORMATION', 20, 120);
            
            doc.setDrawColor(200, 200, 200);
            doc.line(20, 125, 190, 125);
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('Client Name:', 25, 135);
            doc.text('Payment Method:', 25, 142);
            doc.text('Transaction Reference:', 25, 149);
            doc.text('Service Period:', 25, 156);
            
            doc.setFont('helvetica', 'bold');
            doc.text(receipt.client, 80, 135);
            doc.text(receipt.paymentMethod, 80, 142);
            doc.text(receipt.reference || 'N/A', 80, 149);
            doc.text(receipt.servicePeriod || 'N/A', 80, 156);

            // Payment Amount (Highlighted)
            doc.setFillColor(34, 197, 94);
            doc.rect(20, 170, 170, 25, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('AMOUNT PAID', 25, 185);
            doc.setFontSize(20);
            doc.text(`KES ${receipt.amount.toFixed(2)}`, 120, 185);

            // Notes (if any)
            if (receipt.notes && receipt.notes.trim()) {
              doc.setTextColor(0, 0, 0);
              doc.setFont('helvetica', 'bold');
              doc.setFontSize(12);
              doc.text('NOTES', 20, 210);
              
              doc.setFont('helvetica', 'normal');
              doc.setFontSize(10);
              const splitNotes = doc.splitTextToSize(receipt.notes, 170);
              doc.text(splitNotes, 20, 220);
            }

            // Footer
            const footerY = receipt.notes ? 250 : 220;
            doc.setDrawColor(200, 200, 200);
            doc.line(20, footerY, 190, footerY);
            
            doc.setTextColor(100, 100, 100);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text('Thank you for your payment!', 20, footerY + 10);
            doc.text('Dr.Net Services - Your Trusted Internet Provider', 20, footerY + 17);
            doc.text(`Generated on: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, 20, footerY + 24);
          });

          // Save the PDF with all receipts
          const fileName = `DR.NET_All_Receipts_${new Date().toISOString().split('T')[0]}.pdf`;
          doc.save(fileName);

        } catch (error) {
          console.error('Error exporting all receipts PDF:', error);
          alert('Error exporting PDF. Please try again.');
        }
      }

      function exportReceipts() {
        try {
          const receipts = JSON.parse(localStorage.getItem('paymentReceipts') || '[]');
          
          if (receipts.length === 0) {
            alert('No receipts to export');
            return;
          }

          // Create CSV content
          const headers = ['Date', 'Receipt Number', 'Client', 'Amount', 'Payment Method', 'Reference', 'Service Period', 'Notes'];
          const csvContent = [
            headers.join(','),
            ...receipts.map(receipt => [
              receipt.date,
              receipt.receiptNumber || receipt.id.substr(-4),
              `"${receipt.client}"`,
              receipt.amount.toFixed(2),
              receipt.paymentMethod,
              receipt.reference,
              receipt.servicePeriod,
              `"${receipt.notes || ''}"`
            ].join(','))
          ].join('\n');

          // Download CSV file
          const blob = new Blob([csvContent], { type: 'text/csv' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.setAttribute('hidden', '');
          a.setAttribute('href', url);
          a.setAttribute('download', `payment-receipts-${new Date().toISOString().split('T')[0]}.csv`);
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);

          alert('Receipts exported successfully!');
        } catch (error) {
          console.error('Error exporting receipts:', error);
          alert('Error exporting receipts');
        }

        // Sort by date (newest first)
        receipts.sort((a, b) => new Date(b.date) - new Date(a.date));

        tableBody.innerHTML = receipts.map(receipt => `
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-3">
              <div class="font-medium text-gray-900">${receipt.client}</div>
              <div class="text-sm text-gray-500">${new Date(receipt.date).toLocaleDateString()}</div>
            </td>
            <td class="px-4 py-3 font-semibold text-green-600">KES ${receipt.amount.toLocaleString()}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${receipt.paymentMethod}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${receipt.servicePeriod || '-'}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${receipt.reference || '-'}</td>
            <td class="px-4 py-3">
              <button onclick="deleteReceipt('${receipt.id}')" class="text-red-600 hover:text-red-800 text-sm">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `).join('');
      }

      function deleteReceipt(receiptId) {
        if (!confirm('Are you sure you want to delete this receipt?')) return;
        
        let receipts = JSON.parse(localStorage.getItem('paymentReceipts') || '[]');
        receipts = receipts.filter(receipt => receipt.id !== receiptId);
        localStorage.setItem('paymentReceipts', JSON.stringify(receipts));
        
        loadReceiptData();
        alert('Receipt deleted successfully!');
      }

      // Expense Management Functions
      function recordExpense() {
        // Placeholder for expense recording
        alert('Expense recording functionality will be implemented here');
      }

      function clearExpenseForm() {
        // Placeholder for expense form clearing
        const form = document.getElementById('expenseForm');
        if (form) form.reset();
      }

      // Sales Management Functions
      function recordSale() {
        // Placeholder for sales recording
        alert('Sales recording functionality will be implemented here');
      }

      function clearSalesForm() {
        // Placeholder for sales form clearing
        const form = document.getElementById('salesForm');
        if (form) form.reset();
      }

      // Payslip Management Functions
      let payslipNumber = 1;

      // Function to populate pay period dropdown with current year
      function populatePayPeriodDropdown() {
        const currentDate = new Date();
        const currentYear = currentDate.getFullYear();
        const currentMonth = currentDate.getMonth(); // 0-based (0 = January, 11 = December)
        
        const monthNames = [
          'January', 'February', 'March', 'April', 'May', 'June',
          'July', 'August', 'September', 'October', 'November', 'December'
        ];
        
        const selectElement = document.getElementById('payPeriod');
        if (!selectElement) return;
        
        // Clear existing options except the first one
        selectElement.innerHTML = '<option value="">Select pay period...</option>';
        
        // Add all months of current year up to current month (no future months)
        for (let month = 0; month <= currentMonth; month++) {
          const monthValue = `${currentYear}-${String(month + 1).padStart(2, '0')}`;
          const monthName = monthNames[month];
          const option = document.createElement('option');
          option.value = monthValue;
          option.textContent = `${monthName} ${currentYear}`;
          selectElement.appendChild(option);
        }
      }

      function loadStaffForPayslips() {
        try {
          // Mock staff data for testing
          const mockStaff = [
            {
              id: '1',
              fullName: 'John Supervisor',
              role: 'Supervisor',
              department: 'Network Management',
              email: 'john.supervisor@drnet.com',
              phoneNumber: '+254712345678',
              basicSalary: 45000
            },
            {
              id: '2',
              fullName: 'Sarah Technician',
              role: 'Senior Technician',
              department: 'Technical Services',
              email: 'sarah.technician@drnet.com',
              phoneNumber: '+254712345679',
              basicSalary: 35000
            },
            {
              id: '3',
              fullName: 'Mike Engineer',
              role: 'Network Engineer',
              department: 'Technical Services',
              email: 'mike.engineer@drnet.com',
              phoneNumber: '+254712345680',
              basicSalary: 40000
            },
            {
              id: '4',
              fullName: 'Lisa Support',
              role: 'Customer Support',
              department: 'Customer Service',
              email: 'lisa.support@drnet.com',
              phoneNumber: '+254712345681',
              basicSalary: 25000
            },
            {
              id: '5',
              fullName: 'David Admin',
              role: 'Admin Assistant',
              department: 'Administration',
              email: 'david.admin@drnet.com',
              phoneNumber: '+254712345682',
              basicSalary: 30000
            },
            {
              id: '6',
              fullName: 'Grace Manager',
              role: 'Team Manager',
              department: 'Operations',
              email: 'grace.manager@drnet.com',
              phoneNumber: '+254712345683',
              basicSalary: 50000
            }
          ];

          // Try to load from localStorage first, fallback to mock data
          let staff = [];
          try {
            const storedStaff = JSON.parse(localStorage.getItem('staffData') || '[]');
            staff = storedStaff.length > 0 ? storedStaff : mockStaff;
          } catch (e) {
            staff = mockStaff;
          }

          // Store mock data if no staff data exists
          if (staff.length === 0) {
            localStorage.setItem('staffData', JSON.stringify(mockStaff));
            staff = mockStaff;
          }

          const selectElement = document.getElementById('payslipStaff');
          
          if (selectElement) {
            selectElement.innerHTML = '<option value="">Choose a staff member...</option>';
            staff.forEach(member => {
              const option = document.createElement('option');
              option.value = JSON.stringify(member);
              option.textContent = `${member.fullName} - ${member.role} (${member.department || 'N/A'})`;
              selectElement.appendChild(option);
            });
          }
        } catch (error) {
          console.error('Error loading staff:', error);
        }
      }

      function calculatePayslipData(staff, period) {
        // Basic salary calculation (you can enhance this based on your needs)
        const baseSalary = staff.salary || staff.baseSalary || 25000;
        const allowances = staff.allowances || 5000;
        const deductions = staff.deductions || 2500;
        
        // Calculate based on period
        let workingDays = 22; // Default working days per month
        let attendedDays = 22; // You can integrate with attendance data
        
        const grossSalary = baseSalary + allowances;
        const netSalary = grossSalary - deductions;
        
        return {
          baseSalary,
          allowances,
          deductions,
          grossSalary,
          netSalary,
          workingDays,
          attendedDays,
          payPeriod: period
        };
      }

      function generatePayslip() {
        try {
          const staffData = document.getElementById('payslipStaff')?.value;
          const payPeriod = document.getElementById('payPeriod')?.value;
          
          if (!staffData) {
            alert('Please select a staff member');
            return;
          }
          
          if (!payPeriod) {
            alert('Please select a pay period');
            return;
          }

          const staff = JSON.parse(staffData);
          const payslipData = calculatePayslipData(staff, payPeriod);
          
          // Generate payslip
          const currentDate = new Date().toLocaleDateString();
          const payslipId = `PAY-${String(payslipNumber).padStart(4, '0')}`;
          
          const payslipInfo = {
            id: payslipId,
            staff,
            ...payslipData,
            generatedDate: currentDate,
            generatedAt: new Date().toISOString()
          };
          
          // Save payslip to localStorage
          const payslips = JSON.parse(localStorage.getItem('payslipsData') || '[]');
          payslips.push(payslipInfo);
          localStorage.setItem('payslipsData', JSON.stringify(payslips));
          
          // Show payslip preview
          showPayslipPreview(payslipInfo);
          
          // Generate downloadable payslip
          const payslipText = `
DR.NET SERVICES
PAYSLIP

Payslip ID: ${payslipId}
Employee: ${staff.fullName}
Department: ${staff.department || 'N/A'}
Pay Period: ${payPeriod}
Generated: ${currentDate}

==============================

EARNINGS:
Basic Salary: KES ${payslipData.baseSalary.toFixed(2)}
Allowances: KES ${payslipData.allowances.toFixed(2)}
Gross Salary: KES ${payslipData.grossSalary.toFixed(2)}

DEDUCTIONS:
Total Deductions: KES ${payslipData.deductions.toFixed(2)}

==============================

NET SALARY: KES ${payslipData.netSalary.toFixed(2)}

==============================

Working Days: ${payslipData.workingDays}
Attended Days: ${payslipData.attendedDays}

This is a system generated payslip.
          `;
          
          // Create downloadable text file
          const blob = new Blob([payslipText], { type: 'text/plain' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.setAttribute('hidden', '');
          a.setAttribute('href', url);
          a.setAttribute('download', `payslip-${payslipId}-${staff.fullName.replace(/\s+/g, '-')}.txt`);
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          
          payslipNumber++;
          alert(`Payslip ${payslipId} generated successfully!`);
          
        } catch (error) {
          console.error('Error generating payslip:', error);
          alert('Error generating payslip. Please try again.');
        }
      }

      function showPayslipPreview(payslipInfo) {
        const previewDiv = document.getElementById('payslipPreview');
        if (!previewDiv) return;
        
        previewDiv.innerHTML = `
          <h5 class="font-semibold text-gray-800 mb-4">Payslip Preview - ${payslipInfo.id}</h5>
          <div class="bg-white p-6 rounded-lg border-2 border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <h6 class="font-semibold text-gray-700 mb-3">Employee Details</h6>
                <p><strong>Name:</strong> ${payslipInfo.staff.fullName}</p>
                <p><strong>Department:</strong> ${payslipInfo.staff.department || 'N/A'}</p>
                <p><strong>Pay Period:</strong> ${payslipInfo.payPeriod}</p>
                <p><strong>Working Days:</strong> ${payslipInfo.attendedDays}/${payslipInfo.workingDays}</p>
              </div>
              <div>
                <h6 class="font-semibold text-gray-700 mb-3">Salary Breakdown</h6>
                <div class="space-y-2">
                  <div class="flex justify-between">
                    <span>Basic Salary:</span>
                    <span>KES ${payslipInfo.baseSalary.toFixed(2)}</span>
                  </div>
                  <div class="flex justify-between">
                    <span>Allowances:</span>
                    <span>KES ${payslipInfo.allowances.toFixed(2)}</span>
                  </div>
                  <div class="flex justify-between border-t pt-2">
                    <span>Gross Salary:</span>
                    <span class="font-semibold">KES ${payslipInfo.grossSalary.toFixed(2)}</span>
                  </div>
                  <div class="flex justify-between text-red-600">
                    <span>Deductions:</span>
                    <span>-KES ${payslipInfo.deductions.toFixed(2)}</span>
                  </div>
                  <div class="flex justify-between border-t pt-2 text-lg font-bold text-green-600">
                    <span>Net Salary:</span>
                    <span>KES ${payslipInfo.netSalary.toFixed(2)}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        previewDiv.classList.remove('hidden');
      }

      function generatePayslipSMS() {
        try {
          const staffData = document.getElementById('payslipStaff')?.value;
          const payPeriod = document.getElementById('payPeriod')?.value;
          
          if (!staffData) {
            alert('Please select a staff member first');
            return;
          }
          
          if (!payPeriod) {
            alert('Please select a pay period');
            return;
          }

          const staff = JSON.parse(staffData);
          const payslipData = calculatePayslipData(staff, payPeriod);
          
          const smsText = `Dear ${staff.fullName}, your payslip is ready! Pay Period: ${payPeriod}, Net Salary: KES ${payslipData.netSalary.toFixed(2)}. Please contact HR for collection. - Dr.Net Services`;
          
          // Show SMS preview
          const smsPreviewDiv = document.getElementById('payslipSmsPreview');
          const smsContent = document.getElementById('payslipSmsContent');
          const smsRecipient = document.getElementById('payslipSmsRecipient');
          const smsCharCount = document.getElementById('payslipSmsCharCount');
          
          if (smsContent) smsContent.textContent = smsText;
          if (smsRecipient) smsRecipient.textContent = staff.phoneNumber || staff.phone || 'N/A';
          if (smsCharCount) smsCharCount.textContent = smsText.length;
          if (smsPreviewDiv) smsPreviewDiv.classList.remove('hidden');
          
        } catch (error) {
          console.error('Error generating payslip SMS:', error);
          alert('Error generating SMS');
        }
      }

      function copyPayslipSMS() {
        const smsContent = document.getElementById('payslipSmsContent');
        if (smsContent) {
          navigator.clipboard.writeText(smsContent.textContent).then(() => {
            alert('SMS copied to clipboard!');
          }).catch(err => {
            console.error('Error copying to clipboard:', err);
            alert('Error copying to clipboard');
          });
        }
      }

      function generateBulkPayslips() {
        const department = document.getElementById('bulkDepartment')?.value;
        const status = document.getElementById('bulkStatus')?.value;
        const month = document.getElementById('bulkMonth')?.value;
        
        if (!month) {
          alert('Please select a month for bulk generation');
          return;
        }
        
        alert(`Bulk payslip generation for ${department === 'all' ? 'All Departments' : department} - ${month} will be implemented here`);
      }

      function generateBulkPayslipSMS() {
        alert('Bulk payslip SMS generation will be implemented here');
      }

      function clearPayslipForm() {
        const payPeriodSelect = document.getElementById('payPeriod');
        const staffSelect = document.getElementById('payslipStaff');
        const previewDiv = document.getElementById('payslipPreview');
        const smsPreviewDiv = document.getElementById('payslipSmsPreview');
        const customDateRange = document.getElementById('customDateRange');
        
        if (payPeriodSelect) payPeriodSelect.selectedIndex = 0;
        if (staffSelect) staffSelect.selectedIndex = 0;
        if (previewDiv) previewDiv.classList.add('hidden');
        if (smsPreviewDiv) smsPreviewDiv.classList.add('hidden');
        if (customDateRange) customDateRange.classList.add('hidden');
      }

      function toggleCustomDateRange() {
        const payPeriod = document.getElementById('payPeriod')?.value;
        const customDateRange = document.getElementById('customDateRange');
        
        if (customDateRange) {
          if (payPeriod === 'custom') {
            customDateRange.classList.remove('hidden');
          } else {
            customDateRange.classList.add('hidden');
          }
        }
      }

      // Expense Management Functions
      let expenseIdCounter = 1;

      function clearExpenseForm() {
        const form = document.getElementById('expenseForm');
        if (form) {
          form.reset();
          // Set today's date as default
          const today = new Date().toISOString().split('T')[0];
          const dateField = document.getElementById('expenseDate');
          if (dateField) dateField.value = today;
        }
      }

      function recordExpense(event) {
        event.preventDefault();
        
        const form = document.getElementById('expenseForm');
        if (!form || !form.checkValidity()) {
          if (form) form.reportValidity();
          return;
        }

        try {
          const expenseData = {
            id: Date.now().toString(),
            expenseNumber: `EXP-${String(expenseIdCounter).padStart(4, '0')}`,
            category: document.getElementById('expenseCategory').value,
            amount: parseFloat(document.getElementById('expenseAmount').value),
            date: document.getElementById('expenseDate').value,
            vendor: document.getElementById('expenseVendor').value,
            paymentMethod: document.getElementById('paymentMethod').value,
            description: document.getElementById('expenseDescription').value,
            reference: document.getElementById('expenseReference').value || '',
            timestamp: new Date().toISOString()
          };

          // Save to localStorage
          let expenses = JSON.parse(localStorage.getItem('expensesData') || '[]');
          expenses.push(expenseData);
          localStorage.setItem('expensesData', JSON.stringify(expenses));

          expenseIdCounter++;

          // Clear form and show success message
          clearExpenseForm();
          alert(`Expense ${expenseData.expenseNumber} recorded successfully!`);
          
          // Refresh display
          loadExpenseData();
          updateExpenseSummary();
        } catch (error) {
          console.error('Error recording expense:', error);
          alert('Error recording expense. Please try again.');
        }
      }

      function loadExpenseData() {
        try {
          const expenses = JSON.parse(localStorage.getItem('expensesData') || '[]');
          const tableBody = document.getElementById('expenseTableBody');
          const noExpenses = document.getElementById('noExpenses');
          
          if (!tableBody) return;
          
          if (expenses.length === 0) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                  <div class="flex flex-col items-center">
                    <i class="fas fa-money-bill-wave text-4xl text-gray-300 mb-3"></i>
                    <p class="text-lg font-medium">No expenses recorded</p>
                    <p class="text-sm">Start by recording your first expense</p>
                  </div>
                </td>
              </tr>
            `;
            if (noExpenses) noExpenses.classList.remove('hidden');
            return;
          }

          if (noExpenses) noExpenses.classList.add('hidden');

          // Sort expenses by date (newest first)
          expenses.sort((a, b) => new Date(b.date) - new Date(a.date));

          tableBody.innerHTML = expenses.map(expense => {
            const categoryText = getCategoryText(expense.category);
            return `
              <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-4 py-3 text-sm text-gray-900">${new Date(expense.date).toLocaleDateString()}</td>
                <td class="px-4 py-3 text-sm text-gray-600">
                  <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">
                    ${categoryText}
                  </span>
                </td>
                <td class="px-4 py-3 text-sm text-gray-900">${expense.vendor}</td>
                <td class="px-4 py-3 text-sm text-gray-600" title="${expense.description}">
                  ${expense.description.length > 50 ? expense.description.substring(0, 50) + '...' : expense.description}
                </td>
                <td class="px-4 py-3 text-sm font-semibold text-right text-red-600">KES ${expense.amount.toFixed(2)}</td>
                <td class="px-4 py-3 text-center">
                  <div class="flex justify-center space-x-2">
                    <button onclick="viewExpense('${expense.id}')" class="text-blue-600 hover:text-blue-800" title="View Details">
                      <i class="fas fa-eye"></i>
                    </button>
                    <button onclick="editExpense('${expense.id}')" class="text-yellow-600 hover:text-yellow-800" title="Edit Expense">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteExpense('${expense.id}')" class="text-red-600 hover:text-red-800" title="Delete Expense">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            `;
          }).join('');
          
        } catch (error) {
          console.error('Error loading expense data:', error);
        }
      }

      function getCategoryText(category) {
        const categories = {
          'bills': 'Bills & Utilities',
          'salaries': 'Staff Salaries',
          'petty_cash': 'Petty Cash',
          'equipment': 'Equipment & Hardware',
          'office_supplies': 'Office Supplies',
          'maintenance': 'Maintenance & Repairs',
          'transportation': 'Transportation',
          'marketing': 'Marketing & Advertising',
          'insurance': 'Insurance',
          'rent': 'Rent & Property',
          'software': 'Software & Licenses',
          'training': 'Training & Development',
          'other': 'Other'
        };
        return categories[category] || category;
      }

      function updateExpenseSummary() {
        try {
          const expenses = JSON.parse(localStorage.getItem('expensesData') || '[]');
          const currentDate = new Date();
          const thisMonth = currentDate.toISOString().substr(0, 7); // YYYY-MM
          const thisYear = currentDate.getFullYear().toString();

          // Calculate totals
          const monthlyTotal = expenses
            .filter(e => e.date.startsWith(thisMonth))
            .reduce((sum, e) => sum + e.amount, 0);

          const yearlyTotal = expenses
            .filter(e => e.date.startsWith(thisYear))
            .reduce((sum, e) => sum + e.amount, 0);

          const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
          
          const largestExpense = expenses.length > 0 ? Math.max(...expenses.map(e => e.amount)) : 0;

          // Update UI
          const updateElement = (id, value) => {
            const element = document.getElementById(id);
            if (element) element.textContent = value;
          };

          updateElement('monthlyExpenses', `KES ${monthlyTotal.toFixed(2)}`);
          updateElement('yearlyExpenses', `KES ${yearlyTotal.toFixed(2)}`);
          updateElement('totalExpenses', `KES ${totalExpenses.toFixed(2)}`);
          updateElement('largestExpense', `KES ${largestExpense.toFixed(2)}`);
        } catch (error) {
          console.error('Error updating expense summary:', error);
        }
      }

      function viewExpense(expenseId) {
        try {
          const expenses = JSON.parse(localStorage.getItem('expensesData') || '[]');
          const expense = expenses.find(e => e.id === expenseId);
          
          if (!expense) {
            alert('Expense not found');
            return;
          }

          const expenseDetails = `
EXPENSE DETAILS
Expense #: ${expense.expenseNumber || expense.id.substr(-4)}
Date: ${new Date(expense.date).toLocaleDateString()}

Category: ${getCategoryText(expense.category)}
Vendor/Payee: ${expense.vendor}
Payment Method: ${expense.paymentMethod}
Reference: ${expense.reference || 'N/A'}

Description: ${expense.description}

Amount: KES ${expense.amount.toFixed(2)}

Recorded on: ${new Date(expense.timestamp).toLocaleString()}
          `;

          alert(expenseDetails);
        } catch (error) {
          console.error('Error viewing expense:', error);
          alert('Error viewing expense');
        }
      }

      function editExpense(expenseId) {
        alert('Edit expense functionality will be enhanced in future updates');
      }

      function deleteExpense(expenseId) {
        if (!confirm('Are you sure you want to delete this expense? This action cannot be undone.')) {
          return;
        }

        try {
          let expenses = JSON.parse(localStorage.getItem('expensesData') || '[]');
          expenses = expenses.filter(e => e.id !== expenseId);
          localStorage.setItem('expensesData', JSON.stringify(expenses));
          
          alert('Expense deleted successfully');
          loadExpenseData();
          updateExpenseSummary();
        } catch (error) {
          console.error('Error deleting expense:', error);
          alert('Error deleting expense');
        }
      }

      function filterExpenses() {
        const categoryFilter = document.getElementById('expenseFilterCategory')?.value || 'all';
        const monthFilter = document.getElementById('expenseFilterMonth')?.value || '';
        
        try {
          const allExpenses = JSON.parse(localStorage.getItem('expensesData') || '[]');
          let filteredExpenses = allExpenses;

          if (categoryFilter !== 'all') {
            filteredExpenses = filteredExpenses.filter(e => e.category === categoryFilter);
          }

          if (monthFilter) {
            filteredExpenses = filteredExpenses.filter(e => e.date.startsWith(monthFilter));
          }

          // Update table with filtered data
          const tableBody = document.getElementById('expenseTableBody');
          if (!tableBody) return;
          
          if (filteredExpenses.length === 0) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                  <div class="flex flex-col items-center">
                    <i class="fas fa-search text-4xl text-gray-300 mb-3"></i>
                    <p class="text-lg font-medium">No matching expenses</p>
                    <p class="text-sm">Try adjusting your filters</p>
                  </div>
                </td>
              </tr>
            `;
            return;
          }

          // Sort filtered expenses
          filteredExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));

          tableBody.innerHTML = filteredExpenses.map(expense => {
            const categoryText = getCategoryText(expense.category);
            return `
              <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-4 py-3 text-sm text-gray-900">${new Date(expense.date).toLocaleDateString()}</td>
                <td class="px-4 py-3 text-sm text-gray-600">
                  <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">
                    ${categoryText}
                  </span>
                </td>
                <td class="px-4 py-3 text-sm text-gray-900">${expense.vendor}</td>
                <td class="px-4 py-3 text-sm text-gray-600" title="${expense.description}">
                  ${expense.description.length > 50 ? expense.description.substring(0, 50) + '...' : expense.description}
                </td>
                <td class="px-4 py-3 text-sm font-semibold text-right text-red-600">KES ${expense.amount.toFixed(2)}</td>
                <td class="px-4 py-3 text-center">
                  <div class="flex justify-center space-x-2">
                    <button onclick="viewExpense('${expense.id}')" class="text-blue-600 hover:text-blue-800" title="View Details">
                      <i class="fas fa-eye"></i>
                    </button>
                    <button onclick="editExpense('${expense.id}')" class="text-yellow-600 hover:text-yellow-800" title="Edit Expense">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteExpense('${expense.id}')" class="text-red-600 hover:text-red-800" title="Delete Expense">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            `;
          }).join('');
          
        } catch (error) {
          console.error('Error filtering expenses:', error);
        }
      }

      function exportExpenses() {
        try {
          const expenses = JSON.parse(localStorage.getItem('expensesData') || '[]');
          
          if (expenses.length === 0) {
            alert('No expenses to export');
            return;
          }

          // Create CSV content
          const headers = ['Date', 'Expense Number', 'Category', 'Vendor', 'Description', 'Amount', 'Payment Method', 'Reference'];
          const csvContent = [
            headers.join(','),
            ...expenses.map(expense => [
              expense.date,
              expense.expenseNumber || expense.id.substr(-4),
              getCategoryText(expense.category),
              `"${expense.vendor}"`,
              `"${expense.description}"`,
              expense.amount.toFixed(2),
              expense.paymentMethod,
              `"${expense.reference}"`
            ].join(','))
          ].join('\n');

          // Download CSV file
          const blob = new Blob([csvContent], { type: 'text/csv' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.setAttribute('hidden', '');
          a.setAttribute('href', url);
          a.setAttribute('download', `expenses-${new Date().toISOString().split('T')[0]}.csv`);
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);

          alert('Expenses exported successfully!');
        } catch (error) {
          console.error('Error exporting expenses:', error);
          alert('Error exporting expenses');
        }
      }

      // Debug function to check sections
      function debugSections() {
        const sections = [
          'invoicesSection', 'receiptsSection', 'payslipsSection', 
          'expensesSection', 'salesSection', 'equipmentSection', 
          'dailyReportsSection', 'staffAttendanceSection', 'analyticsSection'
        ];
        
        console.log('=== Section Debug ===');
        sections.forEach(sectionId => {
          const section = document.getElementById(sectionId);
          if (section) {
            console.log(`${sectionId}: EXISTS - Classes: ${section.className} - Display: ${section.style.display || 'default'} - Visibility: ${section.style.visibility || 'default'}`);
          } else {
            console.log(`${sectionId}: MISSING`);
          }
        });
        console.log('=== End Debug ===');
      }

      // Test tab switching function
      function testTabSystem() {
        console.log('=== Testing Tab System ===');
        const tabs = ['invoices', 'receipts', 'payslips', 'expenses', 'sales', 'equipment', 'dailyReports', 'staffAttendance', 'analytics'];
        tabs.forEach(tab => {
          console.log(`Testing tab: ${tab}`);
          showTab(tab);
          debugSections();
        });
        console.log('=== Tab System Test Complete ===');
      }

      // Global function to manually test tabs (can be called from browser console)
      window.testTabs = testTabSystem;

      // Initialize page on load
      document.addEventListener('DOMContentLoaded', function() {
        // Debug sections first
        debugSections();
        
        // Ensure all sections are hidden first
        const sections = [
          'invoicesSection', 'receiptsSection', 'payslipsSection', 
          'expensesSection', 'salesSection', 'equipmentSection', 
          'dailyReportsSection', 'staffAttendanceSection', 'analyticsSection'
        ];
        
        sections.forEach(sectionId => {
          const section = document.getElementById(sectionId);
          if (section) {
            section.classList.add('hidden');
            section.classList.remove('section-visible');
            section.style.display = 'none';
            section.style.visibility = 'hidden';
            section.style.opacity = '0';
            section.style.height = '0';
            console.log('Force hiding section:', sectionId);
          }
        });
        
        // Initialize default tab after a small delay to ensure DOM is ready
        setTimeout(() => {
          showTab('invoices');
        }, 100);
        
        // Set today's date in filters and forms
        const today = new Date().toISOString().split('T')[0];
        
        // Set date for attendance filter
        const dateFilter = document.getElementById('attendanceDateFilter');
        if (dateFilter) {
          dateFilter.value = today;
        }
        
        // Set date for receipt form
        const receiptDate = document.getElementById('receiptDate');
        if (receiptDate) {
          receiptDate.value = today;
        }

        // Set date for expense form
        const expenseDate = document.getElementById('expenseDate');
        if (expenseDate) {
          expenseDate.value = today;
        }

        console.log('All sections properly initialized and hidden');
        
        // Load initial data for sections that need it
        try {
          loadEquipmentData();
          updateEquipmentStats();
        } catch (error) {
          console.warn('Error loading equipment data:', error);
        }
      });

      // Initialize the reports page
      function initReportsPage() {
        console.log('üöÄ Initializing Finance and Reports page...');
        
        // Wait a bit for DOM to be fully ready
        setTimeout(() => {
          console.log('üìã Setting default tab to invoices...');
          
          // Set default tab to invoices
          showTab('invoices');
          
          // Load initial data
          try {
            console.log('üìä Loading initial data...');
            loadClients();
            loadReceiptData();
            loadCtioReports();
            loadEquipmentData();
            updateEquipmentStats();
            console.log('‚úÖ Initial data loaded successfully');
          } catch (error) {
            console.error('‚ùå Error loading initial data:', error);
          }
          
          // Check PDF library status
          setTimeout(() => {
            if (window.testPDFLibrary) {
              const pdfStatus = window.testPDFLibrary();
              console.log(pdfStatus ? '‚úÖ PDF library ready' : '‚ùå PDF library not ready');
            }
          }, 2000);
          
          console.log('‚úÖ Finance and Reports page initialized successfully');
        }, 100);
      }

    </script>

    <!-- Temporarily disabled external scripts for debugging -->
    <!-- <script src="js/config.js"></script> -->
    <!-- <script src="js/common.js"></script> -->
    <!-- <script src="js/invoice-generator.js"></script> -->
    
    <script>
      // Initialize the page after all scripts are loaded
      document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ All scripts loaded, initializing Finance and Reports page...');
        
         // Debug all sections first
         setTimeout(() => {
           console.log('üîß Running diagnostics...');
           runFullDiagnostic();
           debugAllSections();
           initReportsPage();
           
           // Test basic functionality
           console.log('üß™ Testing basic tab functionality...');
           setTimeout(() => {
             console.log('Testing showTab function...');
             showTab('invoices');
           }, 500);
         }, 200);
      });
    </script>
  </body>
</html>
