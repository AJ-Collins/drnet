<style>
  .pulse-ring { animation: pulse 2s infinite; }
  @keyframes pulse {
    0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
    70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
    100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
  }
  .user-row:hover { background: linear-gradient(to right, #f0fdf4, #dcfce7); }
  .skeleton { background: #e5e7eb; animation: skeleton 1.2s ease-in-out infinite alternate; }
  @keyframes skeleton { to { background-color: #f3f4f6; } }
  .skeleton-text { height: 1rem; }
  .skeleton-title { height: 1.5rem; width: 60%; }
  .skeleton-circle { width: 2.5rem; height: 2.5rem; border-radius: 9999px; }
</style>

<!-- Header -->
<div class="bg-white shadow-sm border-b border-gray-200">
  <div class="px-6 py-6 flex items-center justify-between">
    <div>
      <h3 class="text-2xl font-bold text-green-700 flex items-center"> Active Subscriptions
      </h3>
      <p class="text-gray-600 mt-1">
        Clients with valid active plans (<span id="activeCount">0</span>)
      </p>
    </div>
    <button onclick="location.reload()" class="px-5 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium shadow-md hover:shadow-lg transition">
      <i class="fas fa-sync-alt mr-2"></i> Refresh
    </button>
  </div>
</div>

<div class="max-w-full mx-auto p-6">
  <!-- Search & Filters -->
  <div class="bg-white shadow-md p-5 mb-6 rounded-lg">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="relative">
        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
        <input type="text" id="searchInput" placeholder="Search by name, email, phone..."
               class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition">
      </div>
      <select id="planFilter" class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 bg-white">
        <option value="">Loading plans...</option>
      </select>
    </div>
  </div>

  <!-- Table -->
  <div class="bg-white shadow-md overflow-hidden rounded-lg">
    <div class="px-6 py-4 border-b border-green-200 bg-green-50">
      <h3 class="text-lg font-bold text-green-800">
        <i class="fas fa-users mr-2"></i> Active Clients List
      </h3>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full" id="activeTable">
        <thead class="bg-gray-50 border-b border-gray-200">
          <tr>
            <th class="text-left p-4 font-semibold text-gray-700 text-sm uppercase tracking-wider">User</th>
            <th class="text-left p-4 font-semibold text-gray-700 text-sm uppercase tracking-wider">Contact</th>
            <th class="text-left p-4 font-semibold text-gray-700 text-sm uppercase tracking-wider">Active Plan</th>
            <th class="text-left p-4 font-semibold text-gray-700 text-sm uppercase tracking-wider">Expiry Date</th>
            <th class="text-left p-4 font-semibold text-gray-700 text-sm uppercase tracking-wider">Days Left</th>
            <!-- <th class="text-right p-4 font-semibold text-gray-700 text-sm uppercase tracking-wider">Actions</th> -->
          </tr>
        </thead>
        <tbody id="activeTableBody">
          <!-- Filled by JS -->
        </tbody>
      </table>
    </div>

    <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 text-sm text-gray-600">
      Showing <span id="range">0-0</span> of <span id="totalActive">0</span> active clients
    </div>
  </div>
</div>

<script>
  const API_BASE = "/api";
  let allClients = [];
  let filtered = [];
  let allPackages = [];

  const $ = (id) => document.getElementById(id);

  const formatDate = (d) => new Date(d).toLocaleDateString("en-KE", { day: "numeric", month: "short", year: "numeric" });
  
  const daysUntil = (date) => {
    const diff = (new Date(date).setHours(0,0,0,0) - new Date().setHours(0,0,0,0)) / 86400000;
    return Math.ceil(diff);
  };

  const showSkeleton = () => {
    $("activeTableBody").innerHTML = Array(8).fill("").map(() => `
      <tr>
        <td class="p-4"><div class="flex items-center space-x-3">
          <div class="skeleton skeleton-circle"></div>
          <div><div class="skeleton skeleton-title mb-1"></div><div class="skeleton skeleton-text w-24"></div></div>
        </div></td>
        <td class="p-4"><div class="skeleton skeleton-text"></div><div class="skeleton skeleton-text w-32 mt-1"></div></td>
        <td class="p-4"><div class="skeleton skeleton-text w-40"></div></td>
        <td class="p-4"><div class="skeleton skeleton-text w-28"></div></td>
        <td class="p-4"><div class="skeleton skeleton-text w-20"></div></td>
        <td class="p-4 text-right"><div class="flex justify-end space-x-2">${"<div class='skeleton w-9 h-9 rounded'></div>".repeat(3)}</div></td>
      </tr>`).join("");
  };

  // Load packages
  const loadPackages = async () => {
    try {
      const res = await fetch(`${API_BASE}/packages`);
      if (!res.ok) throw new Error("Failed to load packages");
      allPackages = await res.json();

      const select = $("planFilter");
      select.innerHTML = `<option value="">All Active Plans</option>`;
      allPackages.forEach(pkg => {
        const opt = document.createElement("option");
        opt.value = pkg.name;
        opt.textContent = `${pkg.name} (${pkg.speed}Mbps)`;
        select.appendChild(opt);
      });
    } catch (err) {
      $("planFilter").innerHTML = `<option value="">Error loading plans</option>`;
      console.error(err);
    }
  };

  //load active clients
  const loadActiveClients = async () => {
    showSkeleton();
    try {
      const res = await fetch(`${API_BASE}/clients`);
      if (!res.ok) throw new Error("Failed to load clients");
      const clients = await res.json();

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Only clients with a valid expiry_date that is today or in the future
      allClients = clients.filter(c => {
        if (!c.expiry_date || c.expiry_date === "0000-00-00") return false;
        return new Date(c.expiry_date) >= today;
      });

      filtered = [...allClients];
      renderTable();
      $("activeCount").textContent = allClients.length;
      $("totalActive").textContent = allClients.length;
    } catch (err) {
      console.error(err);
      $("activeTableBody").innerHTML = `<tr><td colspan="6" class="p-8 text-center text-red-600">Failed to load data</td></tr>`;
    }
  };

  const renderTable = () => {
    const search = $("searchInput").value.toLowerCase().trim();
    const planFilter = $("planFilter").value.toLowerCase();

    let data = filtered.filter(c => {
      const fullName = `${c.first_name || ""} ${c.second_name || ""}`.toLowerCase();
      const matchesSearch = fullName.includes(search) ||
                          (c.email && c.email.toLowerCase().includes(search)) ||
                          (c.phone && c.phone.includes(search));
      const matchesPlan = !planFilter || (c.plan || "").toLowerCase().includes(planFilter);
      return matchesSearch && matchesPlan;
    });

    $("totalActive").textContent = data.length;
    $("range").textContent = data.length ? `1-${data.length}` : "0-0";

    if (data.length === 0) {
      $("activeTableBody").innerHTML = `<tr><td colspan="6" class="p-8 text-center text-gray-500">
        ${allClients.length === 0 ? "No active subscriptions found" : "No clients match your search or filter"}
      </td></tr>`;
      return;
    }

    $("activeTableBody").innerHTML = data.map(client => {
      const planName = client.plan || "Unknown Plan";
      const expiry = client.expiry_date;
      const daysLeft = daysUntil(expiry);
      const daysText = daysLeft === 0 ? "Expires today" :
                      daysLeft === 1 ? "1 day left" :
                      `${daysLeft} days left`;

      const badgeClass = daysLeft <= 3 ? "bg-orange-100 text-orange-800" :
                        daysLeft <= 7 ? "bg-yellow-100 text-yellow-800" :
                        "bg-green-100 text-green-800";

      return `
      <tr class="user-row border-b hover:bg-green-50 transition">
        <td class="p-4">
          <div class="flex items-center space-x-3">
            <div class="w-11 h-11 bg-gradient-to-br from-green-500 to-green-700 rounded-full flex items-center justify-center text-white font-bold shadow-md">
              ${(client.first_name?.[0] || "?")}${(client.second_name?.[0] || "?")}
            </div>
            <div>
              <p class="font-semibold text-gray-900">${client.first_name || ""} ${client.second_name || ""}</p>
              <p class="text-xs text-gray-500">ID: ${client.id}</p>
            </div>
          </div>
        </td>
        <td class="p-4">
          <p class="text-sm text-gray-700"><i class="fas fa-envelope mr-2 text-gray-400"></i>${client.email || "-"}</p>
          <p class="text-sm text-gray-600"><i class="fas fa-phone mr-2 text-gray-400"></i>${client.phone || "-"}</p>
        </td>
        <td class="p-4">
          <span class="px-3 py-1.5 rounded-lg text-sm font-semibold ${badgeClass}">
            ${planName}
          </span>
        </td>
        <td class="p-4 text-gray-700 font-medium">${formatDate(expiry)}</td>
        <td class="p-4">
          <span class="font-bold ${daysLeft <= 3 ? 'text-orange-700' : daysLeft <= 7 ? 'text-yellow-700' : 'text-green-700'}">
            ${daysText}
          </span>
        </td>
       
      </tr>`;
    }).join("");
  };

  // Actions
  window.openSubscription = (id) => window.location.href = `/admin/users?openSubscription=${id}`;
  window.sendReminder = (id) => Swal.fire("Reminder Sent!", `Message sent to client #${id}`, "success");
  window.viewClient = (id) => window.location.href = `/admin/users?view=${id}`;

  // Filters
  $("searchInput").addEventListener("input", () => setTimeout(renderTable, 200));
  $("planFilter").addEventListener("change", renderTable);

  // Load on start
  window.addEventListener("DOMContentLoaded", () => {
    Promise.all([loadPackages(), loadActiveClients()]);
  });
</script>