<style>
  .pulse-ring { animation: pulse 2s infinite; }
  @keyframes pulse {
    0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
    70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
    100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
  }
  .user-row:hover { background: linear-gradient(to right, #f0fdf4, #dcfce7); }
  .skeleton { background: #e5e7eb; animation: skeleton 1.2s ease-in-out infinite alternate; }
  @keyframes skeleton { to { background-color: #f3f4f6; } }
  .skeleton-text { height: 1rem; }
  .skeleton-title { height: 1.5rem; width: 60%; }
  .skeleton-circle { width: 2.5rem; height: 2.5rem; border-radius: 9999px; }
</style>

<!-- Header -->
<div class="bg-white shadow-sm border-b border-gray-200">
  <div class="px-6 py-6 flex items-center justify-between">
    <div>
      <h3 class="text-2xl font-bold text-green-700 flex items-center">
        Active Subscriptions
      </h3>
      <p class="text-gray-600 mt-1">
        Clients with valid active plans (<span id="activeCount">0</span>)
      </p>
    </div>
    <button onclick="loadActiveClients()" class="px-5 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium shadow-md hover:shadow-lg transition">
      <i class="fas fa-sync-alt mr-2"></i> Refresh
    </button>
  </div>
</div>

<div class="max-w-full mx-auto p-6">
  <!-- Search & Filters -->
  <div class="bg-white shadow-md p-5 mb-6 rounded-lg">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="relative">
        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
        <input type="text" id="searchInput" placeholder="Search by name, email, phone..."
               class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition">
      </div>
      <select id="planFilter" class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 bg-white">
        <option value="">All Active Plans</option>
      </select>
    </div>
  </div>

  <!-- Table -->
  <div class="bg-white shadow-md overflow-hidden rounded-lg">
    <div class="px-6 py-4 border-b border-green-200 bg-green-50">
      <h3 class="text-lg font-bold text-green-800">
        Active Clients List
      </h3>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full" id="activeTable">
        <thead class="bg-gray-50 border-b border-gray-200">
          <tr>
            <th class="text-left p-4 font-semibold text-gray-700 text-sm uppercase tracking-wider">User</th>
            <th class="text-left p-4 font-semibold text-gray-700 text-sm uppercase tracking-wider">Contact</th>
            <th class="text-left p-4 font-semibold text-gray-700 text-sm uppercase tracking-wider">Active Plan</th>
            <th class="text-left p-4 font-semibold text-gray-700 text-sm uppercase tracking-wider">Expires On</th>
            <th class="text-left p-4 font-semibold text-gray-700 text-sm uppercase tracking-wider">Days Left</th>
          </tr>
        </thead>
        <tbody id="activeTableBody"></tbody>
      </table>
    </div>

    <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 text-sm text-gray-600">
      Showing <span id="range">0-0</span> of <span id="totalActive">0</span> active clients
    </div>
  </div>
</div>

<script>
  const API_BASE = "/api";
  let activeClients = [];
  let allPackages = [];

  const $ = (id) => document.getElementById(id);

  const formatDate = (d) => {
    if (!d) return "Unknown";
    return new Date(d).toLocaleDateString("en-KE", { day: "numeric", month: "short", year: "numeric" });
  };

  const daysLeft = (date) => {
    if (!date) return "â€”";
    const diff = (new Date(date).setHours(0,0,0,0) - new Date().setHours(0,0,0,0)) / 86400000;
    const days = Math.ceil(diff);
    if (days < 0) return "Expired";
    if (days === 0) return "Today";
    if (days === 1) return "1 day";
    return `${days} days`;
  };

  const showSkeleton = () => {
    $("activeTableBody").innerHTML = Array(10).fill("").map(() => `
      <tr>
        <td class="p-4"><div class="flex items-center space-x-3">
          <div class="skeleton skeleton-circle"></div>
          <div><div class="skeleton skeleton-title mb-1"></div><div class="skeleton skeleton-text w-24"></div></div>
        </div></td>
        <td class="p-4"><div class="skeleton skeleton-text"></div><div class="skeleton skeleton-text w-32 mt-1"></div></td>
        <td class="p-4"><div class="skeleton skeleton-text w-40"></div></td>
        <td class="p-4"><div class="skeleton skeleton-text w-28"></div></td>
        <td class="p-4"><div class="skeleton skeleton-text w-20"></div></td>
      </tr>`).join("");
  };

  // Load packages for filter dropdown
  const loadPackages = async () => {
    try {
      const res = await fetch(`${API_BASE}/packages`);
      if (!res.ok) throw new Error("Failed");
      allPackages = await res.json();

      const select = $("planFilter");
      select.innerHTML = `<option value="">All Active Plans</option>`;
      allPackages.forEach(pkg => {
        const opt = document.createElement("option");
        opt.value = pkg.id;
        opt.textContent = `${pkg.name} (${pkg.speed || "?"}Mbps)`;
        select.appendChild(opt);
      });
    } catch (err) {
      $("planFilter").innerHTML = `<option value="">Error loading plans</option>`;
    }
  };

  const loadActiveClients = async () => {
    showSkeleton();
    $("activeCount").textContent = "Loading...";

    try {
      const response = await fetch(`${API_BASE}/clients/active-subscriptions`);
      if (!response.ok) throw new Error("Failed to load active clients");
      
      const data = await response.json();

      activeClients = data.map(client => ({
        id: client.id,
        first_name: client.first_name,
        second_name: client.second_name,
        email: client.email,
        phone: client.phone,
        packageName: client.package?.name || "Unknown",
        packageId: client.package?.id || client.subscription?.package_id,
        expiryDate: new Date(client.subscription?.expiry_date),
        daysLeft: client.subscription?.days_left || daysLeft(client.subscription?.expiry_date),
        expiryDisplay: formatDate(client.subscription?.expiry_date)
      }));

      // Already sorted by expiry date from backend
      renderTable();
      $("activeCount").textContent = activeClients.length;
      $("totalActive").textContent = activeClients.length;

    } catch (err) {
      console.error(err);
      $("activeTableBody").innerHTML = `<tr><td colspan="6" class="p-8 text-center text-red-600">Failed to load active clients</td></tr>`;
    }
  };

  const renderTable = () => {
    const search = $("searchInput").value.toLowerCase().trim();
    const planFilter = $("planFilter").value;

    let data = activeClients.filter(c => {
      const name = `${c.first_name || ""} ${c.second_name || ""}`.toLowerCase();
      const matchesSearch = name.includes(search) ||
                          (c.email && c.email.toLowerCase().includes(search)) ||
                          (c.phone && c.phone.includes(search));
      const matchesPlan = !planFilter || String(c.packageId) === planFilter;
      return matchesSearch && matchesPlan;
    });

    $("totalActive").textContent = data.length;
    $("range").textContent = data.length ? `1-${data.length}` : "0-0";

    if (data.length === 0) {
      $("activeTableBody").innerHTML = `<tr><td colspan="6" class="p-8 text-center text-gray-500">
        ${activeClients.length === 0 ? "No active subscriptions" : "No clients match your search"}
      </td></tr>`;
      return;
    }

    $("activeTableBody").innerHTML = data.map(client => {
      const daysNum = parseInt(client.daysLeft) || 0;
      const badgeClass = daysNum <= 3 ? "bg-orange-100 text-orange-800" :
                        daysNum <= 7 ? "bg-yellow-100 text-yellow-800" :
                        "bg-green-100 text-green-800";

      const daysColor = daysNum <= 3 ? "text-orange-700" :
                       daysNum <= 7 ? "text-yellow-700" :
                       "text-green-700";

      return `
      <tr class="user-row border-b hover:bg-green-50 transition">
        <td class="p-4">
          <div class="flex items-center space-x-3">
            <div class="w-11 h-11 bg-gradient-to-br from-green-500 to-green-700 rounded-full flex items-center justify-center text-white font-bold shadow-md">
              ${(client.first_name?.[0] || "?")}${(client.second_name?.[0] || "?")}
            </div>
            <div>
              <p class="font-semibold text-gray-900">${client.first_name} ${client.second_name}</p>
              <p class="text-xs text-gray-500">ID: ${client.id}</p>
            </div>
          </div>
        </td>
        <td class="p-4">
          <p class="text-sm text-gray-700"><i class="fas fa-envelope mr-2 text-gray-400"></i>${client.email || "-"}</p>
          <p class="text-sm text-gray-600"><i class="fas fa-phone mr-2 text-gray-400"></i>${client.phone || "-"}</p>
        </td>
        <td class="p-4">
          <span class="px-3 py-1.5 rounded-lg text-sm font-semibold ${badgeClass}">
            ${client.packageName}
          </span>
        </td>
        <td class="p-4 text-gray-700 font-medium">${client.expiryDisplay}</td>
        <td class="p-4">
          <span class="font-bold ${daysColor}">${client.daysLeft}</span>
        </td>
      </tr>`;
    }).join("");
  };

  // Actions
  window.openSubscription = (id) => window.location.href = `/admin/users?openSubscription=${id}`;
  window.viewClient = (id) => window.location.href = `/admin/users?view=${id}`;

  // Search & Filter
  $("searchInput").addEventListener("input", () => setTimeout(renderTable, 300));
  $("planFilter").addEventListener("change", renderTable);

  // Init
  window.addEventListener("DOMContentLoaded", () => {
    Promise.all([loadPackages(), loadActiveClients()]);
  });
</script>