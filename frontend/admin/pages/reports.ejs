<style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f1f5f9; 
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .input-area {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
        }
        
        .input-area:focus { 
            background: white; 
            border-color: #25bf93; 
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1); 
            outline: none;
        }

        .badge-urgent { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .badge-normal { background: #f0fdf4; color: #166534; border: 1px solid #86efac; }
        .badge-draft { background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; }
        .badge-submitted { background: #dcfce7; color: #166534; border: 1px solid #86efac; }

        .tab-btn {
            background: white;
            color: #64748b;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        .tab-btn:hover {
            color: #111515;
        }
        .tab-btn.active {
            color: #111515;
            border-bottom-color: #111515;
        }

        .action-btn {
            transition: all 0.2s;
        }
        .action-btn:hover {
            transform: translateY(-2px);
        }

        .report-card {
            transition: all 0.2s;
            cursor: pointer;
        }
        .report-card:hover {
            transform: translateY(-2px);
            border-color: #94a3b8;
        }

        .section-header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }

        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-5 right-5 z-50 space-y-2"></div>

    <!-- Header -->
    <nav class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-6 shadow-sm">
        <div class="flex items-center gap-3">
            <div>
                <h2 class="font-black text-2xl tracking-wide text-slate-900">Reports Management</h2>
                <p class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Manage Generated Reports</p>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 bg-slate-800 px-3 py-1.5 rounded-lg border border-slate-700">
                <i class="fas fa-calendar-day text-white text-xs"></i>
                <span class="text-xs text-white font-bold" id="currentDate">Loading...</span>
            </div>
        </div>
    </nav>

    <!-- Tab Navigation -->
    <div class="bg-white border-b border-slate-200 px-6">
        <div class="flex gap-2">
            <button onclick="switchTab('general')" id="generalTab" class="tab-btn active px-6 py-4 text-sm font-black uppercase">
                <i class="fas fa-file-alt mr-2"></i>General Reports
            </button>
            <button onclick="switchTab('analytics')" id="analyticsTab" class="tab-btn px-6 py-4 text-sm font-black uppercase">
                <i class="fas fa-chart-line mr-2"></i>Analytics Reports
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto p-6">

        <!-- TAB 1: GENERAL REPORTS MANAGEMENT -->
        <div id="generalReportsTab">
            
            <!-- Filters -->
            <div class="bg-white p-4 border border-slate-200 shadow-sm mb-4">
                <div class="flex flex-wrap items-center gap-4">
                    <div class="flex-1 min-w-[250px]">
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="Search by author, content..." 
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg text-sm font-medium focus:outline-none focus:border-red-500"
                            oninput="applyFilters()"
                        >
                    </div>

                    <select id="statusFilter" onchange="applyFilters()" class="px-4 py-2 border border-slate-300 rounded-lg text-sm font-bold focus:outline-none focus:border-red-500">
                        <option value="all">All Status</option>
                        <option value="submitted">Submitted</option>
                        <option value="draft">Draft</option>
                    </select>

                    <select id="urgencyFilter" onchange="applyFilters()" class="px-4 py-2 border border-slate-300 rounded-lg text-sm font-bold focus:outline-none focus:border-red-500">
                        <option value="all">All Priority</option>
                        <option value="urgent">Urgent Only</option>
                        <option value="normal">Normal Only</option>
                    </select>

                    <input 
                        type="date" 
                        id="dateFilter" 
                        onchange="applyFilters()"
                        class="px-4 py-2 border border-slate-300 rounded-lg text-sm font-bold focus:outline-none focus:border-red-500"
                    >

                    <button onclick="clearFilters()" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg text-xs font-bold hover:bg-slate-200 uppercase">
                        <i class="fas fa-times mr-2"></i>Clear
                    </button>
                </div>
            </div>

            <!-- Reports List -->
            <div id="reportsContainer" class="space-y-3">
                <div class="flex flex-col items-center justify-center p-20 text-slate-400 bg-white border border-slate-200">
                    <i class="fas fa-circle-notch fa-spin text-3xl mb-3"></i>
                    <p class="text-xs font-bold uppercase">Loading reports...</p>
                </div>
            </div>

        </div>

        <!-- TAB 2: ANALYTICS REPORT GENERATOR -->
        <div id="analyticsReportTab" class="hidden">
            
            <div class="grid grid-cols-12 gap-6">
                
                <!-- Left: Generator Form -->
                <div class="col-span-12 lg:col-span-5">
                    <div class="bg-white border border-slate-200 shadow-sm">
                        <div class="section-header px-4 py-3">
                            <h3 class="text-sm font-black text-white uppercase tracking-wide">Generate Analytics Report</h3>
                        </div>
                        
                        <div class="p-6 space-y-6">
                            
                            <!-- Report Type -->
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-wider mb-2 block">
                                    Report Type
                                </label>
                                <select id="reportType" class="w-full input-area rounded-lg p-3 text-sm font-bold">
                                    <option value="full">Complete Dashboard Summary</option>
                                    <option value="financial">Financial Overview Only</option>
                                    <option value="clients">Client Statistics Only</option>
                                    <option value="operations">Operations Summary Only</option>
                                </select>
                            </div>

                            <!-- Date Range -->
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-wider mb-2 block">
                                    Report Period
                                </label>
                                <select id="reportPeriod" class="w-full input-area rounded-lg p-3 text-sm font-bold" onchange="updateDateRange()">
                                    <option value="current">Current Month</option>
                                    <option value="last">Last Month</option>
                                    <option value="custom">Custom Range</option>
                                </select>
                            </div>

                            <!-- Custom Date Range (Hidden by default) -->
                            <div id="customDateRange" class="hidden space-y-3">
                                <div>
                                    <label class="text-[10px] font-bold uppercase text-slate-400 mb-1 block">From Date</label>
                                    <input type="date" id="dateFrom" class="w-full input-area rounded p-2 text-sm font-bold">
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold uppercase text-slate-400 mb-1 block">To Date</label>
                                    <input type="date" id="dateTo" class="w-full input-area rounded p-2 text-sm font-bold">
                                </div>
                            </div>

                            <!-- Format Options -->
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-wider mb-2 block">
                                    Export Format
                                </label>
                                <div class="grid grid-cols-2 gap-3">
                                    <label class="relative cursor-pointer">
                                        <input type="radio" name="exportFormat" value="pdf" checked class="peer sr-only">
                                        <div class="bg-slate-50 border-2 border-slate-200 rounded-lg p-3 peer-checked:border-teal-600 peer-checked:bg-teal-50 transition-all text-center">
                                            <i class="fas fa-file-pdf text-2xl text-slate-400 peer-checked:text-red-600 mb-1"></i>
                                            <p class="font-bold text-xs text-slate-700">PDF Report</p>
                                        </div>
                                    </label>
                                    <label class="relative cursor-pointer">
                                        <input type="radio" name="exportFormat" value="view" class="peer sr-only">
                                        <div class="bg-slate-50 border-2 border-slate-200 rounded-lg p-3 peer-checked:border-teal-600 peer-checked:bg-teal-50 transition-all text-center">
                                            <i class="fas fa-eye text-2xl text-slate-400 peer-checked:text-red-600 mb-1"></i>
                                            <p class="font-bold text-xs text-slate-700">View Only</p>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- Generate Button -->
                            <button onclick="generateAnalyticsReport()" class="w-full bg-gray-600 text-white py-3 rounded-lg font-bold text-sm hover:bg-gray-700 shadow-lg uppercase">
                                <i class="fas fa-chart-bar mr-2"></i>Generate Report
                            </button>

                        </div>
                    </div>
                </div>

                <!-- Right: Preview Area -->
                <div class="col-span-12 lg:col-span-7">
                    <div class="bg-white border border-slate-200 shadow-sm">
                        <div class="section-header px-4 py-3 flex items-center justify-between">
                            <h3 class="text-sm font-black text-white uppercase tracking-wide">Report Preview</h3>
                            <button onclick="downloadCurrentReport()" id="downloadReportBtn" class="hidden px-3 py-1 bg-white text-slate-800 rounded text-xs font-bold hover:bg-slate-100 uppercase">
                                <i class="fas fa-download mr-1"></i>Download
                            </button>
                        </div>
                        
                        <div id="analyticsPreview" class="p-6 min-h-[600px] overflow-y-auto max-h-[calc(100vh-300px)]">
                            <div class="flex flex-col items-center justify-center p-20 text-slate-400">
                                <i class="fas fa-chart-pie text-5xl mb-4"></i>
                                <p class="text-sm font-bold uppercase">No report generated yet</p>
                                <p class="text-xs text-slate-400 mt-2">Select options and click "Generate Report"</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>

    </div>

    <script>
        let allReports = [];
        let filteredReports = [];
        let currentTab = 'general';
        let currentAnalyticsData = null;

        // Initialize
        window.onload = () => {
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
            fetchGeneralReports();
        };

        // Tab Switching
        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab buttons
            document.getElementById('generalTab').classList.toggle('active', tab === 'general');
            document.getElementById('analyticsTab').classList.toggle('active', tab === 'analytics');
            
            // Toggle content
            document.getElementById('generalReportsTab').classList.toggle('hidden', tab !== 'general');
            document.getElementById('analyticsReportTab').classList.toggle('hidden', tab !== 'analytics');
        }

        // GENERAL REPORTS TAB FUNCTIONS

        async function fetchGeneralReports() {
            try {
                const response = await fetch('/api/reports/general');
                const data = await response.json();
                
                if (data.success) {
                    allReports = data.reports;
                    filteredReports = [...allReports];
                    renderReportsList();
                }
            } catch (error) {
                console.error('Error fetching reports:', error);
                showToast('Failed to load reports', 'error');
            }
        }

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const urgency = document.getElementById('urgencyFilter').value;
            const date = document.getElementById('dateFilter').value;

            filteredReports = allReports.filter(report => {
                const matchSearch = !search || 
                    report.first_name.toLowerCase().includes(search) ||
                    report.second_name.toLowerCase().includes(search) ||
                    (report.ops_summary && report.ops_summary.toLowerCase().includes(search)) ||
                    (report.staff_summary && report.staff_summary.toLowerCase().includes(search)) ||
                    (report.support_summary && report.support_summary.toLowerCase().includes(search));

                const matchStatus = status === 'all' || report.status === status;
                
                const matchUrgency = urgency === 'all' || 
                    (urgency === 'urgent' && report.is_urgent) ||
                    (urgency === 'normal' && !report.is_urgent);

                const matchDate = !date || report.report_date === date;

                return matchSearch && matchStatus && matchUrgency && matchDate;
            });

            renderReportsList();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('urgencyFilter').value = 'all';
            document.getElementById('dateFilter').value = '';
            filteredReports = [...allReports];
            renderReportsList();
        }

        function renderReportsList() {
            const container = document.getElementById('reportsContainer');
            
            if (filteredReports.length === 0) {
                container.innerHTML = `
                    <div class="p-20 text-center bg-white border border-slate-200">
                        <i class="fas fa-inbox text-4xl text-slate-300 mb-3"></i>
                        <p class="text-xs font-bold text-slate-400 uppercase">No reports found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredReports.map(report => {
                const statusBadge = report.status === 'submitted' 
                    ? '<span class="badge-submitted px-2 py-1 rounded text-[9px] font-black uppercase">Submitted</span>'
                    : '<span class="badge-draft px-2 py-1 rounded text-[9px] font-black uppercase">Draft</span>';

                const urgencyBadge = report.is_urgent
                    ? '<span class="badge-urgent px-2 py-1 rounded text-[9px] font-black uppercase">Urgent</span>'
                    : '<span class="badge-normal px-2 py-1 rounded text-[9px] font-black uppercase">Normal</span>';

                return `
                    <div class="report-card bg-white border border-slate-200 shadow-sm animate-fade-in" onclick="viewGeneralReport(${report.id})">
                        <div class="p-4">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <h3 class="text-sm font-black text-slate-900 uppercase">Report #${report.id}</h3>
                                        ${statusBadge}
                                        ${urgencyBadge}
                                    </div>
                                    <p class="text-xs text-slate-500 font-medium">
                                        <i class="far fa-calendar mr-1"></i>${new Date(report.report_date).toLocaleDateString()}
                                        <span class="mx-2">|</span>
                                        <i class="far fa-user mr-1"></i>${escapeHtml(report.first_name)} ${escapeHtml(report.second_name)}
                                    </p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="viewGeneralReport(${report.id}); event.stopPropagation();" class="px-3 py-1 bg-blue-600 text-white rounded text-[10px] font-bold hover:bg-blue-700 action-btn uppercase">
                                        <i class="fas fa-eye mr-1"></i>View
                                    </button>
                                    <button onclick="editGeneralReport(${report.id}); event.stopPropagation();" class="px-3 py-1 bg-amber-600 text-white rounded text-[10px] font-bold hover:bg-amber-700 action-btn uppercase">
                                        <i class="fas fa-edit mr-1"></i>Edit
                                    </button>
                                    <button onclick="deleteGeneralReport(${report.id}); event.stopPropagation();" class="px-3 py-1 bg-red-600 text-white rounded text-[10px] font-bold hover:bg-red-700 action-btn uppercase">
                                        <i class="fas fa-trash mr-1"></i>Delete
                                    </button>
                                    <button onclick="downloadGeneralReportPDF(${report.id}); event.stopPropagation();" class="px-3 py-1 bg-slate-600 text-white rounded text-[10px] font-bold hover:bg-slate-700 action-btn uppercase">
                                        <i class="fas fa-file-pdf mr-1"></i>PDF
                                    </button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-4 gap-3 pt-3 border-t border-slate-100">
                                <div class="text-center">
                                    <p class="text-[9px] text-slate-400 font-bold uppercase mb-1">Installations</p>
                                    <p class="text-lg font-black text-teal-600">${report.ops_installs || 0}</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-[9px] text-slate-400 font-bold uppercase mb-1">Pending</p>
                                    <p class="text-lg font-black text-amber-600">${report.ops_pending || 0}</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-[9px] text-slate-400 font-bold uppercase mb-1">Created</p>
                                    <p class="text-[10px] font-bold text-slate-700">${new Date(report.created_at).toLocaleDateString()}</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-[9px] text-slate-400 font-bold uppercase mb-1">Updated</p>
                                    <p class="text-[10px] font-bold text-slate-700">${new Date(report.updated_at).toLocaleDateString()}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function viewGeneralReport(id) {
            const report = allReports.find(r => r.id === id);
            if (!report) return;

            // Navigate to view page in same container
            const container = document.getElementById('reportsContainer');
            container.innerHTML = `
                <div class="bg-white border border-slate-200 shadow-sm animate-fade-in">
                    <div class="section-header px-6 py-4 flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-black text-white uppercase">Report #${report.id}</h3>
                            <p class="text-xs text-slate-300 mt-1">${new Date(report.report_date).toLocaleDateString()}</p>
                        </div>
                        <button onclick="fetchGeneralReports()" class="px-4 py-2 bg-white text-slate-800 rounded-lg text-xs font-bold hover:bg-slate-100 uppercase">
                            <i class="fas fa-arrow-left mr-2"></i>Back to List
                        </button>
                    </div>
                    
                    <div class="p-6 space-y-6">
                        <!-- Report Info -->
                        <div class="grid grid-cols-4 gap-4 pb-4 border-b border-slate-200">
                            <div>
                                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Created By</p>
                                <p class="text-sm font-bold text-slate-900">${escapeHtml(report.first_name)} ${escapeHtml(report.second_name)}</p>
                                <p class="text-[10px] text-slate-500 font-medium">${escapeHtml(report.position)}</p>
                            </div>
                            <div>
                                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Status</p>
                                <span class="${report.status === 'submitted' ? 'badge-submitted' : 'badge-draft'} px-2 py-1 rounded text-[9px] font-black uppercase inline-block">
                                    ${report.status}
                                </span>
                            </div>
                            <div>
                                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Priority</p>
                                <span class="${report.is_urgent ? 'badge-urgent' : 'badge-normal'} px-2 py-1 rounded text-[9px] font-black uppercase inline-block">
                                    ${report.is_urgent ? 'Urgent' : 'Normal'}
                                </span>
                            </div>
                            <div>
                                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Report Date</p>
                                <p class="text-sm font-bold text-slate-900">${new Date(report.report_date).toLocaleDateString()}</p>
                            </div>
                        </div>

                        <!-- Operations -->
                        <div>
                            <h4 class="text-xs font-black text-slate-700 uppercase mb-3 flex items-center gap-2 border-b border-slate-200 pb-2">
                                <i class="fas fa-network-wired text-teal-600"></i>Operations & Logistics
                            </h4>
                            <div class="bg-slate-50 p-4 border border-slate-200">
                                <p class="text-sm text-slate-700 leading-relaxed mb-4">${escapeHtml(report.ops_summary || 'No summary provided')}</p>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-white p-3 border border-slate-200">
                                        <p class="text-[10px] font-black text-slate-400 uppercase">Installations</p>
                                        <p class="text-3xl font-black text-teal-600">${report.ops_installs || 0}</p>
                                    </div>
                                    <div class="bg-white p-3 border border-slate-200">
                                        <p class="text-[10px] font-black text-slate-400 uppercase">Pending Jobs</p>
                                        <p class="text-3xl font-black text-amber-600">${report.ops_pending || 0}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Staff -->
                        <div>
                            <h4 class="text-xs font-black text-slate-700 uppercase mb-3 flex items-center gap-2 border-b border-slate-200 pb-2">
                                <i class="fas fa-users text-blue-600"></i>Staff & Personnel
                            </h4>
                            <div class="bg-slate-50 p-4 border border-slate-200">
                                <p class="text-sm text-slate-700 leading-relaxed">${escapeHtml(report.staff_summary || 'No summary provided')}</p>
                            </div>
                        </div>

                        <!-- Support -->
                        <div>
                            <h4 class="text-xs font-black text-slate-700 uppercase mb-3 flex items-center gap-2 border-b border-slate-200 pb-2">
                                <i class="fas fa-headset text-indigo-600"></i>Support & Client Feedback
                            </h4>
                            <div class="bg-slate-50 p-4 border border-slate-200">
                                <p class="text-sm text-slate-700 leading-relaxed">${escapeHtml(report.support_summary || 'No summary provided')}</p>
                            </div>
                        </div>

                        <!-- Conclusion -->
                        <div>
                            <h4 class="text-xs font-black text-slate-700 uppercase mb-3 flex items-center gap-2 border-b border-slate-200 pb-2">
                                <i class="fas fa-clipboard-check text-slate-600"></i>Conclusion & Action Items
                            </h4>
                            <div class="bg-slate-50 p-4 border border-slate-200 border-l-4 border-l-slate-800">
                                <p class="text-sm text-slate-700 leading-relaxed">${escapeHtml(report.conclusion || 'No conclusion provided')}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function editGeneralReport(id) {
            const report = allReports.find(r => r.id === id);
            if (!report) return;

            const container = document.getElementById('reportsContainer');
            container.innerHTML = `
                <div class="bg-white border border-slate-200 shadow-sm animate-fade-in">
                    <div class="section-header px-6 py-4 flex items-center justify-between">
                        <h3 class="text-lg font-black text-white uppercase">Edit Report #${report.id}</h3>
                        <button onclick="fetchGeneralReports()" class="px-4 py-2 bg-white text-slate-800 rounded-lg text-xs font-bold hover:bg-slate-100 uppercase">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </button>
                    </div>
                    
                    <div class="p-6">
                        <form id="editReportForm" class="space-y-6">
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase mb-2 block">
                                    <i class="fas fa-network-wired text-teal-600 mr-1"></i>Operations Summary
                                </label>
                                <textarea id="edit_ops_summary" rows="4" class="w-full input-area rounded-lg p-3 text-sm font-medium">${escapeHtml(report.ops_summary || '')}</textarea>
                                <div class="grid grid-cols-2 gap-4 mt-3">
                                    <div>
                                        <label class="text-[10px] font-bold uppercase text-slate-400 mb-1 block">Installations</label>
                                        <input type="number" id="edit_ops_installs" value="${report.ops_installs || 0}" class="w-full input-area rounded p-2 text-sm font-bold">
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-bold uppercase text-slate-400 mb-1 block">Pending Jobs</label>
                                        <input type="number" id="edit_ops_pending" value="${report.ops_pending || 0}" class="w-full input-area rounded p-2 text-sm font-bold">
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase mb-2 block">
                                    <i class="fas fa-users text-blue-600 mr-1"></i>Staff Summary
                                </label>
                                <textarea id="edit_staff_summary" rows="3" class="w-full input-area rounded-lg p-3 text-sm font-medium">${escapeHtml(report.staff_summary || '')}</textarea>
                            </div>

                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase mb-2 block">
                                    <i class="fas fa-headset text-indigo-600 mr-1"></i>Support Summary
                                </label>
                                <textarea id="edit_support_summary" rows="3" class="w-full input-area rounded-lg p-3 text-sm font-medium">${escapeHtml(report.support_summary || '')}</textarea>
                                <label class="flex items-center gap-2 cursor-pointer mt-3">
                                    <input type="checkbox" id="edit_is_urgent" ${report.is_urgent ? 'checked' : ''} class="w-4 h-4 text-red-600 rounded">
                                    <span class="text-xs font-bold text-slate-600">Flag as Urgent</span>
                                </label>
                            </div>

                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase mb-2 block">
                                    <i class="fas fa-clipboard-check text-slate-600 mr-1"></i>Conclusion
                                </label>
                                <textarea id="edit_conclusion" rows="3" class="w-full input-area rounded-lg p-3 text-sm font-medium border-l-4 border-l-slate-800">${escapeHtml(report.conclusion || '')}</textarea>
                            </div>

                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase mb-2 block">Status</label>
                                <select id="edit_status" class="w-full input-area rounded-lg p-3 text-sm font-bold">
                                    <option value="draft" ${report.status === 'draft' ? 'selected' : ''}>Draft</option>
                                    <option value="submitted" ${report.status === 'submitted' ? 'selected' : ''}>Submitted</option>
                                </select>
                            </div>

                            <div class="flex gap-4 pt-4 border-t border-slate-200">
                                <button type="button" onclick="fetchGeneralReports()" class="px-6 py-3 bg-slate-200 text-slate-700 rounded-lg text-sm font-bold hover:bg-slate-300 uppercase">
                                    Cancel
                                </button>
                                <button type="button" onclick="saveGeneralReportEdit(${report.id})" class="flex-1 bg-gray-500 text-white py-3 rounded-lg text-sm font-bold hover:bg-gray-700 uppercase">
                                    <i class="fas fa-save mr-2"></i>Save Changes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        async function saveGeneralReportEdit(id) {
            const updatedData = {
                report_date: allReports.find(r => r.id === id).report_date,
                ops_summary: document.getElementById('edit_ops_summary').value,
                ops_installs: parseInt(document.getElementById('edit_ops_installs').value) || 0,
                ops_pending: parseInt(document.getElementById('edit_ops_pending').value) || 0,
                staff_summary: document.getElementById('edit_staff_summary').value,
                support_summary: document.getElementById('edit_support_summary').value,
                is_urgent: document.getElementById('edit_is_urgent').checked ? 1 : 0,
                conclusion: document.getElementById('edit_conclusion').value,
                status: document.getElementById('edit_status').value
            };

            try {
                const response = await fetch(`/api/reports/general/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Report updated successfully', 'success');
                    fetchGeneralReports();
                } else {
                    showToast('Failed to update report', 'error');
                }
            } catch (error) {
                console.error('Error updating report:', error);
                showToast('Failed to update report', 'error');
            }
        }

        async function deleteGeneralReport(id) {
            if (!confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/reports/general/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Report deleted successfully', 'success');
                    fetchGeneralReports();
                } else {
                    showToast('Failed to delete report', 'error');
                }
            } catch (error) {
                console.error('Error deleting report:', error);
                showToast('Failed to delete report', 'error');
            }
        }

        async function downloadGeneralReportPDF(id) {
            const report = allReports.find(r => r.id === id);
            if (!report) return;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFont('helvetica');
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text('Daily General Report', 20, 20);

            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Report #${report.id} - ${new Date(report.report_date).toLocaleDateString()}`, 20, 30);
            doc.text(`Created by: ${report.first_name} ${report.second_name}`, 20, 36);

            let yPos = 50;

            // Operations
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Operations & Logistics', 20, yPos);
            yPos += 7;

            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            const opsSummary = doc.splitTextToSize(report.ops_summary || 'No summary', 170);
            doc.text(opsSummary, 20, yPos);
            yPos += (opsSummary.length * 5) + 10;

            // Staff
            if (yPos > 250) { doc.addPage(); yPos = 20; }
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Staff & Personnel', 20, yPos);
            yPos += 7;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            const staffSummary = doc.splitTextToSize(report.staff_summary || 'No summary', 170);
            doc.text(staffSummary, 20, yPos);
            yPos += (staffSummary.length * 5) + 10;

            // Support
            if (yPos > 250) { doc.addPage(); yPos = 20; }
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Support & Client Feedback', 20, yPos);
            yPos += 7;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            const supportSummary = doc.splitTextToSize(report.support_summary || 'No summary', 170);
            doc.text(supportSummary, 20, yPos);
            yPos += (supportSummary.length * 5) + 10;

            // Conclusion
            if (yPos > 250) { doc.addPage(); yPos = 20; }
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Conclusion', 20, yPos);
            yPos += 7;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            const conclusion = doc.splitTextToSize(report.conclusion || 'No conclusion', 170);
            doc.text(conclusion, 20, yPos);

            doc.save(`Report-${report.id}-${report.report_date}.pdf`);
            showToast('PDF downloaded successfully', 'success');
        }

        // ANALYTICS TAB FUNCTIONS

        function updateDateRange() {
            const period = document.getElementById('reportPeriod').value;
            const customRange = document.getElementById('customDateRange');
            
            if (period === 'custom') {
                customRange.classList.remove('hidden');
            } else {
                customRange.classList.add('hidden');
            }
        }

        async function generateAnalyticsReport() {
            const reportType = document.getElementById('reportType').value;
            const period = document.getElementById('reportPeriod').value;
            const format = document.querySelector('input[name="exportFormat"]:checked').value;

            showToast('Generating analytics report...', 'info');

            try {
                const response = await fetch('/api/dashboard/summary');
                const data = await response.json();

                if (data.success) {
                    currentAnalyticsData = data.data;
                    
                    if (format === 'pdf') {
                        generateAnalyticsPDF(reportType, currentAnalyticsData);
                    } else {
                        displayAnalyticsPreview(reportType, currentAnalyticsData);
                    }
                } else {
                    showToast('Failed to generate report', 'error');
                }
            } catch (error) {
                console.error('Error generating analytics:', error);
                showToast('Failed to generate report', 'error');
            }
        }

        function displayAnalyticsPreview(reportType, data) {
            const preview = document.getElementById('analyticsPreview');
            document.getElementById('downloadReportBtn').classList.remove('hidden');

            let content = `
                <div class="space-y-6">
                    <div class="border-b border-slate-200 pb-4">
                        <h2 class="text-2xl font-black text-slate-900 uppercase">Analytics Report</h2>
                        <p class="text-sm text-slate-600 mt-1">Generated on ${new Date().toLocaleDateString()}</p>
                    </div>
            `;

            if (reportType === 'full' || reportType === 'financial') {
                content += `
                    <div>
                        <h3 class="text-lg font-black text-slate-800 uppercase mb-4 border-b border-slate-200 pb-2">
                            <i class="fas fa-dollar-sign text-emerald-600 mr-2"></i>Financial Overview
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-emerald-50 p-4 border border-emerald-200">
                                <p class="text-xs font-bold text-slate-600 uppercase">Monthly Revenue</p>
                                <p class="text-3xl font-black text-emerald-600">KES ${Number(data.financial.monthly_revenue).toLocaleString()}</p>
                                <p class="text-xs text-emerald-700 mt-1">
                                    <i class="fas fa-arrow-up mr-1"></i>${data.financial.revenue_trend}% vs last month
                                </p>
                            </div>
                            <div class="bg-blue-50 p-4 border border-blue-200">
                                <p class="text-xs font-bold text-slate-600 uppercase">Projected Revenue</p>
                                <p class="text-3xl font-black text-blue-600">KES ${Number(data.financial.projected_revenue).toLocaleString()}</p>
                                <p class="text-xs text-blue-700 mt-1">
                                    ${data.financial.projection_growth}% growth expected
                                </p>
                            </div>
                            <div class="bg-red-50 p-4 border border-red-200">
                                <p class="text-xs font-bold text-slate-600 uppercase">Monthly Expenditure</p>
                                <p class="text-3xl font-black text-red-600">KES ${Number(data.financial.monthly_expenditure).toLocaleString()}</p>
                            </div>
                            <div class="bg-purple-50 p-4 border border-purple-200">
                                <p class="text-xs font-bold text-slate-600 uppercase">Staff Salaries Payable</p>
                                <p class="text-3xl font-black text-purple-600">KES ${Number(data.financial.staff_salaries_payable).toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (reportType === 'full' || reportType === 'clients') {
                content += `
                    <div>
                        <h3 class="text-lg font-black text-slate-800 uppercase mb-4 border-b border-slate-200 pb-2">
                            <i class="fas fa-users text-blue-600 mr-2"></i>Client Statistics
                        </h3>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="bg-white p-4 border border-slate-200">
                                <p class="text-xs font-bold text-slate-600 uppercase">Total Users</p>
                                <p class="text-2xl font-black text-slate-900">${data.financial.total_users}</p>
                            </div>
                            <div class="bg-white p-4 border border-slate-200">
                                <p class="text-xs font-bold text-slate-600 uppercase">Active Subscriptions</p>
                                <p class="text-2xl font-black text-emerald-600">${data.financial.active_subscriptions}</p>
                            </div>
                            <div class="bg-white p-4 border border-slate-200">
                                <p class="text-xs font-bold text-slate-600 uppercase">Expired/Overdue</p>
                                <p class="text-2xl font-black text-red-600">${data.financial.expired_users + data.financial.overdue_users}</p>
                            </div>
                            <div class="bg-white p-4 border border-slate-200">
                                <p class="text-xs font-bold text-slate-600 uppercase">New This Week</p>
                                <p class="text-2xl font-black text-blue-600">${data.financial.new_clients_week}</p>
                            </div>
                            <div class="bg-white p-4 border border-slate-200">
                                <p class="text-xs font-bold text-slate-600 uppercase">New This Month</p>
                                <p class="text-2xl font-black text-blue-600">${data.financial.new_clients_month}</p>
                            </div>
                            <div class="bg-white p-4 border border-slate-200">
                                <p class="text-xs font-bold text-slate-600 uppercase">Inactive Users</p>
                                <p class="text-2xl font-black text-amber-600">${data.financial.inactive_users}</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (reportType === 'full' || reportType === 'operations') {
                content += `
                    <div>
                        <h3 class="text-lg font-black text-slate-800 uppercase mb-4 border-b border-slate-200 pb-2">
                            <i class="fas fa-cogs text-amber-600 mr-2"></i>Operations Summary
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-white p-4 border border-slate-200">
                                <p class="text-xs font-bold text-slate-600 uppercase">Total Bookings</p>
                                <p class="text-2xl font-black text-slate-900">${data.financial.total_bookings}</p>
                            </div>
                            <div class="bg-white p-4 border border-slate-200">
                                <p class="text-xs font-bold text-slate-600 uppercase">Pending Bookings</p>
                                <p class="text-2xl font-black text-amber-600">${data.financial.pending_bookings}</p>
                            </div>
                            <div class="bg-white p-4 border border-slate-200">
                                <p class="text-xs font-bold text-slate-600 uppercase">Pending Tickets</p>
                                <p class="text-2xl font-black text-red-600">${data.financial.pending_tickets}</p>
                            </div>
                            <div class="bg-white p-4 border border-slate-200">
                                <p class="text-xs font-bold text-slate-600 uppercase">Pending Tasks</p>
                                <p class="text-2xl font-black text-blue-600">${data.financial.pending_tasks}</p>
                            </div>
                            <div class="bg-white p-4 border border-slate-200">
                                <p class="text-xs font-bold text-slate-600 uppercase">Inventory Value</p>
                                <p class="text-2xl font-black text-emerald-600">KES ${Number(data.financial.inventory_value).toLocaleString()}</p>
                            </div>
                            <div class="bg-white p-4 border border-slate-200">
                                <p class="text-xs font-bold text-slate-600 uppercase">Staff On Duty</p>
                                <p class="text-2xl font-black text-purple-600">${data.financial.staff_on_duty}</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            content += '</div>';
            preview.innerHTML = content;
            preview.classList.add('animate-fade-in');
        }

        function generateAnalyticsPDF(reportType, data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFont('helvetica', 'bold');
            doc.setFontSize(22);
            doc.text('Analytics Report', 20, 20);

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text(`Generated on ${new Date().toLocaleString()}`, 20, 28);

            let yPos = 45;

            if (reportType === 'full' || reportType === 'financial') {
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Financial Overview', 20, yPos);
                yPos += 10;

                doc.autoTable({
                    startY: yPos,
                    head: [['Metric', 'Value']],
                    body: [
                        ['Monthly Revenue', `KES ${Number(data.financial.monthly_revenue).toLocaleString()}`],
                        ['Subscription Revenue', `KES ${Number(data.financial.monthly_subscription_revenue).toLocaleString()}`],
                        ['Sales Revenue', `KES ${Number(data.financial.monthly_sales_revenue).toLocaleString()}`],
                        ['Monthly Expenditure', `KES ${Number(data.financial.monthly_expenditure).toLocaleString()}`],
                        ['Projected Revenue', `KES ${Number(data.financial.projected_revenue).toLocaleString()}`],
                        ['Revenue Trend', `${data.financial.revenue_trend}%`]
                    ],
                    theme: 'grid',
                    headStyles: { fillColor: [30, 41, 59] },
                    margin: { left: 20 }
                });

                yPos = doc.lastAutoTable.finalY + 15;
            }

            if (reportType === 'full' || reportType === 'clients') {
                if (yPos > 220) {
                    doc.addPage();
                    yPos = 20;
                }

                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Client Statistics', 20, yPos);
                yPos += 10;

                doc.autoTable({
                    startY: yPos,
                    head: [['Metric', 'Count']],
                    body: [
                        ['Total Users', data.financial.total_users],
                        ['Active Subscriptions', data.financial.active_subscriptions],
                        ['Inactive Users', data.financial.inactive_users],
                        ['Expired Users', data.financial.expired_users],
                        ['Overdue Users', data.financial.overdue_users],
                        ['New Clients (Week)', data.financial.new_clients_week],
                        ['New Clients (Month)', data.financial.new_clients_month]
                    ],
                    theme: 'grid',
                    headStyles: { fillColor: [30, 41, 59] },
                    margin: { left: 20 }
                });

                yPos = doc.lastAutoTable.finalY + 15;
            }

            if (reportType === 'full' || reportType === 'operations') {
                if (yPos > 220) {
                    doc.addPage();
                    yPos = 20;
                }

                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Operations Summary', 20, yPos);
                yPos += 10;

                doc.autoTable({
                    startY: yPos,
                    head: [['Metric', 'Value']],
                    body: [
                        ['Total Bookings', data.financial.total_bookings],
                        ['Pending Bookings', data.financial.pending_bookings],
                        ['Pending Tickets', data.financial.pending_tickets],
                        ['Pending Tasks', data.financial.pending_tasks],
                        ['Inventory Value', `KES ${Number(data.financial.inventory_value).toLocaleString()}`],
                        ['In Stock Items', data.financial.in_stock_count],
                        ['Out of Stock Items', data.financial.out_stock_count],
                        ['Staff On Duty', data.financial.staff_on_duty]
                    ],
                    theme: 'grid',
                    headStyles: { fillColor: [30, 41, 59] },
                    margin: { left: 20 }
                });
            }

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text(`Page ${i} of ${pageCount}`, 180, 285);
            }

            doc.save(`Report-${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('PDF downloaded successfully', 'success');
        }

        function downloadCurrentReport() {
            if (!currentAnalyticsData) {
                showToast('No report to download', 'error');
                return;
            }

            const reportType = document.getElementById('reportType').value;
            generateAnalyticsPDF(reportType, currentAnalyticsData);
        }

        // UTILITY FUNCTIONS

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `px-6 py-3 rounded-lg shadow-lg text-white text-sm font-bold animate-fade-in ${
                type === 'success' ? 'bg-emerald-600' : 
                type === 'error' ? 'bg-red-600' : 
                'bg-blue-600'
            }`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-2"></i>
                ${message}
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>