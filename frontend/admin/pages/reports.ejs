<div class="mb-10">
    <h1 class="text-3xl font-bold text-teal-800">Admin Reports Management</h1>
    <p class="text-teal-600 mt-2">Review, approve, reject, or delete supervisor reports</p>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-white rounded-xl shadow p-6 border border-teal-200">
      <p class="text-sm text-gray-600">Total Reports</p>
      <p id="totalCount" class="text-3xl font-bold text-teal-700">0</p>
    </div>
    <div class="bg-white rounded-xl shadow p-6 border border-yellow-200">
      <p class="text-sm text-gray-600">Pending</p>
      <p id="pendingCount" class="text-3xl font-bold text-yellow-600">0</p>
    </div>
    <div class="bg-white rounded-xl shadow p-6 border border-orange-200">
      <p class="text-sm text-gray-600">In Review</p>
      <p id="reviewCount" class="text-3xl font-bold text-orange-600">0</p>
    </div>
    <div class="bg-white rounded-xl shadow p-6 border border-green-200">
      <p class="text-sm text-gray-600">Approved</p>
      <p id="approvedCount" class="text-3xl font-bold text-green-600">0</p>
    </div>
  </div>

  <!-- Reports Table -->
  <div class="bg-white rounded-xl shadow-xl overflow-hidden">
    <div class="p-6 border-b border-gray-200">
      <h3 class="text-2xl font-bold text-teal-800">All Supervisor Reports</h3>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-teal-50">
          <tr>
            <th class="px-6 py-4 text-left text-xs font-medium text-teal-700 uppercase">Ref</th>
            <th class="px-6 py-4 text-left text-xs font-medium text-teal-700 uppercase">Type</th>
            <th class="px-6 py-4 text-left text-xs font-medium text-teal-700 uppercase hidden sm:table-cell">Generated By</th>
            <th class="px-6 py-4 text-left text-xs font-medium text-teal-700 uppercase hidden md:table-cell">Date Range</th>
            <th class="px-6 py-4 text-left text-xs font-medium text-teal-700 uppercase hidden lg:table-cell">Submitted</th>
            <th class="px-6 py-4 text-left text-xs font-medium text-teal-700 uppercase">Status</th>
            <th class="px-6 py-4 text-right text-xs font-medium text-teal-700 uppercase">Actions</th>
          </tr>
        </thead>
        <tbody id="reportsTable" class="bg-white divide-y divide-gray-200 text-sm">
          <!-- Filled by JS -->
        </tbody>
      </table>
    </div>
  </div>

<!-- View Modal -->
<div id="viewModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center p-4">
  <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-screen overflow-y-auto">
    <div class="p-6 border-b border-gray-200 flex justify-between items-center">
      <h3 class="text-2xl font-bold text-teal-800" id="modalTitle">Report Details</h3>
      <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
        <i class="fas fa-times text-2xl"></i>
      </button>
    </div>
    <div class="p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 text-sm">
        <div>
          <p class="text-gray-600">Reference</p>
          <p class="font-bold text-teal-700" id="modalRef">-</p>
        </div>
        <div>
          <p class="text-gray-600">Type</p>
          <p class="font-bold capitalize" id="modalType">-</p>
        </div>
        <div>
          <p class="text-gray-600">Generated By</p>
          <p id="modalGeneratedBy">-</p>
        </div>
        <div>
          <p class="text-gray-600">Submitted On</p>
          <p id="modalDate">-</p>
        </div>
      </div>
      <div class="mt-6">
        <p class="text-gray-600 font-semibold mb-3">Report Content</p>
        <pre id="modalContent" class="whitespace-pre-wrap font-sans text-gray-700 bg-gray-50 p-6 rounded-lg border"></pre>
      </div>
    </div>
    <div class="p-6 border-t border-gray-200 flex justify-between items-center">
      <div id="statusControls" class="flex gap-3">
        <button onclick="changeStatus('in_review')" class="bg-teal-400 hover:bg-teal-500 text-white px-5 py-2 rounded-lg font-medium">In Review</button>
        <button onclick="changeStatus('approved')" class="bg-teal-400 hover:bg-teal-500 text-white px-5 py-2 rounded-lg font-medium">Approve</button>
        <button onclick="changeStatus('rejected')" class="bg-teal-400 hover:bg-teal-500 text-white px-5 py-2 rounded-lg font-medium">Reject</button>
      </div>
      <div class="flex gap-3">
        <button onclick="downloadCurrentPDF()" class="bg-teal-600 hover:bg-teal-700 text-white px-6 py-3 rounded-lg font-medium flex items-center gap-2">
          Download PDF
        </button>
        <button onclick="closeModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
const API = '/api';
let reports = [];
let currentReport = null;

async function loadReports() {
  try {
    const res = await fetch(`${API}/reports`);
    reports = await res.json();

    updateStats();
    renderTable();
  } catch (err) {
    console.error("Failed to load reports:", err);
  }
}

function updateStats() {
  const total = reports.length;
  const pending = reports.filter(r => !r.status || r.status === 'pending').length;
  const review = reports.filter(r => r.status === 'in_review').length;
  const approved = reports.filter(r => r.status === 'approved').length;

  document.getElementById('totalCount').textContent = total;
  document.getElementById('pendingCount').textContent = pending;
  document.getElementById('reviewCount').textContent = review;
  document.getElementById('approvedCount').textContent = approved;
}

function renderTable() {
  const tbody = document.getElementById('reportsTable');
  tbody.innerHTML = reports.length === 0
    ? `<tr><td colspan="7" class="text-center py-16 text-gray-500">No reports submitted yet</td></tr>`
    : reports.map(r => `
      <tr class="hover:bg-teal-50 transition">
        <td class="px-6 py-4 font-medium text-teal-700">${r.reference || 'REP-' + r.id}</td>
        <td class="px-6 py-4 capitalize">${r.report_type.replace('_', ' ')}</td>
        <td class="px-6 py-4 hidden sm:table-cell">${r.generated_by || 'Unknown'}</td>
        <td class="px-6 py-4 hidden md:table-cell">
          ${new Date(r.start_date).toLocaleDateString('en-GB')} - ${new Date(r.end_date).toLocaleDateString('en-GB')}
        </td>
        <td class="px-6 py-4 hidden lg:table-cell">${new Date(r.generated_at).toLocaleDateString('en-GB')}</td>
        <td class="px-6 py-4">
          ${getStatusBadge(r.status)}
        </td>
        <td class="px-6 py-4 text-right">
          <div class="flex justify-end gap-2">
            <button onclick="viewReport(${r.id})" class="p-2 rounded hover:bg-teal-100 text-teal-600" title="View">
              <i class="fas fa-eye"></i>
            </button>
            <button onclick="deleteReport(${r.id})" class="p-2 rounded hover:bg-red-100 text-red-600" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </td>
      </tr>
    `).join('');
}

function getStatusBadge(status) {
  const s = status || 'pending';
  const badges = {
    pending: 'bg-yellow-100 text-yellow-800',
    in_review: 'bg-orange-100 text-orange-800',
    approved: 'bg-green-100 text-green-800',
    rejected: 'bg-red-100 text-red-800'
  };
  return `<span class="px-4 py-2 rounded-full text-xs font-medium ${badges[s] || 'bg-gray-100 text-gray-800'}">
    ${s.toUpperCase()}
  </span>`;
}

function viewReport(id) {
  currentReport = reports.find(r => r.id === id);
  if (!currentReport) return;

  document.getElementById('modalTitle').textContent = currentReport.reference || 'Report';
  document.getElementById('modalRef').textContent = currentReport.reference || 'N/A';
  document.getElementById('modalType').textContent = currentReport.report_type.replace('_', ' ');
  document.getElementById('modalGeneratedBy').textContent = currentReport.generated_by || 'Unknown';
  document.getElementById('modalDate').textContent = new Date(currentReport.generated_at).toLocaleString('en-GB');
  document.getElementById('modalContent').textContent = currentReport.content || 'No content';

  // Hide status buttons if already approved/rejected
  const controls = document.getElementById('statusControls');
  if (['approved', 'rejected'].includes(currentReport.status)) {
    controls.innerHTML = `<span class="text-gray-600 font-medium">Status is final</span>`;
  } else {
    controls.innerHTML = `
      <button onclick="changeStatus('in_review')" class="bg-teal-400 hover:bg-teal-500 text-white px-5 py-2 rounded-lg font-medium">In Review</button>
      <button onclick="changeStatus('approved')" class="bg-green-400 hover:bg-green-500 text-white px-5 py-2 rounded-lg font-medium">Approve</button>
      <button onclick="changeStatus('rejected')" class="bg-red-400 hover:bg-red-500 text-white px-5 py-2 rounded-lg font-medium">Reject</button>
    `;
  }

  document.getElementById('viewModal').classList.remove('hidden');
}

function closeModal() {
  document.getElementById('viewModal').classList.add('hidden');
  currentReport = null;
}

async function changeStatus(newStatus) {
  if (!currentReport) return;
  if (confirm(`Change status to "${newStatus.toUpperCase()}"?`)) {
    try {
      const res = await fetch(`${API}/report/${currentReport.id}/status`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus })
      });

      if (res.ok) {
        alert("Status updated!");
        loadReports();
        closeModal();
      } else {
        alert("Failed to update status");
      }
    } catch (err) {
      alert("Network error");
    }
  }
}

async function deleteReport(id) {
  if (!confirm("Permanently delete this report?")) return;
  try {
    await fetch(`${API}/reports/${id}`, { method: 'DELETE' });
    loadReports();
  } catch (err) {
    alert("Delete failed");
  }
}

function downloadPDF(ref, content) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(20);
  doc.text(ref, 105, 20, { align: 'center' });
  doc.setFontSize(12);
  const lines = doc.splitTextToSize(content, 170);
  doc.text(lines, 20, 40);
  doc.save(`${ref}.pdf`);
}

function downloadCurrentPDF() {
  if (currentReport) {
    downloadPDF(currentReport.reference || 'Report', currentReport.content || '');
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Close modal on outside click
document.getElementById('viewModal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('viewModal')) closeModal();
});

// Load on start + refresh every 30s
loadReports();
setInterval(loadReports, 30000);
</script>