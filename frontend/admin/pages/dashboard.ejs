<style>
    :root { font-family: 'Plus Jakarta Sans', sans-serif; }
    
    body { background-color: #f8fafc; }
    
    .glass-panel { 
        background: white;
        border: 1px solid #e2e8f0; 
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transition: all 0.3s ease;
    }
    
    .glass-panel:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
    }
    
    .stat-card { position: relative; overflow: hidden; }
    .stat-card::after {
        content: ''; position: absolute; top: 0; right: 0; width: 80px; height: 80px;
        background: linear-gradient(135deg, currentColor 0%, transparent 70%);
        opacity: 0.05; border-radius: 0 0 0 4rem; pointer-events: none;
    }

    .action-btn {
        transition: all 0.2s;
        border: 1px solid #f1f5f9;
    }
    .action-btn:hover {
        border-color: #e2e8f0;
        background-color: #f8fafc;
        transform: translateY(-2px);
    }

    .chart-container { position: relative; height: 260px; width: 100%; }
    
    .animate-fade-up { animation: fade-in-up 0.5s ease-out forwards; opacity: 0; }
    @keyframes fade-in-up { 
        from { transform: translateY(15px); opacity: 0; } 
        to { transform: translateY(0); opacity: 1; } 
    }
    
    .status-badge {
        font-size: 10px;
        font-weight: 800;
        padding: 2px 8px;
        border-radius: 12px;
        text-transform: uppercase;
    }
    
    .status-paid { background-color: #d1fae5; color: #065f46; }
    .status-pending { background-color: #fef3c7; color: #92400e; }
    .status-overdue { background-color: #fee2e2; color: #991b1b; }
</style>

<div class="max-w-full mx-auto space-y-4">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 animate-fade-up">
        <div>
            <h1 class="text-3xl font-black text-slate-900 tracking-tight">Dashboard</h1>
            <p class="text-slate-500 font-bold text-sm">Welcome to Dr.Net Technology Labs Management System</p>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="refreshDashboard()" class="text-xs font-bold bg-slate-50 hover:bg-slate-100 px-3 py-1.5 rounded-lg transition-colors text-slate-600">
                <i class="fas fa-sync-alt mr-1"></i> Refresh
            </button>
            <span class="text-xs text-slate-400" id="lastUpdated">Loading...</span>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Monthly Revenue -->
        <div class="glass-panel stat-card p-5 rounded-2xl border-l-4 border-indigo-500 animate-fade-up bg-white shadow-sm flex flex-col justify-between" style="animation-delay: 0.1s;">
            <div class="flex items-center justify-between mb-4">
                <div class="w-10 h-10 rounded-xl bg-indigo-50 flex items-center justify-center text-indigo-600">
                    <i class="fas fa-file-invoice-dollar text-lg"></i>
                </div>
                <div class="text-right">
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Net Flow</p>
                    <span id="revenueTrend" class="text-[10px] font-black px-1.5 py-0.5 rounded-lg bg-emerald-100 text-emerald-700">+0%</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-2 mb-4">
                <div class="space-y-0.5">
                    <p class="text-[10px] font-black text-emerald-500 uppercase tracking-tighter">Revenue Value</p>
                    <h2 id="monthlyRevenue" class="text-lg font-black text-slate-900 leading-none">KES 0</h2>
                    <p class="text-[8px] font-bold text-slate-400 uppercase">Actual</p>
                </div>
                <div class="border-l border-slate-100 pl-3 space-y-0.5">
                    <p class="text-[10px] font-black text-rose-500 uppercase tracking-tighter">Expenditure Value</p>
                    <h2 id="monthlyExpenditure" class="text-lg font-black text-slate-900 leading-none">KES 0</h2>
                    <p class="text-[8px] font-bold text-slate-400 uppercase">Operational</p>
                </div>
            </div>

            <div class="pt-3 border-t border-slate-50">
                <div class="flex justify-between items-center mb-1.5">
                    <div class="flex items-center gap-1">
                        <i class="fas fa-chart-line text-[9px] text-green-500"></i>
                        <p class="text-[10px] font-black text-slate-400 uppercase">Next Month Projection</p>
                    </div>
                    <span id="projectionPercent" class="text-[10px] font-black text-indigo-600">0%</span>
                </div>
                
                <div class="w-full h-1.5 bg-slate-100 rounded-full overflow-hidden mb-2">
                    <div id="projectionBar" class="h-full bg-teal-500 rounded-full transition-all duration-1000" style="width: 0%"></div>
                </div>
                
                <div class="grid grid-cols-1 gap-0">
                    <div>
                        <p class="text-[8px] font-bold text-slate-400 uppercase mb-0.5">Expected Revenue</p>
                        <p id="projectedRevenue" class="text-xs font-black text-indigo-600">KES 0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Subscribers -->
        <div class="glass-panel stat-card p-5 rounded-2xl border-l-4 border-teal-500 animate-fade-up bg-white shadow-sm flex flex-col justify-between" style="animation-delay: 0.2s;">
            <div class="flex justify-between items-start mb-4">
                <div class="w-10 h-10 rounded-xl bg-teal-50 flex items-center justify-center text-teal-600">
                    <i class="fas fa-sync-alt text-lg"></i>
                </div>
                <div class="text-right">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Subscriptions Value</p>
                    <h2 id="monthlySubRevenue" class="text-xl font-black text-slate-900 leading-none mt-1">KES 0</h2>
                    <p class="text-[9px] font-bold text-emerald-600 uppercase mt-1">Monthly Recurring</p>
                </div>
            </div>

            <div class="flex items-center gap-2 mb-4">
                <div class="h-px bg-slate-100 flex-1"></div>
                <span class="text-[9px] font-black text-slate-400 uppercase">Subscriptions</span>
                <div class="h-px bg-slate-100 flex-1"></div>
            </div>

            <div class="grid grid-cols-2 gap-y-3 gap-x-4">
                <div class="flex flex-col">
                    <div class="flex items-center gap-1.5">
                        <div class="w-1.5 h-1.5 rounded-full bg-emerald-500"></div>
                        <p class="text-[11px] font-black text-slate-400 uppercase tracking-widest">Active</p>
                    </div>
                    <p id="activeClients" class="text-sm font-bold text-slate-800">0</p>
                </div>

                <div class="flex flex-col">
                    <div class="flex items-center gap-1.5">
                        <div class="w-1.5 h-1.5 rounded-full bg-amber-500"></div>
                        <p class="text-[11px] font-black text-slate-400 uppercase tracking-widest">Overdue</p>
                    </div>
                    <p id="overdueClients" class="text-sm font-bold text-amber-600">0</p>
                </div>

                <div class="flex flex-col pt-2 border-t border-slate-50">
                    <div class="flex items-center gap-1.5">
                        <div class="w-1.5 h-1.5 rounded-full bg-slate-300"></div>
                        <p class="text-[11px] font-black text-slate-400 uppercase tracking-widest">Inactive</p>
                    </div>
                    <p id="inactiveClients" class="text-sm font-bold text-slate-500">0</p>
                </div>

                <div class="flex flex-col pt-2 border-t border-slate-50">
                    <div class="flex items-center gap-1.5">
                        <div class="w-1.5 h-1.5 rounded-full bg-rose-500 animate-pulse"></div>
                        <p class="text-[11px] font-black text-slate-400 uppercase tracking-widest">Expired</p>
                    </div>
                    <p id="expiredClients" class="text-sm font-bold text-rose-600">0</p>
                </div>
            </div>
        </div>

        <!-- Schedules -->
        <div class="glass-panel stat-card p-5 rounded-2xl border-l-4 border-amber-500 animate-fade-up bg-white shadow-sm" style="animation-delay: 0.3s;">
            <div class="flex justify-between items-center mb-4">
                <div class="w-10 h-10 rounded-xl bg-amber-50 flex items-center justify-center text-amber-600">
                    <i class="fas fa-tools text-lg"></i>
                </div>
                <div class="text-right">
                    <p class="text-[13px] font-black text-slate-400 uppercase tracking-widest">Total Bookings</p>
                    <h2 id="totalBookings" class="text-lg font-black text-slate-900 leading-none">0</h2>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-y-3 gap-x-4">
                <div class="flex flex-col">
                    <p class="text-[12px] font-black text-amber-600 uppercase tracking-widest">Pending Bookings</p>
                    <h2 id="pendingBookings" class="text-sm font-bold text-slate-800 mt-0.5">0</h2>
                </div>

                <div class="flex flex-col">
                    <p class="text-[12px] font-black text-rose-500 uppercase tracking-widest">Pending Tickets</p>
                    <h2 id="pendingTickets" class="text-sm font-bold text-slate-800 mt-0.5">0</h2>
                </div>

                <div class="flex flex-col pt-2 border-t border-slate-50">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Received Reports</p>
                    <h2 id="receivedReports" class="text-sm font-bold text-slate-800 mt-0.5">0</h2>
                </div>

                <div class="flex flex-col pt-2 border-t border-slate-50">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Pending Assignments</p>
                    <h2 id="pendingTasks" class="text-sm font-bold text-emerald-600 mt-0.5">0</h2>
                </div>
            </div>
        </div>

        <div class="glass-panel stat-card p-5 rounded-2xl border-l-4 border-rose-500 animate-fade-up bg-white shadow-sm" style="animation-delay: 0.4s;">
            <div class="flex justify-between items-center mb-4">
                <div class="w-10 h-10 rounded-xl bg-rose-50 flex items-center justify-center text-rose-600">
                    <i class="fas fa-boxes text-lg"></i>
                </div>
                <% const salesSlug = "sales"; %>
                <a href="/admin/<%= salesSlug %>" class="text-[10px] font-black px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 hover:underline">
                    Go to Sales ->
                </a>
            </div>

            <div class="grid grid-cols-2 gap-y-4 gap-x-2">
                <div>
                    <p class="text-[12px] font-black text-slate-400 uppercase tracking-widest">Inventory Value</p>
                    <h2 id="inventoryValue" class="text-base font-black text-slate-900 leading-tight">KES 0</h2>
                </div>

                <div>
                    <p class="text-[12px] font-black text-emerald-500 uppercase tracking-widest">This Month Sales</p>
                    <h2 id="inventorySalesValue" class="text-base font-black text-slate-900 leading-tight">KES 0</h2>
                </div>

                <div class="pt-2 border-t border-slate-50">
                    <p class="text-[12px] font-black text-slate-400 uppercase tracking-widest">In Stock</p>
                    <p class="text-xs font-bold text-slate-700 mt-0.5">
                        <span id="inStockCount">0</span> <span class="text-[10px] font-medium text-slate-400">Items</span>
                    </p>
                </div>

                <div class="pt-2 border-t border-slate-50">
                    <p class="text-[12px] font-black text-slate-400 uppercase tracking-widest">Out of Stock</p>
                    <p class="text-xs font-bold text-rose-600 mt-0.5">
                        <span id="outOfStockCount">0</span> <span class="text-[10px] font-medium text-slate-400">Items</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Revenue Chart -->
        <div class="glass-panel p-6 rounded-2xl lg:col-span-2 animate-fade-up" style="animation-delay: 0.5s;">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-lg font-black text-slate-800">Income Trend (Monthly) </h3>
                </div>
                <button onclick="exportRevenueData()" class="text-xs font-bold bg-slate-50 hover:bg-slate-100 px-3 py-1.5 rounded-lg transition-colors text-slate-600">
                    <i class="fas fa-download mr-1"></i> Export Data
                </button>
            </div>
            <div class="chart-container">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

         <div class="glass-panel p-6 rounded-2xl animate-fade-up flex flex-col h-full" style="animation-delay: 0.9s;">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h3 class="text-lg font-black text-slate-800 tracking-tight">Dispatch Inbox</h3>
                    <p class="text-xs font-bold text-slate-400">Executive sync & reminder status</p>                    
                </div>
                <% const inboxSlug = "operational-inbox"; %>
                <a href="/admin/<%= inboxSlug %>" class="text-[10px] font-black text-teal-600 hover:underline">Full Inbox →</a>
            </div>
            
            <div id="dispatchInboxContainer" class="flex-1 overflow-y-auto pr-1 custom-scroll" style="max-height: 400px;">
                <div id="dispatchInboxContent" class="space-y-3">
                    <div class="text-center py-12 text-slate-400">
                        <i class="fas fa-satellite-dish fa-spin mb-3 text-xl"></i>
                        <p class="text-[10px] font-black uppercase tracking-widest">Fetching Inbox replies...</p>
                    </div>
                </div>
            </div>
        </div>        
    </div>

    <!-- Recent Activity & Package Distribution -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Recent Invoices -->
        <div class="glass-panel p-6 rounded-2xl lg:col-span-2 animate-fade-up" style="animation-delay: 0.7s;">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-lg font-black text-slate-800">Recent Invoices</h3>
                    <p class="text-xs font-bold text-slate-400">Latest payments and invoices</p>
                </div>
                <% const financeSlug = "finance"; %>
                <a href="/admin/<%= financeSlug %>" class="text-xs font-black text-teal-600 hover:text-teal-700">View All</a>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-[10px] uppercase text-slate-400 border-b border-slate-100">
                            <th class="pb-3 pl-2">Invoice ID</th>
                            <th class="pb-3">Client</th>
                            <th class="pb-3">Package</th>
                            <th class="pb-3">Amount</th>
                            <th class="pb-3">Status</th>
                            <th class="pb-3 text-right pr-2">Date</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTable" class="text-sm font-bold text-slate-700">
                        <tr>
                            <td colspan="6" class="text-center py-8 text-slate-400">
                                <i class="fas fa-spinner fa-spin mr-2"></i> Loading transactions...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Package Distribution -->
        <div class="glass-panel p-6 rounded-2xl animate-fade-up" style="animation-delay: 0.8s;">
            <div class="flex justify-between items-center mb-2">
                <div>
                    <h3 class="text-lg font-black text-slate-800">Plan Distribution</h3>
                    <p class="text-xs font-bold text-slate-400">Active subscriptions by package</p>
                </div>
                <span id="totalSubscriptions" class="text-xs font-black text-slate-600">0 total</span>
            </div>
            <div class="chart-container" style="height: 200px;">
                <canvas id="packageChart"></canvas>
            </div>
            <div id="packageLegend" class="mt-4 flex flex-wrap gap-2 justify-center">
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">        
        <div class="glass-panel p-6 rounded-2xl animate-fade-up" style="animation-delay: 0.6s;">
            <h3 class="text-lg font-black text-slate-800 mb-1">Quick Actions</h3>
            <p class="text-xs font-bold text-slate-400 mb-6">Frequent administrative tasks</p>
            
            <div class="grid grid-cols-2 gap-3">
              <% const manageusersSlug = "manage-users"; %>
                <a href="/admin/<%= manageusersSlug %>" class="action-btn p-4 rounded-xl flex flex-col items-center justify-center text-center group">
                    <div class="w-10 h-10 rounded-full bg-teal-50 group-hover:bg-teal-100 text-teal-600 flex items-center justify-center mb-2 transition-colors">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <span class="text-xs font-bold text-slate-700">Add Client</span>
                </a>
                <% const remindersSlug = "reminders"; %>
                <a href="/admin/<%= remindersSlug %>" class="action-btn p-4 rounded-xl flex flex-col items-center justify-center text-center group">
                    <div class="w-10 h-10 rounded-full bg-emerald-50 group-hover:bg-emerald-100 text-emerald-600 flex items-center justify-center mb-2 transition-colors">
                        <i class="fas fa-bell"></i>
                    </div>
                    <span class="text-xs font-bold text-slate-700">New Reminders</span>
                </a>
                <% const supportSlug = "support-tickets"; %>
                <a href="/admin/<%= supportSlug %>" class="action-btn p-4 rounded-xl flex flex-col items-center justify-center text-center group">
                    <div class="w-10 h-10 rounded-full bg-rose-50 group-hover:bg-rose-100 text-rose-600 flex items-center justify-center mb-2 transition-colors">
                        <i class="fas fa-ticket-alt"></i>
                    </div>
                    <span class="text-xs font-bold text-slate-700">New Ticket</span>
                </a>
                <% const equipmentsSlug = "equipments"; %>
                <a href="/admin/<%= equipmentsSlug %>" class="action-btn p-4 rounded-xl flex flex-col items-center justify-center text-center group">
                    <div class="w-10 h-10 rounded-full bg-indigo-50 group-hover:bg-indigo-100 text-indigo-600 flex items-center justify-center mb-2 transition-colors">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <span class="text-xs font-bold text-slate-700">Stock</span>
                </a>
            </div>
        </div>
        <div class="glass-panel rounded-2xl overflow-hidden animate-fade-up shadow-sm border border-slate-100" style="animation-delay: 1.0s;">
            <div class="px-6 py-5 bg-slate-50/50 border-b border-slate-100 flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-black text-slate-800 tracking-tight">Onboarded Clients (Dumb data - Coming soon)</h3>
                    <p class="text-[10px] font-black text-indigo-600 uppercase tracking-widest">
                        New Acquisitions This Month: <span id="monthlyOnboardCount">24</span>
                    </p>
                </div>
                <div class="flex items-center gap-2">
                    <a href="#" class="status-badge bg-emerald-100 text-emerald-700 inline-flex items-center gap-1 underline underline-offset-2 hover:no-underline transition">
                        Manage Onboarding <span aria-hidden="true">→</span>
                    </a>
                </div>
            </div>
            
            <div class="p-0"> <div id="onboardingList" class="divide-y divide-slate-50">
                    
                    <div class="px-6 py-4 flex items-center justify-between hover:bg-slate-50 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold text-xs">JD</div>
                            <div>
                                <p class="text-sm font-black text-slate-800 leading-none">John Doe</p>
                                <p class="text-[10px] font-bold text-slate-400 mt-1 uppercase">Package: Fiber Home 10</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] font-black text-slate-500 uppercase">Staff: <span class="text-indigo-600">Kevin K.</span></p>
                            <p class="text-[9px] font-bold text-slate-400 mt-0.5">2 hours ago</p>
                        </div>
                    </div>

                    <div class="px-6 py-4 flex items-center justify-between hover:bg-slate-50 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-teal-100 flex items-center justify-center text-teal-600 font-bold text-xs">SM</div>
                            <div>
                                <p class="text-sm font-black text-slate-800 leading-none">Sarah Muthoni</p>
                                <p class="text-[10px] font-bold text-slate-400 mt-1 uppercase">Package: Fiber Biz 50</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] font-black text-slate-500 uppercase">Staff: <span class="text-indigo-600">Alice W.</span></p>
                            <p class="text-[9px] font-bold text-slate-400 mt-0.5">Yesterday</p>
                        </div>
                    </div>

                    <div class="px-6 py-4 flex items-center justify-between hover:bg-slate-50 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center text-amber-600 font-bold text-xs">PK</div>
                            <div>
                                <p class="text-sm font-black text-slate-800 leading-none">Peter Kamau</p>
                                <p class="text-[10px] font-bold text-slate-400 mt-1 uppercase">Package: Wireless Pro</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] font-black text-slate-500 uppercase">Staff: <span class="text-indigo-600">Kevin K.</span></p>
                            <p class="text-[9px] font-bold text-slate-400 mt-0.5">Jan 26, 2026</p>
                        </div>
                    </div>

                    <div class="px-6 py-4 flex items-center justify-between hover:bg-slate-50 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-rose-100 flex items-center justify-center text-rose-600 font-bold text-xs">LC</div>
                            <div>
                                <p class="text-sm font-black text-slate-800 leading-none">Linda Cherono</p>
                                <p class="text-[10px] font-bold text-slate-400 mt-1 uppercase">Package: Fiber Home 20</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] font-black text-slate-500 uppercase">Staff: <span class="text-indigo-600">Brian O.</span></p>
                            <p class="text-[9px] font-bold text-slate-400 mt-0.5">Jan 25, 2026</p>
                        </div>
                    </div>

                </div>
            </div>

            <div class="px-6 py-3 bg-slate-50/30 border-t border-slate-50 flex justify-between items-center">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Active Staff:</span>
                <div class="flex gap-4">
                    <span class="text-[10px] font-black text-indigo-600 uppercase">Kevin: 12 Clients</span>
                    <span class="text-[10px] font-black text-slate-500 uppercase">Alice: 8 Clients</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let revenueChartInstance = null;
    let packageChartInstance = null;
    let dashboardData = null;

    document.addEventListener('DOMContentLoaded', () => {
        loadDashboardData();
        setInterval(updateLastUpdated, 60000); // Update timestamp every minute
    });

    async function loadDashboardData() {
        try {
            showLoadingState();
            
            // Load main dashboard data
            const [summaryRes, metricsRes, activityRes, inventoryRes] = await Promise.all([
                fetch('/api/dashboard/summary'),
                fetch('/api/dashboard/metrics'),
                fetch('/api/dashboard/recent-activity'),
                fetch('/api/dashboard/inventory-status')
            ]);

            if (!summaryRes.ok || !metricsRes.ok || !activityRes.ok) {
                throw new Error('Failed to load dashboard data');
            }

            const summary = await summaryRes.json();
            const metrics = await metricsRes.json();
            const inventory = await inventoryRes.json();

            dashboardData = {
                ...summary.data,
                metrics: metrics.data,
                inventory: inventory.data
            };

            updateDashboardUI(dashboardData);
            fetchAdminInbox();
            updateLastUpdated();

        } catch (error) {
            console.error("Dashboard Load Error:", error);
            showErrorState(error.message);
        }
    }

    function updateDashboardUI(data) {
        const fmt = (n) => Number(n || 0).toLocaleString();
        const fmtCurrency = (n) => `KES ${Number(n || 0).toLocaleString()}`;
        
        const monthlyRevenue = document.getElementById('monthlyRevenue');
        if (monthlyRevenue) {
            monthlyRevenue.innerText = fmtCurrency(data.financial?.monthly_revenue || 0);
        }

        const monthlyExpenditure = document.getElementById('monthlyExpenditure');
        if (monthlyExpenditure) {
            monthlyExpenditure.innerText = fmtCurrency(data.financial?.monthly_expenditure || 0);
        }
        
        const revenue = Number(data.financial?.monthly_revenue || 0);
        const expenditure = Number(data.financial?.monthly_expenditure || 0);
        const netFlow = revenue - expenditure;
        
        const trend = data.financial?.revenue_trend || 0;
        const trendEl = document.getElementById('revenueTrend');
        
        if (trendEl) {
            if (netFlow > 0) {
                trendEl.innerText = `+${fmt(netFlow)}`;
                trendEl.className = 'text-[9px] font-black px-1.5 py-0.5 rounded-lg bg-emerald-100 text-emerald-700';
            } else if (netFlow < 0) {
                trendEl.innerText = `${fmt(netFlow)}`;
                trendEl.className = 'text-[9px] font-black px-1.5 py-0.5 rounded-lg bg-rose-100 text-rose-700';
            } else {
                trendEl.innerText = '0';
                trendEl.className = 'text-[9px] font-black px-1.5 py-0.5 rounded-lg bg-slate-100 text-slate-500';
            }
        }
        
        const projectedRevenue = Number(data.financial?.projected_revenue || 0);
        const projectionGrowth = Number(data.financial?.projection_growth || 0);
        const currentDay = Number(data.financial?.current_day || 1);
        const daysInMonth = Number(data.financial?.days_in_month || 30);
        
        const monthProgress = Math.min((currentDay / daysInMonth) * 100, 100);
        
        const projectionPercentEl = document.getElementById('projectionPercent');
        const projectionBarEl = document.getElementById('projectionBar');
        const projectedRevenueEl = document.getElementById('projectedRevenue');
        
        if (projectionPercentEl) {
            projectionPercentEl.innerText = `${projectionGrowth.toFixed(1)}%`;
            if (projectionGrowth > 0) {
                projectionPercentEl.className = 'text-[10px] font-black text-emerald-600';
            } else if (projectionGrowth < 0) {
                projectionPercentEl.className = 'text-[10px] font-black text-rose-600';
            } else {
                projectionPercentEl.className = 'text-[10px] font-black text-slate-600';
            }
        }
        
        if (projectionBarEl) {
            projectionBarEl.style.width = `${monthProgress}%`;
            
            if (projectionGrowth > 0) {
                projectionBarEl.className = 'h-full bg-emerald-500 rounded-full transition-all duration-1000';
            } else if (projectionGrowth < 0) {
                projectionBarEl.className = 'h-full bg-rose-500 rounded-full transition-all duration-1000';
            } else {
                projectionBarEl.className = 'h-full bg-teal-500 rounded-full transition-all duration-1000';
            }
        }
        
        if (projectedRevenueEl) {
            projectedRevenueEl.innerHTML = `
                <span class="text-[10px] text-slate-400">Projected:</span> ${fmtCurrency(projectedRevenue)}
                <span class="text-[10px] text-slate-400 ml-1">(Day ${currentDay}/${daysInMonth})</span>
            `;
        }
        
        const safeUpdate = (id, value) => {
            const el = document.getElementById(id);
            if (el) el.innerText = fmt(value);
        };
        
        safeUpdate('activeClients', data.financial?.active_subscriptions);
        safeUpdate('totalClients', data.financial?.total_users);
        safeUpdate('overdueClients', data.financial?.overdue_users);
        safeUpdate('monthlySubRevenue', data.financial?.monthly_subscription_revenue);
        safeUpdate('inactiveClients', data.financial?.inactive_users);
        safeUpdate('expiredClients', data.financial?.expired_users);
        safeUpdate('pendingBookings', data.financial?.pending_bookings);
        safeUpdate('totalBookings', data.financial?.total_bookings);
        safeUpdate('pendingTickets', data.financial?.pending_tickets);
        safeUpdate('inventoryValue', data.financial?.inventory_value);
        safeUpdate('inventorySalesValue', data.financial?.monthly_sales_revenue);
        safeUpdate('inStockCount', data.financial?.in_stock_count);
        safeUpdate('outOfStockCount', data.financial?.out_stock_count);
        safeUpdate('pendingTasks', data.financial?.pending_tasks);
        
        if (data.charts?.monthlyRevenue) {
            renderRevenueChart(data.charts.monthlyRevenue);
        }
        
        if (data.charts?.packagePopularity) {
            renderPackageChart(data.charts.packagePopularity);
        }
        
        if (data.recent?.invoices) {
            renderRecentInvoices(data.recent.invoices);
        }
        
        hideLoadingState();
    }

    function renderRecentInvoices(invoices) {
        const tbody = document.getElementById('invoicesTable');
        
        if (!invoices || invoices.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-8 text-slate-400">
                        <i class="fas fa-receipt mr-2"></i> No recent transactions
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = invoices.map(inv => {
            let statusClass = 'status-pending';
            if (inv.status === 'paid') statusClass = 'status-paid';
            if (inv.status === 'overdue' || inv.status === 'failed') statusClass = 'status-overdue';
            
            return `
                <tr class="border-b border-slate-50 last:border-0 hover:bg-slate-50 transition-colors">
                    <td class="py-3 pl-2 text-xs font-black text-slate-500">${inv.invoice_id || `INV-${inv.id}`}</td>
                    <td>
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center text-[10px] font-black text-slate-500">
                                ${inv.client_name ? inv.client_name.charAt(0) : '?'}
                            </div>
                            <span class="truncate max-w-[120px]" title="${inv.client_name}">
                                ${inv.client_name || 'Unknown Client'}
                            </span>
                        </div>
                    </td>
                    <td class="text-xs text-slate-500 truncate max-w-[80px]" title="${inv.package_name || 'N/A'}">
                        ${inv.package_name || 'N/A'}
                    </td>
                    <td class="font-black text-slate-800">KES ${Number(inv.amount || 0).toLocaleString()}</td>
                    <td><span class="status-badge ${statusClass}">${inv.status || 'pending'}</span></td>
                    <td class="text-right pr-2 text-xs text-slate-400">${inv.payment_date || 'N/A'}</td>
                </tr>
            `;
        }).join('');
    }

    function renderRevenueChart(data) {
        const ctx = document.getElementById('revenueChart').getContext('2d');
        if (revenueChartInstance) revenueChartInstance.destroy();

        // Create gradient
        const gradient = ctx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, 'rgba(16, 185, 129, 0.3)');
        gradient.addColorStop(0.5, 'rgba(16, 185, 129, 0.1)'); 
        gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');

        // Sort data by day number to ensure correct order
        const sortedData = [...data].sort((a, b) => (a.day_num || 0) - (b.day_num || 0));

        revenueChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: sortedData.map(d => d.day_label || d.month_name),
                datasets: [{
                    label: 'Daily Revenue',
                    data: sortedData.map(d => d.revenue),
                    borderColor: '#10b981',
                    backgroundColor: gradient,
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#ffffff',
                    pointBorderColor: '#10b981',
                    pointBorderWidth: 2,
                    pointHoverBackgroundColor: '#10b981',
                    pointHoverBorderColor: '#ffffff',
                    pointHoverBorderWidth: 3,
                    cubicInterpolationMode: 'monotone'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index',
                },
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1e293b',
                        titleFont: { size: 13, weight: 'bold', family: "'Plus Jakarta Sans'" },
                        bodyFont: { size: 12, family: "'Plus Jakarta Sans'" },
                        padding: 10,
                        cornerRadius: 8,
                        displayColors: false,
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                return `Revenue: KES ${Number(context.raw).toLocaleString()}`;
                            }
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        grid: { 
                            color: '#f1f5f9',
                            drawBorder: false 
                        },
                        ticks: { 
                            font: { size: 10, weight: '600' },
                            callback: function(value) {
                                if (value >= 1000000) return 'KES ' + (value/1000000).toFixed(1) + 'M';
                                if (value >= 1000) return 'KES ' + (value/1000).toFixed(0) + 'K';
                                return 'KES ' + value;
                            }
                        }
                    },
                    x: { 
                        grid: { display: false },
                        ticks: { 
                            font: { size: 9, weight: '600' },
                            maxRotation: 45,
                            minRotation: 0,
                            // Show fewer labels on small screens
                            autoSkip: true,
                            maxTicksLimit: 15
                        }
                    }
                }
            }
        });
    }

    function renderPackageChart(data) {
        const ctx = document.getElementById('packageChart').getContext('2d');
        if (packageChartInstance) packageChartInstance.destroy();

        // Calculate total for percentage display
        const total = data.reduce((sum, d) => sum + (d.subscription_count || 0), 0);
        document.getElementById('totalSubscriptions').innerText = `${total} total`;

        const colors = ['#0d9488', '#6366f1', '#f43f5e', '#f59e0b', '#64748b'];

        packageChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.map(d => d.package_name),
                datasets: [{
                    data: data.map(d => d.subscription_count || 0),
                    backgroundColor: colors,
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw || 0;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${context.label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                cutout: '70%'
            }
        });

        // Custom Legend with percentages
        const legendContainer = document.getElementById('packageLegend');
        legendContainer.innerHTML = data.map((d, i) => {
            const percentage = total > 0 ? ((d.subscription_count / total) * 100).toFixed(1) : 0;
            return `
                <div class="flex items-center gap-1.5 bg-slate-50 px-2 py-1 rounded-md">
                    <div class="w-2 h-2 rounded-full" style="background-color: ${colors[i] || '#ccc'}"></div>
                    <span class="text-[10px] font-black text-slate-600 truncate max-w-[80px]" title="${d.package_name}">
                        ${d.package_name}
                    </span>
                    <span class="text-[10px] font-bold text-slate-400">${percentage}%</span>
                </div>
            `;
        }).join('');
    }

    function refreshDashboard() {
        document.getElementById('lastUpdated').innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Refreshing...';
        loadDashboardData();
    }

    function updateLastUpdated() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: true 
        });
        document.getElementById('lastUpdated').innerText = `Updated at ${timeString}`;
    }

    function exportRevenueData() {
        if (!dashboardData || !dashboardData.charts.monthlyRevenue) {
            alert('No data available to export');
            return;
        }

        const csvContent = "data:text/csv;charset=utf-8," 
            + ["Month,Revenue (KES)"]
            .concat(dashboardData.charts.monthlyRevenue.map(d => 
                `${d.month_name || d.month},${d.revenue || 0}`
            ))
            .join("\n");

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `revenue_data_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function showLoadingState() {
        // Add loading indicator
        const elements = [
            'monthlyRevenue', 'activeClients', 'monthlyExpenditure', 'totalClients', 'overdueClients', 'inactiveClients', 'monthlySubRevenue', 'expiredClients', 'inventoryValue', 'inventorySalesValue', 'inventorySalesValue', 'inStockCount', 'outOfStockCount', 'pendingBookings', 'totalBookings', 'pendingTickets', 'receivedReports', 'pendingTasks'
        ];
        
        elements.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        });
    }

    function hideLoadingState() {
        // Remove any remaining loading indicators
        document.querySelectorAll('.fa-spinner').forEach(spinner => {
            spinner.parentElement.classList.remove('fa-spinner', 'fa-spin');
        });
    }

    function showErrorState(message) {
        const errorHtml = `
            <div class="col-span-full text-center py-12">
                <div class="w-16 h-16 rounded-full bg-rose-50 text-rose-500 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-2xl"></i>
                </div>
                <h3 class="text-lg font-black text-slate-700 mb-2">Failed to Load Dashboard</h3>
                <p class="text-sm text-slate-500 mb-4">${message || 'Please check your connection and try again.'}</p>
                <button onclick="loadDashboardData()" class="text-sm font-bold bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-redo mr-2"></i> Retry
                </button>
            </div>
        `;
        
        // Replace main content with error
        document.querySelector('.max-w-full').innerHTML = errorHtml;
    }

    async function fetchAdminInbox() {
        const container = document.getElementById('dispatchInboxContent');
        
        try {
            const response = await fetch('/api/hr/dispatch/inbox');
            if (!response.ok) throw new Error('Network response error');
            const data = await response.json();

            if (data.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-slate-400 text-xs font-bold uppercase">No records found</div>`;
                return;
            }

            container.innerHTML = data.slice(0, 15).map(msg => {
                const isHigh = msg.priority === 'high';
                const isDone = msg.status === 'processed' || msg.status === 'COMPLETED';
                
                return `
                    <div class="action-btn p-3 rounded-xl border border-slate-50 flex flex-col gap-2 transition-all ${isDone ? 'opacity-60 grayscale-[0.5]' : 'bg-white shadow-sm'}">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full ${isHigh ? 'bg-rose-500' : 'bg-blue-400'}"></span>
                                <span class="text-[9px] font-black text-slate-400 uppercase tracking-tighter">${msg.priority} priority</span>
                            </div>
                            <span class="text-[9px] font-bold text-slate-400">${new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                        </div>
                        
                        <p class="text-xs font-bold text-slate-700 leading-relaxed line-clamp-2" title="${msg.message_content}">
                            ${msg.message_content}
                        </p>
                    </div>
                `;
            }).join('');

        } catch (err) {
            container.innerHTML = `<div class="text-center py-10 text-rose-400 text-xs font-black uppercase">Sync Failed</div>`;
        }
    }
</script>