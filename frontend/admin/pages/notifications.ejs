<style>
    .skeleton { 
      background: #e5e7eb; 
      animation: skeleton 1.2s ease-in-out infinite alternate; 
      border-radius: 0.5rem;
    }
    @keyframes skeleton { 
      to { background-color: #f3f4f6; } 
    }
    .skeleton-circle { width: 3rem; height: 3rem; border-radius: 9999px; }
    .skeleton-title { height: 1.5rem; width: 70%; }
    .skeleton-text { height: 1rem; }

    .notification-card {
      border-bottom: 1px solid #e5e7eb;
    }
    .notification-card:last-child {
      border-bottom: none;
    }
    .unread-dot {
      width: 10px;
      height: 10px;
      background-color: #14b8a6;
      border-radius: 50%;
      box-shadow: 0 0 0 4px rgba(20, 184, 166, 0.1);
    }
    .type-badge {
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      background-color: #f3f4f6;
      color: #4b5563;
    }
  </style>

<!-- Header -->
<div class="bg-white shadow-sm border-b border-gray-200">
  <div class="px-6 py-6 flex items-center justify-between">
    <div class="flex items-center gap-4">
      <div class="relative">
        <i class="fas fa-bell text-3xl text-teal-600"></i>
        <span id="unreadBadge" class="absolute -top-2 -right-2 bg-teal-600 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center shadow-lg">
          0
        </span>
      </div>
      <div>
        <h3 class="text-2xl font-bold text-teal-700">Notifications</h3>
        <p class="text-gray-600 mt-1">Stay updated with announcements and alerts</p>
      </div>
    </div>
    <div class="flex gap-3">
      <button id="markAllBtn" class="px-5 py-2.5 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium shadow-md transition flex items-center gap-2">
        <i class="fas fa-check-double"></i> Mark All Read
      </button>
      <button onclick="loadNotifications()" class="px-5 py-2.5 bg-teal-600 hover:bg-teal-700 text-white rounded-lg font-medium shadow-md transition flex items-center gap-2">
        <i class="fas fa-sync-alt mr-2"></i> Refresh
      </button>
    </div>
  </div>
</div>

<div class="max-w-full mx-auto">

  <!-- Notifications List -->
  <div class="bg-white shadow-xl overflow-hidden border border-gray-200">
    <div class="px-6 py-4 bg-gradient-to-r from-teal-50 to-cyan-50 border-b border-teal-100">
      <h3 class="text-lg font-bold text-teal-800">
        Your Notifications
      </h3>
    </div>

    <div id="notificationsContainer" class="divide-y divide-gray-100">
      <!-- Skeleton Loader -->
      <div class="p-6 flex gap-5 notification-card">
        <div class="skeleton skeleton-circle flex-shrink-0"></div>
        <div class="flex-1 space-y-3">
          <div class="skeleton skeleton-title"></div>
          <div class="skeleton skeleton-text w-full"></div>
          <div class="skeleton skeleton-text w-4/5"></div>
        </div>
      </div>
      <div class="p-6 flex gap-5 notification-card">
        <div class="skeleton skeleton-circle flex-shrink-0"></div>
        <div class="flex-1 space-y-3">
          <div class="skeleton skeleton-title"></div>
          <div class="skeleton skeleton-text w-11/12"></div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="hidden p-16 text-center bg-gray-50">
      <div class="w-24 h-24 mx-auto mb-6 bg-teal-50 rounded-full flex items-center justify-center">
        <i class="fas fa-bell-slash text-5xl text-teal-300"></i>
      </div>
      <h3 class="text-2xl font-semibold text-gray-700 mb-2">All caught up!</h3>
      <p class="text-gray-500 text-lg">You have no notifications at the moment.</p>
    </div>

    <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 text-sm text-gray-600 font-medium">
      <span id="totalCount">0</span> notification<span id="plural">s</span>
    </div>
  </div>
</div>

<script>
  const API_BASE = "/api";
  let allNotifications = [];
  let unreadCount = 0;

  const $ = (id) => document.getElementById(id);



  const formatTime = (dateString) => {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return "Just now";
    if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
    if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
    return date.toLocaleDateString("en-KE", { day: "numeric", month: "short", year: "numeric" });
  };

  const getIconAndColor = (type) => {
    const map = {
      announcement: { icon: "fas fa-bullhorn", color: "bg-purple-500" },
      alert:       { icon: "fas fa-exclamation-triangle", color: "bg-red-500" },
      task:        { icon: "fas fa-tasks", color: "bg-blue-500" },
      system:      { icon: "fas fa-cog", color: "bg-gray-600" },
    };
    return map[type] || { icon: "fas fa-bell", color: "bg-teal-500" };
  };

  const showSkeleton = () => {
    $("notificationsContainer").innerHTML = Array(6).fill("").map(() => `
      <div class="p-6 flex gap-5 notification-card">
        <div class="skeleton skeleton-circle flex-shrink-0"></div>
        <div class="flex-1 space-y-3">
          <div class="skeleton skeleton-title"></div>
          <div class="skeleton skeleton-text w-full"></div>
          <div class="skeleton skeleton-text w-4/5"></div>
        </div>
      </div>
    `).join("");
  };

  const loadNotifications = async () => {
    showSkeleton();
    $("unreadBadge").textContent = "...";

    try {
      const res = await fetch(`${API_BASE}/notifications`, { 
        headers: { 'Cache-Control': 'no-cache' }
      });
      if (!res.ok) throw new Error("Failed to load");

      const data = await res.json();
      allNotifications = data.notifications || [];
      unreadCount = data.unreadCount || 0;

      $("unreadBadge").textContent = unreadCount > 99 ? "99+" : unreadCount;
      $("unreadBadge").classList.toggle("hidden", unreadCount === 0);

      renderNotifications();
    } catch (err) {
      $("notificationsContainer").innerHTML = `
        <div class="p-12 text-center text-red-600">
          <p class="font-medium">Failed to load notifications</p>
          <button onclick="loadNotifications()" class="mt-4 text-teal-600 underline font-medium">Try again</button>
        </div>`;
    }
  };

  const renderNotifications = () => {
    const container = $("notificationsContainer");
    const totalEl = $("totalCount");
    const pluralEl = $("plural");

    if (allNotifications.length === 0) {
      container.innerHTML = "";
      $("emptyState").classList.remove("hidden");
      totalEl.textContent = "0";
      pluralEl.textContent = "s";
      return;
    }

    $("emptyState").classList.add("hidden");

    container.innerHTML = allNotifications.map(notif => {
      const { icon, color } = getIconAndColor(notif.type);
      const isUnread = notif.is_read == 0;

      return `
        <div class="p-6 flex gap-5 notification-card ${isUnread ? 'bg-teal-50' : 'bg-white'}">
          <div class="${color} text-white w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0 shadow-md">
            <i class="${icon} text-xl"></i>
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex items-start justify-between gap-6">
              <div class="flex-1">
                <div class="flex items-center gap-3">
                  <h4 class="font-bold text-gray-900 text-lg">${notif.title}</h4>
                  ${isUnread ? '<div class="unread-dot"></div>' : ''}
                </div>
                <p class="text-gray-700 mt-2 text-sm leading-relaxed">${notif.message}</p>
              </div>
              <div class="text-right">
                <div class="text-xs text-gray-500 mb-3">${formatTime(notif.created_at)}</div>
                ${isUnread ? `
                  <button class="mark-read-btn px-4 py-2 bg-teal-600 hover:bg-teal-700 text-white text-xs font-medium rounded-lg transition shadow-sm"
                          data-id="${notif.id}">
                    Mark as Read
                  </button>
                ` : ''}
              </div>
            </div>
            <div class="mt-4">
              <span class="type-badge">${notif.type}</span>
            </div>
          </div>
        </div>
      `;
    }).join("");

    totalEl.textContent = allNotifications.length;
    pluralEl.textContent = allNotifications.length === 1 ? "" : "s";

    // Attach "Mark as Read" buttons with optimistic update
    document.querySelectorAll('.mark-read-btn').forEach(btn => {
      btn.onclick = async (e) => {
        e.stopPropagation();
        const id = parseInt(btn.dataset.id);
        const notif = allNotifications.find(n => n.id === id);
        if (!notif || notif.is_read === 1) return;

        // Instant UI update
        notif.is_read = 1;
        unreadCount = Math.max(0, unreadCount - 1);
        $("unreadBadge").textContent = unreadCount > 99 ? "99+" : unreadCount;
        $("unreadBadge").classList.toggle("hidden", unreadCount === 0);
        showNotification("Marked as read!", "success");
        renderNotifications();

        // Sync with server
        try {
          const res = await fetch(`/api/notifications/${id}/read`, { method: "PUT" });

          if (res.ok) {
            setTimeout(() => {
              location.reload();
            }, 300);
          }
        } catch (err) {
          showNotification("Sync failed", "error");
        }
      };
    });
  };

  // Mark All as Read - Optimistic
  document.getElementById("markAllBtn").addEventListener("click", async () => {
    if (unreadCount === 0) return;

    // Instant UI update
    allNotifications.forEach(n => n.is_read = 1);
    unreadCount = 0;
    $("unreadBadge").classList.add("hidden");
    showNotification("All marked as read!", "success");
    renderNotifications();

    try {
      const res = await fetch('/api/notifications/read-all', { method: 'PUT' });

      if (res.ok) {
        setTimeout(() => location.reload(), 400);
      }
    } catch (err) {
      showNotification("Failed to sync", "error");
    }
  });

  // Auto load
  document.addEventListener("DOMContentLoaded", () => {
    loadNotifications();
    setInterval(loadNotifications, 60000);
  });
</script>