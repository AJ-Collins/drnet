<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dr.Net Labs - <%= pageTitle || 'Admin' %></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.13/dayjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      html,
      body {
        height: 100%;
        overflow: hidden;
      }

      @keyframes pulse {
        0% { transform: translateX(50%) translateY(-50%) scale(1); }
        50% { transform: translateX(50%) translateY(-50%) scale(1.2); }
        100% { transform: translateX(50%) translateY(-50%) scale(1); }
      }

      #notificationBadge:not(.hidden) {
        animation: pulse 2s infinite;
      }
    </style>
  </head>
  <script>
  dayjs.extend(dayjs_plugin_relativeTime);
</script>
  <body class="bg-gradient-to-br from-white via-teal-50 to-teal-100">
    <!-- Main Layout Container -->
    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar -->
      <aside
        id="sidebar"
        class="w-64 bg-gradient-to-b from-teal-700 to-teal-800 text-white transition-all duration-300 ease-in-out flex-shrink-0 lg:relative fixed inset-y-0 left-0 z-50"
      >
        <div class="flex flex-col h-full">
          <!-- Logo & Brand -->
          <div class="p-6 border-b border-teal-600 flex-shrink-0">
            <div class="flex items-center space-x-3">
              <div
                class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center"
              >
                <i class="fas fa-network-wired text-white text-xl"></i>
              </div>
              <div>
                <h1 class="text-lg font-bold">DR.NET LABS</h1>
                <p class="text-teal-200 text-xs">Innovating Connectivity</p>
              </div>
            </div>
          </div>

          <!-- Navigation -->
          <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <% const pages = [ {slug:'dashboard', name:'Dashboard'},
            {slug:'operational-inbox', name:'Operational Inbox'},
            {slug:'staff-attendance', name:'Staff Attendance'},
            {slug:'subscriptions', name:'Subscriptions'},
            { slug: 'reminders', name:'Reminders' },
            { slug: 'my-packages', name: 'My Packages' },
            {slug:'manage-users', name:'User Management'},
            {slug:'service-management', name:'Service Management'},
            { slug:'reports', name:'Generated Reports' },            
            {slug:'support-tickets', name:'Support Tickets'}, {slug:'finance',
            name:'Finance'},
            {slug:'website-bookings', name:'Website Bookings'},
            {slug:'communication-team', name:'Team Communication'},
            {slug:'inventory', name:'Inventory'}, {slug:'profile',
            name:'Profile'} ]; %> <% pages.forEach(p => { %>
            <a
              href="/admin/<%= p.slug %>"
              class="nav-link flex items-center px-4 py-3 rounded-lg w-full <%= currentPage===p.slug ? 'bg-teal-900/50 text-white font-medium' : 'text-teal-100 font-medium' %> transition-all duration-200 hover:bg-teal-900/50 hover:text-white hover:translate-x-1"
            >
              <i
                class="fas <%= 
                  p.slug === 'dashboard' ? 'fa-chart-pie' :
                  p.slug === 'operational-inbox' ? 'fa-inbox' :
                  p.slug.includes('attendance') ? 'fa-user-check' :
                  p.slug === 'subscriptions' ? 'fas fa-wifi' :
                  p.slug.includes('users') ? 'fa-users' :
                  p.slug.includes('service') ? 'fa-tools' :
                  p.slug.includes('reports') ? 'fa-calendar-day' :
                  p.slug.includes('reminders') ? 'fa-bell':
                  p.slug.includes('ticket') ? 'fa-ticket-alt' :
                  p.slug.includes('finance') ? 'fa-dollar-sign' :
                  p.slug.includes('booking') ? 'fa-globe' :
                  p.slug.includes('communication') ? 'fa-comments' :
                  p.slug.includes('inventory') ? 'fa-tools' :
                  p.slug === 'my-packages' ? 'fa-box' :  // Added this line
                  'fa-cog' 
                %> w-6 text-lg"
              ></i>


              <span><%= p.name %></span>
            </a>
            <% }); %>
          </nav>
        </div>
      </aside>

      <!-- Sidebar Overlay (Mobile Only) -->
      <div
        id="sidebarOverlay"
        class="fixed inset-0 bg-black bg-opacity-50 z-30 lg:hidden hidden"
      ></div>

      <!-- Main Content Area -->
      <div class="flex-1 flex flex-col min-w-0 h-screen overflow-hidden">
        <!-- Header -->
        <header
          class="bg-white shadow-md border-b border-teal-100 flex-shrink-0 z-40"
        >
          <div
            class="px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between"
          >
            <div class="flex items-center space-x-4">
              <!-- Menu Toggle (All Screens) -->
              <button
                id="mobileMenuBtn"
                class="p-2 rounded-lg hover:bg-teal-50 text-teal-700 transition"
              >
                <i class="fas fa-bars text-xl"></i>
              </button>
              <div>
                <h1 id="pageTitle" class="text-2xl font-bold text-teal-800">
                  Admin
                </h1>
                <p id="pageSubtitle" class="text-sm text-teal-600">
                  Welcome to Dr.Net Technology Labs
                </p>
              </div>
            </div>

            <!-- Header Actions -->
            <div class="flex items-center space-x-2">
              <!-- Notifications -->
              <div class="relative inline-block">
                <button
                  id="notificationBtn"
                  class="p-2 rounded-lg hover:bg-teal-50 text-teal-700 transition relative"
                >
                  <!-- Bell Icon -->
                  <i class="fas fa-bell text-xl"></i>

                  <!-- Unread Count Badge -->
                  <span 
                    id="notificationBadge"
                    class="absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 
                          min-w-5 h-5 bg-red-600 text-white text-xs font-bold 
                          rounded-full flex items-center justify-center shadow-lg
                          border-2 border-white
                          hidden"
                  >
                    0
                  </span>
                </button>

                <!-- Notification Dropdown -->
                <div
                  id="notificationDropdown"
                  class="absolute right-0 mt-2 w-96 bg-white rounded-2xl shadow-2xl z-50 hidden border border-gray-100 overflow-hidden"
                >
                  <div class="p-5 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="font-bold text-gray-800 text-lg">Notifications</h3>
                    <button id="markAllReadBtn" class="text-sm text-teal-600 hover:text-teal-700 font-medium">
                      Mark all as read
                    </button>
                  </div>

                  <div id="notificationsList" class="max-h-96 overflow-y-auto">
                    <!-- JS will populate here -->
                    <div class="p-8 text-center text-gray-400">
                      <i class="fas fa-bell-slash text-4xl mb-3"></i>
                      <p>No notifications yet</p>
                    </div>
                  </div>

                  <% const notificationsSlug = "notifications"; %>
                  <div class="p-4 border-t border-gray-200 text-center">
                    <a href="/admin/<%= notificationsSlug %>" class="text-teal-600 hover:text-teal-700 font-medium">
                      View all notifications â†’
                    </a>
                  </div>
                </div>
              </div>

              <!-- User Menu -->
              <div class="relative">
                <button
                  id="userMenuBtn"
                  class="flex items-center space-x-3 p-2 rounded-lg hover:bg-teal-50 transition"
                >
                  <div
                    class="w-9 h-9 bg-teal-200 rounded-full flex items-center justify-center"
                  >
                    <span class="text-teal-800 font-bold text-sm"></span>
                  </div>
                  <span class="hidden sm:block font-medium text-gray-800"
                    >N/A</span
                  >
                  <i class="fas fa-chevron-down text-sm text-gray-600"></i>
                </button>

                <!-- User Dropdown -->
                <% const profilePageSlug = "profile"; %>
                <div
                  id="userDropdown"
                  class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-xl py-2 z-50 hidden border border-teal-100"
                >
                  <a
                   href="/admin/<%= profilePageSlug %>"
                    class="flex items-center px-4 py-2 text-gray-700 hover:bg-teal-50 transition"
                  >
                    <i class="fas fa-user mr-3 text-teal-600"></i> My Profile
                  </a>
                  <div class="border-t border-gray-200 my-1"></div>
                  <a
                    href="#"
                    id="logoutBtn"
                    class="flex items-center px-4 py-2 text-red-600 hover:bg-red-50 transition"
                  >
                    <i class="fas fa-sign-out-alt mr-3"></i> Logout
                  </a>
                </div>
              </div>
            </div>
          </div>
        </header>

        <!-- Page Content Container -->
        <div class="flex-1 overflow-y-auto flex flex-col">
          <!-- Page Content Container -->
          <main class="p-2 sm:p-2 lg:p-6 flex-1">
            <div id="pageContent" class="p-2">
              <%- include(`pages/${currentPage}`) %>
            </div>
          </main>

          <!-- Footer -->
          <footer class="bg-gray-700 text-white py-4">
            <div class="container mx-auto px-4 text-center text-sm">
              <p>&copy; 2025 Dr.Net Technology Labs. All rights reserved.</p>
            </div>
          </footer>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script>
      // Initialize sidebar state
      function initSidebar() {
        const sidebar = document.getElementById("sidebar");
        const isLargeScreen = window.innerWidth >= 1024;

        if (isLargeScreen) {
          sidebar.style.marginLeft = "0";
          sidebar.style.transform = "translateX(0)";
        } else {
          sidebar.style.marginLeft = "0";
          sidebar.style.transform = "translateX(-100%)";
        }
      }

      // Toggle sidebar
      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("sidebarOverlay");
        const isLargeScreen = window.innerWidth >= 1024;

        if (isLargeScreen) {
          // Desktop: sidebar pushes content
          const currentMargin = sidebar.style.marginLeft;
          if (currentMargin === "0px" || currentMargin === "") {
            sidebar.style.marginLeft = "-16rem";
          } else {
            sidebar.style.marginLeft = "0";
          }
        } else {
          // Mobile: sidebar overlays content
          const currentTransform = sidebar.style.transform;
          if (
            currentTransform === "translateX(0px)" ||
            currentTransform === "translateX(0%)"
          ) {
            sidebar.style.transform = "translateX(-100%)";
            overlay.classList.add("hidden");
          } else {
            sidebar.style.transform = "translateX(0)";
            overlay.classList.remove("hidden");
          }
        }
      }

      // Mobile menu button
      document
        .getElementById("mobileMenuBtn")
        .addEventListener("click", toggleSidebar);

      // Sidebar overlay
      document
        .getElementById("sidebarOverlay")
        .addEventListener("click", toggleSidebar);

      // Handle window resize
      window.addEventListener("resize", function () {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("sidebarOverlay");
        const isLargeScreen = window.innerWidth >= 1024;

        if (isLargeScreen) {
          sidebar.style.transform = "translateX(0)";
          sidebar.style.marginLeft = "0";
          overlay.classList.add("hidden");
        } else {
          sidebar.style.marginLeft = "0";
          sidebar.style.transform = "translateX(-100%)";
          overlay.classList.add("hidden");
        }
      });

      // Notification dropdown
      // document
      //   .getElementById("notificationBtn")
      //   .addEventListener("click", function (e) {
      //     e.stopPropagation();
      //     const dropdown = document.getElementById("notificationDropdown");
      //     const userDropdown = document.getElementById("userDropdown");
      //     userDropdown.classList.add("hidden");
      //     dropdown.classList.toggle("hidden");
      //   });

      // User dropdown
      document
        .getElementById("userMenuBtn")
        .addEventListener("click", function (e) {
          e.stopPropagation();
          const dropdown = document.getElementById("userDropdown");
          const notificationDropdown = document.getElementById(
            "notificationDropdown"
          );
          notificationDropdown.classList.add("hidden");
          dropdown.classList.toggle("hidden");
        });

      // Close dropdowns on outside click
      document.addEventListener("click", function (e) {
        const userDropdown = document.getElementById("userDropdown");
        const userBtn = document.getElementById("userMenuBtn");
        const notificationDropdown = document.getElementById(
          "notificationDropdown"
        );
        const notificationBtn = document.getElementById("notificationBtn");

        if (!userBtn.contains(e.target) && !userDropdown.contains(e.target)) {
          userDropdown.classList.add("hidden");
        }

        if (
          !notificationBtn.contains(e.target) &&
          !notificationDropdown.contains(e.target)
        ) {
          notificationDropdown.classList.add("hidden");
        }
      });

      // Logout
      document
        .getElementById("logoutBtn")
        .addEventListener("click", function (e) {
          e.preventDefault();

          if (confirm("Are you sure you want to log out?")) {
            // Start the logout process
            logoutUser();
          }
        });

      async function logoutUser() {
        try {
          // Send a POST request to the server's logout endpoint
          const response = await fetch("/api/logout", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
          });

          const data = await response.json();

          if (response.ok && data.success) {
            window.location.href = "/login";
          } else {
            alert("Logout failed: " + (data.error || "Please try again."));
          }
        } catch (error) {
          console.error("Network or system error during logout:", error);
          alert("A network error occurred. Please check your connection.");
        }
      }

      // Close sidebar when clicking nav links
      document.querySelectorAll(".nav-link").forEach((link) => {
        link.addEventListener("click", function (e) {
          const isLargeScreen = window.innerWidth >= 1024;
          if (!isLargeScreen) {
            toggleSidebar();
          }
        });
      });

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", initSidebar);

      //Notification
      let notificationContainer = document.getElementById(
        "notificationContainer"
      );
      if (!notificationContainer) {
        notificationContainer = document.createElement("div");
        notificationContainer.id = "notificationContainer";
        notificationContainer.className =
          "fixed top-4 right-4 flex flex-col gap-3 z-50";
        document.body.appendChild(notificationContainer);
      }

      function showNotification(message, type) {
        const colors = {
          success: "bg-teal-500",
          error: "bg-red-500",
          info: "bg-blue-500",
        };

        const notification = document.createElement("div");
        notification.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300`;
        notification.textContent = message;

        notificationContainer.prepend(notification);

        setTimeout(() => {
          notification.style.opacity = "0";
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }

      async function loadUserMenu() {
    const avatarCircle = document.querySelector('#userMenuBtn .w-9.h-9');
    const nameSpan     = document.querySelector('#userMenuBtn .font-medium');

    try {
      const res = await fetch('/api/profile', {
        method: 'GET',
        credentials: 'include',               // keep session cookies
        headers: { 'Cache-Control': 'no-cache' }
      });

      if (!res.ok) throw new Error('Failed to fetch profile');

      const data = await res.json();
      const profile = data.profile;           // <-- your API shape

      // ---- 1. Avatar -------------------------------------------------
      if (profile.image) {
        // create an <img> inside the circle
        const img = document.createElement('img');
        img.src = profile.image;
        img.alt = 'Profile';
        img.className = 'w-full h-full rounded-full object-cover';

        // replace the placeholder <div> with the image
        avatarCircle.innerHTML = '';
        avatarCircle.appendChild(img);
      } else {
        // keep the initials fallback
        const initials = (profile.name || 'U')
          .split(' ')
          .map(n => n[0])
          .join('')
          .toUpperCase()
          .substring(0, 2);
        avatarCircle.innerHTML = `<span class="text-teal-800 font-bold text-sm">${initials}</span>`;
      }

      // ---- 2. Name ---------------------------------------------------
      nameSpan.textContent = profile.name || 'User';

      // optional: tiny success toast
      // showNotification('Profile loaded', 'success');

    } catch (err) {
      console.error('loadUserMenu error:', err);
      showNotification('Could not load user info', 'error');

      // keep the static placeholder when everything fails
      avatarCircle.innerHTML = `<span class="text-teal-800 font-bold text-sm"></span>`;
      nameSpan.textContent = '';
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const dropdown = document.getElementById('notificationDropdown');
    const listContainer = document.getElementById('notificationsList');
    const markAllBtn = document.getElementById('markAllReadBtn');
    const badge = document.getElementById('notificationBadge');

    // Load and render notifications
    async function loadNotifications() {
    try {
      const res = await fetch('/api/notifications');
      if (!res.ok && res.status !== 304) throw new Error('Failed');

      const json = await res.json();
      const notifications = json.data || json.notifications || [];

      // Count unread ones
      const unreadCount = notifications.filter(n => n.is_read == 0).length;

      // Update badge
      const badge = document.getElementById('notificationBadge');
      if (unreadCount > 0) {
        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }

      // Clear list
      listContainer.innerHTML = '';

      if (notifications.length === 0) {
        listContainer.innerHTML = `
          <div class="p-8 text-center text-gray-400">
            <i class="fas fa-bell-slash text-4xl mb-3"></i>
            <p>No notifications yet</p>
          </div>`;
        return;
      }

      // Sort newest first
      notifications.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

      notifications.forEach(notif => {
        const isUnread = notif.is_read == 0;
        const timeAgo = dayjs(notif.created_at).fromNow(); // "2 minutes ago"

        const item = document.createElement('div');
        item.className = `p-4 border-b border-gray-100 hover:bg-teal-50 transition-all ${isUnread ? 'bg-teal-50' : ''}`;

        item.innerHTML = `
          <div class="flex items-start justify-between">
            <div class="flex-1 pr-3">
              <div class="flex items-center gap-2 mb-1">
                <span class="text-sm font-semibold text-gray-900">${notif.title}</span>
                ${isUnread ? '<span class="w-2 h-2 bg-teal-500 rounded-full"></span>' : ''}
              </div>
              <p class="text-sm text-gray-600 leading-relaxed">${notif.message}</p>
              <p class="text-xs text-gray-400 mt-2">${timeAgo}</p>
            </div>
            ${isUnread ? `
              <button 
                class="mark-read-btn text-xs text-teal-600 hover:text-teal-800 font-medium whitespace-nowrap"
                data-id="${notif.id}"
              >
                Mark read
              </button>
            ` : ''}
          </div>
        `;

        // Optional: click whole item to go somewhere
        // if (notif.link) item.onclick = () => location.href = notif.link;

        listContainer.appendChild(item);
      });

      // Re-attach mark read buttons
      document.querySelectorAll('.mark-read-btn').forEach(btn => {
        btn.onclick = async (e) => {
          e.stopPropagation();
          const id = btn.dataset.id;
          try {
            await fetch(`/api/notifications/${id}/read`, { 
              method: 'PUT',
              credentials: 'include'
            });
            loadNotifications();
          } catch {
            showNotification('Failed to mark as read', 'error');
          }
        };
      });

    } catch (err) {
      console.error('Load notifications failed:', err);
      listContainer.innerHTML = `<div class="p-4 text-center text-red-500">Failed to load notifications</div>`;
    }
  }
    // Mark all as read
    markAllBtn.addEventListener('click', async () => {
      try {
        await fetch('/api/notifications/read-all', { method: 'PUT' });
        loadNotifications();
        showNotification('All notifications marked as read', 'success');
      } catch (err) {
        showNotification('Failed to mark all as read', 'error');
      }
    });

    // Toggle dropdown
    document.getElementById('notificationBtn').addEventListener('click', (e) => {
      e.stopPropagation();
      dropdown.classList.toggle('hidden');
      if (!dropdown.classList.contains('hidden')) {
        loadNotifications(); // Reload when opening
      }
    });

    // Close when clicking outside
    document.addEventListener('click', (e) => {
      if (!document.getElementById('notificationBtn').contains(e.target) && 
          !dropdown.contains(e.target)) {
        dropdown.classList.add('hidden');
      }
    });

    // Initial load
    loadNotifications();
  });



  // -----------------------------------------------------------------
  // Run on DOM ready (you already have DOMContentLoaded elsewhere)
  // -----------------------------------------------------------------
  document.addEventListener('DOMContentLoaded', () => {
    loadUserMenu();
  });
    </script>
  </body>
</html>
