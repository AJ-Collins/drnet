<style>
  /* Skeleton Loading */
  @keyframes skeleton {
    0% {
      background-color: #f3f4f6;
    }
    100% {
      background-color: #e5e7eb;
    }
  }
  .skeleton {
    background: #e5e7eb;
    animation: skeleton 1.2s ease-in-out infinite;
    border-radius: 0.5rem;
  }
  .skeleton-text {
    height: 1rem;
  }
  .skeleton-title {
    height: 1.5rem;
    width: 60%;
  }
  .skeleton-circle {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 9999px;
  }
  .skeleton-badge {
    height: 1.75rem;
    width: 6rem;
  }
  .skeleton-ticket {
    height: 8rem;
  }
</style>
<div class="flex items-center justify-between mb-8">
  <div>
    <h3 class="text-3xl font-bold text-teal-800">Support Tickets</h3>
    <p class="text-teal-600 mt-1">
      Manage and respond to customer support requests
    </p>
  </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
  <!-- Total Tickets -->
  <div class="bg-white rounded-2xl shadow-lg p-6 border-2 border-teal-100">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-teal-600">Total Tickets</p>
        <p id="totalTickets" class="text-3xl font-bold text-teal-800 mt-1">0</p>
      </div>
      <div
        class="w-12 h-12 bg-teal-100 rounded-full flex items-center justify-center"
      >
        <i class="fas fa-ticket-alt text-teal-600 text-xl"></i>
      </div>
    </div>
  </div>

  <!-- Open Tickets -->
  <div class="bg-white rounded-2xl shadow-lg p-6 border-2 border-amber-100">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-amber-600">Open</p>
        <p id="openTickets" class="text-3xl font-bold text-amber-800 mt-1">0</p>
      </div>
      <div
        class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center"
      >
        <i class="fas fa-clock text-amber-600 text-xl"></i>
      </div>
    </div>
  </div>

  <!-- In Progress -->
  <div class="bg-white rounded-2xl shadow-lg p-6 border-2 border-blue-100">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-blue-600">In Progress</p>
        <p id="inProgressTickets" class="text-3xl font-bold text-blue-800 mt-1">
          0
        </p>
      </div>
      <div
        class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center"
      >
        <i class="fas fa-cog text-blue-600 text-xl"></i>
      </div>
    </div>
  </div>

  <!-- Resolved -->
  <div class="bg-white rounded-2xl shadow-lg p-6 border-2 border-green-100">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-green-600">Resolved</p>
        <p id="resolvedTickets" class="text-3xl font-bold text-green-800 mt-1">
          0
        </p>
      </div>
      <div
        class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center"
      >
        <i class="fas fa-check-circle text-green-600 text-xl"></i>
      </div>
    </div>
  </div>
</div>

<!-- Filters & Tickets List -->
<div class="bg-white rounded-2xl shadow-xl p-6 border-2 border-gray-100 mb-8">
  <div
    class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-6"
  >
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 flex-1">
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2"
          >Search</label
        >
        <input
          id="searchInput"
          type="text"
          placeholder="Ticket ID, Name, Phone..."
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-teal-500 transition"
        />
      </div>
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2"
          >Priority</label
        >
        <select
          id="priorityFilter"
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-teal-500 transition bg-white"
        >
          <option value="">All Priorities</option>
          <option value="Low">Low</option>
          <option value="Medium">Medium</option>
          <option value="High">High</option>
          <option value="Critical">Critical</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2"
          >Issue Type</label
        >
        <select
          id="issueTypeFilter"
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-teal-500 transition bg-white"
        >
          <option value="">All Types</option>
          <option value="Network Issue">Network Issue</option>
          <option value="Hardware Problem">Hardware Problem</option>
          <option value="Software Bug">Software Bug</option>
          <option value="Installation Request">Installation Request</option>
          <option value="Maintenance">Maintenance</option>
          <option value="Repair">Repair</option>
          <option value="Inspection">Inspection</option>
          <option value="Asset Recovery">Asset Recovery</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2"
          >Status</label
        >
        <select
          id="statusFilter"
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-teal-500 transition bg-white"
        >
          <option value="">All Status</option>
          <option value="Pending">Pending</option>
          <option value="In Progress">In Progress</option>
          <option value="Resolved">Resolved</option>
          <option value="Closed">Closed</option>
        </select>
      </div>
    </div>
    <div class="flex-shrink-0">
      <button
        onclick="refreshTickets()"
        id="refreshBtn"
        class="bg-gradient-to-r from-teal-500 to-teal-600 hover:from-teal-600 hover:to-teal-700 text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all flex items-center gap-2"
      >
        <i class="fas fa-sync"></i> Refresh
      </button>
    </div>
  </div>

  <!-- Tickets List Header -->
  <div class="border-t-2 border-gray-100 pt-4">
    <h3 class="text-lg font-bold text-gray-900 mb-4">
      <i class="fas fa-list mr-2 text-teal-600"></i>All Tickets
    </h3>
    <div id="allTicketsList" class="space-y-3">
      <!-- Skeleton Tickets -->
      <div class="bg-white border-2 border-gray-200 rounded-xl p-5">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
          <div class="space-y-2">
            <div class="skeleton skeleton-title"></div>
            <div class="skeleton h-4 w-32"></div>
          </div>
          <div class="space-y-2">
            <div class="skeleton skeleton-title"></div>
          </div>
          <div class="space-y-2">
            <div class="skeleton skeleton-title"></div>
          </div>
          <div><div class="skeleton skeleton-badge"></div></div>
          <div><div class="skeleton skeleton-badge"></div></div>
        </div>
        <div class="mt-4 flex justify-end">
          <div class="skeleton w-32 h-10 rounded-lg"></div>
        </div>
      </div>
      <!-- Repeat 3 more -->
      <div class="bg-white border-2 border-gray-200 rounded-xl p-5">
        <div class="skeleton skeleton-ticket"></div>
      </div>
      <div class="bg-white border-2 border-gray-200 rounded-xl p-5">
        <div class="skeleton skeleton-ticket"></div>
      </div>
      <div class="bg-white border-2 border-gray-200 rounded-xl p-5">
        <div class="skeleton skeleton-ticket"></div>
      </div>
    </div>
  </div>
</div>
<!-- Modal (same as before, no changes) -->
<div
  id="ticketModal"
  class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/50"
>
  <div
    class="bg-white w-full max-w-5xl rounded-2xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col"
  >
    <div
      class="bg-gradient-to-r from-teal-600 to-teal-700 text-white p-6 flex justify-between items-center"
    >
      <div class="flex-1">
        <h3 class="text-2xl font-bold mb-1">Ticket Details</h3>
        <p id="modalTicketId" class="text-teal-100 text-sm"></p>
      </div>
      <button
        onclick="closeTicketModal()"
        class="text-white/90 hover:text-white transition"
      >
        <i class="fas fa-times text-2xl"></i>
      </button>
    </div>
    <div class="flex-1 overflow-y-auto">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">
        <div class="lg:col-span-1 space-y-4">
          <div class="bg-gray-50 rounded-xl p-5 border-2 border-gray-200">
            <h4 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
              <i class="fas fa-user text-teal-600"></i> Customer Information
            </h4>
            <div class="space-y-3 text-sm">
              <div>
                <p class="text-gray-500 text-xs font-semibold mb-1">
                  Full Name
                </p>
                <p id="modalFullName" class="font-semibold text-gray-900"></p>
              </div>
              <div>
                <p class="text-gray-500 text-xs font-semibold mb-1">
                  Phone Number
                </p>
                <p id="modalPhone" class="font-semibold text-gray-900"></p>
              </div>
            </div>
          </div>
          <div class="bg-gray-50 rounded-xl p-5 border-2 border-gray-200">
            <h4 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
              <i class="fas fa-info-circle text-teal-600"></i> Ticket Details
            </h4>
            <div class="space-y-3 text-sm">
              <div>
                <p class="text-gray-500 text-xs font-semibold mb-1">
                  Issue Type
                </p>
                <p id="modalIssueType" class="font-semibold text-gray-900"></p>
              </div>
              <div>
                <p class="text-gray-500 text-xs font-semibold mb-1">Priority</p>
                <span
                  id="modalPriority"
                  class="inline-block px-3 py-1 rounded-full text-xs font-bold"
                ></span>
              </div>
              <div>
                <p class="text-gray-500 text-xs font-semibold mb-1">Status</p>
                <select
                  id="modalStatus"
                  onchange="updateTicketStatus()"
                  class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg font-semibold focus:outline-none focus:border-teal-500"
                >
                  <option value="Pending">Pending</option>
                  <option value="In Progress">In Progress</option>
                  <option value="Resolved">Resolved</option>
                  <option value="Closed">Closed</option>
                </select>
              </div>
              <div>
                <p class="text-gray-500 text-xs font-semibold mb-1">Created</p>
                <p id="modalCreated" class="text-gray-700"></p>
              </div>
            </div>
          </div>
        </div>
        <div class="lg:col-span-2 flex flex-col h-[600px]">
          <div
            class="flex-1 overflow-y-auto bg-gray-50 rounded-xl p-5 border-2 border-gray-200 mb-4"
          >
            <div id="conversationMessages" class="space-y-4"></div>
          </div>
          <div class="bg-white border-2 border-gray-200 rounded-xl p-4">
            <textarea
              id="responseMessage"
              rows="4"
              placeholder="Type your response..."
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-teal-500 transition resize-none mb-3"
            ></textarea>
            <div class="flex items-center justify-end">
              <button
                onclick="sendResponse()"
                class="bg-gradient-to-r from-teal-500 to-teal-600 text-white px-6 py-3 rounded-xl font-semibold hover:from-teal-600 hover:to-teal-700 transition-all shadow-lg flex items-center gap-2"
              >
                <span>Response</span> <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div
      class="p-6 border-t-2 border-gray-100 bg-gray-50 flex justify-between items-center"
    >
      <button
        onclick="deleteTicket()"
        class="px-6 py-3 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 transition flex items-center gap-2"
      >
        <i class="fas fa-trash"></i> Delete Ticket
      </button>
      <button
        onclick="closeTicketModal()"
        class="px-6 py-3 bg-gray-600 text-white font-semibold rounded-xl hover:bg-gray-700 transition"
      >
        Close
      </button>
    </div>
  </div>
</div>

<script>
  const API_BASE = "/api";
  const $ = (id) => document.getElementById(id);
  let tickets = [];
  let currentTicket = null;

  // Load Tickets
  const loadTickets = async () => {
    try {
      const res = await fetch(`${API_BASE}/tickets`);
      if (!res.ok) throw new Error("Failed to load");
      tickets = await res.json();
      tickets = tickets.map((ticket) => {
        if (!ticket.messages && ticket.message) {
          return {
            ...ticket,
            messages: [
              {
                from: ticket.fullName || "customer",
                message: ticket.message,
                time: ticket.created || "N/A",
              },
            ],
          };
        }
        return ticket;
      });
      renderTickets();
      updateStats();
    } catch (err) {
      $(
        "allTicketsList"
      ).innerHTML = `<p class="text-center text-red-600 py-8">Error: ${err.message}</p>`;
    }
  };

  // Render Stats
  const updateStats = () => {
    const active = tickets.filter((t) => !t.is_deleted);
    $("totalTickets").textContent = active.length;
    $("openTickets").textContent = active.filter(
      (t) => t.status === "Pending"
    ).length;
    $("inProgressTickets").textContent = active.filter(
      (t) => t.status === "In Progress"
    ).length;
    $("resolvedTickets").textContent = active.filter(
      (t) => t.status === "Resolved"
    ).length;
  };

  // Render Tickets
  const renderTickets = () => {
    const container = $("allTicketsList");
    const filtered = applyFilters();

    if (!filtered.length) {
      container.innerHTML =
        '<p class="text-center text-gray-500 py-8">No tickets found</p>';
      return;
    }

    const priorityColors = {
      Low: "bg-green-100 text-green-700",
      Medium: "bg-amber-100 text-amber-700",
      High: "bg-orange-100 text-orange-700",
      Critical: "bg-red-100 text-red-700",
    };
    const statusColors = {
      Pending: "bg-yellow-100 text-yellow-700",
      "In Progress": "bg-blue-100 text-blue-700",
      Resolved: "bg-green-100 text-green-700",
      Closed: "bg-gray-100 text-gray-700",
    };

    container.innerHTML = filtered
      .map(
        (t) => `
      <div class="bg-white border-2 border-gray-200 hover:border-teal-300 rounded-xl p-5 transition-all cursor-pointer" onclick="viewTicket(${
        t.id
      })">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div class="flex-1 grid grid-cols-1 md:grid-cols-5 gap-4">
            <div>
              <p class="text-xs text-gray-500 font-semibold mb-1">Customer</p>
              <p class="font-bold text-gray-900">${t.fullName}</p>
              <p class="text-sm text-gray-600">${t.phone}</p>
            </div>
            <div>
              <p class="text-xs text-gray-500 font-semibold mb-1">Ticket ID</p>
              <p class="font-semibold text-teal-600">#${t.ticket_id}</p>
            </div>
            <div>
              <p class="text-xs text-gray-500 font-semibold mb-1">Issue Type</p>
              <p class="text-sm font-semibold text-gray-900">${t.issueType}</p>
            </div>
            <div>
              <p class="text-xs text-gray-500 font-semibold mb-1">Priority</p>
              <span class="inline-block px-3 py-1 rounded-full text-xs font-bold ${
                priorityColors[t.priority]
              }">${t.priority}</span>
            </div>
            <div>
              <p class="text-xs text-gray-500 font-semibold mb-1">Status</p>
              <span class="inline-block px-3 py-1 rounded-full text-xs font-bold ${
                statusColors[t.status]
              }">${t.status}</span>
            </div>
          </div>
          <div class="flex-shrink-0">
            <button class="px-4 py-2 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition flex items-center gap-2">
              <i class="fas fa-eye"></i> View Details
            </button>
          </div>
        </div>
      </div>
    `
      )
      .join("");
  };

  // Filters
  const applyFilters = () => {
    let list = tickets.filter((t) => !t.is_deleted);
    const search = $("searchInput").value.toLowerCase();
    const priority = $("priorityFilter").value;
    const issueType = $("issueTypeFilter").value;
    const status = $("statusFilter").value;

    if (search) {
      list = list.filter(
        (t) =>
          t.fullName.toLowerCase().includes(search) ||
          t.phone.includes(search) ||
          t.ticket_id.toLowerCase().includes(search)
      );
    }
    if (priority) list = list.filter((t) => t.priority === priority);
    if (issueType) list = list.filter((t) => t.issueType === issueType);
    if (status) list = list.filter((t) => t.status === status);
    return list;
  };

  // Modal Actions
  const viewTicket = async (id) => {
    currentTicket = tickets.find((t) => t.id === id);
    if (!currentTicket) return;

    $("modalTicketId").textContent = `Ticket #${currentTicket.ticket_id}`;
    $("modalFullName").textContent = currentTicket.fullName;
    $("modalPhone").textContent = currentTicket.phone;
    $("modalIssueType").textContent = currentTicket.issueType;
    $("modalCreated").textContent = currentTicket.created;
    $("modalStatus").value = currentTicket.status;

    const priorityColors = {
      Low: "bg-green-100 text-green-700",
      Medium: "bg-amber-100 text-amber-700",
      High: "bg-orange-100 text-orange-700",
      Critical: "bg-red-100 text-red-700",
    };
    $("modalPriority").textContent = currentTicket.priority;
    $(
      "modalPriority"
    ).className = `inline-block px-3 py-1 rounded-full text-xs font-bold ${
      priorityColors[currentTicket.priority]
    }`;

    renderConversation();
    $("ticketModal").classList.remove("hidden");
  };

  const renderConversation = () => {
    const container = $("conversationMessages");
    if (!currentTicket.messages?.length) {
      container.innerHTML =
        '<p class="text-center text-gray-500 py-8">No responses yet.</p>';
      return;
    }

    container.innerHTML = currentTicket.messages
      .map((m) =>
        m.from === "staff"
          ? `
      <div class="flex items-start gap-3">
        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
          <i class="fas fa-user-tie text-blue-600"></i>
        </div>
        <div class="flex-1">
          <div class="flex items-center gap-2 mb-1">
            <span class="font-semibold text-gray-900 text-sm">Support Staff</span>
            <span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs font-semibold rounded-full">Staff</span>
            <span class="text-xs text-gray-500">${m.time}</span>
          </div>
          <div class="bg-blue-50 border-2 border-blue-100 rounded-2xl rounded-tl-none p-4">
            <p class="text-gray-900 text-sm">${m.message}</p>
          </div>
        </div>
      </div>
    `
          : `
      <div class="flex items-start gap-3 flex-row-reverse">
        <div class="w-10 h-10 bg-teal-100 rounded-full flex items-center justify-center flex-shrink-0">
          <i class="fas fa-user text-teal-600"></i>
        </div>
        <div class="flex-1 text-right">
          <div class="flex items-center gap-2 mb-1 justify-end">
            <span class="text-xs text-gray-500">${m.time}</span>
            <span class="font-semibold text-gray-900 text-sm">Customer</span>
          </div>
          <div class="bg-teal-50 border-2 border-teal-100 rounded-2xl rounded-tr-none p-4 text-left">
            <p class="text-gray-900 text-sm">${m.message}</p>
          </div>
        </div>
      </div>
    `
      )
      .join("");
    container.scrollTop = container.scrollHeight;
  };

  const sendResponse = async () => {
    const msg = $("responseMessage").value.trim();
    if (!msg || !currentTicket) return;

    const now = dayjs().format("MMM D, YYYY h:mm A");
    const newMsg = { from: "staff", message: msg, time: now };

    try {
      await fetch(`${API_BASE}/${currentTicket.id}/respond`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: msg, time: now }),
      });
      currentTicket.messages.push(newMsg);
      if (currentTicket.status === "Pending")
        currentTicket.status = "In Progress";
      $("responseMessage").value = "";
      renderConversation();
      renderTickets();
    } catch (err) {
      alert("Failed to send response");
    }
  };

  const updateTicketStatus = async () => {
    if (!currentTicket) return;
    const newStatus = $("modalStatus").value;
    try {
      await fetch(`${API_BASE}/${currentTicket.id}/status`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: newStatus }),
      });
      currentTicket.status = newStatus;
      renderTickets();
    } catch (err) {
      alert("Failed to update status");
    }
  };

  const deleteTicket = async () => {
    if (!currentTicket || !confirm("Delete this ticket?")) return;
    try {
      await fetch(`${API_BASE}/${currentTicket.id}`, { method: "DELETE" });
      currentTicket.is_deleted = true;
      closeTicketModal();
      renderTickets();
    } catch (err) {
      alert("Failed to delete");
    }
  };

  const closeTicketModal = () => {
    $("ticketModal").classList.add("hidden");
    currentTicket = null;
    $("responseMessage").value = "";
  };

  const refreshTickets = () => loadTickets();

  // Filters
  ["searchInput", "priorityFilter", "issueTypeFilter", "statusFilter"].forEach(
    (id) =>
      $(id)?.addEventListener("input", () => setTimeout(renderTickets, 300))
  );
  ["priorityFilter", "issueTypeFilter", "statusFilter"].forEach((id) =>
    $(id)?.addEventListener("change", renderTickets)
  );

  // Init
  window.onload = loadTickets;
</script>
