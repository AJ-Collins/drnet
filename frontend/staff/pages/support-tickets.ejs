<style>
  /* Skeleton Loading */
  @keyframes skeleton {
    0% {
      background-color: #f3f4f6;
    }
    100% {
      background-color: #e5e7eb;
    }
  }
  .skeleton {
    background: #e5e7eb;
    animation: skeleton 1.2s ease-in-out infinite;
    border-radius: 0.5rem;
  }
  .skeleton-text {
    height: 1rem;
  }
  .skeleton-title {
    height: 1.5rem;
    width: 60%;
  }
  .skeleton-circle {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 9999px;
  }
  .skeleton-badge {
    height: 1.75rem;
    width: 6rem;
  }
  .skeleton-ticket {
    height: 8rem;
  }
</style>
<div class="flex items-center justify-between mb-8">
  <div>
    <h3 class="text-3xl font-bold text-teal-800">Support Tickets</h3>
    <p class="text-teal-600 mt-1">
      Manage and respond to customer support requests
    </p>
  </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
  <!-- Total Tickets -->
  <div class="bg-white rounded-2xl shadow-lg p-6 border-2 border-teal-100">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-teal-600">Total Tickets</p>
        <p id="totalTickets" class="text-3xl font-bold text-teal-800 mt-1">0</p>
      </div>
      <div
        class="w-12 h-12 bg-teal-100 rounded-full flex items-center justify-center"
      >
        <i class="fas fa-ticket-alt text-teal-600 text-xl"></i>
      </div>
    </div>
  </div>

  <!-- Open Tickets -->
  <div class="bg-white rounded-2xl shadow-lg p-6 border-2 border-amber-100">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-amber-600">Open</p>
        <p id="openTickets" class="text-3xl font-bold text-amber-800 mt-1">0</p>
      </div>
      <div
        class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center"
      >
        <i class="fas fa-clock text-amber-600 text-xl"></i>
      </div>
    </div>
  </div>

  <!-- In Progress -->
  <div class="bg-white rounded-2xl shadow-lg p-6 border-2 border-blue-100">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-blue-600">In Progress</p>
        <p id="inProgressTickets" class="text-3xl font-bold text-blue-800 mt-1">
          0
        </p>
      </div>
      <div
        class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center"
      >
        <i class="fas fa-cog text-blue-600 text-xl"></i>
      </div>
    </div>
  </div>

  <!-- Resolved -->
  <div class="bg-white rounded-2xl shadow-lg p-6 border-2 border-green-100">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-green-600">Resolved</p>
        <p id="resolvedTickets" class="text-3xl font-bold text-green-800 mt-1">
          0
        </p>
      </div>
      <div
        class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center"
      >
        <i class="fas fa-check-circle text-green-600 text-xl"></i>
      </div>
    </div>
  </div>
</div>

<!-- Filters & Tickets List -->
<div class="bg-white rounded-2xl shadow-xl p-6 border-2 border-gray-100 mb-8">
  <div
    class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-6"
  >
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 flex-1">
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2"
          >Search</label
        >
        <input
          id="searchInput"
          type="text"
          placeholder="Ticket ID, Name, Phone..."
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-teal-500 transition"
        />
      </div>
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2"
          >Priority</label
        >
        <select
          id="priorityFilter"
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-teal-500 transition bg-white"
        >
          <option value="">All Priorities</option>
          <option value="Low">Low</option>
          <option value="Medium">Medium</option>
          <option value="High">High</option>
          <option value="Critical">Critical</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2"
          >Issue Type</label
        >
        <select
          id="issueTypeFilter"
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-teal-500 transition bg-white"
        >
          <option value="">All Types</option>
          <option value="Network Issue">Network Issue</option>
          <option value="Hardware Problem">Hardware Problem</option>
          <option value="Software Bug">Software Bug</option>
          <option value="Installation Request">Installation Request</option>
          <option value="Maintenance">Maintenance</option>
          <option value="Repair">Repair</option>
          <option value="Inspection">Inspection</option>
          <option value="Asset Recovery">Asset Recovery</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2"
          >Status</label
        >
        <select
          id="statusFilter"
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-teal-500 transition bg-white"
        >
          <option value="">All Status</option>
          <option value="Pending">Pending</option>
          <option value="In Progress">In Progress</option>
          <option value="Resolved">Resolved</option>
          <option value="Closed">Closed</option>
        </select>
      </div>
    </div>
    <div class="flex-shrink-0">
      <button
        onclick="refreshTickets()"
        id="refreshBtn"
        class="bg-gradient-to-r from-teal-500 to-teal-600 hover:from-teal-600 hover:to-teal-700 text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all flex items-center gap-2"
      >
        <i class="fas fa-sync"></i> Refresh
      </button>
    </div>
  </div>

  <!-- Tickets List Header -->
  <div class="border-t-2 border-gray-100 pt-4">
    <h3 class="text-lg font-bold text-gray-900 mb-4">
      <i class="fas fa-list mr-2 text-teal-600"></i>All Tickets
    </h3>
    <div id="allTicketsList" class="space-y-3">
      <!-- Skeleton Tickets -->
      <div class="bg-white border-2 border-gray-200 rounded-xl p-5">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
          <div class="space-y-2">
            <div class="skeleton skeleton-title"></div>
            <div class="skeleton h-4 w-32"></div>
          </div>
          <div class="space-y-2">
            <div class="skeleton skeleton-title"></div>
          </div>
          <div class="space-y-2">
            <div class="skeleton skeleton-title"></div>
          </div>
          <div><div class="skeleton skeleton-badge"></div></div>
          <div><div class="skeleton skeleton-badge"></div></div>
        </div>
        <div class="mt-4 flex justify-end">
          <div class="skeleton w-32 h-10 rounded-lg"></div>
        </div>
      </div>
      <!-- Repeat 3 more -->
      <div class="bg-white border-2 border-gray-200 rounded-xl p-5">
        <div class="skeleton skeleton-ticket"></div>
      </div>
      <div class="bg-white border-2 border-gray-200 rounded-xl p-5">
        <div class="skeleton skeleton-ticket"></div>
      </div>
      <div class="bg-white border-2 border-gray-200 rounded-xl p-5">
        <div class="skeleton skeleton-ticket"></div>
      </div>
    </div>
  </div>
</div>

<!--Modal-->
<div
  id="ticketModal"
  class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/50"
>
  <div
    class="bg-white w-full max-w-5xl rounded-2xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col"
  >
    <div
      class="bg-gradient-to-r from-teal-600 to-teal-700 text-white p-6 flex justify-between items-center"
    >
      <div class="flex-1">
        <h3 class="text-2xl font-bold mb-1">Ticket Details</h3>
        <p id="modalTicketId" class="text-teal-100 text-sm"></p>
      </div>
      <button
        onclick="closeTicketModal()"
        class="text-white/90 hover:text-white transition"
      >
        <i class="fas fa-times text-2xl"></i>
      </button>
    </div>
    <div class="flex-1 overflow-y-auto">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">
        <div class="lg:col-span-1 space-y-4">
          <div class="bg-gray-50 rounded-xl p-5 border-2 border-gray-200">
            <h4 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
              <i class="fas fa-user text-teal-600"></i> Customer Information
            </h4>
            <div class="space-y-3 text-sm">
              <div>
                <p class="text-gray-500 text-xs font-semibold mb-1">
                  Full Name
                </p>
                <p id="modalFullName" class="font-semibold text-gray-900"></p>
              </div>
              <div>
                <p class="text-gray-500 text-xs font-semibold mb-1">
                  Phone Number
                </p>
                <p id="modalPhone" class="font-semibold text-gray-900"></p>
              </div>
            </div>
          </div>
          <div class="bg-gray-50 rounded-xl p-5 border-2 border-gray-200">
            <h4 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
              <i class="fas fa-info-circle text-teal-600"></i> Ticket Details
            </h4>
            <div class="space-y-3 text-sm">
              <div>
                <p class="text-gray-500 text-xs font-semibold mb-1">
                  Issue Type
                </p>
                <p id="modalIssueType" class="font-semibold text-gray-900"></p>
              </div>
              <div>
                <p class="text-gray-500 text-xs font-semibold mb-1">Priority</p>
                <span
                  id="modalPriority"
                  class="inline-block px-3 py-1 rounded-full text-xs font-bold"
                ></span>
              </div>

              <div class="flex items-center space-x-3">
                <span
                  id="ticketStatusBadge"
                  class="px-3 py-1 rounded-full text-white font-semibold bg-yellow-500"
                >
                </span>
                <button
                  id="markResolvedBtn"
                  onclick="updateTicketStatus()"
                  class="px-3 py-1 bg-teal-500 text-white font-semibold rounded-lg hover:bg-teal-600 focus:outline-none"
                >
                  Mark as Resolved
                </button>
              </div>
              <div>
                <p class="text-gray-500 text-xs font-semibold mb-1">Created</p>
                <p id="modalCreated" class="text-gray-700"></p>
              </div>
            </div>
          </div>
        </div>
        <div class="lg:col-span-2 flex flex-col h-[600px]">
          <div
            class="flex-1 overflow-y-auto bg-gray-50 rounded-xl p-5 border-2 border-gray-200 mb-4"
          >
            <div id="conversationMessages" class="space-y-4"></div>
          </div>
          <div class="bg-white border-2 border-gray-200 rounded-xl p-4">
            <textarea
              id="responseMessage"
              rows="4"
              placeholder="Type your response..."
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-teal-500 transition resize-none mb-3"
            ></textarea>
            <div class="flex items-center justify-end">
              <button
                onclick="sendResponse()"
                class="bg-gradient-to-r from-teal-500 to-teal-600 text-white px-6 py-3 rounded-xl font-semibold hover:from-teal-600 hover:to-teal-700 transition-all shadow-lg flex items-center gap-2"
              >
                <span>Response</span> <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div
      class="p-6 border-t-2 border-gray-100 bg-gray-50 flex justify-between items-center"
    >
      <button
        onclick="closeTicketModal()"
        class="px-6 py-3 bg-gray-600 text-white font-semibold rounded-xl hover:bg-gray-700 transition"
      >
        Close
      </button>
    </div>
  </div>
</div>

<script>
  const API_BASE = "/api";
  let tickets = [];
  let currentTicket = null;
  let currentStaffId = null; // Will get from meta tag

  // Utility: Get element safely
  const $ = (id) => document.getElementById(id);

  // Escape HTML
  function escapeHtml(text) {
    if (!text) return "";
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }

  // Get current staff ID from meta tag (add this in your layout!)
  // <meta name="staff-id" content="{{ auth()->user()->id }}">
  currentStaffId =
    document.querySelector('meta[name="staff-id"]')?.content || null;

  // Load assigned tickets
  const loadTickets = async () => {
    try {
      const res = await fetch(`${API_BASE}/assigned/tickets`);
      if (!res.ok) throw new Error("Failed to load tickets");

      const data = await res.json();
      if (!data.success || !Array.isArray(data.tickets))
        throw new Error("Invalid data");

      tickets = data.tickets.map((t) => ({
        ...t,
        ticket_id: t.ticket_number,
        fullName: t.user?.name || "Unknown Customer",
        phone: t.user?.phone || "N/A",
        issueType: t.issue_type || "Other",
        priority:
          t.priority?.charAt(0).toUpperCase() +
            t.priority?.slice(1).toLowerCase() || "Medium",
        status:
          t.status
            ?.replace("_", " ")
            ?.replace(/\b\w/g, (l) => l.toUpperCase()) || "Open",
        created: new Date(t.created_at).toLocaleDateString("en-GB", {
          day: "numeric",
          month: "short",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        }),
      }));

      renderTickets();
      updateStats();
    } catch (err) {
      $("allTicketsList").innerHTML = `
        <div class="text-center py-16 text-red-600">
          <i class="fas fa-exclamation-triangle text-6xl mb-4"></i>
          <p class="text-xl font-bold">Failed to load tickets</p>
          <p class="text-sm mt-2">${escapeHtml(err.message)}</p>
          <button onclick="loadTickets()" class="mt-6 px-8 py-3 bg-red-600 text-white rounded-xl">Retry</button>
        </div>`;
    }
  };

  // Update stats
  const updateStats = () => {
    $("totalTickets").textContent = tickets.length;
    $("openTickets").textContent = tickets.filter(
      (t) => t.status === "Open"
    ).length;
    $("inProgressTickets").textContent = tickets.filter(
      (t) => t.status === "In Progress"
    ).length;
    $("resolvedTickets").textContent = tickets.filter(
      (t) => t.status === "Resolved"
    ).length;
  };

  // Apply filters
  const applyFilters = () => {
    let list = [...tickets];
    const search = $("searchInput")?.value.toLowerCase() || "";
    const priority = $("priorityFilter")?.value || "";
    const issueType = $("issueTypeFilter")?.value || "";
    const status = $("statusFilter")?.value || "";

    if (search) {
      list = list.filter(
        (t) =>
          t.fullName.toLowerCase().includes(search) ||
          t.ticket_id.includes(search) ||
          (t.description || "").toLowerCase().includes(search)
      );
    }
    if (priority) list = list.filter((t) => t.priority === priority);
    if (issueType) list = list.filter((t) => t.issueType === issueType);
    if (status) list = list.filter((t) => t.status === status);
    return list;
  };

  // Render tickets list
  const renderTickets = () => {
    const container = $("allTicketsList");
    const filtered = applyFilters();

    if (!filtered.length) {
      container.innerHTML = `
        <div class="text-center py-20 text-gray-500">
          <i class="fas fa-inbox text-9xl text-gray-200 mb-6"></i>
          <p class="text-2xl font-bold">No tickets assigned</p>
          <p class="text-lg mt-2">You're all caught up!</p>
        </div>`;
      return;
    }

    const priorityColors = {
      Low: "bg-green-100 text-green-700",
      Medium: "bg-amber-100 text-amber-700",
      High: "bg-orange-100 text-orange-700",
      Critical: "bg-red-100 text-red-700",
    };
    const statusColors = {
      Open: "bg-yellow-100 text-yellow-700",
      "In Progress": "bg-blue-100 text-blue-700",
      Resolved: "bg-green-100 text-green-700",
      Closed: "bg-gray-100 text-gray-700",
    };

    container.innerHTML = filtered
      .map(
        (t) => `
      <div onclick="viewTicket(${t.id})" 
           class="bg-white border-2 border-gray-200 hover:border-teal-500 rounded-2xl p-6 transition-all duration-300 cursor-pointer hover:shadow-2xl group">
        <div class="flex justify-between items-start mb-5">
          <div>
            <h4 class="text-xl font-bold text-gray-900">${escapeHtml(
              t.fullName
            )}</h4>
            <p class="text-teal-600 font-mono text-lg font-bold mt-1">#${
              t.ticket_id
            }</p>
          </div>
          <div class="flex gap-3">
            <span class="px-4 py-2 rounded-full text-xs font-bold ${
              priorityColors[t.priority] || "bg-gray-100 text-gray-700"
            }">
              ${t.priority}
            </span>
            <span class="px-4 py-2 rounded-full text-xs font-bold ${
              statusColors[t.status] || "bg-gray-100 text-gray-700"
            }">
              ${t.status}
            </span>
          </div>
        </div>

        <div class="mb-5">
          <p class="text-sm font-medium text-gray-600 mb-2">Issue:</p>
          <p class="text-gray-800 leading-relaxed">${escapeHtml(
            t.description || "No description"
          )}</p>
        </div>

        <div class="flex items-center justify-between text-sm text-gray-600">
          <div class="flex items-center gap-5">
            <span><i class="fas fa-tag text-teal-600 mr-2"></i>${
              t.issueType
            }</span>
            <span><i class="fas fa-clock text-gray-500 mr-2"></i>${
              t.created
            }</span>
          </div>
          <button class="px-6 py-3 bg-gradient-to-r from-teal-600 to-teal-700 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
            <i class="fas fa-comments"></i> Open Chat
          </button>
        </div>
      </div>
    `
      )
      .join("");
  };

  // View ticket modal
  const viewTicket = async (id) => {
    currentTicket = tickets.find((t) => t.id === id);
    if (!currentTicket) return;

    // Safe access to elements
    if ($("modalTicketId"))
      $("modalTicketId").textContent = `#${currentTicket.ticket_id}`;
    if ($("modalFullName"))
      $("modalFullName").textContent = currentTicket.fullName;
    if ($("modalPhone"))
      $("modalPhone").textContent = currentTicket.phone || "N/A";
    if ($("modalIssueType"))
      $("modalIssueType").textContent = currentTicket.issueType;
    if ($("modalCreated"))
      $("modalCreated").textContent = currentTicket.created;

    // Priority badge
    const pEl = $("modalPriority");
    if (pEl) {
      pEl.textContent = currentTicket.priority;
      pEl.className = `inline-block px-4 py-2 rounded-full text-xs font-bold ${
        currentTicket.priority === "Critical"
          ? "bg-red-100 text-red-800"
          : currentTicket.priority === "High"
          ? "bg-orange-100 text-orange-800"
          : currentTicket.priority === "Medium"
          ? "bg-amber-100 text-amber-800"
          : "bg-green-100 text-green-800"
      }`;
    }

    // Status badge
    const statusBadge = $("ticketStatusBadge");
    if (statusBadge) {
      statusBadge.textContent = currentTicket.status;
      statusBadge.className =
        currentTicket.status === "Resolved"
          ? "px-3 py-1 rounded-full text-white font-semibold bg-green-500"
          : "px-3 py-1 rounded-full text-white font-semibold bg-yellow-500";
    }

    // Mark as Resolved button
    updateResolvedButton();

    await loadMessagesForTicket(id);
    $("ticketModal")?.classList.remove("hidden");
  };

  // Load messages
  const loadMessagesForTicket = async (ticketId) => {
    try {
      const res = await fetch(`${API_BASE}/messages/ticket/${ticketId}`);
      if (!res.ok) throw new Error("Failed");
      const data = await res.json();
      currentTicket.messages = Array.isArray(data) ? data : data.messages || [];
      renderConversation();
    } catch (err) {
      currentTicket.messages = [];
      renderConversation();
    }
  };

  // RENDER CONVERSATION — PERFECT SENDER IDENTIFICATION
  const renderConversation = () => {
    const container = $("conversationMessages");
    if (!container || !currentTicket.messages?.length) {
      container.innerHTML = `<p class="text-center text-gray-500 py-16">No messages yet. Start the conversation!</p>`;
      return;
    }

    container.innerHTML = currentTicket.messages
      .map((m) => {
        const isCustomer = m.sender_user_id !== null;
        const isCurrentStaff =
          m.sender_staff_id && String(m.sender_staff_id) === currentStaffId;
        const isAdmin = m.sender_staff_id === 4; // Your admin ID
        const isOtherStaff = m.sender_staff_id && !isCurrentStaff && !isAdmin;

        let senderName = "Unknown";
        let bubbleClass = "bg-gray-100 border-gray-300";
        let avatarClass = "bg-gray-600";
        let avatarLetter = "?";
        let align = "flex-row-reverse";

        if (isCustomer) {
          senderName = "Customer";
          bubbleClass = "bg-teal-50 border-teal-200";
          avatarClass = "bg-teal-600";
          avatarLetter = "C";
          align = "flex-row-reverse";
        } else if (isCurrentStaff) {
          senderName = "You";
          bubbleClass = "bg-blue-50 border-blue-200";
          avatarClass = "bg-blue-600";
          avatarLetter = "Y";
          align = "";
        } else if (isAdmin) {
          senderName = "Admin";
          bubbleClass = "bg-purple-50 border-purple-200";
          avatarClass = "bg-purple-600";
          avatarLetter = "A";
          align = "";
        } else if (isOtherStaff) {
          senderName = "Staff";
          bubbleClass = "bg-orange-50 border-orange-200";
          avatarClass = "bg-orange-600";
          avatarLetter = "S";
          align = "";
        }

        return `
        <div class="flex items-start gap-4 ${align}">
          <div class="w-12 h-12 rounded-full flex-shrink-0 flex items-center justify-center text-white font-bold text-lg ${avatarClass}">
            ${avatarLetter}
          </div>
          <div class="flex-1 max-w-2xl">
            <div class="mb-2 text-xs text-gray-500 flex items-center gap-2 ${
              align === "" ? "" : "justify-end"
            }">
              <span class="font-bold ${
                isCustomer
                  ? "text-teal-700"
                  : isCurrentStaff
                  ? "text-blue-700"
                  : isAdmin
                  ? "text-purple-700"
                  : "text-orange-700"
              }">
                ${senderName}
                ${
                  isAdmin
                    ? '<span class="ml-2 px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded-full">Admin</span>'
                    : ""
                }
                ${
                  isOtherStaff
                    ? '<span class="ml-2 px-2 py-0.5 bg-orange-100 text-orange-700 text-xs rounded-full">Staff</span>'
                    : ""
                }
              </span>
              <span>${new Date(m.created_at).toLocaleString()}</span>
            </div>
            <div class="p-5 rounded-2xl ${bubbleClass} border-2">
              <p class="text-gray-900 leading-relaxed">${escapeHtml(
                m.message
              )}</p>
            </div>
          </div>
        </div>`;
      })
      .join("");

    container.scrollTop = container.scrollHeight;
  };

  // Send response
  const sendResponse = async () => {
    const input = $("responseMessage");
    const msg = input.value.trim();
    if (!msg || !currentTicket) return;

    try {
      await fetch(`${API_BASE}/messages`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ticket_id: currentTicket.id, message: msg }),
      });

      input.value = "";
      await loadMessagesForTicket(currentTicket.id);
      loadTickets();
    } catch (err) {
      alert("Failed to send");
    }
  };

  // Mark as Resolved
  const updateTicketStatus = async () => {
    if (!currentTicket) return;

    try {
      await fetch(`${API_BASE}/tickets/${currentTicket.id}/status`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: "resolved" }),
      });

      currentTicket.status = "Resolved";
      renderTickets();
      updateStats();
      updateResolvedButton();
    } catch (err) {
      alert("Failed to resolve");
    }
  };

  // Update "Mark as Resolved" button state
  const updateResolvedButton = () => {
    const btn = $("markResolvedBtn");
    const badge = $("ticketStatusBadge");

    if (currentTicket.status === "Resolved") {
      btn.textContent = "Resolved";
      btn.disabled = true;
      btn.className =
        "px-3 py-1 bg-gray-400 text-white font-semibold rounded-lg cursor-not-allowed";
      badge.className =
        "px-3 py-1 rounded-full text-white font-semibold bg-green-500";
      badge.textContent = "Resolved";
    } else {
      btn.textContent = "Mark as Resolved";
      btn.disabled = false;
      btn.className =
        "px-3 py-1 bg-teal-500 text-white font-semibold rounded-lg hover:bg-teal-600 focus:outline-none";
      badge.className =
        "px-3 py-1 rounded-full text-white font-semibold bg-yellow-500";
      badge.textContent = currentTicket.status;
    }
  };

  // Close modal
  const closeTicketModal = () => {
    $("ticketModal")?.classList.add("hidden");
    currentTicket = null;
    $("responseMessage").value = "";
  };

  // Filters (FIXED — no more ReferenceError)
  ["searchInput", "priorityFilter", "issueTypeFilter", "statusFilter"].forEach(
    (id) => {
      $(id)?.addEventListener("input", () => setTimeout(renderTickets, 300));
      $(id)?.addEventListener("change", renderTickets);
    }
  );

  // Refresh
  const refreshTickets = () => loadTickets();

  // Init
  window.onload = loadTickets;
</script>
