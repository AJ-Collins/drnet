<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dr.Net Labs - <%= pageTitle || 'Staff' %></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <meta name="staff-id" content="{{ auth()->user()->id }}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      html,
      body {
        height: 100%;
        overflow: hidden;
      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-white via-teal-50 to-teal-100">
    <!-- Main Layout Container -->
    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar -->
      <aside
        id="sidebar"
        class="w-64 bg-gradient-to-b from-teal-700 to-teal-800 text-white transition-all duration-300 ease-in-out flex-shrink-0 lg:relative fixed inset-y-0 left-0 z-50"
      >
        <div class="flex flex-col h-full">
          <!-- Logo & Brand -->
          <div class="p-6 border-b border-teal-600 flex-shrink-0">
            <div class="flex items-center space-x-3">
              <div
                class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center"
              >
                <i class="fas fa-network-wired text-white text-xl"></i>
              </div>
              <div>
                <h1 class="text-lg font-bold">DR.NET LABS</h1>
                <p class="text-teal-200 text-xs">Innovating Connectivity</p>
              </div>
            </div>
          </div>

          <!-- Navigation -->
          <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <% const pages = [ { slug:'dashboard', name:'Dashboard' }, {
            slug:'my-customers', name:'My Clients' }, {
            slug:'communication-team', name:'Team Communication' }, {
            slug:'work-schedule', name:'Work Schedule' }, {
            slug:'support-tickets', name:'Support Tickets' }, { slug:'profile',
            name:'Profile' } ]; %> <% pages.forEach(p => { %>
            <a
              href="/staff/<%= p.slug %>"
              class="nav-link flex items-center px-4 py-3 rounded-lg w-full <%= currentPage===p.slug ? 'bg-teal-900/50 text-white font-medium' : 'text-teal-100 font-medium' %> transition-all duration-200 hover:bg-teal-900/50 hover:text-white hover:translate-x-1"
            >
              <i
                class="fas <%= p.slug==='dashboard' ? 'fa-chart-pie' : p.slug.includes('attendance') ? 'fa-user-check' : p.slug.includes('users') ? 'fa-users' : p.slug.includes('service') ? 'fa-tools' : p.slug.includes('ticket') ? 'fa-ticket-alt' : p.slug.includes('finance') ? 'fa-dollar-sign' : p.slug.includes('renewals') ? 'fa-sync-alt' : p.slug.includes('booking') ? 'fa-globe' : p.slug.includes('communication') ? 'fa-comments' : p.slug.includes('equipments') ? 'fa-tools' : 'fa-cog' %> w-6 text-lg"
              ></i>

              <span><%= p.name %></span>
            </a>
            <% }); %>
          </nav>
        </div>
      </aside>

      <!-- Sidebar Overlay (Mobile Only) -->
      <div
        id="sidebarOverlay"
        class="fixed inset-0 bg-black bg-opacity-50 z-30 lg:hidden hidden"
      ></div>

      <!-- Main Content Area -->
      <div class="flex-1 flex flex-col min-w-0 h-screen overflow-hidden">
        <!-- Header -->
        <header
          class="bg-white shadow-md border-b border-teal-100 flex-shrink-0 z-40"
        >
          <div
            class="px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between"
          >
            <div class="flex items-center space-x-4">
              <!-- Menu Toggle (All Screens) -->
              <button
                id="mobileMenuBtn"
                class="p-2 rounded-lg hover:bg-teal-50 text-teal-700 transition"
              >
                <i class="fas fa-bars text-xl"></i>
              </button>
              <div>
                <h1 id="pageTitle" class="text-2xl font-bold text-teal-800">
                  Staff
                </h1>
                <p id="pageSubtitle" class="text-sm text-teal-600">
                  Welcome to Dr.Net Technology Labs
                </p>
              </div>
            </div>

            <!-- Header Actions -->
            <div class="flex items-center space-x-2">
              <!-- Notifications -->
              <div class="relative">
                <button
                  id="notificationBtn"
                  class="p-2 rounded-lg hover:bg-teal-50 text-teal-700 transition relative"
                >
                  <i class="fas fa-bell text-xl"></i>
                  <span
                    class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"
                  ></span>
                </button>

                <!-- Notification Dropdown -->
                <div
                  id="notificationDropdown"
                  class="absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-xl z-50 hidden border border-teal-100"
                >
                  <div class="p-4 border-b border-gray-200">
                    <h3 class="font-semibold text-gray-800">Notifications</h3>
                  </div>
                  <div class="max-h-96 overflow-y-auto">
                    <a
                      href="#"
                      class="flex items-start px-4 py-3 hover:bg-teal-50 transition border-b border-gray-100"
                    >
                      <div
                        class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3 flex-shrink-0"
                      >
                        <i class="fas fa-user text-blue-600"></i>
                      </div>
                      <div class="flex-1">
                        <p class="text-sm text-gray-800 font-medium">
                          New user registered
                        </p>
                        <p class="text-xs text-gray-500">
                          John Doe joined the platform
                        </p>
                        <p class="text-xs text-gray-400 mt-1">2 hours ago</p>
                      </div>
                    </a>
                    <a
                      href="#"
                      class="flex items-start px-4 py-3 hover:bg-teal-50 transition border-b border-gray-100"
                    >
                      <div
                        class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center mr-3 flex-shrink-0"
                      >
                        <i class="fas fa-ticket-alt text-yellow-600"></i>
                      </div>
                      <div class="flex-1">
                        <p class="text-sm text-gray-800 font-medium">
                          Support ticket opened
                        </p>
                        <p class="text-xs text-gray-500">
                          Ticket #1234: Connection issue
                        </p>
                        <p class="text-xs text-gray-400 mt-1">5 hours ago</p>
                      </div>
                    </a>
                    <a
                      href="#"
                      class="flex items-start px-4 py-3 hover:bg-teal-50 transition border-b border-gray-100"
                    >
                      <div
                        class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3 flex-shrink-0"
                      >
                        <i class="fas fa-dollar-sign text-green-600"></i>
                      </div>
                      <div class="flex-1">
                        <p class="text-sm text-gray-800 font-medium">
                          Payment received
                        </p>
                        <p class="text-xs text-gray-500">
                          Ksh 5,000 from Jane Smith
                        </p>
                        <p class="text-xs text-gray-400 mt-1">1 day ago</p>
                      </div>
                    </a>
                  </div>
                  <div class="p-3 border-t border-gray-200">
                    <a
                      href="#"
                      class="text-sm text-teal-600 hover:text-teal-700 font-medium block text-center"
                      >View all notifications</a
                    >
                  </div>
                </div>
              </div>

              <!-- User Menu -->
              <div class="relative">
                <button
                  id="userMenuBtn"
                  class="flex items-center space-x-3 p-2 rounded-lg hover:bg-teal-50 transition"
                >
                  <div
                    class="w-9 h-9 bg-teal-200 rounded-full flex items-center justify-center"
                  >
                    <span class="text-teal-800 font-bold text-sm">JO</span>
                  </div>
                  <span class="hidden sm:block font-medium text-gray-800"
                    >Julius Ojwang</span
                  >
                  <i class="fas fa-chevron-down text-sm text-gray-600"></i>
                </button>

                <!-- User Dropdown -->
                <% const profilePageSlug = "profile"; %>
                <div
                  id="userDropdown"
                  class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-xl py-2 z-50 hidden border border-teal-100"
                >
                  <a
                    href="/staff/<%= profilePageSlug %>"
                    class="flex items-center px-4 py-2 text-gray-700 hover:bg-teal-50 transition"
                  >
                    <i class="fas fa-user mr-3 text-teal-600"></i> My Profile
                  </a>
                  <div class="border-t border-gray-200 my-1"></div>
                  <a
                    href="#"
                    id="logoutBtn"
                    class="flex items-center px-4 py-2 text-red-600 hover:bg-red-50 transition"
                  >
                    <i class="fas fa-sign-out-alt mr-3"></i> Logout
                  </a>
                </div>
              </div>
            </div>
          </div>
        </header>

        <!-- Page Content Container -->
        <div class="flex-1 overflow-y-auto flex flex-col">
          <!-- Page Content Container -->
          <main class="p-2 sm:p-2 lg:p-6 flex-1">
            <div id="pageContent" class="p-2">
              <%- include(`pages/${currentPage}`) %>
            </div>
          </main>

          <!-- Footer -->
          <footer class="bg-gray-700 text-white py-4">
            <div class="container mx-auto px-4 text-center text-sm">
              <p>&copy; 2025 Dr.Net Technology Labs. All rights reserved.</p>
            </div>
          </footer>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script>
      // Initialize sidebar state
      function initSidebar() {
        const sidebar = document.getElementById("sidebar");
        const isLargeScreen = window.innerWidth >= 1024;

        if (isLargeScreen) {
          sidebar.style.marginLeft = "0";
          sidebar.style.transform = "translateX(0)";
        } else {
          sidebar.style.marginLeft = "0";
          sidebar.style.transform = "translateX(-100%)";
        }
      }

      // Toggle sidebar
      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("sidebarOverlay");
        const isLargeScreen = window.innerWidth >= 1024;

        if (isLargeScreen) {
          // Desktop: sidebar pushes content
          const currentMargin = sidebar.style.marginLeft;
          if (currentMargin === "0px" || currentMargin === "") {
            sidebar.style.marginLeft = "-16rem";
          } else {
            sidebar.style.marginLeft = "0";
          }
        } else {
          // Mobile: sidebar overlays content
          const currentTransform = sidebar.style.transform;
          if (
            currentTransform === "translateX(0px)" ||
            currentTransform === "translateX(0%)"
          ) {
            sidebar.style.transform = "translateX(-100%)";
            overlay.classList.add("hidden");
          } else {
            sidebar.style.transform = "translateX(0)";
            overlay.classList.remove("hidden");
          }
        }
      }

      // Mobile menu button
      document
        .getElementById("mobileMenuBtn")
        .addEventListener("click", toggleSidebar);

      // Sidebar overlay
      document
        .getElementById("sidebarOverlay")
        .addEventListener("click", toggleSidebar);

      // Handle window resize
      window.addEventListener("resize", function () {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("sidebarOverlay");
        const isLargeScreen = window.innerWidth >= 1024;

        if (isLargeScreen) {
          sidebar.style.transform = "translateX(0)";
          sidebar.style.marginLeft = "0";
          overlay.classList.add("hidden");
        } else {
          sidebar.style.marginLeft = "0";
          sidebar.style.transform = "translateX(-100%)";
          overlay.classList.add("hidden");
        }
      });

      // Notification dropdown
      document
        .getElementById("notificationBtn")
        .addEventListener("click", function (e) {
          e.stopPropagation();
          const dropdown = document.getElementById("notificationDropdown");
          const userDropdown = document.getElementById("userDropdown");
          userDropdown.classList.add("hidden");
          dropdown.classList.toggle("hidden");
        });

      // User dropdown
      document
        .getElementById("userMenuBtn")
        .addEventListener("click", function (e) {
          e.stopPropagation();
          const dropdown = document.getElementById("userDropdown");
          const notificationDropdown = document.getElementById(
            "notificationDropdown"
          );
          notificationDropdown.classList.add("hidden");
          dropdown.classList.toggle("hidden");
        });

      // Close dropdowns on outside click
      document.addEventListener("click", function (e) {
        const userDropdown = document.getElementById("userDropdown");
        const userBtn = document.getElementById("userMenuBtn");
        const notificationDropdown = document.getElementById(
          "notificationDropdown"
        );
        const notificationBtn = document.getElementById("notificationBtn");

        if (!userBtn.contains(e.target) && !userDropdown.contains(e.target)) {
          userDropdown.classList.add("hidden");
        }

        if (
          !notificationBtn.contains(e.target) &&
          !notificationDropdown.contains(e.target)
        ) {
          notificationDropdown.classList.add("hidden");
        }
      });

      // Logout
      document
        .getElementById("logoutBtn")
        .addEventListener("click", function (e) {
          e.preventDefault();

          if (confirm("Are you sure you want to log out?")) {
            // Start the logout process
            logoutUser();
          }
        });

      async function logoutUser() {
        try {
          // Send a POST request to the server's logout endpoint
          const response = await fetch("/api/logout", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
          });

          const data = await response.json();

          if (response.ok && data.success) {
            window.location.href = "/login";
          } else {
            alert("Logout failed: " + (data.error || "Please try again."));
          }
        } catch (error) {
          console.error("Network or system error during logout:", error);
          alert("A network error occurred. Please check your connection.");
        }
      }

      // Close sidebar when clicking nav links
      document.querySelectorAll(".nav-link").forEach((link) => {
        link.addEventListener("click", function (e) {
          const isLargeScreen = window.innerWidth >= 1024;
          if (!isLargeScreen) {
            toggleSidebar();
          }
        });
      });

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", initSidebar);

      //Notification
      let notificationContainer = document.getElementById(
        "notificationContainer"
      );
      if (!notificationContainer) {
        notificationContainer = document.createElement("div");
        notificationContainer.id = "notificationContainer";
        notificationContainer.className =
          "fixed top-4 right-4 flex flex-col gap-3 z-50";
        document.body.appendChild(notificationContainer);
      }

      function showNotification(message, type) {
        const colors = {
          success: "bg-teal-500",
          error: "bg-red-500",
          info: "bg-blue-500",
        };

        const notification = document.createElement("div");
        notification.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300`;
        notification.textContent = message;

        notificationContainer.prepend(notification);

        setTimeout(() => {
          notification.style.opacity = "0";
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }
      async function loadUserMenu() {
        const avatarCircle = document.querySelector("#userMenuBtn .w-9.h-9");
        const nameSpan = document.querySelector("#userMenuBtn .font-medium");

        try {
          const res = await fetch("/api/profile", {
            method: "GET",
            credentials: "include", // keep session cookies
            headers: { "Cache-Control": "no-cache" },
          });

          if (!res.ok) throw new Error("Failed to fetch profile");

          const data = await res.json();
          const profile = data.profile; // <-- your API shape

          // ---- 1. Avatar -------------------------------------------------
          if (profile.image) {
            // create an <img> inside the circle
            const img = document.createElement("img");
            img.src = profile.image;
            img.alt = "Profile";
            img.className = "w-full h-full rounded-full object-cover";

            // replace the placeholder <div> with the image
            avatarCircle.innerHTML = "";
            avatarCircle.appendChild(img);
          } else {
            // keep the initials fallback
            const initials = (profile.name || "U")
              .split(" ")
              .map((n) => n[0])
              .join("")
              .toUpperCase()
              .substring(0, 2);
            avatarCircle.innerHTML = `<span class="text-teal-800 font-bold text-sm">${initials}</span>`;
          }

          // ---- 2. Name ---------------------------------------------------
          nameSpan.textContent = profile.name || "User";

          // optional: tiny success toast
          // showNotification('Profile loaded', 'success');
        } catch (err) {
          console.error("loadUserMenu error:", err);
          showNotification("Could not load user info", "error");

          // keep the static placeholder when everything fails
          avatarCircle.innerHTML = `<span class="text-teal-800 font-bold text-sm">JO</span>`;
          nameSpan.textContent = "Julius Ojwang";
        }
      }

      // -----------------------------------------------------------------
      // Run on DOM ready (you already have DOMContentLoaded elsewhere)
      // -----------------------------------------------------------------
      document.addEventListener("DOMContentLoaded", () => {
        loadUserMenu();
      });
    </script>
  </body>
</html>
