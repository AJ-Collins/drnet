<style>
        :root { font-family: 'Plus Jakarta Sans', sans-serif; }
        
        body { background-color: #f8fafc; }

        .glass-panel { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px); 
            border: 1px solid #e2e8f0; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        table { border-collapse: separate; border-spacing: 0; width: 100%; }
        th { 
            background: #f8fafc; color: #64748b; font-size: 0.65rem; 
            font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; 
            padding: 1rem 1.5rem; text-align: left; border-bottom: 1px solid #e2e8f0;
        }
        td { 
            padding: 1rem 1.5rem; border-bottom: 1px solid #f1f5f9; 
            font-size: 0.85rem; vertical-align: middle;
        }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background-color: #f8fafc; }

        .badge { font-size: 0.65rem; font-weight: 800; padding: 0.35rem 0.75rem; border-radius: 9999px; text-transform: uppercase; letter-spacing: 0.05em; display: inline-flex; align-items: center; gap: 0.35rem; }
        .badge-active { background: #f0fdfa; color: #0d9488; border: 1px solid #ccfbf1; }
        .badge-overdue { background: #fff1f2; color: #be123c; border: 1px solid #ffe4e6; }
        .badge-inactive { background: #f8fafc; color: #64748b; border: 1px solid #e2e8f0; }
        .badge-expired { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }

        .drawer-overlay { background: rgba(15, 23, 42, 0.093); backdrop-filter: blur(0px); }
        .drawer-panel {
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: -10px 0 30px rgba(0,0,0,0.1);
        }
        .drawer-panel.open { transform: translateX(0); }

        .search-input { background: #f1f5f9; border: 1px solid transparent; transition: all 0.2s; }
        .search-input:focus { background: white; border-color: #0d9488; box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1); }

        .custom-checkbox {
            appearance: none; background-color: #fff; margin: 0;
            font: inherit; color: currentColor; width: 1.15em; height: 1.15em;
            border: 1px solid #cbd5e1; border-radius: 0.25em;
            display: grid; place-content: center; cursor: pointer;
        }
        .custom-checkbox::before {
            content: ""; width: 0.65em; height: 0.65em; transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em white;
            transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        .custom-checkbox:checked { background-color: #0d9488; border-color: #0d9488; }
        .custom-checkbox:checked::before { transform: scale(1); }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
<div class="max-w-full mx-auto flex flex-col min-h-screen">
    
    <div class="mb-8 flex flex-col md:flex-row md:items-end justify-between gap-4">
        <div>
            <h1 class="text-3xl font-black text-slate-900 tracking-tight">Client Comms</h1>
            <p class="text-slate-500 font-bold text-sm">Client Management Dashboard</p>
        </div>
    </div>

    <div class="glass-panel p-2 rounded-xl flex flex-col md:flex-row gap-2 mb-6 sticky top-4 z-20">
        <div class="relative flex-grow">
            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
            <input type="text" id="searchInput" placeholder="Search clients..." 
                class="w-full pl-10 pr-4 py-3 rounded-xl search-input text-sm font-semibold outline-none text-slate-700 placeholder:text-slate-400">
        </div>
        
        <div class="flex gap-2">
            <select id="statusFilter" class="px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 text-xs font-bold uppercase text-slate-600 outline-none hover:bg-white cursor-pointer">
                <option value="">All Statuses</option>
                <option value="active">Active</option>
                <option value="overdue">Overdue (Warning)</option>
                <option value="expired">Expired (Disconnected)</option>
            </select>

            <button onclick="initData()" class="px-4 py-3 rounded-xl bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 transition-colors">
                <i class="fas fa-sync-alt text-xs"></i>
            </button>
        </div>
    </div>

    <div id="loadingState" class="hidden py-20 text-center">
        <i class="fas fa-circle-notch fa-spin text-4xl text-teal-500 mb-4"></i>
        <p class="text-sm font-bold text-slate-400 uppercase tracking-widest">Syncing Data...</p>
    </div>

    <div id="tableContainer" class="glass-panel rounded-xl overflow-hidden mb-6 hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr>
                        <th class="w-10">
                            <input type="checkbox" id="selectAll" class="custom-checkbox" onchange="Actions.toggleSelectAll()">
                        </th>
                        <th>Client Identity</th>
                        <th>Package Plan</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Expiry Date</th>
                        <th>Sms</th>
                        <th>Counter</th>
                    </tr>
                </thead>
                <tbody id="clientsTableBody" class="bg-white"></tbody>
            </table>
        </div>
    </div>

    <div id="paginationContainer" class="mt-auto pt-6 flex justify-between items-center border-t border-slate-200 hidden">
        <span id="pageInfo" class="text-xs font-bold text-slate-400 uppercase">Showing 0-0 of 0</span>
        <div class="flex gap-2">
            <button id="btnPrev" class="px-4 py-2 rounded-lg border border-slate-200 text-xs font-bold text-slate-600 hover:bg-slate-50 disabled:opacity-50">Previous</button>
            <button id="btnNext" class="px-4 py-2 rounded-lg border border-slate-200 text-xs font-bold text-slate-600 hover:bg-slate-50 disabled:opacity-50">Next</button>
        </div>
    </div>

</div>

<div id="drawerOverlay" class="fixed inset-0 drawer-overlay hidden z-40 transition-opacity opacity-0" onclick="UI.closeAllDrawers()"></div>

<div id="historyDrawer" class="fixed top-0 right-0 h-full w-full max-w-lg bg-white z-50 drawer-panel flex flex-col border-l border-slate-200 shadow-2xl">
    <div class="p-8 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
        <div>
            <h2 class="text-xl font-black text-slate-900 tracking-tight">Comms History</h2>
            <p id="hClientName" class="text-slate-500 text-[10px] font-bold uppercase tracking-widest mt-1">Loading profile...</p>
        </div>
        <button onclick="UI.closeAllDrawers()" class="w-10 h-10 rounded-xl hover:bg-rose-50 text-slate-400 hover:text-rose-600 transition-all flex items-center justify-center">
            <i class="fas fa-times text-lg"></i>
        </button>
    </div>

    <div id="historyList" class="flex-1 overflow-y-auto custom-scroll p-0 bg-white">
        </div>

    <div class="p-6 border-t border-slate-100 bg-white">
        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">End of History Log</span>
    </div>
</div>

<script>
    const DATA_ENDPOINT = "/api/subscriptions/dashboard-data";
    
    const State = {
        allData: [],
        filteredData: [],
        selectedIds: new Set(),
        isLoading: false,
        renderTimeout: null,
        displayedData: [],

        currentPage: 1,
        itemsPerPage: 50,
        totalPages: 1
    };

    function updatePagination() {
        State.totalPages = Math.ceil(State.filteredData.length / State.itemsPerPage);
        
        const startIdx = (State.currentPage - 1) * State.itemsPerPage;
        const endIdx = startIdx + State.itemsPerPage;
        
        State.displayedData = State.filteredData.slice(startIdx, endIdx);
        
        const pageInfo = document.getElementById('pageInfo');
        const btnPrev = document.getElementById('btnPrev');
        const btnNext = document.getElementById('btnNext');
        const paginationContainer = document.getElementById('paginationContainer');
        
        if (State.filteredData.length > State.itemsPerPage) {
            paginationContainer.classList.remove('hidden');
            pageInfo.textContent = `Showing ${startIdx + 1}-${Math.min(endIdx, State.filteredData.length)} of ${State.filteredData.length}`;
            
            btnPrev.disabled = State.currentPage === 1;
            btnNext.disabled = State.currentPage === State.totalPages;
        } else {
            paginationContainer.classList.add('hidden');
        }
    }

    function goToPage(page) {
        State.currentPage = Math.max(1, Math.min(page, State.totalPages));
        updatePagination();
        debouncedRender();
    }

    function debouncedRender() {
        if (State.renderTimeout) {
            clearTimeout(State.renderTimeout);
        }
        State.renderTimeout = setTimeout(() => {
            renderTable();
        }, 100);
    }

    const Els = {
        tableContainer: document.getElementById('tableContainer'),
        tbody: document.getElementById('clientsTableBody'),
        loader: document.getElementById('loadingState'),
        search: document.getElementById('searchInput'),
        filter: document.getElementById('statusFilter'),
        selectAll: document.getElementById('selectAll'),
        overlay: document.getElementById('drawerOverlay')
    };

    async function initData() {
        if (State.isLoading) return;
        
        State.isLoading = true;
        UI.toggleLoading(true);
        
        try {
            // Only fetch subscription data first
            const res = await fetch(DATA_ENDPOINT);
            if(!res.ok) throw new Error("Failed to load data");
            const raw = await res.json();

            // Process subscriptions WITHOUT SMS counts initially
            State.allData = raw.subscriptions.map(sub => {
                const now = new Date();
                const expiryDate = new Date(sub.expiry_date.replace(' ', 'T'));
                
                const warningDate = new Date(expiryDate);
                warningDate.setDate(warningDate.getDate() - 5);
                
                let displayStatus = 'active';
                let isWarningPeriod = false;

                if (now > expiryDate) {
                    displayStatus = 'expired';
                } else if (now > warningDate) {
                    displayStatus = 'overdue'; 
                    isWarningPeriod = true;
                } else {
                    displayStatus = 'active';
                }

                return {
                    id: sub.id,
                    name: `${sub.first_name} ${sub.second_name}`,
                    phone: sub.phone,
                    pkgName: sub.package_name,
                    price: sub.price,
                    expiry: expiryDate,
                    warningDate: warningDate,
                    isWarningPeriod: isWarningPeriod,
                    displayStatus: displayStatus,
                    sms_24h_count: 0  // Default to 0, load later
                };
            }).sort((a,b) => a.name.localeCompare(b.name));
            
            applyFilters();
            
            // Load SMS counts in background (non-blocking)
            loadSmsCountsAsync();
            
        } catch (error) {
            console.error("Init data error:", error);
            Swal.fire("Error", "Could not load data.", "error");
        } finally {
            State.isLoading = false;
            UI.toggleLoading(false);
        }
    }

    async function loadSmsCountsAsync() {
        try {
            const logRes = await fetch('/api/hr/sms/log');
            if(!logRes.ok) return;
            
            const logData = await logRes.json();
            
            // Update counts in existing data
            State.allData.forEach(client => {
                const logEntry = logData.subscriptions.find(l => l.id === client.id);
                if (logEntry) {
                    client.sms_24h_count = logEntry.sms_24h_count;
                }
            });
            
            // Re-render only if user is still on first page
            if (!State.isLoading) {
                debouncedRender();
            }
        } catch (e) {
            console.warn("SMS log fetch failed:", e);
        }
    }

    function getCountdown(graceExpiry) {
        const now = new Date();
        const diff = graceExpiry - now;

        if (diff <= 0) return "EXPIRED";

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

        return `${days}d ${hours}h ${mins}m left`;
    }

    function applyFilters() {
        const term = Els.search.value.toLowerCase().trim();
        const filter = Els.filter.value;

        State.filteredData = State.allData.filter(item => {
            const matchesSearch = item.name.toLowerCase().includes(term) || item.phone.includes(term);
            const matchesFilter = !filter || item.displayStatus === filter;
            return matchesSearch && matchesFilter;
        });

        // Reset to page 1 when filtering
        State.currentPage = 1;
        
        // Don't clear selections on filter - let user keep their selections
        // State.selectedIds.clear();  // REMOVED
        
        updatePagination();
        debouncedRender();
    }

    function renderTable() {
        if (State.isLoading) return;
        
        Els.tbody.innerHTML = "";
        Els.tableContainer.classList.remove('hidden');

        // Only render displayedData (current page)
        State.displayedData.forEach(client => {
            const tr = document.createElement('tr');
            tr.dataset.clientId = client.id;
            
            const isSelected = State.selectedIds.has(client.id);
            const dateStr = client.expiry.toLocaleDateString('en-GB');
            let badgeClass = 'badge-active';
            let iconClass = 'fa-check-circle';

            if (client.displayStatus === 'expired') {
                badgeClass = 'badge-expired bg-rose-50 text-rose-700 border border-rose-100'; // Added inline styles for safety
                iconClass = 'fa-times-circle';
            } else if (client.displayStatus === 'overdue') {
                badgeClass = 'badge-overdue';
                iconClass = 'fa-exclamation-triangle';
            }

            const now = new Date();
            let countdownText = "";
            let countdownClass = "text-slate-500";
            let subLabel = "";

            if (now > client.expiry) {
                countdownText = "0 days left";
                countdownClass = "text-slate-400 font-medium";
                subLabel = "Service Disconnected";
            } else if (now > client.warningDate) {
                countdownText = getCountdown(client.expiry); 
                countdownClass = "text-rose-500 font-bold animate-pulse";
                subLabel = "CRITICAL: PAY SOON";
            } else {
                const diff = client.expiry - now;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                countdownText = `${days} days left`;
                countdownClass = "text-teal-600 font-bold";
                subLabel = "Active Period";
            }

            const count = client.sms_24h_count || 0;
            let countClass = count > 3 ? "text-rose-500 font-black animate-pulse" : (count > 0 ? "text-teal-600 font-bold" : "text-slate-400");

            tr.innerHTML = `
                <td>
                    <input type="checkbox" class="custom-checkbox row-checkbox" ${isSelected ? 'checked' : ''}>
                </td>
                <td>
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-700 font-bold text-xs overflow-hidden border border-slate-200">
                            ${client.image ? `<img src="${client.image}" class="w-full h-full object-cover" loading="lazy">` : client.name.charAt(0)}
                        </div>
                        <div>
                            <h2 class="font-bold text-slate-800 leading-tight">${client.name}</h2>
                            <p class="text-[10px] font-mono text-slate-400">${client.phone}</p>
                        </div>
                    </div>
                </td>
                <td class="font-medium text-slate-600 text-xs">${client.pkgName}</td>
                <td class="font-mono font-bold text-slate-700 text-xs">KES ${client.price}</td>
                <td>
                    <span class="badge ${badgeClass}">
                        <i class="fas ${iconClass}"></i> ${client.displayStatus}
                    </span>
                </td>
                <td class="text-xs font-medium text-slate-500 font-mono">${dateStr}</td>
                <td class="text-xs">
                    <div class="flex flex-col">
                        <span class="${countClass}">${count} sent <span class="text-[9px] opacity-60">/ 24h</span></span>
                        <button class="view-history text-[10px] text-indigo-500 font-bold hover:underline text-left uppercase mt-1">
                            History
                        </button>
                    </div>
                </td>
                <td class="text-xs">
                    <div class="font-mono ${countdownClass} flex items-center gap-1">
                        <i class="fas fa-clock opacity-70"></i> ${countdownText}
                    </div>
                    <div class="text-[10px] text-slate-400 mt-1 font-bold uppercase tracking-tighter">
                        ${subLabel}
                    </div>
                </td>
            `;
            Els.tbody.appendChild(tr);
        });
        
        const allCurrentPageSelected = State.displayedData.length > 0 && 
                                        State.displayedData.every(c => State.selectedIds.has(c.id));
        Els.selectAll.checked = allCurrentPageSelected;
    }

    Els.tbody.addEventListener('click', (e) => {
        const row = e.target.closest('tr');
        if (!row) return;
        
        const clientId = parseInt(row.dataset.clientId);
        
        if (e.target.classList.contains('row-checkbox')) {
            Actions.toggleSelect(clientId);
        } else if (e.target.classList.contains('view-history')) {
            const client = State.allData.find(c => c.id === clientId);
            if (client) Actions.viewHistory(clientId, client.name);
        }
    });

    const Actions = {
        toggleSelect: (id) => {
            if(State.selectedIds.has(id)) State.selectedIds.delete(id);
            else State.selectedIds.add(id);
            renderTable();
        },

        toggleSelectAll: () => {
            const allCurrentPageSelected = State.displayedData.every(c => State.selectedIds.has(c.id));
            
            State.displayedData.forEach(c => {
                if(allCurrentPageSelected) State.selectedIds.delete(c.id);
                else State.selectedIds.add(c.id);
            });
            
            renderTable();
        },

        viewHistory: async (id, name) => {
            const list = document.getElementById('historyList');
            document.getElementById('hClientName').innerText = name;
            
            list.innerHTML = `
                <div class="flex flex-col items-center justify-center py-20">
                    <div class="relative">
                        <div class="w-10 h-10 border-4 border-teal-100 border-t-teal-500 rounded-full animate-spin"></div>
                    </div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] mt-4">Syncing Logs</p>
                </div>`;
            
            UI.openDrawer('historyDrawer');

            try {
                const res = await fetch(`/api/hr/sms/log/${id}`);
                const data = await res.json();
                
                if(!data.history || data.history.length === 0) {
                    list.innerHTML = `
                        <div class="py-20 text-center">
                            <div class="bg-slate-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-history text-slate-300 text-xl"></i>
                            </div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">No dispatch history recorded.</p>
                        </div>`;
                    return;
                }

                list.innerHTML = data.history.map(item => {
                    const typeColor = item.message_type === 'reminder' ? 'bg-amber-500' : 'bg-teal-500';
                    const iconColor = item.message_type === 'reminder' ? 'text-amber-500' : 'text-teal-500';
                    const badgeBg = item.message_type === 'reminder' ? 'bg-amber-100 text-amber-700' : 'bg-teal-100 text-teal-700';

                    return `
                    <div class="group relative bg-white border-b border-slate-50 hover:bg-slate-50/50 transition-all cursor-default">
                        <div class="absolute left-0 top-0 bottom-0 w-1 ${typeColor}"></div>

                        <div class="flex items-start gap-4 p-4 sm:px-8">
                            <div class="mt-1">
                                <i class="fas fa-check-circle ${iconColor} text-sm"></i>
                            </div>

                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-[9px] font-black uppercase tracking-tight ${badgeBg} px-2 py-0.5 rounded">
                                        ${item.message_type}
                                    </span>
                                    <span class="text-[9px] font-medium text-slate-400 uppercase tracking-tighter">
                                        ${item.formatted_date}
                                    </span>
                                </div>
                                
                                <p class="text-sm text-slate-700 font-medium leading-relaxed mb-1 font-mono">
                                    ${item.message_body}
                                </p>

                                <div class="flex items-center gap-2 mt-2">
                                    <span class="text-[9px] font-bold text-slate-400 uppercase">Status: Delivered</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');
            } catch (e) {
                list.innerHTML = `
                    <div class="p-8 text-center">
                        <i class="fas fa-exclamation-triangle text-rose-400 mb-2"></i>
                        <p class="text-xs font-bold text-rose-500 uppercase">Connection Error</p>
                    </div>`;
            }
        }
    };

    const UI = {
        toggleLoading: (show) => {
            Els.loader.classList.toggle('hidden', !show);
            Els.tableContainer.classList.toggle('hidden', show);
        },
        openDrawer: (id) => {
            Els.overlay.classList.remove('hidden');
            setTimeout(() => {
                Els.overlay.classList.remove('opacity-0');
                document.getElementById(id).classList.add('open');
            }, 10);
        },
        closeAllDrawers: () => {
            document.getElementById('historyDrawer').classList.remove('open');
            Els.overlay.classList.add('opacity-0');
            setTimeout(() => {
                Els.overlay.classList.add('hidden');
            }, 400);
        }
    };

    document.getElementById('btnPrev').addEventListener('click', () => {
        goToPage(State.currentPage - 1);
    });

    document.getElementById('btnNext').addEventListener('click', () => {
        goToPage(State.currentPage + 1);
    });

    let searchTimeout;
    Els.search.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            applyFilters();
        }, 300);
    });
    Els.filter.addEventListener('change', applyFilters);
    document.addEventListener('DOMContentLoaded', initData);

</script>