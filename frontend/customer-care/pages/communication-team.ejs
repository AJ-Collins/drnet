<style>
        .chat-scroll::-webkit-scrollbar { width: 5px; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .bubble-in { border-radius: 0 15px 15px 15px; background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .bubble-out { border-radius: 15px 0 15px 15px; background: #dcf8c6; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .chat-bg { background-color: #e5ddd5; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><text x="10" y="50" font-size="80" fill="%23999">ðŸ’¬</text></svg>'); }
    </style>
<div class="bg-gray-100 h-screen overflow-hidden flex flex-col">

    <header class="bg-teal-700 text-white p-4 flex justify-between items-center shadow-md z-30">
        <h1 class="text-lg md:text-xl font-bold tracking-tight">TEAM COMMUNICATION</h1>
        <div class="flex gap-2">
            <button onclick="toggleAnnouncementModal()" class="bg-teal-600 hover:bg-teal-800 px-3 py-2 rounded text-xs md:text-sm font-semibold transition">
                <i class="fas fa-bullhorn mr-1"></i> <span class="hidden md:inline">New Announcement</span>
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        <!-- Sidebar: Team Members & Announcements -->
        <aside id="sidebar" class="w-full md:w-1/3 lg:w-1/4 border-r bg-white flex flex-col z-20 transition-all duration-300">
            <div class="p-4 border-b bg-teal-50">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-bold text-teal-700 uppercase flex items-center gap-2">
                        <i class="fas fa-users"></i> Team Members
                    </span>
                    <span id="onlineCount" class="text-[10px] font-bold text-teal-600">0 online</span>
                </div>
            </div>
            
            <!-- Team Members List -->
            <div class="flex-1 overflow-y-auto p-3 space-y-2" id="teamMembers">
                <div class="p-3 bg-gray-100 rounded animate-pulse h-16"></div>
                <div class="p-3 bg-gray-100 rounded animate-pulse h-16"></div>
            </div>

            <!-- Announcements Section -->
            <div class="border-t bg-gray-50 p-4 max-h-64 overflow-y-auto">
                <h3 class="text-xs font-bold text-gray-500 uppercase mb-3 flex items-center gap-2">
                    <i class="fas fa-bullhorn text-teal-600"></i> Announcements
                </h3>
                <div id="announcementsList" class="space-y-2">
                    <p class="text-xs text-gray-400 italic">No announcements</p>
                </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main id="mainDisplay" class="hidden md:flex flex-1 flex-col bg-white absolute inset-0 z-10 md:relative md:z-0">
            <div class="p-3 md:p-4 border-b flex justify-between items-center bg-white shadow-sm">
                <div class="flex items-center gap-3">
                    <button onclick="closeChatMobile()" class="md:hidden p-2 -ml-2 text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                    </button>
                    <div>
                        <h2 class="text-sm md:text-lg font-bold text-teal-800 flex items-center gap-2">
                            <i class="fas fa-comments"></i> #team-chat
                        </h2>
                        <p class="text-[10px] md:text-xs text-teal-600">Real-time team communication</p>
                    </div>
                </div>
                <button onclick="refreshChat()" class="text-teal-600 hover:text-teal-800 p-2">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>

            <!-- Chat Messages -->
            <div class="flex-1 flex flex-col chat-bg">
                <div id="chatMessages" class="flex-1 overflow-y-auto p-4 chat-scroll flex flex-col gap-3">
                    <div class="text-center text-gray-400 py-10">
                        <i class="fas fa-comment-slash text-5xl mb-3"></i>
                        <p class="text-sm">No messages yet. Start the conversation!</p>
                    </div>
                </div>

                <!-- Message Input -->
                <div class="p-3 bg-white border-t flex gap-2">
                    <textarea 
                        id="messageInput" 
                        rows="1" 
                        placeholder="Type a message..." 
                        class="flex-1 p-2 bg-gray-100 border-none rounded-full px-4 text-sm outline-none resize-none"
                        oninput="autoResize(this)"
                        onkeypress="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"></textarea>
                    <button onclick="sendMessage()" class="bg-teal-600 hover:bg-teal-700 text-white p-2 rounded-full">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                    </button>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Announcement Modal -->
<div id="announcementModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg">
        <div class="p-6 border-b bg-teal-50">
            <h2 class="text-xl font-bold text-teal-800 flex items-center gap-2">
                <i class="fas fa-bullhorn"></i> New Announcement
            </h2>
        </div>
        <form onsubmit="saveAnnouncement(event)" class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">Title</label>
                <input type="text" id="annTitle" required placeholder="Announcement title..." 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">Message</label>
                <textarea id="annBody" required rows="4" placeholder="Announcement details..." 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none resize-none"></textarea>
            </div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-teal-600 text-white py-2.5 rounded-lg font-bold hover:bg-teal-700 transition">
                    Post Announcement
                </button>
                <button type="button" onclick="toggleAnnouncementModal()" class="px-6 py-2.5 text-gray-600 font-semibold hover:text-gray-900">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    const API_BASE = "/api";
    let messages = [];
    let teamMembers = [];
    let announcements = [];
    let currentUser = null;

    window.onload = () => {
        loadData();
        setInterval(loadData, 10000); // Auto-refresh every 10s
    };

    async function loadData() {
        try {
            const [msgRes, memberRes, annRes, userRes] = await Promise.all([
                fetch(`${API_BASE}/team/messages`),
                fetch(`${API_BASE}/team/members`),
                fetch(`${API_BASE}/team/announcements`),
                fetch(`${API_BASE}/auth/me`)
            ]);

            const msgData = msgRes.ok ? await msgRes.json() : {};
            const annData = annRes.ok ? await annRes.json() : {};

            messages = Array.isArray(msgData.messages) ? msgData.messages : [];
            teamMembers = memberRes.ok ? await memberRes.json() : [];
            announcements = Array.isArray(annData.announcements) ? annData.announcements : [];
            currentUser = userRes.ok ? await userRes.json() : null;

            renderMessages();
            renderMembers();
            renderAnnouncements();
        } catch (err) {
            console.error("Failed to load data:", err);
        }
    }

    function renderMessages() {
        const container = document.getElementById('chatMessages');
        if (!messages.length) {
            container.innerHTML = `
                <div class="text-center text-gray-400 py-10">
                    <i class="fas fa-comment-slash text-5xl mb-3"></i>
                    <p class="text-sm">No messages yet. Start the conversation!</p>
                </div>`;
            return;
        }

        container.innerHTML = messages.map(m => {
            const isMe = currentUser && m.sender_id === currentUser.id;
            const sender = m.sender_name || "Unknown";
            const role = m.sender_role || "Staff";

            return `
                <div class="${isMe ? 'self-end' : 'self-start'} max-w-[80%]">
                    <span class="text-[10px] text-gray-600 ${isMe ? 'mr-2 text-right block' : 'ml-2'}">
                        ${isMe ? 'You' : escapeHtml(sender)}
                        ${role === 'Admin' ? '<span class="ml-1 px-1.5 py-0.5 bg-purple-100 text-purple-700 rounded text-[9px] font-bold">ADMIN</span>' : ''}
                    </span>
                    <div class="${isMe ? 'bubble-out' : 'bubble-in'} p-3 text-sm text-gray-800">
                        ${escapeHtml(m.message)}
                        <span class="block text-[9px] text-gray-400 text-right mt-1">
                            ${new Date(m.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                        </span>
                    </div>
                </div>
            `;
        }).join('');

        container.scrollTop = container.scrollHeight;
    }

    function renderMembers() {
        const container = document.getElementById('teamMembers');
        const onlineCount = teamMembers.filter(m => m.online).length;
        document.getElementById('onlineCount').textContent = `${onlineCount} online`;

        container.innerHTML = teamMembers.map(m => `
            <div class="p-3 border-b hover:bg-teal-50 cursor-pointer transition rounded flex items-center gap-3">
                <div class="relative">
                    <div class="w-10 h-10 rounded-full ${m.role === 'Admin' ? 'bg-purple-600' : 'bg-teal-600'} text-white flex items-center justify-center font-bold">
                        ${m.name.charAt(0).toUpperCase()}
                    </div>
                    ${m.online ? '<div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>' : ''}
                </div>
                <div class="flex-1">
                    <div class="font-semibold text-gray-800 text-sm">${escapeHtml(m.name)}</div>
                    <div class="text-xs ${m.online ? 'text-green-600' : 'text-gray-400'}">
                        ${m.online ? 'Online' : 'Offline'} â€¢ ${m.role || 'Staff'}
                    </div>
                </div>
            </div>
        `).join('');
    }

    function renderAnnouncements() {
        const container = document.getElementById('announcementsList');
        if (!announcements.length) {
            container.innerHTML = `<p class="text-xs text-gray-400 italic">No announcements</p>`;
            return;
        }

        container.innerHTML = announcements.map(a => `
            <div class="p-3 bg-teal-50 border-l-4 border-teal-600 rounded text-xs group relative">
                <h4 class="font-bold text-teal-800">${escapeHtml(a.title)}</h4>
                <p class="text-gray-700 mt-1 text-[11px]">${escapeHtml(a.message.substring(0, 80))}${a.message.length > 80 ? '...' : ''}</p>
                <p class="text-[9px] text-gray-500 mt-2">${new Date(a.created_at).toLocaleDateString()}</p>
                ${currentUser?.role === 'Admin' ? `
                    <button onclick="deleteAnnouncement(${a.id})" 
                        class="absolute top-2 right-2 text-gray-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                ` : ''}
            </div>
        `).join('');
    }

    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const msg = input.value.trim();
        if (!msg) return;

        try {
            await fetch(`${API_BASE}/team/messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: msg })
            });
            input.value = '';
            input.style.height = 'auto';
            loadData();
        } catch (err) {
            alert('Failed to send message');
        }
    }

    function toggleAnnouncementModal() {
        const modal = document.getElementById('announcementModal');
        modal.classList.toggle('hidden');
        if (!modal.classList.contains('hidden')) {
            document.getElementById('annTitle').value = '';
            document.getElementById('annBody').value = '';
        }
    }

    async function saveAnnouncement(e) {
        e.preventDefault();
        const title = document.getElementById('annTitle').value.trim();
        const body = document.getElementById('annBody').value.trim();

        if (!title || !body) return;

        try {
            await fetch(`${API_BASE}/team/announcements`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, body })
            });
            toggleAnnouncementModal();
            loadData();
        } catch (err) {
            alert('Failed to save announcement');
        }
    }

    async function deleteAnnouncement(id) {
        if (!confirm('Delete this announcement?')) return;
        try {
            await fetch(`${API_BASE}/team/announcements/${id}`, { method: 'DELETE' });
            loadData();
        } catch (err) {
            alert('Failed to delete');
        }
    }

    function refreshChat() {
        loadData();
    }

    function closeChatMobile() {
        const main = document.getElementById('mainDisplay');
        const sidebar = document.getElementById('sidebar');
        main.classList.add('hidden');
        sidebar.classList.remove('hidden');
        sidebar.classList.add('w-full');
    }

    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>