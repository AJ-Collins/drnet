<style>
  .skeleton {
    background: #e5e7eb;
    border-radius: 0.375rem;
    animation: skeleton 1.5s ease-in-out infinite;
  }
  @keyframes skeleton {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.6;
    }
  }
  .user-row:hover {
    background: linear-gradient(to right, #f0fdfa, #ccfbf1);
  }
</style>
<div class="flex items-center justify-between mb-8">
  <div>
    <h3 class="text-2xl font-bold text-teal-800">Staff Attendance</h3>
    <p class="text-teal-600 mt-1">Mark staff attendance</p>
  </div>
  <button
    onclick="openCreateModal()"
    class="bg-teal-500 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center space-x-2"
  >
    <i class="fas fa-plus"></i><span>Mark New</span>
  </button>
</div>

<!-- STATS -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
  <div
    class="stat-card bg-teal-50 rounded-xl shadow-lg p-6 border border-teal-400"
  >
    <div class="flex items-center justify-between">
      <div>
        <h3 class="text-teal-600 text-sm font-bold mb-1">Present Today</h3>
        <h2 id="totalPresent" class="text-2xl font-bold text-gray-800">0</h2>
      </div>
      <div
        class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center"
      >
        <i class="fas fa-user-check text-blue-600 text-xl"></i>
      </div>
    </div>
  </div>
  <div
    class="stat-card bg-teal-50 rounded-xl shadow-lg p-6 border border-teal-400"
  >
    <div class="flex items-center justify-between">
      <div>
        <h3 class="text-teal-600 text-sm font-bold mb-1">Absent Today</h3>
        <h2 id="totalAbsent" class="text-2xl font-bold text-gray-800">0</h2>
      </div>
      <div
        class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center"
      >
        <i class="fas fa-user-times text-red-600 text-xl"></i>
      </div>
    </div>
  </div>
  <div
    class="stat-card bg-teal-50 rounded-xl shadow-lg p-6 border border-teal-400"
  >
    <div class="flex items-center justify-between">
      <div>
        <h3 class="text-teal-600 text-sm font-bold mb-1">Attendance Rate</h3>
        <h2 id="attendanceRate" class="text-2xl font-bold text-gray-800">0%</h2>
      </div>
      <div
        class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center"
      >
        <i class="fas fa-percent text-blue-600 text-xl"></i>
      </div>
    </div>
  </div>
  <div
    class="stat-card bg-teal-50 rounded-xl shadow-lg p-6 border border-teal-400"
  >
    <div class="flex items-center justify-between">
      <div>
        <h3 class="text-teal-600 text-sm font-bold mb-1">Total Staff</h3>
        <h2 id="totalEmployees" class="text-2xl font-bold text-gray-800">0</h2>
      </div>
      <div
        class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center"
      >
        <i class="fas fa-users text-blue-600 text-xl"></i>
      </div>
    </div>
  </div>
</div>

<!-- FILTERS & TABLE -->
<div class="bg-white/90 backdrop-blur-sm p-8 shadow-xl border border-teal-100">
  <div
    class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 pb-4"
  >
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 flex-1">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Search</label
        >
        <input
          id="searchInput"
          type="text"
          onkeyup="applyFilters()"
          placeholder="Search Staff..."
          class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500"
        />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Status</label
        >
        <select
          id="statusFilter"
          onchange="applyFilters()"
          class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 bg-white"
        >
          <option value="">All Status</option>
          <option value="present">Present</option>
          <option value="absent">Absent</option>
          <option value="on-leave">On Leave</option>
          <option value="off-duty">Off Duty</option>
        </select>
      </div>
    </div>
    <button
      onclick="refreshData()"
      class="bg-teal-500 hover:bg-teal-700 text-white px-2 py-2 rounded-lg mb-2 font-semibold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center space-x-2"
    >
      <i class="fas fa-sync-alt"></i><span>Refresh</span>
    </button>
  </div>

  <div class="flex items-center justify-between border-b pb-4">
    <h3 class="text-lg font-bold text-teal-800">
      <i class="fas fa-list mr-2"></i>Attendance Records
    </h3>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-teal-50">
        <tr>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            Employee ID
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            Name
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            Department
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            Role
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            Time In
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            Time Out
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            Status
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            Date
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            Marked By
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            Actions
          </th>
        </tr>
      </thead>
      <tbody
        id="attendanceTableBody"
        class="bg-white divide-y divide-gray-200"
      ></tbody>
    </table>
  </div>
</div>

<!-- MODALS -->
<div id="detailsModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
  <div class="flex min-h-screen items-center justify-center p-4">
    <div
      class="fixed inset-0 bg-black/60 backdrop-blur-sm"
      onclick="closeModal()"
    ></div>
    <div
      class="relative bg-white shadow-2xl max-w-3xl w-full p-8 border border-teal-100"
    >
      <div
        class="flex items-center justify-between mb-6 pb-3 border-b border-teal-200"
      >
        <h3 id="modalTitle" class="text-2xl font-bold text-teal-700">
          Attendance Details
        </h3>
        <button
          onclick="closeModal()"
          class="text-teal-600 hover:text-teal-800"
        >
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
      <div
        id="modalContent"
        class="text-gray-700 space-y-4 max-h-[60vh] overflow-y-auto pr-2"
      ></div>
    </div>
  </div>
</div>

<div id="formModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
  <div class="flex min-h-screen items-center justify-center p-4">
    <div class="fixed inset-0 bg-black/60" onclick="closeFormModal()"></div>
    <div class="relative bg-white shadow-2xl max-w-2xl w-full p-8">
      <div class="flex justify-between items-center mb-6">
        <h3 id="formModalTitle" class="text-2xl font-bold text-teal-700">
          Mark New Attendance
        </h3>
        <button
          onclick="closeFormModal()"
          class="text-gray-500 hover:text-gray-700"
        >
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <form id="attendanceForm" class="space-y-4">
        <input type="hidden" id="editId" />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Staff Member</label
            >
            <select
              id="formStaffId"
              required
              class="w-full p-3 border rounded-lg focus:ring-teal-500 focus:border-teal-500 bg-white"
            ></select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Status</label
            >
            <select
              id="formStatus"
              required
              class="w-full p-3 border rounded-lg focus:ring-teal-500 focus:border-teal-500 bg-white"
            >
              <option value="present">Present</option>
              <option value="absent">Absent</option>
              <option value="on-leave">On Leave</option>
              <option value="off-duty">Off Duty</option>
            </select>
          </div>
          <div id="timeInContainer" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Time In</label
            >
            <div class="relative">
              <input
                type="text"
                id="formTimeIn"
                readonly
                placeholder="Select time"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 cursor-pointer bg-white"
                onclick="openTimePicker('timeIn')"
              />
              <i
                class="fas fa-clock absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"
              ></i>
            </div>
          </div>

          <div id="timeOutContainer" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Time Out</label
            >
            <div class="relative">
              <input
                type="text"
                id="formTimeOut"
                readonly
                placeholder="Select time"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 cursor-pointer bg-white"
                onclick="openTimePicker('timeOut')"
              />
              <i
                class="fas fa-clock absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"
              ></i>
            </div>
          </div>
        </div>
        <div class="flex justify-end space-x-3 mt-6">
          <button
            type="button"
            onclick="closeFormModal()"
            class="px-5 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50"
          >
            Cancel
          </button>
          <button
            type="submit"
            id="formSubmitBtn"
            class="px-5 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700"
          >
            Save
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add this TIME PICKER MODAL after your other modals -->
<div id="timePickerModal" class="fixed inset-0 z-[60] hidden">
  <div class="flex min-h-screen items-center justify-center p-4">
    <div class="fixed inset-0 bg-black/50" onclick="closeTimePicker()"></div>
    <div class="relative bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-800">Select Time</h3>
        <button
          onclick="closeTimePicker()"
          class="text-gray-400 hover:text-gray-600"
        >
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <div class="flex items-center justify-center space-x-4 mb-6">
        <!-- Hour Selector -->
        <div class="flex flex-col items-center">
          <button
            onclick="incrementHour()"
            class="w-12 h-12 rounded-full bg-teal-50 hover:bg-teal-100 text-teal-600 flex items-center justify-center transition"
          >
            <i class="fas fa-chevron-up"></i>
          </button>
          <div
            class="text-5xl font-bold text-gray-800 my-4 w-20 text-center"
            id="pickerHour"
          >
            08
          </div>
          <button
            onclick="decrementHour()"
            class="w-12 h-12 rounded-full bg-teal-50 hover:bg-teal-100 text-teal-600 flex items-center justify-center transition"
          >
            <i class="fas fa-chevron-down"></i>
          </button>
        </div>

        <div class="text-5xl font-bold text-gray-400">:</div>

        <!-- Minute Selector -->
        <div class="flex flex-col items-center">
          <button
            onclick="incrementMinute()"
            class="w-12 h-12 rounded-full bg-teal-50 hover:bg-teal-100 text-teal-600 flex items-center justify-center transition"
          >
            <i class="fas fa-chevron-up"></i>
          </button>
          <div
            class="text-5xl font-bold text-gray-800 my-4 w-20 text-center"
            id="pickerMinute"
          >
            00
          </div>
          <button
            onclick="decrementMinute()"
            class="w-12 h-12 rounded-full bg-teal-50 hover:bg-teal-100 text-teal-600 flex items-center justify-center transition"
          >
            <i class="fas fa-chevron-down"></i>
          </button>
        </div>
      </div>

      <!-- Quick Time Presets -->
      <div class="mb-4">
        <p class="text-xs font-medium text-gray-500 mb-2">Quick Select</p>
        <div class="grid grid-cols-4 gap-2">
          <button
            onclick="setQuickTime('08:00')"
            class="px-3 py-2 text-sm bg-gray-100 hover:bg-teal-100 rounded-lg transition"
          >
            08:00
          </button>
          <button
            onclick="setQuickTime('09:00')"
            class="px-3 py-2 text-sm bg-gray-100 hover:bg-teal-100 rounded-lg transition"
          >
            09:00
          </button>
          <button
            onclick="setQuickTime('12:00')"
            class="px-3 py-2 text-sm bg-gray-100 hover:bg-teal-100 rounded-lg transition"
          >
            12:00
          </button>
          <button
            onclick="setQuickTime('17:00')"
            class="px-3 py-2 text-sm bg-gray-100 hover:bg-teal-100 rounded-lg transition"
          >
            17:00
          </button>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex space-x-3">
        <button
          onclick="closeTimePicker()"
          class="flex-1 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium"
        >
          Cancel
        </button>
        <button
          onclick="confirmTime()"
          class="flex-1 py-3 bg-teal-600 text-white rounded-lg hover:bg-teal-700 font-medium"
        >
          Confirm
        </button>
      </div>
    </div>
  </div>
</div>
<script>
  /* --------------------------------------------------------------
     CONFIG & HELPERS
  -------------------------------------------------------------- */
  const API = {
    ATTENDANCE: "/api/attendance",
    STAFF: "/api/staff",
  };

  let allAttendance = []; // raw API data
  let filteredAttendance = []; // after filters
  let staffList = []; // all staff
  let editingId = null;

  const $ = (id) => document.getElementById(id);
  const formatTime = (t) => (t ? t.slice(0, 5) : "-"); // "08:30"

  /* --------------------------------------------------------------
     API WRAPPER
  -------------------------------------------------------------- */
  const api = {
    async get(url) {
      const res = await fetch(url, {
        headers: {
          Authorization: `Bearer ${localStorage.getItem("token") || ""}`,
        },
      });
      if (!res.ok && res.status !== 304) throw new Error(`HTTP ${res.status}`);
      return res.json();
    },
    async post(url, data) {
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${localStorage.getItem("token") || ""}`,
        },
        body: JSON.stringify(data),
      });

      const body = await res.json();

      if (!res.ok) {
        throw new Error(body.message || `HTTP ${res.status}`);
      }

      return body;
    },
    async put(url, data) {
      const res = await fetch(url, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${localStorage.getItem("token") || ""}`,
        },
        body: JSON.stringify(data),
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    },
    async delete(url) {
      const res = await fetch(url, {
        method: "DELETE",
        headers: {
          Authorization: `Bearer ${localStorage.getItem("token") || ""}`,
        },
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    },
  };

  /* --------------------------------------------------------------
     SKELETON LOADING
  -------------------------------------------------------------- */
  function showTableSkeleton() {
    const tbody = $("attendanceTableBody");
    tbody.innerHTML = Array(6)
      .fill("")
      .map(
        () => `
      <tr class="hover:bg-teal-50 transition user-row">
        <td class="px-6 py-4"><div class="skeleton h-4 w-16"></div></td>
        <td class="px-6 py-4"><div class="skeleton h-4 w-32"></div></td>
        <td class="px-6 py-4"><div class="skeleton h-4 w-24"></div></td>
        <td class="px-6 py-4"><div class="skeleton h-4 w-20"></div></td>
        <td class="px-6 py-4"><div class="skeleton h-4 w-28"></div></td>
        <td class="px-6 py-4"><div class="skeleton h-4 w-36"></div></td>
        <td class="px-6 py-4"><div class="skeleton h-4 w-20"></div></td>
        <td class="px-6 py-4"><div class="skeleton h-4 w-20"></div></td>
        <td class="px-6 py-4"><div class="skeleton h-8 w-20 rounded-full"></div></td>
        <td class="px-6 py-4"><div class="skeleton h-4 w-24"></div></td>
        <td class="px-6 py-4"><div class="skeleton h-4 w-24"></div></td>
        <td class="px-6 py-4"><div class="skeleton h-8 w-24 rounded"></div></td>
      </tr>`
      )
      .join("");
  }

  function showStatsSkeleton() {
    ["totalPresent", "totalAbsent", "attendanceRate", "totalEmployees"].forEach(
      (id) => {
        $(id).innerHTML = `<div class="skeleton h-8 w-12"></div>`;
      }
    );
  }

  /* --------------------------------------------------------------
     LOAD DATA
  -------------------------------------------------------------- */
  async function loadData() {
    showTableSkeleton();
    showStatsSkeleton();

    try {
      const [att, staff] = await Promise.all([
        api.get(API.ATTENDANCE),
        api.get(API.STAFF),
      ]);

      // Normalise field names
      allAttendance = att.map((r) => ({
        id: r.id,
        staffId: r.staff_id,
        status: r.status,
        timeIn: r.time_in,
        timeOut: r.time_out,
        // FIX: Extract only YYYY-MM-DD
        date: r.attendance_date,
        markedBy: r.marked_by,
      }));

      staffList = staff;
      populateStaffDropdown();
      applyFilters();
      updateStats();
    } catch (e) {
      Swal.fire("Error", e.message, "error");
      $(
        "attendanceTableBody"
      ).innerHTML = `<tr><td colspan="12" class="text-center py-8 text-red-600">Failed to load data</td></tr>`;
    }
  }

  function populateStaffDropdown() {
    const sel = $("formStaffId");
    sel.innerHTML = '<option value="">Select Staff</option>';
    staffList.forEach((s) => {
      const opt = document.createElement("option");
      opt.value = s.id;
      opt.textContent = `${s.name} (${s.role} - ${s.department})`;
      sel.appendChild(opt);
    });
  }

  /* --------------------------------------------------------------
     TABLE RENDER
  -------------------------------------------------------------- */
  function updateTable() {
    const tbody = $("attendanceTableBody");
    tbody.innerHTML = "";

    if (!filteredAttendance.length) {
      tbody.innerHTML = `<tr><td colspan="12" class="text-center py-8 text-gray-500">No records</td></tr>`;
      return;
    }

    const statusBadge = (s) => {
      const map = {
        present: "bg-green-100 text-green-800",
        absent: "bg-red-100 text-red-800",
        "on-leave": "bg-yellow-100 text-yellow-800",
        "off-duty": "bg-gray-100 text-gray-800",
      };
      return map[s] || "bg-gray-100 text-gray-800";
    };

    filteredAttendance.forEach((r) => {
      const staff = staffList.find((s) => s.id === r.staffId) || {};
      const tr = document.createElement("tr");
      tr.className = "hover:bg-teal-50 transition user-row";
      tr.innerHTML = `
        <td class="px-6 py-4 text-sm text-gray-900">${
          staff.employeeId || "-"
        }</td>
        <td class="px-6 py-4 text-sm font-medium text-gray-900">${
          staff.name || "-"
        }</td>
        <td class="px-6 py-4 text-sm text-gray-700">${
          staff.department || "-"
        }</td>
        <td class="px-6 py-4 text-sm text-gray-700">${staff.role || "-"}</td>
        <td class="px-6 py-4 text-sm text-gray-700">${formatTime(r.timeIn)}</td>
        <td class="px-6 py-4 text-sm text-gray-700">${formatTime(
          r.timeOut
        )}</td>
        <td class="px-6 py-4 text-sm">
          <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusBadge(
            r.status
          )}">
            ${r.status.replace(/-/g, " ")}
          </span>
        </td>
        <td class="px-6 py-4 text-sm text-gray-700">${r.date}</td>
        <td class="px-6 py-4 text-sm text-gray-700">${r.markedBy || "-"}</td>
        <td class="px-6 py-4 text-sm space-x-2">
          <button onclick="viewRecord(${
            r.id
          })" class="text-blue-600 hover:text-blue-900"><i class="fas fa-eye"></i></button>
          <button onclick="openEditModal(${
            r.id
          })" class="text-teal-600 hover:text-teal-900"><i class="fas fa-edit"></i></button>
          <button onclick="deleteRecord(${
            r.id
          })" class="text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  /* --------------------------------------------------------------
     STATS
  -------------------------------------------------------------- */
  function updateStats() {
    const today = new Date().toLocaleDateString("en-CA", {
      timeZone: "Africa/Nairobi",
    });
    const todayRec = allAttendance.filter((a) => a.date === today);

    const present = todayRec.filter((a) => a.status === "present").length;
    const absent = todayRec.filter((a) => a.status === "absent").length;
    const onLeave = todayRec.filter((a) => a.status === "on-leave").length;
    const offDuty = todayRec.filter((a) => a.status === "off-duty").length;

    const totalMarked = present + absent + onLeave + offDuty;
    const totalStaff = staffList.length;
    const rate = totalStaff > 0 ? Math.round((present / totalStaff) * 100) : 0;

    $("totalPresent").textContent = present;
    $("totalAbsent").textContent = absent + onLeave + offDuty; // optional: group
    $("attendanceRate").textContent = rate + "%";
    $("totalEmployees").textContent = totalStaff;
  }

  /* --------------------------------------------------------------
     FILTERS
  -------------------------------------------------------------- */
  function applyFilters() {
    const q = $("searchInput").value.toLowerCase().trim();
    const status = $("statusFilter").value;

    filteredAttendance = allAttendance.filter((r) => {
      const staff = staffList.find((s) => s.id === r.staffId) || {};
      const matchesSearch =
        (staff.name || "").toLowerCase().includes(q) ||
        (staff.email || "").toLowerCase().includes(q) ||
        (staff.employeeId || "").toLowerCase().includes(q);
      const matchesStatus = !status || r.status === status;
      return matchesSearch && matchesStatus;
    });

    updateTable();
  }

  /* --------------------------------------------------------------
     MODALS – CREATE / EDIT
  -------------------------------------------------------------- */
  function openCreateModal() {
    editingId = null;
    $("formModalTitle").textContent = "Mark New Attendance";
    $("formSubmitBtn").textContent = "Save";
    $("formSubmitBtn").className =
      "px-5 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700";
    $("attendanceForm").reset();
    $("formStaffId").value = "";
    toggleTimeFields(true);
    $("formModal").classList.remove("hidden");
  }

  function openEditModal(id) {
    const rec = allAttendance.find((r) => r.id === id);
    if (!rec) return;
    editingId = id;

    $("formModalTitle").textContent = "Edit Attendance";
    $("formSubmitBtn").textContent = "Update";
    $("formSubmitBtn").className =
      "px-5 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700";

    $("formStaffId").value = rec.staffId;
    $("formStatus").value = rec.status;
    $("formTimeIn").value = rec.timeIn ? rec.timeIn.slice(0, 5) : "";
    $("formTimeOut").value = rec.timeOut ? rec.timeOut.slice(0, 5) : "";

    toggleTimeFields(rec.status === "present");
    $("formModal").classList.remove("hidden");
  }

  function toggleTimeFields(show) {
    $("timeInContainer").classList.toggle("hidden", !show);
    $("timeOutContainer").classList.toggle("hidden", !show);
  }

  function closeFormModal() {
    $("formModal").classList.add("hidden");
    editingId = null;
  }

  /* --------------------------------------------------------------
     VIEW RECORD
  -------------------------------------------------------------- */
  function viewRecord(id) {
    const rec = allAttendance.find((r) => r.id === id);
    const staff = staffList.find((s) => s.id === rec.staffId) || {};
    const content = $("modalContent");
    content.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
        <div><p class="text-xs font-semibold text-gray-500 uppercase">Name</p><p class="mt-1">${
          staff.name
        }</p></div>
        <div><p class="text-xs font-semibold text-gray-500 uppercase">Status</p><p class="mt-1">${rec.status.replace(
          /-/g,
          " "
        )}</p></div>
        <div><p class="text-xs font-semibold text-gray-500 uppercase">Time In</p><p class="mt-1">${formatTime(
          rec.timeIn
        )}</p></div>
        <div><p class="text-xs font-semibold text-gray-500 uppercase">Time Out</p><p class="mt-1">${formatTime(
          rec.timeOut
        )}</p></div>
        <div><p class="text-xs font-semibold text-gray-500 uppercase">Date</p><p class="mt-1">${
          rec.date
        }</p></div>
        <div><p class="text-xs font-semibold text-gray-500 uppercase">Marked By</p><p class="mt-1">${
          rec.markedBy || "-"
        }</p></div>
      </div>`;
    $("detailsModal").classList.remove("hidden");
  }

  function closeModal() {
    $("detailsModal").classList.add("hidden");
  }

  /* --------------------------------------------------------------
     FORM SUBMIT
  -------------------------------------------------------------- */
  $("attendanceForm").onsubmit = async (e) => {
    e.preventDefault();
    const staffId = parseInt($("formStaffId").value);
    const status = $("formStatus").value;
    const getKenyaDate = () => {
      return new Date().toLocaleDateString("en-CA", {
        timeZone: "Africa/Nairobi",
      });
    };
    const data = {
      staff_id: staffId,
      status,
      time_in: status === "present" ? $("formTimeIn").value + ":00" : null,
      time_out: status === "present" ? $("formTimeOut").value + ":00" : null,
      attendance_date: getKenyaDate(),
    };

    try {
      let response;
      if (editingId) {
        response = await api.put(`${API.ATTENDANCE}/${editingId}`, data);
        Swal.fire("Updated!", "", "success");
      } else {
        response = await api.post(API.ATTENDANCE, data);
        Swal.fire("Marked!", "", "success");
      }

      closeFormModal();
      loadData();
    } catch (err) {
      Swal.fire("Error", err.message, "error");
    }
  };

  /* --------------------------------------------------------------
     DELETE
  -------------------------------------------------------------- */
  async function deleteRecord(id) {
    const res = await Swal.fire({
      title: "Delete record?",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#dc2626",
    });
    if (!res.isConfirmed) return;
    await api.delete(`${API.ATTENDANCE}/${id}`);
    loadData();
    Swal.fire("Deleted!", "", "success");
  }

  /* --------------------------------------------------------------
     UI – STATUS CHANGE → TIME FIELDS
  -------------------------------------------------------------- */
  $("formStatus").addEventListener("change", () => {
    const show = $("formStatus").value === "present";
    toggleTimeFields(show);
  });

  /* --------------------------------------------------------------
     FILTER INPUTS (debounced)
  -------------------------------------------------------------- */
  const debounce = (fn, delay) => {
    let t;
    return (...a) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...a), delay);
    };
  };
  $("searchInput").addEventListener("input", debounce(applyFilters, 300));
  $("statusFilter").addEventListener("change", applyFilters);

  /* --------------------------------------------------------------
     INIT & AUTO-REFRESH
  -------------------------------------------------------------- */
  document.addEventListener("DOMContentLoaded", () => {
    loadData();
  });

  /* --------------------------------------------------------------
     GLOBAL EXPORTS
  -------------------------------------------------------------- */
  window.openCreateModal = openCreateModal;
  window.openEditModal = openEditModal;
  window.closeFormModal = closeFormModal;
  window.viewRecord = viewRecord;
  window.closeModal = closeModal;
  window.deleteRecord = deleteRecord;
  window.applyFilters = applyFilters;
  window.refreshData = loadData;

  /* --------------------------------------------------------------
   TIME PICKER FUNCTIONALITY
-------------------------------------------------------------- */
  let currentTimeField = null;
  let currentHour = 8;
  let currentMinute = 0;

  function openTimePicker(field) {
    currentTimeField = field;

    // Get existing time if any
    const inputId = field === "timeIn" ? "formTimeIn" : "formTimeOut";
    const existingTime = $(inputId).value;

    if (existingTime && existingTime.includes(":")) {
      const [h, m] = existingTime.split(":");
      currentHour = parseInt(h);
      currentMinute = parseInt(m);
    } else {
      // Default to current time
      const now = new Date();
      currentHour = now.getHours();
      currentMinute = now.getMinutes();
    }

    updateTimeDisplay();
    $("timePickerModal").classList.remove("hidden");
  }

  function closeTimePicker() {
    $("timePickerModal").classList.add("hidden");
    currentTimeField = null;
  }

  function updateTimeDisplay() {
    $("pickerHour").textContent = String(currentHour).padStart(2, "0");
    $("pickerMinute").textContent = String(currentMinute).padStart(2, "0");
  }

  function incrementHour() {
    currentHour = (currentHour + 1) % 24;
    updateTimeDisplay();
  }

  function decrementHour() {
    currentHour = currentHour === 0 ? 23 : currentHour - 1;
    updateTimeDisplay();
  }

  function incrementMinute() {
    currentMinute = (currentMinute + 5) % 60;
    updateTimeDisplay();
  }

  function decrementMinute() {
    currentMinute = currentMinute === 0 ? 55 : currentMinute - 5;
    updateTimeDisplay();
  }

  function setQuickTime(time) {
    const [h, m] = time.split(":");
    currentHour = parseInt(h);
    currentMinute = parseInt(m);
    updateTimeDisplay();
  }

  function confirmTime() {
    const timeString = `${String(currentHour).padStart(2, "0")}:${String(
      currentMinute
    ).padStart(2, "0")}`;

    if (currentTimeField === "timeIn") {
      $("formTimeIn").value = timeString;
    } else if (currentTimeField === "timeOut") {
      $("formTimeOut").value = timeString;
    }

    closeTimePicker();
  }

  // Export to global scope
  window.openTimePicker = openTimePicker;
  window.closeTimePicker = closeTimePicker;
  window.incrementHour = incrementHour;
  window.decrementHour = decrementHour;
  window.incrementMinute = incrementMinute;
  window.decrementMinute = decrementMinute;
  window.setQuickTime = setQuickTime;
  window.confirmTime = confirmTime;
</script>
