<style>
    :root { font-family: 'Plus Jakarta Sans', sans-serif; }
    
    body { background-color: #f8fafc; }
    
    .glass-panel { 
        background: rgba(255, 255, 255, 0.95); 
        backdrop-filter: blur(10px); 
        border: 1px solid #e2e8f0; 
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }
    
    .drawer-overlay { background: rgba(15, 23, 42, 0.093); backdrop-filter: blur(0px); }
    .drawer-panel {
        transform: translateX(100%);
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        box-shadow: -10px 0 30px rgba(0,0,0,0.1);
    }
    .drawer-panel.open { transform: translateX(0); }
    
    .search-input { background: #f1f5f9; border: 1px solid transparent; transition: all 0.2s; }
    .search-input:focus { background: white; border-color: #0d9488; box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1); }
    
    .custom-checkbox {
        appearance: none; background-color: #fff; margin: 0;
        font: inherit; color: currentColor; width: 1.15em; height: 1.15em;
        border: 1px solid #cbd5e1; border-radius: 0.25em;
        display: grid; place-content: center; cursor: pointer;
    }
    .custom-checkbox::before {
        content: ""; width: 0.65em; height: 0.65em; transform: scale(0);
        transition: 120ms transform ease-in-out;
        box-shadow: inset 1em 1em white;
        transform-origin: center;
        clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
    }
    .custom-checkbox:checked { background-color: #0d9488; border-color: #0d9488; }
    .custom-checkbox:checked::before { transform: scale(1); }
    
    .custom-scroll::-webkit-scrollbar { width: 4px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    
    .badge { font-size: 0.65rem; font-weight: 800; padding: 0.35rem 0.75rem; border-radius: 9999px; text-transform: uppercase; letter-spacing: 0.05em; display: inline-flex; align-items: center; gap: 0.35rem; }
    .badge-pending { background: #fff1f2; color: #be123c; border: 1px solid #ffe4e6; }
    .badge-progress { background: #f0f9ff; color: #0369a1; border: 1px solid #e0f2fe; }
    .badge-completed { background: #f0fdfa; color: #0d9488; border: 1px solid #ccfbf1; }
    .badge-low { background: #f8fafc; color: #64748b; border: 1px solid #e2e8f0; }
    .badge-medium { background: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; }
    .badge-high { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
    .badge-urgent { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
    
    .task-type-badge {
        font-size: 0.65rem; font-weight: 800; padding: 0.35rem 0.75rem; border-radius: 9999px; text-transform: uppercase; letter-spacing: 0.05em;
    }
    .type-installation { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
    .type-repair { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
    .type-maintenance { background: #f3e8ff; color: #7c3aed; border: 1px solid #e9d5ff; }
    .type-inspection { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
    .type-emergency { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
    
    .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 0.5rem;
    }
    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    
    .animate-fade-in { 
        animation: fadeIn 0.3s ease-out forwards; 
    }
    @keyframes fadeIn { 
        from { opacity: 0; transform: translateY(5px); } 
        to { opacity: 1; transform: translateY(0); } 
    }
    
    .spinner {
        border: 2px solid rgba(255,255,255,0.3);
        border-top: 2px solid white;
        border-radius: 50%;
        width: 14px;
        height: 14px;
        animation: spin 0.6s linear infinite;
        display: inline-block;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<div class="max-w-full mx-auto flex flex-col min-h-screen">
    <!-- Header -->
    <div class="mb-8 flex flex-col md:flex-row md:items-end justify-between gap-4">
        <div>
            <h1 class="text-3xl font-black text-slate-900 tracking-tight">Work Scheduler</h1>
            <p class="text-slate-500 font-bold text-sm">Manage installations, repairs, and maintenance tasks</p>
        </div>
        <div class="flex gap-2 items-center">
            <div class="bg-white px-4 py-2 rounded-xl border border-slate-200 shadow-sm flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-teal-50 flex items-center justify-center text-teal-600">
                    <i class="fas fa-tasks"></i>
                </div>
                <div>
                    <p class="text-[10px] font-black uppercase text-slate-400">Active Tasks</p>
                    <p class="text-sm font-bold text-slate-900" id="activeTasksCount">0</p>
                </div>
            </div>
            
            <button onclick="openCreateDrawer()" class="px-6 py-3 rounded-xl bg-teal-600 text-white hover:bg-teal-700 transition-colors shadow-lg shadow-teal-600/20 font-bold text-xs flex items-center gap-2">
                <i class="fas fa-plus"></i> NEW TASK
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="glass-panel p-2 rounded-xl flex flex-col md:flex-row gap-2 mb-6 sticky top-4 z-20">
        <div class="relative flex-grow">
            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
            <input type="text" id="searchInput" placeholder="Search tasks, customers, locations..." 
                class="w-full pl-10 pr-4 py-3 rounded-xl search-input text-sm font-semibold outline-none text-slate-700 placeholder:text-slate-400">
        </div>
        
        <div class="flex gap-2">
            <select id="statusFilter" class="px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 text-xs font-bold uppercase text-slate-600 outline-none hover:bg-white cursor-pointer">
                <option value="">All Statuses</option>
                <option value="pending">Pending</option>
                <option value="in-progress">In Progress</option>
                <option value="completed">Completed</option>
            </select>
            
            <select id="typeFilter" class="px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 text-xs font-bold uppercase text-slate-600 outline-none hover:bg-white cursor-pointer">
                <option value="">All Types</option>
                <option value="Installation">Installation</option>
                <option value="Repair">Repair</option>
                <option value="Maintenance">Maintenance</option>
                <option value="Inspection">Inspection</option>
                <option value="Emergency">Emergency</option>
            </select>
            
            <input type="date" id="dateFilter" class="px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 text-xs font-bold uppercase text-slate-600 outline-none hover:bg-white cursor-pointer">
            
            <button onclick="loadSchedules()" class="px-4 py-3 rounded-xl bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 transition-colors">
                <i class="fas fa-sync-alt text-xs"></i>
            </button>
        </div>
    </div>

    <div id="loadingState" class="hidden py-20 text-center">
        <i class="fas fa-circle-notch fa-spin text-4xl text-teal-500 mb-4"></i>
        <p class="text-sm font-bold text-slate-400 uppercase tracking-widest">Loading Schedule...</p>
    </div>

    <div id="tableContainer" class="glass-panel rounded-xl overflow-hidden mb-6 hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr>
                        <th>Task Details</th>
                        <th>Type</th>
                        <th>Date & Time</th>
                        <th>Customer</th>
                        <th>Location</th>
                        <th>Priority</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="tasksTableBody" class="bg-white"></tbody>
            </table>
        </div>
    </div>

    <div id="paginationContainer" class="mt-auto pt-6 flex justify-between items-center border-t border-slate-200 hidden">
        <span id="pageInfo" class="text-xs font-bold text-slate-400 uppercase">Showing 0-0 of 0</span>
        <div class="flex gap-2">
            <button id="btnPrev" class="px-4 py-2 rounded-lg border border-slate-200 text-xs font-bold text-slate-600 hover:bg-slate-50 disabled:opacity-50">Previous</button>
            <button id="btnNext" class="px-4 py-2 rounded-lg border border-slate-200 text-xs font-bold text-slate-600 hover:bg-slate-50 disabled:opacity-50">Next</button>
        </div>
    </div>
</div>

<!-- Create/Edit Drawer -->
<div id="createDrawer" class="fixed top-0 right-0 h-full w-full max-w-[600px] bg-white z-50 drawer-panel flex flex-col border-l border-slate-200">
    <div class="p-6 border-b border-slate-100 bg-slate-900 text-white">
        <h2 class="text-xl font-black tracking-tight" id="drawerTitle">New Task</h2>
        <p class="text-xs font-medium text-slate-400 mt-1">Schedule a new work task</p>
    </div>

    <div class="flex-grow overflow-y-auto custom-scroll p-6 space-y-6">
        <form id="taskForm" onsubmit="saveTask(event)" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">Task Type *</label>
                    <select id="taskType" required class="w-full p-3 rounded-xl border border-slate-200 text-sm text-slate-700 outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-100 transition-all">
                        <option value="">Select type...</option>
                        <option>Installation</option>
                        <option>Repair</option>
                        <option>Maintenance</option>
                        <option>Inspection</option>
                        <option>Emergency</option>
                    </select>
                </div>
                
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">Priority *</label>
                    <select id="priority" required class="w-full p-3 rounded-xl border border-slate-200 text-sm text-slate-700 outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-100 transition-all">
                        <option>Low</option>
                        <option selected>Medium</option>
                        <option>High</option>
                        <option>Urgent</option>
                    </select>
                </div>
                
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">Date *</label>
                    <input type="date" id="taskDate" required class="w-full p-3 rounded-xl border border-slate-200 text-sm text-slate-700 outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-100 transition-all">
                </div>
                
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">Time *</label>
                    <input type="time" id="taskTime" required class="w-full p-3 rounded-xl border border-slate-200 text-sm text-slate-700 outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-100 transition-all">
                </div>
                
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">Duration (hours) *</label>
                    <input type="number" id="duration" required min="0.5" step="0.5" value="2" class="w-full p-3 rounded-xl border border-slate-200 text-sm text-slate-700 outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-100 transition-all">
                </div>
                
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">Status *</label>
                    <select id="status" class="w-full p-3 rounded-xl border border-slate-200 text-sm text-slate-700 outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-100 transition-all">
                        <option>Pending</option>
                        <option>In Progress</option>
                        <option>Completed</option>
                    </select>
                </div>
            </div>
            
            <div>
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">Customer Name *</label>
                <input type="text" id="customerName" required placeholder="Enter customer name" class="w-full p-3 rounded-xl border border-slate-200 text-sm text-slate-700 outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-100 transition-all">
            </div>
            
            <div>
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">Location *</label>
                <input type="text" id="location" required placeholder="Enter service location address" class="w-full p-3 rounded-xl border border-slate-200 text-sm text-slate-700 outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-100 transition-all">
            </div>
            
            <div>
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">Contact Number *</label>
                <input type="tel" id="contactNumber" required placeholder="0700000000" class="w-full p-3 rounded-xl border border-slate-200 text-sm text-slate-700 outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-100 transition-all">
            </div>
            
            <div>
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">Task Description</label>
                <textarea id="description" rows="4" placeholder="Describe the task details..." class="w-full p-3 rounded-xl border border-slate-200 text-sm text-slate-700 outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-100 transition-all resize-none"></textarea>
            </div>
            
            <div>
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">Notes</label>
                <textarea id="notes" rows="3" placeholder="Any additional notes..." class="w-full p-3 rounded-xl border border-slate-200 text-sm text-slate-700 outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-100 transition-all resize-none"></textarea>
            </div>
            
            <input type="hidden" id="taskId" value="">
        </form>
    </div>

    <div class="p-6 bg-slate-50 border-t border-slate-100 flex gap-3">
        <button type="button" onclick="UI.closeAllDrawers()" class="flex-1 py-3 rounded-xl border border-slate-300 text-slate-700 font-bold text-sm hover:bg-slate-100 transition-all">
            Cancel
        </button>
        <button type="submit" form="taskForm" id="btnSaveTask" class="flex-1 py-3 rounded-xl bg-teal-600 text-white font-bold text-sm hover:bg-teal-700 shadow-lg shadow-teal-600/20 transition-all flex items-center justify-center gap-2">
            <i class="fas fa-save"></i> SAVE TASK
        </button>
    </div>
</div>

<!-- View Task Drawer -->
<div id="viewDrawer" class="fixed top-0 right-0 h-full w-full max-w-[600px] bg-white z-50 drawer-panel flex flex-col border-l border-slate-200">
    <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
        <div>
            <h2 class="text-xl font-black text-slate-900 tracking-tight">Task Details</h2>
            <p id="viewTaskTypeBadge" class="text-[10px] font-bold uppercase tracking-widest mt-1 inline-block px-2 py-0.5 rounded">Loading...</p>
        </div>
        <button onclick="UI.closeAllDrawers()" class="w-10 h-10 rounded-xl hover:bg-rose-50 text-slate-400 hover:text-rose-600 transition-all flex items-center justify-center">
            <i class="fas fa-times text-lg"></i>
        </button>
    </div>

    <div class="flex-grow overflow-y-auto custom-scroll p-6 space-y-6">
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-slate-50 p-4 rounded-xl">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Date & Time</p>
                <p id="viewDateTime" class="text-sm font-bold text-slate-900"></p>
            </div>
            
            <div class="bg-slate-50 p-4 rounded-xl">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Duration</p>
                <p id="viewDuration" class="text-sm font-bold text-slate-900"></p>
            </div>
            
            <div class="bg-slate-50 p-4 rounded-xl">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Priority</p>
                <p id="viewPriority" class="text-sm font-bold text-slate-900"></p>
            </div>
            
            <div class="bg-slate-50 p-4 rounded-xl">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Status</p>
                <p id="viewStatus" class="text-sm font-bold text-slate-900"></p>
            </div>
        </div>
        
        <div class="space-y-4">
            <div>
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Customer</p>
                <p id="viewCustomer" class="text-lg font-bold text-slate-900"></p>
            </div>
            
            <div>
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Location</p>
                <p id="viewLocation" class="text-sm text-slate-700 bg-slate-50 p-3 rounded-xl border border-slate-200"></p>
            </div>
            
            <div>
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Contact</p>
                <p id="viewContact" class="text-sm font-mono text-slate-700"></p>
            </div>
            
            <div>
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Description</p>
                <p id="viewDescription" class="text-sm text-slate-700 bg-slate-50 p-3 rounded-xl border border-slate-200 min-h-[80px]"></p>
            </div>
            
            <div>
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Notes</p>
                <p id="viewNotes" class="text-sm text-slate-700 bg-slate-50 p-3 rounded-xl border border-slate-200 min-h-[60px]"></p>
            </div>
        </div>
    </div>

    <div class="p-6 border-t border-slate-100 bg-white flex gap-3">
        <button onclick="editCurrentTask()" class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold text-sm hover:bg-blue-700 transition-all flex items-center justify-center gap-2">
            <i class="fas fa-edit"></i> EDIT
        </button>
        <button onclick="deleteCurrentTask()" class="flex-1 py-3 rounded-xl bg-red-600 text-white font-bold text-sm hover:bg-red-700 transition-all flex items-center justify-center gap-2">
            <i class="fas fa-trash"></i> DELETE
        </button>
        <button onclick="UI.closeAllDrawers()" class="flex-1 py-3 rounded-xl border border-slate-300 text-slate-700 font-bold text-sm hover:bg-slate-100 transition-all">
            CLOSE
        </button>
    </div>
</div>

<div id="drawerOverlay" class="fixed inset-0 drawer-overlay hidden z-40 transition-opacity opacity-0" onclick="UI.closeAllDrawers()"></div>

<script>
    const API_BASE = "/api/schedules";
    const State = {
        allTasks: [],
        filteredTasks: [],
        displayedTasks: [],
        currentTask: null,
        isLoading: false,
        renderTimeout: null,
        currentPage: 1,
        itemsPerPage: 50,
        totalPages: 1
    };

    const Els = {
        tableContainer: document.getElementById('tableContainer'),
        tbody: document.getElementById('tasksTableBody'),
        loader: document.getElementById('loadingState'),
        search: document.getElementById('searchInput'),
        statusFilter: document.getElementById('statusFilter'),
        typeFilter: document.getElementById('typeFilter'),
        dateFilter: document.getElementById('dateFilter'),
        overlay: document.getElementById('drawerOverlay')
    };

    // State Management Functions
    function updatePagination() {
        State.totalPages = Math.ceil(State.filteredTasks.length / State.itemsPerPage);
        const startIdx = (State.currentPage - 1) * State.itemsPerPage;
        const endIdx = startIdx + State.itemsPerPage;
        State.displayedTasks = State.filteredTasks.slice(startIdx, endIdx);
        
        const pageInfo = document.getElementById('pageInfo');
        const btnPrev = document.getElementById('btnPrev');
        const btnNext = document.getElementById('btnNext');
        const paginationContainer = document.getElementById('paginationContainer');
        
        if (State.filteredTasks.length > State.itemsPerPage) {
            paginationContainer.classList.remove('hidden');
            pageInfo.textContent = `Showing ${startIdx + 1}-${Math.min(endIdx, State.filteredTasks.length)} of ${State.filteredTasks.length}`;
            btnPrev.disabled = State.currentPage === 1;
            btnNext.disabled = State.currentPage === State.totalPages;
        } else {
            paginationContainer.classList.add('hidden');
        }
    }

    function goToPage(page) {
        State.currentPage = Math.max(1, Math.min(page, State.totalPages));
        updatePagination();
        debouncedRender();
    }

    function debouncedRender() {
        if (State.renderTimeout) clearTimeout(State.renderTimeout);
        State.renderTimeout = setTimeout(renderTable, 100);
    }

    // API Functions
    async function loadSchedules() {
        if (State.isLoading) return;
        State.isLoading = true;
        UI.toggleLoading(true);
        
        try {
            const res = await fetch(API_BASE, { headers: { 'Cache-Control': 'no-cache' } });
            let rawSchedules = [];
            
            if (res.status === 304 && State.allTasks.length > 0) {
                rawSchedules = State.allTasks;
            } else if (res.ok) {
                rawSchedules = await res.json();
            } else {
                throw new Error("Failed to load schedules");
            }

            // Transform data
            State.allTasks = rawSchedules.map(item => {
                const lines = (item.task_description || "").split("\n").map(l => l.trim()).filter(Boolean);
                const descMap = {};
                lines.forEach(line => {
                    const [key, ...valueParts] = line.split(":");
                    if (key && valueParts.length) {
                        descMap[key.trim().toLowerCase().replace(/\s+/g, '')] = valueParts.join(":").trim();
                    }
                });

                const customer = descMap['customer'] || 'Unknown';
                const location = descMap['location'] || 'Unknown';
                const contact = descMap['contact'] || 'N/A';
                const priority = descMap['priority'] || 'Medium';
                const status = descMap['status'] || 'Pending';
                const description = descMap['description'] || '';
                const notes = descMap['notes'] || '';

                // Parse date and time
                const start = item.start_time;
                const end = item.end_time;
                const duration = start && end
                    ? ((new Date(`2000-01-01 ${end}`) - new Date(`2000-01-01 ${start}`)) / (1000 * 60 * 60)).toFixed(1)
                    : 2;

                // Date reconstruction logic
                const year = new Date().getFullYear();
                const month = item.month;
                const dayOfWeek = item.day_of_week;
                const dayMap = { Sunday: 0, Monday: 1, Tuesday: 2, Wednesday: 3, Thursday: 4, Friday: 5, Saturday: 6 };
                const targetDay = dayMap[dayOfWeek];
                let date = new Date().toISOString().split('T')[0];

                if (targetDay !== undefined && month >= 1 && month <= 12) {
                    const now = new Date();
                    let candidateDate = new Date(year, month - 1, 1);
                    while (candidateDate.getDay() !== targetDay) {
                        candidateDate.setDate(candidateDate.getDate() + 1);
                    }
                    while (candidateDate < now && candidateDate.getMonth() === month - 1) {
                        candidateDate.setDate(candidateDate.getDate() + 7);
                    }
                    if (candidateDate.getMonth() === month - 1) {
                        date = candidateDate.toISOString().split('T')[0];
                    } else {
                        candidateDate = new Date(year, month - 1, 1);
                        while (candidateDate.getDay() !== targetDay) {
                            candidateDate.setDate(candidateDate.getDate() + 1);
                        }
                        date = candidateDate.toISOString().split('T')[0];
                    }
                }

                return {
                    id: item.id,
                    taskType: item.schedule_type,
                    priority,
                    date,
                    time: start ? start.slice(0, 5) : "09:00",
                    duration: parseFloat(duration),
                    status,
                    customerName: customer,
                    location,
                    contactNumber: contact,
                    description,
                    notes,
                    is_active: item.is_active !== false
                };
            }).filter(task => task.is_active);

            applyFilters();
            updateActiveTasksCount();
            
        } catch (error) {
            console.error("Load schedules error:", error);
            showToast("Failed to load schedules", 'error');
        } finally {
            State.isLoading = false;
            UI.toggleLoading(false);
        }
    }

    function applyFilters() {
        const term = Els.search.value.toLowerCase().trim();
        const statusFilter = Els.statusFilter.value;
        const typeFilter = Els.typeFilter.value;
        const dateFilter = Els.dateFilter.value;

        State.filteredTasks = State.allTasks.filter(task => {
            const matchesSearch = 
                task.customerName.toLowerCase().includes(term) ||
                task.location.toLowerCase().includes(term) ||
                task.taskType.toLowerCase().includes(term) ||
                task.description.toLowerCase().includes(term);
            
            const matchesStatus = !statusFilter || 
                (statusFilter === 'pending' && task.status === 'Pending') ||
                (statusFilter === 'in-progress' && task.status === 'In Progress') ||
                (statusFilter === 'completed' && task.status === 'Completed');
            
            const matchesType = !typeFilter || task.taskType === typeFilter;
            const matchesDate = !dateFilter || task.date === dateFilter;
            
            return matchesSearch && matchesStatus && matchesType && matchesDate;
        });

        State.currentPage = 1;
        updatePagination();
        debouncedRender();
    }

    function renderTable() {
        if (State.isLoading) return;
        Els.tbody.innerHTML = "";
        Els.tableContainer.classList.remove('hidden');

        State.displayedTasks.forEach(task => {
            const tr = document.createElement('tr');
            tr.dataset.taskId = task.id;
            
            const date = new Date(task.date);
            const now = new Date();
            const isToday = date.toDateString() === now.toDateString();
            const isTomorrow = new Date(now.setDate(now.getDate() + 1)).toDateString() === date.toDateString();
            
            let dateDisplay = date.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
            if (isToday) dateDisplay = `<span class="text-teal-600 font-bold">Today</span>`;
            if (isTomorrow) dateDisplay = `<span class="text-blue-600 font-bold">Tomorrow</span>`;
            
            let statusClass = 'badge-pending';
            let statusIcon = 'fa-clock';
            if (task.status === 'In Progress') {
                statusClass = 'badge-progress';
                statusIcon = 'fa-spinner';
            } else if (task.status === 'Completed') {
                statusClass = 'badge-completed';
                statusIcon = 'fa-check-circle';
            }
            
            let priorityClass = 'badge-medium';
            if (task.priority === 'Low') priorityClass = 'badge-low';
            else if (task.priority === 'High') priorityClass = 'badge-high';
            else if (task.priority === 'Urgent') priorityClass = 'badge-urgent';
            
            let typeClass = 'type-installation';
            if (task.taskType === 'Repair') typeClass = 'type-repair';
            else if (task.taskType === 'Maintenance') typeClass = 'type-maintenance';
            else if (task.taskType === 'Inspection') typeClass = 'type-inspection';
            else if (task.taskType === 'Emergency') typeClass = 'type-emergency';
            
            tr.innerHTML = `
                <td>
                    <div class="flex flex-col">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="task-type-badge ${typeClass}">${task.taskType}</span>
                        </div>
                        <p class="text-xs text-slate-600 line-clamp-2">${task.description || 'No description provided'}</p>
                    </div>
                </td>
                <td class="text-xs font-bold text-slate-700">${task.taskType}</td>
                <td>
                    <div class="flex flex-col">
                        <span class="font-mono text-sm font-bold text-slate-800">${dateDisplay}</span>
                        <span class="text-[10px] text-slate-500">${task.time} â€¢ ${task.duration}h</span>
                    </div>
                </td>
                <td>
                    <div class="flex flex-col">
                        <span class="font-bold text-slate-800 text-sm">${task.customerName}</span>
                        <span class="text-[10px] text-slate-500 font-mono">${task.contactNumber}</span>
                    </div>
                </td>
                <td class="text-xs text-slate-600 max-w-[200px] truncate">${task.location}</td>
                <td><span class="badge ${priorityClass}">${task.priority}</span></td>
                <td><span class="badge ${statusClass}"><i class="fas ${statusIcon}"></i> ${task.status}</span></td>
            `;
            
            tr.addEventListener('click', (e) => {
                if (!e.target.closest('button')) {
                    viewTask(task.id);
                }
            });
            
            Els.tbody.appendChild(tr);
        });
    }

    function updateActiveTasksCount() {
        const activeCount = State.allTasks.filter(task => 
            task.status !== 'Completed' && 
            new Date(task.date) >= new Date(new Date().setDate(new Date().getDate() - 1))
        ).length;
        document.getElementById('activeTasksCount').textContent = activeCount;
    }

    // Task CRUD Operations
    async function saveTask(e) {
        e.preventDefault();
        const btn = document.getElementById('btnSaveTask');
        const originalText = btn.innerHTML;
        const isEdit = document.getElementById('taskId').value !== '';
        
        try {
            btn.innerHTML = `<span class="spinner"></span> Saving...`;
            btn.disabled = true;
            
            const data = {
                taskType: document.getElementById('taskType').value,
                priority: document.getElementById('priority').value,
                date: document.getElementById('taskDate').value,
                time: document.getElementById('taskTime').value,
                duration: parseFloat(document.getElementById('duration').value),
                status: document.getElementById('status').value,
                customerName: document.getElementById('customerName').value,
                location: document.getElementById('location').value,
                contactNumber: document.getElementById('contactNumber').value,
                description: document.getElementById('description').value,
                notes: document.getElementById('notes').value,
            };
            
            const taskId = document.getElementById('taskId').value;
            const method = isEdit ? 'PUT' : 'POST';
            const url = isEdit ? `${API_BASE}/${taskId}` : API_BASE;
            
            if (isEdit) data.id = parseInt(taskId);
            
            const res = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (!res.ok) throw new Error('Failed to save task');
            
            showToast(`Task ${isEdit ? 'updated' : 'created'} successfully!`, 'success');
            UI.closeAllDrawers();
            await loadSchedules();
            
        } catch (error) {
            console.error('Save task error:', error);
            showToast('Failed to save task', 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    function viewTask(id) {
        const task = State.allTasks.find(t => t.id === id);
        if (!task) return;
        State.currentTask = task;
        
        // Set task type badge
        let typeClass = 'type-installation';
        if (task.taskType === 'Repair') typeClass = 'type-repair';
        else if (task.taskType === 'Maintenance') typeClass = 'type-maintenance';
        else if (task.taskType === 'Inspection') typeClass = 'type-inspection';
        else if (task.taskType === 'Emergency') typeClass = 'type-emergency';
        
        document.getElementById('viewTaskTypeBadge').textContent = task.taskType;
        document.getElementById('viewTaskTypeBadge').className = `text-[10px] font-bold uppercase tracking-widest mt-1 inline-block px-2 py-0.5 rounded ${typeClass}`;
        
        // Format date and time
        const date = new Date(task.date);
        const dateStr = date.toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById('viewDateTime').textContent = `${dateStr} at ${task.time}`;
        
        // Set other details
        document.getElementById('viewDuration').textContent = `${task.duration} hour${task.duration !== 1 ? 's' : ''}`;
        document.getElementById('viewPriority').textContent = task.priority;
        document.getElementById('viewStatus').textContent = task.status;
        document.getElementById('viewCustomer').textContent = task.customerName;
        document.getElementById('viewLocation').textContent = task.location;
        document.getElementById('viewContact').textContent = task.contactNumber;
        document.getElementById('viewDescription').textContent = task.description || 'No description provided';
        document.getElementById('viewNotes').textContent = task.notes || 'No notes';
        
        UI.openDrawer('viewDrawer');
    }

    function editCurrentTask() {
        if (!State.currentTask) return;
        openCreateDrawer(State.currentTask.id);
    }

    function openCreateDrawer(id = null) {
        const task = id ? State.allTasks.find(t => t.id === id) : null;
        const title = document.getElementById('drawerTitle');
        const form = document.getElementById('taskForm');
        
        if (task) {
            title.textContent = 'Edit Task';
            document.getElementById('taskId').value = task.id;
            document.getElementById('taskType').value = task.taskType;
            document.getElementById('priority').value = task.priority;
            document.getElementById('taskDate').value = task.date;
            document.getElementById('taskTime').value = task.time;
            document.getElementById('duration').value = task.duration;
            document.getElementById('status').value = task.status;
            document.getElementById('customerName').value = task.customerName;
            document.getElementById('location').value = task.location;
            document.getElementById('contactNumber').value = task.contactNumber;
            document.getElementById('description').value = task.description || '';
            document.getElementById('notes').value = task.notes || '';
        } else {
            title.textContent = 'New Task';
            form.reset();
            document.getElementById('taskId').value = '';
            document.getElementById('priority').value = 'Medium';
            document.getElementById('status').value = 'Pending';
            document.getElementById('duration').value = '2';
            document.getElementById('taskDate').value = new Date().toISOString().split('T')[0];
        }
        
        UI.openDrawer('createDrawer');
    }

    async function deleteCurrentTask() {
        if (!State.currentTask) return;
        
        if (!confirm('Are you sure you want to delete this task? This action cannot be undone.')) {
            return;
        }
        
        try {
            const res = await fetch(`${API_BASE}/${State.currentTask.id}`, {
                method: 'DELETE'
            });
            
            if (!res.ok) throw new Error('Failed to delete task');
            
            showToast('Task deleted successfully', 'success');
            UI.closeAllDrawers();
            await loadSchedules();
            
        } catch (error) {
            console.error('Delete task error:', error);
            showToast('Failed to delete task', 'error');
        }
    }

    // UI Functions
    const UI = {
        toggleLoading: (show) => {
            Els.loader.classList.toggle('hidden', !show);
            Els.tableContainer.classList.toggle('hidden', show);
        },
        openDrawer: (id) => {
            Els.overlay.classList.remove('hidden');
            setTimeout(() => {
                Els.overlay.classList.remove('opacity-0');
                document.getElementById(id).classList.add('open');
            }, 10);
        },
        closeAllDrawers: () => {
            document.getElementById('createDrawer').classList.remove('open');
            document.getElementById('viewDrawer').classList.remove('open');
            Els.overlay.classList.add('opacity-0');
            setTimeout(() => {
                Els.overlay.classList.add('hidden');
            }, 400);
        }
    };

    function showToast(msg, type = 'error') {
        const toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) return;
        
        const toast = document.createElement('div');
        const bgColor = type === 'error' ? 'bg-rose-600' : 'bg-emerald-600';
        const title = type === 'error' ? 'Error' : 'Success';
        toast.className = `${bgColor} text-white p-4 rounded-2xl shadow-2xl min-w-[280px] animate-fade-in flex flex-col`;
        toast.innerHTML = `
            <span class="text-[10px] font-black uppercase tracking-widest opacity-70">${title}</span>
            <span class="text-sm font-bold">${msg}</span>
        `;
        toastContainer.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 500);
        }, 4000);
    }

    // Event Listeners
    document.getElementById('btnPrev').addEventListener('click', () => {
        goToPage(State.currentPage - 1);
    });

    document.getElementById('btnNext').addEventListener('click', () => {
        goToPage(State.currentPage + 1);
    });

    let searchTimeout;
    Els.search.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(applyFilters, 300);
    });

    Els.statusFilter.addEventListener('change', applyFilters);
    Els.typeFilter.addEventListener('change', applyFilters);
    Els.dateFilter.addEventListener('change', applyFilters);

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadSchedules();
        
        // Create toast container if it doesn't exist
        if (!document.getElementById('toastContainer')) {
            const toastContainer = document.createElement('div');
            toastContainer.id = 'toastContainer';
            toastContainer.className = 'fixed top-5 right-5 z-[100] space-y-3';
            document.body.appendChild(toastContainer);
        }
    });
</script>