// Shared payslip functionality for all staff dashboards
// This file provides payslip loading and management for all staff roles

// Function to get current staff user info based on dashboard type
function getCurrentStaffUser() {
  // This function should be overridden by each dashboard
  // Default implementation for testing
  return {
    id: '1',
    name: 'John Supervisor',
    role: 'Supervisor',
    department: 'Network Management'
  };
}

// Function to load activated payslips for current staff member
function loadStaffPayslips() {
  try {
    // Get current staff user info
    const currentStaff = getCurrentStaffUser();
    
    // Get staff-specific payslips from localStorage
    const staffPayslips = JSON.parse(localStorage.getItem('staffPayslips') || '[]');
    
    // Filter payslips for current staff user
    const currentUserPayslips = staffPayslips.filter(payslip => 
      payslip.staffUserId === currentStaff.id
    );

    // Sort payslips by period (most recent first)
    currentUserPayslips.sort((a, b) => {
      // Convert period to date for sorting
      const dateA = new Date(a.payPeriod + ' 01'); // Add day to make valid date
      const dateB = new Date(b.payPeriod + ' 01');
      return dateB - dateA; // Most recent first
    });

    // Update the payslip history display
    updateStaffPayslipHistory(currentUserPayslips);
    
  } catch (error) {
    console.error('Error loading activated payslips:', error);
  }
}

// Function to update payslip history display
function updateStaffPayslipHistory(payslips) {
  const historyDiv = document.getElementById('payslipHistory');
  
  if (!historyDiv) {
    return;
  }

  if (payslips.length === 0) {
    historyDiv.innerHTML = `
      <h5 class="font-semibold text-green-800 mb-3">Available Payslips</h5>
      <p class="text-xs text-gray-600 mb-3">Payslips generated by CTIO</p>
      <div class="text-center py-4 text-gray-500">
        <div class="text-4xl mb-2">üìÑ</div>
        <p>No payslips available yet</p>
        <p class="text-sm">CTIO will activate payslips for you</p>
      </div>
    `;
    return;
  }

  let payslipHTML = `
    <h5 class="font-semibold text-green-800 mb-3">Available Payslips (${payslips.length})</h5>
    <p class="text-xs text-gray-600 mb-3">Payslips generated by CTIO - Click Download to view and remove from list</p>
    <div class="space-y-2">
  `;

  payslips.forEach(payslip => {
    // Determine if this is current month, previous month, or older
    const currentDate = new Date();
    const currentYear = currentDate.getFullYear();
    const currentMonth = currentDate.getMonth() + 1; // 1-based
    
    const payslipDate = new Date(payslip.payPeriod + ' 01');
    const payslipYear = payslipDate.getFullYear();
    const payslipMonth = payslipDate.getMonth() + 1;
    
    let statusText = '';
    let statusColor = 'text-green-600';
    
    if (payslipYear === currentYear && payslipMonth === currentMonth) {
      statusText = '‚úì Current Month';
    } else if (payslipYear === currentYear && payslipMonth === currentMonth - 1) {
      statusText = '‚úì Previous Month';
    } else {
      statusText = '‚úì Available';
    }
    
    payslipHTML += `
      <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg border border-green-200">
        <div class="flex-1">
          <div class="font-medium text-gray-800">${payslip.payPeriod}</div>
          <div class="text-xs text-gray-600 mb-1">KSH ${payslip.netSalary.toLocaleString()} - Generated by CTIO</div>
          <div class="text-xs ${statusColor} font-medium">${statusText}</div>
          <div class="text-xs text-gray-500 mt-1">Activated: ${new Date(payslip.activatedDate).toLocaleDateString()}</div>
        </div>
        <button onclick="downloadAndDeletePayslip('${payslip.payPeriod}')" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700 transition-colors ml-3">
          Download & Remove
        </button>
      </div>
    `;
  });

  payslipHTML += '</div>';
  historyDiv.innerHTML = payslipHTML;
}

// Pagination variables
let currentPayslipPage = 1;
const payslipsPerPage = 3; // Show only 3 payslips per page

// Function to update payslip history display with pagination
function updateStaffPayslipHistoryWithPagination(payslips) {
  const historyDiv = document.getElementById('payslipHistory');
  console.log('updateStaffPayslipHistoryWithPagination called with payslips:', payslips);
  console.log('historyDiv found:', historyDiv);
  
  if (!historyDiv) {
    console.error('payslipHistory div not found!');
    return;
  }

  if (payslips.length === 0) {
    console.log('No payslips to display, showing empty state');
    historyDiv.innerHTML = `
      <h5 class="font-semibold text-green-800 mb-3">Available Payslips</h5>
      <p class="text-xs text-gray-600 mb-3">Payslips generated by CTIO</p>
      <div class="text-center py-4 text-gray-500">
        <div class="text-4xl mb-2">üìÑ</div>
        <p>No payslips available yet</p>
        <p class="text-sm">CTIO will activate payslips for you</p>
      </div>
    `;
    return;
  }

  console.log(`Displaying ${payslips.length} payslips with pagination`);

  // Calculate pagination
  const totalPages = Math.ceil(payslips.length / payslipsPerPage);
  const startIndex = (currentPayslipPage - 1) * payslipsPerPage;
  const endIndex = startIndex + payslipsPerPage;
  const currentPayslips = payslips.slice(startIndex, endIndex);

  let payslipHTML = `
    <div class="flex justify-between items-center mb-4">
      <h5 class="font-semibold text-green-800">Available Payslips</h5>
      <span class="text-xs text-gray-600">${payslips.length} total payslip${payslips.length !== 1 ? 's' : ''}</span>
    </div>
    <p class="text-xs text-gray-600 mb-3">Payslips generated by CTIO</p>
    <div class="space-y-2">
  `;

  currentPayslips.forEach(payslip => {
    // Determine if this is current month, previous month, or older
    const currentDate = new Date();
    const currentYear = currentDate.getFullYear();
    const currentMonth = currentDate.getMonth() + 1; // 1-based
    
    const payslipDate = new Date(payslip.payPeriod + ' 01');
    const payslipYear = payslipDate.getFullYear();
    const payslipMonth = payslipDate.getMonth() + 1;
    
    let statusText = '';
    let statusColor = 'text-green-600';
    
    if (payslipYear === currentYear && payslipMonth === currentMonth) {
      statusText = '‚úì Current Month';
    } else if (payslipYear === currentYear && payslipMonth === currentMonth - 1) {
      statusText = '‚úì Previous Month';
    } else {
      statusText = '‚úì Available';
    }
    
    payslipHTML += `
      <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg border border-green-200">
        <div class="flex-1">
          <div class="font-medium text-gray-800">${payslip.payPeriod}</div>
          <div class="text-xs text-gray-600 mb-1">KSH ${payslip.netSalary.toLocaleString()} - Generated by CTIO</div>
          <div class="text-xs ${statusColor} font-medium">${statusText}</div>
          <div class="text-xs text-gray-500 mt-1">Activated: ${new Date(payslip.activatedDate).toLocaleDateString()}</div>
        </div>
        <button onclick="downloadStaffPayslip('${payslip.payPeriod}')" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700 transition-colors ml-3">
          Download
        </button>
      </div>
    `;
  });

  payslipHTML += '</div>';

  // Add pagination controls if there are multiple pages
  if (totalPages > 1) {
    payslipHTML += `
      <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-200">
        <div class="flex items-center space-x-2">
          <button onclick="changePayslipPage(${currentPayslipPage - 1})" 
                  ${currentPayslipPage === 1 ? 'disabled' : ''} 
                  class="px-3 py-1 text-xs rounded ${currentPayslipPage === 1 ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'}">
            ‚Üê Previous
          </button>
          <span class="text-xs text-gray-600">
            Page ${currentPayslipPage} of ${totalPages}
          </span>
          <button onclick="changePayslipPage(${currentPayslipPage + 1})" 
                  ${currentPayslipPage === totalPages ? 'disabled' : ''} 
                  class="px-3 py-1 text-xs rounded ${currentPayslipPage === totalPages ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'}">
            Next ‚Üí
          </button>
        </div>
        <div class="text-xs text-gray-500">
          Showing ${startIndex + 1}-${Math.min(endIndex, payslips.length)} of ${payslips.length}
        </div>
      </div>
    `;
  }

  console.log('Setting innerHTML with payslip content');
  console.log('Payslip HTML length:', payslipHTML.length);
  historyDiv.innerHTML = payslipHTML;
  console.log('Payslip history div updated successfully');
}

// Function to change payslip page
function changePayslipPage(page) {
  const historyDiv = document.getElementById('payslipHistory');
  if (!historyDiv) return;

  // Get current payslips from localStorage
  const currentStaff = getCurrentStaffUser();
  const staffPayslips = JSON.parse(localStorage.getItem('staffPayslips') || '[]');
  const currentUserPayslips = staffPayslips.filter(payslip => 
    payslip.staffUserId === currentStaff.id
  );

  // Sort payslips by period (most recent first)
  currentUserPayslips.sort((a, b) => {
    const dateA = new Date(a.payPeriod + ' 01');
    const dateB = new Date(b.payPeriod + ' 01');
    return dateB - dateA;
  });

  const totalPages = Math.ceil(currentUserPayslips.length / payslipsPerPage);
  
  if (page >= 1 && page <= totalPages) {
    currentPayslipPage = page;
    updateStaffPayslipHistoryWithPagination(currentUserPayslips);
  }
}

// Function to download and delete staff payslip
function downloadAndDeletePayslip(period) {
  try {
    // Get current staff user info
    const currentStaff = getCurrentStaffUser();
    
    // Find the payslip data from staff-specific payslips
    const staffPayslips = JSON.parse(localStorage.getItem('staffPayslips') || '[]');
    const payslip = staffPayslips.find(p => 
      p.payPeriod === period && p.staffUserId === currentStaff.id
    );
    
    if (!payslip) {
      alert('Payslip not found for your account');
      return;
    }

    // Create payslip HTML for PDF
    const payslipHTML = `
      <!DOCTYPE html>
      <html>
      <head>
        <title>Payslip - ${payslip.payPeriod}</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 20px; }
          .header { text-align: center; margin-bottom: 30px; }
          .company { font-size: 24px; font-weight: bold; color: #1f2937; }
          .payslip-title { font-size: 18px; margin: 10px 0; color: #059669; }
          .details { margin: 20px 0; }
          .row { display: flex; justify-content: space-between; margin: 8px 0; padding: 5px 0; }
          .total { border-top: 2px solid #059669; font-weight: bold; margin-top: 10px; }
          .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #6b7280; }
        </style>
      </head>
      <body>
        <div class="header">
          <div class="company">DR.NET TECHNOLOGY LABS</div>
          <div class="payslip-title">PAYSLIP - ${payslip.payPeriod}</div>
        </div>
        
        <div class="details">
          <div class="row">
            <span>Employee:</span>
            <span>${payslip.staffName}</span>
          </div>
          <div class="row">
            <span>Position:</span>
            <span>${payslip.staffRole}</span>
          </div>
          <div class="row">
            <span>Period:</span>
            <span>${payslip.payPeriod}</span>
          </div>
          <div class="row">
            <span>Basic Salary:</span>
            <span>KSH ${payslip.basicSalary.toLocaleString()}</span>
          </div>
          <div class="row total">
            <span>Net Salary:</span>
            <span>KSH ${payslip.netSalary.toLocaleString()}</span>
          </div>
        </div>
        
        <div class="footer">
          <p>This is a computer-generated payslip. No signature required.</p>
          <p>Generated on: ${new Date().toLocaleDateString()}</p>
          <p>Activated by: ${payslip.activatedBy}</p>
        </div>
      </body>
      </html>
    `;

    // Create and download PDF
    const blob = new Blob([payslipHTML], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `payslip-${period.replace(/\s+/g, '-').toLowerCase()}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    // Remove the payslip from localStorage after download
    const updatedPayslips = staffPayslips.filter(p => 
      !(p.payPeriod === period && p.staffUserId === currentStaff.id)
    );
    localStorage.setItem('staffPayslips', JSON.stringify(updatedPayslips));
    
    // Reload the payslip display
    loadStaffPayslips();

    alert('Payslip downloaded successfully and removed from list!');
    
  } catch (error) {
    console.error('Error downloading payslip:', error);
    alert('Error downloading payslip. Please try again.');
  }
}

// Legacy function for backward compatibility
function downloadStaffPayslip(period) {
  downloadAndDeletePayslip(period);
}

// Function to refresh payslips
function refreshStaffPayslips() {
  loadStaffPayslips();
  alert('Refreshing payslips... Checking for new payslips from CTIO.');
}

// Function to view payslip history
function viewStaffPayslipHistory() {
  const historyDiv = document.getElementById('payslipHistory');
  if (historyDiv.classList.contains('hidden')) {
    historyDiv.classList.remove('hidden');
  } else {
    historyDiv.classList.add('hidden');
  }
}
