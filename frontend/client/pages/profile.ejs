<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
  <!-- Left Column - Profile Card -->
  <div class="lg:col-span-1">
    <div class="bg-white shadow-lg overflow-hidden rounded-xl">
      <!-- Profile Image -->
      <div class="relative h-48 bg-teal-600 rounded-t-xl">
        <div class="absolute -bottom-16 left-1/2 transform -translate-x-1/2">
          <div
            id="profileImageContainer"
            class="w-32 h-32 rounded-full overflow-hidden bg-white p-1 shadow-xl"
          >
            <img
              id="profileImage"
              src=""
              alt="Profile"
              class="w-full h-full rounded-full object-cover hidden"
            />
            <div
              id="defaultProfileIcon"
              class="w-full h-full rounded-full bg-gradient-to-br from-teal-400 to-teal-600 flex items-center justify-center"
            >
              <svg
                class="w-16 h-16 text-white"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                ></path>
              </svg>
            </div>
          </div>
          <button
            onclick="triggerFileInput()"
            class="absolute -bottom-2 -right-2 bg-teal-600 text-white p-2.5 rounded-full hover:bg-teal-700 transition-all duration-200 shadow-lg"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
              ></path>
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"
              ></path>
            </svg>
          </button>
        </div>
      </div>
      <input
        id="fileInput"
        type="file"
        accept="image/jpeg,image/png,image/gif,image/webp"
        onchange="handleImageUpload(event)"
        class="hidden"
      />

      <!-- Profile Info -->
      <div class="pt-20 pb-6 px-6 text-center">
        <h2 id="displayName" class="text-2xl font-bold text-gray-800 mb-1">
          Loading...
        </h2>
        <p id="displayTitle" class="text-teal-600 font-medium mb-1">
          Loading...
        </p>
        <div
          class="flex items-center justify-center text-gray-500 text-sm mb-4"
        >
          <svg
            class="w-4 h-4 mr-1"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
            ></path>
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
            ></path>
          </svg>
          <span id="displayLocation">Loading...</span>
        </div>

        <!-- Action Buttons -->
        <div class="flex space-x-2 mb-6">
          <button
            class="flex-1 flex items-center justify-center space-x-2 px-4 py-2.5 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition-colors duration-200"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"
              ></path>
            </svg>
            <span class="text-sm">Send message</span>
          </button>
          <button
            class="flex-1 flex items-center justify-center space-x-2 px-4 py-2.5 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition-colors duration-200"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
              ></path>
            </svg>
            <span class="text-sm">Contacts</span>
          </button>
        </div>

        <!-- Tabs -->
        <div class="border-b border-gray-200 mb-6">
          <div class="flex">
            <button
              onclick="showTab('about')"
              id="aboutTab"
              class="flex-1 py-3 text-sm font-medium text-gray-900 border-b-2 border-teal-600"
            >
              <span class="flex items-center justify-center">
                <svg
                  class="w-4 h-4 mr-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                  ></path>
                </svg>
                About
              </span>
            </button>
            <button
              onclick="showTab('timeline')"
              id="timelineTab"
              class="flex-1 py-3 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700"
            >
              <span class="flex items-center justify-center">
                <svg
                  class="w-4 h-4 mr-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                  ></path>
                </svg>
                Timeline
              </span>
            </button>
          </div>
        </div>

        <!-- Contact Information -->
        <div id="aboutContent" class="text-left">
          <h3
            class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-4"
          >
            Contact Information
          </h3>
          <div class="space-y-4">
            <div>
              <p class="text-xs text-gray-500 mb-1">Phone:</p>
              <p id="displayPhone" class="text-sm text-teal-600 font-medium">
                Loading...
              </p>
            </div>
            <div>
              <p class="text-xs text-gray-500 mb-1">Address:</p>
              <p id="displayAddress" class="text-sm text-gray-700">
                Loading...
              </p>
            </div>
            <div>
              <p class="text-xs text-gray-500 mb-1">E-mail:</p>
              <p id="displayEmail" class="text-sm text-teal-600 font-medium">
                Loading...
              </p>
            </div>
          </div>
        </div>

        <div id="timelineContent" class="text-left hidden">
          <p class="text-gray-500 text-sm">No timeline events yet.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Right Column - Edit Profile Form -->
  <div class="lg:col-span-2">
    <div class="bg-white shadow-lg overflow-hidden p-8 rounded-xl">
      <h3 class="text-2xl font-bold text-gray-800 mb-6">Edit Profile</h3>

      <!-- Profile Information -->
      <div class="mb-8">
        <h4 class="text-lg font-semibold text-gray-800 mb-4">
          Profile Information
        </h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Full Name</label
            >
            <input
              id="adminName"
              type="text"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all"
              placeholder="Enter your full name"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Job Title</label
            >
            <input
              id="adminTitle"
              type="text"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all"
              placeholder="Enter your job title"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Email Address</label
            >
            <input
              id="adminEmail"
              type="email"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all"
              placeholder="Enter your email"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Phone Number</label
            >
            <input
              id="adminPhone"
              type="tel"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all"
              placeholder="Enter your phone number"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Location</label
            >
            <input
              id="adminLocation"
              type="text"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all"
              placeholder="Enter your location"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Birthday</label
            >
            <input
              id="adminBirthday"
              type="text"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all"
              placeholder="Enter your birthday"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Gender</label
            >
            <select
              id="adminGender"
              class="w-full bg-white p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all"
            >
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Other">Other</option>
              <option value="Prefer not to say">Prefer not to say</option>
            </select>
          </div>
        </div>
        <div class="mt-6">
          <label class="block text-sm font-medium text-gray-700 mb-2"
            >Address</label
          >
          <textarea
            id="adminAddress"
            rows="3"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all"
            placeholder="Enter your address"
          ></textarea>
        </div>
      </div>

      <!-- Password Reset Section -->
      <div class="pt-6 border-t border-gray-200 mb-8">
        <h4 class="text-lg font-semibold text-gray-800 mb-4">
          Change Password
        </h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Current Password</label
            >
            <input
              id="currentPassword"
              type="password"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all"
              placeholder="Enter current password"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >New Password</label
            >
            <input
              id="newPassword"
              type="password"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all"
              placeholder="Enter new password"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Confirm New Password</label
            >
            <input
              id="confirmNewPassword"
              type="password"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all"
              placeholder="Confirm new password"
            />
          </div>
        </div>
        <div class="mt-4 flex justify-end">
          <button
            onclick="resetPassword()"
            class="flex items-center space-x-2 px-6 py-3 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-lg hover:from-red-600 hover:to-red-700 transition-all duration-200 shadow-md hover:shadow-lg"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"
              ></path>
            </svg>
            <span>Change Password</span>
          </button>
        </div>
      </div>

      <!-- Save/Cancel Buttons -->
      <div class="flex justify-end space-x-4">
        <button
          onclick="cancelEdit()"
          class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all duration-200"
        >
          Cancel
        </button>
        <button
          onclick="saveProfile()"
          class="flex items-center space-x-2 px-6 py-3 bg-gradient-to-r from-teal-500 to-teal-600 text-white rounded-lg hover:from-teal-600 hover:to-teal-700 transition-all duration-200 shadow-md hover:shadow-lg"
        >
          <svg
            class="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M5 13l4 4L19 7"
            ></path>
          </svg>
          <span>Save Profile</span>
        </button>
      </div>
    </div>
  </div>
</div>
<script>
  const API_BASE = "/api";
  const $ = (id) => document.getElementById(id);
  let currentImageData = null;
  let cachedProfile = null;

  // Notification
  function showNotification(message, type = "info") {
    const colors = {
      success: "bg-green-500",
      error: "bg-red-500",
      info: "bg-blue-500",
    };
    const div = document.createElement("div");
    div.className = `fixed top-4 right-4 text-white px-6 py-3 rounded-lg shadow-lg ${colors[type]} z-50 transition-all`;
    div.textContent = message;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 3000);
  }

  async function loadProfile() {
    try {
      const res = await fetch(`${API_BASE}/my/profile`, {
        headers: { "Cache-Control": "no-cache" },
      });

      let p = {};

      if (res.status === 304) {
        // Use cached data
        if (!cachedProfile) {
          throw new Error("No cached profile available");
        }
        p = cachedProfile;
        console.log("Using cached profile (304)");
      } else if (res.ok) {
        const data = await res.json();
        p = data.profile;
        cachedProfile = p; // Update cache
        console.log("Loaded fresh profile");
      } else {
        throw new Error("Failed to load profile");
      }

      const img = p.image || null;
      currentImageData = img;

      // === UPDATE DISPLAY ===
      const setText = (id, value) => {
        const el = $(id);
        if (el) el.textContent = value || "N/A";
      };

      const setValue = (id, value) => {
        const el = $(id);
        if (el) el.value = value || "";
      };

      const displayName = `${p.first_name || ""} ${p.second_name || ""}`.trim();
      setText("displayName", displayName);
      setText("displayTitle", p.email);
      setText("displayPhone", p.phone);
      setText("displayEmail", p.email);
      setText("displayLocation", p.location);
      $("displayAddress").innerHTML = (p.address || "").replace(/\n/g, "<br>");

      // Update form
      setValue("adminName", displayName);
      setValue("adminTitle", p.position);
      setValue("adminEmail", p.email);
      setValue("adminPhone", p.phone);
      setValue("adminLocation", p.location);
      setValue("adminBirthday", p.birthday);
      setValue("adminGender", p.gender);
      setValue("adminAddress", p.address);

      // Update image
      if (img) {
        $("profileImage").src = img;
        $("profileImage").classList.remove("hidden");
        $("defaultProfileIcon").classList.add("hidden");
      } else {
        $("profileImage").classList.add("hidden");
        $("defaultProfileIcon").classList.remove("hidden");
      }
    } catch (err) {
      console.error("loadProfile error:", err);
      showNotification("Failed to load profile: " + err.message, "error");
    }
  }

  // Save Profile
  async function saveProfile() {
    const profile = {
      name: $("adminName").value.trim(),
      title: $("adminTitle").value.trim(),
      email: $("adminEmail").value.trim(),
      phone: $("adminPhone").value.trim(),
      location: $("adminLocation").value.trim(),
      birthday: $("adminBirthday").value.trim(),
      gender: $("adminGender").value,
      address: $("adminAddress").value.trim(),
    };

    if (!profile.name || !profile.email) {
      showNotification("Name and email are required", "error");
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/my/profile`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(profile),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message);

      loadProfile();
      showNotification("Profile saved!", "success");
    } catch (err) {
      showNotification("Save failed: " + err.message, "error");
    }
  }

  // Upload Image
  async function handleImageUpload(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async () => {
      currentImageData = reader.result;
      $("profileImage").src = currentImageData;
      $("profileImage").classList.remove("hidden");
      $("defaultProfileIcon").classList.add("hidden");

      const form = new FormData();
      form.append("image", file);

      try {
        const res = await fetch(`${API_BASE}/my/upload-profile-image`, {
          method: "POST",
          body: form,
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message);
        currentImageData = data.imageUrl;
        showNotification("Image uploaded!", "success");
      } catch (err) {
        showNotification("Upload failed: " + err.message, "error");
      }
    };
    reader.readAsDataURL(file);
  }

  // Change Password
  async function resetPassword() {
    const current = $("currentPassword").value;
    const newP = $("newPassword").value;
    const confirm = $("confirmNewPassword").value;

    if (!current || !newP || !confirm)
      return showNotification("All fields required", "error");
    if (newP !== confirm)
      return showNotification("Passwords don't match", "error");
    if (newP.length < 6) return showNotification("Password too short", "error");

    try {
      const res = await fetch(`${API_BASE}/my/change-password`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ currentPassword: current, newPassword: newP }),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message);

      $("currentPassword").value =
        $("newPassword").value =
        $("confirmNewPassword").value =
          "";
      showNotification("Password changed!", "success");
    } catch (err) {
      showNotification("Failed: " + err.message, "error");
    }
  }

  function cancelEdit() {
    loadProfile();
    showNotification("Changes cancelled", "info");
  }

  function showTab(tab) {
    const about = $("aboutContent"),
      timeline = $("timelineContent");
    const aTab = $("aboutTab"),
      tTab = $("timelineTab");

    if (tab === "about") {
      about.classList.remove("hidden");
      timeline.classList.add("hidden");
      aTab.classList.replace("text-gray-500", "text-gray-900");
      aTab.classList.replace("border-transparent", "border-teal-600");
      tTab.classList.replace("text-gray-900", "text-gray-500");
      tTab.classList.replace("border-teal-600", "border-transparent");
    } else {
      timeline.classList.remove("hidden");
      about.classList.add("hidden");
      tTab.classList.replace("text-gray-500", "text-gray-900");
      tTab.classList.replace("border-transparent", "border-teal-600");
      aTab.classList.replace("text-gray-900", "text-gray-500");
      aTab.classList.replace("border-teal-600", "border-transparent");
    }
  }

  function triggerFileInput() {
    $("fileInput").click();
  }

  // Init
  window.onload = loadProfile;
</script>
