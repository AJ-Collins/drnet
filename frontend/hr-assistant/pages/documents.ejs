<style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');

    body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; color: #1e293b; }
    
    .vscode-sidebar { background-color: #1a1a1a; color: #94a3b8; font-family: 'Inter', sans-serif; }
    .tree-item { cursor: pointer; display: flex; align-items: center; padding: 4px 12px; font-size: 13px; transition: all 0.1s; position: relative; }
    .tree-item:hover { background-color: #2d2d2d; color: #f1f5f9; }
    .tree-item.active { background-color: #37373d; color: #ffffff; }
    .tree-item.active-folder { border-left: 2px solid #0d9488; background-color: #2a2d2e; }
    
    .file-tree-item { padding-left: 38px; font-size: 12px; color: #858585; height: 28px; }
    .file-tree-item:hover { color: #e1e1e1; background-color: #2a2d2e; }
    .file-tree-item.active-file { color: #4cc2ff; background-color: #37373d; }

    .folder-actions { display: none; position: absolute; right: 8px; gap: 8px; }
    .tree-item:hover .folder-actions { display: flex; }
    
    .main-grid { display: grid; grid-template-columns: 1fr 320px; height: 100vh; }
    
    .doc-card { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid #e2e8f0; background: white; }
    .doc-card:hover { border-color: #0d9488; transform: translateY(-2px); }
    
    .view-list .doc-grid { grid-template-columns: 1fr !important; gap: 8px !important; }
    .view-list .doc-card { display: flex; align-items: center; padding: 12px 24px; border-radius: 12px; }

    .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    .animate-slide-in { animation: slideIn 0.3s ease-out; }
    .chevron-rotate { transition: transform 0.2s; }
    .open .chevron-rotate { transform: rotate(90deg); }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    .animate-spin-fast {
        animation: spin 0.8s linear infinite;
    }
  </style>
<div class="overflow-y-auto">

  <div id="toastContainer" class="fixed top-5 right-5 z-[120] space-y-3"></div>

  <div class="main-grid">
    <div class="flex flex-col h-full bg-[#fbfcfd]">
        <nav class="h-16 border-b border-slate-200 px-8 flex items-center justify-between bg-white shrink-0">
            <div class="flex items-center gap-6">
                <div class="relative w-64 lg:w-96">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                    <input type="text" id="globalSearch" oninput="renderDocuments()" placeholder="Search files..." 
                           class="w-full pl-10 pr-4 py-2 bg-slate-100 border-none rounded-xl text-sm outline-none">
                </div>
            </div>

            <div class="flex items-center gap-3">
                <div class="flex bg-slate-100 p-1 rounded-xl mr-2">
                    <button onclick="setView('grid')" id="btn-grid" class="px-3 py-1.5 rounded-lg text-xs font-bold transition-all bg-white shadow-sm text-teal-600">
                        <i class="fas fa-th-large"></i>
                    </button>
                    <button onclick="setView('list')" id="btn-list" class="px-3 py-1.5 rounded-lg text-xs font-bold transition-all text-slate-500">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
                <button onclick="openManualReport()" class="text-teal-700 px-4 py-2 text-xs font-bold border border-teal-200 rounded-xl hover:bg-teal-50">
                    <i class="fas fa-chart-line mr-2"></i> GENERATE
                </button>
                <button onclick="openModal('uploadModal')" class="bg-slate-900 text-white px-5 py-2 rounded-xl text-xs font-bold hover:bg-teal-700">
                    <i class="fas fa-plus mr-2"></i> NEW ITEM
                </button>
            </div>
        </nav>

        <main id="workspaceMain" class="flex-1 overflow-y-auto p-4 custom-scrollbar">
            <div class="max-w-full mx-auto">
                <header class="mb-8 flex justify-between items-center">
                    <div>
                        <div class="flex items-center gap-2 text-[10px] font-bold text-teal-600 uppercase tracking-widest mb-1">
                            <i class="fas fa-folder-open"></i> <span id="breadcrumb">ROOT / ALL FILES</span>
                        </div>
                    </div>
                    <div id="filterStats" class="text-xs font-bold text-slate-400 uppercase"></div>
                </header>
                <div id="documentGrid" class="doc-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-2 transition-all"></div>
            </div>
        </main>
    </div>

    <aside class="vscode-sidebar flex flex-col h-full shadow-2xl z-10">
        <div class="p-4 border-b border-[#333333] flex justify-between items-center bg-[#252526]">
            <span class="text-[11px] font-bold uppercase tracking-wider text-gray-500">Explorer</span>
            <button onclick="createNewFolder()" class="hover:text-white p-1"><i class="fas fa-folder-plus text-xs"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto custom-scrollbar py-2" id="explorerBody">
            <div onclick="filterDocs('all')" class="tree-item active" id="tree-all">
                <i class="fas fa-chevron-right mr-2 text-[10px] opacity-0"></i>
                <i class="fas fa-layer-group mr-2 text-teal-500"></i>
                <span>All Documents</span>
            </div>
            <div id="folderTree" class="mt-1"></div>
        </div>
    </aside>
  </div>

  <div id="detailPanel" class="fixed inset-y-0 right-0 w-[480px] bg-white shadow-2xl z-[100] transform translate-x-full transition-transform duration-300 flex flex-col">
    <div class="p-8 border-b bg-slate-50">
        <div class="flex justify-start items-start mb-6">
            <button onclick="closeDetail()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-lg"></i></button>
        </div>
        <input type="text" id="det-name-input" onchange="renameDocument()" class="text-2xl font-black text-slate-900 bg-transparent outline-none w-full">
        <p id="det-cat-label" class="text-[10px] font-bold text-teal-600 uppercase mt-2 tracking-widest"></p>
    </div>
    <div class="flex-1 overflow-y-auto p-8 space-y-8">
        <div id="det-versions" class="space-y-3"></div>
        <div>
            <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Composer</h4>
            
            <div class="space-y-4">
                <div>
                    <label id="reminder-recipient-label" class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">
                        Contact
                    </label>
                    <input type="text" id="reminder-recipient" placeholder="+2547*******/address@gmail.com"
                        class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-teal-500">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Message</label>
                    <textarea id="reminder-message" placeholder="Write your reminder or message here..." 
                        class="w-full p-4 text-sm bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-teal-500 h-40 resize-none"></textarea>
                </div>

                <div class="bg-teal-50 border border-teal-200 rounded-xl p-4 flex flex-col gap-3">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" id="include-main-doc" checked class="accent-teal-600 w-5 h-5">
                        <div class="flex-1">
                            <p class="text-[11px] font-bold text-teal-800">
                                Include this document in the reminder
                            </p>
                            <p class="text-[10px] text-teal-700">
                                "<span id="auto-attached-doc-name"></span>" will be attached
                            </p>
                        </div>
                    </label>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Attach Additional Documents</label>
                    <div class="relative mb-3">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-[10px] text-slate-400"></i>
                        <input type="text" id="reminder-attachment-search" oninput="filterReminderAttachments()" placeholder="Search documents to attach..." 
                               class="w-full pl-9 pr-4 py-2.5 bg-white border border-slate-200 rounded-lg text-xs outline-none focus:border-teal-500">
                    </div>
                    <div id="reminder-attachment-list" class="max-h-64 overflow-y-auto custom-scrollbar space-y-2 border border-slate-200 rounded-xl p-3 bg-slate-50">
                    
                    </div>
                    <p id="reminder-no-attachments" class="text-[10px] text-slate-400 italic text-center py-4 hidden">
                        No documents available or none match your search.
                    </p>
                </div>

                <div class="grid grid-cols-2 gap-4 mt-6">
                    <button onclick="sendReminder('WhatsApp')" class="flex items-center justify-center gap-3 p-2 bg-emerald-50 text-emerald-700 rounded-2xl text-xs font-bold border border-emerald-100 hover:bg-emerald-100 transition-colors">
                        <i class="fab fa-whatsapp text-lg"></i> Send via WhatsApp
                    </button>
                    <button onclick="sendReminder('Email')" class="flex items-center justify-center gap-3 p-4 bg-blue-50 text-blue-700 rounded-2xl text-xs font-bold border border-blue-100 hover:bg-blue-100 transition-colors">
                        <i class="fas fa-envelope text-lg"></i> Send via Email
                    </button>
                </div>
            </div>
        </div>        
    </div>
    <div class="p-8 border-t flex gap-4">
        <button onclick="downloadFile()" class="flex-1 bg-teal-600 text-white py-4 rounded-2xl text-xs font-bold uppercase">Download Latest PDF</button>
        <button onclick="deleteDocFromDetail()" class="px-6 bg-red-50 text-red-600 rounded-2xl hover:bg-red-100"><i class="fas fa-trash-alt"></i></button>
    </div>
  </div>

    <div id="uploadModal" class="modal-overlay hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[110] flex items-center justify-center p-4" onclick="handleOutsideClick(event)">
        <div class="bg-white rounded-xl w-full max-w-[800px] p-10 relative">
            <button onclick="closeModals()" class="absolute top-6 right-6 text-slate-400 hover:text-slate-600">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="text-2xl font-black mb-6 text-slate-900">Archive Records</h3>
            
            <div id="dropZone" class="border-2 border-dashed border-slate-200 rounded-3xl p-12 text-center mb-6 cursor-pointer hover:bg-teal-50 transition-all">
                <i class="fas fa-cloud-upload-alt text-5xl text-teal-600 mb-4"></i>
                <p class="text-sm font-bold mb-2">Drag & Drop files here</p>
                <p class="text-xs text-slate-500 mb-4">or click to browse</p>
                <input type="file" id="fileInput" multiple class="hidden">
            </div>

            <div id="fileListPreview" class="mb-6 space-y-2 max-h-48 overflow-y-auto custom-scrollbar"></div>

            <form id="uploadForm" class="space-y-4">
                <select id="docCategorySelect" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none" required>
                    <option value="">Select Destination Folder</option>
                </select>
                
                <div id="uploadProgressSection" class="hidden">
                    <div class="bg-slate-50 rounded-2xl p-4 space-y-3">
                        <div class="flex justify-between text-xs font-bold">
                            <span id="uploadStatusText">Uploading files...</span>
                            <span id="uploadPercentage">0%</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2 overflow-hidden">
                            <div id="uploadProgressBar" class="bg-teal-600 h-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <div id="uploadFileProgress" class="text-[10px] text-slate-500"></div>
                    </div>
                </div>

                <button type="submit" id="uploadBtn" class="w-full py-5 bg-slate-900 text-white rounded-2xl font-bold hover:bg-teal-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-upload mr-2"></i> UPLOAD FILES
                </button>
            </form>
        </div>
    </div>

  <div id="manualReportModal" class="modal-overlay hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[110] flex items-center justify-center p-4" onclick="handleOutsideClick(event)">
    <div class="bg-white rounded-xl w-full max-w-[1000px] h-[80vh] flex flex-col relative overflow-hidden">
        <div class="p-6 border-b flex justify-between items-center bg-slate-50">
            <div>
                <h3 class="text-xl font-black text-slate-900">Manual Report Composer</h3>
                <p class="text-xs text-slate-500">Drafting operational documentation manually</p>
            </div>
            <button onclick="closeModals()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-lg"></i></button>
        </div>

        <div class="flex-1 flex overflow-hidden">
            <form id="manualReportForm" class="flex-1 p-8 overflow-y-auto space-y-6 custom-scrollbar border-r">
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Report Type</label>
                        <select id="m-reportType" class="w-full p-3 bg-slate-50 border rounded-xl outline-none focus:ring-2 focus:ring-teal-500/20">
                            <option>Daily Activity Report</option>
                            <option>Progress Update</option>
                            <option>Site Incident Report</option>
                            <option>Safety Audit</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Destination Folder</label>
                        <select id="m-reportCategory" class="w-full p-3 bg-slate-50 border rounded-xl outline-none focus:ring-2 focus:ring-teal-500/20">
                            </select>
                    </div>                    
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Project / Reference</label>
                    <input type="text" id="m-reportRef" placeholder="e.g. Project Alpha" class="w-full p-3 bg-slate-50 border rounded-xl outline-none">
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Key Highlights & Progress</label>
                    <textarea id="m-highlights" placeholder="What was achieved today?..." class="w-full p-4 bg-slate-50 border rounded-xl h-32 outline-none"></textarea>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Challenges & Blockers</label>
                    <textarea id="m-challenges" placeholder="Any issues encountered?..." class="w-full p-4 bg-slate-50 border rounded-xl h-24 outline-none"></textarea>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Next Steps</label>
                    <input type="text" id="m-nextSteps" placeholder="Planned activities for tomorrow..." class="w-full p-3 bg-slate-50 border rounded-xl outline-none">
                </div>
            </form>

            <div class="w-80 bg-slate-50 flex flex-col border-l">
                <div class="p-6 border-b bg-slate-100/50">
                    <h4 class="text-[10px] font-bold text-slate-500 uppercase mb-3">Attach Documents</h4>
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-[10px] text-slate-400"></i>
                        <input type="text" id="attachmentSearch" oninput="filterAttachments()" placeholder="Filter files..." 
                               class="w-full pl-8 pr-3 py-2 bg-white border border-slate-200 rounded-lg text-xs outline-none focus:border-teal-500">
                    </div>
                </div>
                <div id="attachmentPickerList" class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar">
                    </div>
            </div>
        </div>

        <div class="p-6 border-t bg-white flex justify-end gap-3">
            <button onclick="closeModals()" class="px-6 py-3 text-sm font-bold text-slate-500 hover:text-slate-700">Cancel</button>
            <button onclick="submitManualReport()" class="px-8 py-3 bg-teal-600 text-white rounded-xl text-sm font-bold shadow-lg shadow-teal-500/20 hover:bg-teal-700">
                <i class="fas fa-check-circle mr-2"></i> FINALISE & SAVE
            </button>
        </div>
    </div>
  </div>
</div>

  <script>
    let folders = [];
    let documents = [];
    const BASE_URL = "/api";
    let currentCategory = 'all', currentDetailId = null, viewMode = 'grid';

    async function loadDataFromBackend() {
        try {
            const [folderRes, docRes] = await Promise.all([
                fetch(`${BASE_URL}/folders`),
                fetch(`${BASE_URL}/documents`)
            ]);
            
            if (!folderRes.ok || !docRes.ok) throw new Error("Server response error");

            folders = await folderRes.json();
            documents = await docRes.json();
            
            renderTree();
            renderDocuments();
        } catch (err) {
            showToast("Server error", "Try again later.");
            console.error("Fetch error:", err);
        }
    }

    function renderTree() {
        const tree = document.getElementById('folderTree');
        if(!tree) return;
        tree.innerHTML = folders.map(f => {
            const isFolderActive = currentCategory === f.id;
            const folderFiles = documents.filter(d => d.category === f.id);
            
            return `
                <div class="folder-group ${f.isOpen ? 'open' : ''}">
                    <div class="tree-item ${isFolderActive ? 'active active-folder' : ''}" onclick="toggleFolder('${f.id}')">
                        <i class="fas fa-chevron-right mr-2 text-[9px] chevron-rotate"></i>
                        <i class="fas ${f.icon} mr-2 ${isFolderActive ? 'text-teal-400' : 'text-slate-500'}"></i>
                        <span class="flex-1 truncate">${f.name}</span>
                        <div class="folder-actions">
                            <i class="fas fa-pen text-[10px]" onclick="event.stopPropagation(); renameFolder('${f.id}')"></i>
                            <i class="fas fa-trash text-[10px]" onclick="event.stopPropagation(); deleteFolder('${f.id}')"></i>
                        </div>
                    </div>
                    <div class="folder-content ${f.isOpen ? '' : 'hidden'}">
                        ${folderFiles.map(doc => `
                            <div class="tree-item file-tree-item ${currentDetailId === doc.id ? 'active-file' : ''}" onclick="event.stopPropagation(); openDetail(${doc.id})">
                                <i class="far fa-file-alt mr-2 text-blue-400"></i>
                                <span class="truncate">${doc.name}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }).join('');
        
        const select = document.getElementById('docCategorySelect');
        if(select) select.innerHTML = folders.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
    }

    function toggleFolder(id) {
        folders = folders.map(f => {
            if (f.id === id) {
                const updatedFolder = { ...f, isOpen: !f.isOpen };
                saveAndSync(`folders/${id}`, 'PUT', { 
                    name: updatedFolder.name, 
                    isOpen: updatedFolder.isOpen 
                });
                return updatedFolder;
            }
            return f;
        });
        filterDocs(id);
    }

    function filterDocs(id) {
        currentCategory = id;
        document.getElementById('breadcrumb').innerText = `ROOT / ${id.toUpperCase()}`;
        const folder = folders.find(f => f.id === id);
        document.getElementById('tree-all').classList.toggle('active', id === 'all');
        renderTree();
        renderDocuments();
    }

    function renderDocuments() {
        const grid = document.getElementById('documentGrid'), search = document.getElementById('globalSearch').value.toLowerCase();
        const filtered = documents.filter(d => (currentCategory === 'all' || d.category === currentCategory) && d.name.toLowerCase().includes(search));
        document.getElementById('filterStats').innerText = `${filtered.length} Items`;

        grid.innerHTML = filtered.map(doc => `
            <div onclick="openDetail(${doc.id})" class="doc-card p-6 rounded-[12px] cursor-pointer group">
                <div class="card-icon w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center text-slate-400 mb-4 group-hover:text-teal-600"><i class="fas fa-file-contract text-xl"></i></div>
                <h4 class="font-bold truncate text-slate-800">${doc.name}</h4>
                <div class="flex items-center gap-2 mt-2">
                    <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded text-slate-500 font-bold uppercase">v${doc.versions.length}.0</span>
                    <span class="text-[10px] text-slate-400">${doc.versions[doc.versions.length-1].date}</span>
                </div>
            </div>`).join('') || '<div class="col-span-full py-20 text-center text-slate-400 italic">Folder is empty</div>';
    }

    function openDetail(id) {
        currentDetailId = id;
        const d = documents.find(x => x.id === id);
        if(!d) return;

        document.getElementById('det-name-input').value = d.name;
        document.getElementById('det-cat-label').innerText = d.category;
        document.getElementById('auto-attached-doc-name').textContent = d.name;
        
        let contentHtml = '';
        if(d.isManual) {
            contentHtml = `
                <div class="bg-teal-50 p-4 rounded-xl border border-teal-100 mb-6">
                    <h5 class="text-[10px] font-black text-teal-700 uppercase mb-2">Report Content</h5>
                    <p class="text-xs text-slate-700 mb-2"><strong>Highlights:</strong> ${d.content.highlights}</p>
                    ${d.content.challenges ? `<p class="text-xs text-slate-700 mb-2"><strong>Challenges:</strong> ${d.content.challenges}</p>` : ''}
                    <p class="text-xs text-slate-700"><strong>Next Steps:</strong> ${d.content.nextSteps}</p>
                </div>
            `;

            if(d.attachments && d.attachments.length > 0) {
                contentHtml += `<h5 class="text-[10px] font-black text-slate-400 uppercase mb-2">Linked Attachments</h5><div class="space-y-2 mb-6">`;
                d.attachments.forEach(attId => {
                    const attDoc = documents.find(doc => doc.id == attId);
                    if(attDoc) {
                        contentHtml += `<div class="flex items-center gap-2 p-2 bg-white border rounded-lg text-[11px] font-medium text-slate-600"><i class="fas fa-link text-teal-500"></i> ${attDoc.name}</div>`;
                    }
                });
                contentHtml += `</div>`;
            }
        }

        document.getElementById('det-versions').innerHTML = contentHtml + d.versions.slice().reverse().map(v => `
            <div class="p-3 bg-slate-50 rounded-xl border border-slate-100">
                <div class="flex justify-between font-bold text-[10px] text-slate-400 uppercase mb-1"><span>Version ${v.v}</span><span>${v.date}</span></div>
                <p class="text-xs text-slate-600">${v.note}</p>
            </div>`).join('');
            
        document.getElementById('detailPanel').classList.remove('translate-x-full');
        renderReminderAttachments();
        document.getElementById('reminder-message').value = '';
        document.getElementById('reminder-attachment-search').value = '';
        renderTree(); 
    }

    function openModal(id) {
        const modal = document.getElementById(id);
        if(modal) modal.classList.remove('hidden');
    }

    function closeModals() {
        document.querySelectorAll('.modal-overlay').forEach(m => m.classList.add('hidden'));
    }

    function handleOutsideClick(e) {
        if(e.target.classList.contains('modal-overlay')) closeModals();
    }

    function openManualReport() {
        const picker = document.getElementById('attachmentPickerList');
        const searchInput = document.getElementById('attachmentSearch');
        const reportCatSelect = document.getElementById('m-reportCategory');

        if(searchInput) searchInput.value = '';

        if(picker) {
            if (!documents || documents.length === 0) {
                picker.innerHTML = `
                    <div class="p-4 text-center border-2 border-dashed border-slate-100 rounded-xl">
                        <i class="fas fa-info-circle text-slate-300 mb-2"></i>
                        <p class="text-[10px] text-slate-400 italic">No documents available to attach or still loading...</p>
                    </div>`;
            } else {
                picker.innerHTML = documents.map(doc => `
                    <label class="flex items-center gap-3 p-3 bg-white border rounded-xl cursor-pointer hover:border-teal-500 transition-all">
                        <input type="checkbox" name="report_attachment" value="${doc.id}" class="accent-teal-600">
                        <div class="overflow-hidden">
                            <p class="text-[11px] font-bold truncate">${doc.name}</p>
                            <p class="text-[9px] text-slate-400 uppercase">${doc.category}</p>
                        </div>
                    </label>
                `).join('');
            }
        }
        
        if (reportCatSelect) {
            reportCatSelect.innerHTML = folders.map(f => 
                `<option value="${f.id}">${f.name}</option>`
            ).join('');
        }

        openModal('manualReportModal');
    }

    function renderReminderAttachments() {
        const container = document.getElementById('reminder-attachment-list');
        const noAttachmentsMsg = document.getElementById('reminder-no-attachments');
        
        if (!documents || documents.length === 0) {
            container.innerHTML = '';
            noAttachmentsMsg.classList.remove('hidden');
            noAttachmentsMsg.textContent = 'No documents available';
            return;
        }

        const availableDocs = documents.find(doc => doc.id === currentDetailId);

        if (!availableDocs) {
            container.innerHTML = '';
            noAttachmentsMsg.classList.remove('hidden');
            noAttachmentsMsg.textContent = 'Document not found';
            return;
        }

        const sameFolderDocs = documents.filter(doc => 
            doc.category === availableDocs.category && 
            doc.id !== currentDetailId
        );

        if (sameFolderDocs.length === 0) {
            container.innerHTML = '';
            noAttachmentsMsg.classList.remove('hidden');
            noAttachmentsMsg.textContent = 'No other documents in this folder to attach';
            return;
        }
        
        const currentFolderName = folders.find(f => f.id === availableDocs.category)?.name || 'Unknown Folder';

        container.innerHTML = sameFolderDocs.map(doc => `
           <label class="flex items-center gap-2 p-2 bg-white border rounded-md cursor-pointer hover:border-teal-500 transition-all">
                <input type="checkbox" name="reminder_attachment" value="${doc.id}" class="accent-teal-600 scale-90">
                <div class="flex-1 overflow-hidden leading-tight">
                    <p class="text-[10px] font-semibold truncate">${doc.name}</p>
                    <p class="text-[8px] text-slate-400 uppercase tracking-wide truncate">v${doc.versions.length} â€¢ ${doc.versions[doc.versions.length-1].date}</p>
                </div>
            </label>
        `).join('');

        noAttachmentsMsg.classList.add('hidden');

        if (!document.getElementById('reminder-folder-context')) {
            const contextHeader = document.createElement('div');
            contextHeader.id = 'reminder-folder-context';
            contextHeader.className = 'text-[9px] font-bold text-teal-600 uppercase tracking-wider mb-2';
            contextHeader.textContent = `Attach from: ${currentFolderName}`;
            container.before(contextHeader);
        } else {
            document.getElementById('reminder-folder-context').textContent = `Attach from: ${currentFolderName}`;
        }
    }

    function filterReminderAttachments() {
        const search = document.getElementById('reminder-attachment-search').value.toLowerCase();
        const labels = document.querySelectorAll('#reminder-attachment-list label');
        const noMsg = document.getElementById('reminder-no-attachments');

        let visibleCount = 0;

        labels.forEach(label => {
            const name = label.querySelector('p').innerText.toLowerCase();
            if (name.includes(search)) {
                label.style.display = 'flex';
                visibleCount++;
            } else {
                label.style.display = 'none';
            }
        });

        if (visibleCount === 0 && labels.length > 0) {
            noMsg.classList.remove('hidden');
            noMsg.textContent = 'No documents match your search';
        } else {
            noMsg.classList.add('hidden');
        }
    }

    async function sendReminder(channel) {
        const message = document.getElementById('reminder-message').value.trim();
        const recipient = document.getElementById('reminder-recipient').value.trim();
        const selectedCheckboxes = document.querySelectorAll('input[name="reminder_attachment"]:checked');
        const attachmentIds = Array.from(selectedCheckboxes).map(cb => cb.value);

        const includeMainDoc = document.getElementById('include-main-doc').checked;

        if (includeMainDoc && currentDetailId && !attachmentIds.includes(currentDetailId)) {
            attachmentIds.push(currentDetailId);
        }

        if (!message) {
            showToast("Error", "Please write a reminder message.");
            return;
        }

        if (!recipient) {
            showToast("Error", "Please enter a recipient.");
            return;
        }

        if (channel === 'WhatsApp') { //&& !recipient.startsWith('+')
            // showToast("Error", "Phone number must include country code (e.g., +1234567890)");
            showToast("Error", "Will be implemented soon. Hold on");
            return;
        }
        if (channel === 'Email' && !recipient.includes('@')) {
            showToast("Error", "Please enter a valid email address.");
            return;
        }

        document.getElementById('reminder-recipient-label').textContent = 
            channel === 'WhatsApp' ? 'Recipient Phone Number' : 'Recipient Email Address';
        document.getElementById('reminder-recipient').placeholder = 
            channel === 'WhatsApp' ? '+1234567890 (include country code)' : 'name@company.com';

        const whatsappBtn = document.querySelector('button[onclick*="WhatsApp"]');
        const emailBtn = document.querySelector('button[onclick*="Email"]');
        const originalWhatsAppText = whatsappBtn.innerHTML;
        const originalEmailText = emailBtn.innerHTML;

        if (channel === 'WhatsApp') {
            whatsappBtn.disabled = true;
            whatsappBtn.innerHTML = `<i class="fas fa-circle-notch animate-spin-fast mr-2"></i> SENDING...`;
        } else {
            emailBtn.disabled = true;
            emailBtn.innerHTML = `<i class="fas fa-circle-notch animate-spin-fast mr-2"></i> SENDING...`;
        }

        try {
            const payload = {
                message: message,
                recipient: recipient,
                attachments: attachmentIds,
                channel: channel.toLowerCase()
            };

            if (includeMainDoc) {
                payload.context_document_id = currentDetailId;
            }

            const response = await fetch(`${BASE_URL}/doc/notify`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || 'Failed to send reminder');
            }

            const result = await response.json();

            showToast("Success", result.message || `Reminder sent via ${channel}!`);

            document.getElementById('reminder-message').value = '';
            document.getElementById('reminder-recipient').value = '';
            selectedCheckboxes.forEach(cb => cb.checked = false);
            document.getElementById('reminder-attachment-search').value = '';
            filterReminderAttachments();
        } catch(err) {
            console.error('Reminder send error:', err);
            showToast("Error", err.message || "Failed to send reminder. Please try again.");
        } finally {
            if (channel === 'WhatsApp') {
                whatsappBtn.disabled = false;
                whatsappBtn.innerHTML = originalWhatsAppText;
            } else {
                emailBtn.disabled = false;
                emailBtn.innerHTML = originalEmailText;
            }
        }
    }

    async function  submitManualReport() {
        const type = document.getElementById('m-reportType').value;
        const ref = document.getElementById('m-reportRef').value;
        const categoryId = document.getElementById('m-reportCategory').value;
        const highlights = document.getElementById('m-highlights').value;
        const challenges = document.getElementById('m-challenges').value;
        const nextSteps = document.getElementById('m-nextSteps').value;
        const selectedIds = Array.from(document.querySelectorAll('input[name="report_attachment"]:checked')).map(cb => cb.value);

        if(!highlights) {
            showToast("Error", "Please provide report highlights.");
            return;
        }

        const newReport = {
            name: `${type} - ${ref || 'No Ref'}`,
            category: categoryId,
            isManual: true,
            content: { highlights, challenges, nextSteps },
            attachments: selectedIds,
            versions: [{ v: 1, date: new Date().toLocaleDateString(), note: "Manually Prepared Report" }]
        };

        const response = await fetch(`${BASE_URL}/documents/manual`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newReport)
        });

        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error || 'Failed to save report');
        }

        const result = await response.json();
        showToast("SUCCESS", result.message || "Report saved.");
        closeModals();
        loadDataFromBackend();
        document.getElementById('manualReportForm').reset();
    }

    async function saveAndSync(endpoint = null, method = 'GET', data = null) {
        if (!endpoint) return;
        try {
            const options = {
                method: method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (data) options.body = JSON.stringify(data);
            const response = await fetch(`${BASE_URL}/${endpoint}`, options);

            if (!response.ok) throw new Error("Sync failed");  

            await loadDataFromBackend();
        } catch (err) {
            showToast("Server Error", "Please try again.");
        }
    }

    async function createNewFolder() {
        const n = prompt("Folder Name:");
        if (n) {
            const newFolder = {
                id: Date.now().toString(),
                name: n,
                icon: 'fa-folder',
                isOpen: true
            };
            
            await saveAndSync('folders', 'POST', newFolder);
        }
    }

    async function renameFolder(id) {
        const f = folders.find(x => x.id === id);
        const n = prompt("Rename to:", f.name);
    
        if (n && n.trim() !== "") {
            const updateData = { 
                name: n, 
                isOpen: f.isOpen
            };
            await saveAndSync(`folders/${id}`, 'PUT', updateData);
        }
    }

    async function renameDocument() {
        if (!currentDetailId) return;
        const newName = document.getElementById('det-name-input').value.trim();
        if (!newName) return;

        const updateData = { name: newName };

        await saveAndSync(`documents/${currentDetailId}`, 'PUT', updateData);
        showToast("Success", "Renamed successfully");
    }

    function filterAttachments() {
        const searchTerm = document.getElementById('attachmentSearch').value.toLowerCase();
        const items = document.querySelectorAll('#attachmentPickerList label');

        items.forEach(item => {
            // Search against the filename text within the label
            const fileName = item.querySelector('p').innerText.toLowerCase();
            if (fileName.includes(searchTerm)) {
                item.style.display = "flex";
            } else {
                item.style.display = "none";
            }
        });
    }

    async function deleteFolder(id) {
        if (confirm("Delete folder? Files will stay in repository.")) {
            await saveAndSync(`folders/${id}`, 'DELETE');
        }
    }

    function closeDetail() { 
        document.getElementById('detailPanel').classList.add('translate-x-full'); 
        currentDetailId = null; 
        renderTree(); 
        const contextHeader = document.getElementById('reminder-folder-context');
        if (contextHeader) contextHeader.remove();
    }

    function showToast(title, msg) {
        const t = document.createElement('div');
        t.className = "bg-slate-900 text-white p-4 rounded-xl shadow-2xl border-teal-500 animate-slide-in";
        t.innerHTML = `<h5 class="text-[10px] font-black text-teal-400 uppercase tracking-widest">${title}</h5><p class="text-xs text-slate-300">${msg}</p>`;
        document.getElementById('toastContainer').appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }

    function setView(mode) {
        viewMode = mode;
        document.getElementById('workspaceMain').className = mode === 'list' ? 'flex-1 overflow-y-auto p-8 custom-scrollbar view-list' : 'flex-1 overflow-y-auto p-8 custom-scrollbar';
        document.getElementById('btn-grid').classList.toggle('text-teal-600', mode === 'grid');
        document.getElementById('btn-list').classList.toggle('text-teal-600', mode === 'list');
    }

    function dispatch(p) { showToast("Dispatch", `Sent via ${p}`); }
        async function downloadFile() {
        if (!currentDetailId) {
            showToast("Error", "No document selected");
            return;
        }
        
        const doc = documents.find(d => d.id === currentDetailId);
        if (!doc) {
            showToast("Error", "Document not found");
            return;
        }
        
        if (doc.isManual) {
            showToast("Info", "Manual reports don't have downloadable files. This is a text-based report.");
            return;
        }        
            
        if (!doc.file_path) {
            showToast("Error", "File path not found for this document");
            return;
        }

        const dlBtn = document.querySelector('#detailPanel button[onclick="downloadFile()"]');
        const originalContent = dlBtn.innerHTML;
        dlBtn.disabled = true;
        dlBtn.innerHTML = `<i class="fas fa-circle-notch animate-spin-fast mr-2"></i> PREPARING...`;
        dlBtn.classList.add('opacity-75', 'cursor-not-allowed');
        
        try {
            showToast("Download", "Preparing file...");
            
            const downloadUrl = `${BASE_URL}/documents/${currentDetailId}/download`;
            
            const response = await fetch(downloadUrl);
            
            if (!response.ok) {
                throw new Error("Download failed");
            }
            
            const blob = await response.blob();
            
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = doc.name || 'document';
            
            document.body.appendChild(a);
            a.click();
            
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showToast("Success", "File downloaded successfully");
            
        } catch (err) {
            console.error('Download error:', err);
            showToast("Error", "Could not download file. Please try again.");
        } finally {
            dlBtn.disabled = false;
            dlBtn.innerHTML = originalContent;
            dlBtn.classList.remove('opacity-75', 'cursor-not-allowed');
        }
    }

    async function deleteDocFromDetail() {
        if(confirm("Permanently delete this record?")) {
            await saveAndSync(`documents/${currentDetailId}`, 'DELETE');
            closeDetail();
        }
    }
    

    let selectedFiles = [];

    function initializeUploadUI() {
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        
        dropZone.onclick = (e) => {
            if (e.target.id !== 'fileInput') {
                fileInput.click();
            }
        };
        
        fileInput.onchange = (e) => {
            handleFileSelection(Array.from(e.target.files));
        };
        
        dropZone.ondragover = (e) => {
            e.preventDefault();
            dropZone.classList.add('border-teal-500', 'bg-teal-50');
        };
        
        dropZone.ondragleave = (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-teal-500', 'bg-teal-50');
        };
        
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-teal-500', 'bg-teal-50');
            
            const files = Array.from(e.dataTransfer.files);
            handleFileSelection(files);
        };
    }

    function handleFileSelection(files) {
        if (files.length === 0) return;
        
        selectedFiles = [...selectedFiles, ...files];
        
        selectedFiles = selectedFiles.filter((file, index, self) =>
            index === self.findIndex(f => f.name === file.name && f.size === file.size)
        );
        
        renderFileList();
    }

    function renderFileList() {
        const preview = document.getElementById('fileListPreview');
        
        if (selectedFiles.length === 0) {
            preview.innerHTML = '';
            return;
        }
        
        preview.innerHTML = selectedFiles.map((file, index) => `
            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl border">
                <div class="flex items-center gap-3 flex-1 min-w-0">
                    <i class="fas fa-file text-teal-600"></i>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-bold truncate">${file.name}</p>
                        <p class="text-xs text-slate-500">${formatFileSize(file.size)}</p>
                    </div>
                </div>
                <button type="button" onclick="removeFile(${index})" class="text-red-500 hover:text-red-700 px-2">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `).join('');
    }

    function removeFile(index) {
        selectedFiles.splice(index, 1);
        renderFileList();
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    document.getElementById('uploadForm').onsubmit = async (e) => {
        e.preventDefault();
        
        const category = document.getElementById('docCategorySelect').value;
        const uploadBtn = document.getElementById('uploadBtn');
        const progressSection = document.getElementById('uploadProgressSection');
        const progressBar = document.getElementById('uploadProgressBar');
        const statusText = document.getElementById('uploadStatusText');
        const percentageText = document.getElementById('uploadPercentage');
        const fileProgress = document.getElementById('uploadFileProgress');
        
        if (!category) {
            showToast("Error", "Please select a destination folder");
            return;
        }
        
        if (selectedFiles.length === 0) {
            showToast("Error", "Please select at least one file");
            return;
        }
        
        // Disable button and show progress
        uploadBtn.disabled = true;
        progressSection.classList.remove('hidden');
        
        const formData = new FormData();
        formData.append('category', category);
        
        // Append all files with the field name 'file' (matching backend)
        selectedFiles.forEach(file => {
            formData.append('file', file);
        });
        
        try {
            const xhr = new XMLHttpRequest();
            
            // Progress tracking
            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    progressBar.style.width = percentComplete + '%';
                    percentageText.textContent = percentComplete + '%';
                    fileProgress.textContent = `${formatFileSize(e.loaded)} / ${formatFileSize(e.total)}`;
                }
            };
            
            // Success handler
            xhr.onload = () => {
                if (xhr.status === 201) {
                    const response = JSON.parse(xhr.responseText);
                    showToast("SUCCESS", `${response.count} file(s) uploaded successfully`);
                    
                    // Reset form
                    selectedFiles = [];
                    renderFileList();
                    document.getElementById('uploadForm').reset();
                    progressSection.classList.add('hidden');
                    progressBar.style.width = '0%';
                    
                    closeModals();
                    loadDataFromBackend();
                } else {
                    throw new Error('Upload failed');
                }
                uploadBtn.disabled = false;
            };
            
            // Error handler
            xhr.onerror = () => {
                showToast("Error", "Upload failed. Please try again.");
                uploadBtn.disabled = false;
                progressSection.classList.add('hidden');
            };
            
            // Send request
            xhr.open('POST', `${BASE_URL}/documents`);
            xhr.send(formData);
            
            statusText.textContent = `Uploading ${selectedFiles.length} file(s)...`;
            
        } catch (err) {
            console.error('Upload error:', err);
            showToast("Error", "Could not upload files");
            uploadBtn.disabled = false;
            progressSection.classList.add('hidden');
        }
    };

    window.onload = () => { 
        loadDataFromBackend();
        initializeUploadUI();
    };
  </script>