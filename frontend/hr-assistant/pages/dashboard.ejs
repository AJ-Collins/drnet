<style>
  .gradient-bg {
    background: linear-gradient(135deg, #0d9488 0%, #0f766e 50%, #115e59 100%);
  }
  .stat-card {
    transition: all 0.3s ease;
  }
  .stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 25px rgba(13, 148, 136, 0.15);
  }

  @keyframes skeleton {
    0% { background-color: #f3f4f6; }
    100% { background-color: #e5e7eb; }
  }
  .skeleton { background: #e5e7eb; animation: skeleton 1.2s ease-in-out infinite; border-radius: 0.5rem; }
  .skeleton-text { height: 1rem; }
  .skeleton-title { height: 1.5rem; width: 70%; }
  .skeleton-circle { width: 2.5rem; height: 2.5rem; border-radius: 9999px; }
  .skeleton-line { height: 1rem; width: 100%; }
  .skeleton-sm { height: 0.75rem; width: 60%; }
</style>

<div class="flex flex-1">
  <main class="flex-1 p-4 lg:p-2">
     <!-- Page Header -->
    <div class="mb-2">
      <h1 class="text-3xl font-bold text-teal-800">Dashboard</h1>
      <p class="text-teal-600">
        Manage your daily work efficiently
      </p>
    </div>

    <section class="mb-8">
      <div class="flex items-center justify-between mb-6">
        <!-- <h2 class="text-2xl font-bold text-gray-800">Metrics Overview</h2> -->
        <span id="criticalAlert" class="px-5 py-2 bg-red-100 text-red-800 rounded-full text-sm font-bold hidden">
          <i class="fas fa-exclamation-triangle mr-2"></i>
          Critical Items Need Attention!
        </span>
      </div>

      <div id="statsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
      </div>
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- Project Progress Trend Chart -->
      <div class="lg:col-span-1 bg-white shadow-lg p-6">
        <div class="flex items-center justify-between mb-5">
          <h3 class="text-lg font-semibold text-gray-800">Progress Trend</h3>
          <div class="flex space-x-2">
            <button data-period="monthly" class="period-btn px-3 py-1 bg-teal-100 text-teal-700 rounded-lg text-sm font-medium">Monthly</button>
            <button data-period="quarterly" class="period-btn px-3 py-1 bg-gray-100 text-gray-600 rounded-lg text-sm font-medium">Quarterly</button>
          </div>
        </div>
        <div class="h-72"><canvas id="progressChart"></canvas></div>
      </div>

      <!-- Active Projects -->
      <div class="lg:col-span-1">
        <div class="flex items-center justify-between mb-5">
          <h2 class="text-xl font-semibold text-gray-800 flex items-center">
            <i class="fas fa-project-diagram text-teal-600 mr-3"></i> Active Projects
          </h2>
          <% const projectsSlug = "projects"; %>
          <a href="/hr-assistant/<%= projectsSlug %>" class="text-teal-600 hover:text-teal-800 font-medium text-base">View All →</a>
        </div>
        <div id="projectsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[420px] overflow-y-auto pr-1">
          <!-- Filled by JS -->
        </div>
      </div>
    </section>

    <section class="grid grid-cols-0 lg:grid-cols-0 gap-7 mb-8">
        <!-- Recent Documents -->
        <div class="bg-white shadow-lg p-6">
            <div class="flex items-center justify-between mb-5">
            <h3 class="text-lg font-semibold text-gray-800">Recent Documents</h3>
            <% const documentsSlug = "documents"; %>
            <a href="/hr-assistant/<%= documentsSlug %>" class="text-teal-600 hover:text-teal-800 font-medium text-sm">View All → </a>
            </div>
            <div
            id="docsContainer"
            class="space-y-3 max-h-96 overflow-y-auto pr-2"
            ></div>
        </div>

        <!-- Quick Actions -->
        <!-- <div class="bg-white shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-6">
            Quick Actions
            </h3>

            <div class="grid grid-cols-2 gap-5">
            <a
                href="/hr/tasks/create"
                class="bg-teal-50 hover:bg-teal-100 rounded-2xl p-5 text-center transition group"
            >
                <div
                class="w-12 h-12 bg-teal-500 rounded-xl flex items-center justify-center mx-auto mb-3 group-hover:bg-teal-600 shadow-md"
                >
                <i class="fas fa-list-check text-white text-xl"></i>
                </div>
                <p class="font-semibold text-teal-700 text-sm">
                Create Task
                </p>
            </a>

            <a
                href="/hr/communications/send"
                class="bg-blue-50 hover:bg-blue-100 rounded-2xl p-5 text-center transition group"
            >
                <div
                class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center mx-auto mb-3 group-hover:bg-blue-600 shadow-md"
                >
                <i class="fas fa-paper-plane text-white text-xl"></i>
                </div>
                <p class="font-semibold text-blue-700 text-sm">
                Send Message
                </p>
            </a>

            <a
                href="/hr/documents/upload"
                class="bg-green-50 hover:bg-green-100 rounded-2xl p-5 text-center transition group"
            >
                <div
                class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center mx-auto mb-3 group-hover:bg-green-600 shadow-md"
                >
                <i class="fas fa-upload text-white text-xl"></i>
                </div>
                <p class="font-semibold text-green-700 text-sm">
                Upload Document
                </p>
            </a>

            <a
                href="/hr/projects/expense"
                class="bg-purple-50 hover:bg-purple-100 rounded-2xl p-5 text-center transition group"
            >
                <div
                class="w-12 h-12 bg-purple-500 rounded-xl flex items-center justify-center mx-auto mb-3 group-hover:bg-purple-600 shadow-md"
                >
                <i class="fas fa-receipt text-white text-xl"></i>
                </div>
                <p class="font-semibold text-purple-700 text-sm">
                Log Expense
                </p>
            </a>

            </div>
        </div> -->
        </section>
  </main>
</div>

<template id="statCardTemplate">
  <div class="stat-card bg-white rounded-2xl shadow-xl p-7 border border-gray-200 hover:shadow-2xl transition">
    <div class="flex items-center justify-between mb-4">
      <div class="w-14 h-14 rounded-xl flex items-center justify-center icon-bg">
        <i class="fas text-white text-2xl icon"></i>
      </div>
      <span class="text-3xl font-bold text-gray-800 count">0</span>
    </div>
    <p class="text-gray-600 text-sm label"></p>
    <p class="text-gray-500 text-xs mt-2 subtext"></p>
  </div>
</template>

<template id="taskCardTemplate">
  <div class="stat-card bg-teal-50 rounded-xl shadow-lg p-6 border border-teal-400">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-teal-700 text-base font-bold priority-label"></p>
        <h3 class="text-4xl font-bold text-gray-800 mt-2 count"></h3>
        <p class="text-teal-600 text-sm mt-1">tasks today</p>
      </div>
      <div class="w-14 h-14 bg-teal-100 rounded-lg flex items-center justify-center">
        <i class="fas fa-clipboard-list text-teal-600 text-2xl"></i>
      </div>
    </div>
  </div>
</template>

<template id="commItemTemplate">
  <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-teal-50 transition">
    <div class="flex items-center space-x-4">
      <div class="w-10 h-10 bg-teal-100 rounded-full flex items-center justify-center">
        <i class="fas fa-envelope text-teal-600 text-lg"></i>
      </div>
      <div>
        <p class="font-medium text-gray-800 subject text-base"></p>
        <p class="text-gray-600 text-sm recipient"></p>
      </div>
    </div>
    <span class="text-sm text-gray-500 time"></span>
  </div>
</template>

<template id="docItemTemplate">
  <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-teal-50 transition">
    <div class="flex items-center space-x-4">
      <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
        <i class="fas fa-file-alt text-blue-600 text-lg"></i>
      </div>
      <div>
        <p class="font-medium text-gray-800 title text-base"></p>
        <p class="text-gray-600 text-sm category"></p>
      </div>
    </div>
    <a href="#" class="download-link text-teal-600 hover:text-teal-800 font-medium text-base"></a>
  </div>
</template>

<template id="projectCardTemplate">
  <div class="stat-card bg-white rounded-2xl shadow-xl p-7 border border-gray-200">
    <div class="flex justify-between items-start mb-5">
      <div>
        <h4 class="text-lg font-bold text-gray-800 name"></h4>
        <p class="text-gray-600 text-sm type mt-1"></p>
      </div>
      <span class="status-badge px-3 py-1 rounded-full text-xs font-bold"></span>
    </div>
    <div class="mb-5">
      <div class="flex justify-between text-sm mb-2">
        <span class="text-gray-600">Progress</span>
        <span class="progress-percent font-bold text-teal-700"></span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-3">
        <div class="progress-bar h-3 rounded-full transition-all duration-700"></div>
      </div>
    </div>
    <div class="flex justify-between text-sm">
      <span class="text-gray-700">Spent: <span class="budget-spent font-bold"></span></span>
      <span class="budget-status font-bold"></span>
    </div>
  </div>
</template>

<script>
  const API_BASE = "/api/hr";
  const $ = (s) => document.querySelector(s);
  const $$ = (s) => document.querySelectorAll(s);

  const timeAgo = (dateString) => {
    if (!dateString) return "N/A";
    const now = new Date();
    const date = new Date(dateString);
    const diff = now - date;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    if (days === 0) return "Today";
    if (days === 1) return "Yesterday";
    return `${days} days ago`;
  };

  let progressChart = null;

  /* 1. TODAY'S TASKS SUMMARY */
  async function renderStats() {
    const container = document.getElementById("statsGrid");
    
    // 1. Skeleton Loader for 4 cards
    container.innerHTML = Array(4).fill("").map(() => `
      <div class="bg-teal-50 rounded-xl shadow-lg p-6 border border-teal-400 animate-pulse">
        <div class="h-4 w-24 bg-teal-200 rounded mb-4"></div>
        <div class="h-24 bg-slate-200 rounded-lg"></div>
      </div>
    `).join("");

    try {
      const data = await fetch(`${API_BASE}/stats-summary`).then(r => r.json());
      container.innerHTML = "";

      const stats = [
        {
          label: "Projects",
          title: "Active Projects",
          count: data.activeProjects,
          icon: "fa-project-diagram",
          colorClass: "bg-teal-100 text-teal-700",
          subtext: "Live in system",
          trendIcon: "fa-check-circle"
        },
        {
          label: "Procurement",
          title: "Pending Requests",
          count: data.pendingRequests,
          icon: "fa-clock",
          colorClass: data.pendingRequests > 0 ? "bg-orange-100 text-orange-700" : "bg-slate-100 text-slate-500",
          subtext: "Awaiting approval",
          trendIcon: "fa-hourglass-half"
        },
        {
          label: "Deadlines",
          title: "Overdue Tasks",
          count: data.overdueTasks,
          icon: "fa-exclamation-triangle",
          colorClass: data.overdueTasks > 0 ? "bg-red-100 text-red-600" : "bg-teal-100 text-teal-700",
          subtext: "Immediate action",
          trendIcon: "fa-calendar-times"
        },
        {
          label: "Financials",
          title: "Budget at Risk",
          count: `Ksh ${data.atRiskAmount.toLocaleString()}`,
          icon: "fa-chart-line",
          colorClass: data.atRiskAmount > 0 ? "bg-purple-100 text-purple-700" : "bg-teal-100 text-teal-700",
          subtext: `${data.atRiskProjects} Overspent`,
          trendIcon: "fa-arrow-up"
        }
      ];

      stats.forEach(s => {
        const cardHtml = `
          <div class="stat-card bg-teal-50 rounded-xl shadow-lg p-6 border border-teal-400">
            <h3 class="text-teal-600 text-[10px] font-black uppercase tracking-widest mb-4 flex items-center justify-between">
              <span>${s.label}</span><i class="fas ${s.icon} text-teal-600"></i>
            </h3>
            <div class="${s.colorClass} rounded-lg p-4 transition-all hover:scale-[1.02] shadow-sm border border-white/50">
              <p class="text-[11px] font-bold opacity-80">${s.title}</p>
              <h2 class="text-2xl font-bold text-slate-800 mt-1">${s.count}</h2>
              <p class="text-[10px] font-medium flex items-center mt-2">
                <i class="fas ${s.trendIcon} mr-1"></i> ${s.subtext}
              </p>
            </div>
          </div>
        `;
        container.insertAdjacentHTML('beforeend', cardHtml);
      });

    } catch (e) {
      console.error(e);
      container.innerHTML = `<div class="col-span-full p-8 text-center text-slate-400 font-medium bg-white rounded-2xl border border-dashed border-slate-300">
        <i class="fas fa-exclamation-circle mb-2 text-xl"></i><br>Failed to sync dashboard metrics
      </div>`;
    }
}

  /* 2. RECENT DOCUMENTS */
  async function renderRecentDocs() {
    const container = $("#docsContainer");
    container.innerHTML = Array(6).fill("").map(() => `
      <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
        <div class="flex items-center space-x-4">
          <div class="skeleton skeleton-circle"></div>
          <div class="flex-1">
            <div class="skeleton skeleton-title mb-2"></div>
            <div class="skeleton skeleton-sm"></div>
          </div>
        </div>
      </div>
    `).join("");

    try {
      const { documents } = await fetch(`${API_BASE}/documents/recent`).then(r => r.json());

      const tmpl = document.getElementById("docItemTemplate").content;
      container.innerHTML = documents.length ? "" : "<p class='text-center text-gray-500 py-6 text-base'>No recent documents</p>";

      documents.forEach(d => {
        const node = tmpl.cloneNode(true);
        node.querySelector(".title").textContent = d.name;
        node.querySelector(".category").textContent = d.category;
        const link = node.querySelector(".download-link");
        if (!d.isManual) {
          link.href = `/api/hr/documents/${d.id}/download`;
        } else {
          link.remove(); // manual reports can't be downloaded
        }
        container.appendChild(node);
      });
    } catch (e) {
      container.innerHTML = `<p class="text-red-600 text-center py-6">Error loading documents</p>`;
    }
  }

  /* 3. ACTIVE PROJECTS */
  async function renderActiveProjects() {
    const container = $("#projectsGrid");
    container.innerHTML = Array(4).fill("").map(() => `
      <div class="bg-white rounded-2xl p-7 shadow-xl border border-gray-200">
        <div class="skeleton skeleton-title mb-4"></div>
        <div class="skeleton skeleton-sm mb-5"></div>
        <div class="skeleton skeleton-text mb-2"></div>
      </div>
    `).join("");

    try {
      const { projects } = await fetch(`${API_BASE}/projects/active`).then(r => r.json());

      const tmpl = document.getElementById("projectCardTemplate").content;
      container.innerHTML = projects.length ? "" : "<p class='col-span-full text-center text-gray-500 py-10 text-lg'>No active projects</p>";

      projects.forEach(p => {
        const node = tmpl.cloneNode(true);
        node.querySelector(".name").textContent = p.name;
        node.querySelector(".type").textContent = `Deadline: ${new Date(p.deadline).toLocaleDateString()}`;

        const badge = node.querySelector(".status-badge");
        const statusText = p.progress >= 100 ? "Completed" : p.progress >= 50 ? "On Track" : p.progress >= 10 ? "Started": "No Progress";
        badge.textContent = statusText;
        badge.className += p.progress >= 100 ? " bg-green-100 text-green-700" :
                           p.progress >= 70 ? " bg-teal-100 text-teal-700" :
                           " bg-orange-100 text-orange-700";

        node.querySelector(".progress-percent").textContent = `${Math.round(p.progress)}%`;
        const bar = node.querySelector(".progress-bar");
        bar.style.width = `${p.progress}%`;
        bar.classList.add(p.progress >= 80 ? "bg-green-500" : p.progress >= 50 ? "bg-teal-500" : "bg-orange-500");

        node.querySelector(".budget-spent").textContent = `Ksh ${Number(p.spent).toLocaleString()}`;
        const remaining = p.budget - p.spent;
        const statusEl = node.querySelector(".budget-status");
        statusEl.textContent = remaining >= 0 
          ? `Ksh ${remaining.toLocaleString()} left`
          : `Over by Ksh ${Math.abs(remaining).toLocaleString()}`;
        statusEl.classList.add(remaining >= 0 ? "text-green-600" : "text-red-600");

        container.appendChild(node);
      });
    } catch (e) {
      container.innerHTML = `<p class="col-span-full text-red-600 text-center py-10 text-lg">Failed to load projects</p>`;
    }
  }

  /* 4. PROGRESS TREND CHART (real trend from backend) */
  async function renderProgressChart(period = "monthly") {
    const canvas = $("#progressChart");
    canvas.classList.add("skeleton");

    try {
      const { trend } = await fetch(`${API_BASE}/projects/progress-trend/${period}`).then(r => r.json());

      canvas.classList.remove("skeleton");

      const labels = trend.map(d => d.label);
      const data = trend.map(d => d.avg);

      if (progressChart) progressChart.destroy();

      progressChart = new Chart(canvas, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "Average Project Progress (%)",
            data,
            borderColor: "#0d9488",
            backgroundColor: "rgba(13, 148, 136, 0.1)",
            fill: true,
            tension: 0.4,
            pointBackgroundColor: "#0d9488",
            pointRadius: 5,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, max: 100, ticks: { callback: v => `${v}%` } }
          }
        }
      });
    } catch (e) {
      canvas.classList.remove("skeleton");
      canvas.parentElement.innerHTML += `<p class="text-red-600 text-center py-4">Chart failed to load</p>`;
    }
  }

  /* INITIAL LOAD */
  document.addEventListener("DOMContentLoaded", () => {
    renderStats();
    renderRecentDocs();
    renderActiveProjects();
    renderProgressChart();

    // Period buttons
    $$(".period-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        $$(".period-btn").forEach(b => {
          b.classList.remove("bg-teal-100", "text-teal-700");
          b.classList.add("bg-gray-100", "text-gray-600");
        });
        btn.classList.add("bg-teal-100", "text-teal-700");
        btn.classList.remove("bg-gray-100", "text-gray-600");
        renderProgressChart(btn.dataset.period);
      });
    });
  });

  // Auto-refresh every 2 minutes
  setInterval(() => {
    renderStats();
    renderRecentDocs();
    renderActiveProjects();
  }, 120000);
</script>