<style>
    :root { font-family: 'Plus Jakarta Sans', sans-serif; }

    .glass-panel { background: white; border: 1px solid #e2e8f0; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05); }
    .nav-card { cursor: pointer; transition: all 0.3s; border: 1px solid #d5d9de; }
    .nav-card.active { border-color: #0d9488; background: #f0fdfa; border-left: 4px solid #0d9488; }

    .status-monitor-card { background: white; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 1rem; transition: all 0.2s; }
    .status-monitor-card:hover { border-color: #0d9488; background: #fafafa; }

    .btn-whatsapp { 
        background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
        box-shadow: 0 4px 12px rgba(37, 211, 102, 0.2);
    }
    .btn-email { 
        background: #0f172a;
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.15);
    }
    
    .input-field { 
        background: #f8fafc; 
        border: 1px solid #e2e8f0; 
        transition: all 0.2s;
    }
    .input-field:focus-within { border-color: #0d9488; background: white; box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.05); }

    .memo-paper { background: #ffffff; border: 2px solid #f1f5f9; border-radius: 0.75rem; }
    .custom-scroll::-webkit-scrollbar { width: 3px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
</style>

<div class="max-w-full mx-auto">
    <div id="toastContainer" class="fixed top-5 right-5 z-[100] space-y-3"></div>
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <div class="lg:col-span-3 space-y-4">
            <div class="mb-6">
                <h1 class="text-2xl font-black text-slate-900 tracking-tighter">Communication</h1>
                <p class="text-slate-500 font-bold text-sm">Execute reminders and all Communications</p>
            </div>

            <div class="space-y-2">
                <div onclick="switchDomain('tasks', this)" class="nav-card active p-4 rounded-xl flex items-center gap-3">
                    <div class="w-8 h-8 text-slate-700 flex items-center justify-center text-xm"><i class="fas fa-list-check"></i></div>
                    <h4 class="text-xm font-bold text-slate-700">Tasks</h4>
                </div>
                <div onclick="switchDomain('bookings', this)" class="nav-card p-4 rounded-xl flex items-center gap-3">
                    <div class="w-8 h-8 text-slate-700 flex items-center justify-center text-xm"><i class="fas fa-calendar-check"></i></div>
                    <h4 class="text-xm font-bold text-slate-700">Bookings</h4>
                </div>
                <div onclick="switchDomain('expenses', this)" class="nav-card p-4 rounded-xl flex items-center gap-3">
                    <div class="w-8 h-8 text-slate-700 flex items-center justify-center text-xm"><i class="fas fa-wallet"></i></div>
                    <h4 class="text-xm font-bold text-slate-700">Expenses</h4>
                </div>
            </div>

           <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200 h-[535px] overflow-y-auto">
                <h4 class="text-xm font-black text-slate-400 uppercase mb-3">Recents</h4>
                <div id="historyList" class="space-y-2 custom-scroll flex-grow"></div>
            </div>
        </div>

        <div class="lg:col-span-4 space-y-4">
            <div id="domainStats" class="grid grid-cols-2 gap-3"></div>

            <div class="bg-white border border-slate-200 rounded-xl flex flex-col h-[750px] overflow-hidden">
                <div class="p-4 pb-2 border-b border-slate-50 flex flex-col gap-2">
                    <div class="flex justify-between items-center">
                        <span id="monitorTitle" class="text-xm font-black uppercase tracking-widest text-slate-800">Feed</span>
                        <span id="itemCount" class="text-[10px] font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full">0 items</span>
                    </div>
                    <div class="relative mt-1">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-[12px]"></i>
                        <input type="text" id="monitorSearch" oninput="updateUI()" placeholder="Search feed..." 
                            class="w-full pl-8 pr-4 py-1.5 bg-slate-100 border border-slate-100 rounded-lg text-[12px] font-bold text-slate-700 outline-none focus:border-teal-500 focus:bg-white transition-all">
                    </div>
                </div>

                <div id="monitorList" class="p-4 space-y-3 overflow-y-auto custom-scroll flex-grow"></div>
            </div>
        </div>

        <div class="lg:col-span-5 flex flex-col gap-4">
            <div class="glass-panel rounded-xl p-6 flex flex-col h-full border-t-4 border-t-teal-500">
                
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="input-field flex items-center px-3 py-2 rounded-xl">
                        <i class="fas fa-at text-teal-400 text-xm mr-2"></i>
                        <div class="flex-grow">
                            <p class="text-[10px] font-black text-slate-400 uppercase">Recip. Email</p>
                            <input type="email" id="targetEmail" class="w-full bg-transparent border-none outline-none text-xm font-bold text-slate-700" placeholder="cto@company.com">
                        </div>
                    </div>
                    <div class="input-field flex items-center px-3 py-2 rounded-xl">
                        <i class="fab fa-whatsapp text-teal-400 text-xm mr-2"></i>
                        <div class="flex-grow">
                            <p class="text-[10px] font-black text-slate-400 uppercase">Recip. Phone</p>
                            <input type="text" id="targetPhone" class="w-full bg-transparent border-none outline-none text-xm font-bold text-slate-700" placeholder="254700000000">
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-end mb-4">
                    <div class="flex-grow mr-4 border-b border-slate-100">
                        <p class="text-xm font-black text-slate-400 uppercase">Subject</p>
                        <input type="text" id="msgSubject" class="text-sm font-bold text-slate-800 bg-transparent border-none outline-none w-full py-1" value="Executive Info">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="generateOutline()" class="text-[10px] font-black text-white bg-slate-800 px-4 py-2 rounded-xl hover:bg-slate-700 shadow-md transition-all">
                            <i class="fas fa-magic mr-2"></i>AUTO-DRAFT
                        </button>                        
                        <button onclick="generatePDF()" class="text-[10px] font-black text-white bg-rose-600 px-4 py-2 rounded-xl hover:bg-rose-500 shadow-md shadow-rose-900/20 transition-all">
                            <i class="fas fa-file-pdf mr-2"></i>PDF REPORT
                        </button>
                    </div>
                </div>

                <div class="flex-grow memo-paper p-5 mb-4 relative">
                    <div class="absolute top-3 right-3 group z-10">
                        <button onclick="copyToClipboard()" id="copyBtn" class="w-8 h-8 flex items-center justify-center rounded-lg  bg-slate-50 text-slate-400 hover:text-teal-600 hover:bg-teal-50 border border-slate-100 hover:border-teal-200 transition-all shadow-sm">
                            <i class="fas fa-copy"></i>
                        </button>
                        <span class="absolute -bottom-8 left-1/2 -translate-x-1/2 whitespace-nowrap bg-slate-900 text-white text-[10px] px-2 py-1 rounded-md opacity-0 group-hover:opacity-100 transition pointer-events-none">
                            Copy body content to clipboard
                        </span>
                    </div>
                    <textarea id="msgBody" 
                        placeholder="Click '+' on data points to build your report..."
                        class="w-full h-full bg-transparent border-none text-slate-700 font-medium text-xm leading-relaxed outline-none resize-none custom-scroll"></textarea>
                </div>

                <div class="flex gap-4">
                    <button id="btnEmail" onclick="handleSend('email')" class="btn-email flex-1 flex items-center justify-center gap-3 py-4 rounded-xl text-white text-[11px] font-black uppercase tracking-widest transition-all hover:scale-[1.02] active:scale-95">
                        <i id="spinnerEmail" class="fas fa-circle-notch fa-spin hidden"></i>
                        <i id="iconEmail" class="fas fa-envelope-open-text text-lg"></i>
                        Dispatch Email
                    </button>

                    <button id="btnCEO" onclick="handleSend('ceo')" class="flex-1 bg-teal-600 flex items-center justify-center gap-3 py-4 rounded-xl text-white text-[11px] font-black uppercase tracking-widest transition-all hover:bg-teal-500 hover:scale-[1.02] active:scale-95 shadow-lg shadow-teal-900/10">
                        <i id="spinnerCEO" class="fas fa-circle-notch fa-spin hidden"></i>
                        <i id="iconCEO" class="fas fa-paper-plane text-lg"></i>
                        Send to CEO Inbox
                    </button>

                    <button id="btnSMS" onclick="handleSend('sms')" class="btn-email flex-1 flex items-center justify-center gap-3 py-4 rounded-xl text-white text-[11px] font-black uppercase tracking-widest transition-all hover:scale-[1.02] active:scale-95">
                        <i id="spinnerSMS" class="fas fa-circle-notch fa-spin hidden"></i>
                        <i id="iconSMS" class="fas fa-comment-sms text-lg"></i>
                        Dispatch SMS
                    </button>
                </div>
                <button onclick="document.getElementById('msgBody').value = ''" class="mt-4 text-[9px] font-bold text-slate-500 hover:text-rose-500 uppercase tracking-widest transition-colors">
                    <i class="fas fa-trash-alt mr-2"></i> Reset Workspace
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const $ = id => document.getElementById(id);
    let activeDomain = 'tasks';
    let allData = {
        tasks: [],
        bookings: [],
        expenses: []
    };

    async function loadBackendData() {
        try {
            const res = await fetch('/api/hr/planner');
            const data = await res.json();
            
            allData.tasks = data.filter(item => item.source === 'task');
            allData.bookings = data.filter(item => item.source === 'booking');
            allData.expenses = data.filter(item => item.source === 'expense');

            updateUI();
        } catch (e) {
            showToast("ERROR", "Failed to sync with database.");
        }
    }

    function switchDomain(domain, el) {
        activeDomain = domain;
        document.querySelectorAll('.nav-card').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        updateUI();
    }

    function updateUI() {
        const query = $('monitorSearch').value.toLowerCase();
        const filteredItems = allData[activeDomain].filter(item => {
            const description = item.item_desc ? item.item_desc.toLowerCase() : '';
            const type = item.type ? item.type.toLowerCase() : '';
            const status = item.status ? item.status.toLowerCase() : '';
            
            return description.includes(query) || 
                type.includes(query) ||
                status.includes(query);
        });

        const titleMap = { tasks: "Tasks Feed", bookings: "Client Bookings", expenses: "Expenditure Review" };
        $('monitorTitle').innerText = titleMap[activeDomain];
        $('itemCount').innerText = `${filteredItems.length} items`;
        
        renderStats(allData[activeDomain]);
        renderMonitor(filteredItems);
    }

    function renderStats(items) {
        const container = $('domainStats');
        const pending = items.filter(i => i.status === 'pending').length;
        const completed = items.filter(i => i.status === 'completed').length;
        const total = items.length;
        const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;

        const stats = [
            { label: "Active", val: pending, color: "rose" },
            { label: "Success Rate", val: completionRate + "%", color: "teal" }
        ];

        container.innerHTML = stats.map(s => `
            <div onclick="injectText('${s.label}: ${s.val}')" class="bg-white p-4 rounded-2xl border border-slate-200 cursor-pointer hover:shadow-md transition-all">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">${s.label}</p>
                <div class="flex items-center justify-between">
                    <span class="text-sm font-black text-${s.color}-600">${s.val}</span>
                    <i class="fas fa-plus text-[8px] text-slate-200"></i>
                </div>
            </div>
        `).join('');
    }

    function renderMonitor(items) {
        const list = $('monitorList');
        if (items.length === 0) {
            list.innerHTML = `
                <div class="flex flex-col items-center justify-center py-20 text-slate-400">
                    <i class="fas fa-search mb-2 text-xl opacity-20"></i>
                    <p class="text-xs italic">No matching records found</p>
                </div>`;
            return;
        }

        list.innerHTML = items.map((item, index) => {
            const colorMap = { pending: 'rose', completed: 'teal', suspended: 'slate' };
            const color = colorMap[item.status] || 'slate';

            const originalIndex = allData[activeDomain].findIndex(i => i.id === item.id);
            
            return `
                <div class="status-monitor-card shadow-sm border-l-4 border-l-${color}-500 animate-fade-up">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="text-[16px] text-slate-700">${item.item_desc}</h4>
                            <span class="text-[11px] font-black bg-${color}-50 text-${color}-600 px-2 py-0.5 rounded uppercase tracking-tighter">
                                ${item.status} | ${item.type}
                            </span>
                        </div>
                        <div class="relative group"> 
                            <button onclick="injectItem(${originalIndex})" class="w-7 h-7 rounded-lg bg-slate-900 text-white hover:bg-teal-500 transition-all text-[10px]">
                                <i class="fas fa-plus"></i>
                            </button>
                            <span class="absolute top-1/2 right-full mr-2 -translate-y-1/2
                                whitespace-nowrap bg-slate-900 text-white text-[10px]
                                px-2 py-1 rounded-md opacity-0
                                group-hover:opacity-100 transition
                                pointer-events-none z-50

                                after:content-[''] after:absolute after:top-1/2 after:left-full
                                after:-translate-y-1/2
                                after:border-4 after:border-transparent
                                after:border-l-slate-900">
                                Add data to form body
                            </span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mt-2">
                        <p class="text-[10px] text-slate-500 font-bold">
                            <i class="far fa-calendar-alt mr-1"></i> ${new Date(item.event_date).toLocaleDateString()}
                        </p>
                        <p class="text-[10px] text-slate-400 font-medium">Duration: ${item.duration}</p>
                    </div>
                </div>
            `;
        }).join('');
    }

    function injectText(text) {
        const textArea = $('msgBody');
        textArea.value += (textArea.value ? "\n" : "") + "• " + text;
    }

    function injectItem(index) {
        const item = allData[activeDomain][index];
        if (!item) return;
        const statusNote = item.status === 'pending' ? ' (ACTION REQUIRED)' : ` (${item.status.toUpperCase()})`;
        injectText(`${item.item_desc}${statusNote}`);
    }

    function generateOutline() {
        const textArea = $('msgBody');
        const now = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
        
        let outline = `DAILY OPS BRIEF - ${now}\n`;
        
        const items = allData[activeDomain];
        const pending = items.filter(i => i.status === 'pending').length;
        outline += `STATUS: ${pending} PENDING ${activeDomain.toUpperCase()}\n\n`;
        
        textArea.value = outline + textArea.value;
    }

    function setBtnLoading(method, isLoading) {
        const btnMap = { 
            email: $('btnEmail'), 
            whatsapp: $('btnWhatsapp'), 
            ceo: $('btnCEO') 
        };
        const spinnerMap = { 
            email: $('spinnerEmail'), 
            whatsapp: $('spinnerWhatsapp'), 
            ceo: $('spinnerCEO') 
        };
        const iconMap = { 
            email: $('iconEmail'), 
            whatsapp: $('iconWhatsapp'), 
            ceo: $('iconCEO') 
        };

        const btn = btnMap[method];
        const spinner = spinnerMap[method];
        const icon = iconMap[method];

        if (!btn || !spinner || !icon) return;

        if (isLoading) {
            btn.classList.add('opacity-80', 'pointer-events-none');
            spinner.classList.remove('hidden');
            icon.classList.add('hidden');
        } else {
            btn.classList.remove('opacity-80', 'pointer-events-none');
            spinner.classList.add('hidden');
            icon.classList.remove('hidden');
        }
    }

    async function handleSend(method) {
        const subject = $('msgSubject').value;
        const body = $('msgBody').value;
        const email = $('targetEmail').value;
        const phone = $('targetPhone').value;

        if(!body.trim()) {
            showToast("WARNING", "Please add content to the workspace.");
            return;
        }

        setBtnLoading(method, true);

        try {           
            if(method === 'ceo') {
                const response = await fetch('/api/hr/dispatch/reply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message_content: `[${subject}] ${body}`,
                        priority: 'high' 
                    })
                });

                if(response.ok) {
                    showToast("SUCCESS", "Briefing reply sent.");
                    await saveToHistory(subject, 'CEO FEED');
                    $('msgBody').value = '';
                } else {
                    throw new Error("An error occured. Try again.");
                }
            } 
            else if(method === 'email') {
                if(!email) {
                    showToast("ERROR", "Recipient email is required");
                    return;
                }

                const response = await fetch('/api/hr/dispatch/mail', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recipient: email, subject, body })
                });

                if(response.ok) {
                    showToast("SUCCESS", "Email dispatched successfully");
                    await saveToHistory(subject, 'EMAIL');
                } else {
                    throw new Error("An error occured. Try again.");
                }
            } else if(method === 'sms') {
                const phone = $('targetPhone').value;
                if(!phone) {
                    showToast("WARNING", "Recipient phone number is required");
                    return;
                }

                const subject = $('msgSubject').value;
                const body = $('msgBody').value;
                const fullMessage = `*${subject}*\n\n${body}`;

                try {
                    const response = await fetch('/api/hr/dispatch/sms', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            phone: phone,
                            message: fullMessage 
                        })
                    });

                    const result = await response.json();
                    
                    if(response.ok) {
                        showToast("SUCCESS", "SMS dispatched successfully");
                        await saveToHistory(subject, 'SMS');
                    } else {
                        throw new Error(result.error || "Failed to send SMS");
                    }
                } catch (e) {
                    showToast("ERROR", e.message || "Failed to send SMS");
                }
            }
        } catch (e) {
            showToast("ERROR", "An error occured. Try again.");
        } finally {
            setBtnLoading(method, false);
        }
    }

    async function saveToHistory(subject, method) {
        const methodMap = {
            'CEO FEED': 'ceo',
            'EMAIL': 'email',
            'SMS': 'sms'
        };

        let recipientStr = '';
        if (method === 'CEO FEED') {
            recipientStr = 'CEO Office';
        } else if (method === 'EMAIL') {
            recipientStr = $('targetEmail').value || 'Unknown';
        } else {
            recipientStr = $('targetPhone').value || 'Unknown';
        }

        const logData = {
            subject: subject,
            recipient: recipientStr,
            method: methodMap[method] || 'email',
            body: $('msgBody').value
        };

        try {
            const response = await fetch('/api/hr/logs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(logData)
            });
            
            if(!response.ok) {
                const err = await response.json();
                throw new Error(err.error || "Log failed");
            }
            
            renderHistory();
        } catch (e) {
            console.error("History Log Error:", e.message);
            showToast("ERROR", "Logging failed: " + e.message);
        }
    }

    async function renderHistory() {
        try {
            const res = await fetch('/api/hr/logs');
            const history = await res.json();
            
            const list = $('historyList');
            list.innerHTML = history.map(h => {
                    const icons = {
                        ceo: '<i class="fas fa-shield-halved text-amber-500 mr-2"></i>',
                        email: '<i class="fas fa-envelope text-blue-500 mr-2"></i>',
                        sms: '<i class="fas fa-comment-sms text-emerald-500 mr-2"></i>'
                    };
                    return `
                    <div class="group flex items-center justify-between p-2.5 bg-white rounded-xl border border-slate-100 text-[11px] font-bold shadow-sm transition-all hover:border-teal-200">
                        <div class="flex items-center truncate">
                            ${icons[h.method] || icons.email}
                            <div class="flex flex-col truncate">
                                <span class="truncate w-32 text-slate-600">${h.subject}</span>
                                <span class="text-[9px] text-slate-400 font-medium">${h.method.toUpperCase()} to ${h.recipient}</span>
                            </div>                            
                        </div>
                        <div class="flex items-center gap-2">
                                <span class="text-teal-500 bg-teal-50 px-2 py-0.5 rounded-lg text-[8px]">
                                    ${new Date(h.sent_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                </span>
                                <div class="relative group"> 
                                    <button onclick="deleteLog(${h.id})" class="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-rose-500 transition-opacity">
                                        <i class="fas fa-times text-sm"></i>
                                    </button>
                                    <span class="absolute top-1/2 right-full mr-2 -translate-y-1/2
                                        whitespace-nowrap bg-slate-900 text-white text-[10px]
                                        px-2 py-1 rounded-md opacity-0
                                        group-hover:opacity-100 transition
                                        pointer-events-none z-50
                                        after:content-[''] after:absolute after:top-1/2 after:left-full
                                        after:-translate-y-1/2
                                        after:border-4 after:border-transparent
                                        after:border-l-slate-900">
                                        Delete log
                                    </span>
                                </div>                        
                            </div>
                    </div>
                `;
            }).join('') || '<p class="text-[10px] text-slate-400 italic text-center py-4">No recent activity</p>';
        } catch (e) {
            console.error("History fetch failed", e);
        }
    }

    async function deleteLog(id) {
        if(!confirm("Remove this log from history?")) return;
        try {
            await fetch(`/api/hr/logs/${id}`, { method: 'DELETE' });
            showToast("ERROR", "Log deleted successfully.");
            renderHistory();
        } catch (e) {
            showToast("ERROR", "Delete failed.");
        }
    }

    function copyToClipboard() {
        const textArea = $('msgBody');
        if (!textArea.value.trim()) return showToast("WARNING", "Workspace empty.");
        
        navigator.clipboard.writeText(textArea.value).then(() => {
            showToast("SUCCESS", "Copied to clipboard!");
        });
    }

    function showToast(title, msg) {
        const toast = document.createElement('div');
        toast.className = "bg-slate-900 text-white p-4 rounded-xl shadow-xl min-w-[200px] animate-fade-up";
        toast.innerHTML = `<h5 class="text-[10px] font-black uppercase text-teal-400 mb-1">${title}</h5><p class="text-xs font-medium">${msg}</p>`;
        $('toastContainer').appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    async function getCurrentUserName() {
        try {
            const response = await fetch("/api/profile", {
                method: "GET",
                credentials: "include"
            });

            if (!response.ok) throw new Error("Failed to fetch profile");

            const data = await response.json();
            return data.profile?.name || "Unknown User";
        } catch (err) {
            console.error("Error fetching user:", err);
            return "Unknown User";
        }
    }

    async function generatePDF() {
        if (!window.jspdf) {
            showToast("ERROR", "PDF Library not loaded.");
            return;
        }

        const userName = await getCurrentUserName();
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const subject = $('msgSubject').value || 'Executive Report';
        const rawBody = $('msgBody').value;
        const dateStr = new Date().toLocaleDateString('en-GB', { 
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
        });
        const timeStr = new Date().toLocaleTimeString('en-GB', { 
            hour: '2-digit', minute: '2-digit' 
        });
        
        if(!rawBody.trim()) {
            showToast("WARNING", "Workspace is empty. Nothing to print.");
            return;
        }

        // Parse and structure the content
        const lines = rawBody.split('\n').filter(line => line.trim());
        const structuredData = parseContent(lines);
        
        const margin = 20;
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const contentWidth = pageWidth - (margin * 2);
        let yPos = margin;

        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0); 
        doc.text("TASK, EXPENSES, BOOKINGS REPORT", pageWidth / 2, yPos, { align: 'center' });
        
        yPos += 8;
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        doc.setTextColor(60, 60, 60);
        doc.text("HR ASSISTANT", pageWidth / 2, yPos, { align: 'center' });
        
        yPos += 15;
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(18);
        doc.setTextColor(0, 0, 0);
        const titleWidth = doc.getTextWidth(subject);
        const titleX = (pageWidth - titleWidth) / 2;
        doc.text(subject, titleX, yPos);
        
        yPos += 10;
        
        doc.setDrawColor(200, 200, 200);
        doc.setFillColor(255, 255, 255);
        doc.rect(margin, yPos, pageWidth - margin * 2, 25, 'F');
        doc.rect(margin, yPos, pageWidth - margin * 2, 25);
        
        const metaY = yPos + 8;
        doc.setFontSize(9);
        doc.setTextColor(0, 0, 0);

        let xPos = margin + 2;

        doc.setFont("helvetica", "bold");
        doc.text("Date:", xPos, metaY);
        doc.setFont("helvetica", "normal");

        let displayDate = dateStr;
        const maxDateWidth = 55;
        if (doc.getTextWidth(dateStr) > maxDateWidth) {
            displayDate = new Date().toLocaleDateString('en-GB', { 
                day: 'numeric', month: 'short', year: 'numeric' 
            });
        }
        doc.text(displayDate, xPos + doc.getTextWidth("Date: ") + 2, metaY);

        xPos += doc.getTextWidth("Date: " + displayDate) + 15;

        doc.setFont("helvetica", "bold");
        doc.text("Time:", xPos, metaY);
        doc.setFont("helvetica", "normal");
        doc.text(timeStr, xPos + doc.getTextWidth("Time: ") + 2, metaY);

        xPos += doc.getTextWidth("Time: " + timeStr) + 15;

        doc.setFont("helvetica", "bold");
        doc.text("Prepared By:", xPos, metaY);
        doc.setFont("helvetica", "normal");
        doc.text(userName, xPos + doc.getTextWidth("Prepared By: ") + 2, metaY);
        
        if (structuredData.statusSummary) {
            doc.setFont("helvetica", "bold");
            doc.text("Status Summary:", margin + 5, metaY + 10);
            doc.setFont("helvetica", "normal");
            const statusText = doc.splitTextToSize(structuredData.statusSummary, contentWidth - 35);
            doc.text(statusText[0], margin + 35, metaY + 10);
        }
        
        yPos += 35;
        
        if (structuredData.executiveSummary) {
            doc.setFont("helvetica", "bold");
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            doc.text("EXECUTIVE SUMMARY", margin, yPos);
            
            yPos += 8;
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            doc.line(margin, yPos, pageWidth - margin, yPos);
            
            yPos += 12;
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            
            const summaryText = doc.splitTextToSize(structuredData.executiveSummary, contentWidth);
            summaryText.forEach(line => {
                if (yPos + 6 > pageHeight - margin) {
                    doc.addPage();
                    yPos = margin;
                }
                doc.text(line, margin, yPos);
                yPos += 6;
            });
            
            yPos += 10;
        }
        
        if (structuredData.tasks && structuredData.tasks.length > 0) {
            doc.setFont("helvetica", "bold");
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            doc.text("TASKS & ACTIVITIES OVERVIEW", margin, yPos);
            
            yPos += 8;
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            doc.line(margin, yPos, pageWidth - margin, yPos);
            
            yPos += 12;
            
            // Task status counts - single line with proper spacing
            if (structuredData.taskStats) {
                doc.setFont("helvetica", "bold");
                doc.setFontSize(9);
                doc.setTextColor(0, 0, 0);
                doc.text("Task Status Distribution:", margin, yPos);
                
                yPos += 6;
                doc.setFont("helvetica", "normal");
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                
                let xPos = margin;
                Object.entries(structuredData.taskStats).forEach(([status, count], index) => {
                    const text = `${status.toUpperCase()}: ${count}`;
                    const textWidth = doc.getTextWidth(text);
                    
                    // Check if it fits on current line
                    if (xPos + textWidth + 10 > pageWidth - margin) {
                        yPos += 5;
                        xPos = margin;
                    }
                    
                    doc.text(text, xPos, yPos);
                    xPos += textWidth + 15; // Add spacing between items
                });
                
                yPos += 10;
            }
            
            // Individual tasks
            doc.setFont("helvetica", "bold");
            doc.setFontSize(9);
            doc.setTextColor(0, 0, 0);
            doc.text("DETAILED TASK BREAKDOWN:", margin, yPos);
            yPos += 4;
            
            structuredData.tasks.forEach((task, index) => {
                if (yPos + 20 > pageHeight - margin) {
                    doc.addPage();
                    yPos = margin;
                }
                
                // Task number
                doc.setFont("helvetica", "bold");
                doc.setFontSize(9);
                doc.setTextColor(0, 0, 0);
                doc.text(`${index + 1}.`, margin + 5, yPos + 12);
                
                // Task description - truncated to fit
                doc.setFont("helvetica", "normal");
                doc.setFontSize(9);
                doc.setTextColor(0, 0, 0);
                
                const availableWidth = contentWidth - 80;
                let taskDesc = task.description;
                
                if (doc.getTextWidth(taskDesc) > availableWidth) {
                    taskDesc = doc.splitTextToSize(taskDesc, availableWidth)[0];
                    if (taskDesc.length > 3) {
                        taskDesc = taskDesc.substring(0, taskDesc.length - 3) + "...";
                    }
                }
                
                doc.text(taskDesc, margin + 15, yPos + 12);
                
                // Status - simple text
                const statusText = task.status.toUpperCase();
                const statusWidth = doc.getTextWidth(statusText);
                const statusX = pageWidth - margin - statusWidth - 5;
                
                doc.setFont("helvetica", "bold");
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                doc.text(statusText, statusX, yPos + 12);
                
                yPos += 16;
            });

            yPos += 8;
        }
        
        if (structuredData.observations && structuredData.observations.length > 0) {
            doc.setFont("helvetica", "bold");
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            doc.text("KEY OBSERVATIONS & NOTICES", margin, yPos);
            
            yPos += 8;
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            doc.line(margin, yPos, pageWidth - margin, yPos);

            yPos += 12;

            structuredData.observations.forEach((obs, index) => {
                if (yPos + 15 > pageHeight - margin) {
                    doc.addPage();
                    yPos = margin;
                }

                const numberedObs = `${index + 1}. ${obs}`;

                doc.setFont("helvetica", "normal");
                doc.setFontSize(9);
                doc.setTextColor(0, 0, 0);

                const obsText = doc.splitTextToSize(numberedObs, contentWidth - 10);

                doc.text(obsText, margin + 2, yPos);
                yPos += obsText.length * 6 + 4; 
            });

            yPos += 5;
        }
        
        if (structuredData.recommendations && structuredData.recommendations.length > 0) {
            doc.setFont("helvetica", "bold");
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            doc.text("PENDING ACTIONS/TASKS", margin, yPos);
            
            yPos += 8;
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            doc.line(margin, yPos, pageWidth - margin, yPos);
            
            yPos += 12;
            
            structuredData.recommendations.forEach((rec, index) => {
                if (yPos + 15 > pageHeight - margin) {
                    doc.addPage();
                    yPos = margin;
                }
                
                // Numbered recommendation
                doc.setFont("helvetica", "bold");
                doc.setFontSize(9);
                doc.setTextColor(0, 0, 0);
                doc.text(`${index + 1}.`, margin, yPos);
                
                // Recommendation text
                doc.setFont("helvetica", "normal");
                doc.setFontSize(9);
                doc.setTextColor(0, 0, 0);
                
                const recText = doc.splitTextToSize(` ${rec}`, contentWidth - 10);
                doc.text(recText, margin + 10, yPos);
                yPos += recText.length * 6;
                
                yPos += 6;
            });
        }
        
        // Add page if needed
        if (yPos + 40 > pageHeight - margin) {
            doc.addPage();
            yPos = margin;
        } else {
            yPos += 20;
        }
        
        // Signature line
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(0.5);
        doc.line(margin, yPos, margin + 80, yPos);
        
        yPos += 6;
        doc.setFont("helvetica", "bold");
        doc.setFontSize(9);
        doc.setTextColor(0, 0, 0);
        doc.text("HR Assistant", margin, yPos);
        
        // Page number on all pages
        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            doc.setFont("helvetica", "normal");
            doc.setFontSize(8);
            doc.setTextColor(60, 60, 60);
            doc.text(`Page ${i} of ${totalPages}`, pageWidth - margin - 20, pageHeight - 10);
            doc.text(`Generated: ${displayDate || dateStr} ${timeStr}`, margin, pageHeight - 10);
        }
        
        // Save the PDF
        const safeFilename = subject.toLowerCase().replace(/[^a-z0-9]/g, '_') + '_report';
        doc.save(`${safeFilename}.pdf`);
        showToast("SUCCESS", "Professional report generated successfully.");
    }

    // Helper function to parse and structure content
    function parseContent(lines) {
        const result = {
            executiveSummary: '',
            tasks: [],
            observations: [],
            recommendations: [],
            taskStats: {},
            statusSummary: ''
        };
        
        lines.forEach(line => {
            const trimmed = line.trim();
            
            // Check for executive summary
            if (trimmed.includes('DAILY OPS BRIEF') || trimmed.includes('STATUS:')) {
                result.executiveSummary = trimmed;
                return;
            }
            
            // Check for status summary
            if (trimmed.includes('PENDING') && trimmed.includes('TASKS')) {
                result.statusSummary = trimmed;
                return;
            }
            
            // Parse bullet points
            if (trimmed.startsWith('•')) {
                const content = trimmed.substring(1).trim();
                
                // Determine if it's a task, observation, or recommendation
                if (content.includes('(ACTION REQUIRED)')) {
                    result.recommendations.push(content.replace('(ACTION REQUIRED)', '').trim());
                    result.tasks.push({
                        description: content.replace('(ACTION REQUIRED)', '').trim(),
                        status: 'pending'
                    });
                } else if (content.includes('(COMPLETED)')) {
                    result.tasks.push({
                        description: content.replace('(COMPLETED)', '').trim(),
                        status: 'completed'
                    });
                } else if (content.includes('(SUSPENDED)')) {
                    result.tasks.push({
                        description: content.replace('(SUSPENDED)', '').trim(),
                        status: 'suspended'
                    });
                    result.observations.push(content.replace('(SUSPENDED)', '').trim());
                } else {
                    result.observations.push(content);
                }
            }
        });
        
        // Calculate task statistics
        const stats = {};
        result.tasks.forEach(task => {
            stats[task.status] = (stats[task.status] || 0) + 1;
        });
        result.taskStats = stats;
        
        return result;
    }
    renderHistory();
    loadBackendData();
</script>