<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    :root {
        --primary-teal: #0d9488;
        --secondary-slate: #1e293b;
    }
    
    .profile-gradient {
        background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%);
    }

    .form-input {
        transition: all 0.2s ease;
        border: 1.5px solid #e2e8f0;
    }

    .form-input:focus {
        border-color: var(--primary-teal);
        box-shadow: 0 0 0 4px rgba(13, 148, 136, 0.1);
        outline: none;
    }

    .tab-active {
        color: var(--primary-teal);
        border-bottom: 3px solid var(--primary-teal);
    }

    .glass-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
    }
</style>

<div class="max-w-full mx-auto">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <div class="lg:col-span-4 space-y-6">
            <div class="bg-white rounded-lg shadow-xl shadow-slate-200/50 overflow-hidden border border-slate-100">
                <div class="h-32 profile-gradient relative">
                    <div class="absolute -bottom-12 left-1/2 -translate-x-1/2">
                        <div class="relative group">
                            <div id="profileImageContainer" class="w-32 h-32 rounded-3xl bg-white p-1 shadow-2xl overflow-hidden rotate-3 transition-transform group-hover:rotate-0">
                                <img id="profileImage" src="" class="w-full h-full object-cover rounded-2xl hidden border border-slate-50">
                                <div id="defaultProfileIcon" class="w-full h-full rounded-2xl bg-slate-100 flex items-center justify-center">
                                    <i class="fa-solid fa-user-tie text-4xl text-slate-400"></i>
                                </div>
                            </div>
                            <button onclick="triggerFileInput()" class="absolute bottom-0 right-0 bg-white text-teal-600 p-2.5 rounded-xl shadow-lg border border-teal-50 hover:bg-teal-600 hover:text-white transition-all transform hover:scale-110">
                                <i class="fa-solid fa-camera text-sm"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="pt-16 pb-8 px-8 text-center">
                    <h2 id="displayName" class="text-2xl font-extrabold text-slate-800 tracking-tight">Loading...</h2>
                    <p id="displayTitle" class="text-teal-600 font-semibold text-sm uppercase tracking-wider mt-1">Loading...</p>
                    
                    <div class="flex items-center justify-center mt-4 space-x-2 text-slate-500 text-sm">
                        <i class="fa-solid fa-location-dot"></i>
                        <span id="displayLocation">Loading...</span>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mt-8">
                        <button class="flex items-center justify-center gap-2 py-3 bg-slate-800 text-white rounded-2xl text-xs font-bold hover:bg-slate-900 transition-all shadow-lg shadow-slate-200">
                            <i class="fa-solid fa-paper-plane"></i> Message
                        </button>
                        <button class="flex items-center justify-center gap-2 py-3 bg-teal-50 text-teal-700 rounded-2xl text-xs font-bold hover:bg-teal-100 transition-all border border-teal-100">
                            <i class="fa-solid fa-address-book"></i> Directory
                        </button>
                    </div>

                    <div class="mt-10 border-t border-slate-50 pt-6">
                        <nav class="flex space-x-4">
                            <button onclick="showTab('about')" id="aboutTab" class="flex-1 pb-3 text-sm font-bold border-b-2 border-teal-600 text-teal-600 transition-all">
                                <i class="fa-solid fa-id-card mr-2"></i> About
                            </button>
                            <button onclick="showTab('timeline')" id="timelineTab" class="flex-1 pb-3 text-sm font-bold border-b-2 border-transparent text-slate-400 hover:text-slate-600 transition-all">
                                <i class="fa-solid fa-clock-rotate-left mr-2"></i> Activity
                            </button>
                        </nav>
                    </div>

                    <div id="aboutContent" class="mt-6 text-left space-y-5">
                        <div class="group">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Electronic Mail</p>
                            <p id="displayEmail" class="text-sm font-bold text-slate-700 break-words">Loading...</p>
                        </div>
                        <div class="group">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Direct Line</p>
                            <p id="displayPhone" class="text-sm font-bold text-slate-700">Loading...</p>
                        </div>
                        <div class="group">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Workplace Hub</p>
                            <p id="displayAddress" class="text-sm font-medium text-slate-600 leading-relaxed italic">Loading...</p>
                        </div>
                    </div>

                    <div id="timelineContent" class="mt-6 text-center py-10 hidden bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200">
                        <i class="fa-solid fa-hourglass-start text-slate-300 text-3xl mb-3"></i>
                        <p class="text-xs text-slate-400 font-bold uppercase tracking-widest">No Recent Logs</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-8">
            <div class="bg-white rounded-lg shadow-xl shadow-slate-200/50 p-8 border border-slate-100">
                <div class="flex items-center justify-between mb-10">
                    <div>
                        <h3 class="text-2xl font-black text-slate-800 tracking-tight">Profile Settings</h3>
                        <p class="text-slate-400 text-sm font-medium">Manage your identity and security protocols.</p>
                    </div>
                    <div class="bg-teal-50 p-3 rounded-lg">
                        <i class="fa-solid fa-user-gear text-teal-600 text-xl"></i>
                    </div>
                </div>

                <div class="space-y-10">
                    <section>
                        <h4 class="flex items-center text-xs font-black text-slate-400 uppercase tracking-[0.2em] mb-6">
                            <span class="bg-slate-100 w-8 h-[2px] mr-3"></span>
                            General Information
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-slate-700 ml-1">Legal Full Name</label>
                                <input id="adminName" type="text" class="w-full p-4 form-input rounded-2xl text-sm font-semibold text-slate-700 bg-slate-50/50" placeholder="John Doe">
                            </div>
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-slate-700 ml-1">Official Designation</label>
                                <input id="adminTitle" type="text" class="w-full p-4 form-input rounded-2xl text-sm font-semibold text-slate-700 bg-slate-50/50" placeholder="Lead Developer">
                            </div>
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-slate-700 ml-1">Email Connection</label>
                                <input id="adminEmail" type="email" class="w-full p-4 form-input rounded-2xl text-sm font-semibold text-slate-700 bg-slate-50/50" placeholder="john@company.com">
                            </div>
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-slate-700 ml-1">Phone Protocol</label>
                                <input id="adminPhone" type="tel" class="w-full p-4 form-input rounded-2xl text-sm font-semibold text-slate-700 bg-slate-50/50" placeholder="+1 234 567 890">
                            </div>
                        </div>
                    </section>

                    <section>
                        <h4 class="flex items-center text-xs font-black text-slate-400 uppercase tracking-[0.2em] mb-6">
                            <span class="bg-slate-100 w-8 h-[2px] mr-3"></span>
                            Bio-Metrics & Location
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-slate-700 ml-1">Primary Base</label>
                                <input id="adminLocation" type="text" class="w-full p-4 form-input rounded-2xl text-sm font-semibold text-slate-700 bg-slate-50/50" placeholder="Nairobi, KE">
                            </div>
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-slate-700 ml-1">Birth Date</label>
                                <input id="adminBirthday" type="text" class="w-full p-4 form-input rounded-2xl text-sm font-semibold text-slate-700 bg-slate-50/50" placeholder="DD/MM/YYYY">
                            </div>
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-slate-700 ml-1">Gender Identity</label>
                                <select id="adminGender" class="w-full p-4 form-input rounded-2xl text-sm font-semibold text-slate-700 bg-slate-50/50 appearance-none">
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                    <option value="Prefer not to say">Prefer not to say</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-6 space-y-2">
                            <label class="text-xs font-bold text-slate-700 ml-1">Physical Mailing Address</label>
                            <textarea id="adminAddress" rows="3" class="w-full p-4 form-input rounded-2xl text-sm font-semibold text-slate-700 bg-slate-50/50" placeholder="Enter full address..."></textarea>
                        </div>
                    </section>

                    <section class="p-8 bg-slate-100 rounded-lg border border-rose-100">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center text-rose-500 shadow-sm">
                                <i class="fa-solid fa-shield-halved"></i>
                            </div>
                            <h4 class="text-sm font-black text-rose-900 uppercase tracking-widest">Security Credentials</h4>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input id="currentPassword" type="password" class="p-3 form-input rounded-xl text-sm font-bold bg-white" placeholder="Current Password">
                            <input id="newPassword" type="password" class="p-3 form-input rounded-xl text-sm font-bold bg-white" placeholder="New Password">
                            <input id="confirmNewPassword" type="password" class="p-3 form-input rounded-xl text-sm font-bold bg-white" placeholder="Confirm New">
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button onclick="resetPassword()" class="px-6 py-2.5 bg-rose-600 text-white rounded-xl text-xs font-black uppercase tracking-widest hover:bg-rose-700 transition-all shadow-lg shadow-rose-200">
                                Update Password
                            </button>
                        </div>
                    </section>

                    <div class="pt-6 flex flex-col md:flex-row items-center justify-end gap-4 border-t border-slate-100">
                        <button onclick="cancelEdit()" class="w-full md:w-auto px-8 py-3 text-sm font-bold text-slate-400 hover:text-slate-600 transition-all">
                            Discard Changes
                        </button>
                        <button onclick="saveProfile()" class="w-full md:w-auto flex items-center justify-center gap-3 px-10 py-4 bg-teal-600 text-white rounded-2xl text-sm font-black uppercase tracking-[0.15em] hover:bg-teal-700 transition-all shadow-xl shadow-teal-100">
                            Save Profile
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<input id="fileInput" type="file" accept="image/*" onchange="handleImageUpload(event)" class="hidden" />

<script>
  const API_BASE = "/api";
  const $ = (id) => document.getElementById(id);
  let currentImageData = null;
  let cachedProfile = null;

  // Notification
  function showNotification(message, type = "info") {
    const colors = {
      success: "bg-green-500",
      error: "bg-red-500",
      info: "bg-blue-500",
    };
    const div = document.createElement("div");
    div.className = `fixed top-4 right-4 text-white px-6 py-3 rounded-lg shadow-lg ${colors[type]} z-50 transition-all`;
    div.textContent = message;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 3000);
  }

  async function loadProfile() {
    try {
      const res = await fetch(`${API_BASE}/profile`, {
        headers: { "Cache-Control": "no-cache" },
      });

      let p = {};

      if (res.status === 304) {
        // Use cached data
        if (!cachedProfile) {
          throw new Error("No cached profile available");
        }
        p = cachedProfile;
      } else if (res.ok) {
        const data = await res.json();
        p = data.profile;
        cachedProfile = p;
      } else {
        throw new Error("Failed to load profile");
      }

      const img = p.image || null;
      currentImageData = img;

      // === UPDATE DISPLAY ===
      const setText = (id, value) => {
        const el = $(id);
        if (el) el.textContent = value || "N/A";
      };

      const setValue = (id, value) => {
        const el = $(id);
        if (el) el.value = value || "";
      };

      setText("displayName", p.name);
      setText("displayTitle", p.position);
      setText("displayPhone", p.phone);
      setText("displayEmail", p.email);
      setText("displayLocation", p.location);
      $("displayAddress").innerHTML = (p.address || "").replace(/\n/g, "<br>");

      // Update form
      setValue("adminName", p.name);
      setValue("adminTitle", p.position);
      setValue("adminEmail", p.email);
      setValue("adminPhone", p.phone);
      setValue("adminLocation", p.location);
      setValue("adminBirthday", p.birthday);
      setValue("adminGender", p.gender);
      setValue("adminAddress", p.address);

      // Update image
      if (img) {
        $("profileImage").src = img;
        $("profileImage").classList.remove("hidden");
        $("defaultProfileIcon").classList.add("hidden");
      } else {
        $("profileImage").classList.add("hidden");
        $("defaultProfileIcon").classList.remove("hidden");
      }
    } catch (err) {
      showNotification("Failed to load profile: " + err.message, "error");
    }
  }

  // Save Profile
  async function saveProfile() {
    const profile = {
      name: $("adminName").value.trim(),
      title: $("adminTitle").value.trim(),
      email: $("adminEmail").value.trim(),
      phone: $("adminPhone").value.trim(),
      location: $("adminLocation").value.trim(),
      birthday: $("adminBirthday").value.trim(),
      gender: $("adminGender").value,
      address: $("adminAddress").value.trim(),
    };

    if (!profile.name || !profile.email) {
      showNotification("Name and email are required", "error");
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/profile`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(profile),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message);

      loadProfile();
      showNotification("Profile saved!", "success");
    } catch (err) {
      showNotification("Save failed: " + err.message, "error");
    }
  }

  // Upload Image
  async function handleImageUpload(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async () => {
      currentImageData = reader.result;
      $("profileImage").src = currentImageData;
      $("profileImage").classList.remove("hidden");
      $("defaultProfileIcon").classList.add("hidden");

      const form = new FormData();
      form.append("image", file);

      try {
        const res = await fetch(`${API_BASE}/upload-profile-image`, {
          method: "POST",
          body: form,
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message);
        currentImageData = data.imageUrl;
        showNotification("Image uploaded!", "success");
      } catch (err) {
        showNotification("Upload failed: " + err.message, "error");
      }
    };
    reader.readAsDataURL(file);
  }

  // Change Password
  async function resetPassword() {
    const current = $("currentPassword").value;
    const newP = $("newPassword").value;
    const confirm = $("confirmNewPassword").value;

    if (!current || !newP || !confirm)
      return showNotification("All fields required", "error");
    if (newP !== confirm)
      return showNotification("Passwords don't match", "error");
    if (newP.length < 6) return showNotification("Password too short", "error");

    try {
      const res = await fetch(`${API_BASE}/change-password`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ currentPassword: current, newPassword: newP }),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message);

      $("currentPassword").value =
        $("newPassword").value =
        $("confirmNewPassword").value =
          "";
      showNotification("Password changed!", "success");
    } catch (err) {
      showNotification("Failed: " + err.message, "error");
    }
  }

  function cancelEdit() {
    loadProfile();
    showNotification("Changes cancelled", "info");
  }

  function showTab(tab) {
    const about = $("aboutContent"),
      timeline = $("timelineContent");
    const aTab = $("aboutTab"),
      tTab = $("timelineTab");

    if (tab === "about") {
      about.classList.remove("hidden");
      timeline.classList.add("hidden");
      aTab.classList.replace("text-gray-500", "text-gray-900");
      aTab.classList.replace("border-transparent", "border-teal-600");
      tTab.classList.replace("text-gray-900", "text-gray-500");
      tTab.classList.replace("border-teal-600", "border-transparent");
    } else {
      timeline.classList.remove("hidden");
      about.classList.add("hidden");
      tTab.classList.replace("text-gray-500", "text-gray-900");
      tTab.classList.replace("border-transparent", "border-teal-600");
      aTab.classList.replace("text-gray-900", "text-gray-500");
      aTab.classList.replace("border-teal-600", "border-transparent");
    }
  }

  function triggerFileInput() {
    $("fileInput").click();
  }

  // Init
  window.onload = loadProfile;
</script>
