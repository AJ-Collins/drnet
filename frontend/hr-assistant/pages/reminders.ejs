<style>
        :root { font-family: 'Plus Jakarta Sans', sans-serif; }
        
        body { background-color: #f8fafc; }

        .glass-panel { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px); 
            border: 1px solid #e2e8f0; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        table { border-collapse: separate; border-spacing: 0; width: 100%; }
        th { 
            background: #f8fafc; 
            color: #64748b; 
            font-size: 0.65rem; 
            font-weight: 800; 
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
            padding: 1rem 1.5rem; 
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        td { 
            padding: 1rem 1.5rem; 
            border-bottom: 1px solid #f1f5f9; 
            font-size: 0.85rem;
            vertical-align: middle;
        }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background-color: #f8fafc; }

        .badge { font-size: 0.65rem; font-weight: 800; padding: 0.35rem 0.75rem; border-radius: 9999px; text-transform: uppercase; letter-spacing: 0.05em; display: inline-flex; align-items: center; gap: 0.35rem; }
        .badge-active { background: #f0fdfa; color: #0d9488; border: 1px solid #ccfbf1; }
        .badge-overdue { background: #fff1f2; color: #be123c; border: 1px solid #ffe4e6; }
        .badge-inactive { background: #f8fafc; color: #64748b; border: 1px solid #e2e8f0; }

        .drawer-overlay {
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(4px);
        }
        .drawer-panel {
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: -10px 0 30px rgba(0,0,0,0.1);
        }
        .drawer-panel.open { transform: translateX(0); }

        .search-input {
            background: #f1f5f9;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .search-input:focus {
            background: white;
            border-color: #0d9488;
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
        }

        .sms-editor {
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
            font-family: 'Courier New', monospace;
            line-height: 1.5;
        }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .copy-btn.copied { background: #10b981 !important; color: white !important; }
</style>
<div class="max-w-full mx-auto flex flex-col">
        
        <div class="mb-8">
            <h1 class="text-3xl font-black text-slate-900 tracking-tight">Client Comms</h1>
            <p class="text-slate-500 font-bold text-sm">Payment & Reminder System</p>
        </div>

        <div class="glass-panel p-2 rounded-xl flex flex-col md:flex-row gap-2 mb-6 sticky top-4 z-20">
            <div class="relative flex-grow">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                <input type="text" id="searchInput" placeholder="Search client name, phone, or package..." 
                    class="w-full pl-10 pr-4 py-3 rounded-xl search-input text-sm font-semibold outline-none text-slate-700 placeholder:text-slate-400">
            </div>
            
            <div class="flex gap-2">
                <select id="statusFilter" class="px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 text-xs font-bold uppercase text-slate-600 outline-none hover:bg-white cursor-pointer">
                    <option value="">All Statuses</option>
                    <option value="active">Active Only</option>
                    <option value="overdue">Overdue Only</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>
        </div>

        <div id="loadingState" class="hidden py-20 text-center">
            <i class="fas fa-circle-notch fa-spin text-4xl text-teal-500 mb-4"></i>
            <p class="text-sm font-bold text-slate-400 uppercase tracking-widest">Loading Data...</p>
        </div>

        <div id="tableContainer" class="glass-panel rounded-xl overflow-hidden mb-6 hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr>
                            <th>Client Identity</th>
                            <th>Package</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Expiry Date</th>
                            <th class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="clientsTableBody" class="bg-white">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="emptyState" class="hidden py-16 text-center">
             <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-100 text-slate-300 mb-4">
                <i class="fas fa-folder-open text-2xl"></i>
             </div>
             <p class="text-sm font-bold text-slate-400 uppercase tracking-widest">No Records Found</p>
        </div>

        <div id="paginationContainer" class="mt-auto pt-6 flex justify-between items-center border-t border-slate-200 hidden">
            <span id="pageInfo" class="text-xs font-bold text-slate-400 uppercase">Showing 0-0 of 0</span>
            <div class="flex gap-2">
                <button id="btnPrev" class="px-4 py-2 rounded-lg border border-slate-200 text-xs font-bold text-slate-600 hover:bg-slate-50 disabled:opacity-50">Previous</button>
                <button id="btnNext" class="px-4 py-2 rounded-lg border border-slate-200 text-xs font-bold text-slate-600 hover:bg-slate-50 disabled:opacity-50">Next</button>
            </div>
        </div>

    </div>

    <div id="drawerOverlay" class="fixed inset-0 drawer-overlay hidden z-40 transition-opacity opacity-0" onclick="UI.closeDrawer()"></div>
    
    <div id="smsDrawer" class="fixed top-0 right-0 h-full w-full max-w-[480px] bg-white z-50 drawer-panel flex flex-col border-l border-slate-200">
        
        <div class="p-6 border-b border-slate-100 flex justify-between items-start bg-slate-50">
            <div>
                <h2 id="dName" class="text-xl font-black text-slate-800 tracking-tight">Client Name</h2>
                <div class="flex items-center gap-2 mt-1">
                    <span id="dPhone" class="text-xs font-bold text-slate-500 font-mono">07XX XXX XXX</span>
                    <span id="dStatus" class="text-[9px] font-black uppercase px-2 py-0.5 rounded bg-slate-200 text-slate-600">Status</span>
                </div>
            </div>
            <button onclick="UI.closeDrawer()" class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-400 hover:text-rose-500 hover:border-rose-200 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="flex-grow overflow-y-auto custom-scroll p-6 space-y-8">
            
            <div class="grid grid-cols-2 gap-3">
                <div class="p-3 rounded-xl bg-slate-100 border border-slate-100">
                    <p class="text-[8px] font-black text-slate-400 uppercase">Package</p>
                    <p id="dPackage" class="text-sm font-bold text-slate-900 truncate">--</p>
                </div>
                <div class="p-3 rounded-xl bg-slate-100 border border-slate-100">
                    <p class="text-[8px] font-black text-slate-400 uppercase">Amount Due</p>
                    <p id="dPrice" class="text-sm font-bold text-slate-900">KES 0</p>
                </div>
            </div>

            <div class="space-y-3">
                <div class="flex justify-between items-end">
                    <label class="text-[10px] font-black text-rose-500 uppercase tracking-widest">
                        <i class="fas fa-bell mr-1"></i> Payment Reminder
                    </label>
                    <button onclick="Actions.copyToClipboard('reminderText', this)" class="copy-btn text-[9px] font-bold bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1.5 rounded-lg transition-all">
                        <i class="fas fa-copy mr-1"></i> COPY TEXT
                    </button>
                </div>
                <div class="relative group">
                    <textarea id="reminderText" class="w-full h-40 sms-editor p-4 rounded-xl border border-slate-200 text-xs text-slate-700 outline-none focus:border-rose-400 focus:ring-4 focus:ring-rose-50 transition-all resize-none"></textarea>
                    <div class="absolute bottom-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="text-[9px] font-mono text-slate-400">~ DR.NET LABS</span>
                    </div>
                </div>
            </div>

            <hr class="border-slate-100">

            <div class="space-y-3">
                <div class="flex justify-between items-end">
                    <label class="text-[10px] font-black text-teal-600 uppercase tracking-widest">
                        <i class="fas fa-check-circle mr-1"></i> Payment Receipt
                    </label>
                    <button onclick="Actions.copyToClipboard('confirmText', this)" class="copy-btn text-[9px] font-bold bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1.5 rounded-lg transition-all">
                        <i class="fas fa-copy mr-1"></i> COPY TEXT
                    </button>
                </div>
                <div class="relative group">
                    <textarea id="confirmText" class="w-full h-40 sms-editor p-4 rounded-xl border border-slate-200 text-xs text-slate-700 outline-none focus:border-teal-400 focus:ring-4 focus:ring-teal-50 transition-all resize-none"></textarea>
                    <div class="absolute bottom-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="text-[9px] font-mono text-slate-400">~ DR.NET LABS</span>
                    </div>
                </div>
            </div>

        </div>

        <div class="p-4 bg-slate-50 border-t border-slate-100 text-center">
            <p class="text-[10px] text-slate-400 font-bold uppercase">Click copy, then paste into SMS app or Bulk Sender</p>
        </div>
    </div>

    <script>
        const API_BASE = "/api";
        const ITEMS_PER_PAGE = 20;
        
        const State = {
            allClients: [],
            filteredClients: [],
            currentPage: 1,
            isLoading: false
        };

        const Els = {
            tableContainer: document.getElementById('tableContainer'),
            tbody: document.getElementById('clientsTableBody'),
            emptyState: document.getElementById('emptyState'),
            search: document.getElementById('searchInput'),
            filter: document.getElementById('statusFilter'),
            loader: document.getElementById('loadingState'),
            pagination: document.getElementById('paginationContainer'),
            pageInfo: document.getElementById('pageInfo'),
            prevBtn: document.getElementById('btnPrev'),
            nextBtn: document.getElementById('btnNext'),
            
            drawer: document.getElementById('smsDrawer'),
            overlay: document.getElementById('drawerOverlay'),
            dName: document.getElementById('dName'),
            dPhone: document.getElementById('dPhone'),
            dStatus: document.getElementById('dStatus'),
            dPackage: document.getElementById('dPackage'),
            dPrice: document.getElementById('dPrice'),
            txtReminder: document.getElementById('reminderText'),
            txtConfirm: document.getElementById('confirmText')
        };

        async function loadClients() {
            UI.toggleLoading(true);
            
            try {
                const res = await fetch(`${API_BASE}/clients`);
                if (!res.ok) throw new Error("API Error");
                const rawData = await res.json();

                const enriched = await Promise.all(rawData.map(async (client) => {
                    let details = {
                        pkg: "No Package",
                        price: 0,
                        expiry: null,
                        status: "inactive"
                    };

                    try {
                        const subRes = await fetch(`${API_BASE}/subscribe/client/current?userId=${client.id}`);
                        if(subRes.ok) {
                            const subs = await subRes.json();
                            if(subs.length > 0) {
                                const sub = subs[0];
                                details.pkg = sub.package?.name || "Unknown";
                                details.price = sub.package?.price || 0;
                                details.expiry = sub.expiry_date;
                                details.status = sub.subscription_status;
                            }
                        }
                    } catch(e) { console.warn("Sub fetch failed", e); }

                    const today = new Date();
                    const expDate = details.expiry ? new Date(details.expiry) : null;
                    const isOverdue = expDate && expDate < today;

                    let displayStatus = 'inactive';
                    if(details.status === 'active') displayStatus = isOverdue ? 'overdue' : 'active';
                    
                    return { ...client, ...details, displayStatus, expDate };
                }));

                State.allClients = enriched.sort((a, b) => {
                    const nA = (a.name || a.first_name).toLowerCase();
                    const nB = (b.name || b.first_name).toLowerCase();
                    return nA.localeCompare(nB);
                });

                applyFilters();

            } catch (error) {
                console.error(error);
                Swal.fire({
                    icon: 'error',
                    title: 'Connection Error',
                    text: 'Could not sync client database.',
                    confirmButtonColor: '#0f172a'
                });
            } finally {
                UI.toggleLoading(false);
            }
        }

        function applyFilters() {
            const term = Els.search.value.toLowerCase().trim();
            const filter = Els.filter.value;

            State.filteredClients = State.allClients.filter(c => {
                const name = (c.name || `${c.first_name} ${c.second_name}`).toLowerCase();
                const phone = (c.phone || "").toLowerCase();
                const pkg = (c.pkg || "").toLowerCase();

                const matchesSearch = !term || name.includes(term) || phone.includes(term) || pkg.includes(term);
                const matchesFilter = !filter || c.displayStatus === filter;

                return matchesSearch && matchesFilter;
            });

            State.currentPage = 1;
            renderTable();
        }

        function renderTable() {
            const start = (State.currentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageData = State.filteredClients.slice(start, end);

            Els.tbody.innerHTML = "";

            if (pageData.length === 0) {
                Els.tableContainer.classList.add('hidden');
                Els.emptyState.classList.remove('hidden');
                UI.updatePagination(0);
                return;
            }

            Els.tableContainer.classList.remove('hidden');
            Els.emptyState.classList.add('hidden');

            pageData.forEach(client => {
                const tr = document.createElement('tr');
                
                const name = client.name || `${client.first_name} ${client.second_name}`;
                const price = Number(client.price).toLocaleString();
                let statusClass = "badge-inactive";
                let statusIcon = "fa-minus-circle";
                
                if(client.displayStatus === 'active') {
                    statusClass = "badge-active";
                    statusIcon = "fa-check-circle";
                } else if(client.displayStatus === 'overdue') {
                    statusClass = "badge-overdue";
                    statusIcon = "fa-exclamation-circle";
                }

                const dateStr = client.expDate ? new Date(client.expDate).toLocaleDateString('en-GB') : "N/A";

                tr.innerHTML = `
                    <td>
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-700 font-bold text-xm border border-slate-100">
                                ${name.charAt(0)}
                            </div>
                            <div>
                                <h2 class="font-bold text-slate-800 leading-tight">${name}</h2>
                                <p class="text-[10px] font-mono text-slate-400">${client.phone || "No Phone"}</p>
                            </div>
                        </div>
                    </td>
                    <td class="font-medium text-slate-600">${client.pkg}</td>
                    <td class="font-mono font-bold text-slate-700">KES ${price}</td>
                    <td>
                        <span class="badge ${statusClass}">
                            <i class="fas ${statusIcon}"></i> ${client.displayStatus}
                        </span>
                    </td>
                    <td class="text-xs font-medium text-slate-500">
                        <i class="far fa-calendar-alt mr-1 opacity-50"></i> ${dateStr}
                    </td>
                    <td class="text-right">
                        <button onclick="Actions.openDrawer(${client.id})" class="text-[9px] font-black uppercase tracking-widest text-teal-600 bg-teal-50 hover:bg-teal-100 px-3 py-1.5 rounded-lg transition-colors">
                            <i class="fas fa-comment-dots mr-1"></i> Compose sms
                        </button>
                    </td>
                `;
                Els.tbody.appendChild(tr);
            });

            UI.updatePagination(State.filteredClients.length);
        }

        const UI = {
            toggleLoading: (show) => {
                Els.loader.classList.toggle('hidden', !show);
                Els.tableContainer.classList.toggle('hidden', show);
                if(show) Els.emptyState.classList.add('hidden');
            },

            updatePagination: (total) => {
                Els.pagination.classList.toggle('hidden', total === 0);
                const maxPage = Math.ceil(total / ITEMS_PER_PAGE) || 1;
                const start = (State.currentPage - 1) * ITEMS_PER_PAGE + 1;
                const end = Math.min(start + ITEMS_PER_PAGE - 1, total);

                Els.pageInfo.innerText = `Showing ${total === 0 ? 0 : start}-${end} of ${total}`;
                Els.prevBtn.disabled = State.currentPage === 1;
                Els.nextBtn.disabled = State.currentPage >= maxPage;
            },

            openDrawer: () => {
                Els.overlay.classList.remove('hidden');
                setTimeout(() => {
                    Els.overlay.classList.remove('opacity-0');
                    Els.drawer.classList.add('open');
                }, 10);
                document.body.style.overflow = 'hidden';
            },

            closeDrawer: () => {
                Els.drawer.classList.remove('open');
                Els.overlay.classList.add('opacity-0');
                setTimeout(() => {
                    Els.overlay.classList.add('hidden');
                    document.body.style.overflow = '';
                }, 400);
            }
        };

        const Actions = {
            openDrawer: (id) => {
                const client = State.allClients.find(c => c.id === id);
                if(!client) return;

                const name = client.name || `${client.first_name} ${client.second_name}`;
                Els.dName.innerText = name;
                Els.dPhone.innerText = client.phone || "No Phone";
                Els.dStatus.innerText = client.displayStatus;
                
                Els.dStatus.className = `text-[9px] font-black uppercase px-2 py-0.5 rounded ${
                    client.displayStatus === 'overdue' ? 'bg-rose-100 text-rose-600' : 
                    client.displayStatus === 'active' ? 'bg-teal-100 text-teal-600' : 
                    'bg-slate-200 text-slate-600'
                }`;

                Els.dPackage.innerText = client.pkg;
                Els.dPrice.innerText = `KES ${Number(client.price).toLocaleString()}`;

                // Generate Templates
                const firstName = name.split(" ")[0];
                const amount = Number(client.price).toLocaleString();
                const dateStr = client.expDate ? new Date(client.expDate).toLocaleDateString('en-GB') : "IMMEDIATELY";
                
                // Reminder Template
                Els.txtReminder.value = 
`REMINDER: ${firstName},
Your DR.NET subscription payment is overdue.
Amount Due: KES ${amount}.
Please pay by ${dateStr} to avoid service suspension.
Pay via M-PESA:
• Buy Goods & Services
• Till Number: 5626320
DR.NET TECHNOLOGY LABS`;

                // Receipt Template
                Els.txtConfirm.value = 
`Payment Confirmed!
Thank you ${firstName}.
Amount: KES ${amount}
Package: ${client.pkg}
Your DR.NET internet service has been renewed for 30 days.
Questions? Call 0701782354
DR.NET TECHNOLOGY LABS`;

                UI.openDrawer();
            },

            copyToClipboard: (elementId, btn) => {
                const text = document.getElementById(elementId).value;
                navigator.clipboard.writeText(text).then(() => {
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = `<i class="fas fa-check mr-1"></i> COPIED!`;
                    btn.classList.add('copied');
                    
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                        btn.classList.remove('copied');
                    }, 2000);
                });
            },

            prevPage: () => {
                if(State.currentPage > 1) {
                    State.currentPage--;
                    renderTable();
                    window.scrollTo({top: 0, behavior: 'smooth'});
                }
            },

            nextPage: () => {
                const max = Math.ceil(State.filteredClients.length / ITEMS_PER_PAGE);
                if(State.currentPage < max) {
                    State.currentPage++;
                    renderTable();
                    window.scrollTo({top: 0, behavior: 'smooth'});
                }
            }
        };

        Els.search.addEventListener('input', applyFilters);
        Els.filter.addEventListener('change', applyFilters);
        Els.prevBtn.addEventListener('click', Actions.prevPage);
        Els.nextBtn.addEventListener('click', Actions.nextPage);

        document.addEventListener('DOMContentLoaded', loadClients);

    </script>