<style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
    :root { font-family: 'Plus Jakarta Sans', sans-serif; }
    
    .glass-panel { background: white; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02); }
    
    .btn-loading { position: relative; color: transparent !important; pointer-events: none; }
    .btn-loading::after {
        content: ""; position: absolute; width: 16px; height: 16px; top: 0; left: 0; right: 0; bottom: 0;
        margin: auto; border: 2px solid white; border-radius: 50%; border-top-color: transparent; animation: spin 0.6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .animate-fade-up { animation: fade-in-up 0.4s ease-out forwards; }
    @keyframes fade-in-up { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .custom-scroll::-webkit-scrollbar { width: 5px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

    .filter-pill.active { background-color: #0f172a; color: white; border-color: #0f172a; }

    #inboxDrawer {
        position: fixed;
        top: 20px;
        right: 20px;
        bottom: 100px;
        width: 520px;
        z-index: 100;
        background: white;
        border-radius: 14px;
        border: 1px solid rgba(226, 232, 240, 0.8);
        box-shadow: 0 20px 50px -12px rgba(15, 23, 42, 0.25);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        
        transform-origin: bottom right;
        transition: 
            transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), 
            opacity 0.4s ease;
    }

    .drawer-hidden {
        transform: scale(0) translate(50px, 50px);
        opacity: 0;
        pointer-events: none;
    }

    .drawer-visible {
        transform: scale(1) translate(0, 0);
        opacity: 1;
        pointer-events: auto;
    }

    #inboxOverlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.1);
        backdrop-filter: blur(0px);
        z-index: 90;
        transition: opacity 0.4s ease;
    }

    #inboxList::-webkit-scrollbar { width: 4px; }
    #inboxList::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

    @keyframes pulse-teal {
        0% { box-shadow: 0 0 0 0 rgba(20, 184, 166, 0.4); }
        70% { box-shadow: 0 0 0 15px rgba(20, 184, 166, 0); }
        100% { box-shadow: 0 0 0 0 rgba(20, 184, 166, 0); }
    }
    .highlight-field { animation: pulse-teal 1.5s ease-out; border-color: #14b8a6 !important; }
</style>

<div class="max-w-full mx-auto">
    <div id="toastContainer" class="fixed top-5 right-5 z-[100] space-y-3"></div>
    <div class="mb-8 animate-fade-up">
        <h1 class="text-3xl font-black text-slate-900">Expense Tracking</h1>
        <p class="text-slate-500 font-medium">Monitor and record daily operational expenditures.</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
        
        <div class="lg:col-span-8 order-2 lg:order-1 animate-fade-up" style="animation-delay: 0.1s;">
            <div class="glass-panel rounded-xl p-6 min-h-[720px] flex flex-col">
                
                <div class="flex flex-col gap-6 mb-8">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Expenditure</p>
                            <h3 id="grandTotal" class="text-2xl font-black text-slate-900">KES 0.00</h3>
                        </div>
                        
                        <div class="flex flex-wrap items-center gap-2">
                            <button onclick="setFilterType('all')" class="filter-pill active px-4 py-1.5 rounded-full border border-slate-200 text-[11px] font-black uppercase transition-all">All</button>
                            <button onclick="setFilterType('daily')" class="filter-pill px-4 py-1.5 rounded-full border border-slate-200 text-[11px] font-black uppercase transition-all">Daily</button>
                            <button onclick="setFilterType('weekly')" class="filter-pill px-4 py-1.5 rounded-full border border-slate-200 text-[11px] font-black uppercase transition-all">Weekly</button>
                            <button onclick="setFilterType('monthly')" class="filter-pill px-4 py-1.5 rounded-full border border-slate-200 text-[11px] font-black uppercase transition-all">Monthly</button>                                                
                            
                            <div class="flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-full border border-slate-200">
                                <i class="far fa-calendar text-slate-400 text-xs"></i>
                                <input type="date" id="historyFilter" class="bg-transparent border-none text-[11px] font-black text-slate-700 focus:ring-0 p-0 cursor-pointer">
                            </div>


                            <div class="relative">
                                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-[10px]"></i>
                                <input type="text" id="searchInput" oninput="render()" placeholder="Search expenses..." 
                                       class="pl-8 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-full text-xs font-bold text-slate-700 outline-none focus:border-teal-500 w-44 transition-all">
                            </div>
                            <div class="h-6 w-[1px] bg-slate-200 mx-1"></div>
                            <button onclick="exportToExcel()" class="group flex items-center gap-2 px-4 py-1.5 rounded-full border border-slate-200 hover:border-emerald-500 hover:bg-emerald-50 transition-all">
                                <i class="fas fa-file-excel text-emerald-600 text-xs"></i>
                                <span class="text-[11px] font-black uppercase text-slate-600 group-hover:text-emerald-700">Export</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="expenseTable" class="space-y-3 overflow-y-auto custom-scroll pr-1 flex-grow max-h-[500px]">
                </div>
            </div>
        </div>

        <div class="lg:col-span-4 order-1 lg:order-2 animate-fade-up" style="animation-delay: 0.2s;">
            <div class="bg-slate-900 text-white p-8 rounded-xl sticky top-6 shadow-2xl shadow-slate-200">
                <div class="flex items-center gap-3 mb-8">
                    <div class="w-10 h-10 rounded-2xl bg-teal-500/20 flex items-center justify-center text-teal-400">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <h2 class="text-xl font-black">Record Outflow</h2>
                </div>

                <form id="expForm" class="space-y-5">
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1 mb-2 block">Amount Spent</label>
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 font-bold text-sm">KES</span>
                            <input type="number" id="expAmount" placeholder="0.00" required 
                                   class="w-full pl-14 pr-4 py-2 bg-slate-800 border border-slate-700 rounded-2xl outline-none text-teal-400 font-black text-2xl focus:border-teal-500 transition-all">
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1 mb-2 block">Category</label>
                        <input type="text" id="expOnWhat" placeholder="e.g. Meals, Transport, Equipments" required 
                               class="w-full p-2 bg-slate-800 border border-slate-700 rounded-2xl outline-none text-sm font-bold text-slate-200 focus:border-teal-500 transition-all">
                    </div>

                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1 mb-2 block">Description</label>
                        <textarea id="expDesc" placeholder="Brief details..." 
                                  class="w-full p-2 bg-slate-800 border border-slate-700 rounded-2xl outline-none text-sm font-medium text-slate-200 h-20 focus:border-teal-500 transition-all"></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1 mb-2 block">Date</label>
                            <input type="date" id="expDate" required 
                                   class="w-full p-2 bg-slate-800 border border-slate-700 rounded-xl outline-none text-[11px] font-bold text-slate-200 focus:border-teal-500 transition-all">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1 mb-2 block">Beneficiary (optional)</label>
                            <input type="text" id="beneficiary" placeholder="Name" 
                                   class="w-full p-2 bg-slate-800 border border-slate-700 rounded-xl outline-none text-[11px] font-bold text-slate-200 focus:border-teal-500 transition-all">
                        </div>
                    </div>

                    <button type="submit" id="submitExpBtn" class="w-full py-4 bg-teal-500 hover:bg-teal-400 text-slate-900 rounded-2xl font-black uppercase text-xs tracking-widest shadow-lg shadow-teal-900/20 transition-all mt-4">
                        Save Expense
                    </button>
                    <button type="button" id="cancelEdit" onclick="resetForm()" class="hidden w-full py-2 text-slate-500 text-[10px] font-black uppercase tracking-widest hover:text-white transition-colors">
                        Cancel Edit
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!--Inbox-->
    <button id="inboxBtn" onclick="toggleInbox()" class="fixed bottom-8 right-8 w-16 h-16 bg-slate-900 text-white rounded-full shadow-2xl hover:scale-110 active:scale-95 transition-all z-[70] flex items-center justify-center">
        <div class="absolute -top-1 -right-1 w-6 h-6 bg-rose-500 border-4 border-white rounded-full text-[10px] font-black flex items-center justify-center" id="inboxCount">0</div>        
        <i class="fas fa-comment-dots text-xl group-hover:scale-110 transition-transform"></i>
    </button>

    <div id="inboxDrawer" class="drawer-hidden">
        <div class="p-6 bg-slate-900 text-white flex justify-between items-center">
            <div>
                <div class="flex items-center gap-2">
                    <i class="fas fa-comment-dots text-xl group-hover:scale-110 transition-transform"></i>
                    <h3 class="font-black text-lg tracking-tight leading-none">Inbox</h3>
                </div>
                <p class="text-slate-400 text-[10px] font-black uppercase tracking-widest mt-2">Received Feeds</p>
            </div>
            <button onclick="toggleInbox()" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center hover:bg-slate-500 transition-all">
                <i class="fas fa-times text-xs"></i>
            </button>
        </div>

        <div id="inboxList" class="flex-grow overflow-y-auto p-5 space-y-4 bg-slate-50/50 custom-scroll">
            </div>

        <div class="p-4 bg-white border-t border-slate-100">
            <button onclick="fetchCEOInbox()" class="w-full py-3 rounded-xl text-[10px] font-black uppercase tracking-widest text-slate-500 hover:bg-slate-50 transition-all">
                <i class="fas fa-sync-alt mr-2"></i> Refresh
            </button>
        </div>
    </div>

    <div id="inboxOverlay" onclick="toggleInbox()" class="fixed inset-0 bg-slate-900/10 backdrop-blur-[2px] z-[60] hidden opacity-0 transition-opacity duration-500"></div>
</div>

<script>
    const expenseApi = {
        async getAll() {
            const res = await fetch('/api/hr/expenses');
            return await res.json();
        },
        async create(data) {
            const res = await fetch('/api/hr/expenses', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            return await res.json();
        },
        async update(id, data) {
            const res = await fetch(`/api/hr/expenses/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            return await res.json();
        },
        async delete(id) {
            await fetch(`/api/hr/expenses/${id}`, { method: 'DELETE' });
            return true;
        }
    };

    let expenses = [];
    let activeFilterType = 'all'; // daily, weekly, monthly, all
    const $ = id => document.getElementById(id);
    let editingId = null;

    async function init() {
        $('expDate').valueAsDate = new Date();
        $('historyFilter').valueAsDate = new Date();
        expenses = await expenseApi.getAll();

        await fetchCEOInbox();
        render();
    }

    function setFilterType(type) {
        activeFilterType = type;
        document.querySelectorAll('.filter-pill').forEach(p => {
            p.classList.toggle('active', p.innerText.toLowerCase() === type);
        });
        render();
    }

    async function handleFormSubmit(e) {
        e.preventDefault();
        const btn = $('submitExpBtn');
        btn.classList.add('btn-loading');

        const formData = {
            amount: Number($('expAmount').value),
            category: $('expOnWhat').value,
            description: $('expDesc').value,
            beneficiary: $('beneficiary').value || 'None',
            expense_date: $('expDate').value
        };

        let saved;

        if (editingId) {
            saved = await expenseApi.update(editingId, formData);
            showToast("SUCCESS", "Data Updated.");
            expenses = expenses.map(e => e.id === editingId ? { ...e, ...saved } : e );
            editingId = null;
            btn.innerText = "Save Expense";
        } else {
            saved = await expenseApi.create(formData);
            expenses.unshift(saved);
            showToast("SUCCESS", "Data Created.");
        }
                
        $('expForm').reset();
        $('expDate').valueAsDate = new Date();
        btn.classList.remove('btn-loading');
        render();
    }

    function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    function render() {
        const container = $('expenseTable');
        const selectedDate = new Date($('historyFilter').value);
        const searchQuery = $('searchInput').value.toLowerCase();
        
        let filtered = expenses.filter(e => {
            const expDate = new Date(e.expense_date);
            if (activeFilterType === 'all') {
                return true; 
            }
            if (activeFilterType === 'daily') {
                return expDate.toDateString() === selectedDate.toDateString();
            } else if (activeFilterType === 'weekly') {
                return getWeekNumber(expDate) === getWeekNumber(selectedDate) && 
                       expDate.getFullYear() === selectedDate.getFullYear();
            } else {
                return expDate.getMonth() === selectedDate.getMonth() && 
                       expDate.getFullYear() === selectedDate.getFullYear();
            }
        });

        if (searchQuery) {
            filtered = filtered.filter(e => 
                e.category.toLowerCase().includes(searchQuery) || 
                e.description.toLowerCase().includes(searchQuery) || 
                e.beneficiary.toLowerCase().includes(searchQuery)
            );
        }

        if (filtered.length === 0) {
            container.innerHTML = `<div class="text-center py-20 text-slate-300 font-bold text-sm">No records found.</div>`;
            $('grandTotal').textContent = 'KES 0.00';
            return;
        }

        let total = 0;
        container.innerHTML = filtered.map(e => {
            const amount = Number(e.amount) || 0;
            total += amount;
            return `
            <div class="flex items-center justify-between p-4 bg-slate-50 hover:bg-white border border-slate-100 hover:border-teal-200 rounded-2xl transition-all animate-fade-up">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-xl bg-white border border-slate-100 flex flex-col items-center justify-center font-black">
                        <span class="text-[8px] uppercase text-slate-500">${new Date(e.expense_date).toLocaleString('default', {month: 'short'})}</span>
                        <span class="text-xs text-slate-700">${new Date(e.expense_date).getDate()}</span>
                    </div>
                    <div>
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-black text-slate-800">${e.category}</span>
                            <span class="text-[8px] font-black uppercase text-teal-600 bg-teal-50 px-2 py-0.5 rounded">${e.beneficiary}</span>
                        </div>
                        <p class="text-[10px] text-slate-500 truncate w-40 sm:w-64">${e.description}</p>
                    </div>
                </div>
                <div class="text-right flex items-center gap-4">
                    <span class="text-sm font-black text-slate-900">KES ${Number(e.amount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>                    
                    <div class="relative group/icon">
                        <button onclick="editExpense(${e.id})" class="text-slate-300 hover:text-rose-500 transition-all"><i class="fas fa-edit text-xm"></i></button>
                        <span class="absolute top-1/2 right-full mr-2 -translate-y-1/2
                            whitespace-nowrap bg-slate-900 text-white text-[10px]
                            px-2 py-1 rounded-md opacity-0
                            group-hover/icon:opacity-100 transition
                            pointer-events-none z-50

                            after:content-[''] after:absolute after:top-1/2 after:left-full
                            after:-translate-y-1/2
                            after:border-4 after:border-transparent
                            after:border-l-slate-900">
                            Edit expense
                        </span>
                    </div>
                    <div class="relative group/icon">
                        <button onclick="deleteExpense(${e.id})" class="text-slate-300 hover:text-rose-500 transition-all"><i class="fas fa-trash-alt text-xm"></i></button>                
                        <span class="absolute top-1/2 right-full mr-2 -translate-y-1/2
                            whitespace-nowrap bg-slate-900 text-white text-[10px]
                            px-2 py-1 rounded-md opacity-0
                            group-hover/icon:opacity-100 transition
                            pointer-events-none z-50

                            after:content-[''] after:absolute after:top-1/2 after:left-full
                            after:-translate-y-1/2
                            after:border-4 after:border-transparent
                            after:border-l-slate-900">
                            Delete expense
                        </span>
                    </div>                        
                </div>
            </div>`;
        }).join('');        

        $('grandTotal').textContent = `KES ${Number(total).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    function resetForm() {
        $('expForm').reset();
        editingId = null;
        $('expDate').valueAsDate = new Date();
        $('submitExpBtn').innerText = "Save Expense";
        $('cancelEdit').classList.add('hidden');
    }

    function editExpense(id) {
        const item = expenses.find(e => e.id === id);
        if (!item) return;

        editingId = id;
        $('expAmount').value = item.amount;
        $('expOnWhat').value = item.category;
        $('expDesc').value = item.description;
        $('beneficiary').value = item.beneficiary;
        $('expDate').value = item.expense_date.slice(0, 10);
        
        $('submitExpBtn').innerText = "Update Expense";
        $('cancelEdit').classList.remove('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function deleteExpense(id) {
        if(!confirm("Delete record?")) return;
        await expenseApi.delete(id);
        showToast("SUCCESS", "Record deleted.");
        expenses = expenses.filter(e => e.id !== id);
        render();
    }

    function showToast(title, msg) {
        const toast = document.createElement('div');
        toast.className = "bg-slate-900 text-white p-4 rounded-xl shadow-xl min-w-[200px] animate-slide-in";
        toast.innerHTML = `<h5 class="text-[10px] font-black uppercase text-teal-400 mb-1">${title}</h5><p class="text-xs font-medium">${msg}</p>`;
        document.getElementById('toastContainer').appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    function toggleInbox() {
        const drawer = document.getElementById('inboxDrawer');
        const overlay = document.getElementById('inboxOverlay');
        const isHidden = drawer.classList.contains('drawer-hidden');

        if (isHidden) {
            drawer.classList.remove('drawer-hidden');
            drawer.classList.add('drawer-visible');
            overlay.classList.remove('hidden');
            setTimeout(() => overlay.style.opacity = "1", 10);
            markAllAsSeen();
            fetchCEOInbox();
        } else {
            drawer.classList.add('drawer-hidden');
            drawer.classList.remove('drawer-visible');
            overlay.style.opacity = "0";
            setTimeout(() => overlay.classList.add('hidden'), 400);
        }
    }

    async function fetchCEOInbox() {
        try {
            const res = await fetch('/api/hr/inbox');
            const data = await res.json();
            const container = document.getElementById('inboxList');
            const countBadge = document.getElementById('inboxCount');

            const pendingCount = data.filter(m => m.status === 'pending').length;
            
            if (pendingCount > 0) {
                countBadge.innerText = pendingCount;
                countBadge.style.display = 'flex';
            } else {
                countBadge.style.display = 'none';
            }

            if (data.length === 0) {
                container.innerHTML = `<div class="text-center py-20 text-slate-400 font-bold text-xs uppercase tracking-widest">Feed is Empty</div>`;
                return;
            }

            container.innerHTML = data.map(msg => {
                const isProcessed = msg.status === 'processed';
                return `
                    <div class="${isProcessed ? 'bg-slate-200 opacity-70' : 'bg-slate-200'} p-5 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-all animate-fade-up">
                        <div class="flex justify-between items-center mb-3">
                            <span class="px-2 py-1 rounded-lg bg-teal-50 text-teal-600 text-[9px] font-black uppercase">CTO</span>
                            <span class="text-[10px] text-slate-400 font-bold">${new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                        </div>
                        
                        <p class="text-sm font-semibold text-slate-700 leading-relaxed mb-4">"${msg.message_content}"</p>
                        
                        <div class="flex gap-2 pt-3 border-t border-slate-50">
                            ${isProcessed ? `
                                <div class="w-full py-2 flex items-center justify-center gap-2 text-emerald-500 font-black uppercase text-[10px] tracking-widest">
                                    <i class="fas fa-check-double"></i> Processed
                                </div>
                            ` : `
                                <button onclick="captureMessage('${msg.message_content.replace(/'/g, "\\'")}', ${msg.id})" 
                                        class="flex-1 bg-slate-900 text-white py-2 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-teal-500 hover:text-slate-900 transition-all">
                                    <i class="fas fa-file-export mr-2"></i> Capture to Input
                                </button>
                                <div class="relative group/icon">                     
                                    <button onclick="updateInboxStatus(${msg.id}, 'processed')" 
                                        class="w-10 h-10 flex items-center justify-center bg-slate-50 text-slate-400 hover:text-rose-500 rounded-xl transition-all">
                                        <i class="fas fa-check-circle text-xs"></i>
                                    </button>
                                    <span class="absolute top-1/2 right-full mr-2 -translate-y-1/2
                                        whitespace-nowrap bg-slate-900 text-white text-[10px]
                                        px-2 py-1 rounded-md opacity-0
                                        group-hover/icon:opacity-100 transition
                                        pointer-events-none z-50

                                        after:content-[''] after:absolute after:top-1/2 after:left-full
                                        after:-translate-y-1/2
                                        after:border-4 after:border-transparent
                                        after:border-l-slate-900">
                                        Mark as complete
                                    </span>
                                </div> 
                            `}                       
                        </div>
                    </div>
                `;
            }).join('');
        } catch (e) {
            console.error("Inbox fetch failed");
        }
    }

    async function markAllAsSeen() {
        try {
            await fetch('/api/hr/inbox/mark-seen', { method: 'PATCH' });
        } catch (e) {
            console.error("Failed to update seen status");
        }
    }

    function captureMessage(content, id) {
        const amountField = $('expAmount');
        const descField = $('expDesc');
        const categoryField = $('expOnWhat');

        const numberMatch = content.match(/(\d+(\.\d{1,2})?)/);
        
        if (numberMatch) {
            amountField.value = numberMatch[0];
            descField.value = content.replace(numberMatch[0], '').trim();
        } else {
            descField.value = content;
        }

        toggleInbox();
        
        [amountField, descField].forEach(field => {
            field.classList.add('highlight-field');
            setTimeout(() => field.classList.remove('highlight-field'), 1500);
        });

        amountField.focus();
        showToast("SUCCESS", "Captured & Parsed request details.");
    }

    async function updateInboxStatus(id, status) {
        await fetch(`/api/hr/inbox/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status })
        });
        fetchCEOInbox();
    }

    function exportToExcel() {
        if (!expenses || expenses.length === 0) {
            showToast("WARNING", "No data available to export.");
            return;
        }
        const headers = ["Date", "Category", "Beneficiary", "Description", "Amount (KES)"];
        const totalSum = expenses.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
        const csvRows = expenses.map(row => {
            const date = new Date(row.expense_date).toLocaleDateString();
            const cleanDesc = `"${(row.description || '').replace(/"/g, '""')}"`; 
            const cleanCat = `"${(row.category || '').replace(/"/g, '""')}"`;
            const cleanBen = `"${(row.beneficiary || '').replace(/"/g, '""')}"`;
            
            return [
                date,
                cleanCat,
                cleanBen,
                cleanDesc,
                row.amount
            ].join(",");
        });
        const totalRow = ["", "", "TOTAL EXPENDITURE", "", totalSum.toFixed(2)].join(",");
        const csvContent = [headers.join(","), ...csvRows, "", totalRow].join("\n");
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        const timestamp = new Date().toISOString().slice(0,10);
        link.setAttribute("href", url);
        link.setAttribute("download", `Expenses_data_${timestamp}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showToast("SUCCESS", "Excel data file downloaded.");
    }

    setInterval(fetchCEOInbox, 60000);

    $('expForm').onsubmit = handleFormSubmit;
    $('historyFilter').oninput = render;
    init();
</script>