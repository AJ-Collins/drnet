<style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; }
    .kanban-column { min-height: 600px; }
    .dragging { opacity: 0.5; transform: scale(0.95); }
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    .summary-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .summary-card:hover { transform: translateY(-5px); }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    .animate-spin-fast {
        animation: spin 0.8s linear infinite;
    }
  </style>

<body class="bg-[#f1f5f9] text-slate-900 min-h-screen">

  <div id="toastContainer" class="fixed top-5 right-5 z-[100] space-y-3"></div>
  <nav class="bg-white border-b border-slate-200 sticky top-0 px-6 h-16 flex items-end justify-end shadow-sm">
    
    <div class="flex items-center gap-3">        
        <div class="hidden md:flex bg-slate-100 p-1 rounded-xl">
            <button onclick="setView('list')" id="listBtn" class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all">List View</button>
            <button onclick="setView('kanban')" id="kanbanBtn" class="px-4 py-1.5 rounded-lg text-xs font-bold bg-white shadow-sm transition-all">Board View</button>
        </div>
        <button onclick="generatePDF()" title="Export Report" class="p-2.5 bg-white border border-slate-200 rounded-xl hover:bg-slate-50 transition-all">
            <i class="fas fa-file-export text-slate-600"></i>
        </button>
        <button onclick="openTaskModal()" class="bg-teal-600 text-white px-4 py-2.5 rounded-xl text-xs font-bold shadow-lg shadow-teal-100 hover:bg-teal-700 transition-all">
            + NEW TASK
        </button>
    </div>
  </nav>

  <main class="max-w-full mx-auto p-6">
    
    <div id="summarySection" class="mb-4 grid grid-cols-1 md:grid-cols-4 gap-4 animate-fade-in">
        <div class="summary-card bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
            <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Weekly Summary</h4>
            <p id="weeklyText" class="text-sm text-slate-600 font-medium leading-relaxed">Calculating your weekly outlook...</p>
        </div>
        <div class="summary-card bg-indigo-50 p-5 rounded-2xl border border-indigo-100 shadow-sm">
            <h4 class="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-2">High Priority Ops</h4>
            <div id="highPriorityList" class="space-y-2"></div>
        </div>
        <div class="summary-card bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
            <h4 class="text-[10px] font-black text-emerald-500 uppercase tracking-widest mb-2">Calendar: Site Visits</h4>
            <div id="siteVisitList" class="space-y-2"></div>
        </div>
        <div class="summary-card bg-slate-900 p-5 rounded-2xl shadow-xl">
            <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 text-white">Efficiency Score</h4>
            <div class="flex items-end gap-2">
                <span id="efficiencyVal" class="text-3xl font-bold text-white">0%</span>
                <span class="text-slate-400 text-xs mb-1">vs last week</span>
            </div>
            <div class="w-full bg-slate-700 h-1.5 rounded-full mt-4">
                <div id="efficiencyBar" class="bg-indigo-500 h-full rounded-full" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <div class="flex flex-wrap items-center gap-4 mb-8 bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
        <div class="flex items-center gap-2 border-r pr-4 border-slate-100">
            <i class="fas fa-filter text-slate-400 text-xs"></i>
            <span class="text-xs font-bold text-slate-500 uppercase tracking-widest">Filters</span>
        </div>
        <select id="filterRole" onchange="renderAll()" class="bg-transparent text-xs font-bold outline-none cursor-pointer">
            <option value="All">All Roles</option>
            <option value="HR">Human Resources</option>
            <option value="Contractor">Contractors</option>
            <option value="Staff">Internal Staff</option>
            <option value="Site Visit">Site Visits</option>
        </select>
        <select id="filterPriority" onchange="renderAll()" class="bg-transparent text-xs font-bold outline-none cursor-pointer">
            <option value="All">All Priorities</option>
            <option value="high">High Priority</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
        </select>
        <div class="ml-auto flex items-center gap-2">
            <input type="text" id="searchInput" oninput="renderAll()" placeholder="Search task, owner, or notes..." class="bg-slate-50 border-none rounded-xl px-4 py-2 text-xs w-64 focus:ring-2 focus:ring-indigo-500">
        </div>
    </div>

    <div id="kanbanView" class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="kanban-column" ondrop="drop(event, 'pending')" ondragover="allowDrop(event)">
            <div class="flex items-center justify-between mb-4 px-2">
                <h3 class="font-bold text-slate-600 flex items-center gap-2 text-sm uppercase tracking-wider">
                    <span class="w-2 h-2 rounded-full bg-slate-400"></span> Pending
                </h3>
                <span id="count-pending" class="text-[10px] font-bold bg-slate-200 px-2 py-0.5 rounded-full">0</span>
            </div>
            <div id="col-pending" class="space-y-4"></div>
        </div>

        <div class="kanban-column" ondrop="drop(event, 'progress')" ondragover="allowDrop(event)">
            <div class="flex items-center justify-between mb-4 px-2">
                <h3 class="font-bold text-indigo-600 flex items-center gap-2 text-sm uppercase tracking-wider">
                    <span class="w-2 h-2 rounded-full bg-indigo-500"></span> In Progress
                </h3>
                <span id="count-progress" class="text-[10px] font-bold bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full">0</span>
            </div>
            <div id="col-progress" class="space-y-4"></div>
        </div>

        <div class="kanban-column" ondrop="drop(event, 'completed')" ondragover="allowDrop(event)">
            <div class="flex items-center justify-between mb-4 px-2">
                <h3 class="font-bold text-emerald-600 flex items-center gap-2 text-sm uppercase tracking-wider">
                    <span class="w-2 h-2 rounded-full bg-emerald-500"></span> Completed
                </h3>
                <span id="count-completed" class="text-[10px] font-bold bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded-full">0</span>
            </div>
            <div id="col-completed" class="space-y-4"></div>
        </div>
    </div>

    <div id="listView" class="hidden overflow-x-auto bg-white rounded-xl border border-slate-200 shadow-sm">
        <table class="w-full text-left border-collapse">
            <thead class="bg-slate-50 border-b border-slate-100">
                <tr>
                    <th class="p-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Task</th>
                    <th class="p-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Category</th>
                    <th class="p-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Priority</th>
                    <th class="p-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Status</th>
                    <th class="p-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Deadline</th>
                    <th class="p-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Actions</th>
                </tr>
            </thead>
            <tbody id="listContainer"></tbody>
        </table>
    </div>

  </main>

  <div id="collabDrawer" class="fixed inset-y-0 right-0 w-96 bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300 border-l border-slate-200 flex flex-col">
    <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
        <div>
            <h3 class="font-bold text-slate-900">Collaboration Space</h3>
            <p id="activeTaskTitle" class="text-xs text-indigo-600 font-bold truncate max-w-[200px]"></p>
        </div>
        <button onclick="closeCollab()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
    </div>
    
    <div id="commentList" class="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar"></div>

    <div class="p-4 border-t border-slate-100 space-y-3">
        <div class="flex gap-2">
            <button onclick="sendReminder('email')" class="flex-1 py-2 bg-slate-800 text-white rounded-lg text-[10px] font-bold hover:bg-slate-900"><i class="far fa-envelope mr-1"></i> EMAIL</button>
            <button onclick="sendReminder('whatsapp')" class="flex-1 py-2 bg-emerald-600 text-white rounded-lg text-[10px] font-bold hover:bg-emerald-700 cursor-not-allowed opacity-60" disabled title="WhatsApp reminders coming soon"><i class="fab fa-whatsapp mr-1"></i> WHATSAPP</button>
        </div>
        <!-- <div class="flex gap-2">
            <input type="text" id="commentInput" placeholder="Write a note..." class="flex-1 bg-slate-100 border-none rounded-xl px-4 py-2 text-sm focus:ring-1 focus:ring-indigo-500">
            <button onclick="addComment()" class="bg-indigo-600 text-white p-2 rounded-xl w-10 h-10 flex items-center justify-center transition-transform active:scale-90"><i class="fas fa-paper-plane text-xs"></i></button>
        </div> -->
    </div>
  </div>

  <div id="modalBackdrop" onclick="handleOutsideClick(event)" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-[600px] p-8 shadow-2xl relative" onclick="event.stopPropagation()">
        <button onclick="closeModals()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition-colors">
            <i class="fas fa-times text-lg"></i>
        </button>
      <h3 class="text-xl font-bold mb-6">New Operation</h3>
      <form id="taskForm" class="space-y-4">
        <input type="text" id="taskTitle" placeholder="Task Name" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none" required>
        <div class="grid grid-cols-2 gap-4">
          <select id="taskRole" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none">
          </select>
          <select id="taskPriority" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none">
            <option value="high">High</option><option value="medium" selected>Medium</option><option value="low">Low</option>
          </select>
        </div>
        <div class="grid grid-cols-2 gap-4">
            <input type="date" id="taskDate" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none" required>
            <input type="text" id="taskPhone" placeholder="Phone (WhatsApp)" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none" required>
        </div>
        <input type="email" id="taskOwner" placeholder="Assignee Email" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none" required>
        <div class="flex gap-3 mt-6">
            <button type="button" onclick="closeModals()" class="flex-1 py-4 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-all">Cancel</button>
            <button type="submit" class="flex-[2] py-4 bg-teal-600 text-white rounded-xl font-bold hover:bg-teal-700 transition-all">Deploy Task</button>
        </div>
      </form>
    </div>
  </div>

<script>

const API_BASE_URL = '/api';
let tasks = [];
let activeTaskId = null;
let isSummaryVisible = false;
let currentView = 'kanban';

/**
 * Utility: Standard Response Handler
 */
async function handleResponse(response) {
    if (!response.ok) {
        const errData = await response.json().catch(() => ({}));
        throw new Error(errData.message || `Server Error: ${response.status}`);
    }
    return response.json();
}

/**
 * INITIALIZATION & READ (GET)
 * Replaces localStorage loading with an async fetch
 */
async function init() {
    try {
        await loadStaffDropdown();
        const response = await fetch(`${API_BASE_URL}/tasks`);
        tasks = await handleResponse(response);        
        
        renderAll();
        updateExecutiveSummary();
        
        setInterval(refreshDataQuietly, 30000);
        setInterval(autoCheckReminders, 60000);
    } catch (err) {
        console.error("Init Error:", err);
        showToast("SYNC ERROR", "Failed to load tasks. Try again.", "warning");
    }
}

async function refreshDataQuietly() {
    try {
        const response = await fetch(`${API_BASE_URL}/tasks`);
        tasks = await response.json();
        renderAll();
        if (isSummaryVisible) updateExecutiveSummary();
    } catch (e) { /* Silent fail for background tasks */ }
}

/**
 * CREATE (POST)
 * Submits new operation to the backend
 */
document.getElementById('taskForm').onsubmit = async (e) => {
    e.preventDefault();
    
    const newTask = {
        title: document.getElementById('taskTitle').value,
        role: document.getElementById('taskRole').value,
        priority: document.getElementById('taskPriority').value,
        owner: document.getElementById('taskOwner').value,
        phone: document.getElementById('taskPhone').value,
        dueDate: document.getElementById('taskDate').value,
        status: 'pending',
        comments: []
    };

    try {
        const response = await fetch(`${API_BASE_URL}/tasks`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newTask)
        });
        
        const savedTask = await handleResponse(response);
        tasks.unshift(savedTask); // Add with the DB-generated ID
        
        renderAll();
        closeModals();
        e.target.reset();
        showToast("DEPLOYED", "Task synced successfully.", "info");
    } catch (err) {
        showToast("SAVE FAILED", err.message, "warning");
    }
};

/**
 * UPDATE STATUS (PATCH)
 * Handles Kanban drag-and-drop syncing
 */
async function drop(ev, newStatus) {
    ev.preventDefault();
    const id = ev.dataTransfer.getData("taskId");
    
    // Optimistic UI Update
    const originalTasks = [...tasks];
    tasks = tasks.map(t => t.id == id ? {...t, status: newStatus} : t);
    renderAll();

    try {
        const response = await fetch(`${API_BASE_URL}/tasks/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus })
        });
        await handleResponse(response);
        updateExecutiveSummary();
        showToast("SYNCED", "Status updated successfully.", "info");
    } catch (err) {
        tasks = originalTasks; // Rollback on failure
        renderAll();
        showToast("UPDATE FAILED", "Reverting local changes.", "warning");
    }
}

/**
 * COMMENTS (POST to Sub-resource)
 */
async function addComment() {
    const input = document.getElementById('commentInput');
    if (!input.value) return;
    
    const payload = {
        text: input.value,
        time: new Date().toLocaleTimeString()
    };

    try {
        const response = await fetch(`${API_BASE_URL}/tasks/${activeTaskId}/comments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const updatedTask = await handleResponse(response);
        tasks = tasks.map(t => t.id === activeTaskId ? updatedTask : t);
        
        input.value = '';
        renderComments();
    } catch (err) {
        showToast("COMMENT ERROR", "Could not save note.", "warning");
    }
}

/**
 * DELETE (DELETE)
 */
async function deleteTask(id) {
    if (!confirm('Permanently delete this operation from the records?')) return;
    
    try {
        const response = await fetch(`${API_BASE_URL}/tasks/${id}`, {
            method: 'DELETE'
        });
        await handleResponse(response);
        
        tasks = tasks.filter(t => t.id !== id);
        renderAll();
        showToast("REMOVED", "Operation deleted.", "info");
    } catch (err) {
        showToast("DELETE ERROR", "Could not remove task.", "warning");
    }
}

/**
 * EXTERNAL TRIGGERS (Email/WhatsApp)
 */
async function sendReminder(type) {
    const task = tasks.find(t => t.id === activeTaskId);

    const emailBtn = document.querySelector("button[onclick*='email']");
    const whatsappBtn = document.querySelector("button[onclick*='whatsapp']");
    const activeBtn = type === 'email' ? emailBtn : whatsappBtn;
    const originalHTML = activeBtn.innerHTML;
    
    try {

        emailBtn.disabled = true;
        whatsappBtn.disabled = true;
        activeBtn.innerHTML = `<i class="fas fa-circle-notch animate-spin-fast mr-1"></i> SENDING...`;
        activeBtn.classList.add('opacity-70', 'cursor-not-allowed');
        const response = await fetch(`${API_BASE_URL}/notify`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                taskId: activeTaskId, 
                channel: type,
                recipient: type === 'email' ? task.owner : task.phone 
            })
        });
        await handleResponse(response);
        
        showToast(`${type.toUpperCase()} SENT`, `Notification out to ${task.owner}`, "success");
        
        // Optionally fetch task again to show the system comment logged by backend
        refreshDataQuietly();
        if (activeTaskId) renderComments();
    } catch (err) {
        showToast("NOTIFY ERROR", "Messaging service unavailable.", "warning");
    } finally {
        emailBtn.disabled = false;
        whatsappBtn.disabled = false;
        activeBtn.innerHTML = originalHTML;
        activeBtn.classList.remove('opacity-70', 'cursor-not-allowed');
    }
}

/**
 * Fetch staff and populate dropdown
 */
async function loadStaffDropdown() {
    try {
        const response = await fetch(`${API_BASE_URL}/staff`);
        const staffList = await response.json();
        const select = document.getElementById('taskRole');
        
        select.innerHTML = '<option value="" disabled selected>Select Assignee</option>';
        
        staffList.forEach(staff => {
            const option = document.createElement('option');
            option.value = staff.name; 
            option.textContent = `${staff.name} (${staff.role})`;
            
            option.dataset.email = staff.email;
            option.dataset.phone = staff.phone || "";
            select.appendChild(option);
        });
    } catch (err) {
        console.error("Staff Load Error:", err);
    }
}

/**
 * Auto-fill fields when staff is selected
 */
document.getElementById('taskRole').addEventListener('change', function(e) {
    const selectedOption = e.target.options[e.target.selectedIndex];
    if (selectedOption.dataset.email) {
        document.getElementById('taskOwner').value = selectedOption.dataset.email;
    }
    if (selectedOption.dataset.phone) {
        document.getElementById('taskPhone').value = selectedOption.dataset.phone;
    }
});

/**
 * Handle clicking outside the modal
 */
function handleOutsideClick(event) {
    if (event.target.id === 'modalBackdrop') {
        closeModals();
    }
}

/**
 * UI & VIEW LOGIC (Unchanged from original but supports async state)
 */
function setView(view) {
    currentView = view;
    const kanban = document.getElementById('kanbanView');
    const list = document.getElementById('listView');
    const kBtn = document.getElementById('kanbanBtn');
    const lBtn = document.getElementById('listBtn');

    if(view === 'list') {
        kanban.classList.add('hidden');
        list.classList.remove('hidden');
        lBtn.classList.add('bg-white', 'shadow-sm');
        kBtn.classList.remove('bg-white', 'shadow-sm');
    } else {
        list.classList.add('hidden');
        kanban.classList.remove('hidden');
        kBtn.classList.add('bg-white', 'shadow-sm');
        lBtn.classList.remove('bg-white', 'shadow-sm');
    }
    renderAll();
}

function updateExecutiveSummary() {
    const today = new Date();
    const nextWeek = new Date();
    nextWeek.setDate(today.getDate() + 7);

    const pendingCount = tasks.filter(t => t.status !== 'completed').length;
    const dueSoon = tasks.filter(t => new Date(t.dueDate) <= nextWeek && t.status !== 'completed').length;
    document.getElementById('weeklyText').innerText = `You have ${pendingCount} active operations. ${dueSoon} tasks are due within 7 days.`;

    const highPriority = tasks.filter(t => t.priority === 'high' && t.status !== 'completed').slice(0, 3);
    document.getElementById('highPriorityList').innerHTML = highPriority.map(t => `
        <div class="flex items-center gap-2 text-xs font-bold text-slate-700">
            <span class="w-1 h-1 bg-red-500 rounded-full"></span> ${t.title}
        </div>
    `).join('') || '<p class="text-xs text-slate-400">None.</p>';

    const completed = tasks.filter(t => t.status === 'completed').length;
    const total = tasks.length || 1;
    const score = Math.round((completed / total) * 100);
    document.getElementById('efficiencyVal').innerText = `${score}%`;
    document.getElementById('efficiencyBar').style.width = `${score}%`;
}

function renderAll() {
    const filterRole = document.getElementById('filterRole').value;
    const filterPriority = document.getElementById('filterPriority').value;
    const search = document.getElementById('searchInput').value.toLowerCase();

    const filtered = tasks.filter(t => {
        const matchRole = filterRole === 'All' || t.role === filterRole;
        const matchPriority = filterPriority === 'All' || t.priority === filterPriority;
        const matchSearch = t.title.toLowerCase().includes(search) || t.owner.toLowerCase().includes(search);
        return matchRole && matchPriority && matchSearch;
    });

    if (currentView === 'kanban') {
        ['pending', 'progress', 'completed'].forEach(status => {
            const col = document.getElementById(`col-${status}`);
            const count = document.getElementById(`count-${status}`);
            const list = filtered.filter(t => t.status === status);
            count.innerText = list.length;
            col.innerHTML = list.map(t => createTaskCard(t)).join('');
        });
    } else {
        renderListView(filtered);
    }
}

function renderListView(filteredTasks) {
    const container = document.getElementById('listContainer');
    container.innerHTML = filteredTasks.map(t => {
        const priorityBadge = { high: 'bg-red-100 text-red-600', medium: 'bg-amber-100 text-amber-600', low: 'bg-indigo-100 text-indigo-600' }[t.priority];
        const statusBadge = { pending: 'bg-slate-100 text-slate-600', progress: 'bg-indigo-100 text-indigo-600', completed: 'bg-emerald-100 text-emerald-600' }[t.status];
        return `
            <tr class="border-b border-slate-50 hover:bg-slate-100 transition-colors">
                <td class="p-4">
                    <p class="font-bold text-sm text-slate-800">${t.title}</p>
                    <p class="text-[10px] text-slate-400">${t.owner}</p>
                </td>
                <td class="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider">${t.role}</td>
                <td class="p-4"><span class="px-2.5 py-1 rounded-full text-[10px] font-black uppercase ${priorityBadge}">${t.priority}</span></td>
                <td class="p-4"><span class="px-2.5 py-1 rounded-full text-[10px] font-black uppercase ${statusBadge}">${t.status}</span></td>
                <td class="p-4 text-xs font-bold text-slate-600">${t.dueDate}</td>
                <td class="p-4">
                    <div class="flex gap-2">
                        <button onclick="openCollab(${t.id})" class="text-slate-400 hover:text-indigo-600"><i class="fas fa-comment-dots"></i></button>
                        <button onclick="deleteTask(${t.id})" class="text-slate-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                    </div>
                </td>
            </tr>
        `;
    }).join('') || '<tr><td colspan="6" class="p-10 text-center text-slate-300">No operations found.</td></tr>';
}

function createTaskCard(t) {
    const priorityColor = { high: 'bg-red-500', medium: 'bg-amber-500', low: 'bg-indigo-500' }[t.priority];
    const isOverdue = new Date(t.dueDate) < new Date() && t.status !== 'completed';
    return `
        <div draggable="true" ondragstart="drag(event, ${t.id})" class="bg-white p-4 rounded-2xl border ${isOverdue ? 'border-red-200' : 'border-slate-200'} shadow-sm hover:shadow-md transition-all cursor-move group">
            <div class="flex items-center justify-between mb-2">
                <span class="text-[9px] font-black uppercase text-slate-400 tracking-widest">${t.role}</span>
                <div class="w-2 h-2 rounded-full ${priorityColor}"></div>
            </div>
            <h4 class="font-bold text-slate-800 text-sm mb-1 group-hover:text-indigo-600 transition-colors">${t.title}</h4>
            <div class="flex items-center gap-2 mb-3">
                <i class="far fa-clock text-[10px] text-slate-400"></i>
                <span class="text-[10px] font-bold ${isOverdue ? 'text-red-500' : 'text-slate-400'}">${t.dueDate}</span>
            </div>
            <div class="flex items-center justify-between mt-4">
                <div class="flex items-center gap-2">
                    <div class="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center text-[10px] font-bold text-slate-500">
                        ${t.owner.charAt(0).toUpperCase()}
                    </div>
                    <span class="text-[10px] text-slate-400 font-medium truncate w-20">${t.owner.split('@')[0]}</span>
                </div>
                <div class="flex gap-1">
                    <button onclick="openCollab(${t.id})" class="p-1.5 text-slate-300 hover:text-indigo-500"><i class="far fa-comment-dots"></i></button>
                    <button onclick="deleteTask(${t.id})" class="p-1.5 text-slate-300 hover:text-red-500"><i class="far fa-trash-alt text-xs"></i></button>
                </div>
            </div>
        </div>
    `;
}

function allowDrop(ev) { ev.preventDefault(); }
function drag(ev, id) { ev.dataTransfer.setData("taskId", id); }

function openCollab(id) {
    activeTaskId = id;
    const task = tasks.find(t => t.id == id);
    document.getElementById('activeTaskTitle').innerText = task.title;
    document.getElementById('collabDrawer').classList.remove('translate-x-full');
    renderComments();
}

function closeCollab() { document.getElementById('collabDrawer').classList.add('translate-x-full'); }

function formatTimeLocal(dateStr) {
    const localDate = new Date(dateStr.replace(' ', 'T'));

    return localDate.toLocaleString('en-KE', {
        weekday: 'short',
        day: '2-digit',
        month: 'short',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
    });
}

function renderComments() {
    const task = tasks.find(t => t.id == activeTaskId);
    const container = document.getElementById('commentList');
    container.innerHTML = task.comments?.map(c => `
        <div class="bg-slate-50 p-3 rounded-2xl rounded-tr-none ml-4 border border-slate-100 mb-2">
            <p class="text-xs text-slate-700">${c.text}</p>
            <span class="text-[8px] font-bold text-slate-400 uppercase mt-1 block"> ${formatTimeLocal(c.time)}</span>
        </div>
    `).join('') || '<p class="text-center text-slate-300 text-xs py-10">No notes.</p>';
}

function showToast(title, msg) {
    const t = document.createElement('div');
    t.className = "bg-slate-900 text-white p-4 rounded-xl shadow-2xl border-teal-500 animate-slide-in";
    t.innerHTML = `<h5 class="text-[10px] font-black text-teal-400 uppercase tracking-widest">${title}</h5><p class="text-xs text-slate-300">${msg}</p>`;
    document.getElementById('toastContainer').appendChild(t);
    setTimeout(() => t.remove(), 3000);
}

function autoCheckReminders() {
    const today = new Date().toISOString().split('T')[0];
    tasks.forEach(t => {
        if (t.status !== 'completed' && t.dueDate < today) {
            showToast("OVERDUE ALERT", `${t.title} requires attention!`, "warning");
        }
    });
}

function openTaskModal() { document.getElementById('modalBackdrop').classList.remove('hidden'); }
function closeModals() { document.getElementById('modalBackdrop').classList.add('hidden'); }

function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("Executive Operations Report", 14, 20);
    const data = tasks.map(t => [t.title, t.role, t.status, t.dueDate, t.owner]);
    doc.autoTable({ head: [['Task', 'Category', 'Status', 'Deadline', 'Lead']], body: data, startY: 35 });
    doc.save(`Report_${new Date().toISOString().split('T')[0]}.pdf`);
}

// Start App
init();
</script>