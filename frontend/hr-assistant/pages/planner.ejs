<style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
    :root { font-family: 'Plus Jakarta Sans', sans-serif; }
    
    .glass-panel { background: white; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02); }
    
    .animate-fade-up { animation: fade-in-up 0.4s ease-out forwards; }
    @keyframes fade-in-up { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .custom-scroll::-webkit-scrollbar { width: 5px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

    .filter-pill.active { background-color: #0f172a; color: white; border-color: #0f172a; }
    
    .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
</style>

<div class="max-w-full mx-auto">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-10 gap-6 animate-fade-up">
        <div>
            <h1 class="text-3xl font-black text-slate-900 tracking-tight">Operations Planner</h1>
            <p id="statsText" class="text-slate-500 font-bold text-sm">0 of 0 tasks completed</p>
        </div>
        <div class="flex flex-col items-end gap-2">
            <span id="progressPercent" class="text-[10px] font-black text-teal-600 uppercase tracking-widest">0% Complete</span>
            <div class="w-64 bg-slate-100 h-3 rounded-full overflow-hidden border border-slate-200">
                <div id="progressBar" class="bg-teal-500 h-full transition-all duration-700 ease-out" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <div class="glass-panel rounded-xl p-4 mb-8 flex flex-wrap items-center justify-between gap-4 animate-fade-up" style="animation-delay: 0.1s;">
        <div class="flex flex-wrap items-center gap-2">
                <button onclick="setFilterType('all')" class="filter-pill active px-4 py-1.5 rounded-full border border-slate-200 text-[10px] font-black uppercase transition-all">All</button>
                <button onclick="setFilterType('daily')" class="filter-pill px-4 py-1.5 rounded-full border border-slate-200 text-[10px] font-black uppercase transition-all">Daily</button>
                <button onclick="setFilterType('weekly')" class="filter-pill px-4 py-1.5 rounded-full border border-slate-200 text-[10px] font-black uppercase transition-all">Weekly</button>
                <button onclick="setFilterType('monthly')" class="filter-pill px-4 py-1.5 rounded-full border border-slate-200 text-[10px] font-black uppercase transition-all">Monthly</button>            

            <div class="flex items-center gap-2 bg-slate-50 px-4 py-2 rounded-full border border-slate-200">
                <i class="far fa-calendar text-slate-400 text-[10px]"></i>
                <input type="date" id="historyFilter" oninput="renderPlanner()" class="bg-transparent border-none text-[10px] font-black text-slate-700 focus:ring-0 p-0 cursor-pointer">                
            </div>
        </div>

        <div class="relative">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-[10px]"></i>
            <input type="text" id="searchInput" oninput="renderPlanner()" placeholder="Search by task name..." 
                class="pl-8 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-full text-xs font-bold text-slate-700 outline-none focus:border-teal-500 w-56 transition-all">
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8" id="plannerGrid">
        
        <div class="space-y-4 animate-fade-up" style="animation-delay: 0.2s;">
            <div class="flex justify-between items-center px-2">
                <h3 class="text-[11px] font-black text-slate-400 uppercase tracking-widest flex items-center">
                    <span class="status-dot bg-slate-300"></span> Pending
                </h3>
                <span id="count-pending" class="bg-slate-100 text-slate-500 text-[10px] font-black px-2 py-0.5 rounded-full">0</span>
            </div>
            <div id="col-pending" class="space-y-4 min-h-[500px] bg-slate-50/50 p-4 rounded-xl border-2 border-dashed border-slate-300 custom-scroll overflow-y-auto max-h-[600px]"></div>
        </div>

        <div class="space-y-4 animate-fade-up" style="animation-delay: 0.3s;">
            <div class="flex justify-between items-center px-2">
                <h3 class="text-[11px] font-black text-teal-600 uppercase tracking-widest flex items-center">
                    <span class="status-dot bg-teal-500"></span> Completed
                </h3>
                <span id="count-completed" class="bg-teal-50 text-teal-600 text-[10px] font-black px-2 py-0.5 rounded-full">0</span>
            </div>
            <div id="col-completed" class="space-y-4 min-h-[500px] bg-teal-50/20 p-4 rounded-xl border-2 border-dashed border-teal-200 custom-scroll overflow-y-auto max-h-[600px]"></div>
        </div>

        <div class="space-y-4 animate-fade-up" style="animation-delay: 0.4s;">
            <div class="flex justify-between items-center px-2">
                <h3 class="text-[11px] font-black text-rose-400 uppercase tracking-widest flex items-center">
                    <span class="status-dot bg-rose-400"></span> Suspended
                </h3>
                <span id="count-suspended" class="bg-rose-50 text-rose-400 text-[10px] font-black px-2 py-0.5 rounded-full">0</span>
            </div>
            <div id="col-suspended" class="space-y-4 min-h-[500px] bg-rose-50/20 p-4 rounded-xl border-2 border-dashed border-rose-200 custom-scroll overflow-y-auto max-h-[600px]"></div>
        </div>

    </div>
</div>

<script>
    let allTasks = [];
    let activeFilterType = 'all';
    const $ = id => document.getElementById(id);

    // 1. Fetch data from the Unified Planner API
    async function fetchPlannerData() {
        try {
            const res = await fetch('/api/hr/planner');
            if (!res.ok) throw new Error("Network error");
            allTasks = await res.json();
            renderPlanner();
        } catch (e) {
            console.error("Failed to fetch planner data:", e);
        }
    }

    async function updateStatus(id, newStatus, source) {
        const task = allTasks.find(t => t.id === id && t.source === source);
        if (!task) return;

        const originalStatus = task.status;
        task.status = newStatus;
        renderPlanner();

        try {
            const res = await fetch('/api/hr/planner/status', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    id: id, 
                    status: newStatus, 
                    source: task.source 
                })
            });
            
            if(!res.ok) throw new Error();
        } catch (e) {
            task.status = originalStatus;
            renderPlanner();
            alert("Update failed. Please try again.");
        }
    }

    // 3. Filtering logic
    function setFilterType(type) {
        activeFilterType = type;
        document.querySelectorAll('.filter-pill').forEach(p => {
            p.classList.toggle('active', p.innerText.toLowerCase() === type);
        });
        renderPlanner();
    }

    function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    // 4. Render the Kanban columns
    function renderPlanner() {
        const selectedDate = new Date($('historyFilter').value);
        const searchQuery = $('searchInput').value.toLowerCase();

        let filtered = allTasks.filter(t => {
            const tDate = new Date(t.event_date);
            let timeMatch = false;
            if (activeFilterType === 'all') timeMatch = true;
            else if (activeFilterType === 'daily') timeMatch = tDate.toDateString() === selectedDate.toDateString();
            else if (activeFilterType === 'weekly') timeMatch = getWeekNumber(tDate) === getWeekNumber(selectedDate);
            else timeMatch = tDate.getMonth() === selectedDate.getMonth() && tDate.getFullYear() === selectedDate.getFullYear();

            const searchMatch = t.item_desc.toLowerCase().includes(searchQuery);
            return timeMatch && searchMatch;
        });

        const cols = {
            pending: $('col-pending'),
            completed: $('col-completed'),
            suspended: $('col-suspended')
        };
        Object.values(cols).forEach(c => c.innerHTML = '');

        let counts = { pending: 0, completed: 0, suspended: 0 };

        filtered.forEach(t => {
            counts[t.status]++;
            const card = document.createElement('div');
            card.className = `glass-panel p-5 rounded-2xl border-l-4 transition-all hover:shadow-md animate-fade-up ${
                t.status === 'pending' ? 'border-slate-300' : t.status === 'completed' ? 'border-teal-500' : 'border-rose-400'
            }`;
            
            card.innerHTML = `
                <div class="mb-3">
                    <div class="flex justify-between items-start">
                        <span class="text-[9px] font-black uppercase tracking-widest text-slate-400">${t.type}</span>
                        <span class="text-[8px] font-black uppercase px-1.5 py-0.5 rounded bg-slate-100 text-slate-500">${t.source}</span>
                    </div>
                    <h4 class="text-sm font-black text-slate-800 leading-tight mt-1">${t.item_desc}</h4>
                </div>
                <div class="flex gap-2 pt-3 border-t border-slate-50">
                    ${t.status !== 'pending' ? `<button onclick="updateStatus(${t.id}, 'pending', '${t.source}')" class="text-[9px] font-black uppercase text-slate-400 hover:text-slate-600">Re-open</button>` : ''}
                    ${t.status !== 'completed' ? `<button onclick="updateStatus(${t.id}, 'completed', '${t.source}')" class="text-[9px] font-black uppercase text-teal-600 hover:text-teal-700">Complete</button>` : ''}
                    ${t.status !== 'suspended' ? `<button onclick="updateStatus(${t.id}, 'suspended', '${t.source}')" class="text-[9px] font-black uppercase text-rose-400 hover:text-rose-500 ml-auto">Suspend</button>` : ''}
                </div>
            `;
            cols[t.status].appendChild(card);
        });

        // Update UI Stats
        $('count-pending').innerText = counts.pending;
        $('count-completed').innerText = counts.completed;
        $('count-suspended').innerText = counts.suspended;

        const total = filtered.length;
        const progress = total > 0 ? Math.round((counts.completed / total) * 100) : 0;
        
        $('statsText').innerText = `${counts.completed} of ${total} activities completed`;
        $('progressBar').style.width = `${progress}%`;
        $('progressPercent').innerText = `${progress}% Complete`;
    }

    function init() {
        $('historyFilter').valueAsDate = new Date();
        fetchPlannerData();
    }
    
    init();
</script>