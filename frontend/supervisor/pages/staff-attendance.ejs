<div id="toastContainer" class="fixed top-6 right-6 z-[100] flex flex-col gap-3 w-80 pointer-events-none"></div>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
    :root { font-family: 'Plus Jakarta Sans', sans-serif; }

    @keyframes slide-in-right {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes fade-in-up {
        from { transform: translateY(10px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    .animate-toast { animation: slide-in-right 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    .animate-fade-up { animation: fade-in-up 0.4s ease-out forwards; }

    .glass-panel {
        background: white;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
    }
    
    .view-pill {
        padding: 0.2rem 1rem;        
        border-radius: 0.75rem;   
        font-size: 0.75rem;            
        font-weight: 700;            
        text-transform: uppercase;
        letter-spacing: 0.08em;       

        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 64px;

        border: 1px solid transparent;
        transition: all 200ms ease;
        background-color: transparent;
        cursor: pointer;
    }

    .view-pill.active {
        background-color: #0f172a;
        color: #ffffff;
        border-color: #0f172a;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
    }

    .view-pill.inactive {
        color: #64748b;             
    }

    .view-pill.inactive:hover {
        background-color: #f8fafc;     
        color: #334155;                
        border-color: #e2e8f0;         
    }

    .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>

<div class="max-w-full mx-auto py-2">
    
    <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-8 animate-fade-up">
        <div>
            <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight">Attendance Logs</h1>
            <p id="currentPeriodLabel" class="text-slate-500 font-medium text-sm mt-1">Loading dates...</p>
        </div>

        <div class="flex flex items-center justify-end gap-3">
            <div class="flex items-center gap-2 bg-white p-1 rounded-xl border border-slate-200 shadow-sm p-2">
              <button onclick="setViewMode('day')" id="btnDay" class="view-pill active">Day</button>
              <button onclick="setViewMode('week')" id="btnWeek" class="view-pill inactive">Week</button>
              <button onclick="setViewMode('month')" id="btnMonth" class="view-pill inactive">Month</button>
            </div>
            <div class="flex items-center gap-2 bg-white p-1 rounded-xl border border-slate-200 shadow-sm">
                <button onclick="navigateDate(-1)" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-slate-50 text-slate-400 transition-colors"><i class="fas fa-chevron-left text-xs"></i></button>
                <input type="date" id="dateInput" onchange="jumpToDate(this.value)" class="border-none py-1 px-2 text-xs font-bold text-slate-700 focus:ring-0 cursor-pointer">
                <button onclick="navigateDate(1)" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-slate-50 text-slate-400 transition-colors"><i class="fas fa-chevron-right text-xs"></i></button>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <div class="lg:col-span-8 space-y-6 animate-fade-up" style="animation-delay: 0.1s;">
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="glass-panel p-5 rounded-2xl border-l-4 border-l-teal-500">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Present</p>
                    <span id="statPresent" class="text-3xl font-black text-slate-800">0</span>
                </div>
                <div class="glass-panel p-5 rounded-2xl border-l-4 border-l-rose-500">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Absent</p>
                    <span id="statAbsent" class="text-3xl font-black text-slate-800">0</span>
                </div>
                <div class="glass-panel p-5 rounded-2xl border-l-4 border-l-indigo-500">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Rate</p>
                    <span id="statRate" class="text-3xl font-black text-slate-800">0%</span>
                </div>
                <div class="glass-panel p-5 rounded-2xl bg-slate-900 border-none">
                    <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Total Staff</p>
                    <span id="statTotal" class="text-3xl font-black text-slate-800">0</span>
                </div>
            </div>

            <div class="glass-panel rounded-[0.5rem] overflow-hidden flex flex-col min-h-[500px]">
                <div class="p-5 border-b border-slate-100 bg-slate-50/50 flex items-center justify-between">
                    <div class="relative w-full max-w-xs">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                        <input id="searchInput" oninput="renderTable()" type="text" placeholder="Search staff..." class="w-full pl-10 pr-4 py-2.5 bg-white border border-slate-200 rounded-xl text-xs font-semibold outline-none focus:border-teal-500 transition-all">
                    </div>
                    <div class="hidden md:block text-[10px] font-bold text-slate-400 uppercase tracking-wider">
                        Attendance Records
                    </div>
                </div>
                
                <div class="overflow-x-auto custom-scroll flex-1">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-white sticky top-0 z-10">
                            <tr class="text-[10px] font-black text-slate-400 uppercase tracking-[0.15em] border-b border-slate-100">
                                <th class="px-6 py-4 bg-slate-50/30">Employee</th>
                                <th class="px-6 py-4 bg-slate-50/30">Status</th>
                                <th class="px-6 py-4 bg-slate-50/30">Timing</th>
                                <th class="px-6 py-4 bg-slate-50/30">Date</th>
                                <th class="px-6 py-4 bg-slate-50/30 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody" class="divide-y divide-slate-50">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="lg:col-span-4 animate-fade-up" style="animation-delay: 0.2s;">
            <div class="sticky top-8 space-y-6">
                
                <div class="bg-slate-900 text-white p-8 rounded-[1rem] shadow-2xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-teal-500 rounded-full blur-[60px] opacity-20 -mr-10 -mt-10"></div>
                    
                    <h3 class="relative text-lg font-black tracking-tight mb-6 flex items-center gap-2">
                        <i class="fas fa-bolt text-teal-400"></i> Attendance Entry
                    </h3>
                    
                    <form id="attendanceForm" class="relative space-y-4">
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1 mb-1 block">Staff Member</label>
                            <select id="formStaffId" required class="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl text-sm font-semibold text-slate-200 outline-none focus:border-teal-500 transition-all"></select>
                        </div>
                        
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1 mb-1 block">Attendance Status</label>
                            <div class="grid grid-cols-3 gap-2">
                                <label class="cursor-pointer">
                                    <input type="radio" name="status" value="present" class="peer sr-only" checked onchange="toggleTimeVisibility('form')">
                                    <div class="py-2 text-center rounded-lg bg-slate-800 border border-slate-700 text-slate-400 text-xs font-bold peer-checked:bg-teal-600 peer-checked:text-white peer-checked:border-teal-500 transition-all">Present</div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="status" value="absent" class="peer sr-only" onchange="toggleTimeVisibility('form')">
                                    <div class="py-2 text-center rounded-lg bg-slate-800 border border-slate-700 text-slate-400 text-xs font-bold peer-checked:bg-rose-600 peer-checked:text-white peer-checked:border-rose-500 transition-all">Absent</div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="status" value="on-leave" class="peer sr-only" onchange="toggleTimeVisibility('form')">
                                    <div class="py-2 text-center rounded-lg bg-slate-800 border border-slate-700 text-slate-400 text-xs font-bold peer-checked:bg-amber-600 peer-checked:text-white peer-checked:border-amber-500 transition-all">Leave</div>
                                </label>
                            </div>
                        </div>

                        <div id="timeContainerForm" class="grid grid-cols-2 gap-3 pt-2">
                            <div class="group cursor-pointer" onclick="openTimePicker('formTimeIn')">
                                <label class="text-[9px] font-bold text-slate-500 uppercase tracking-widest ml-1 block mb-1">Time In</label>
                                <div class="relative">
                                    <input type="text" id="formTimeIn" readonly value="08:00" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl text-sm font-bold text-white text-center cursor-pointer group-hover:border-teal-500 transition-all">
                                </div>
                            </div>
                            <div class="group cursor-pointer" onclick="openTimePicker('formTimeOut')">
                                <label class="text-[9px] font-bold text-slate-500 uppercase tracking-widest ml-1 block mb-1">Time Out</label>
                                <div class="relative">
                                    <input type="text" id="formTimeOut" readonly value="17:00" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl text-sm font-bold text-white text-center cursor-pointer group-hover:border-teal-500 transition-all">
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="w-full py-4 mt-2 bg-teal-500 hover:bg-teal-400 text-slate-900 font-black text-sm uppercase tracking-wider rounded-xl transition-all shadow-lg hover:shadow-teal-500/20 active:scale-[0.98]">
                            Mark Attendance
                        </button>
                    </form>
                </div>
                
                <div class="bg-indigo-50 border border-indigo-100 p-4 rounded-2xl flex gap-3 items-start">
                    <i class="fas fa-info-circle text-indigo-500 mt-1"></i>
                    <p class="text-xs text-indigo-800 font-medium leading-relaxed">
                        Entries default to the selected date above. Use the table action buttons to edit past records.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="editModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-600/20 backdrop-blur-sm transition-opacity" onclick="closeEditModal()"></div>
    <div class="relative bg-white w-full max-w-md rounded-[1rem] p-8 shadow-2xl animate-fade-up">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-black text-slate-900">Update Record</h3>
            <button onclick="closeEditModal()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-rose-100 hover:text-rose-500 transition-colors flex items-center justify-center"><i class="fas fa-times"></i></button>
        </div>
        
        <form id="editForm" class="space-y-5">
            <input type="hidden" id="editRecordId">
            
            <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-teal-600 font-bold text-sm">
                    <i class="fas fa-user"></i>
                </div>
                <div>
                    <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest block">Staff Member</label>
                    <div id="editStaffName" class="font-bold text-slate-800">John Doe</div>
                </div>
            </div>

            <div>
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Status</label>
                <select id="editStatus" onchange="toggleTimeVisibility('edit')" class="w-full p-3 bg-white border border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-teal-500">
                    <option value="present">Present</option>
                    <option value="absent">Absent</option>
                    <option value="on-leave">On Leave</option>
                </select>
            </div>

            <div id="timeContainerEdit" class="grid grid-cols-2 gap-4">
                <div class="cursor-pointer" onclick="openTimePicker('editTimeIn')">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Time In</label>
                    <input type="text" id="editTimeIn" readonly class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-800 text-center cursor-pointer hover:bg-white hover:border-teal-500 transition-all">
                </div>
                <div class="cursor-pointer" onclick="openTimePicker('editTimeOut')">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Time Out</label>
                    <input type="text" id="editTimeOut" readonly class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-800 text-center cursor-pointer hover:bg-white hover:border-teal-500 transition-all">
                </div>
            </div>

            <button type="submit" class="w-full py-4 bg-slate-900 text-white font-bold rounded-xl hover:bg-teal-600 transition-colors shadow-lg">
                Save Changes
            </button>
        </form>
    </div>
</div>

<div id="timePicker" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="closeTimePicker()"></div>
    <div class="relative bg-white p-8 rounded-[1rem] shadow-2xl text-center w-full max-w-[300px] animate-fade-up">
        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6">Select Time</p>
        
        <div class="flex items-center justify-center gap-4 mb-8 bg-slate-50 rounded-2xl p-4">
            <div class="flex flex-col items-center">
                <button onclick="adjustTime('h', 1)" class="w-8 h-8 text-slate-400 hover:text-teal-600 hover:bg-white rounded-full transition-all"><i class="fas fa-chevron-up"></i></button>
                <div id="pHour" class="text-4xl font-black text-slate-800 my-2 w-16 tabular-nums">08</div>
                <button onclick="adjustTime('h', -1)" class="w-8 h-8 text-slate-400 hover:text-teal-600 hover:bg-white rounded-full transition-all"><i class="fas fa-chevron-down"></i></button>
            </div>
            <div class="text-2xl font-black text-slate-300 pb-1">:</div>
            <div class="flex flex-col items-center">
                <button onclick="adjustTime('m', 5)" class="w-8 h-8 text-slate-400 hover:text-teal-600 hover:bg-white rounded-full transition-all"><i class="fas fa-chevron-up"></i></button>
                <div id="pMin" class="text-4xl font-black text-slate-800 my-2 w-16 tabular-nums">00</div>
                <button onclick="adjustTime('m', -5)" class="w-8 h-8 text-slate-400 hover:text-teal-600 hover:bg-white rounded-full transition-all"><i class="fas fa-chevron-down"></i></button>
            </div>
        </div>

        <button onclick="saveTimeSelection()" class="w-full py-3.5 bg-teal-500 text-white font-black uppercase tracking-widest text-xs rounded-xl shadow-lg hover:bg-teal-600 transition-all">
            Confirm Time
        </button>
    </div>
</div>

<script>
    let allAttendance = [];
    let staffList = [];
    let viewMode = 'day'; 
    let selectedDate = new Date();
    let activeTimeInputId = null;
    let pickerH = 8, pickerM = 0;

    const $ = id => document.getElementById(id);
    const api = { att: "/api/attendance", staff: "/api/staff" };

    window.onload = () => {
        updateDateLabels();
        loadData();
    };

    function showToast(title, msg) {
        const t = document.createElement('div');
        t.className = "bg-slate-900 text-white p-4 pr-6 rounded-2xl shadow-xl animate-toast flex flex-col pointer-events-auto mb-3";
        t.innerHTML = `<span class="text-[10px] font-black text-teal-400 uppercase tracking-widest">${title}</span><span class="text-xs text-slate-200 font-medium mt-0.5">${msg}</span>`;
        $("toastContainer").appendChild(t);
        setTimeout(() => {
            t.style.opacity = '0';
            t.style.transform = 'translateY(-10px)';
            setTimeout(() => t.remove(), 300);
        }, 3000);
    }

    function setViewMode(mode) {
        viewMode = mode;

        ['day', 'week', 'month'].forEach(m => {
            const btn = document.getElementById(
                `btn${m.charAt(0).toUpperCase() + m.slice(1)}`
            );

            btn.classList.remove('active', 'inactive');
            btn.classList.add(mode === m ? 'active' : 'inactive');
        });

        updateDateLabels();
        renderTable();
    }

    function navigateDate(dir) {
        if(viewMode === 'day') selectedDate.setDate(selectedDate.getDate() + dir);
        else if(viewMode === 'week') selectedDate.setDate(selectedDate.getDate() + (dir * 7));
        else selectedDate.setMonth(selectedDate.getMonth() + dir);
        updateDateLabels();
        renderTable();
    }

    function jumpToDate(val) {
        if(!val) return;
        selectedDate = new Date(val);
        updateDateLabels();
        renderTable();
    }

    function updateDateLabels() {
        const yyyy = selectedDate.getFullYear();
        const mm = String(selectedDate.getMonth() + 1).padStart(2, '0');
        const dd = String(selectedDate.getDate()).padStart(2, '0');
        $("dateInput").value = `${yyyy}-${mm}-${dd}`;

        const opts = { day: 'numeric', month: 'short', year: 'numeric' };
        let text = "";
        
        if (viewMode === 'day') {
            const isToday = new Date().toDateString() === selectedDate.toDateString();
            text = (isToday ? "Today, " : "") + selectedDate.toLocaleDateString('en-GB', opts);
        } else if (viewMode === 'week') {
            const start = new Date(selectedDate);
            text = `Week of ${start.toLocaleDateString('en-GB', opts)}`;
        } else {
            text = selectedDate.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
        }
        $("currentPeriodLabel").textContent = text;
    }

    async function loadData() {
        try {
            const [attData, staffData] = await Promise.all([
                fetch(api.att).then(r => r.json()),
                fetch(api.staff).then(r => r.json())
            ]);
            allAttendance = attData;
            staffList = staffData;
            
            populateStaffSelect();
            renderTable();
        } catch (e) {
            showToast("Connection Error", "Could not sync with server.");
        }
    }

    function populateStaffSelect() {
        const opts = '<option value="">Select Staff...</option>' + 
            staffList.map(s => `<option value="${s.id}">${s.first_name} ${s.second_name}</option>`).join('');
        $("formStaffId").innerHTML = opts;
    }

    function renderTable() {
        const tbody = $("attendanceTableBody");
        const query = $("searchInput").value.toLowerCase();
        
        const filtered = allAttendance.filter(r => {
            const rDate = new Date(r.attendance_date);
            const staff = staffList.find(s => s.id === r.staff_id) || {};

            const fullName = `${staff.first_name || ''} ${staff.second_name || ''}`.toLowerCase();
            
            let dateMatch = false;
            if (viewMode === 'day') {
                dateMatch = rDate.toDateString() === selectedDate.toDateString();
            } else if (viewMode === 'week') {
                const diff = Math.abs((selectedDate - rDate) / (1000 * 60 * 60 * 24));
                dateMatch = diff < 4; 
            } else {
                dateMatch = rDate.getMonth() === selectedDate.getMonth() && rDate.getFullYear() === selectedDate.getFullYear();
            }

            return dateMatch && fullName.includes(query);
        });

        filtered.sort((a,b) => new Date(b.attendance_date) - new Date(a.attendance_date) || b.id - a.id);

        updateStats(filtered);

        if (filtered.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="py-12 text-center text-slate-400 italic">No records found for this period.</td></tr>`;
            return;
        }

        tbody.innerHTML = filtered.map(r => {
            const staff = staffList.find(s => s.id === r.staff_id) || { first_name: 'Unknown', second_name: '', department: 'N/A' };
            const fullName = `${staff.first_name} ${staff.second_name}`;
            
            let statusBadge = '';
            if(r.status === 'present') statusBadge = `<span class="px-3 py-1.5 rounded-lg bg-teal-50 text-teal-700 text-[10px] font-black uppercase tracking-wider border border-teal-100">Present</span>`;
            else if(r.status === 'absent') statusBadge = `<span class="px-3 py-1.5 rounded-lg bg-rose-50 text-rose-700 text-[10px] font-black uppercase tracking-wider border border-rose-100">Absent</span>`;
            else statusBadge = `<span class="px-3 py-1.5 rounded-lg bg-amber-50 text-amber-700 text-[10px] font-black uppercase tracking-wider border border-amber-100">On Leave</span>`;

            return `
                <tr class="group hover:bg-slate-50 transition-colors border-b border-slate-50 last:border-none">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            ${staff.image 
                                ? `<img src="${staff.image}" class="w-8 h-8 rounded-full object-cover border border-slate-200">`
                                : `<div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-[10px] font-bold text-slate-500 border border-slate-200">${staff.first_name.charAt(0)}</div>`
                            }
                            <div>
                                <div class="font-bold text-slate-800 text-sm">${fullName}</div>
                                <div class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">${staff.position || 'Staff'}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">${statusBadge}</td>
                    <td class="px-6 py-4">
                        <div class="text-xs font-mono font-bold text-slate-600 bg-slate-100 inline-block px-2 py-1 rounded">
                            ${r.time_in ? r.time_in.substring(0,5) : '--:--'} <span class="text-slate-300 mx-1">|</span> ${r.time_out ? r.time_out.substring(0,5) : '--:--'}
                        </div>
                    </td>
                    <td class="px-6 py-4 text-xs font-bold text-slate-400">${new Date(r.attendance_date).toLocaleDateString('en-GB')}</td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="editRecord(${r.id})" class="w-8 h-8 inline-flex items-center justify-center rounded-lg text-slate-300 hover:text-indigo-600 hover:bg-indigo-50 transition-all mr-1"><i class="fas fa-pen text-xs"></i></button>
                        <button onclick="deleteRecord(${r.id})" class="w-8 h-8 inline-flex items-center justify-center rounded-lg text-slate-300 hover:text-rose-600 hover:bg-rose-50 transition-all"><i class="fas fa-trash text-xs"></i></button>
                    </td>
                </tr>
                `;
            }).join('');
        }

    function updateStats(data) {
        const present = data.filter(x => x.status === 'present').length;
        const total = staffList.length || 1; 
        $("statPresent").textContent = present;
        $("statAbsent").textContent = data.length - present;
        $("statTotal").textContent = staffList.length;
        $("statRate").textContent = Math.round((present / total) * 100) + "%";
    }

    $("attendanceForm").onsubmit = async (e) => {
        e.preventDefault();
        const status = document.querySelector('input[name="status"]:checked').value;
        
        const payload = {
            staff_id: $("formStaffId").value,
            status: status,
            time_in: status === 'present' ? $("formTimeIn").value + ":00" : null,
            time_out: status === 'present' ? $("formTimeOut").value + ":00" : null,
            attendance_date: $("dateInput").value
        };

        await sendData(api.att, 'POST', payload, "Attendance Marked");
        $("attendanceForm").reset();
        document.querySelector('input[value="present"]').checked = true;
        toggleTimeVisibility('form');
    };

    function editRecord(id) {
        const record = allAttendance.find(x => x.id === id);
        const staff = staffList.find(s => s.id === record.staff_id);
        if(!record) return;

        $("editRecordId").value = id;
        $("editStaffName").textContent = staff ? `${staff.first_name} ${staff.second_name}` : "Unknown Staff";
        $("editStatus").value = record.status;
        $("editTimeIn").value = record.time_in ? record.time_in.substring(0,5) : "08:00";
        $("editTimeOut").value = record.time_out ? record.time_out.substring(0,5) : "17:00";
        
        toggleTimeVisibility('edit');
        $("editModal").classList.remove("hidden");
    }

    $("editForm").onsubmit = async (e) => {
        e.preventDefault();
        const id = $("editRecordId").value;
        const status = $("editStatus").value;
        const record = allAttendance.find(x => x.id == id);

        const payload = {
            staff_id: record.staff_id,
            attendance_date: record.attendance_date,
            status: status,
            time_in: status === 'present' ? $("editTimeIn").value + ":00" : null,
            time_out: status === 'present' ? $("editTimeOut").value + ":00" : null
        };

        await sendData(`${api.att}/${id}`, 'PUT', payload, "Record Updated");
        closeEditModal();
    };

    function closeEditModal() { $("editModal").classList.add("hidden"); }

    async function deleteRecord(id) {
        if(confirm("Are you sure you want to remove this entry?")) {
            try {
                await fetch(`${api.att}/${id}`, { method: 'DELETE' });
                showToast("Deleted", "Entry removed successfully");
                loadData();
            } catch(e) { showToast("Error", "Could not delete"); }
        }
    }

    async function sendData(url, method, body, successMsg) {
        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            const data = await res.json();

            if (res.ok) {
                showToast("Success", successMsg);
                loadData();
                return true; 
            } else {
                showToast("Attention", data.message || "Operation failed");
                return false;
            }
        } catch (e) {
            showToast("Error", "Could not connect to server");
            return false;
        }
    }

    function openTimePicker(inputId) {
        activeTimeInputId = inputId;
        const currentVal = $(inputId).value || "08:00";
        const [h, m] = currentVal.split(':').map(Number);
        pickerH = h || 8; 
        pickerM = m || 0;
        updatePickerDisplay();
        $("timePicker").classList.remove("hidden");
    }

    function closeTimePicker() { $("timePicker").classList.add("hidden"); }

    function adjustTime(unit, val) {
        if(unit === 'h') pickerH = (pickerH + val + 24) % 24;
        else pickerM = (pickerM + val + 60) % 60;
        updatePickerDisplay();
    }

    function updatePickerDisplay() {
        $("pHour").textContent = String(pickerH).padStart(2, '0');
        $("pMin").textContent = String(pickerM).padStart(2, '0');
    }

    function saveTimeSelection() {
        const str = `${String(pickerH).padStart(2,'0')}:${String(pickerM).padStart(2,'0')}`;
        if(activeTimeInputId) $(activeTimeInputId).value = str;
        closeTimePicker();
    }

    function toggleTimeVisibility(context) {
        let status, container;
        if(context === 'form') {
            status = document.querySelector('input[name="status"]:checked').value;
            container = $("timeContainerForm");
        } else {
            status = $("editStatus").value;
            container = $("timeContainerEdit");
        }

        if(status === 'present') {
            container.style.opacity = "1";
            container.style.pointerEvents = "auto";
        } else {
            container.style.opacity = "0.3";
            container.style.pointerEvents = "none";
        }
    }
</script>