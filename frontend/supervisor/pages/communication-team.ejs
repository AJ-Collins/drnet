<style>
  .skeleton {
    background: #e5e7eb;
    animation: pulse 1.5s ease-in-out infinite;
  }
  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }
</style>

<div class="flex items-center justify-between mb-8">
  <div>
    <h3 class="text-3xl font-bold text-teal-800">Team Communication</h3>
    <p class="text-teal-600 mt-1">
      Real-time chat, announcements, and collaboration
    </p>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Chat Panel -->
  <section
    class="lg:col-span-2 bg-white rounded-2xl shadow-xl border border-teal-100 overflow-hidden flex flex-col h-[80vh]"
  >
    <div
      class="p-5 bg-gradient-to-r from-teal-600 to-teal-700 text-white flex items-center justify-between"
    >
      <div class="flex items-center gap-4">
        <i class="fas fa-comments text-3xl"></i>
        <div>
          <h2 class="text-xl font-bold">#team-chat</h2>
          <div id="onlineCount" class="text-sm opacity-90">
            Loading members...
          </div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button
          onclick="refreshChat()"
          class="p-2 hover:bg-white/20 rounded-lg transition"
        >
          <i class="fas fa-sync-alt"></i>
        </button>
        <button
          onclick="clearChat()"
          class="p-2 hover:bg-red-500/30 rounded-lg transition text-white"
          title="Clear chat (Admin only)"
        >
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>

    <!-- Messages -->
    <div
      id="chatMessages"
      class="flex-1 overflow-y-auto p-6 space-y-5 bg-gray-50"
    >
      <div class="text-center text-gray-500 py-20">
        <i class="fas fa-comment-slash text-8xl text-gray-200 mb-4"></i>
        <p class="text-xl font-semibold">No messages yet</p>
        <p class="text-sm">Start the conversation!</p>
      </div>
    </div>

    <!-- Input -->
    <div class="p-5 border-t-2 border-teal-100 bg-white">
      <form onsubmit="sendMessage(event)" class="flex items-end gap-3">
        <textarea
          id="messageInput"
          rows="1"
          placeholder="Type a message..."
          class="flex-1 px-5 py-3 border-2 border-teal-200 rounded-2xl resize-none focus:border-teal-500 focus:ring-4 focus:ring-teal-100 transition-all text-base"
          oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px'"
        ></textarea>
        <button
          type="submit"
          class="bg-teal-600 hover:bg-teal-700 text-white p-4 rounded-2xl shadow-lg hover:shadow-xl transition-all"
        >
          <i class="fas fa-paper-plane text-xl"></i>
        </button>
      </form>
    </div>
  </section>

  <!-- Right Sidebar -->
  <aside class="space-y-6">
    <!-- Team Members -->
    <div class="bg-white rounded-2xl shadow-xl border border-teal-100 p-5">
      <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
        <i class="fas fa-users text-teal-600"></i> Team Members
      </h3>
      <div id="teamMembers" class="space-y-3 max-h-80 overflow-y-auto">
        <div class="skeleton h-16 rounded-xl"></div>
        <div class="skeleton h-16 rounded-xl"></div>
      </div>
    </div>

    <!-- Announcements -->
    <div class="bg-white rounded-2xl shadow-xl border border-teal-100 p-5">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
          <i class="fas fa-bullhorn text-teal-600"></i> Announcements
        </h3>
        <button
          onclick="openAnnouncementModal()"
          class="text-teal-600 hover:text-teal-700 text-xl"
        >
          <i class="fas fa-plus-circle"></i>
        </button>
      </div>
      <div id="announcementsList" class="space-y-3 max-h-96 overflow-y-auto">
        <div class="skeleton h-24 rounded-xl"></div>
      </div>
    </div>
  </aside>
</div>

<!-- Announcement Modal -->
<div
  id="announcementModal"
  class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/60"
>
  <div
    class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl border border-teal-100"
  >
    <div class="p-6 border-b border-teal-100">
      <h3 class="text-2xl font-bold text-teal-800" id="annModalTitle">
        New Announcement
      </h3>
    </div>
    <form onsubmit="saveAnnouncement(event)" class="p-6 space-y-5">
      <input type="hidden" id="annEditId" />
      <div>
        <label class="block text-sm font-bold text-gray-700 mb-2">Title</label>
        <input
          type="text"
          id="annTitle"
          required
          class="w-full px-5 py-3 border-2 border-teal-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100"
          placeholder="e.g. System Maintenance"
        />
      </div>
      <div>
        <label class="block text-sm font-bold text-gray-700 mb-2"
          >Message</label
        >
        <textarea
          id="annBody"
          rows="5"
          required
          class="w-full px-5 py-3 border-2 border-teal-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100 resize-none"
          placeholder="Details..."
        ></textarea>
      </div>
      <div class="flex justify-end gap-3 pt-4">
        <button
          type="button"
          onclick="closeAnnouncementModal()"
          class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-xl font-semibold"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="px-6 py-3 bg-teal-600 hover:bg-teal-700 text-white rounded-xl font-semibold shadow-lg"
        >
          Publish
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  const API_BASE = "/api";
  let messages = [];
  let teamMembers = [];
  let announcements = [];
  let currentUser = null;

  const $ = (id) => document.getElementById(id);

  // Load everything
  const loadData = async () => {
    try {
      const [msgRes, memberRes, annRes, userRes] = await Promise.all([
        fetch(`${API_BASE}/team/messages`),
        fetch(`${API_BASE}/team/members`),
        fetch(`${API_BASE}/team/announcements`),
        fetch(`${API_BASE}/auth/me`),
      ]);

      const msgData = msgRes.ok ? await msgRes.json() : {};
      const annData = annRes.ok ? await annRes.json() : {};

      messages = Array.isArray(msgData.messages) ? msgData.messages : [];
      teamMembers = memberRes.ok ? await memberRes.json() : [];
      announcements = Array.isArray(annData.announcements)
        ? annData.announcements
        : [];
      currentUser = userRes.ok ? await userRes.json() : null;

      renderMessages();
      renderMembers();
      renderAnnouncements();
    } catch (err) {
      alert("Failed to load team data");
    }
  };

  // Render Messages
  const renderMessages = () => {
    const container = $("chatMessages");
    if (!messages.length) {
      container.innerHTML = `
        <div class="text-center py-20 text-gray-500">
          <i class="fas fa-comments text-9xl text-gray-200 mb-6"></i>
          <p class="text-2xl font-bold">No messages yet</p>
          <p class="text-lg">Be the first to say something!</p>
        </div>`;
      return;
    }

    container.innerHTML = messages
      .map((m) => {
        const isMe = currentUser && m.sender_id === currentUser.id;
        const sender = m.sender_name || "Unknown";
        const role = m.sender_role || "Staff";

        return `
        <div class="flex items-start gap-4 ${isMe ? "flex-row-reverse" : ""}">
          <div class="w-12 h-12 rounded-full flex-shrink-0 flex items-center justify-center text-white font-bold text-lg
            ${
              isMe
                ? "bg-blue-600"
                : role === "Admin"
                ? "bg-purple-600"
                : "bg-teal-600"
            }">
            ${sender.charAt(0).toUpperCase()}
          </div>

          <div class="flex-1 max-w-xl">
            <div class="mb-2 text-xs text-gray-500 flex items-center gap-2 ${
              isMe ? "justify-end" : ""
            }">
              <span class="font-bold ${
                isMe
                  ? "text-blue-700"
                  : role === "Admin"
                  ? "text-purple-700"
                  : "text-teal-700"
              }">
                ${isMe ? "You" : sender}
                ${
                  role === "Admin"
                    ? '<span class="ml-2 px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs">Admin</span>'
                    : ""
                }
              </span>
              <span>${new Date(m.created_at).toLocaleString()}</span>
            </div>

            <!-- MESSAGE BUBBLE -->
            <div class="p-5 
              ${
                isMe
                  ? "rounded-2xl rounded-tr-none bg-blue-50 border-2 border-blue-200"
                  : "rounded-2xl rounded-tl-none bg-gray-100 border-2 border-gray-300"
              }">
              <p class="text-gray-900 leading-relaxed">${escapeHtml(
                m.message
              )}</p>
            </div>
          </div>
        </div>`;
      })
      .join("");

    container.scrollTop = container.scrollHeight;
  };

  // Render Team Members
  const renderMembers = () => {
    const container = $("teamMembers");
    const onlineCount = teamMembers.filter((m) => m.online).length;
    $("onlineCount").textContent = `${onlineCount} member${
      onlineCount !== 1 ? "s" : ""
    } online`;

    container.innerHTML = teamMembers
      .map(
        (m) => `
      <div class="flex items-center justify-between p-3 rounded-xl hover:bg-gray-50 transition">
        <div class="flex items-center gap-3">
          <div class="relative">
            <div class="w-12 h-12 rounded-full bg-teal-600 text-white flex items-center justify-center font-bold text-lg">
              ${m.name.charAt(0).toUpperCase()}
            </div>
            ${
              m.online
                ? '<div class="absolute bottom-0 right-0 w-4 h-4 bg-green-500 rounded-full border-2 border-white"></div>'
                : ""
            }
          </div>
          <div>
            <div class="font-semibold text-gray-900">${escapeHtml(m.name)}</div>
            <div class="text-xs text-gray-500">${m.role || "Staff"}</div>
          </div>
        </div>
        <div class="text-sm ${m.online ? "text-green-600" : "text-gray-400"}">
          ${m.online ? "Online" : "Offline"}
        </div>
      </div>
    `
      )
      .join("");
  };

  function truncateText(text, limit = 120) {
    if (text.length <= limit)
      return { truncated: text, full: text, isTruncated: false };

    return {
      truncated: text.substring(0, limit) + "...",
      full: text,
      isTruncated: true,
    };
  }

  function toggleAnnouncement(id) {
    const el = document.getElementById(`announcement-msg-${id}`);
    const btn = document.getElementById(`announcement-btn-${id}`);

    const isExpanded = el.dataset.expanded === "true";

    if (isExpanded) {
      el.textContent = el.dataset.truncated;
      el.dataset.expanded = "false";
      btn.textContent = "Read more";
    } else {
      el.textContent = el.dataset.full;
      el.dataset.expanded = "true";
      btn.textContent = "Show less";
    }
  }

  // Render Announcements
  const renderAnnouncements = () => {
    const container = $("announcementsList");

    if (!announcements.length) {
      container.innerHTML = `<p class="text-center text-gray-500 py-8">No announcements</p>`;
      return;
    }

    container.innerHTML = announcements
      .map((a) => {
        const trunc = truncateText(a.message, 120);

        return `
      <div class="p-5 bg-teal-50 border-2 border-teal-200 rounded-xl relative group">
        <div class="pr-10">
          <h4 class="font-bold text-teal-800 text-lg">${escapeHtml(
            a.title
          )}</h4>

          <p class="text-gray-700 mt-2">
            <span 
              id="announcement-msg-${a.id}"
              data-full="${escapeHtml(trunc.full)}"
              data-truncated="${escapeHtml(trunc.truncated)}"
              data-expanded="false"
            >
              ${escapeHtml(trunc.isTruncated ? trunc.truncated : trunc.full)}
            </span>

            ${
              trunc.isTruncated
                ? `<button 
                    id="announcement-btn-${a.id}" 
                    onclick="toggleAnnouncement(${a.id})" 
                    class="text-teal-700 ml-2 underline text-sm"
                  >
                    Read more
                  </button>`
                : ""
            }
          </p>

          <p class="text-xs text-gray-500 mt-3">
            Posted ${new Date(a.created_at).toLocaleDateString()}
          </p>
        </div>

        ${
          currentUser?.role === "Admin"
            ? `
          <button onclick="deleteAnnouncement(${a.id})" 
            class="absolute top-3 right-3 text-gray-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition">
            <i class="fas fa-trash"></i>
          </button>`
            : ""
        }
      </div>
    `;
      })
      .join("");
  };

  // Send Message
  const sendMessage = async (e) => {
    e.preventDefault();
    const input = $("messageInput");
    const msg = input.value.trim();
    if (!msg) return;

    try {
      await fetch(`${API_BASE}/team/messages`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: msg }),
      });
      input.value = "";
      loadData();
    } catch (err) {
      alert("Failed to send message");
    }
  };

  // Clear Chat (Admin only)
  const clearChat = async () => {
    if (!currentUser || currentUser.role !== "Admin")
      return alert("Only admins can clear chat");
    if (!confirm("Delete all messages?")) return;
    try {
      await fetch(`${API_BASE}/team/messages/clear`, { method: "DELETE" });
      loadData();
    } catch (err) {
      alert("Failed to clear");
    }
  };

  // Announcement Modal
  const openAnnouncementModal = (id = null) => {
    const modal = $("announcementModal");
    const title = $("annModalTitle");
    const editId = $("annEditId");

    if (id) {
      const ann = announcements.find((a) => a.id === id);
      if (!ann) return;
      title.textContent = "Edit Announcement";
      editId.value = id;
      $("annTitle").value = ann.title;
      $("annBody").value = ann.body;
    } else {
      title.textContent = "New Announcement";
      editId.value = "";
      $("annTitle").value = "";
      $("annBody").value = "";
    }
    modal.classList.remove("hidden");
  };

  const closeAnnouncementModal = () => {
    $("announcementModal").classList.add("hidden");
  };

  const saveAnnouncement = async (e) => {
    e.preventDefault();
    const title = $("annTitle").value.trim();
    const body = $("annBody").value.trim();
    const editId = $("annEditId").value;

    if (!title || !body) return;

    try {
      const url = editId
        ? `${API_BASE}/team/announcements/${editId}`
        : `${API_BASE}/team/announcements`;
      const method = editId ? "PUT" : "POST";

      await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title, body }),
      });

      closeAnnouncementModal();
      loadData();
    } catch (err) {
      alert("Failed to save announcement");
    }
  };

  const deleteAnnouncement = async (id) => {
    if (!confirm("Delete this announcement?")) return;
    try {
      await fetch(`${API_BASE}/team/announcements/${id}`, { method: "DELETE" });
      loadData();
    } catch (err) {
      alert("Failed to delete");
    }
  };

  // Refresh
  const refreshChat = () => loadData();

  // Escape HTML
  function escapeHtml(text) {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }

  // Auto-resize textarea
  document
    .getElementById("messageInput")
    ?.addEventListener("input", function () {
      this.style.height = "auto";
      this.style.height = this.scrollHeight + "px";
    });

  // Init
  window.onload = loadData;
  setInterval(loadData, 10000); // Auto-refresh every 10s
</script>
