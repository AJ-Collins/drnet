<style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f8fafc; 
        }

        /* Custom Scrollbar for the table and sidebar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        .input-field { 
            background: #f1f5f9; 
            border: 1px solid #cbd5e1; 
            transition: all 0.2s; 
        }
        
        .input-field:focus { 
            background: white; 
            border-color: #0d9488; 
            box-shadow: 0 0 0 4px rgba(13, 148, 136, 0.1); 
        }
        
        .table-row {
            transition: background-color 0.2s;
        }
        
        .table-row:hover { 
            background-color: #f0f9ff; 
        }

        .label-caps { 
            font-size: 10px; 
            font-weight: 800; 
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
            color: #64748b; 
        }

        /* Animations */
        .animate-slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fa-spin-slow {
            animation: fa-spin 1s infinite linear;
        }

        /* Detail View Specific Styles */
        .detail-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .detail-group {
            margin-bottom: 1rem;
        }
        .detail-group:last-child {
            margin-bottom: 0;
        }

        .detail-label {
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #94a3b8;
            margin-bottom: 0.25rem;
        }

        .detail-value {
            font-size: 0.925rem;
            font-weight: 600;
            color: #1e293b;
            word-break: break-word;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 800;
            color: white;
            border: 4px solid white;
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.2);
        }
    </style>

    <div class="h-screen flex flex-col overflow-hidden">

        <div id="toastContainer" class="fixed top-5 right-5 z-[100] space-y-3"></div>

        <div class="p-4 md:p-6 h-full flex flex-col">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6 flex-shrink-0">
                <div>
                    <h1 class="text-2xl md:text-3xl font-black text-slate-900 tracking-tight">Client Directory</h1>
                    <p class="text-slate-500 font-bold text-xs md:text-sm tracking-widest uppercase mt-1">Customer Management Portal</p>
                </div>
            </div>

            <div class="flex-1 overflow-hidden flex flex-col lg:flex-row gap-6 relative">
                
                <div id="listContainer" class="flex-1 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden transition-all duration-300">
                    
                    <div class="p-4 border-b border-slate-200 bg-slate-50">
                        <div class="flex flex-col md:flex-row gap-3">
                            <div class="relative flex-grow max-w-xl">
                                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input 
                                    type="text" 
                                    onkeyup="filterData(this.value)" 
                                    placeholder="Search clients by name, email or phone..." 
                                    class="w-full pl-11 pr-4 py-2.5 rounded-lg input-field text-sm font-bold outline-none"
                                >
                            </div>
                            <div class="min-w-[200px]">
                                <select 
                                    id="location-filter" 
                                    onchange="filterByLocation(this.value)"
                                    class="w-full px-4 py-2.5 rounded-lg input-field text-sm font-bold outline-none cursor-pointer"
                                >
                                    <option value="">All Locations</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto bg-white relative">
                        <table class="w-full text-left border-collapse">
                            <thead class="sticky top-0 bg-slate-50 border-b border-slate-200 z-10 shadow-[0_1px_2px_rgba(0,0,0,0.02)]">
                                <tr>
                                    <th class="px-6 py-4 label-caps w-[30%]">Client Identity</th>
                                    <th class="px-6 py-4 label-caps w-[20%]">Location</th>
                                    <th class="px-6 py-4 label-caps w-[20%]">ID Number</th>
                                    <th class="px-6 py-4 label-caps w-[20%]">Contact</th>
                                    <th class="px-6 py-4 label-caps w-[10%] text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="clientsTable" class="divide-y divide-slate-100">
                                </tbody>
                        </table>
                    </div>
                    
                    <div class="p-3 bg-slate-50 border-t border-slate-200 text-xs font-bold text-slate-500 text-right">
                        Showing <span id="clientCount">0</span> Clients
                    </div>
                </div>

                <aside id="profileContainer" class="hidden w-full lg:w-[450px] bg-white rounded-lg shadow-lg border border-slate-200 flex flex-col overflow-hidden animate-slide-in absolute lg:relative inset-0 lg:inset-auto z-20">
                    
                    <div class="p-5 bg-gradient-to-r from-slate-900 to-slate-800 text-white flex justify-between items-center flex-shrink-0">
                        <div>
                            <h2 class="text-base font-black tracking-tight uppercase">Client Profile</h2>
                            <p class="text-[10px] text-slate-400 mt-0.5">Read-only view</p>
                        </div>
                        <button 
                            onclick="hideProfile()" 
                            class="w-8 h-8 rounded-full bg-slate-700 hover:bg-slate-600 text-white flex items-center justify-center transition"
                            title="Close Profile"
                        >
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="flex-1 overflow-y-auto p-5 bg-slate-50">
                        <div id="profileContent" class="space-y-4">
                            
                            <div class="detail-card text-center relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-full h-16 bg-gradient-to-r from-teal-50 to-emerald-50 border-b border-slate-100"></div>
                                <div class="relative z-10">
                                    <div class="profile-avatar mx-auto mb-3" id="profileAvatar">?</div>
                                    <h3 class="text-xl font-black text-slate-900 uppercase tracking-tight" id="profileFullName">---</h3>
                                </div>
                            </div>

                            <div class="detail-card">
                                <h4 class="text-xs font-black text-slate-700 uppercase tracking-wider mb-4 flex items-center gap-2 pb-2 border-b border-slate-100">
                                    <i class="fas fa-user text-teal-500"></i>
                                    Personal Details
                                </h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="detail-group">
                                        <div class="detail-label">First Name</div>
                                        <div class="detail-value" id="detailFirstName">---</div>
                                    </div>
                                    <div class="detail-group">
                                        <div class="detail-label">Last Name</div>
                                        <div class="detail-value" id="detailLastName">---</div>
                                    </div>
                                    <div class="detail-group col-span-2">
                                        <div class="detail-label">National ID / Passport</div>
                                        <div class="detail-value font-mono bg-slate-50 px-2 py-1 rounded inline-block border border-slate-200 text-slate-600" id="detailIdNumber">---</div>
                                    </div>
                                </div>
                            </div>

                            <div class="detail-card">
                                <h4 class="text-xs font-black text-slate-700 uppercase tracking-wider mb-4 flex items-center gap-2 pb-2 border-b border-slate-100">
                                    <i class="fas fa-address-book text-teal-500"></i>
                                    Contact Info
                                </h4>
                                <div class="space-y-4">
                                    <div class="detail-group">
                                        <div class="detail-label">Email Address</div>
                                        <div class="detail-value flex items-center gap-2">
                                            <div class="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center flex-shrink-0">
                                                <i class="fas fa-envelope text-slate-400 text-[10px]"></i>
                                            </div>
                                            <span id="detailEmail">---</span>
                                        </div>
                                    </div>
                                    <div class="detail-group">
                                        <div class="detail-label">Phone Number</div>
                                        <div class="detail-value flex items-center gap-2 font-mono">
                                            <div class="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center flex-shrink-0">
                                                <i class="fas fa-phone text-slate-400 text-[10px]"></i>
                                            </div>
                                            <span id="detailPhone">---</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="detail-card">
                                <h4 class="text-xs font-black text-slate-700 uppercase tracking-wider mb-4 flex items-center gap-2 pb-2 border-b border-slate-100">
                                    <i class="fas fa-map-marked-alt text-teal-500"></i>
                                    Location Data
                                </h4>
                                <div class="space-y-4">
                                    <div class="detail-group">
                                        <div class="detail-label">Region / Location</div>
                                        <div class="detail-value" id="detailLocation">---</div>
                                    </div>
                                    <div class="detail-group">
                                        <div class="detail-label">Physical Address</div>
                                        <div class="detail-value text-sm leading-relaxed" id="detailAddress">---</div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <div class="p-4 bg-white border-t border-slate-200">
                        <button 
                            onclick="hideProfile()" 
                            class="w-full bg-slate-900 text-white py-3 rounded-lg font-black text-xs uppercase tracking-widest hover:bg-teal-600 transition-all shadow-md"
                        >
                            Close Details
                        </button>
                    </div>
                </aside>
            </div>
        </div>
    </div>

    <script>
        // Global State
        let allClients = [];
        let filteredClients = [];

        // 1. INITIALIZATION
        window.onload = () => {
            fetchClients();
        };

        // 2. DATA FETCHING
        async function fetchClients() {
            setLoadingState(true);
            
            try {
                const res = await fetch('/api/manage/clients');
                
                if (!res.ok) throw new Error('Network response was not ok');
                
                // Simulate small delay for UI smoothness if API is instant
                await new Promise(resolve => setTimeout(resolve, 300));
                
                allClients = await res.json();
                filteredClients = [...allClients]; // Create a copy
                renderTable();
            } catch (e) {
                console.error("Fetch Error:", e);
                showToast("ERROR", 'Could not load client database.');
                
                // Fallback for UI visualization if API fails (Optional: Remove if not needed)
                const tbody = document.getElementById('clientsTable');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-20 text-center text-rose-500">
                            <i class="fas fa-exclamation-circle text-3xl mb-2"></i>
                            <p class="font-bold">Connection Failed</p>
                        </td>
                    </tr>`;
            }
        }

        // 3. RENDER LOGIC
        function renderTable() {
            const tbody = document.getElementById('clientsTable');
            const countEl = document.getElementById('clientCount');
            
            // Update Count
            countEl.textContent = filteredClients.length;

            // Empty State
            if (!filteredClients || filteredClients.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-20 text-center select-none">
                            <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-folder-open text-slate-300 text-2xl"></i>
                            </div>
                            <h3 class="text-slate-900 font-bold mb-1">No clients found</h3>
                            <p class="text-slate-400 text-xs font-semibold">Try adjusting your search filters</p>
                        </td>
                    </tr>`;
                return;
            }

            // Populate Rows
            tbody.innerHTML = filteredClients.map(client => {
                const fName = client.first_name || 'Unknown';
                const sName = client.second_name || '';
                const fullName = `${fName} ${sName}`;
                const initials = (fName[0] || '?') + (sName[0] || '');

                return `
                    <tr class="table-row group cursor-pointer border-b border-slate-50 last:border-0" onclick="showProfile(${client.id})">
                        
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-slate-200 to-slate-300 flex items-center justify-center text-slate-600 font-bold text-xs overflow-hidden shrink-0 shadow-sm group-hover:from-teal-500 group-hover:to-teal-600 group-hover:text-white transition-all">
                                    ${client.image ? `<img src="${client.image}" class="w-full h-full object-cover">` : initials}
                                </div>
                                <div>
                                    <div class="text-sm font-black text-slate-800 uppercase tracking-tight group-hover:text-teal-700 transition-colors">${fullName}</div>
                                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Client #${client.id}</div>
                                </div>
                            </div>
                        </td>

                        <td class="px-6 py-4">
                            <div class="text-xs font-bold text-slate-600 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-teal-400"></span>
                                ${client.location || 'Not Set'}
                            </div>
                        </td>

                        <td class="px-6 py-4">
                            <div class="text-xs font-bold text-slate-600 font-mono bg-slate-100 px-2 py-1 rounded inline-block">
                                ${client.id_number || '---'}
                            </div>
                        </td>

                        <td class="px-6 py-4">
                            <div class="flex flex-col gap-1">
                                <div class="text-xs font-bold text-slate-600 flex items-center gap-2">
                                    <i class="fas fa-envelope text-slate-300 text-[10px]"></i>
                                    <span class="truncate max-w-[150px]">${client.email || '---'}</span>
                                </div>
                                <div class="text-xs font-bold text-slate-600 flex items-center gap-2">
                                    <i class="fas fa-phone text-slate-300 text-[10px]"></i>
                                    <span class="font-mono">${client.phone || '---'}</span>
                                </div>
                            </div>
                        </td>

                        <td class="px-6 py-4 text-right">
                            <button 
                                onclick="event.stopPropagation(); showProfile(${client.id})" 
                                class="px-3 py-1.5 rounded-md bg-white border border-slate-200 text-slate-600 hover:border-teal-500 hover:text-teal-600 hover:bg-teal-50 transition-all font-bold text-[10px] uppercase tracking-wider shadow-sm"
                            >
                                <i class="fas fa-eye mr-1"></i> View
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Only populate drop down once or if needed dynamically
            if (document.getElementById('location-filter').options.length <= 1) {
                populateLocationFilter();
            }
        }

        // 4. PROFILE SIDEBAR LOGIC
        function showProfile(id) {
            const client = allClients.find(c => c.id === id);
            if (!client) return;

            // DOM Elements
            const container = document.getElementById('profileContainer');
            const avatarEl = document.getElementById('profileAvatar');
            
            // Show Container
            container.classList.remove('hidden');
            container.classList.add('flex');

            // --- Populate Data ---
            
            // 1. Avatar
            const fName = client.first_name || 'Client';
            const sName = client.second_name || '';
            const initials = (fName[0] || '?') + (sName[0] || '');
            
            if (client.image) {
                avatarEl.innerHTML = `<img src="${client.image}" class="w-full h-full object-cover">`;
            } else {
                avatarEl.textContent = initials;
            }

            // 2. Header
            document.getElementById('profileFullName').textContent = `${fName} ${sName}`;

            // 3. Details
            document.getElementById('detailFirstName').textContent = fName;
            document.getElementById('detailLastName').textContent = sName;
            document.getElementById('detailIdNumber').textContent = client.id_number || 'Not Provided';
            document.getElementById('detailEmail').textContent = client.email || 'Not Provided';
            document.getElementById('detailPhone').textContent = client.phone || 'Not Provided';
            document.getElementById('detailLocation').textContent = client.location || 'Not Set';
            document.getElementById('detailAddress').textContent = client.address || 'No physical address recorded';

            // Mobile handling: Scroll to profile if on small screen
            if (window.innerWidth < 1024) {
                container.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function hideProfile() {
            const container = document.getElementById('profileContainer');
            container.classList.add('hidden');
            container.classList.remove('flex');
        }

        // 5. FILTERING LOGIC
        function filterData(val) {
            const term = val.toLowerCase();
            const locationFilter = document.getElementById('location-filter');
            const selectedLocation = locationFilter ? locationFilter.value : '';
            
            applyFilters(term, selectedLocation);
        }

        function filterByLocation(location) {
            const searchInput = document.querySelector('input[type="text"]');
            const term = searchInput.value.toLowerCase();
            
            applyFilters(term, location);
        }

        function applyFilters(searchTerm, location) {
            filteredClients = allClients.filter(client => {
                const fName = (client.first_name || '').toLowerCase();
                const sName = (client.second_name || '').toLowerCase();
                const email = (client.email || '').toLowerCase();
                const phone = (client.phone || '').toLowerCase();

                const matchesSearch = 
                    fName.includes(searchTerm) || 
                    sName.includes(searchTerm) ||
                    email.includes(searchTerm) ||
                    phone.includes(searchTerm);
                
                const matchesLocation = !location || client.location === location;
                
                return matchesSearch && matchesLocation;
            });
            
            renderTable();
        }

        function populateLocationFilter() {
            const locationFilter = document.getElementById('location-filter');
            
            // Extract unique locations
            const locations = [...new Set(allClients
                .map(client => client.location)
                .filter(loc => loc && loc.trim() !== '')
            )].sort();
            
            // Add to dropdown
            const currentVal = locationFilter.value;
            locationFilter.innerHTML = `<option value="">All Locations</option>`;
            
            locations.forEach(loc => {
                const count = allClients.filter(c => c.location === loc).length;
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = `${loc} (${count})`;
                locationFilter.appendChild(option);
            });

            locationFilter.value = currentVal;
        }

        // 6. UTILITIES
        function showToast(title, msg) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            
            const isError = title === 'ERROR';
            const bgColor = isError ? 'bg-rose-600' : 'bg-emerald-600';
            
            toast.className = `${bgColor} text-white p-4 rounded-xl shadow-xl min-w-[280px] animate-slide-in flex items-center gap-3`;
            toast.innerHTML = `
                <div class="text-2xl opacity-50"><i class="fas ${isError ? 'fa-times-circle' : 'fa-check-circle'}"></i></div>
                <div>
                    <h5 class="text-[10px] font-black uppercase opacity-70 mb-0.5">${title}</h5>
                    <p class="text-sm font-bold">${msg}</p>
                </div>
            `;
            
            container.appendChild(toast);
            
            // Auto remove
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-10px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function setLoadingState(isLoading) {
            const tbody = document.getElementById('clientsTable');
            if (isLoading) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-32 text-center">
                            <div class="inline-flex flex-col items-center">
                                <i class="fas fa-circle-notch fa-spin-slow text-4xl text-teal-500 mb-4"></i>
                                <p class="text-xs font-black uppercase tracking-[0.2em] text-slate-400 animate-pulse">
                                    Loading Directory...
                                </p>
                            </div>
                        </td>
                    </tr>`;
            }
        }
    </script>