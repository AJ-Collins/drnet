<style>
  .slide-in {
    animation: slideIn 0.4s ease-out;
  }
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .animate-spin-slow {
    animation: spin 2s linear infinite;
  }
  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }
</style>
<div class="flex items-center justify-between mb-8">
  <div>
    <h3 class="text-2xl font-bold text-teal-800">Website Bookings</h3>
    <p class="text-teal-600 mt-1">Online Booking Management</p>
  </div>
  <button
    onclick="addNewBooking()"
    class="bg-teal-500 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center space-x-2 group"
  >
    <i class="fas fa-plus"></i>
    <span class="mr-2">New Booking</span>
  </button>
</div>

<!-- BOOKINGS LIST -->
<div class="bg-white shadow-md border border-gray-200 overflow-hidden slide-in">
  <div
    class="px-6 py-4 bg-gradient-to-r from-teal-50 to-teal-100 border-b border-teal-200"
  >
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-bold text-teal-800">
        <i class="fas fa-list mr-2"></i>Bookings
      </h3>
      <button
        onclick="refreshBookings()"
        class="bg-teal-500 hover:bg-teal-700 text-white px-2 py-2 rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center space-x-2 group"
      >
        <i class="fas fa-sync"></i>
        <span class="mr-2">Refresh</span>
      </button>
    </div>
  </div>
  <div id="allRenewalList" class="space-y-4 p-6">
    <p class="text-center text-gray-500 py-8">Loading bookings...</p>
  </div>
</div>

<!-- ADD / EDIT MODAL -->
<div
  id="addBookingModal"
  class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/40"
>
  <div
    class="bg-white w-full max-w-3xl shadow-xl border border-teal-200 overflow-y-auto max-h-[90vh]"
  >
    <div class="bg-teal-600 text-white p-6 flex justify-between items-center">
      <h3 id="modalTitle" class="text-2xl font-bold tracking-wide">
        Add New Booking
      </h3>
      <button
        onclick="closeBookingModal()"
        class="text-white/90 hover:text-white"
      >
        <i class="fas fa-times text-2xl"></i>
      </button>
    </div>
    <div class="p-8 space-y-6 text-gray-700">
      <form id="bookingForm" class="space-y-6">
        <input type="hidden" id="bookingId" />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block font-semibold mb-2">Full Name *</label>
            <input
              required
              type="text"
              id="fullName"
              class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-teal-500 focus:ring-4 focus:ring-teal-100"
            />
          </div>
          <div>
            <label class="block font-semibold mb-2">Phone Number *</label>
            <input
              required
              type="text"
              id="phoneNumber"
              class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-teal-500 focus:ring-4 focus:ring-teal-100"
            />
          </div>
          <div>
            <label class="block font-semibold mb-2">Email Address</label>
            <input
              type="email"
              id="email"
              class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-teal-500 focus:ring-4 focus:ring-teal-100"
            />
          </div>
          <div>
            <label class="block font-semibold mb-2">Location *</label>
            <input
              required
              type="text"
              id="location"
              class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-teal-500 focus:ring-4 focus:ring-teal-100"
            />
          </div>
          <div>
            <label class="block font-semibold mb-2">Exact Location *</label>
            <input
              required
              type="text"
              id="exactLocation"
              class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-teal-500 focus:ring-4 focus:ring-teal-100"
            />
          </div>
          <div>
            <label class="block font-semibold mb-2">Package *</label>
            <select
              id="package"
              required
              class="w-full bg-white p-4 rounded-xl border-2 border-gray-200 focus:border-teal-500 focus:ring-4 focus:ring-teal-100"
            >
              <option value="" disabled selected hidden>
                Select package...
              </option>
            </select>
          </div>
          <div>
            <label class="block font-semibold mb-2">Status</label>
            <select
              id="status"
              class="w-full bg-white p-4 rounded-xl border-2 border-gray-200 focus:border-teal-500 focus:ring-4 focus:ring-teal-100"
            >
              <option value="Pending">Pending</option>
              <option value="Contacted">Contacted</option>
              <option value="Processed">Processed</option>
            </select>
          </div>
          <div>
            <label class="block font-semibold mb-2">Installation Date</label>
            <input
              type="date"
              id="installationDate"
              class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-teal-500 focus:ring-4 focus:ring-teal-100"
            />
          </div>
        </div>
        <div>
          <label class="block font-semibold mb-2">Message</label>
          <textarea
            id="message"
            rows="3"
            class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-teal-500 focus:ring-4 focus:ring-teal-100"
          ></textarea>
        </div>
      </form>
    </div>
    <div class="p-6 border-t border-gray-200 flex justify-end space-x-4">
      <button
        id="addBtn"
        class="bg-teal-600 hover:bg-teal-700 text-white px-6 py-3 rounded-lg font-semibold shadow-md flex items-center gap-2 transition"
      >
        <i class="fas fa-plus"></i> Add
      </button>
      <button
        onclick="closeBookingModal()"
        class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold shadow-md transition"
      >
        Close
      </button>
    </div>
  </div>
</div>

<script>
  const API = {
    BOOKINGS: "/api/bookings",
    PACKAGES: "/api/packages",
  };

  let bookings = [];
  let packages = [];

  const $ = (id) => document.getElementById(id);

  // === API CALLS ===
  const api = {
    async get(url) {
      const res = await fetch(url, {
        headers: {
          Authorization: `Bearer ${localStorage.getItem("token") || ""}`,
        },
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    },
    async post(url, data) {
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${localStorage.getItem("token") || ""}`,
        },
        body: JSON.stringify(data),
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    },
    async put(url, data) {
      const res = await fetch(url, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${localStorage.getItem("token") || ""}`,
        },
        body: JSON.stringify(data),
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    },
    async delete(url) {
      const res = await fetch(url, {
        method: "DELETE",
        headers: {
          Authorization: `Bearer ${localStorage.getItem("token") || ""}`,
        },
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    },
  };

  // === LOAD DATA ===
  async function loadData() {
    try {
      const [bookingData, packageData] = await Promise.all([
        api.get(API.BOOKINGS),
        api.get(API.PACKAGES),
      ]);
      bookings = bookingData.filter((b) => !b.is_deleted);
      packages = packageData;
      populatePackageSelect();
      renderBookings();
    } catch (err) {
      Swal.fire("Error", err.message, "error");
    }
  }

  function populatePackageSelect() {
    const sel = $("package");
    sel.innerHTML =
      '<option value="" disabled selected hidden>Select package...</option>';
    packages.forEach((p) => {
      const opt = document.createElement("option");
      opt.value = p.name;
      opt.textContent = p.name;
      sel.appendChild(opt);
    });
  }

  // === RENDER BOOKINGS ===
  function renderBookings() {
    const container = $("allRenewalList");
    if (!bookings.length) {
      container.innerHTML = `<p class="text-center text-gray-500 py-8">No bookings found</p>`;
      return;
    }

    const statusColor = (s) => {
      return s === "Processed"
        ? "bg-green-100 text-green-700"
        : s === "Contacted"
        ? "bg-blue-100 text-blue-700"
        : "bg-yellow-100 text-yellow-700";
    };

    const statusOptions = (current) =>
      ["Pending", "Contacted", "Processed"]
        .map(
          (s) =>
            `<option value="${s}" ${
              s === current ? "selected" : ""
            }>${s}</option>`
        )
        .join("");

    container.innerHTML = bookings
      .map((r) => {
        const pkgName = r.package || "N/A";
        const renewed = dayjs(r.renewal_date);
        return `
        <div class="bg-gray-50 p-5 border hover:border-teal-300 hover:bg-teal-50 transition-all mb-3">
          <div class="grid grid-cols-1 sm:grid-cols-7 gap-3 items-center">
            <div class="flex items-center space-x-2 overflow-hidden">
              <span class="font-semibold text-gray-800 truncate">${
                r.name
              }</span>
              <span class="px-2 py-0.5 rounded text-xs font-medium ${statusColor(
                r.status
              )}">${r.status}</span>
            </div>
            <div class="text-sm text-gray-700">${r.phone}</div>
            <div class="text-sm text-gray-700 truncate">${
              r.location && r.exact_location
                ? `${r.location} - ${r.exact_location}`
                : r.location || r.exact_location
            }</div>

            <div class="text-sm text-gray-700 whitespace-nowrap">Booked on: ${renewed.format(
              "MMM D, YYYY"
            )}</div>
            <div class="flex flex-col text-right whitespace-nowrap">
              <span class="text-xs text-gray-500">Pkg: ${pkgName} </span>
            </div>
            <div class="flex justify-end space-x-2 sm:col-start-7 sm:justify-end ml-auto">
              <div class="inline-flex shadow-sm border border-gray-300 bg-white overflow-hidden" role="group">
                <select onchange="updateStatus(${
                  r.id
                }, this.value)" class="text-xs font-medium px-3 py-1.5 bg-transparent border-0 focus:outline-none cursor-pointer hover:bg-gray-50 transition ${
          statusColor(r.status).split(" ")[1]
        }">
                  ${statusOptions(r.status)}
                </select>
                <button onclick="editBooking(${
                  r.id
                })" class="px-2.5 py-1.5 text-blue-600 hover:bg-blue-50 transition border-l border-gray-300" title="Edit">
                  <i class="fas fa-edit text-sm"></i>
                </button>
                <button onclick="deleteBooking(${
                  r.id
                })" class="px-2.5 py-1.5 text-red-600 hover:bg-red-50 transition border-l border-gray-300" title="Delete">
                  <i class="fas fa-trash text-sm"></i>
                </button>
              </div>
            </div>
          </div>
        </div>`;
      })
      .join("");
  }

  // === MODAL ===
  function addNewBooking() {
    clearModal();
    $("modalTitle").textContent = "Add New Booking";
    $("addBtn").innerHTML = '<i class="fas fa-plus"></i> Add';
    $("addBookingModal").classList.remove("hidden");
  }

  function closeBookingModal() {
    $("addBookingModal").classList.add("hidden");
  }

  function clearModal() {
    $("bookingForm").reset();
    $("bookingId").value = "";
  }

  // === EDIT ===
  window.editBooking = async (id) => {
    const bk = bookings.find((b) => b.id === id);
    if (!bk) return;

    $("bookingId").value = bk.id;
    $("fullName").value = bk.name;
    $("phoneNumber").value = bk.phone;
    $("email").value = bk.email || "";
    $("location").value = bk.location;
    $("exactLocation").value = bk.exact_location;
    $("package").value = bk.package || "";
    $("status").value = bk.status;
    $("installationDate").value = bk.installationDate || "";
    $("message").value = bk.message || "";

    $("modalTitle").textContent = "Edit Booking";
    $("addBtn").innerHTML = '<i class="fas fa-save"></i> Update';
    $("addBookingModal").classList.remove("hidden");
  };

  // === SAVE (ADD/UPDATE) ===
  $("addBtn").onclick = async () => {
    const form = $("bookingForm");
    if (!form.checkValidity()) return form.reportValidity();

    const pkg = $("package").value;
    console.log(pkg);
    const id = $("bookingId").value;

    const data = {
      name: $("fullName").value.trim(),
      phone: $("phoneNumber").value.trim(),
      email: $("email").value.trim(),
      location: $("location").value.trim(),
      exact_location: $("exactLocation").value.trim(),
      package: pkg,
      status: $("status").value,
      installation_date: $("installationDate").value,
      extra_notes: $("message").value.trim(),
    };

    try {
      if (id) {
        await api.put(`${API.BOOKINGS}/${id}`, data);
        Swal.fire("Updated!", "", "success");
      } else {
        await api.post(API.BOOKINGS, data);
        Swal.fire("Added!", "", "success");
      }
      closeBookingModal();
      loadData();
    } catch (err) {
      Swal.fire("Error", err.message, "error");
    }
  };

  // === STATUS UPDATE ===
  window.updateStatus = async (id, newStatus) => {
    try {
      await api.put(`${API.BOOKINGS}/${id}`, { status: newStatus });
      loadData();
    } catch (err) {
      Swal.fire("Error", err.message, "error");
    }
  };

  // === DELETE (soft) ===
  window.deleteBooking = async (id) => {
    const res = await Swal.fire({
      title: "Delete?",
      text: "This cannot be undone.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#dc2626",
    });
    if (!res.isConfirmed) return;
    await api.put(`${API.BOOKINGS}/${id}`, { is_deleted: true });
    loadData();
    Swal.fire("Deleted!", "", "success");
  };

  // === REFRESH ===
  window.refreshBookings = loadData;

  // === INIT ===
  document.addEventListener("DOMContentLoaded", () => {
    loadData();
  });
</script>
