<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dr.Net Portal - Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/styles.css" />
  </head>
  <body
    class="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-100 via-purple-100 to-indigo-200"
  >
    <!-- Back to Home Button -->
    <div class="absolute top-4 left-4">
      <a
        href="/"
        class="bg-white/80 hover:bg-white text-blue-700 font-semibold px-4 py-2 rounded-lg transition duration-200 flex items-center"
      >
        ‚Üê Back to Home
      </a>
    </div>

    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
      <div class="text-center mb-8">
        <div
          class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4"
        >
          <span class="text-4xl text-white">üîê</span>
        </div>
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Dr.Net Portal</h1>
        <p class="text-gray-600 text-sm">Unified Access to Your Dashboard</p>
      </div>

      <form id="unifiedLoginForm" class="space-y-6">
        <div>
          <label
            for="username"
            class="block text-sm font-semibold text-gray-700 mb-2"
          >
            Username / Employee ID / Client ID
          </label>
          <input
            type="text"
            id="username"
            placeholder="Enter your credentials"
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200"
          />
        </div>

        <div>
          <label
            for="password"
            class="block text-sm font-semibold text-gray-700 mb-2"
          >
            Password
          </label>
          <input
            type="password"
            id="password"
            placeholder="Enter your password"
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200"
          />
        </div>

        <div class="flex items-center justify-between">
          <label class="flex items-center">
            <input type="checkbox" id="remember" class="mr-2 rounded" />
            <span class="text-sm text-gray-600">Remember me</span>
          </label>
          <a
            href="#"
            onclick="forgotPassword()"
            class="text-sm text-blue-600 hover:text-blue-800 font-medium"
          >
            Forgot Password?
          </a>
        </div>

        <button
          type="submit"
          id="loginBtn"
          class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-lg font-bold hover:from-blue-700 hover:to-purple-700 transition duration-200 transform hover:scale-[1.02]"
        >
          <span id="btnText">Sign In</span>
          <span id="spinner" class="hidden">
            <svg
              class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
            Signing In...
          </span>
        </button>

        <div
          id="errorMessage"
          class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded text-sm text-center"
        >
          ‚ùå Invalid credentials. Please check your username and password.
        </div>

        <div
          id="successMessage"
          class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded text-sm text-center"
        >
          ‚úÖ Login successful! Redirecting to your dashboard...
        </div>
      </form>

      <div class="mt-8 text-center">
        <div
          class="flex items-center justify-center space-x-4 text-sm text-gray-600"
        >
          <div class="flex items-center">
            <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
            CTIO / Admin
          </div>
          <div class="flex items-center">
            <span class="w-2 h-2 bg-purple-500 rounded-full mr-2"></span>
            Staff
          </div>
          <div class="flex items-center">
            <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
            Clients
          </div>
        </div>
        <p class="text-xs text-gray-500 mt-2">
          Need help?
          <a
            href="#"
            onclick="showContactInfo()"
            class="text-blue-600 hover:text-blue-800"
          >
            Contact Support
          </a>
        </p>
        <p class="text-xs text-gray-500 mt-3">
          New client?
          <a
            href="/client/register"
            class="text-green-600 hover:text-green-800 font-medium"
          >
            Register Here
          </a>
        </p>
      </div>
    </div>

    <script src="js/config.js"></script>
    <script>
      let isLoggingIn = false;

      document
        .getElementById("unifiedLoginForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          if (isLoggingIn) return;
          isLoggingIn = true;

          const username = document.getElementById("username").value.trim();
          const password = document.getElementById("password").value;

          // Show loading state
          showLoading(true);
          hideMessages();

          try {
            // First, try to determine user type and authenticate
            const result = await attemptUnifiedLogin(username, password);

            if (result.success) {
              showSuccessMessage(result.message || "Login successful!");

              // Wait a moment for user to see success message
              setTimeout(() => {
                window.location.href = result.redirectUrl;
              }, 1000);
            } else {
              showErrorMessage(
                result.error || "Login failed. Please check your credentials."
              );
            }
          } catch (error) {
            console.error("Login error:", error);
            showErrorMessage("Network error. Please try again.");
          } finally {
            showLoading(false);
            isLoggingIn = false;
          }
        });

      async function attemptUnifiedLogin(username, password) {
        // Try different authentication endpoints in order

        // 1. Try Admin/CTIO login
        try {
          const adminResult = await tryAdminLogin(username, password);
          if (adminResult.success) {
            return {
              success: true,
              message: "Welcome, CTIO (SysAdmin)!",
              redirectUrl: "dashboard.html",
            };
          }
        } catch (error) {
          console.log("Admin login attempt failed:", error.message);
        }

        // 2. Try Staff login
        // Block deleted Lead Technician credentials
        if (username === "LAED0013" && password === "lead123") {
          return {
            success: false,
            error: "This account has been removed. Please contact support.",
          };
        }
        try {
          const staffResult = await tryStaffLogin(username, password);
          if (staffResult.success) {
            // Prevent redirect to deleted dashboard
            if (staffResult.redirectUrl && staffResult.redirectUrl.includes("lead-technician-dashboard")) {
              return {
                success: false,
                error: "This dashboard is no longer available.",
              };
            }
            return {
              success: true,
              message: `Welcome, ${staffResult.position || "Staff Member"}!`,
              redirectUrl: staffResult.redirectUrl || "/staff/dashboard",
            };
          }
        } catch (error) {
          console.log("Staff login attempt failed:", error.message);
        }

        // 3. Try Client login
        try {
          const clientResult = await tryClientLogin(username, password);
          if (clientResult.success) {
            return {
              success: true,
              message: "Welcome to your client portal!",
              redirectUrl: "/client/dashboard",
            };
          }
        } catch (error) {
          console.log("Client login attempt failed:", error.message);
        }

        // If all attempts fail
        return {
          success: false,
          error:
            "Invalid credentials. Please check your username and password.",
        };
      }

      async function tryAdminLogin(username, password) {
        const response = await fetch(`${window.BASE_URL}/api/admin/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ username, password }),
        });

        const data = await response.json();

        if (response.ok && data.success) {
          return { success: true };
        } else {
          throw new Error(data.error || "Admin login failed");
        }
      }

      async function tryStaffLogin(username, password) {
        const response = await fetch(`${window.BASE_URL}/api/staff/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ employeeId: username, password }),
        });

        const data = await response.json();

        if (response.ok && data.success) {
          return {
            success: true,
            position: data.position,
            redirectUrl: data.redirectUrl,
          };
        } else {
          throw new Error(data.error || "Staff login failed");
        }
      }

      async function tryClientLogin(username, password) {
        const response = await fetch(`${window.BASE_URL}/api/client/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ phone: username, password }),
        });

        const data = await response.json();

        if (response.ok && data.success) {
          return { success: true };
        } else {
          throw new Error(data.error || "Client login failed");
        }
      }

      function showLoading(show) {
        const btnText = document.getElementById("btnText");
        const spinner = document.getElementById("spinner");
        const loginBtn = document.getElementById("loginBtn");

        if (show) {
          btnText.classList.add("hidden");
          spinner.classList.remove("hidden");
          loginBtn.disabled = true;
          loginBtn.classList.add("opacity-75", "cursor-not-allowed");
        } else {
          btnText.classList.remove("hidden");
          spinner.classList.add("hidden");
          loginBtn.disabled = false;
          loginBtn.classList.remove("opacity-75", "cursor-not-allowed");
        }
      }

      function showErrorMessage(message) {
        const errorEl = document.getElementById("errorMessage");
        errorEl.textContent = "‚ùå " + message;
        errorEl.classList.remove("hidden");
      }

      function showSuccessMessage(message) {
        const successEl = document.getElementById("successMessage");
        successEl.textContent = "‚úÖ " + message;
        successEl.classList.remove("hidden");
      }

      function hideMessages() {
        document.getElementById("errorMessage").classList.add("hidden");
        document.getElementById("successMessage").classList.add("hidden");
      }

      function forgotPassword() {
        alert(
          "üîê Password Recovery\n\n" +
            "Please contact your system administrator to reset your password:\n\n" +
            "Email: admin@drnet.com\n" +
            "Phone: +1-234-567-8900\n" +
            "Office Hours: Mon-Fri 9AM-5PM"
        );
      }

      function showContactInfo() {
        alert(
          "üìû Support Contact Information\n\n" +
            "Technical Support:\n" +
            "Email: support@drnet.com\n" +
            "Phone: +1-234-567-8900\n\n" +
            "Business Hours:\n" +
            "Monday - Friday: 9:00 AM - 5:00 PM\n" +
            "Saturday: 10:00 AM - 2:00 PM\n" +
            "Sunday: Closed\n\n" +
            "Emergency Support: +1-234-567-9999"
        );
      }

      // Auto-focus on username field
      document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("username").focus();
      });
    </script>
  </body>
</html>
